<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>2021 CryptoCTF | Van1sh的小屋</title>
  <meta name="keywords" content>
  <meta name="description" content="2021 CryptoCTF | Van1sh的小屋">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="&amp;emsp;&amp;emsp; Van1sh，也用ID：V、Vanish，主要是有的网站昵称至少两个字符，Vanish也容易被注册&amp;emsp;现就读于杭州电子科技大学。是一只究极大菜鸡加懒狗。自2019.2.14的2019Hctf-Game接触CTF，由于零基础，目前还菜的一批，可能还会继续菜下去。现在还只会做一点Crypto方向的题，其他什么Web，Pwn，Reverse, Misc….俺都不知道。">
<meta property="og:type" content="website">
<meta property="og:title" content="Van1sh的小屋">
<meta property="og:url" content="http://jayxv.github.io/about/index.html">
<meta property="og:site_name" content="Van1sh的小屋">
<meta property="og:description" content="&amp;emsp;&amp;emsp; Van1sh，也用ID：V、Vanish，主要是有的网站昵称至少两个字符，Vanish也容易被注册&amp;emsp;现就读于杭州电子科技大学。是一只究极大菜鸡加懒狗。自2019.2.14的2019Hctf-Game接触CTF，由于零基础，目前还菜的一批，可能还会继续菜下去。现在还只会做一点Crypto方向的题，其他什么Web，Pwn，Reverse, Misc….俺都不知道。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-04-30T11:44:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Van1sh的小屋">
<meta name="twitter:description" content="&amp;emsp;&amp;emsp; Van1sh，也用ID：V、Vanish，主要是有的网站昵称至少两个字符，Vanish也容易被注册&amp;emsp;现就读于杭州电子科技大学。是一只究极大菜鸡加懒狗。自2019.2.14的2019Hctf-Game接触CTF，由于零基础，目前还菜的一批，可能还会继续菜下去。现在还只会做一点Crypto方向的题，其他什么Web，Pwn，Reverse, Misc….俺都不知道。">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/sublime.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1"></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.0.1"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value>
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Van1sh</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/JayxV" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="email" href="mailto:643713081@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=643713081&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(57)</small></div></li>
    
        
            
            <li><div data-rel="比赛小屋">比赛小屋<small>(18)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="工具小屋">工具小屋<small>(5)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="合约小屋"><i class="fold iconfont icon-right"></i>合约小屋<small>(8)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="contract">contract<small>(6)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="区块链靶场">区块链靶场<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="密码小屋"><i class="fold iconfont icon-right"></i>密码小屋<small>(17)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="ECC">ECC<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Paillier">Paillier<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Lattice">Lattice<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Stream">Stream<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Knapsack">Knapsack<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Rsa">Rsa<small>(3)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Block">Block<small>(3)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Basic">Basic<small>(2)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="CTF">CTF<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="RSA">RSA<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
        
    
        
            
            <li><div data-rel="协议小屋">协议小屋<small>(2)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="Web小屋"><i class="fold iconfont icon-right"></i>Web小屋<small>(3)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="Files related">Files related<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="SQL">SQL<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="XSS">XSS<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="论文小屋">论文小屋<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="逆向小屋"><i class="fold iconfont icon-right"></i>逆向小屋<small>(1)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="patch">patch<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="漏洞小屋">漏洞小屋<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="小书屋">小书屋<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="57">
<input type="hidden" id="yelog_site_word_count" value="270.8k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://www.fzwjscj.xyz/">fzwjscj</a></li>
            
            <li><a target="_blank" href="http://dldxz.cn/">DLDXZ</a></li>
            
            <li><a target="_blank" href="http://fanda.cloud/">fanda</a></li>
            
            <li><a target="_blank" href="http://passingfoam.com/">PassingFoam&#39;s blog</a></li>
            
            <li><a target="_blank" href="https://eqqie.cn/">赤道企鹅</a></li>
            
            <li><a target="_blank" href="http://blog.ragdoll.work/">咲夜南梦</a></li>
            
            <li><a target="_blank" href="https://www.zhaoj.in/">glzjin</a></li>
            
            <li><a target="_blank" href="https://coinc1dens.github.io/">Coinc1dens</a></li>
            
            <li><a target="_blank" href="http://blog.soreatu.com/">soreatu</a></li>
            
            <li><a target="_blank" href="http://www.ga1axy.top/">盖乐希</a></li>
            
            <li><a target="_blank" href="https://shawroot.cc/">Root.</a></li>
            
            <li><a target="_blank" href="https://l1near.top/">l1near</a></li>
            
            <li><a target="_blank" href="https://0xdktb.top/">0xDktb</a></li>
            
            <li><a target="_blank" href="https://www.wootec.top/">Reverier</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode === 13){return false;}">
        <input id="local-search-input" class="search" type="text" placeholder="以 in: 开头进行全文搜索" />
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color4">Write Up</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">docker</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">Sage</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">CTF</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">ECC</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">TLS 1.2</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">Crypto</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Paillier</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Web</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">Files</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Serialization</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">Lattice</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Dsa</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">LCG</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Rc4</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">SM4</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">paper</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">small private exponent</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">SQL</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">python</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Knapsack</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Rsa</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">continued_fraction</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">RE</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">DES</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">差分密码分析</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">操作模式</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">number theory</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">Abstract algebra</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">ETH</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">SPN</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">线性密码分析</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">Book</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">Shadowsocks</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">Nmap</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">XSS</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">Linux</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">Coppersmith’s Method</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">book</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a id="top" class="密码小屋 Basic "
           href="/2020/05/27/密码学学习笔记之introduction to mathematical cryptography/"
           data-tag="Book"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 introduction to mathematical cryptography">密码学学习笔记 之 introduction to mathematical cryptography</span>
            <span class="post-date" title="2020-05-27 21:05:00">2020/05/27</span>
        </a>
        
        <a  class="漏洞小屋 "
           href="/2023/01/30/Shadowsocks Redirect Attack/"
           data-tag="Shadowsocks"
           data-author="Van1sh" >
            <span class="post-title" title="Shadowsocks Redirect Attack">Shadowsocks Redirect Attack</span>
            <span class="post-date" title="2023-01-30 17:14:00">2023/01/30</span>
        </a>
        
        <a  class="协议小屋 "
           href="/2022/12/15/TLS1.2协议分析（二）/"
           data-tag="TLS 1.2"
           data-author="Van1sh" >
            <span class="post-title" title="TLS 1.2 协议（二）">TLS 1.2 协议（二）</span>
            <span class="post-date" title="2022-12-15 10:24:00">2022/12/15</span>
        </a>
        
        <a  class="协议小屋 "
           href="/2022/12/08/TLS1.2协议分析（一）/"
           data-tag="TLS 1.2"
           data-author="Van1sh" >
            <span class="post-title" title="TLS 1.2 协议（一）">TLS 1.2 协议（一）</span>
            <span class="post-date" title="2022-12-08 21:10:00">2022/12/08</span>
        </a>
        
        <a  class="密码小屋 "
           href="/2022/11/15/密码学学习笔记之连分数/"
           data-tag="continued_fraction"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记之连分数">密码学学习笔记之连分数</span>
            <span class="post-date" title="2022-11-15 17:59:00">2022/11/15</span>
        </a>
        
        <a  class="论文小屋 "
           href="/2022/10/17/Generalization of Some Attacks on RSA with Small Prime Combination and Small Private Exponent/"
           data-tag="paper,small private exponent"
           data-author="Van1sh" >
            <span class="post-title" title="Generalization of Some Attacks on RSA with Small Prime Combination and Small Private Exponent">Generalization of Some Attacks on RSA with Small Prime Combination and Small Private Exponent</span>
            <span class="post-date" title="2022-10-17 15:31:00">2022/10/17</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2022/09/14/2022 cryptoctf/"
           data-tag=""
           data-author="Van1sh" >
            <span class="post-title" title="2022 CryptoCTF">2022 CryptoCTF</span>
            <span class="post-date" title="2022-09-14 17:16:00">2022/09/14</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2022/08/30/2021 cryptoctf/"
           data-tag=""
           data-author="Van1sh" >
            <span class="post-title" title="2021 CryptoCTF">2021 CryptoCTF</span>
            <span class="post-date" title="2022-08-30 13:30:00">2022/08/30</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/06/29/区块链学习笔记之2022ACTF-bet2loss/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之2022ACTF—bet2loss">区块链学习笔记之2022ACTF—bet2loss</span>
            <span class="post-date" title="2022-06-29 15:23:00">2022/06/29</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/04/19/区块链学习笔记之2022starCTF/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之2022starCTF——TreasureHunter">区块链学习笔记之2022starCTF——TreasureHunter</span>
            <span class="post-date" title="2022-04-19 15:23:00">2022/04/19</span>
        </a>
        
        <a  class="合约小屋 区块链靶场 "
           href="/2022/03/08/区块链靶场刷题之cpaturetheether/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="cpature the ether">cpature the ether</span>
            <span class="post-date" title="2022-03-08 11:03:00">2022/03/08</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2022/02/28/2022 SUSCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2022 SUSCTF">2022 SUSCTF</span>
            <span class="post-date" title="2022-02-28 11:18:35">2022/02/28</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2022/02/22/2021TQLCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2022 TQLCTF">2022 TQLCTF</span>
            <span class="post-date" title="2022-02-22 22:22:22">2022/02/22</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/02/18/区块链学习笔记之BalsnCTF 2019 Bank/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之Balsn CTF 2019 - Bank">区块链学习笔记之Balsn CTF 2019 - Bank</span>
            <span class="post-date" title="2022-02-18 14:45:00">2022/02/18</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/02/15/区块链学习笔记之BalsnCTF 2020 IdleGame/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之BalsnCTF 2020 IdleGame">区块链学习笔记之BalsnCTF 2020 IdleGame</span>
            <span class="post-date" title="2022-02-15 15:39:00">2022/02/15</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/02/11/区块链学习笔记之paradigm-CTF babysandbox/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之paradigm-CTF babysandbox">区块链学习笔记之paradigm-CTF babysandbox</span>
            <span class="post-date" title="2022-02-11 16:22:00">2022/02/11</span>
        </a>
        
        <a  class="合约小屋 contract "
           href="/2022/01/23/区块链学习笔记之RealWorld体验赛/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之RealWorld体验赛——TransferFrom">区块链学习笔记之RealWorld体验赛——TransferFrom</span>
            <span class="post-date" title="2022-01-23 00:11:00">2022/01/23</span>
        </a>
        
        <a  class="合约小屋 "
           href="/2021/12/22/区块链学习笔记之初探以太坊/"
           data-tag="ETH"
           data-author="Van1sh" >
            <span class="post-title" title="区块链学习笔记之初探以太坊">区块链学习笔记之初探以太坊</span>
            <span class="post-date" title="2021-12-22 10:16:00">2021/12/22</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2021/08/23/2021 祥云杯/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2021 祥云杯">2021 祥云杯</span>
            <span class="post-date" title="2021-08-23 14:07:00">2021/08/23</span>
        </a>
        
        <a  class="密码小屋 Block "
           href="/2021/08/06/密码学学习笔记之线性分析入门篇——EzSPN/"
           data-tag="SPN,线性密码分析"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 线性分析入门篇——EzSPN">密码学学习笔记 之 线性分析入门篇——EzSPN</span>
            <span class="post-date" title="2021-08-06 09:24:25">2021/08/06</span>
        </a>
        
        <a  class="密码小屋 Block "
           href="/2021/07/16/密码学学习笔记之差分分析入门篇——四轮DES/"
           data-tag="DES,差分密码分析"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 差分分析入门篇——四轮DES">密码学学习笔记 之 差分分析入门篇——四轮DES</span>
            <span class="post-date" title="2021-07-16 09:24:25">2021/07/16</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2021/04/04/2021HFCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2021 HFCTF">2021 HFCTF</span>
            <span class="post-date" title="2021-04-04 11:02:47">2021/04/04</span>
        </a>
        
        <a  class="逆向小屋 patch "
           href="/2021/03/27/逆向学习笔记之drinkSomeTea/"
           data-tag="RE"
           data-author="Van1sh" >
            <span class="post-title" title="逆向学习笔记 之 drinkSomeTea">逆向学习笔记 之 drinkSomeTea</span>
            <span class="post-date" title="2021-03-27 19:22:00">2021/03/27</span>
        </a>
        
        <a  class="密码小屋 "
           href="/2021/01/01/密码学学习笔记之密码学随笔/"
           data-tag="Crypto"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 密码学随笔">密码学学习笔记 之 密码学随笔</span>
            <span class="post-date" title="2021-01-01 00:00:00">2021/01/01</span>
        </a>
        
        <a  class="密码小屋 RSA "
           href="/2020/12/18/密码学学习笔记之RSA的一些套路/"
           data-tag="Rsa"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 RSA的一些套路">密码学学习笔记 之 RSA的一些套路</span>
            <span class="post-date" title="2020-12-18 14:32:00">2020/12/18</span>
        </a>
        
        <a  class="密码小屋 CTF "
           href="/2020/12/18/密码学学习笔记之CTF/"
           data-tag="CTF"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 CTF">密码学学习笔记 之 CTF</span>
            <span class="post-date" title="2020-12-18 00:00:00">2020/12/18</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/12/10/2020RoarCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 RoarCTF">2020 RoarCTF</span>
            <span class="post-date" title="2020-12-10 10:00:00">2020/12/10</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/11/04/2020ByteCTF&X-NUCA部分密码学题解/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 ByteCTF&amp;X-NUCA">2020 ByteCTF&amp;X-NUCA</span>
            <span class="post-date" title="2020-11-04 10:00:00">2020/11/04</span>
        </a>
        
        <a  class="密码小屋 Rsa "
           href="/2020/08/13/密码学学习笔记之coppersmith/"
           data-tag="Coppersmith’s Method"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 Coppersmith’s Method">密码学学习笔记 之 Coppersmith’s Method</span>
            <span class="post-date" title="2020-08-13 10:00:00">2020/08/13</span>
        </a>
        
        <a  class="Web小屋 Files related "
           href="/2020/08/09/Web学习笔记之文件与序列化/"
           data-tag="Web,Files,Serialization"
           data-author="Van1sh" >
            <span class="post-title" title="Web学习笔记 之 文件与序列化">Web学习笔记 之 文件与序列化</span>
            <span class="post-date" title="2020-08-09 14:16:00">2020/08/09</span>
        </a>
        
        <a  class="Web小屋 SQL "
           href="/2020/08/07/Web学习笔记之SQL注入/"
           data-tag="Web,SQL"
           data-author="Van1sh" >
            <span class="post-title" title="Web学习笔记 之 SQL注入">Web学习笔记 之 SQL注入</span>
            <span class="post-date" title="2020-08-07 13:18:00">2020/08/07</span>
        </a>
        
        <a  class="Web小屋 XSS "
           href="/2020/07/26/Web学习笔记之XSS/"
           data-tag="Web,XSS"
           data-author="Van1sh" >
            <span class="post-title" title="Web学习笔记 之 XSS">Web学习笔记 之 XSS</span>
            <span class="post-date" title="2020-07-26 10:44:00">2020/07/26</span>
        </a>
        
        <a  class="密码小屋 Knapsack "
           href="/2020/06/08/密码学学习笔记之knapsack/"
           data-tag="Knapsack"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 knapsack">密码学学习笔记 之 knapsack</span>
            <span class="post-date" title="2020-06-08 10:30:43">2020/06/08</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/05/26/2020BJD3rd/"
           data-tag="Write Up"
           data-author="Van1sh &amp; FzWjScJ" >
            <span class="post-title" title="2020 BJD3rd">2020 BJD3rd</span>
            <span class="post-date" title="2020-05-26 16:00:47">2020/05/26</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/05/24/2020GKCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 GKCTF">2020 GKCTF</span>
            <span class="post-date" title="2020-05-24 17:05:00">2020/05/24</span>
        </a>
        
        <a  class="工具小屋 "
           href="/2020/05/20/sage常用命令/"
           data-tag="Sage"
           data-author="Van1sh" >
            <span class="post-title" title="sage常用命令">sage常用命令</span>
            <span class="post-date" title="2020-05-20 11:22:00">2020/05/20</span>
        </a>
        
        <a  class="密码小屋 Paillier "
           href="/2020/05/14/密码学学习笔记之paillier cryptosystem/"
           data-tag="Paillier"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 paillier cryptosystem">密码学学习笔记 之 paillier cryptosystem</span>
            <span class="post-date" title="2020-05-14 11:00:19">2020/05/14</span>
        </a>
        
        <a  class="密码小屋 Lattice "
           href="/2020/05/12/密码学学习笔记之HNP/"
           data-tag="Lattice,Dsa,LCG"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 HNP">密码学学习笔记 之 HNP</span>
            <span class="post-date" title="2020-05-12 10:00:57">2020/05/12</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/05/10/2020网鼎杯/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 网鼎杯">2020 网鼎杯</span>
            <span class="post-date" title="2020-05-10 21:15:00">2020/05/10</span>
        </a>
        
        <a  class="密码小屋 ECC "
           href="/2020/05/07/密码学学习笔记之NCCIP/"
           data-tag="ECC"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 NCCIP">密码学学习笔记 之 NCCIP</span>
            <span class="post-date" title="2020-05-07 10:30:43">2020/05/07</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/05/05/2020De1CTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 De1CTF">2020 De1CTF</span>
            <span class="post-date" title="2020-05-05 15:57:00">2020/05/05</span>
        </a>
        
        <a  class="密码小屋 Block "
           href="/2020/03/03/密码学学习笔记之分组密码操作模式/"
           data-tag="操作模式"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 分组密码操作模式">密码学学习笔记 之 分组密码操作模式</span>
            <span class="post-date" title="2020-03-03 15:15:00">2020/03/03</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2020/02/18/2020hgame_week1/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2020 hgame week1">2020 hgame week1</span>
            <span class="post-date" title="2020-02-18 16:22:35">2020/02/18</span>
        </a>
        
        <a  class="密码小屋 Stream "
           href="/2020/01/30/密码学学习笔记之RC4与SM4/"
           data-tag="Rc4,SM4"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 RC4与SM4">密码学学习笔记 之 RC4与SM4</span>
            <span class="post-date" title="2020-01-30 00:05:00">2020/01/30</span>
        </a>
        
        <a  class="密码小屋 Rsa "
           href="/2019/12/04/密码学学习笔记之浅析On r-th Root Extraction Algorithm in Fq/"
           data-tag="Rsa"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 浅析On r-th Root Extraction Algorithm in Fq">密码学学习笔记 之 浅析On r-th Root Extraction Algorithm in Fq</span>
            <span class="post-date" title="2019-12-04 14:30:46">2019/12/04</span>
        </a>
        
        <a  class="密码小屋 Basic "
           href="/2019/12/03/密码学学习笔记之数论四大定理及应用/"
           data-tag="number theory,Abstract algebra"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 数论四大定理及应用">密码学学习笔记 之 数论四大定理及应用</span>
            <span class="post-date" title="2019-12-03 15:30:25">2019/12/03</span>
        </a>
        
        <a  class="密码小屋 Rsa "
           href="/2019/11/11/密码学学习笔记之浅析Pollard's rho algorithm及其应用/"
           data-tag="Rsa"
           data-author="Van1sh" >
            <span class="post-title" title="密码学学习笔记 之 浅析Pollard&#39;s rho algorithm及其应用">密码学学习笔记 之 浅析Pollard&#39;s rho algorithm及其应用</span>
            <span class="post-date" title="2019-11-11 15:32:00">2019/11/11</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2019/11/08/2019UNCTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2019 UNCTF">2019 UNCTF</span>
            <span class="post-date" title="2019-11-08 11:30:30">2019/11/08</span>
        </a>
        
        <a  class="工具小屋 "
           href="/2019/11/01/docker和docker-compose的安装/"
           data-tag="docker"
           data-author="Van1sh" >
            <span class="post-title" title="安装Docker 和 Docker-Compose以及docker images的制作及上传">安装Docker 和 Docker-Compose以及docker images的制作及上传</span>
            <span class="post-date" title="2019-11-01 21:00:00">2019/11/01</span>
        </a>
        
        <a  class="工具小屋 "
           href="/2019/09/12/Linux 基础/"
           data-tag="Linux"
           data-author="Vanish" >
            <span class="post-title" title="Linux 基础">Linux 基础</span>
            <span class="post-date" title="2019-09-12 00:17:00">2019/09/12</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2019/08/29/2019第五空间/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2019 第五空间">2019 第五空间</span>
            <span class="post-date" title="2019-08-29 12:18:35">2019/08/29</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2019/08/27/2019OGeek/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2019 OGeek">2019 OGeek</span>
            <span class="post-date" title="2019-08-27 11:02:35">2019/08/27</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2019/08/03/2019De1CTF/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2019 De1CTF">2019 De1CTF</span>
            <span class="post-date" title="2019-08-03 22:14:55">2019/08/03</span>
        </a>
        
        <a  class="小书屋 "
           href="/2019/08/02/三体/"
           data-tag="book"
           data-author="Van1sh" >
            <span class="post-title" title="三体">三体</span>
            <span class="post-date" title="2019-08-02 12:56:00">2019/08/02</span>
        </a>
        
        <a  class="工具小屋 "
           href="/2019/07/22/nmap/"
           data-tag="Nmap"
           data-author="Van1sh" >
            <span class="post-title" title="初遇Nmap">初遇Nmap</span>
            <span class="post-date" title="2019-07-22 16:07:55">2019/07/22</span>
        </a>
        
        <a  class="工具小屋 "
           href="/2019/07/21/python 正则/"
           data-tag="python"
           data-author="Van1sh" >
            <span class="post-title" title="python 之 正则">python 之 正则</span>
            <span class="post-date" title="2019-07-21 22:30:35">2019/07/21</span>
        </a>
        
        <a  class="比赛小屋 "
           href="/2019/07/15/2019赛博杯/"
           data-tag="Write Up"
           data-author="Van1sh" >
            <span class="post-title" title="2019 赛博杯">2019 赛博杯</span>
            <span class="post-date" title="2019-07-15 16:22:35">2019/07/15</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-2021 cryptoctf" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">2021 CryptoCTF</h1>
    
    <div class="article-meta">
        
        
        <span class="author"><a>Van1sh</a></span>
        
        
        <span class="book">
            
                <a  data-rel="比赛小屋">比赛小屋</a>
            
        </span>
        
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2023-01-31 16:25:06'>2022-08-30 13:30</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:19.6k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Farm"><span class="toc-text">Farm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keybase"><span class="toc-text">Keybase</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rima"><span class="toc-text">Rima</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Titu"><span class="toc-text">Titu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Symbols"><span class="toc-text">Symbols</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hyper-Normal"><span class="toc-text">Hyper Normal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Salt-and-Pepper"><span class="toc-text">Salt and Pepper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hamul"><span class="toc-text">Hamul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Triplet"><span class="toc-text">Triplet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Onlude"><span class="toc-text">Onlude</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maid"><span class="toc-text">Maid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wolf"><span class="toc-text">Wolf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ferman"><span class="toc-text">Ferman</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RSAphantine"><span class="toc-text">RSAphantine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FROZEN"><span class="toc-text">FROZEN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LINDA"><span class="toc-text">LINDA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TinyECC"><span class="toc-text">TinyECC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELEGANT-CURVE"><span class="toc-text">ELEGANT CURVE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DOUBLE-MIFF"><span class="toc-text">DOUBLE MIFF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ECCHIMERA"><span class="toc-text">ECCHIMERA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROHALD"><span class="toc-text">ROHALD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROBERT"><span class="toc-text">ROBERT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TRUNC"><span class="toc-text">TRUNC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MY-SIEVE"><span class="toc-text">MY SIEVE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DORSA"><span class="toc-text">DORSA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POLISH"><span class="toc-text">POLISH</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Crypto CTF <span class="keyword">is</span> an online competition <span class="keyword">for</span> hackers <span class="keyword">to</span> test, evaluate, <span class="keyword">and</span> expand their cryptography exploiting skills. In this CTF, we will provide various crypto challenges regarding modern cryptography techniques.</span><br><span class="line">All crypto lovers are most welcome!</span><br><span class="line">Crypto CTF <span class="keyword">is</span> a revenge <span class="keyword">for</span> everlasting complaints <span class="keyword">by</span> CTF participants <span class="keyword">about</span> crypto challenges <span class="keyword">in</span> CTF contests. In this brand-new tournament, we are trying <span class="keyword">to</span> provide <span class="keyword">the</span> crypto lovers <span class="keyword">with</span> fun <span class="keyword">and</span> challenging pure crypto tasks <span class="keyword">to</span> squeeze their heart <span class="keyword">and</span> test their passion <span class="keyword">for</span> cryptography.</span><br><span class="line">Each task will be based <span class="keyword">on</span> a particular cryptographic primitive, <span class="keyword">or</span> <span class="keyword">it</span> will include a direct <span class="built_in">application</span> <span class="keyword">of</span> cryptography <span class="keyword">in</span> other fields.</span><br><span class="line">The organizers <span class="keyword">of</span> these tournaments generously offer their skills' knowledge <span class="keyword">to</span> design original Crypto tasks <span class="keyword">and</span> challenges <span class="keyword">for</span> similar contests.</span><br><span class="line"></span><br><span class="line">Long Live Crypto :)</span><br></pre></td></tr></table></figure>

<p>这两天在复现2022-CryptoCTF，但是想着2021的CryptoCTF也没复现完，于是就决定先从2021开始了。</p>
<h2 id="Farm"><a href="#Farm" class="headerlink" title="Farm"></a>Farm</h2><p>POINTS：41</p>
<p>考点：有限域，逐字节爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sage.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string, base64, math</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">ALPHABET = string.printable[:<span class="number">62</span>] + <span class="string">'\\='</span></span><br><span class="line"></span><br><span class="line">F = list(GF(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(l)</span>:</span></span><br><span class="line">	key = [F[randint(<span class="number">1</span>, <span class="number">63</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> range(l)] </span><br><span class="line">	key = math.prod(key) <span class="comment"># Optimization the key length :D</span></span><br><span class="line">	<span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maptofarm</span><span class="params">(c)</span>:</span></span><br><span class="line">	<span class="keyword">assert</span> c <span class="keyword">in</span> ALPHABET</span><br><span class="line">	<span class="keyword">return</span> F[ALPHABET.index(c)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, key)</span>:</span></span><br><span class="line">	m64 = base64.b64encode(msg)</span><br><span class="line">	enc, pkey = <span class="string">''</span>, key**<span class="number">5</span> + key**<span class="number">3</span> + key**<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> m <span class="keyword">in</span> m64:</span><br><span class="line">		enc += ALPHABET[F.index(pkey * maptofarm(chr(m)))]</span><br><span class="line">	<span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"><span class="comment"># KEEP IT SECRET </span></span><br><span class="line">key = keygen(<span class="number">14</span>) <span class="comment"># I think 64**14 &gt; 2**64 is not brute-forcible :P</span></span><br><span class="line"></span><br><span class="line">enc = encrypt(flag, key)</span><br><span class="line">print(<span class="string">f'enc = <span class="subst">&#123;enc&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#enc = "805c9GMYuD5RefTmabUNfS9N9YrkwbAbdZE0df91uCEytcoy9FDSbZ8Ay8jj"</span></span><br></pre></td></tr></table></figure>

<p>这道题目，生成了一个F = list(GF(64))，这里用sagemath测试一下，得到的是</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,</span><br><span class="line"> z6,</span><br><span class="line"> z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">3</span>,</span><br><span class="line"> z6^<span class="number">4</span>,</span><br><span class="line"> z6^<span class="number">5</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">3</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">3</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6,</span><br><span class="line"> z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">3</span> + z6,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span>,</span><br><span class="line"> z6^<span class="number">3</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">2</span> + z6,</span><br><span class="line"> z6^<span class="number">3</span> + z6^<span class="number">2</span>,</span><br><span class="line"> z6^<span class="number">4</span> + z6^<span class="number">3</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">4</span> + z6^<span class="number">3</span> + z6 + <span class="number">1</span>,</span><br><span class="line"> z6^<span class="number">5</span> + z6^<span class="number">3</span> + z6^<span class="number">2</span> + <span class="number">1</span>,</span><br><span class="line"> <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>长度正好是64。ok，虽然不是很明白怎么来的，但是可以先放一边。然后看到程序调用了keygen(l)函数，</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def keygen(l):</span><br><span class="line">	<span class="built_in">key</span> = [F[randint(<span class="number">1</span>, <span class="number">63</span>)] <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="built_in">range</span>(l)] </span><br><span class="line">	<span class="built_in">key</span> = math.prod(<span class="built_in">key</span>) # Optimization the <span class="built_in">key</span> <span class="built_in">length</span> :D</span><br><span class="line">	<span class="built_in">return</span> <span class="built_in">key</span></span><br></pre></td></tr></table></figure>

<p>该函数首先生成长度为l的数组，元素取自F，最后prod所有的元素，但由于其结果仍会在F这个<strong>galois-field</strong>中，所以到这里已经可以预见这道题怎么做了，只用穷举一下这个F中的所有元素当作key即可，只有64种可能。</p>
<p>然后我们看具体的加密流程以编写解密算法。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def encrypt(msg, <span class="built_in">key</span>):</span><br><span class="line">	m64 = <span class="built_in">base64</span>.b64encode(msg)</span><br><span class="line">	enc, pkey = '', <span class="built_in">key</span>**<span class="number">5</span> + <span class="built_in">key</span>**<span class="number">3</span> + <span class="built_in">key</span>**<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> m <span class="keyword">in</span> m64:</span><br><span class="line">		enc += ALPHABET[F.index(pkey * maptofarm(chr(m)))]</span><br><span class="line">	<span class="built_in">return</span> enc</span><br></pre></td></tr></table></figure>

<p>重点在enc += ALPHABET[F.index(pkey * maptofarm(chr(m)))]</p>
<p>看到算法是对明文逐位字节加密的，并且根据这个比赛的flag格式，我们知道明文前三个字节应该是‘CCT’，那么也就知道了其base64编码所以，我们可以先爆破出密钥，然后逐字节爆破明文</p>
<p>exp：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">string</span>, <span class="built_in">base64</span>, math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ALPHABET = <span class="built_in">string</span>.printable[:<span class="number">62</span>] + '\\='</span><br><span class="line"></span><br><span class="line">F = list(GF(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line">def keygen(l):</span><br><span class="line">	<span class="built_in">key</span> = [F[randint(<span class="number">1</span>, <span class="number">63</span>)] <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="built_in">range</span>(l)] </span><br><span class="line">	<span class="built_in">key</span> = math.prod(<span class="built_in">key</span>) # Optimization the <span class="built_in">key</span> <span class="built_in">length</span> :D</span><br><span class="line">	<span class="built_in">return</span> <span class="built_in">key</span></span><br><span class="line"></span><br><span class="line">def maptofarm(c):</span><br><span class="line">	assert c <span class="keyword">in</span> ALPHABET</span><br><span class="line">	<span class="built_in">return</span> F[ALPHABET.index(c)]</span><br><span class="line"></span><br><span class="line">def encrypt(msg, <span class="built_in">key</span>):</span><br><span class="line">	m64 = <span class="built_in">base64</span>.b64encode(msg)</span><br><span class="line">	enc, pkey = '', <span class="built_in">key</span>**<span class="number">5</span> + <span class="built_in">key</span>**<span class="number">3</span> + <span class="built_in">key</span>**<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> m <span class="keyword">in</span> m64:</span><br><span class="line">		enc += ALPHABET[F.index(pkey * maptofarm(chr(m)))]</span><br><span class="line">	<span class="built_in">return</span> enc</span><br><span class="line"></span><br><span class="line">def myenc(m,<span class="built_in">key</span>):</span><br><span class="line">	enc, pkey = '', <span class="built_in">key</span>**<span class="number">5</span> + <span class="built_in">key</span>**<span class="number">3</span> + <span class="built_in">key</span>**<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">	enc += ALPHABET[F.index(pkey * maptofarm(m))]</span><br><span class="line">	<span class="built_in">return</span> enc</span><br><span class="line"></span><br><span class="line">flag = b'CCT'</span><br><span class="line">flag64 = b''</span><br><span class="line">ciphertext = '805c9GMYuD5RefTmabUNfS9N9YrkwbAbdZE0df91uCEytcoy9FDSbZ8Ay8jj'</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">key</span> <span class="keyword">in</span> F:</span><br><span class="line">	<span class="keyword">if</span> encrypt(flag,<span class="built_in">key</span>) == ciphertext[:<span class="number">4</span>]:</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> ciphertext:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> ALPHABET:</span><br><span class="line">				<span class="keyword">if</span> myenc(j,<span class="built_in">key</span>) == i:</span><br><span class="line">					flag64+=j.encode()</span><br><span class="line">					<span class="built_in">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">base64</span>.b64decode(flag64))</span><br><span class="line"></span><br><span class="line">#'CCTF&#123;EnCrYp7I0n_4nD_5u8STitUtIn9_iN_Fi3Ld!&#125;'</span><br></pre></td></tr></table></figure>

<h2 id="Keybase"><a href="#Keybase" class="headerlink" title="Keybase"></a>Keybase</h2><p>POINTS：48</p>
<p>考点：AES-CBC模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> number</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os, sys, random</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">()</span>:</span></span><br><span class="line">    iv, key = [os.urandom(<span class="number">16</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="string">'01'</span>]</span><br><span class="line">    <span class="keyword">return</span> iv, key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, iv, key)</span>:</span></span><br><span class="line">    aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    <span class="keyword">return</span> aes.encrypt(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(enc, iv, key)</span>:</span></span><br><span class="line">    aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    <span class="keyword">return</span> aes.decrypt(enc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">" hi all, welcome to the simple KEYBASE cryptography task, try to    "</span>, border)</span><br><span class="line">    pr(border, <span class="string">" decrypt the encrypted message and get the flag as a nice prize!    "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    iv, key = keygen()</span><br><span class="line">    flag_enc = encrypt(flag, iv, key).hex()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[G]et the encrypted flag \n|\t[T]est the encryption \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'g'</span>:</span><br><span class="line">            pr(<span class="string">"| encrypt(flag) ="</span>, flag_enc)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'t'</span>:</span><br><span class="line">            pr(<span class="string">"| Please send your 32 bytes message to encrypt: "</span>)</span><br><span class="line">            msg_inp = sc()</span><br><span class="line">            <span class="keyword">if</span> len(msg_inp) == <span class="number">32</span>:</span><br><span class="line">                enc = encrypt(msg_inp, iv, key).hex()</span><br><span class="line">                r = random.randint(<span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">                s = <span class="number">4</span> - r</span><br><span class="line">                mask_key = key[:<span class="number">-2</span>].hex() + <span class="string">'*'</span> * <span class="number">4</span></span><br><span class="line">                mask_enc = enc[:r] + <span class="string">'*'</span> * <span class="number">28</span> + enc[<span class="number">32</span>-s:]</span><br><span class="line">                pr(<span class="string">"| enc ="</span>, mask_enc)</span><br><span class="line">                pr(<span class="string">"| key ="</span>, mask_key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">"| SEND 32 BYTES MESSAGE :X"</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>是一道需要交互的题目，那么我们看到题目提供的功能。</p>
<p>一个是 g，会将flag的密文输出</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">ans</span> == <span class="string">'g'</span>:</span><br><span class="line">	pr(<span class="string">"| encrypt(flag) ="</span>, flag_enc)</span><br></pre></td></tr></table></figure>

<p>一个是 t，接受32字节的消息加密，然后输出密钥前14字节，以及相应密文，不过会对密文第一组做一个隐藏处理，只给出第一组开头和结尾共4个字节</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">elif ans == <span class="string">'t'</span>:</span><br><span class="line">    pr(<span class="string">"| Please send your 32 bytes message to encrypt: "</span>)</span><br><span class="line">    msg_inp = sc()</span><br><span class="line">    <span class="keyword">if</span> len(msg_inp) == <span class="number">32</span>:</span><br><span class="line">        enc = encrypt(msg_inp, iv, <span class="built_in">key</span>).<span class="built_in">hex</span>()</span><br><span class="line">        r = <span class="built_in">random</span>.randint(<span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">        s = <span class="number">4</span> - r</span><br><span class="line">        mask_key = <span class="built_in">key</span>[:<span class="number">-2</span>].<span class="built_in">hex</span>() + <span class="string">'*'</span> * <span class="number">4</span></span><br><span class="line">        mask_enc = enc[:r] + <span class="string">'*'</span> * <span class="number">28</span> + enc[<span class="number">32</span>-s:]</span><br><span class="line">        pr(<span class="string">"| enc ="</span>, mask_enc)</span><br><span class="line">        pr(<span class="string">"| key ="</span>, mask_key)</span><br></pre></td></tr></table></figure>

<p>而加密和解密使用的是AES-CBC模式</p>
<p><img src="https://s2.loli.net/2022/07/12/YvUDtVK5xLpMETH.png" alt="image-20220712140756535"></p>
<p>所以这里的切入点很明确，就是利用功能 t，</p>
<ol>
<li>首先我们发送两组共32字节的明文 “A”*32 过去，会得到14字节的密钥和一组模糊密文和一组清晰密文</li>
<li>我们爆破密钥的剩余两个字节，然后用爆破出来的密钥尝试对第二组密文进行解密，解密后的结果和第一组模糊密文中的清晰部分进行异或，如果得到的均为”A“，则我们的密钥爆破正确。</li>
<li>由于CBC模式，我们还需要iv。此时我们拥有密钥，明文；如果拥有第一组密文，我们对第一组密文进行解密并与明文异或即可知道iv</li>
<li>需要意识到的是，第一组密文用于第二组明文加密，而第二组明文我们又是知道的，所以我们使用密钥解密第二组密文，并与第二组明文异或得到第一组密文，然后解密第一组密文，与第一组明文异或，得到iv</li>
<li>使用密钥和iv解密flag的密文，获取flag</li>
</ol>
<p>脚本改编自<a href="https://blog.cryptohack.org/cryptoctf2021-easy#keybase" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-easy#keybase</a></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">context</span>.log_level = 'debug'</span><br><span class="line">r = process([<span class="string">"python3"</span>,<span class="string">"keybase.py"</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">"[Q]uit\n"</span>, <span class="string">"G"</span>)</span><br><span class="line">enc_flag = bytes.fromhex(r.recvline().strip().decode().<span class="built_in">split</span>(<span class="string">" = "</span>)[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    r.sendlineafter(<span class="string">"[Q]uit\n"</span>, <span class="string">"T"</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">"Please send your 32 bytes message to encrypt: \n"</span>, b<span class="string">"A"</span>*<span class="number">32</span>)</span><br><span class="line">    enc = r.recvline().strip().decode().<span class="built_in">split</span>(<span class="string">" = "</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">key</span> = r.recvline().strip().decode().<span class="built_in">split</span>(<span class="string">" = "</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">prefix</span> = enc.<span class="built_in">split</span>(<span class="string">"*"</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> len(<span class="built_in">prefix</span>) == <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">prefix</span> = bytes.fromhex(<span class="built_in">prefix</span>)</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">key</span> = bytearray.fromhex(<span class="built_in">key</span>[:-<span class="number">4</span>]) + b<span class="string">"\x00\x00"</span></span><br><span class="line"><span class="keyword">for</span> k1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="built_in">key</span>[-<span class="number">2</span>] = k1</span><br><span class="line">    <span class="keyword">for</span> k2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="built_in">key</span>[-<span class="number">1</span>] = k2</span><br><span class="line">        <span class="keyword">if</span> xor(AES.<span class="built_in">new</span>(<span class="built_in">key</span>, AES.MODE_ECB).decrypt(bytes.fromhex(enc[-<span class="number">32</span>:])), b<span class="string">"AA"</span>)[:<span class="number">2</span>] == <span class="built_in">prefix</span>:</span><br><span class="line">            <span class="built_in">block</span> = xor(AES.<span class="built_in">new</span>(<span class="built_in">key</span>, AES.MODE_ECB).decrypt(bytes.fromhex(enc[-<span class="number">32</span>:])), b<span class="string">"A"</span>*<span class="number">16</span>)</span><br><span class="line">            IV = xor(AES.<span class="built_in">new</span>(<span class="built_in">key</span>, AES.MODE_ECB).decrypt(<span class="built_in">block</span>)[:<span class="number">16</span>], b<span class="string">"A"</span>*<span class="number">16</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"key"</span>,<span class="built_in">key</span>.hex())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"IV"</span>,IV.hex())</span><br><span class="line">            <span class="built_in">print</span>(AES.<span class="built_in">new</span>(<span class="built_in">key</span>, AES.MODE_CBC, IV).decrypt(enc_flag))</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure>

<h2 id="Rima"><a href="#Rima" class="headerlink" title="Rima"></a>Rima</h2><p>POINTS:56</p>
<p>考点：爆破，信息恢复</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">#from flag import FLAG</span><br><span class="line">from sympy import isprime</span><br><span class="line">FLAG=b'CCTF&#123;_how_finD_7h1s_1z_s3cr3T?!&#125;'</span><br><span class="line">def nextPrime(n):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        n += (n <span class="symbol">%</span> <span class="number">2</span>) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isprime(n):</span><br><span class="line">            <span class="built_in">return</span> n</span><br><span class="line"></span><br><span class="line">f = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> bin(int(FLAG.hex(), <span class="number">16</span>))[<span class="number">2</span>:]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(len(f))</span><br><span class="line">f.insert(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(len(f)-<span class="number">1</span>):</span><br><span class="line">    f[i] += f[i+<span class="number">1</span>]</span><br><span class="line">a = nextPrime(len(f))</span><br><span class="line">b = nextPrime(a)</span><br><span class="line"><span class="built_in">print</span>(a,b)</span><br><span class="line">g, h = [[<span class="symbol">_</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x) <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> f] <span class="keyword">for</span> x <span class="keyword">in</span> [a, b]]</span><br><span class="line"><span class="built_in">print</span>(len(g),len(h))</span><br><span class="line"><span class="built_in">print</span>('-'*<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(len(g),len(h))</span><br><span class="line">c = nextPrime(len(f) &gt;&gt; <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> [g, h]:</span><br><span class="line">    <span class="keyword">for</span> <span class="symbol">__</span> <span class="keyword">in</span> <span class="built_in">range</span>(c):</span><br><span class="line">        <span class="symbol">_</span>.insert(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(len(<span class="symbol">_</span>) -  c):</span><br><span class="line">        <span class="symbol">_</span>[i] += <span class="symbol">_</span>[i+c]</span><br><span class="line"></span><br><span class="line">g, h = [int(''.<span class="built_in">join</span>([str(<span class="symbol">_</span>) <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="symbol">__</span>]), <span class="number">5</span>) <span class="keyword">for</span> <span class="symbol">__</span> <span class="keyword">in</span> [g, h]]</span><br><span class="line"></span><br><span class="line"># <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> [g, h]:</span><br><span class="line">#     <span class="keyword">if</span> <span class="symbol">_</span> == g:</span><br><span class="line">#         fname = 'g'</span><br><span class="line">#     <span class="keyword">else</span>:</span><br><span class="line">#         fname = 'h'</span><br><span class="line">#     of = open(f'&#123;fname&#125;.enc', 'wb')</span><br><span class="line">#     of.write(long_to_bytes(<span class="symbol">_</span>))</span><br><span class="line">#     of.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>

<p>这道题的函数很简单，一个nextPrime，顾名思义。</p>
<p>然后程序对flag取二进制，然后在最开始插入一个0。如果flag是这个比赛的常规flag，那么会以‘C’开头，而‘C’的ASCII码的二进制是“01‘开头，所以补上这个0后，不出意外这个f数组的长度应该是8 * len(flag)。</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f = [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> bin(<span class="built_in">int</span>(FLAG.<span class="built_in">hex</span>(), <span class="number">16</span>))[<span class="number">2</span>:]]</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">len</span>(f))</span><br><span class="line">f.insert(<span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>然后进行一个操作，f数组的每一个（除了最后一个）元素赋值为当前元素和后一个元素值之和。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(len(f)<span class="number">-1</span>):</span><br><span class="line">    f[<span class="built_in">i</span>] += f[<span class="built_in">i</span>+<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>然后程序获取三个值 a = nextPrime(len(f)), b = nextPrime(a), c = nextPrime(len(f) &gt;&gt; 2)。三个值的取值只与flag的长度相关。（那么显然最后可以通过爆破flag的长度来解题）</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = nextPrime(<span class="name">len</span>(<span class="name">f</span>))</span><br><span class="line">b = nextPrime(<span class="name">a</span>)</span><br></pre></td></tr></table></figure>

<p>然后是有点绕的一个数组生成 ，其实就是将数组f 分别重复 a次 和 b次。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g, h = [[_ <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> range(x) <span class="keyword">for</span> _ <span class="keyword">in</span> f] <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="selector-tag">a</span>, b]]</span><br></pre></td></tr></table></figure>

<p>接着给g，h前面插c个0，</p>
<p>然后与之前类似的一个操作，g和h数组的每一个（除了后面c个）元素赋值为当前元素和后C个元素值之后。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> [g, h]:</span><br><span class="line">    <span class="keyword">for</span> <span class="symbol">__</span> <span class="keyword">in</span> <span class="built_in">range</span>(c):</span><br><span class="line">        <span class="symbol">_</span>.insert(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(len(<span class="symbol">_</span>) -  c):</span><br><span class="line">        <span class="symbol">_</span>[i] += <span class="symbol">_</span>[i+c]</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/08/04/TiYWND1GgHLPySm.png" alt="image-20210804173731885">类似这样两个数组相加。最后还将当前得到的值拼接，视为五进制</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g, h = [int(''.<span class="built_in">join</span>([str(<span class="symbol">_</span>) <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="symbol">__</span>]), <span class="number">5</span>) <span class="keyword">for</span> <span class="symbol">__</span> <span class="keyword">in</span> [g, h]]</span><br></pre></td></tr></table></figure>

<p>所以解题思路就很清晰。</p>
<ol>
<li><p>首先我们爆破flag的长度，我们知道密文的长度为 a * f + c 和 b * f + c，而a ,b,c 又和f直接相关，所以这很好判断。</p>
</li>
<li><p>然后我们先恢复这个”移位C“的向量加，以上图为例，由于最后结果仍然保留了原来g数组的开头和结尾，故中间部分是很好恢复的。</p>
</li>
<li><p>最后我们在恢复一个”移位1“的向量加即可解出flag。</p>
</li>
</ol>
<p>（其实用不到两个enc，有一个就够了。）</p>
<p>exp.py</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> Crypto.Util.<span class="built_in">number</span> import *</span><br><span class="line"></span><br><span class="line">def to_base_5(n):</span><br><span class="line">    s = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> n:</span><br><span class="line">        s = str(n % <span class="number">5</span>) + s</span><br><span class="line">        n<span class="comment"> //= 5</span></span><br><span class="line">    <span class="literal">return</span> s</span><br><span class="line"></span><br><span class="line">def nextPrime(n):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        n += (n % <span class="number">2</span>) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(n):</span><br><span class="line">            <span class="literal">return</span> n</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'g.enc'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.<span class="built_in">read</span>()</span><br><span class="line">    g_long = bytes_to_long(data)</span><br><span class="line"></span><br><span class="line">g_base5 = to_base_5(g_long)</span><br><span class="line">g = [x <span class="keyword">for</span> x <span class="keyword">in</span> g_base5]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">len</span> <span class="keyword">in</span> range(<span class="number">55</span>):</span><br><span class="line">    f = <span class="built_in">len</span> * <span class="number">8</span></span><br><span class="line">    <span class="keyword">a</span> = nextPrime(f)</span><br><span class="line">    b = nextPrime(<span class="keyword">a</span>)</span><br><span class="line">    c = nextPrime(f &gt;&gt; <span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(g) != <span class="keyword">a</span> * f + c:</span><br><span class="line">        continue</span><br><span class="line"></span><br><span class="line">    g = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> g]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(g) - c - <span class="number">1</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        g[i] -= g[i+c]</span><br><span class="line"></span><br><span class="line">    g = g[c:c+f]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(g) - <span class="number">1</span> - <span class="number">1</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        g[i] -= g[i+<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">    g = [str(x) <span class="keyword">for</span> x <span class="keyword">in</span> g]</span><br><span class="line">    g = int(<span class="string">''</span>.join(g), <span class="number">2</span>)</span><br><span class="line">    g = long_to_bytes(g) </span><br><span class="line">    print(g)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#CCTF&#123;_how_finD_7h1s_1z_s3cr3T?!&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Titu"><a href="#Titu" class="headerlink" title="Titu"></a>Titu</h2><p>POINTS：69</p>
<p>考点：丢番图方程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">l = len(flag)</span><br><span class="line">m_1, m_2 = flag[: l // <span class="number">2</span>], flag[l // <span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">x, y = bytes_to_long(m_1), bytes_to_long(m_2)</span><br><span class="line"></span><br><span class="line">k = <span class="string">'''</span></span><br><span class="line"><span class="string">000bfdc32162934ad6a054b4b3db8578674e27a165113f8ed018cbe9112</span></span><br><span class="line"><span class="string">4fbd63144ab6923d107eee2bc0712fcbdb50d96fdf04dd1ba1b69cb1efe</span></span><br><span class="line"><span class="string">71af7ca08ddc7cc2d3dfb9080ae56861d952e8d5ec0ba0d3dfdf2d12764</span></span><br><span class="line"><span class="string">'''</span>.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>((x**<span class="number">2</span> + <span class="number">1</span>)*(y**<span class="number">2</span> + <span class="number">1</span>) - <span class="number">2</span>*(x - y)*(x*y - <span class="number">1</span>) == <span class="number">4</span>*(int(k, <span class="number">16</span>) + x*y))</span><br></pre></td></tr></table></figure>

<p>代码倒是不多，眼瞅着就是一道数学题</p>
<p>解方程 $(x^2+1)\cdot(y^2+1)-2\cdot(x-y)(xy-1) == 4\cdot(k+xy)$</p>
<p>用sage整理一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sage: var(<span class="string">'x,y'</span>)</span><br><span class="line">(x, y)</span><br><span class="line">sage: f = (x**<span class="number">2</span> + <span class="number">1</span>)*(y**<span class="number">2</span> + <span class="number">1</span>) - <span class="number">2</span>*(x - y)*(x*y - <span class="number">1</span>) - <span class="number">4</span>*x*y</span><br><span class="line">sage: f.factor()</span><br><span class="line">(x + <span class="number">1</span>)^<span class="number">2</span>*(y - <span class="number">1</span>)^<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>$(x^2+1)\cdot(y^2+1)-2\cdot(x-y)(xy-1) - 4xy = ((x+1)(y+1))^2$</p>
<p>那看看这个 k 是不是平方数</p>
<figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">sage: k</span></span><br><span class="line"><span class="xml"></span><span class="number">246389259423689900229483388850933720271363907782961941639413620688310657308991195363798484778005049234253341752674411282663124201840620584781830032437353134292733496201534415265400175632719346764031781179041636</span><span class="xml"></span></span><br><span class="line"><span class="xml">sage: factor(k)</span></span><br><span class="line"><span class="xml"></span><span class="number">2</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">3</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">11</span><span class="xml"></span><span class="keyword">^4</span><span class="xml"> * </span><span class="number">19</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">47</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">71</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">3449</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">11953</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">5485619</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">2035395403834744453</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">17258104558019725087</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"> * </span><span class="number">1357459302115148222329561139218955500171643099</span><span class="xml"></span><span class="keyword">^2</span><span class="xml"></span></span><br></pre></td></tr></table></figure>

<p>$k=(2\cdot 3\cdot 11^2\cdot 19\cdot 47\cdot 71\cdot 3449\cdot 11953\cdot 5485619\cdot 2035395403834744453 \cdot 17258104558019725087 \cdot 1357459302115148222329561139218955500171643099)^2$</p>
<p>那开个方的话，就是解 $(x+1)(y+1)=2^2\cdot 3\cdot 11^2\cdot 19\cdot 47\cdot 71\cdot 3449\cdot 11953\cdot 5485619\cdot 2035395403834744453 \cdot 17258104558019725087 \cdot 1357459302115148222329561139218955500171643099$</p>
<p>然后这里 x 和 y 的长度大小应该是比较接近的，emmm，排列组合一下？方程右边的分一分，给到 (x+1) 和 (y+1)</p>
<p>或者换个意思，显然 $(x+1) \mid 2\sqrt{k}$，遍历一下 $2\sqrt{k}$ 的因子那就</p>
<p>脚本来自<a href="https://blog.cryptohack.org/cryptoctf2021-easy#titu" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-easy#titu</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> iroot</span><br><span class="line">k = <span class="number">246389259423689900229483388850933720271363907782961941639413620688310657308991195363798484778005049234253341752674411282663124201840620584781830032437353134292733496201534415265400175632719346764031781179041636</span> </span><br><span class="line">m = iroot(k,int(<span class="number">2</span>))[<span class="number">0</span>] * <span class="number">2</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> divisors(m):   </span><br><span class="line">    x = long_to_bytes(d - <span class="number">1</span>)   </span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'CCTF&#123;'</span> <span class="keyword">in</span> x:  </span><br><span class="line">        print(x)  </span><br><span class="line">        y = (m // d) + <span class="number">1</span> </span><br><span class="line">        print(long_to_bytes(y))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="Symbols"><a href="#Symbols" class="headerlink" title="Symbols"></a>Symbols</h2><p>POINTS：70</p>
<p>考点：latex</p>
<p>h, my eyes, my eyes! People still can solve this kind of cryptography? Mathematicians should love this one! <img src="https://blog.cryptohack.org/assets/images/cryptoctf-symbols.png" alt="Symbols Challenge"></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">\Cap</span> <span class="string">\Cap</span> <span class="string">\Theta</span> <span class="string">\Finv</span> <span class="string">\&#123;</span> <span class="string">\Pi</span> <span class="string">\ltimes</span> <span class="string">\aleph</span> y <span class="string">\_</span> <span class="string">\wp</span> <span class="string">\infty</span> <span class="string">\therefore</span> <span class="string">\heartsuit</span> <span class="string">\_</span> <span class="string">\Lsh</span> <span class="string">\aleph</span> <span class="string">\Theta</span> <span class="string">\eth</span> <span class="string">\Xi</span> <span class="string">\&#125;</span></span><br></pre></td></tr></table></figure>

<p>$\Cap \Cap \Theta \Finv { \Pi \ltimes \aleph y _ \wp \infty \therefore \heartsuit _ \Lsh \aleph \Theta \eth \Xi }$</p>
<p>CCTF{Play_with_LaTeX}</p>
<h2 id="Hyper-Normal"><a href="#Hyper-Normal" class="headerlink" title="Hyper Normal"></a>Hyper Normal</h2><p>POINTS：71</p>
<p>考点：Matrix，爆破</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">random</span></span><br><span class="line"><span class="built_in">from</span> flag import FLAG</span><br><span class="line"></span><br><span class="line">p = <span class="number">8443</span></span><br><span class="line"></span><br><span class="line">def <span class="built_in">transpose</span>(x):</span><br><span class="line">    <span class="built_in">result</span> = [[x[j][i] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="built_in">len</span>(x))] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(x[<span class="number">0</span>]))]</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line">def vsum(u, v):</span><br><span class="line">    assert <span class="built_in">len</span>(u) == <span class="built_in">len</span>(v)</span><br><span class="line">    l, w = <span class="built_in">len</span>(u), []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(l):</span><br><span class="line">        w += [(u[i] + v[i]) % p]</span><br><span class="line">    <span class="literal">return</span> w</span><br><span class="line"></span><br><span class="line">def sprod(<span class="keyword">a</span>, u):</span><br><span class="line">    w = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(u)):</span><br><span class="line">        w += [<span class="keyword">a</span>*u[i] % p]</span><br><span class="line">    <span class="literal">return</span> w</span><br><span class="line"></span><br><span class="line">def <span class="built_in">encrypt</span>(msg):</span><br><span class="line">    l = <span class="built_in">len</span>(msg)</span><br><span class="line">    hyper = [ord(m)*(i+<span class="number">1</span>) <span class="keyword">for</span> (m, i) <span class="keyword">in</span> zip(list(msg), range(l))]</span><br><span class="line">    V, W = [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(l):</span><br><span class="line">        v = [<span class="number">0</span>]*i + [hyper[i]] + [<span class="number">0</span>]*(l - i - <span class="number">1</span>)</span><br><span class="line">        V.append(v)</span><br><span class="line">    <span class="built_in">random</span>.shuffle(V)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(l):</span><br><span class="line">        R, v = [<span class="built_in">random</span>.randint(<span class="number">0</span>, <span class="number">126</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(l)], [<span class="number">0</span>]*l</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(l):</span><br><span class="line">            v = vsum(v, sprod(R[j], V[j]))  </span><br><span class="line">        W.append(v)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">random</span>.shuffle(<span class="built_in">transpose</span>(W))</span><br><span class="line">    <span class="literal">return</span> W</span><br><span class="line"></span><br><span class="line">enc = <span class="built_in">encrypt</span>(FLAG)</span><br><span class="line">print(enc)</span><br><span class="line"></span><br><span class="line">output =</span><br></pre></td></tr></table></figure>

<p>分析上述源码，可以知道，</p>
<p>transpose函数为矩阵转置</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def <span class="built_in">transpose</span>(x):</span><br><span class="line">    <span class="built_in">result</span> = [[x[j][i] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="built_in">len</span>(x))] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(x[<span class="number">0</span>]))]</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br></pre></td></tr></table></figure>

<p>vsum函数为向量加法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vsum</span><span class="params">(u, v)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(u) == len(v)</span><br><span class="line">    l, w = len(u), []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(l):</span><br><span class="line">        w += [(u[i] + v[i]) % p]</span><br><span class="line">    <span class="keyword">return</span> w</span><br></pre></td></tr></table></figure>

<p>sprod函数为向量的倍增</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sprod</span><span class="params">(a, u)</span>:</span></span><br><span class="line">    w = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(u)):</span><br><span class="line">        w += [a*u[i] % p]</span><br><span class="line">    <span class="keyword">return</span> w</span><br></pre></td></tr></table></figure>

<p>看到加密函数encrypt</p>
<p>首先生成hyper向量，向量的每个值与flag每个字节相关，为 $ord(flag_i) \cdot (i+1), i \in [0,len(flag)]$，</p>
<p>然后用hyper向量生成对角矩阵V，效果为$[a,b,c,d,e] \rightarrow$ $$\begin{bmatrix}a&amp;0&amp;0&amp;0&amp;0\newline 0&amp;b&amp;0&amp;0&amp;0\newline 0&amp;0&amp;c&amp;0&amp;0\newline 0&amp;0&amp;0&amp;d&amp;0\newline 0&amp;0&amp;0&amp;0&amp;e\newline\end{bmatrix}$$</p>
<p>然后利用shuffle函数扰乱一下行向量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg)</span>:</span></span><br><span class="line">    l = len(msg)</span><br><span class="line">    hyper = [ord(m)*(i+<span class="number">1</span>) <span class="keyword">for</span> (m, i) <span class="keyword">in</span> zip(list(msg), range(l))]</span><br><span class="line">    V, W = [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(l):</span><br><span class="line">        v = [<span class="number">0</span>]*i + [hyper[i]] + [<span class="number">0</span>]*(l - i - <span class="number">1</span>)</span><br><span class="line">        V.append(v)</span><br><span class="line">    random.shuffle(V)</span><br></pre></td></tr></table></figure>

<p>之后生成 l 个 R向量，用于生成w矩阵，规则为v = vsum(v, sprod(R[j], V[j])) </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(l):</span><br><span class="line">    R, v = [random.randint(<span class="number">0</span>, <span class="number">126</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(l)], [<span class="number">0</span>]*l</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(l):</span><br><span class="line">        v = vsum(v, sprod(R[j], V[j]))  </span><br><span class="line">    W.append(v)</span><br></pre></td></tr></table></figure>

<p>可以知道，这样乘了之后，之前对于V的shuffle对于结果来说其实是没有意义。由于我们并不关心 <strong>R 的实际顺序</strong>，于是等价生成了R矩阵$$\begin{bmatrix}R_{00}&amp;R_{01}&amp;R_{02}&amp;R_{03}&amp;R_{04}\newline R_{10}&amp;R_{11}&amp;R_{12}&amp;R_{13}&amp;R_{14}\newline R_{20}&amp;R_{21}&amp;R_{22}&amp;R_{23}&amp;R_{24}\newline R_{30}&amp;R_{31}&amp;R_{32}&amp;R_{33}&amp;R_{34}\newline R_{40}&amp;R_{41}&amp;R_{42}&amp;R_{43}&amp;R_{44}\newline \end{bmatrix}$$，然后和矩阵$$V=\begin{bmatrix}a&amp;0&amp;0&amp;0&amp;0\newline 0&amp;b&amp;0&amp;0&amp;0\newline 0&amp;0&amp;c&amp;0&amp;0\newline 0&amp;0&amp;0&amp;d&amp;0\newline 0&amp;0&amp;0&amp;0&amp;e\newline\end{bmatrix}$$相乘。</p>
<p>然后这里还有一个random.shuffle(transpose(W))函数，但是这里 shuffle 的其实是矩阵transpose(W)，而函数返回的是W矩阵，所以这句代码对返回结果其实没有任何影响。</p>
<p>那么我们得到矩阵 $$M = \begin{bmatrix}a \cdot R_{00} &amp;b \cdot R_{01} &amp;c \cdot R_{02}&amp;d \cdot R_{03}&amp;e \cdot R_{04}\newline a \cdot R_{10} &amp;b \cdot R_{11}&amp;c \cdot R_{12}&amp;d \cdot R_{13}&amp;e \cdot R_{14}\newline a \cdot R_{20}&amp;b \cdot R_{21}&amp;c \cdot R_{22}&amp;d \cdot R_{23}&amp;e \cdot R_{24}\newline a \cdot R_{30}&amp;b \cdot R_{31}&amp;c \cdot R_{32}&amp;d \cdot R_{33}&amp;e \cdot R_{34}\newline a \cdot R_{40}&amp;b \cdot R_{41}&amp;c \cdot R_{42}&amp;d \cdot R_{43}&amp;e \cdot R_{44}\newline \end{bmatrix}$$</p>
<p>而加密函数中两次shuffle都没了任何影响。</p>
<p>如果此时不是由于模运算的存在且p = 8443 太小了。那么我们对矩阵列向量求一个gcd就能过获取flag的每一个字节的值了。</p>
<p>所以这里的另辟蹊径。由于模运算的存在显然是逆不回去了，我们选择正向爆破。</p>
<p>由于这里的$R_{ij} \in(0,126)$，那么我们就尝试所有的 $R$ 和每一个可见字符</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">c</span> <span class="keyword">in</span> printable:</span><br><span class="line">    possibilities = [ord(<span class="built_in">c</span>)*r*(idx+<span class="number">1</span>) % p <span class="keyword">for</span> r <span class="keyword">in</span> range(<span class="number">127</span>)]</span><br></pre></td></tr></table></figure>

<p>如果flag密文向量中的每一个值都存在于 possibilities 向量中，那么则说明我们对于该密文向量我们的明文字符选取正确。</p>
<p>脚本来自 <a href="https://blog.cryptohack.org/cryptoctf2021-easy#hyper-normal" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-easy#hyper-normal</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from string import printable</span><br><span class="line"></span><br><span class="line">p = 8443</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="keyword">open</span>(<span class="string">'output.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    enc = eval(f.read())</span><br><span class="line"></span><br><span class="line">results = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="keyword">len</span>(enc[<span class="number">0</span>])):</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> enc:</span><br><span class="line">        tmp.append(j[i])</span><br><span class="line">    results.append(tmp)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> idx, <span class="keyword">result</span> <span class="keyword">in</span> enumerate(results):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> printable:</span><br><span class="line">        possibilities = [<span class="keyword">ord</span>(c)*r*(idx+<span class="number">1</span>) % p <span class="keyword">for</span> r <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">127</span>)]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">all</span>([i <span class="keyword">in</span> possibilities <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">result</span>]):</span><br><span class="line">            flag += c</span><br><span class="line">            break</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<h2 id="Salt-and-Pepper"><a href="#Salt-and-Pepper" class="headerlink" title="Salt and Pepper"></a>Salt and Pepper</h2><p>POINTS：71</p>
<p>考点：哈希拓展攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5, sha1</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> salt, pepper</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> len(salt) == len(pepper) == <span class="number">19</span></span><br><span class="line"><span class="keyword">assert</span> md5(salt).hexdigest()    == <span class="string">'5f72c4360a2287bc269e0ccba6fc24ba'</span></span><br><span class="line"><span class="keyword">assert</span> sha1(pepper).hexdigest() == <span class="string">'3e0d000a4b0bd712999d730bc331f400221008e0'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth_check</span><span class="params">(salt, pepper, username, password, h)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sha1(pepper + password + md5(salt + username).hexdigest().encode(<span class="string">'utf-8'</span>)).hexdigest() == h</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">"  welcome to hash killers battle, your mission is to login into the "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  ultra secure authentication server with provided information!!    "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    USERNAME = <span class="string">b'n3T4Dm1n'</span></span><br><span class="line">    PASSWORD = <span class="string">b'P4s5W0rd'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[L]ogin to server \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'l'</span>:</span><br><span class="line">            pr(<span class="string">'| send your username, password as hex string separated with comma: '</span>)</span><br><span class="line">            inp = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                inp_username, inp_password = [bytes.fromhex(s) <span class="keyword">for</span> s <span class="keyword">in</span> inp.split(<span class="string">','</span>)]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">'| your input is not valid, bye!!'</span>)</span><br><span class="line">            pr(<span class="string">'| send your authentication hash: '</span>)</span><br><span class="line">            inp_hash = sc()</span><br><span class="line">            <span class="keyword">if</span> USERNAME <span class="keyword">in</span> inp_username <span class="keyword">and</span> PASSWORD <span class="keyword">in</span> inp_password:</span><br><span class="line">                <span class="keyword">if</span> auth_check(salt, pepper, inp_username, inp_password, inp_hash):</span><br><span class="line">                    die(<span class="string">f'| Congrats, you are master in hash killing, and it is the flag: <span class="subst">&#123;flag&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    die(<span class="string">'| your credential is not valid, Bye!!!'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">'| Kidding me?! Bye!!!'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>看到获取flag的条件</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> USERNAME <span class="keyword">in</span> inp_username <span class="keyword">and</span> PASSWORD <span class="keyword">in</span> inp_password:</span><br><span class="line">    <span class="keyword">if</span> auth_check(salt, pepper, inp_username, inp_password, inp_hash):</span><br><span class="line">        die(f'| Congrats, you are master <span class="keyword">in</span> hash killing, <span class="keyword">and</span> <span class="keyword">it</span> <span class="keyword">is</span> <span class="keyword">the</span> flag: &#123;flag&#125;')</span><br></pre></td></tr></table></figure>

<p>USERNAME 要在 inp_username 中，PASSWORD 要在 inp_password 中</p>
<p>然后满足</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">sha1</span><span class="params">(pepper + password + md5(salt + username)</span></span>.hexdigest().encode(<span class="string">'utf-8'</span>)).hexdigest() == h</span><br></pre></td></tr></table></figure>

<p>其中 salt，pepper 未知，但是知道 md5(salt) 和 sha1(pepper)以及salt 和 pepper 的长度；inp_username，inp_password，inp_hash可控。那么显然这里是一个哈希长度拓展攻击了。</p>
<ol>
<li><p>我们知道salt的长度以及哈希，那么我们可以使用哈希拓展攻击，附加上username 并获取到 md5(salt + username) 的哈希。</p>
<p><code>./hash_extender -f md5 -d  -s  5f72c4360a2287bc269e0ccba6fc24ba -a n3T4Dm1n -l 19</code></p>
<p>得到</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">95623660</span>d<span class="number">3</span>d<span class="number">04</span><span class="keyword">c</span><span class="number">7680</span>a<span class="number">52679e35</span>f<span class="number">041</span><span class="keyword">c</span></span><br><span class="line">\<span class="keyword">x</span><span class="number">80</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">98</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>n<span class="number">3</span>T<span class="number">4</span>Dm<span class="number">1</span>n</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后我们知道 pepper 的长度以及哈希，还知道 password，我们再次使用哈希拓展攻击，附加上 password+md5(salt + username) 的哈希并获取到最终的哈希</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hash_extender -f sha<span class="number">1</span> -d  -s  <span class="number">3e0</span>d<span class="number">000</span>a<span class="number">4</span>b<span class="number">0</span>bd<span class="number">712999</span>d<span class="number">730</span>bc<span class="number">331</span>f<span class="number">400221008e0</span> -a P<span class="number">4</span>s<span class="number">5</span>W<span class="number">0</span>rd<span class="number">95623660</span>d<span class="number">3</span>d<span class="number">04</span><span class="keyword">c</span><span class="number">7680</span>a<span class="number">52679e35</span>f<span class="number">041</span><span class="keyword">c</span> -l <span class="number">19</span></span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">83875</span>efbe<span class="number">020</span>ced<span class="number">3e2</span><span class="keyword">c</span><span class="number">5</span>ecc<span class="number">908</span>edc<span class="number">98481</span>eba<span class="number">47</span>f</span><br><span class="line">\<span class="keyword">x</span><span class="number">80</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">98</span>P<span class="number">4</span>s<span class="number">5</span>W<span class="number">0</span>rd<span class="number">95623660</span>d<span class="number">3</span>d<span class="number">04</span><span class="keyword">c</span><span class="number">7680</span>a<span class="number">52679e35</span>f<span class="number">041</span><span class="keyword">c</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>那么我们以</p>
<p>用户名：<code>\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x98\x00\x00\x00\x00\x00\x00\x00n3T4Dm1n</code></p>
<p>密码：<code>\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x98P4s5W0rd</code></p>
<p>哈希：</p>
<p><code>83875efbe020ced3e2c5ecc908edc98481eba47f</code></p>
<p>作为输入即可通过验证，获取flag</p>
</li>
</ol>
<p>工具hash_extender来自github：<a href="https://github.com/iagox86/hash_extender" target="_blank" rel="noopener">https://github.com/iagox86/hash_extender</a></p>
<p>下述脚本来自：<a href="https://pwnthenope.pythonanywhere.com/writeups/salt_and_pepper.html" target="_blank" rel="noopener">https://pwnthenope.pythonanywhere.com/writeups/salt_and_pepper.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote, process</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    local = <span class="literal">False</span></span><br><span class="line">    username = <span class="string">'n3T4Dm1n'</span></span><br><span class="line">    password = <span class="string">'P4s5W0rd'</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        md5_salt = <span class="string">'7ae4d6728e33ff002bf67a2e5194ccb1'</span></span><br><span class="line">        sha1_pepper = <span class="string">'8923ecf3550e9ca6cbb26066590fb619a2d65e71'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        md5_salt = <span class="string">'5f72c4360a2287bc269e0ccba6fc24ba'</span></span><br><span class="line">        sha1_pepper = <span class="string">'3e0d000a4b0bd712999d730bc331f400221008e0'</span></span><br><span class="line"></span><br><span class="line">    result = subprocess.check_output([<span class="string">"./hash_extender"</span>, <span class="string">"-f"</span>, <span class="string">"md5"</span>, <span class="string">"-d"</span>, <span class="string">""</span>, <span class="string">"-s"</span>, md5_salt, <span class="string">"-a"</span>, username, <span class="string">"-l"</span>, <span class="string">"19"</span>]).decode()</span><br><span class="line">    new_signature, new_username = re.findall(<span class="string">r"[a-fA-F0-9]&#123;4,&#125;"</span>, result) <span class="comment"># hex-encoded</span></span><br><span class="line">    </span><br><span class="line">    result = subprocess.check_output([<span class="string">"./hash_extender"</span>, <span class="string">"-f"</span>, <span class="string">"sha1"</span>, <span class="string">"-d"</span>, <span class="string">""</span>, <span class="string">"-s"</span>, sha1_pepper, <span class="string">"-a"</span>, password + new_signature, <span class="string">"-l"</span>, <span class="string">"19"</span>]).decode()</span><br><span class="line">    final_signature, new_password = re.findall(<span class="string">r"[a-fA-F0-9]&#123;4,&#125;"</span>, result) <span class="comment"># hex-encoded</span></span><br><span class="line">    </span><br><span class="line">    new_password = new_password[:<span class="number">-64</span>]</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"intermediate signature ="</span>, new_signature)</span><br><span class="line">    print(<span class="string">"final signature ="</span>, final_signature)</span><br><span class="line">    print(<span class="string">"username ="</span>, new_username)</span><br><span class="line">    print(<span class="string">"password ="</span>, new_password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        r = process([<span class="string">"python"</span>, <span class="string">"salt_pepper.py"</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = remote(<span class="string">"02.cr.yp.toc.tf"</span>, <span class="number">28010</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b'uit'</span>)</span><br><span class="line">    r.recvline()</span><br><span class="line">    r.sendline(<span class="string">b'L'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b'comma:'</span>)</span><br><span class="line">    r.recvline()</span><br><span class="line">    r.sendline(<span class="string">","</span>.join([new_username, new_password]).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b'hash:'</span>)</span><br><span class="line">    r.recvline()</span><br><span class="line">    r.sendline(final_signature.encode())</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="Hamul"><a href="#Hamul" class="headerlink" title="Hamul"></a>Hamul</h2><p>POINTS：83</p>
<p>考点：RSA</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line">from flag import flag</span><br><span class="line"></span><br><span class="line">nbit = <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    p, q = getPrime(nbit), getPrime(nbit)</span><br><span class="line">    P = <span class="keyword">int</span>(<span class="keyword">str</span>(p) + <span class="keyword">str</span>(q))</span><br><span class="line">    Q = <span class="keyword">int</span>(<span class="keyword">str</span>(q) + <span class="keyword">str</span>(p))</span><br><span class="line">    PP = <span class="keyword">int</span>(<span class="keyword">str</span>(P) + <span class="keyword">str</span>(Q))</span><br><span class="line">    QQ = <span class="keyword">int</span>(<span class="keyword">str</span>(Q) + <span class="keyword">str</span>(P))</span><br><span class="line">    <span class="keyword">if</span> isPrime(PP) <span class="keyword">and</span> isPrime(QQ):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">n = PP * QQ</span><br><span class="line">m = bytes_to_long(flag.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">if</span> m &lt; n:</span><br><span class="line">    c = pow(m, <span class="number">65537</span>, n)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'n ='</span>, n)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'c ='</span>, c)</span><br><span class="line"></span><br><span class="line"><span class="meta"># n = <span class="number">98027132963374134222724984677805364225505454302688777506193468362969111927940238887522916586024601699661401871147674624868439577416387122924526713690754043</span></span></span><br><span class="line"><span class="meta"># c = <span class="number">42066148309824022259115963832631631482979698275547113127526245628391950322648581438233116362337008919903556068981108710136599590349195987128718867420453399</span></span></span><br></pre></td></tr></table></figure>

<p>emmm，RSA经典整活，就是分解特殊构造的n。</p>
<p>我们设 $x=len(q),y=len(p),x’=len(Q),y’=len(P)$）</p>
<p>那么有</p>
<p>$PP = P \cdot 10^{x’} + Q = (p\cdot 10^{x} +q)\cdot 10^{x’} + (q\cdot 10^{y} +p)=p\cdot (10^{x+x’})+q\cdot (10^{x’}+10^{y})+p$</p>
<p>$QQ = Q \cdot 10^{y’} + P = (q\cdot 10^{y} +p)\cdot 10^{y’} + (p\cdot 10^{x} +q) =q \cdot(10^{y+y’}) + p \cdot(10^y+10^{y’})+q$</p>
<p>$N = PP \cdot QQ = pq\cdot10^{x+x’+y+y’} + \cdots+p\cdot q$</p>
<p>只要我们能够解出 $pq$，因为他只有 128bit，能够大力分解，然后我们就可以解题了。</p>
<p>看着这里 N 的形式，本地测一下，会发现 N 的最高十八位就是 $pq$ 的高位，N 的最低十八、十九位就是 $pq$ 的低位。然后中间会缺一到两位，要爆破一下。</p>
<p>脚本来自<a href="https://blog.cryptohack.org/cryptoctf2021-easy#hamul" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-easy#hamul</a></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">from tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">n = <span class="number">98027132963374134222724984677805364225505454302688777506193468362969111927940238887522916586024601699661401871147674624868439577416387122924526713690754043</span></span><br><span class="line">c = <span class="number">42066148309824022259115963832631631482979698275547113127526245628391950322648581438233116362337008919903556068981108710136599590349195987128718867420453399</span></span><br><span class="line"></span><br><span class="line">low = <span class="built_in">str</span>(n)[<span class="number">-18</span>:]</span><br><span class="line">high = <span class="built_in">str</span>(n)[:<span class="number">18</span>]</span><br><span class="line">pq_prob = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j in range(<span class="number">10</span>):</span><br><span class="line">        pq_prob.<span class="built_in">append</span>(<span class="built_in">int</span>(high + <span class="built_in">str</span>(i) + <span class="built_in">str</span>(j)+ low))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> x in tqdm(pq_prob):</span><br><span class="line">    f = factor(x)</span><br><span class="line">    <span class="keyword">if</span> (len(f) == <span class="number">2</span> and f[<span class="number">0</span>][<span class="number">0</span>].nbits() == <span class="number">64</span>):</span><br><span class="line">        p, q = f[<span class="number">0</span>][<span class="number">0</span>], f[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">P = <span class="built_in">int</span>(<span class="built_in">str</span>(p) + <span class="built_in">str</span>(q))</span><br><span class="line">Q = <span class="built_in">int</span>(<span class="built_in">str</span>(q) + <span class="built_in">str</span>(p))</span><br><span class="line">PP = <span class="built_in">int</span>(<span class="built_in">str</span>(P) + <span class="built_in">str</span>(Q))</span><br><span class="line">QQ = <span class="built_in">int</span>(<span class="built_in">str</span>(Q) + <span class="built_in">str</span>(P))</span><br><span class="line">N = PP * QQ</span><br><span class="line"><span class="keyword">assert</span> N == n</span><br><span class="line">phi = (PP<span class="number">-1</span>) * (QQ<span class="number">-1</span>)</span><br><span class="line">d = inverse(e, phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, p*q)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></table></figure>

<h2 id="Triplet"><a href="#Triplet" class="headerlink" title="Triplet"></a>Triplet</h2><p>POINTS：91</p>
<p>考点：RSA，欧拉函数</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env <span class="keyword">python3</span></span><br><span class="line"></span><br><span class="line">from Crypto.Util.<span class="keyword">number</span> import *</span><br><span class="line">from random import randint</span><br><span class="line">import sys</span><br><span class="line">flag=<span class="string">'a'</span>*<span class="number">55</span></span><br><span class="line"></span><br><span class="line">def die(*<span class="keyword">args</span>):</span><br><span class="line">	pr(*<span class="keyword">args</span>)</span><br><span class="line">	<span class="keyword">quit</span>()</span><br><span class="line"></span><br><span class="line">def pr(*<span class="keyword">args</span>):</span><br><span class="line">	s = <span class="string">" "</span>.<span class="keyword">join</span>(<span class="keyword">map</span>(str, <span class="keyword">args</span>))</span><br><span class="line">	sys.stdout.<span class="keyword">write</span>(s + <span class="string">"\n"</span>)</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">def sc():</span><br><span class="line">	<span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">	border = <span class="string">"+"</span></span><br><span class="line">	pr(border*<span class="number">72</span>)</span><br><span class="line">	pr(border, <span class="string">" hi talented cryptographers, the mission is to find the three RSA   "</span>, border)</span><br><span class="line">	pr(border, <span class="string">" modulus with the same public and private exponent! Try your chance!"</span>, border)</span><br><span class="line">	pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">	nbit = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> True:</span><br><span class="line">		pr(<span class="string">"| Options: \n|\t[S]end the three nbit prime pairs \n|\t[Q]uit"</span>)</span><br><span class="line">		ans = sc().lower()</span><br><span class="line">		order = [<span class="string">'first'</span>, <span class="string">'second'</span>, <span class="string">'third'</span>]</span><br><span class="line">		<span class="keyword">if</span> ans == <span class="string">'s'</span>:</span><br><span class="line">			<span class="keyword">P</span>, <span class="keyword">N</span> = [], []</span><br><span class="line">			<span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">				pr(<span class="string">"| Send the "</span> + order[i] + <span class="string">" RSA primes such that nbit &gt;= "</span> + str(nbit) + <span class="string">": p_"</span> + str(i+<span class="number">1</span>) + <span class="string">", q_"</span> + str(i+<span class="number">1</span>) + <span class="string">" "</span>)</span><br><span class="line">				params = sc()</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					<span class="keyword">p</span>, q = params.<span class="keyword">split</span>(<span class="string">','</span>)</span><br><span class="line">					<span class="keyword">p</span>, q = <span class="keyword">int</span>(<span class="keyword">p</span>), <span class="keyword">int</span>(q)</span><br><span class="line">				excep<span class="variable">t:</span></span><br><span class="line">					die(<span class="string">"| your primes are not valid!!"</span>)</span><br><span class="line">				<span class="keyword">if</span> isPrime(<span class="keyword">p</span>) <span class="built_in">and</span> isPrime(q) <span class="built_in">and</span> <span class="built_in">len</span>(bin(<span class="keyword">p</span>)[<span class="number">2</span>:]) &gt;= nbit <span class="built_in">and</span> <span class="built_in">len</span>(bin(q)[<span class="number">2</span>:]) &gt;= nbi<span class="variable">t:</span></span><br><span class="line">					<span class="keyword">P</span>.<span class="keyword">append</span>((<span class="keyword">p</span>, q))</span><br><span class="line">					n = <span class="keyword">p</span> * q</span><br><span class="line">					<span class="keyword">N</span>.<span class="keyword">append</span>(n)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					die(<span class="string">"| your input is not desired prime, Bye!"</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(<span class="keyword">set</span>(<span class="keyword">N</span>)) == <span class="number">3</span>:</span><br><span class="line">				pr(<span class="string">"| Send the public and private exponent: e, d "</span>)</span><br><span class="line">				params = sc()</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					<span class="keyword">e</span>, d = params.<span class="keyword">split</span>(<span class="string">','</span>)</span><br><span class="line">					<span class="keyword">e</span>, d = <span class="keyword">int</span>(<span class="keyword">e</span>), <span class="keyword">int</span>(d)</span><br><span class="line">				excep<span class="variable">t:</span></span><br><span class="line">					die(<span class="string">"| your parameters are not valid!! Bye!!!"</span>)</span><br><span class="line">				phi_1 = (<span class="keyword">P</span>[<span class="number">0</span>][<span class="number">0</span>] - <span class="number">1</span>)*(<span class="keyword">P</span>[<span class="number">0</span>][<span class="number">1</span>] - <span class="number">1</span>)</span><br><span class="line">				phi_2 = (<span class="keyword">P</span>[<span class="number">1</span>][<span class="number">0</span>] - <span class="number">1</span>)*(<span class="keyword">P</span>[<span class="number">1</span>][<span class="number">1</span>] - <span class="number">1</span>)</span><br><span class="line">				phi_3 = (<span class="keyword">P</span>[<span class="number">2</span>][<span class="number">0</span>] - <span class="number">1</span>)*(<span class="keyword">P</span>[<span class="number">2</span>][<span class="number">1</span>] - <span class="number">1</span>)</span><br><span class="line">				<span class="keyword">if</span> <span class="number">1</span> &lt; <span class="keyword">e</span> &lt; <span class="built_in">min</span>([phi_1, phi_2, phi_3]) <span class="built_in">and</span> <span class="number">1</span> &lt; d &lt; <span class="built_in">min</span>([phi_1, phi_2, phi_3]):</span><br><span class="line">					<span class="keyword">b</span> = (<span class="keyword">e</span> * d % phi_1 == <span class="number">1</span>) <span class="built_in">and</span> (<span class="keyword">e</span> * d % phi_2 == <span class="number">1</span>) <span class="built_in">and</span> (<span class="keyword">e</span> * d % phi_3 == <span class="number">1</span>)</span><br><span class="line">					<span class="keyword">if</span> <span class="variable">b:</span></span><br><span class="line">						die(<span class="string">"| You got the flag:"</span>, FLAG)</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						die(<span class="string">"| invalid exponents, bye!!!"</span>)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					die(<span class="string">"| the exponents are too small or too large!"</span>)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				die(<span class="string">"| kidding me?!!, bye!"</span>)</span><br><span class="line">		elif ans == <span class="string">'q'</span>:</span><br><span class="line">			die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>

<p>可以看到题目逻辑很简单，就是让你输入三对 p,q，在同一对 e,d的情况下，均满足 $e \cdot d \equiv 1 \pmod {(p-1) \cdot (q-1)}$</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="number">1</span> &lt; e &lt; min([phi_1, phi_2, phi_3]) <span class="literal">and</span> <span class="number">1</span> &lt; d &lt; min([phi_1, phi_2, phi_3]):</span><br><span class="line">	<span class="attr">b</span> = (e * d % <span class="attr">phi_1</span> == <span class="number">1</span>) <span class="literal">and</span> (e * d % <span class="attr">phi_2</span> == <span class="number">1</span>) <span class="literal">and</span> (e * d % <span class="attr">phi_3</span> == <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>满足 $e \cdot d \equiv 1 \pmod {(p-1) \cdot (q-1)}$，显然会满足 $e \cdot d \equiv 1 \pmod {LCM((p-1) \cdot (q-1))}$</p>
<p>那么很直观的，我们想要找到一个素数 $p_0$，满足 $p_1 = \frac{p_0-1}{2}+1$ 也是一个素数，这样$(p_1-1)\cdot(q-1) = \frac{(p_0-1)}{2}\cdot(q-1)$，就能够满足条件。</p>
<p>同理可以再找一个$p_2 = \frac{p_0-1}{4}+1$</p>
<p>最后找一个合适的公钥e，1 &lt; e &lt; min([phi_1, phi_2, phi_3])，然后生成私钥 d = inverse(e，min([phi_1, phi_2, phi_3]))，就能够通过验证，获取flag。</p>
<p>何为合适？能过所有的assert的呗。(因为这里要求d = inverse(e，<strong>min</strong>([phi_1, phi_2, phi_3]))，所以会满足 $e \cdot d \equiv 1 \pmod{(p-1)\cdot(q-1)}$ ，但不一定满足$e \cdot d \equiv 1 \pmod{2\cdot (p-1)\cdot(q-1)}$</p>
<p>exp.py</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number <span class="built_in">import</span> *</span><br><span class="line">from gmpy2 <span class="built_in">import</span> is_prime</span><br><span class="line">from tqdm <span class="built_in">import</span> tqdm</span><br><span class="line"><span class="comment"># for _ in tqdm(range(1000)):</span></span><br><span class="line"><span class="comment">#     FLAG=0</span></span><br><span class="line"><span class="comment">#     p = getPrime(170)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     if is_prime(2*p-1):</span></span><br><span class="line"><span class="comment">#         FLAG+=1</span></span><br><span class="line"><span class="comment">#     if is_prime(4*p-3):</span></span><br><span class="line"><span class="comment">#         FLAG+=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     if FLAG &gt;= 2:</span></span><br><span class="line"><span class="comment">#         print(p,2*p-1,4*p-3)</span></span><br><span class="line"><span class="comment">#         break</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#46%|████████████████████████████████████▋                                          | 464/1000 [00:06&lt;00:06, 79.88it/s]1449368757550124595394471100025923300308378816147831 2898737515100249190788942200051846600616757632295661 5797475030200498381577884400103693201233515264591321</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">q</span> = getPrime(<span class="number">160</span>)</span><br><span class="line"><span class="attr">p0</span> = <span class="number">1449368757550124595394471100025923300308378816147831</span></span><br><span class="line"><span class="attr">p1</span> = <span class="number">2898737515100249190788942200051846600616757632295661</span></span><br><span class="line"><span class="attr">p2</span> = <span class="number">5797475030200498381577884400103693201233515264591321</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phi1</span> = (q-<span class="number">1</span>)*(p0-<span class="number">1</span>)</span><br><span class="line"><span class="attr">phi2</span> = (q-<span class="number">1</span>)*(p1-<span class="number">1</span>)</span><br><span class="line"><span class="attr">phi3</span> = (q-<span class="number">1</span>)*(p2-<span class="number">1</span>)</span><br><span class="line">while True:</span><br><span class="line">    <span class="attr">e</span> = getPrime(<span class="number">160</span>)</span><br><span class="line">    <span class="attr">d</span> = inverse(e,min(phi1,phi2,phi3))</span><br><span class="line">    <span class="keyword">if</span> e*d % <span class="attr">phi1</span> == <span class="number">1</span> <span class="literal">and</span> e*d % <span class="attr">phi2</span> == <span class="number">1</span> <span class="literal">and</span> e*d % <span class="attr">phi3</span> == <span class="number">1</span> <span class="literal">and</span> <span class="number">1</span> &lt; e &lt; min(phi1,phi2,phi3) <span class="literal">and</span> <span class="number">1</span> &lt; d &lt; min(phi1,phi2,phi3):</span><br><span class="line">        print(e,d)</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#CCTF&#123;7HrE3_b4Bie5_c4rRi3d_dUr1nG_0Ne_pr39naNcY_Ar3_triplets&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Onlude"><a href="#Onlude" class="headerlink" title="Onlude"></a>Onlude</h2><p>POINTS：95</p>
<p>考点：线性代数</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sage</span></span><br><span class="line"></span><br><span class="line">from sage.all import *</span><br><span class="line">from flag import flag</span><br><span class="line"></span><br><span class="line">global p, alphabet</span><br><span class="line">p = 71</span><br><span class="line">alphabet = '=0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$!?_&#123;&#125;&lt;&gt;'</span><br><span class="line"></span><br><span class="line">flag = flag.lstrip('CCTF&#123;').rstrip('&#125;')</span><br><span class="line">assert len(flag) == 24</span><br><span class="line"></span><br><span class="line">def cross(m):</span><br><span class="line">    return alphabet.index(m)</span><br><span class="line"></span><br><span class="line">def prepare(msg):</span><br><span class="line">    A = zero_matrix(GF(p), 11, 11)</span><br><span class="line">    for k in range(len(msg)):</span><br><span class="line">        i, j = 5*k // 11, 5*k % 11</span><br><span class="line">        A[i, j] = cross(msg[k])</span><br><span class="line">    return A</span><br><span class="line"></span><br><span class="line">def keygen():</span><br><span class="line">    R = random_matrix(GF(p), 11, 11)</span><br><span class="line">    while True:</span><br><span class="line">        S = random_matrix(GF(p), 11, 11)</span><br><span class="line">        if S.rank() == 11:</span><br><span class="line">            _, L, U = S.LU()</span><br><span class="line">            return R, L, U</span><br><span class="line"></span><br><span class="line">def encrypt(A, key):</span><br><span class="line">    R, L, U = key</span><br><span class="line">    S = L * U</span><br><span class="line">    X = A + R</span><br><span class="line">    Y = S * X</span><br><span class="line">    E = L.inverse() * Y</span><br><span class="line">    return E</span><br><span class="line"></span><br><span class="line">A = prepare(flag)</span><br><span class="line">key = keygen()</span><br><span class="line">R, L, U = key</span><br><span class="line">S = L * U</span><br><span class="line">E = encrypt(A, key)</span><br><span class="line">print(f'E = \n&#123;E&#125;')</span><br><span class="line">print(f'L * U * L = \n&#123;L * U * L&#125;')</span><br><span class="line">print(f'L^(-1) * S^2 * L = \n&#123;L.inverse() * S**2 * L&#125;')</span><br><span class="line">print(f'R^(-1) * S^8 = \n&#123;R.inverse() * S**8&#125;')</span><br><span class="line">E = </span><br><span class="line">[25<span class="number"> 55 </span>61<span class="number"> 28 </span>11<span class="number"> 46 </span>19<span class="number"> 50 </span>37 <span class="number"> 5 </span>21]</span><br><span class="line">[20<span class="number"> 57 </span>39 <span class="number"> 9 </span>25<span class="number"> 37 </span>63<span class="number"> 31 </span>70<span class="number"> 15 </span>47]</span><br><span class="line">[56<span class="number"> 31 </span><span class="number"> 1 </span><span class="number"> 1 </span>50<span class="number"> 67 </span>38<span class="number"> 14 </span>42<span class="number"> 46 </span>14]</span><br><span class="line">[42<span class="number"> 54 </span>38<span class="number"> 22 </span>19<span class="number"> 55 </span><span class="number"> 7 </span>18<span class="number"> 45 </span>53 39]</span><br><span class="line">[55<span class="number"> 26 </span>42<span class="number"> 15 </span>48 <span class="number"> 6 </span>24 <span class="number"> 4 </span>17<span class="number"> 60 </span>64]</span><br><span class="line">[<span class="number"> 1 </span>38<span class="number"> 50 </span>10<span class="number"> 19 </span>57<span class="number"> 26 </span>48 <span class="number"> 6 </span><span class="number"> 4 </span>14]</span><br><span class="line">[13 <span class="number"> 4 </span>38<span class="number"> 54 </span>23<span class="number"> 34 </span>54<span class="number"> 42 </span>15<span class="number"> 56 </span>29]</span><br><span class="line">[26<span class="number"> 66 </span><span class="number"> 8 </span>48 <span class="number"> 6 </span>70<span class="number"> 44 </span><span class="number"> 8 </span>67<span class="number"> 68 </span>65]</span><br><span class="line">[56<span class="number"> 67 </span>49<span class="number"> 61 </span>18<span class="number"> 34 </span>53<span class="number"> 21 </span><span class="number"> 7 </span>48 32]</span><br><span class="line">[15<span class="number"> 70 </span>10<span class="number"> 34 </span><span class="number"> 1 </span>57<span class="number"> 70 </span>27<span class="number"> 12 </span>33 46]</span><br><span class="line">[25<span class="number"> 29 </span>20<span class="number"> 21 </span>30<span class="number"> 55 </span>63<span class="number"> 49 </span>11<span class="number"> 36 </span> 7]</span><br><span class="line">L * U * L = </span><br><span class="line">[50 <span class="number"> 8 </span>21<span class="number"> 16 </span>13<span class="number"> 33 </span><span class="number"> 2 </span>12<span class="number"> 35 </span>20 14]</span><br><span class="line">[36<span class="number"> 55 </span>36<span class="number"> 34 </span>27<span class="number"> 28 </span>23<span class="number"> 21 </span>62<span class="number"> 17 </span> 8]</span><br><span class="line">[56<span class="number"> 26 </span>49<span class="number"> 39 </span>43<span class="number"> 30 </span>35<span class="number"> 46 </span><span class="number"> 0 </span>58 43]</span><br><span class="line">[11<span class="number"> 25 </span>25<span class="number"> 35 </span>29 <span class="number"> 0 </span>22<span class="number"> 38 </span>53<span class="number"> 51 </span>58]</span><br><span class="line">[34<span class="number"> 14 </span>69<span class="number"> 68 </span><span class="number"> 5 </span>32<span class="number"> 27 </span><span class="number"> 4 </span>27<span class="number"> 62 </span>15]</span><br><span class="line">[46<span class="number"> 49 </span>36<span class="number"> 42 </span>26<span class="number"> 12 </span>28<span class="number"> 60 </span>54<span class="number"> 66 </span>23]</span><br><span class="line">[69<span class="number"> 55 </span>30<span class="number"> 65 </span>56<span class="number"> 13 </span>14<span class="number"> 36 </span>26<span class="number"> 46 </span>48]</span><br><span class="line">[25<span class="number"> 48 </span>16<span class="number"> 20 </span>34<span class="number"> 57 </span>64<span class="number"> 62 </span>61<span class="number"> 25 </span>62]</span><br><span class="line">[68<span class="number"> 39 </span>11<span class="number"> 40 </span>25<span class="number"> 11 </span><span class="number"> 7 </span>40<span class="number"> 24 </span>43 65]</span><br><span class="line">[54<span class="number"> 20 </span>40<span class="number"> 59 </span>52<span class="number"> 60 </span>37<span class="number"> 14 </span>32<span class="number"> 44 </span> 4]</span><br><span class="line">[45<span class="number"> 20 </span><span class="number"> 7 </span>26<span class="number"> 45 </span>45<span class="number"> 50 </span>17<span class="number"> 41 </span>59 50]</span><br><span class="line">L^(-1) * S^2 * L = </span><br><span class="line">[34<span class="number"> 12 </span>70<span class="number"> 21 </span>36 <span class="number"> 2 </span><span class="number"> 2 </span>43 <span class="number"> 7 </span>14  2]</span><br><span class="line">[<span class="number"> 1 </span>54<span class="number"> 59 </span>12<span class="number"> 64 </span>35 <span class="number"> 9 </span><span class="number"> 7 </span>49<span class="number"> 11 </span>49]</span><br><span class="line">[69<span class="number"> 14 </span>10<span class="number"> 19 </span>16<span class="number"> 27 </span>11 <span class="number"> 9 </span>26<span class="number"> 10 </span>45]</span><br><span class="line">[70<span class="number"> 17 </span>41<span class="number"> 13 </span>35<span class="number"> 58 </span>19<span class="number"> 29 </span>70 <span class="number"> 5 </span>30]</span><br><span class="line">[68<span class="number"> 69 </span>67<span class="number"> 37 </span>63<span class="number"> 69 </span>15<span class="number"> 64 </span>66<span class="number"> 28 </span>26]</span><br><span class="line">[18<span class="number"> 29 </span>64<span class="number"> 38 </span>63<span class="number"> 67 </span>15<span class="number"> 27 </span>64 <span class="number"> 6 </span>26]</span><br><span class="line">[<span class="number"> 0 </span>12<span class="number"> 40 </span>41<span class="number"> 48 </span>30<span class="number"> 46 </span>52<span class="number"> 39 </span>48 58]</span><br><span class="line">[22 <span class="number"> 3 </span>28<span class="number"> 35 </span>55<span class="number"> 30 </span>15<span class="number"> 17 </span>22<span class="number"> 49 </span>55]</span><br><span class="line">[50<span class="number"> 55 </span>55<span class="number"> 61 </span>45<span class="number"> 23 </span>24<span class="number"> 32 </span>10<span class="number"> 59 </span>69]</span><br><span class="line">[27<span class="number"> 21 </span>68<span class="number"> 56 </span>67<span class="number"> 49 </span>64<span class="number"> 53 </span>42<span class="number"> 46 </span>14]</span><br><span class="line">[42<span class="number"> 66 </span>16<span class="number"> 29 </span>42<span class="number"> 42 </span>23<span class="number"> 49 </span>43 <span class="number"> 3 </span>23]</span><br><span class="line">R^(-1) * S^8 = </span><br><span class="line">[51 <span class="number"> 9 </span>22<span class="number"> 61 </span>63<span class="number"> 14 </span><span class="number"> 2 </span><span class="number"> 4 </span>18<span class="number"> 18 </span>23]</span><br><span class="line">[33<span class="number"> 53 </span>31<span class="number"> 31 </span>62<span class="number"> 21 </span>66 <span class="number"> 7 </span>66<span class="number"> 68 </span> 7]</span><br><span class="line">[59<span class="number"> 19 </span>32<span class="number"> 21 </span>13<span class="number"> 34 </span>16<span class="number"> 43 </span>49<span class="number"> 25 </span> 7]</span><br><span class="line">[44<span class="number"> 37 </span><span class="number"> 4 </span>29<span class="number"> 70 </span>50<span class="number"> 46 </span>39<span class="number"> 55 </span><span class="number"> 4 </span>65]</span><br><span class="line">[29<span class="number"> 63 </span>29<span class="number"> 43 </span>47<span class="number"> 28 </span>40<span class="number"> 33 </span><span class="number"> 0 </span>62  8]</span><br><span class="line">[45<span class="number"> 62 </span>36<span class="number"> 68 </span>10<span class="number"> 66 </span>26<span class="number"> 48 </span>10 <span class="number"> 6 </span>61]</span><br><span class="line">[43<span class="number"> 30 </span>25<span class="number"> 18 </span>23<span class="number"> 38 </span>61 <span class="number"> 0 </span>52<span class="number"> 46 </span>35]</span><br><span class="line">[<span class="number"> 3 </span>40 <span class="number"> 6 </span>45<span class="number"> 20 </span>55<span class="number"> 35 </span>67<span class="number"> 25 </span>14 63]</span><br><span class="line">[15<span class="number"> 30 </span>61<span class="number"> 66 </span>25<span class="number"> 33 </span>14<span class="number"> 20 </span>60<span class="number"> 50 </span>50]</span><br><span class="line">[29<span class="number"> 15 </span>53<span class="number"> 22 </span>55<span class="number"> 64 </span>69<span class="number"> 56 </span>44<span class="number"> 40 </span> 8]</span><br><span class="line">[28<span class="number"> 40 </span>69<span class="number"> 60 </span>28<span class="number"> 41 </span><span class="number"> 9 </span>14<span class="number"> 29 </span><span class="number"> 4 </span>29]</span><br></pre></td></tr></table></figure>

<p>看看怎么处理flag的先</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cross</span><span class="params">(m)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> alphabet.index(m)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(msg)</span>:</span></span><br><span class="line">    A = zero_matrix(GF(p), <span class="number">11</span>, <span class="number">11</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(len(msg)):</span><br><span class="line">        i, j = <span class="number">5</span>*k // <span class="number">11</span>, <span class="number">5</span>*k % <span class="number">11</span></span><br><span class="line">        A[i, j] = cross(msg[k])</span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"></span><br><span class="line">A = prepare(flag)</span><br></pre></td></tr></table></figure>

<p>建了个 $11 \times 11$ 的零矩阵，然后将 flag 的每一个字符转化为在字符集里的索引放了进去，两两间隔4个元素，类似这样</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[<span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br><span class="line">[<span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">11</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>然后生成了一个密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">()</span>:</span></span><br><span class="line">    R = random_matrix(GF(p), <span class="number">11</span>, <span class="number">11</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        S = random_matrix(GF(p), <span class="number">11</span>, <span class="number">11</span>)</span><br><span class="line">        <span class="keyword">if</span> S.rank() == <span class="number">11</span>:</span><br><span class="line">            _, L, U = S.LU()</span><br><span class="line">            <span class="keyword">return</span> R, L, U</span><br><span class="line">            </span><br><span class="line">key = keygen()</span><br></pre></td></tr></table></figure>

<p>R 和 S 是一个随机矩阵，</p>
<p>L，U 分别是 S的下三角矩阵和上三角矩阵，会有 $S==L \times U$</p>
<p>然后就是加密</p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def encrypt(A, key):</span><br><span class="line">    <span class="keyword">R</span>, L, U = key</span><br><span class="line">    S = L * U</span><br><span class="line">    <span class="keyword">X</span> = A + <span class="keyword">R</span></span><br><span class="line">    <span class="keyword">Y</span> = S * <span class="keyword">X</span></span><br><span class="line">    E = L.inverse() * <span class="keyword">Y</span></span><br><span class="line">    return E</span><br></pre></td></tr></table></figure>

<p>$E =  L^{-1} \times Y = L^{-1} \times S \times X  $</p>
<p>$E = L^{-1} \times L \times U \times(A+R) $</p>
<p>$E = U \times A + U \times R$</p>
<p>然后题目提供了 $L \times U \times L,L^{-1} \times S^2 \times L,R^{-1} \times S^8$</p>
<p>想法就是怎么用题目提供的这几个东西把 $E$ 里的 $A$ 提出来叭</p>
<p>首先的一个想法是把 $R$ 搞出来，因为 $E$ 里面有 $R$，</p>
<p>因为我们有 $R^{-1} \times S^8$，所以我们搞到 $S^8$ 就行</p>
<p>$S^8 = (L \times U)^8 = (L \times U \times L \times U)^4$</p>
<p>因为我们有 $L \times \ U \times L$ ，所以我们搞到 $U$ 就行</p>
<p>注意到 $L^{-1} \times S^2 \times L = L^{-1} \times (L \times U)^2 \times L = U \times L \times U \times L$</p>
<p>所以我们也能搞到 $U$</p>
<p>然后我们就能从 $E$ 中提出 $A$ 来，从而获取flag了。</p>
<p>脚本来自<a href="https://blog.cryptohack.org/cryptoctf2021-medium#onlude" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-medium#onlude</a></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">E = Matrix(GF(<span class="number">71</span>),[[<span class="number">25,55,61,28</span>,<span class="number">11,46,19,50</span>,<span class="number">37</span>,<span class="number">5</span>,<span class="number">21</span>],</span><br><span class="line">[<span class="number">20,57,39,9</span>,<span class="number">25,37,63,31</span>,<span class="number">70</span>,<span class="number">15</span>,<span class="number">47</span>],</span><br><span class="line">[<span class="number">56,31,1,1</span>,<span class="number">50,67,38,14</span>,<span class="number">42</span>,<span class="number">46</span>,<span class="number">14</span>],</span><br><span class="line">[<span class="number">42,54,38,22</span>,<span class="number">19,55,7,18</span>,<span class="number">45</span>,<span class="number">53</span>,<span class="number">39</span>],</span><br><span class="line">[<span class="number">55,26,42,15</span>,<span class="number">48,6,24,4</span>,<span class="number">17</span>,<span class="number">60</span>,<span class="number">64</span>],</span><br><span class="line">[<span class="number">1,38,50,10</span>,<span class="number">19,57,26,48</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">14</span>],</span><br><span class="line">[<span class="number">13,4,38,54</span>,<span class="number">23,34,54,42</span>,<span class="number">15</span>,<span class="number">56</span>,<span class="number">29</span>],</span><br><span class="line">[<span class="number">26,66,8,48</span>,<span class="number">6,70,44,8</span>,<span class="number">67</span>,<span class="number">68</span>,<span class="number">65</span>],</span><br><span class="line">[<span class="number">56,67,49,61</span>,<span class="number">18,34,53,21</span>,<span class="number">7</span>,<span class="number">48</span>,<span class="number">32</span>],</span><br><span class="line">[<span class="number">15,70,10,34</span>,<span class="number">1,57,70,27</span>,<span class="number">12</span>,<span class="number">33</span>,<span class="number">46</span>],</span><br><span class="line">[<span class="number">25,29,20,21</span>,<span class="number">30,55,63,49</span>,<span class="number">11</span>,<span class="number">36</span>,<span class="number">7</span>]])</span><br><span class="line"></span><br><span class="line">hint1 = Matrix(GF(<span class="number">71</span>),[[<span class="number">50,8,21,16</span>,<span class="number">13,33,2,12</span>,<span class="number">35</span>,<span class="number">20</span>,<span class="number">14</span>],</span><br><span class="line">[<span class="number">36,55,36,34</span>,<span class="number">27,28,23,21</span>,<span class="number">62</span>,<span class="number">17</span>,<span class="number">8</span>],</span><br><span class="line">[<span class="number">56,26,49,39</span>,<span class="number">43,30,35,46</span>,<span class="number">0</span>,<span class="number">58</span>,<span class="number">43</span>],</span><br><span class="line">[<span class="number">11,25,25,35</span>,<span class="number">29,0,22,38</span>,<span class="number">53</span>,<span class="number">51</span>,<span class="number">58</span>],</span><br><span class="line">[<span class="number">34,14,69,68</span>,<span class="number">5,32,27,4</span>,<span class="number">27</span>,<span class="number">62</span>,<span class="number">15</span>],</span><br><span class="line">[<span class="number">46,49,36,42</span>,<span class="number">26,12,28,60</span>,<span class="number">54</span>,<span class="number">66</span>,<span class="number">23</span>],</span><br><span class="line">[<span class="number">69,55,30,65</span>,<span class="number">56,13,14,36</span>,<span class="number">26</span>,<span class="number">46</span>,<span class="number">48</span>],</span><br><span class="line">[<span class="number">25,48,16,20</span>,<span class="number">34,57,64,62</span>,<span class="number">61</span>,<span class="number">25</span>,<span class="number">62</span>],</span><br><span class="line">[<span class="number">68,39,11,40</span>,<span class="number">25,11,7,40</span>,<span class="number">24</span>,<span class="number">43</span>,<span class="number">65</span>],</span><br><span class="line">[<span class="number">54,20,40,59</span>,<span class="number">52,60,37,14</span>,<span class="number">32</span>,<span class="number">44</span>,<span class="number">4</span>],</span><br><span class="line">[<span class="number">45,20,7,26</span>,<span class="number">45,45,50,17</span>,<span class="number">41</span>,<span class="number">59</span>,<span class="number">50</span>]])</span><br><span class="line"></span><br><span class="line">hint2=Matrix(GF(<span class="number">71</span>),[[<span class="number">34,12,70,21</span>,<span class="number">36,2,2,43</span>,<span class="number">7</span>,<span class="number">14</span>,<span class="number">2</span>],</span><br><span class="line">[<span class="number">1,54,59,12</span>,<span class="number">64,35,9,7</span>,<span class="number">49</span>,<span class="number">11</span>,<span class="number">49</span>],</span><br><span class="line">[<span class="number">69,14,10,19</span>,<span class="number">16,27,11,9</span>,<span class="number">26</span>,<span class="number">10</span>,<span class="number">45</span>],</span><br><span class="line">[<span class="number">70,17,41,13</span>,<span class="number">35,58,19,29</span>,<span class="number">70</span>,<span class="number">5</span>,<span class="number">30</span>],</span><br><span class="line">[<span class="number">68,69,67,37</span>,<span class="number">63,69,15,64</span>,<span class="number">66</span>,<span class="number">28</span>,<span class="number">26</span>],</span><br><span class="line">[<span class="number">18,29,64,38</span>,<span class="number">63,67,15,27</span>,<span class="number">64</span>,<span class="number">6</span>,<span class="number">26</span>],</span><br><span class="line">[<span class="number">0,12,40,41</span>,<span class="number">48,30,46,52</span>,<span class="number">39</span>,<span class="number">48</span>,<span class="number">58</span>],</span><br><span class="line">[<span class="number">22,3,28,35</span>,<span class="number">55,30,15,17</span>,<span class="number">22</span>,<span class="number">49</span>,<span class="number">55</span>],</span><br><span class="line">[<span class="number">50,55,55,61</span>,<span class="number">45,23,24,32</span>,<span class="number">10</span>,<span class="number">59</span>,<span class="number">69</span>],</span><br><span class="line">[<span class="number">27,21,68,56</span>,<span class="number">67,49,64,53</span>,<span class="number">42</span>,<span class="number">46</span>,<span class="number">14</span>],</span><br><span class="line">[<span class="number">42,66,16,29</span>,<span class="number">42,42,23,49</span>,<span class="number">43</span>,<span class="number">3</span>,<span class="number">23</span>]])</span><br><span class="line"></span><br><span class="line">hint3=Matrix(GF(<span class="number">71</span>),[[<span class="number">51,9,22,61</span>,<span class="number">63,14,2,4</span>,<span class="number">18</span>,<span class="number">18</span>,<span class="number">23</span>],</span><br><span class="line">[<span class="number">33,53,31,31</span>,<span class="number">62,21,66,7</span>,<span class="number">66</span>,<span class="number">68</span>,<span class="number">7</span>],</span><br><span class="line">[<span class="number">59,19,32,21</span>,<span class="number">13,34,16,43</span>,<span class="number">49</span>,<span class="number">25</span>,<span class="number">7</span>],</span><br><span class="line">[<span class="number">44,37,4,29</span>,<span class="number">70,50,46,39</span>,<span class="number">55</span>,<span class="number">4</span>,<span class="number">65</span>],</span><br><span class="line">[<span class="number">29,63,29,43</span>,<span class="number">47,28,40,33</span>,<span class="number">0</span>,<span class="number">62</span>,<span class="number">8</span>],</span><br><span class="line">[<span class="number">45,62,36,68</span>,<span class="number">10,66,26,48</span>,<span class="number">10</span>,<span class="number">6</span>,<span class="number">61</span>],</span><br><span class="line">[<span class="number">43,30,25,18</span>,<span class="number">23,38,61,0</span>,<span class="number">52</span>,<span class="number">46</span>,<span class="number">35</span>],</span><br><span class="line">[<span class="number">3,40,6,45</span>,<span class="number">20,55,35,67</span>,<span class="number">25</span>,<span class="number">14</span>,<span class="number">63</span>],</span><br><span class="line">[<span class="number">15,30,61,66</span>,<span class="number">25,33,14,20</span>,<span class="number">60</span>,<span class="number">50</span>,<span class="number">50</span>],</span><br><span class="line">[<span class="number">29,15,53,22</span>,<span class="number">55,64,69,56</span>,<span class="number">44</span>,<span class="number">40</span>,<span class="number">8</span>],</span><br><span class="line">[<span class="number">28,40,69,60</span>,<span class="number">28,41,9,14</span>,<span class="number">29</span>,<span class="number">4</span>,<span class="number">29</span>]])</span><br><span class="line"></span><br><span class="line">U = hint2/hint1</span><br><span class="line">R = (hint3/((hint1*U)^<span class="number">4</span>)).inverse()</span><br><span class="line"><span class="keyword">A</span> = U.inverse()*E-R</span><br><span class="line">alphabet = '=<span class="number">0123456789</span>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$!?_&#123;&#125;&lt;&gt;'</span><br><span class="line">flag = ''</span><br><span class="line">for k in range(<span class="number">24</span>):</span><br><span class="line">    i, j = <span class="number">5</span>*k // <span class="number">11</span>, <span class="number">5</span>*k % <span class="number">11</span></span><br><span class="line">    flag+=alphabet[<span class="keyword">A</span>[i, j]]</span><br><span class="line">print('CCTF&#123;'+flag+'&#125;')</span><br></pre></td></tr></table></figure>

<h2 id="Maid"><a href="#Maid" class="headerlink" title="Maid"></a>Maid</h2><p>POINTS：119</p>
<p>考点：Rabin Cryptosystem</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> nbit</span><br><span class="line">nbit = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(nbit)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        p, q = [getStrongPrime(nbit) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="string">'01'</span>]</span><br><span class="line">        <span class="keyword">if</span> p % <span class="number">4</span> == q % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> (p**<span class="number">2</span>)*q, p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(m, pubkey)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> GCD(m, pubkey) != <span class="number">1</span> <span class="keyword">or</span> m &gt;= <span class="number">2</span>**(<span class="number">2</span>*nbit - <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> pow(m, <span class="number">2</span>, pubkey)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag_encrypt</span><span class="params">(flag, p, q)</span>:</span></span><br><span class="line">    m = bytes_to_long(flag)</span><br><span class="line">    <span class="keyword">assert</span> m &lt; p * q</span><br><span class="line">    <span class="keyword">return</span> pow(m, <span class="number">65537</span>, p * q)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">"  hi all, welcome to Rooney Oracle, you can encrypt and decrypt any "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  message in this oracle, but the flag is still encrypted, Rooney   "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  asked me to find the encrypted flag, I'm trying now, please help! "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    pubkey, privkey = keygen(nbit)</span><br><span class="line">    p, q = privkey, pubkey // (privkey ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[E]ncrypt message \n|\t[D]ecrypt ciphertext \n|\t[S]how encrypted flag \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'e'</span>:</span><br><span class="line">            pr(<span class="string">"| Send the message to encrypt: "</span>)</span><br><span class="line">            msg = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                msg = int(msg)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">"| your message is not integer!!"</span>)</span><br><span class="line">            pr(<span class="string">f"| encrypt(msg, pubkey) = <span class="subst">&#123;encrypt(msg, pubkey)&#125;</span> "</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'d'</span>:</span><br><span class="line">            pr(<span class="string">"| Send the ciphertext to decrypt: "</span>)</span><br><span class="line">            enc = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                enc = int(enc)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">"| your message is not integer!!"</span>)</span><br><span class="line">            pr(<span class="string">f"| decrypt(enc, privkey) = <span class="subst">&#123;decrypt(enc, privkey)&#125;</span> "</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            pr(<span class="string">f'| enc = <span class="subst">&#123;flag_encrypt(flag, p, q)&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>这里用的是 Rabin 密码系统，但是 $n=p^2 q$</p>
<p>然后题目提供三个功能，</p>
<p>e:使用公钥加密 $c \equiv msg^2 \pmod n$</p>
<p>d:使用私钥解密 <strong>未知</strong></p>
<p>s:给出flag的密文 $c \equiv m^{65537} \pmod n$</p>
<p> $n$ 也没给，不过这好搞，用两次加密功能，然后 $gcd(m_1^2-c_1,m_2^2-c_2)$ 就好了。</p>
<p>问题出在源码没有给出这个rabin密码系统的解密代码，那么只能fuzz一下，看有没有机会分解出 $p,q$ 来。</p>
<p>一般都是会传一下特殊的值，比如1，0，-1这样去fuzz，但是由于本地没法搭环境，就没法自己搞测试样例了，还挺麻烦的。</p>
<p>（这里后面放出源码了，就模拟一下当时的场景好了。）</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def decrypt(c, privkey):</span><br><span class="line">    m_p = <span class="built_in">pow</span>(c, (privkey + <span class="number">1</span>) <span class="comment">// 4, privkey)</span></span><br><span class="line">    i = (c - <span class="built_in">pow</span>(m_p, <span class="number">2</span>)) <span class="comment">// privkey</span></span><br><span class="line">    j = i * <span class="built_in">inverse</span>(<span class="number">2</span>*m_p, privkey) % privkey</span><br><span class="line">    m = m_p + j * privkey</span><br><span class="line">    <span class="keyword">if</span> <span class="number">2</span>*m &lt; privkey**<span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> m</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> privkey**<span class="number">2</span> - m</span><br></pre></td></tr></table></figure>

<p>这里本地测试的时候，会发现有时候，解密的值再加密，并不能变回去，感觉就挺奇怪的。</p>
<p>然后测试会发现 $gcd(D(-1)-1,n) \neq 1$</p>
<p>那么就能分解n了，然后就是常规解密 RSA 的操作了。</p>
<p>脚本来自 <a href="https://blog.cryptohack.org/cryptoctf2021-medium#maid" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-medium#maid</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'04.cr.yp.toc.tf'</span>, <span class="number">38010</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">b"[Q]uit"</span>)</span><br><span class="line">    r.sendline(<span class="string">b"E"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b"encrypt: "</span>)</span><br><span class="line">    r.sendline(str(msg))</span><br><span class="line">    r.recvuntil(<span class="string">b" = "</span>)</span><br><span class="line">    <span class="keyword">return</span> int(r.recvline().strip())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(msg)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">b"[Q]uit"</span>)</span><br><span class="line">    r.sendline(<span class="string">b"D"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b"decrypt: "</span>)</span><br><span class="line">    r.sendline(str(msg))</span><br><span class="line">    r.recvuntil(<span class="string">b" = "</span>)</span><br><span class="line">    <span class="keyword">return</span> int(r.recvline().strip())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">b"[Q]uit"</span>)</span><br><span class="line">    r.sendline(<span class="string">b"S"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b" = "</span>)</span><br><span class="line">    <span class="keyword">return</span> int(r.recvline().strip())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_n</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Obtain kn</span></span><br><span class="line">    m = <span class="number">2</span>**<span class="number">1536</span> - random.randint(<span class="number">1</span>,<span class="number">2</span>**<span class="number">1000</span>)</span><br><span class="line">    c = encrypt(m)</span><br><span class="line">    n = m**<span class="number">2</span> - c</span><br><span class="line">    <span class="comment"># Remove all factors of two</span></span><br><span class="line">    <span class="keyword">while</span> n%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        n = n // <span class="number">2</span></span><br><span class="line">    <span class="comment"># Compute a few more GCD to remove any other factors.</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        m = <span class="number">2</span>**<span class="number">1536</span> - random.randint(<span class="number">1</span>,<span class="number">2</span>**<span class="number">1000</span>)</span><br><span class="line">        c = encrypt(m)</span><br><span class="line">        n = gcd(n, m**<span class="number">2</span> - c)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec_flag</span><span class="params">(p,q)</span>:</span></span><br><span class="line">    c = get_flag()</span><br><span class="line">    d = pow(<span class="number">0x10001</span>, <span class="number">-1</span>, (p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line">    m = pow(c,d,p*q)</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(m)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_factors</span><span class="params">(n)</span>:</span></span><br><span class="line">    X = decrypt(<span class="number">-1</span>)</span><br><span class="line">    p = gcd(X - <span class="number">1</span>, n)</span><br><span class="line">    <span class="keyword">assert</span> isPrime(p)</span><br><span class="line">    q = n // (p*p) </span><br><span class="line">    <span class="keyword">assert</span> isPrime(q)</span><br><span class="line">    <span class="keyword">return</span> p, q</span><br><span class="line"></span><br><span class="line">n = recover_n()</span><br><span class="line">p, q = recover_factors(n)</span><br><span class="line">flag = dec_flag(p,q)</span><br><span class="line">print(flag)</span><br><span class="line"><span class="comment"># CCTF&#123;___Ra8!N_H_Cryp70_5YsT3M___&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里我们回头看一下解密函数</p>
<p>$m_p \equiv  c^{(p+1)/4} \pmod p$</p>
<p>$i=(c-m_p^2)//p$</p>
<p>$j \equiv \frac{i} {2 \cdot m_p} \pmod p$</p>
<p>$m = m_p + j \cdot p$</p>
<p>如果 $m \ge \frac{p^2}{2},return \ p^2 -m,$</p>
<p>如果 $m \lt \frac{p^2}{2},return \ m,$</p>
<p>最初加密的时候似乎也限制了 $m \lt 2^{2\cdot 1024 -2} = 2^{2046} \le p^2$</p>
<p>推导一下，如果传过去正常的明文 $m$，我们得到密文 $m^2 \pmod {p^2 q}$</p>
<p>（不难知道 $c \equiv m^2 \pmod p$，$c \equiv m^2 \pmod {p^2}$，$c \equiv m^2 \pmod q$ ）</p>
<p>$m_p \equiv (m^2)^{(p+1)/4} \equiv m^{(p+1)/2} \equiv m \cdot m^{(p-1)/2}\equiv \pm m \pmod p$</p>
<p>$i = (m^2  - m_p^2 ) // p = (m^2 + k_1p^2q - m^2 - k_2p)//p=k_1pq-k_2$</p>
<p>$j \equiv \frac{i}{2m_p} \equiv \frac{k_1pq-k_2}{2m_p} \equiv \frac{-k_2}{2m_p}\pmod p $</p>
<p>$m = m_p + j \cdot p =  m_p + \frac{-k_2p}{2m_p} $             这一步似乎是想得到 $m \pmod {p^2}$ ？</p>
<p>如果传 $-1$ 去解密就会有</p>
<p>$m_p \equiv (-1)^{(p+1)/4} \equiv 1 \ or -1\pmod p $</p>
<p>如果 $m_p=1$：</p>
<p>$i = (-1 - 1)// p = -1$</p>
<p>$j \equiv -2^{-1} \pmod p$</p>
<p>$m = 1 +j \cdot p $</p>
<p>那么 $gcd(m-1,n) = gcd(j\cdot p ,p^2 q) = p$</p>
<p>如果 $m_p=-1$：</p>
<p>$i = (-1 - 1- k_1p)// p = -k_1$</p>
<p>$j \equiv \frac{k_1}{2}\pmod p$</p>
<p>$m = -1 + j \cdot p $    (然而好像触发 $m \ge \frac{p^2}{2},return \ p^2 -m,$，所以得到 $m = 1-j\cdot p +p^2 $)</p>
<p>那么 $gcd(m-1,n) = gcd(p^2-j\cdot p ,p^2 q) = p$</p>
<p>比赛的时候没有给出解密函数，，emmm，就会觉得有一点点脑洞。</p>
<h2 id="Wolf"><a href="#Wolf" class="headerlink" title="Wolf"></a>Wolf</h2><p>PONITS：128</p>
<p>考点：爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os, time, sys, random</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">passphrase = <span class="string">b'HungryTimberWolf'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, passphrase, niv)</span>:</span></span><br><span class="line">    msg_header = <span class="string">'EPOCH:'</span> + str(int(time.time()))</span><br><span class="line">    msg = msg_header + <span class="string">"\n"</span> + msg + <span class="string">'='</span> * (<span class="number">15</span> - len(msg) % <span class="number">16</span>)</span><br><span class="line">    aes = AES.new(passphrase, AES.MODE_GCM, nonce = niv)</span><br><span class="line">    enc = aes.encrypt_and_digest(msg.encode(<span class="string">'utf-8'</span>))[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">"  hi wolf hunters, welcome to the most dangerous hunting ground!!   "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  decrypt the encrypted message and get the flag as a nice prize!   "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    niv = os.urandom(random.randint(<span class="number">1</span>, <span class="number">11</span>))</span><br><span class="line">    flag_enc = encrypt(flag, passphrase, niv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[G]et the encrypted flag \n|\t[T]est the encryption \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'g'</span>:</span><br><span class="line">            pr(<span class="string">f'| encrypt(flag) = <span class="subst">&#123;flag_enc.hex()&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'t'</span>:</span><br><span class="line">            pr(<span class="string">"| Please send your message to encrypt: "</span>)</span><br><span class="line">            msg_inp = sc()</span><br><span class="line">            enc = encrypt(msg_inp, passphrase, niv).hex()</span><br><span class="line">            pr(<span class="string">f'| enc = <span class="subst">&#123;enc&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>看到题目的附件，好像把AES-GCM加密用的key都给出来了</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">passphrase</span> = b<span class="string">'HungryTimberWolf'</span></span><br></pre></td></tr></table></figure>

<p>然后iv没给，长度也不确定，但是在1 和 11之间</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">niv</span> = os.urandom(random.randint(<span class="number">1</span>, <span class="number">11</span>))</span><br></pre></td></tr></table></figure>

<p>emmm，那就暴力连接，当niv=1的时候，再爆破一下niv的值进行解密，一共也就256种可能。</p>
<p>期望概率大概也就是 $\frac{1}{11 \cdot 256}$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os, time, sys, random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(line)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> iv <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        a = AES.new(<span class="string">b'HungryTimberWolf'</span>, AES.MODE_GCM, nonce=bytes([iv]))</span><br><span class="line">        flag = a.decrypt(binascii.unhexlify(line))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b'CTF'</span> <span class="keyword">in</span> flag:</span><br><span class="line">            print(flag)</span><br><span class="line">            exit()</span><br><span class="line">            </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sh = remote(<span class="string">'01.cr.yp.toc.tf'</span>, <span class="number">27010</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">"[Q]uit\n"</span>)</span><br><span class="line">    sh.sendline(<span class="string">'g'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">"| encrypt(flag) = "</span>)</span><br><span class="line">    enc_flag = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">    dec(enc_flag)</span><br><span class="line">    sh.close()</span><br></pre></td></tr></table></figure>

<h2 id="Ferman"><a href="#Ferman" class="headerlink" title="Ferman"></a>Ferman</h2><p>POINTS:134</p>
<p>考点：高斯整数</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+  hi talented participants, welcome to the FERMAN cryptography task!  +</span><br><span class="line">+  <span class="keyword">Solve</span> the given <span class="keyword">equations</span> and <span class="comment">decrypt the encrypted flag! Enjoy!    +</span></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">| <span class="keyword">Parameters</span> <span class="comment">generation is a bit time consuming, so please be patient :P</span></span><br><span class="line">| Options: </span><br><span class="line">|   [P]rint <span class="comment">encrypted flag</span> </span><br><span class="line">|   [R]eveal <span class="comment">the parameters</span> </span><br><span class="line">|   [Q]uit</span><br><span class="line"></span><br><span class="line">P</span><br><span class="line">| encrypt(flag) <span class="comment">= 6489656589950752810044571176882070993656025408411955877914111875896024399252967804237101085443293019406006339555779534657926807551928549712558667515175079267695028070934727514846970003337126120540450206565849474378607706030211234939933160392491902242074123763448231072583065175864490510115483208842110529309232348180718641618424365058379284549574700049803925884878710773408472100779358561980206902500388524570616750475958017638946408491011264747032498524679282489181606124604218147</span></span><br><span class="line"></span><br><span class="line">R</span><br><span class="line">    e <span class="comment">= 65537</span></span><br><span class="line">    isPrime(p) <span class="comment">= True</span></span><br><span class="line">    isPrime(q) <span class="comment">= True</span></span><br><span class="line">    n <span class="comment">= p * q</span></span><br><span class="line">    (p <span class="comment">- 127)**2 + (q - 184)**2 = 13809252727788824044233595548226590341967726502046327883413398709726819135921363848617960542444505497356040393690402758557636039683075007984614264314802550433942617885990971202110511768121760826488944622697964930982921462840320850014092598270493079542993367042001339267321218767132063176291998391714014192946596879176425904447127657664796094937171819714510504836456988487840790317576922986001688147359646287894578550322731904860694734616037751755921771706899493873123836562784063321</span></span><br><span class="line">    m <span class="comment">= bytes_to_long(flag)</span></span><br><span class="line">    c <span class="comment">= pow(m, e, n)</span></span><br></pre></td></tr></table></figure>

<p>经典给出 $p,q$ 相关额外信息进行对 $n$ 的分解。</p>
<p>给出 $hint = (p-127)^2 + (q-184)^2$</p>
<p>这里经过测试发现 $hint$ 是一个七次幂，即 $hint = z ^7$</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sage:</span> w=<span class="number">13809252727788824044233595548226590341967726502046327883413398709726819135921363848617960542444505497356040393690402758557636039683075007984614264314802550433942617885990971202110511768121760826488944622697964930982921462840320850014092598270493079542993367042001339267321218767132063176291998391714014192946596879176425904447127657664796094937171819714510504836456988487840790317576922986001688147359646287894578550322731904860694734616037751755921771706899493873123836562784063321</span></span><br><span class="line"><span class="symbol">sage:</span> w^(<span class="number">1</span>/<span class="number">7</span>)</span><br><span class="line"><span class="number">542387941227387369715206573048698209530476609597527643690717423409961</span></span><br></pre></td></tr></table></figure>

<p>设$x=p-127,y=q-184$</p>
<p>那么我们有 $x^2+y^2 = z^7$</p>
<p>由于 $x^2+y^2 = (x+iy)(x-iy)$，</p>
<p>若我们能将 $z$ 分解成共轭的两部分$z_x,z_y$，那么就会有 $x+iy=z_x^7 \ or \ x+iy=z_y^7 $     </p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sage: <span class="keyword">C</span> = ZZ[i]</span><br><span class="line">sage: factor(<span class="keyword">C</span>(z))</span><br><span class="line">(<span class="number">-15642728159752</span>*<span class="keyword">I</span> - <span class="number">39850152715295</span>) * (<span class="number">13420641811410</span>*<span class="keyword">I</span> - <span class="number">19188039291907</span>) * (<span class="number">19188039291907</span>*<span class="keyword">I</span> - <span class="number">13420641811410</span>) * (<span class="number">-4190</span>*<span class="keyword">I</span> - <span class="number">9649</span>) * (<span class="number">4190</span>*<span class="keyword">I</span> - <span class="number">9649</span>) * (<span class="number">-18</span>*<span class="keyword">I</span> - <span class="number">17</span>) * (<span class="number">-3</span>*<span class="keyword">I</span> - <span class="number">8</span>) * (<span class="number">3</span>*<span class="keyword">I</span> - <span class="number">8</span>) * (<span class="number">-3</span>*<span class="keyword">I</span> + <span class="number">10</span>) * (<span class="number">3</span>*<span class="keyword">I</span> + <span class="number">10</span>) * (<span class="number">17</span>*<span class="keyword">I</span> + <span class="number">18</span>) * (<span class="number">-15642728159752</span>*<span class="keyword">I</span> + <span class="number">39850152715295</span>)</span><br></pre></td></tr></table></figure>

<p>很对称，但是emmm，排列组合太多了，，我们可以换一组数据</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">a</span> = <span class="number">2265</span> </span><br><span class="line"><span class="attr">b</span> = <span class="number">902</span> </span><br><span class="line"><span class="attr">w</span> = <span class="number">24007015341450638047707811509679207068051724063799752621201994109462561550079479155110637624506028551099549192036601169213196430196182069103932872524092047760624845002308713558682251660517182097667675473038586407097498167776645896369165963981698265040400341878755056463554861788991872633206414266159558715922583613630387512303492920597052611976890648632123534922756985895479931541478630417251021677032459939450624439421018438357005854556082128718286537575550378203702362524442461229</span></span><br><span class="line"><span class="attr">flag_enc</span> = <span class="number">10564879569008106132040759805988959471544940722100428235462653367215001622634768902220485764070394703676633460036566842009467954832811287152142597331508344786167188766356935684044757086902094847810694941751879500776345600036096556068243767090470376672110936445246103465175956767665996275085293250901512809704594905257754009538501795362031873203086994610168776981264025121998840163864902563628991590207637487738286741829585819040077197755226202284847</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">2265</span> </span><br><span class="line">b = <span class="number">902</span> </span><br><span class="line">z = w^(<span class="number">1</span>/<span class="number">7</span>)</span><br><span class="line">C = ZZ[i]</span><br><span class="line">factor(C(z))</span><br><span class="line"></span><br><span class="line">(-I) * (<span class="number">-1236649975237776943493190425869173</span>*I - <span class="number">3575914522629734831030006136433790</span>) * (<span class="number">-5</span>*I - <span class="number">4</span>) * (<span class="number">4</span>*I + <span class="number">5</span>) * (<span class="number">-1236649975237776943493190425869173</span>*I + <span class="number">3575914522629734831030006136433790</span>)</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">w = <span class="number">24007015341450638047707811509679207068051724063799752621201994109462561550079479155110637624506028551099549192036601169213196430196182069103932872524092047760624845002308713558682251660517182097667675473038586407097498167776645896369165963981698265040400341878755056463554861788991872633206414266159558715922583613630387512303492920597052611976890648632123534922756985895479931541478630417251021677032459939450624439421018438357005854556082128718286537575550378203702362524442461229</span></span><br><span class="line">zx = (<span class="number">-1236649975237776943493190425869173</span>*I + <span class="number">3575914522629734831030006136433790</span>) * (<span class="number">-5</span>*I - <span class="number">4</span>)</span><br><span class="line">x = abs((zx^<span class="number">7</span>).imag())</span><br><span class="line">y = abs((zx^<span class="number">7</span>).real())</span><br><span class="line">print(x)</span><br><span class="line">print(y)</span><br><span class="line">assert x^<span class="number">2</span>+y^<span class="number">2</span> == w</span><br><span class="line">is_prime(x+<span class="number">2265</span>)</span><br><span class="line">is_prime(x+<span class="number">902</span>)</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3515251100858858796435724523870761115321577101490666287216209907489403476079222276536571942496157069855565014771125798502774268554017196492328530962886884456876064742139864478104832820555776577341055529681241338289453827370647829795170811402</span></span><br><span class="line"><span class="number">3413213301181339793171422358348736699126965473930685311400429872075816456893055375667482794611435574843396575239764759040242158681190020317082329009191911152126267671754529169503180596722173728126136891139303943035843711591741985591269095075</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>于是我们得到素数</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x+<span class="number">2265</span>=<span class="number">3515251100858858796435724523870761115321577101490666287216209907489403476079222276536571942496157069855565014771125798502774268554017196492328530962886884456876064742139864478104832820555776577341055529681241338289453827370647829795170813667</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">p = <span class="number">3515251100858858796435724523870761115321577101490666287216209907489403476079222276536571942496157069855565014771125798502774268554017196492328530962886884456876064742139864478104832820555776577341055529681241338289453827370647829795170813667</span>  </span><br><span class="line">q = <span class="number">3413213301181339793171422358348736699126965473930685311400429872075816456893055375667482794611435574843396575239764759040242158681190020317082329009191911152126267671754529169503180596722173728126136891139303943035843711591741985591269095977</span></span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d = pow(<span class="number">0x10001</span>, <span class="number">-1</span>, phi)</span><br><span class="line">print(long_to_bytes(pow(flag_enc,d,p*q)))</span><br><span class="line">b'CCTF&#123;Congrats_Y0u_5OLv3d_x**<span class="number">2</span>+y**<span class="number">2</span>=z**<span class="number">7</span>&#125;'</span><br></pre></td></tr></table></figure>

<p>（PS：对于方程$x^2+y^2=z^7$，我们利用高斯分解似乎能够找到很多组满足条件的解 $x,y$，取决于高斯分解 $z$ 后它能有多少个因子）</p>
<h2 id="RSAphantine"><a href="#RSAphantine" class="headerlink" title="RSAphantine"></a>RSAphantine</h2><p>POINTS:142</p>
<p>考点：丢番图方程</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>*z**<span class="number">5</span> - x**<span class="number">3</span> + y*z = <span class="number">47769864706750161581152919266942014884728504309791272300873440765010405681123224050402253883248571746202060439521835359010439155922618613520747411963822349374260144229698759495359592287331083229572369186844312169397998958687629858407857496154424105344376591742814310010312178029414792153520127354594349356721</span></span><br><span class="line">x**<span class="number">4</span> + y**<span class="number">5</span> + x*y*z = <span class="number">89701863794494741579279495149280970802005356650985500935516314994149482802770873012891936617235883383779949043375656934782512958529863426837860653654512392603575042842591799236152988759047643602681210429449595866940656449163014827637584123867198437888098961323599436457342203222948370386342070941174587735051</span></span><br><span class="line">y**<span class="number">6</span> + <span class="number">2</span>*z**<span class="number">5</span> + z*y = <span class="number">47769864706750161581152919266942014884728504309791272300873440765010405681123224050402253883248571746202060439521835359010439155922618613609786612391835856376321085593999733543104760294208916442207908167085574197779179315081994735796390000652436258333943257231020011932605906567086908226693333446521506911058</span></span><br><span class="line">p = nextPrime(x**<span class="number">2</span> + z**<span class="number">2</span> + y**<span class="number">2</span> &lt;&lt; <span class="number">76</span>)</span><br><span class="line">q = nextPrime(z**<span class="number">2</span> + y**<span class="number">3</span> - y*x*z ^ <span class="number">67</span>)</span><br><span class="line">n, e = p * q, <span class="number">31337</span></span><br><span class="line">m = bytes_to_long(FLAG)</span><br><span class="line">c = pow(m, e, n)</span><br><span class="line">c = <span class="number">486675922771716096231737399040548486325658137529857293201278143425470143429646265649376948017991651364539656238516890519597468182912015548139675971112490154510727743335620826075143903361868438931223801236515950567326769413127995861265368340866053590373839051019268657129382281794222269715218496547178894867320406378387056032984394810093686367691759705672</span></span><br></pre></td></tr></table></figure>

<p>题目的target很明显了，显然解关于x,y,z的方程组了。</p>
<ol>
<li><p>$2z^5 - x^3 + yz=a $</p>
</li>
<li><p>$x^4+y^5+xyz=b$</p>
</li>
<li><p>$y^6+2z^5+zy=c$</p>
</li>
</ol>
<p>很直观的会想要用3式减去 1式</p>
<p>$y^6+x^3=c-a$</p>
<p>用sage处理一下</p>
<figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">sage: f=y</span><span class="keyword">^6</span><span class="xml">+x</span><span class="keyword">^3</span><span class="xml"></span></span><br><span class="line"><span class="xml">sage: factor(f)</span></span><br><span class="line"><span class="xml">(y</span><span class="keyword">^4</span><span class="xml"> - x*y</span><span class="keyword">^2</span><span class="xml"> + x</span><span class="keyword">^2</span><span class="xml">)*(y</span><span class="keyword">^2</span><span class="xml"> + x)</span></span><br><span class="line"><span class="xml">sage: factor(c-a)</span></span><br><span class="line"><span class="xml"></span><span class="number">3133713317731333</span><span class="xml"> * </span><span class="number">28413320364759425177418147555143516002041291710972733253944530195017276664069717887927099709630886727522090965378073004342203980057853092114878433424202989</span><span class="xml"></span></span><br></pre></td></tr></table></figure>

<p>（感觉出题人处理的比较好，c-a只有两个因子）那么显然，这里有 $y^2+x=3133713317731333$</p>
<p>有了这一条我们再代入 $f=y^6+x^3$ 就可以解出 $x,y$ 了</p>
<p>有了 $x,y$ 代入 2 式就能解出 $z$ 了。</p>
<p>从而进行RSA参数的生成，解密获得flag。</p>
<p>脚本来自<a href="https://jsur.in/posts/2021-08-01-crypto-ctf-2021-writeups" target="_blank" rel="noopener">https://jsur.in/posts/2021-08-01-crypto-ctf-2021-writeups</a></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">c1 = 47769864706750161581152919266942014884728504309791272300873440765010405681123224050402253883248571746202060439521835359010439155922618613520747411963822349374260144229698759495359592287331083229572369186844312169397998958687629858407857496154424105344376591742814310010312178029414792153520127354594349356721</span><br><span class="line">c2 = 89701863794494741579279495149280970802005356650985500935516314994149482802770873012891936617235883383779949043375656934782512958529863426837860653654512392603575042842591799236152988759047643602681210429449595866940656449163014827637584123867198437888098961323599436457342203222948370386342070941174587735051</span><br><span class="line">c3 = 47769864706750161581152919266942014884728504309791272300873440765010405681123224050402253883248571746202060439521835359010439155922618613609786612391835856376321085593999733543104760294208916442207908167085574197779179315081994735796390000652436258333943257231020011932605906567086908226693333446521506911058</span><br><span class="line"></span><br><span class="line">R.&lt;x,y,z&gt; = PolynomialRing(QQ)</span><br><span class="line">delta = 3133713317731333</span><br><span class="line">f1 = y^6 + (delta - y^2)^3 - (c3 - c1)</span><br><span class="line">y = f1.univariate_polynomial().roots()[0][0]</span><br><span class="line">x = delta - y^2</span><br><span class="line">f2 = x^4 + y^5 + x*y*z - c2</span><br><span class="line">z = f2.univariate_polynomial().roots()[0][0]</span><br><span class="line"></span><br><span class="line">x = int(x)</span><br><span class="line">y = int(y)</span><br><span class="line">z = int(z)</span><br><span class="line"></span><br><span class="line">p = Integer(x**2 + z**2 + y**2 &lt;&lt; 76).next_prime()</span><br><span class="line">q = Integer(z**2 + y**3 - y*x*z ^^ 67).next_prime()</span><br><span class="line">n, e = p * q, 31337</span><br><span class="line">c = 486675922771716096231737399040548486325658137529857293201278143425470143429646265649376948017991651364539656238516890519597468182912015548139675971112490154510727743335620826075143903361868438931223801236515950567326769413127995861265368340866053590373839051019268657129382281794222269715218496547178894867320406378387056032984394810093686367691759705672</span><br><span class="line">d = pow(e, -1, (p-1)*(q-1))</span><br><span class="line">m = pow(c, int(d), n)</span><br><span class="line">print(long_to_bytes(m).decode())</span><br><span class="line">CCTF&#123;y0Ur_jO8_C4l13D_Diophantine_An4LySI5!&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FROZEN"><a href="#FROZEN" class="headerlink" title="FROZEN"></a>FROZEN</h2><p>POINTS: 142</p>
<p>考点：已知明文攻击（非预期？）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys, random, string</span><br><span class="line"></span><br><span class="line">flag = <span class="string">'fakeflag&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genrandstr</span><span class="params">(N)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(random.choice(string.ascii_uppercase + string.digits + string.ascii_lowercase) <span class="keyword">for</span> _ <span class="keyword">in</span> range(N))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paramaker</span><span class="params">(nbit)</span>:</span></span><br><span class="line">    p = getPrime(nbit)</span><br><span class="line">    r = getRandomRange(<span class="number">1</span>, p)</span><br><span class="line">    <span class="keyword">return</span> p, r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(params, l, d)</span>:</span></span><br><span class="line">    p, r = params</span><br><span class="line">    s = getRandomRange(<span class="number">1</span>, p)</span><br><span class="line">    U = [pow(r, c + <span class="number">1</span>, p) * s % p <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">0</span>,l)]</span><br><span class="line">    V = [int(bin(u)[<span class="number">2</span>:][:-d] + <span class="string">'0'</span> * d, <span class="number">2</span>) <span class="keyword">for</span> u <span class="keyword">in</span> U]</span><br><span class="line">    S = [int(bin(u)[<span class="number">2</span>:][-d:], <span class="number">2</span>) <span class="keyword">for</span> u <span class="keyword">in</span> U]</span><br><span class="line">    privkey, pubkey = S, V</span><br><span class="line">    <span class="keyword">return</span> pubkey, privkey</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg, privkey, d)</span>:</span></span><br><span class="line">    msg = msg.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    l = len(msg) // <span class="number">4</span></span><br><span class="line">    M = [bytes_to_long(msg[<span class="number">4</span>*i:<span class="number">4</span>*(i+<span class="number">1</span>)]) <span class="keyword">for</span> i <span class="keyword">in</span> range(l)]</span><br><span class="line">    q = int(next_prime(max(M)))</span><br><span class="line">    sign = [M[i]*privkey[i] % q <span class="keyword">for</span> i <span class="keyword">in</span> range(l)]</span><br><span class="line">    <span class="keyword">return</span> sign</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">" hi young cryptographers, welcome to the frozen signature battle!!  "</span>, border)</span><br><span class="line">    pr(border, <span class="string">" Your mission is to forge the signature for a given message, ready?!"</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    randstr = genrandstr(<span class="number">20</span>)</span><br><span class="line">    nbit, dbit = <span class="number">128</span>, <span class="number">32</span></span><br><span class="line">    params = paramaker(nbit)</span><br><span class="line">    l = <span class="number">5</span></span><br><span class="line">    pubkey, privkey = keygen(params, l, dbit)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[S]how the params \n|\t[P]rint pubkey \n|\t[E]xample signature \n|\t[F]orge the signature \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            pr(<span class="string">f'| p = <span class="subst">&#123;params[<span class="number">0</span>]&#125;</span>'</span>)</span><br><span class="line">            pr(<span class="string">f'| r = <span class="subst">&#123;params[<span class="number">1</span>]&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'p'</span>:</span><br><span class="line">            pr(<span class="string">f'pubkey = <span class="subst">&#123;pubkey&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'e'</span>:</span><br><span class="line">            pr(<span class="string">f'| the signature for "<span class="subst">&#123;randstr&#125;</span>" is :'</span>)</span><br><span class="line">            pr(<span class="string">f'| signature = <span class="subst">&#123;sign(randstr, privkey, dbit)&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'f'</span>:</span><br><span class="line">            randmsg = genrandstr(<span class="number">20</span>)</span><br><span class="line">            pr(<span class="string">f'| send the signature of the following message like example: <span class="subst">&#123;randmsg&#125;</span>'</span>)</span><br><span class="line">            SIGN = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                SIGN = [int(s) <span class="keyword">for</span> s <span class="keyword">in</span> SIGN.split(<span class="string">','</span>)]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">'| your signature is not valid! Bye!!'</span>)</span><br><span class="line">            <span class="keyword">if</span> SIGN == sign(randmsg, privkey, dbit):</span><br><span class="line">                die(<span class="string">f'| Congrats, you got the flag: <span class="subst">&#123;FLAG&#125;</span>'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">f'| Your signature is not correct, try later! Bye!'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>题目是一个签名服务，使用私钥对4个字节的明文进行签名 $sign = priv_i \cdot m_p \pmod p$</p>
<p>$p$ 是一个约为 30bit 的素数</p>
<p>私钥的生成来源于 $r^is \pmod p,i \in [0,1,2,3,4]$ 的低 32 位。</p>
<p>但是题目给出了一个消息的签名示例，利用其 $msg,sign$，我们可以恢复 $priv_i \pmod p$</p>
<p>但是由于 $p$ 只有30比特左右，所以我们还需要做一点点小小的爆破，而判断依据则是 $(pub_i + pri_i) / (pub_{i-1}+pri_{i-1}) \equiv r \pmod p$</p>
<p>exp</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line">from gmpy2 import *</span><br><span class="line"></span><br><span class="line"># 交互获取签名样例计算大部分私钥: e</span><br><span class="line">msg = <span class="string">"gxOy9KYScvLF2tWUpkg0"</span>.encode('utf-<span class="number">8</span>')</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = len(msg) // <span class="number">4</span></span><br><span class="line">M = [bytes_to_long(msg[<span class="number">4</span>*i:<span class="number">4</span>*(i+<span class="number">1</span>)]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l)]</span><br><span class="line">q = int(<span class="built_in">next_prime</span>(<span class="built_in">max</span>(M)))</span><br><span class="line"><span class="built_in">sign</span> = [<span class="number">289279587</span>, <span class="number">50849811</span>, <span class="number">1632438391</span>, <span class="number">537783778</span>, <span class="number">611375482</span>]</span><br><span class="line">privkey = [inverse(M[i],q)*<span class="built_in">sign</span>[i] <span class="symbol">%</span> q <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l)]</span><br><span class="line"></span><br><span class="line"># 交互获取公钥: p</span><br><span class="line">pubkey = [<span class="number">43888590349289262389019236090217758720</span>, <span class="number">17879334018861290280325290839018307584</span>, <span class="number">40499489748639202207722187467891146752</span>, <span class="number">178025246158865738197422650069448916992</span>, <span class="number">96934554205183278449061380907857870848</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">key</span>=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">	<span class="built_in">key</span>.<span class="built_in">append</span>(pubkey[i]+privkey[i])</span><br><span class="line">	</span><br><span class="line"># 交互获取参数: s</span><br><span class="line">p = <span class="number">178511102601149595520550176105220942341</span></span><br><span class="line">r = <span class="number">125432576416753760620313745406675102980</span></span><br><span class="line"></span><br><span class="line"># 爆破剩余私钥</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">4</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">key</span>[<span class="number">1</span>]+j*q) * inverse(<span class="built_in">key</span>[<span class="number">0</span>]+i*q,p)%p == r:</span><br><span class="line">			<span class="built_in">key</span>[<span class="number">0</span>] += i*q</span><br><span class="line">			<span class="built_in">key</span>[<span class="number">1</span>] += j*q</span><br><span class="line">			<span class="built_in">print</span>(i,j)</span><br><span class="line">			<span class="built_in">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">5</span>):</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">key</span>[i]+k*q) * inverse(<span class="built_in">key</span>[i-<span class="number">1</span>],p)%p == r:</span><br><span class="line">			<span class="built_in">key</span>[i] += k*q</span><br><span class="line">			<span class="built_in">print</span>(i,k)</span><br><span class="line">			<span class="built_in">break</span></span><br><span class="line">privkey = [each <span class="symbol">%</span> (<span class="number">2</span>**<span class="number">32</span>) <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">key</span>]</span><br><span class="line"></span><br><span class="line">def <span class="built_in">sign</span>(msg, privkey):</span><br><span class="line">    msg = msg.encode('utf-<span class="number">8</span>')</span><br><span class="line">    l = len(msg) // <span class="number">4</span></span><br><span class="line">    M = [bytes_to_long(msg[<span class="number">4</span>*i:<span class="number">4</span>*(i+<span class="number">1</span>)]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l)]</span><br><span class="line">    q = int(<span class="built_in">next_prime</span>(<span class="built_in">max</span>(M)))</span><br><span class="line">    <span class="built_in">sign</span> = [M[i]*privkey[i] <span class="symbol">%</span> q <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l)]</span><br><span class="line">    <span class="built_in">return</span> <span class="built_in">sign</span></span><br><span class="line">    </span><br><span class="line"># 交互伪造签名: f</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sign</span>(<span class="string">"4bV9K70jeYOoogSnGsTc"</span>, privkey))</span><br></pre></td></tr></table></figure>

<p>PS：这道题的flag是 <code>CCTF{Lattice_bA5eD_T3cHn1QuE_70_Br34K_LCG!!}</code>，看来作者原意应该是让我们有lattice去恢复未知位，不过这里通过已知明文攻击能够获取到的低位太多了，这里需要再稍微调整一下。</p>
<h2 id="LINDA"><a href="#LINDA" class="headerlink" title="LINDA"></a>LINDA</h2><p>POINTS：169</p>
<p>考点：离散对数，$p-1$ 光滑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        u = getRandomRange(<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">if</span> pow(u, (p<span class="number">-1</span>) // <span class="number">2</span>, p) != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    x = getRandomRange(<span class="number">1</span>, p)</span><br><span class="line">    w = pow(u, x, p)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = getRandomRange(<span class="number">1</span>, p<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">if</span> gcd(r, p<span class="number">-1</span>) == <span class="number">1</span>:</span><br><span class="line">            y = x * inverse(r, p<span class="number">-1</span>) % (p<span class="number">-1</span>)</span><br><span class="line">            v = pow(u, r, p)</span><br><span class="line">            <span class="keyword">return</span> u, v, w</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(m, pubkey)</span>:</span></span><br><span class="line">    p, u, v, w = pubkey</span><br><span class="line">    <span class="keyword">assert</span> m &lt; p</span><br><span class="line">    r, s = [getRandomRange(<span class="number">1</span>, p) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="string">'01'</span>]</span><br><span class="line">    ca = pow(u, r, p)</span><br><span class="line">    cb = pow(v, s, p)</span><br><span class="line">    cc = m * pow(w, r + s, p) % p</span><br><span class="line">    enc = (ca, cb, cc)</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">"  .:::::: LINDA Cryptosystem has high grade security level ::::::.  "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  Can you break this cryptosystem and find the flag?                "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    pr(<span class="string">'| please wait, preparing the LINDA is time consuming...'</span>)</span><br><span class="line">    <span class="keyword">from</span> secret <span class="keyword">import</span> p</span><br><span class="line">    u, v, w = keygen(p)</span><br><span class="line">    msg = bytes_to_long(flag)</span><br><span class="line">    pubkey = p, u, v, w</span><br><span class="line">    enc = encrypt(msg, pubkey)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[E]xpose the parameters \n|\t[T]est the encryption \n|\t[S]how the encrypted flag \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'e'</span>:</span><br><span class="line">            pr(<span class="string">f'| p = <span class="subst">&#123;p&#125;</span>'</span>)</span><br><span class="line">            pr(<span class="string">f'| u = <span class="subst">&#123;u&#125;</span>'</span>)</span><br><span class="line">            pr(<span class="string">f'| v = <span class="subst">&#123;v&#125;</span>'</span>)</span><br><span class="line">            pr(<span class="string">f'| w = <span class="subst">&#123;w&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            print(<span class="string">f'enc = <span class="subst">&#123;enc&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'t'</span>:</span><br><span class="line">            pr(<span class="string">'| send your message to encrypt: '</span>)</span><br><span class="line">            m = sc()</span><br><span class="line">            m = bytes_to_long(m.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">            pr(<span class="string">f'| encrypt(m) = <span class="subst">&#123;encrypt(m, pubkey)&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>这道题目有一个 <code>from secret import p</code>，交互获取样例会发现 $p-1$ 是光滑的</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="number">31236959722193405152010489304408176327538432524312583937104819646529142201202386217645408893898924349364771709996106640982219903602836751314429782819699</span></span><br><span class="line">p - <span class="number">1</span> = <span class="number">2</span> * <span class="number">3</span> * <span class="number">11</span> * <span class="number">41</span> * <span class="number">137</span> * <span class="number">223</span> * <span class="number">7529</span> * <span class="number">14827</span> * <span class="number">15121</span> * <span class="number">40559</span> * <span class="number">62011</span> * <span class="number">429083</span> * <span class="number">916169</span> * <span class="number">3810461</span> * <span class="number">4316867</span> * <span class="number">20962993</span> * <span class="number">31469027</span> * <span class="number">81724477</span> * <span class="number">132735437</span> * <span class="number">268901797</span> * <span class="number">449598857</span> * <span class="number">2101394579</span> * <span class="number">2379719473</span> * <span class="number">5859408629</span> * <span class="number">11862763021</span> * <span class="number">45767566217</span></span><br></pre></td></tr></table></figure>

<p>然后 $u,v,w$ 已知，再由<br>$$<br>cc \equiv m  \cdot w^{r+s} \pmod p \<br>cb \equiv  v^s \pmod p \<br>ca \equiv u^r \pmod p<br>$$<br>我们对 $ca,cb$ 解离散对数就能获取 $s,r$，然后就能计算 $w^{r+s}$，从而解密获取 $m$</p>
<p>exp</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># sage</span><br><span class="line"></span><br><span class="line"># 交互获取 <span class="keyword">cc</span>,cb,<span class="keyword">ca</span>,p,<span class="keyword">u</span>,v,<span class="built_in">w</span></span><br><span class="line"></span><br><span class="line">r = discrete_log(<span class="built_in">Mod</span>(<span class="keyword">ca</span>, p), <span class="built_in">Mod</span>(<span class="keyword">u</span>, p)) </span><br><span class="line">s = discrete_log(<span class="built_in">Mod</span>(cb, p), <span class="built_in">Mod</span>(v, p))</span><br><span class="line"><span class="keyword">m</span> = <span class="keyword">cc</span> * pow(w, -(r + s), p) % p</span><br><span class="line"><span class="keyword">print</span>(long_to_bytes(<span class="keyword">m</span>))</span><br></pre></td></tr></table></figure>

<p>PS：这道题能有这么高的分倒是有点不可思议，可能大部分选手没发现 $p-1$ 是光滑的叭。</p>
<h2 id="TinyECC"><a href="#TinyECC" class="headerlink" title="TinyECC"></a>TinyECC</h2><p>POINTS：217</p>
<p>考点：椭圆曲线离散对数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mini_ecdsa <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tonelli_shanks</span><span class="params">(n, p)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> pow(n, int((p<span class="number">-1</span>)//<span class="number">2</span>), p) == <span class="number">1</span>:</span><br><span class="line">            s = <span class="number">1</span></span><br><span class="line">            q = int((p<span class="number">-1</span>)//<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> q % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    q = q // <span class="number">2</span></span><br><span class="line">                    s += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> s == <span class="number">1</span>:</span><br><span class="line">                r1 = pow(n, int((p+<span class="number">1</span>)//<span class="number">4</span>), p)</span><br><span class="line">                r2 = p - r1</span><br><span class="line">                <span class="keyword">return</span> r1, r2</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                z = <span class="number">2</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    <span class="keyword">if</span> pow(z, int((p<span class="number">-1</span>)//<span class="number">2</span>), p) == p - <span class="number">1</span>:</span><br><span class="line">                        c = pow(z, q, p)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        z += <span class="number">1</span></span><br><span class="line">                r = pow(n, int((q+<span class="number">1</span>)//<span class="number">2</span>), p)</span><br><span class="line">                t = pow(n, q, p)</span><br><span class="line">                m = s</span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    <span class="keyword">if</span> t == <span class="number">1</span>:</span><br><span class="line">                        r1 = r</span><br><span class="line">                        r2 = p - r1</span><br><span class="line">                        <span class="keyword">return</span> r1, r2</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        i = <span class="number">1</span></span><br><span class="line">                        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                            <span class="keyword">if</span> pow(t, <span class="number">2</span>**i, p) == <span class="number">1</span>:</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                i += <span class="number">1</span></span><br><span class="line">                        b = pow(c, <span class="number">2</span>**(m-i<span class="number">-1</span>), p)</span><br><span class="line">                        r = r * b % p</span><br><span class="line">                        t = t * b ** <span class="number">2</span> % p</span><br><span class="line">                        c = b ** <span class="number">2</span> % p</span><br><span class="line">                        m = i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_point</span><span class="params">(p, a, b)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        gx = getRandomRange(<span class="number">1</span>, p<span class="number">-1</span>)</span><br><span class="line">        n = (gx**<span class="number">3</span> + a*gx + b) % p</span><br><span class="line">        gy = tonelli_shanks(n, p)</span><br><span class="line">        <span class="keyword">if</span> gy == <span class="literal">False</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> (gx, gy[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">"  Dual ECC means two elliptic curve with same coefficients over the "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  different fields or ring! You should calculate the discrete log   "</span>, border)</span><br><span class="line">    pr(border, <span class="string">"  in dual ECCs. So be smart in choosing the first parameters! Enjoy!"</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    bool_coef, bool_prime, nbit = <span class="literal">False</span>, <span class="literal">False</span>, <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">f"| Options: \n|\t[C]hoose the <span class="subst">&#123;nbit&#125;</span>-bit prime p \n|\t[A]ssign the coefficients \n|\t[S]olve DLP \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'a'</span>:</span><br><span class="line">            pr(<span class="string">'| send the coefficients a and b separated by comma: '</span>)</span><br><span class="line">            COEFS = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                a, b = [int(_) <span class="keyword">for</span> _ <span class="keyword">in</span> COEFS.split(<span class="string">','</span>)]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">'| your coefficients are not valid, Bye!!'</span>)</span><br><span class="line">            <span class="keyword">if</span> a*b == <span class="number">0</span>:</span><br><span class="line">                die(<span class="string">'| Kidding me?!! a*b should not be zero!!'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                bool_coef = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'c'</span>:</span><br><span class="line">            pr(<span class="string">'| send your prime: '</span>)</span><br><span class="line">            p = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                p = int(p)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">'| your input is not valid :('</span>)</span><br><span class="line">            <span class="keyword">if</span> isPrime(p) <span class="keyword">and</span> p.bit_length() == nbit <span class="keyword">and</span> isPrime(<span class="number">2</span>*p + <span class="number">1</span>):</span><br><span class="line">                q = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line">                bool_prime = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">f'| your integer p is not <span class="subst">&#123;nbit&#125;</span>-bit prime or 2p + 1 is not prime, bye!!'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            <span class="keyword">if</span> bool_coef == <span class="literal">False</span>:</span><br><span class="line">                pr(<span class="string">'| please assign the coefficients.'</span>)</span><br><span class="line">            <span class="keyword">if</span> bool_prime == <span class="literal">False</span>:</span><br><span class="line">                pr(<span class="string">'| please choose your prime first.'</span>)</span><br><span class="line">            <span class="keyword">if</span> bool_prime <span class="keyword">and</span> bool_coef:</span><br><span class="line">                Ep = CurveOverFp(<span class="number">0</span>, a, b, p)</span><br><span class="line">                Eq = CurveOverFp(<span class="number">0</span>, a, b, q)</span><br><span class="line"></span><br><span class="line">                xp, yp = random_point(p, a, b)</span><br><span class="line">                P = Point(xp, yp)</span><br><span class="line"></span><br><span class="line">                xq, yq = random_point(q, a, b)</span><br><span class="line">                Q = Point(xq, yq)</span><br><span class="line"></span><br><span class="line">                k = getRandomRange(<span class="number">1</span>, p &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                kP = Ep.mult(P, k)</span><br><span class="line"></span><br><span class="line">                l = getRandomRange(<span class="number">1</span>, q &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                lQ = Eq.mult(Q, l)</span><br><span class="line">                pr(<span class="string">'| We know that: '</span>)</span><br><span class="line">                pr(<span class="string">f'| P = <span class="subst">&#123;P&#125;</span>'</span>)</span><br><span class="line">                pr(<span class="string">f'| k*P = <span class="subst">&#123;kP&#125;</span>'</span>)</span><br><span class="line">                pr(<span class="string">f'| Q = <span class="subst">&#123;Q&#125;</span>'</span>)</span><br><span class="line">                pr(<span class="string">f'| l*Q = <span class="subst">&#123;lQ&#125;</span>'</span>)</span><br><span class="line">                pr(<span class="string">'| send the k and l separated by comma: '</span>)</span><br><span class="line">                PRIVS = sc()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    priv, qriv = [int(s) <span class="keyword">for</span> s <span class="keyword">in</span> PRIVS.split(<span class="string">','</span>)]</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    die(<span class="string">'| your input is not valid, Bye!!'</span>)</span><br><span class="line">                <span class="keyword">if</span> priv == k <span class="keyword">and</span> qriv == l:</span><br><span class="line">                    die(<span class="string">f'| Congrats, you got the flag: <span class="subst">&#123;flag&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    die(<span class="string">'| sorry, your keys are not correct! Bye!!!'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>题目的意思是让你输入系数 $a,b,p$ 来构造一条曲线，然后解一个椭圆曲线上的离散对数问题。</p>
<p>这里有两个思路，一个是构造 $#E_p = p$，使用smart attack，或者 $#E_p = p-1,  #E_p = p+1$ 可以使用weil pair 去做。</p>
<p>这里是用smart attack的方法，先根据<a href="http://www.monnerat.info/publications/anomalous.pdf生成奇异曲线的参数" target="_blank" rel="noopener">http://www.monnerat.info/publications/anomalous.pdf生成奇异曲线的参数</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://www.monnerat.info/publications/anomalous.pdf</span></span><br><span class="line">D = <span class="number">19</span></span><br><span class="line">j = <span class="number">-2</span>^<span class="number">15</span>*<span class="number">3</span>^<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">anon_prime</span><span class="params">(m)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        p = (<span class="number">19</span>*m*(m + <span class="number">1</span>)) + <span class="number">5</span></span><br><span class="line">        <span class="keyword">if</span> is_prime(p):</span><br><span class="line">            <span class="keyword">return</span> m, p</span><br><span class="line">        m += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">curves = []</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">anom_curve</span><span class="params">()</span>:</span></span><br><span class="line">    m = <span class="number">2</span>**<span class="number">61</span> + <span class="number">2</span>**<span class="number">60</span> <span class="comment"># chosen so the curves have bit length 128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        m, p = anon_prime(m)</span><br><span class="line">        a = (<span class="number">-3</span>*j * inverse_mod((j - <span class="number">1728</span>), p)) % p</span><br><span class="line">        b = (<span class="number">2</span>*j * inverse_mod((j - <span class="number">1728</span>), p)) % p</span><br><span class="line">        E = EllipticCurve(GF(p), [a,b]) </span><br><span class="line">        <span class="keyword">if</span> E.order() == p:</span><br><span class="line">            G = E.gens()[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> is_prime(<span class="number">2</span>*p + <span class="number">1</span>):</span><br><span class="line">                print(<span class="string">f'Found an anomalous prime of bit length: <span class="subst">&#123;p.nbits()&#125;</span>'</span>)</span><br><span class="line">                print(<span class="string">f'Alse q = 2p+1 is a prime. p=<span class="subst">&#123;p&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">if</span> p.nbits() != <span class="number">128</span>:</span><br><span class="line">                    exit()</span><br><span class="line">                curves.append([p,a,b])</span><br><span class="line">                <span class="comment">#print(curves)</span></span><br><span class="line">        m += <span class="number">1</span></span><br><span class="line">anom_curve()</span><br></pre></td></tr></table></figure>

<p>对于第一条曲线我们就可以用smart attack进行离散对数的求解了，</p>
<p>那么第二条曲线，我们就遍历一下，尽量找一条比较光滑的曲线，以便直接使用pohlig-hellman对其继续离散对数求解。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">param</span> <span class="keyword">in</span> curves:</span><br><span class="line">    p, <span class="keyword">a</span>, b = <span class="built_in">param</span></span><br><span class="line">    q = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line">    E1 = EllipticCurve(GF(p), [<span class="keyword">a</span>,b])</span><br><span class="line">    E2 = EllipticCurve(GF(q), [<span class="keyword">a</span>,b])</span><br><span class="line">    assert E1.order() == p</span><br><span class="line">    <span class="keyword">if</span> factor(E2.order())[<span class="number">-1</span>][<span class="number">0</span>] &lt;= <span class="number">2</span>^<span class="number">32</span>:</span><br><span class="line">        print(factor(E2.order()))</span><br><span class="line">        print(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 * 11 * 29 * 269 * 809 * 1153 * 5527 * 1739687 * 272437559 * 1084044811</span></span><br><span class="line"><span class="comment"># 227297987279223760839521045903912023553</span></span><br><span class="line"><span class="comment"># 2^12 * 3^2 * 5^2 * 3943 * 417869 * 2117447 * 204521147 * 691298191</span></span><br><span class="line"><span class="comment"># 227297987279232780301248910046242203569</span></span><br><span class="line"><span class="comment"># 3^3 * 5 * 233 * 241 * 17473333 * 57368039 * 57798431 * 1035039791</span></span><br><span class="line"><span class="comment"># 227297987279245567422831795384518183819</span></span><br></pre></td></tr></table></figure>

<p>一个例子</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># E2.order() = <span class="number">2</span> * <span class="number">11</span> * <span class="number">29</span> * <span class="number">269</span> * <span class="number">809</span> * <span class="number">1153</span> * <span class="number">5527</span> * <span class="number">1739687</span> * <span class="number">272437559</span> * <span class="number">1084044811</span></span><br><span class="line">p = <span class="number">227297987279223760839521045903912023553</span></span><br><span class="line">q = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line">a = <span class="number">120959747616429018926294825597988269841</span> </span><br><span class="line">b = <span class="number">146658155534937748221991162171919843659</span></span><br></pre></td></tr></table></figure>

<p>然后进行 smart attack 和 discrete_log</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">def SmartAttack(P,Q,p):</span><br><span class="line">    <span class="attr">E</span> = P.curve()</span><br><span class="line">    <span class="attr">Eqp</span> = EllipticCurve(Qp(p, <span class="number">2</span>), [ ZZ(t) + randint(<span class="number">0</span>,p)*p for t <span class="keyword">in</span> E.a_invariants() ])</span><br><span class="line"></span><br><span class="line">    <span class="attr">P_Qps</span> = Eqp.lift_x(ZZ(P.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for P_Qp <span class="keyword">in</span> P_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(P_Qp.xy()[<span class="number">1</span>]) == P.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">Q_Qps</span> = Eqp.lift_x(ZZ(Q.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for Q_Qp <span class="keyword">in</span> Q_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(Q_Qp.xy()[<span class="number">1</span>]) == Q.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">p_times_P</span> = p*P_Qp</span><br><span class="line">    <span class="attr">p_times_Q</span> = p*Q_Qp</span><br><span class="line"></span><br><span class="line">    x_P,<span class="attr">y_P</span> = p_times_P.xy()</span><br><span class="line">    x_Q,<span class="attr">y_Q</span> = p_times_Q.xy()</span><br><span class="line"></span><br><span class="line">    <span class="attr">phi_P</span> = -(x_P/y_P)</span><br><span class="line">    <span class="attr">phi_Q</span> = -(x_Q/y_Q)</span><br><span class="line">    <span class="attr">k</span> = phi_Q/phi_P</span><br><span class="line">    return ZZ(k)</span><br><span class="line"></span><br><span class="line"><span class="attr">p</span> = <span class="number">227297987279223760839521045903912023553</span></span><br><span class="line"><span class="attr">q</span> = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line"><span class="attr">a</span> = <span class="number">120959747616429018926294825597988269841</span> </span><br><span class="line"><span class="attr">b</span> = <span class="number">146658155534937748221991162171919843659</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Ep</span> = EllipticCurve(GF(p), [a,b])</span><br><span class="line"><span class="attr">G</span> = Ep(<span class="number">97161828186858857945099901434400040095</span>,<span class="number">76112161730436240110429589963792144699</span>)</span><br><span class="line"><span class="attr">rG</span> = Ep(<span class="number">194119107523766318610516779439078452539</span>,<span class="number">111570625156450061932127850545534033820</span>)</span><br><span class="line"></span><br><span class="line">print(SmartAttack(G,rG,p))</span><br><span class="line"></span><br><span class="line"><span class="attr">Eq</span> = EllipticCurve(GF(q), [a,b])</span><br><span class="line"><span class="attr">H</span> = Eq(<span class="number">229869041108862357437180702478501205702</span>,<span class="number">238550780537940464808919616209960416466</span>)</span><br><span class="line"><span class="attr">sH</span> = Eq(<span class="number">18599290990046241788386470878953668775</span>,<span class="number">281648589325596060237553465951876240185</span>)</span><br><span class="line"></span><br><span class="line">print(H.discrete_log(sH))</span><br></pre></td></tr></table></figure>

<p>交互拿到flag：<code>CCTF{ECC_With_Special_Prime5}</code></p>
<p>不过还有比较简单的方法（也许是非预期），这里只检查了 $a\cdot b = 0?$ 而不是在模 $p$ 下，所以这里可以绕过，从而构造一条奇异曲线 $y^2 \equiv x^3 \pmod p$</p>
<p>这样就有同态 $E(x,y) \to \frac{x}{y}$，离散对数解起来就很方便了。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="number">227297987279223760839521045903912023553</span></span><br><span class="line"><span class="keyword">q</span> = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Fp = GF(p)</span><br><span class="line">Fq = GF(<span class="keyword">q</span>)</span><br><span class="line"></span><br><span class="line">Px, Py = (<span class="number">171267639996301888897655876215740853691</span>,<span class="number">17515108248008333086755597522577521623</span>)</span><br><span class="line">kPx, kPy = (<span class="number">188895340186764942633236645126076288341</span>,<span class="number">83479740999426843193232746079655679683</span>)</span><br><span class="line">k = Fp(Fp(kPx) / Fp(kPy)) / Fp(Fp(Px) / Fp(Py))</span><br><span class="line"></span><br><span class="line">Qx, Qy = (<span class="number">297852081644256946433151544727117912742</span>,<span class="number">290511976119282973548634325709079145116</span>)</span><br><span class="line">lQx, lQy = (<span class="number">83612230453021831094477443040279571268</span>,<span class="number">430089842202788608377537684275601116540</span>)</span><br><span class="line">l = F<span class="string">q(Fq(lQx)</span> / F<span class="string">q(lQy)</span>) / F<span class="string">q(Fq(Qx)</span> / F<span class="string">q(Qy)</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(f<span class="string">'&#123;k&#125;, &#123;l&#125;'</span>)</span><br></pre></td></tr></table></figure>

<p>以上脚本来自<a href="https://blog.cryptohack.org/cryptoctf2021-hard#tiny-ecc" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-hard#tiny-ecc</a></p>
<h2 id="ELEGANT-CURVE"><a href="#ELEGANT-CURVE" class="headerlink" title="ELEGANT CURVE"></a>ELEGANT CURVE</h2><p>POINTS：217</p>
<p>考点：椭圆曲线离散对数</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.<span class="keyword">number</span> import *</span><br><span class="line">import sys</span><br><span class="line">from flag import flag</span><br><span class="line"></span><br><span class="line">def tonelli_shanks(n, <span class="keyword">p</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">pow</span>(n, <span class="keyword">int</span>((<span class="keyword">p</span>-<span class="number">1</span>)//<span class="number">2</span>), <span class="keyword">p</span>) == <span class="number">1</span>:</span><br><span class="line">            s = <span class="number">1</span></span><br><span class="line">            q = <span class="keyword">int</span>((<span class="keyword">p</span>-<span class="number">1</span>)//<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">while</span> True:</span><br><span class="line">                <span class="keyword">if</span> q % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    q = q // <span class="number">2</span></span><br><span class="line">                    s += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> s == <span class="number">1</span>:</span><br><span class="line">                r1 = <span class="built_in">pow</span>(n, <span class="keyword">int</span>((<span class="keyword">p</span>+<span class="number">1</span>)//<span class="number">4</span>), <span class="keyword">p</span>)</span><br><span class="line">                r2 = <span class="keyword">p</span> - r1</span><br><span class="line">                <span class="keyword">return</span> r1, r2</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">z</span> = <span class="number">2</span></span><br><span class="line">                <span class="keyword">while</span> True:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">pow</span>(<span class="keyword">z</span>, <span class="keyword">int</span>((<span class="keyword">p</span>-<span class="number">1</span>)//<span class="number">2</span>), <span class="keyword">p</span>) == <span class="keyword">p</span> - <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">c</span> = <span class="built_in">pow</span>(<span class="keyword">z</span>, q, <span class="keyword">p</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">z</span> += <span class="number">1</span></span><br><span class="line">                r = <span class="built_in">pow</span>(n, <span class="keyword">int</span>((q+<span class="number">1</span>)//<span class="number">2</span>), <span class="keyword">p</span>)</span><br><span class="line">                t = <span class="built_in">pow</span>(n, q, <span class="keyword">p</span>)</span><br><span class="line">                <span class="keyword">m</span> = s</span><br><span class="line">                <span class="keyword">while</span> True:</span><br><span class="line">                    <span class="keyword">if</span> t == <span class="number">1</span>:</span><br><span class="line">                        r1 = r</span><br><span class="line">                        r2 = <span class="keyword">p</span> - r1</span><br><span class="line">                        <span class="keyword">return</span> r1, r2</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        i = <span class="number">1</span></span><br><span class="line">                        <span class="keyword">while</span> True:</span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">pow</span>(t, <span class="number">2</span>**i, <span class="keyword">p</span>) == <span class="number">1</span>:</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                i += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">b</span> = <span class="built_in">pow</span>(<span class="keyword">c</span>, <span class="number">2</span>**(<span class="keyword">m</span>-i-<span class="number">1</span>), <span class="keyword">p</span>)</span><br><span class="line">                        r = r * <span class="keyword">b</span> % <span class="keyword">p</span></span><br><span class="line">                        t = t * <span class="keyword">b</span> ** <span class="number">2</span> % <span class="keyword">p</span></span><br><span class="line">                        <span class="keyword">c</span> = <span class="keyword">b</span> ** <span class="number">2</span> % <span class="keyword">p</span></span><br><span class="line">                        <span class="keyword">m</span> = i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(A, B, <span class="keyword">p</span>):</span><br><span class="line">    <span class="keyword">if</span> A == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> B</span><br><span class="line">    <span class="keyword">if</span> B == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> A</span><br><span class="line">    <span class="keyword">l</span> = ((B[<span class="number">1</span>] - A[<span class="number">1</span>]) * inverse(B[<span class="number">0</span>] - A[<span class="number">0</span>], <span class="keyword">p</span>)) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">x</span> = (<span class="keyword">l</span>*<span class="keyword">l</span> - A[<span class="number">0</span>] - B[<span class="number">0</span>]) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">y</span> = (<span class="keyword">l</span>*(A[<span class="number">0</span>] - <span class="keyword">x</span>) - A[<span class="number">1</span>]) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>(<span class="keyword">x</span>), <span class="keyword">int</span>(<span class="keyword">y</span>))</span><br><span class="line"></span><br><span class="line">def double(G, <span class="keyword">a</span>, <span class="keyword">p</span>):</span><br><span class="line">    <span class="keyword">if</span> G == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> G</span><br><span class="line">    <span class="keyword">l</span> = ((<span class="number">3</span>*G[<span class="number">0</span>]*G[<span class="number">0</span>] + <span class="keyword">a</span>) * inverse(<span class="number">2</span>*G[<span class="number">1</span>], <span class="keyword">p</span>)) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">x</span> = (<span class="keyword">l</span>*<span class="keyword">l</span> - <span class="number">2</span>*G[<span class="number">0</span>]) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">y</span> = (<span class="keyword">l</span>*(G[<span class="number">0</span>] - <span class="keyword">x</span>) - G[<span class="number">1</span>]) % <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>(<span class="keyword">x</span>), <span class="keyword">int</span>(<span class="keyword">y</span>))</span><br><span class="line"></span><br><span class="line">def multiply(point, exponent, <span class="keyword">a</span>, <span class="keyword">p</span>):</span><br><span class="line">    r0 = <span class="number">0</span></span><br><span class="line">    r1 = point</span><br><span class="line">    <span class="keyword">for</span> i in bin(exponent)[<span class="number">2</span>:]:</span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">'0'</span>:</span><br><span class="line">            r1 = <span class="built_in">add</span>(r0, r1, <span class="keyword">p</span>)</span><br><span class="line">            r0 = double(r0, <span class="keyword">a</span>, <span class="keyword">p</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r0 = <span class="built_in">add</span>(r0, r1, <span class="keyword">p</span>)</span><br><span class="line">            r1 = double(r1, <span class="keyword">a</span>, <span class="keyword">p</span>)</span><br><span class="line">    <span class="keyword">return</span> r0</span><br><span class="line"></span><br><span class="line">def random_point(<span class="keyword">a</span>, <span class="keyword">b</span>, <span class="keyword">p</span>):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">x</span> = getRandomRange(<span class="number">1</span>, <span class="keyword">p</span>-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">y</span>, _ = tonelli_shanks((<span class="keyword">x</span>**<span class="number">3</span> + <span class="keyword">a</span>*<span class="keyword">x</span> + <span class="keyword">b</span>) % <span class="keyword">p</span>, <span class="keyword">p</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">x</span>, <span class="keyword">y</span>)</span><br><span class="line">        excep<span class="variable">t:</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">def die(*<span class="keyword">args</span>):</span><br><span class="line">    pr(*<span class="keyword">args</span>)</span><br><span class="line">    <span class="keyword">quit</span>()</span><br><span class="line"></span><br><span class="line">def pr(*<span class="keyword">args</span>):</span><br><span class="line">    s = <span class="string">" "</span>.<span class="keyword">join</span>(<span class="keyword">map</span>(str, <span class="keyword">args</span>))</span><br><span class="line">    sys.stdout.<span class="keyword">write</span>(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">def sc():</span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">" hi talented cryptographers, the mission is decrypt a secret message"</span>, border)</span><br><span class="line">    pr(border, <span class="string">" with given parameters for two elliptic curve, so be genius and send"</span>, border)</span><br><span class="line">    pr(border, <span class="string">" suitable parameters, now try to get the flag!                      "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    nbit = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[S]end ECC parameters and solve the task \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            pr(<span class="string">"| Send the parameters of first ECC y^2 = x^3 + ax + b like: a, b, p "</span>)</span><br><span class="line">            params = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">a</span>, <span class="keyword">b</span>, <span class="keyword">p</span> = params.<span class="keyword">split</span>(<span class="string">','</span>)</span><br><span class="line">                <span class="keyword">a</span>, <span class="keyword">b</span>, <span class="keyword">p</span> = <span class="keyword">int</span>(<span class="keyword">a</span>), <span class="keyword">int</span>(<span class="keyword">b</span>), <span class="keyword">int</span>(<span class="keyword">p</span>)</span><br><span class="line">            excep<span class="variable">t:</span></span><br><span class="line">                die(<span class="string">"| your parameters are not valid!!"</span>)</span><br><span class="line">            <span class="keyword">if</span> isPrime(<span class="keyword">p</span>) <span class="built_in">and</span> <span class="number">0</span> &lt; <span class="keyword">a</span> &lt; <span class="keyword">p</span> <span class="built_in">and</span> <span class="number">0</span> &lt; <span class="keyword">b</span> &lt; <span class="keyword">p</span> <span class="built_in">and</span> <span class="keyword">p</span>.bit_length() == nbi<span class="variable">t:</span></span><br><span class="line">                pr(<span class="string">"| Send the parameters of second ECC y^2 = x^3 + cx + d like: c, d, q "</span>)</span><br><span class="line">                pr(<span class="string">"| such that 0 &lt; q - p &lt;= 2022"</span>)</span><br><span class="line">                params = sc()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">c</span>, d, q = params.<span class="keyword">split</span>(<span class="string">','</span>)</span><br><span class="line">                    <span class="keyword">c</span>, d, q = <span class="keyword">int</span>(<span class="keyword">c</span>), <span class="keyword">int</span>(d), <span class="keyword">int</span>(q)</span><br><span class="line">                excep<span class="variable">t:</span></span><br><span class="line">                    die(<span class="string">"| your parameters are not valid!!"</span>)</span><br><span class="line">                <span class="keyword">if</span> isPrime(q) <span class="built_in">and</span> <span class="number">0</span> &lt; <span class="keyword">c</span> &lt; q <span class="built_in">and</span> <span class="number">0</span> &lt; d &lt; q <span class="built_in">and</span> <span class="number">0</span> &lt; q - <span class="keyword">p</span> &lt;= <span class="number">2022</span> <span class="built_in">and</span> q.bit_length() == nbi<span class="variable">t:</span></span><br><span class="line">                    G, H = random_point(<span class="keyword">a</span>, <span class="keyword">b</span>, <span class="keyword">p</span>), random_point(<span class="keyword">c</span>, d, q)</span><br><span class="line">                    r, s = [getRandomRange(<span class="number">1</span>, <span class="keyword">p</span>-<span class="number">1</span>) <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">                    pr(<span class="keyword">f</span><span class="string">"| G is on first  ECC and G ="</span>, &#123;G&#125;)</span><br><span class="line">                    pr(<span class="keyword">f</span><span class="string">"| H is on second ECC and H ="</span>, &#123;H&#125;)</span><br><span class="line">                    U = multiply(G, r, <span class="keyword">a</span>, <span class="keyword">p</span>)</span><br><span class="line">                    V = multiply(H, s, <span class="keyword">c</span>, q)</span><br><span class="line">                    pr(<span class="keyword">f</span><span class="string">"| r * G ="</span>, &#123;U&#125;)</span><br><span class="line">                    pr(<span class="keyword">f</span><span class="string">"| s * H ="</span>, &#123;V&#125;)</span><br><span class="line">                    pr(<span class="string">"| Send r, s to get the flag: "</span>)</span><br><span class="line">                    rs = sc()</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">u</span>, v = rs.<span class="keyword">split</span>(<span class="string">','</span>)</span><br><span class="line">                        <span class="keyword">u</span>, v = <span class="keyword">int</span>(<span class="keyword">u</span>), <span class="keyword">int</span>(v)</span><br><span class="line">                    excep<span class="variable">t:</span></span><br><span class="line">                        die(<span class="string">"| invalid input, bye!"</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">u</span> == r <span class="built_in">and</span> v == <span class="variable">s:</span></span><br><span class="line">                        die(<span class="string">"| You got the flag:"</span>, flag)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        die(<span class="string">"| the answer is not correct, bye!"</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    die(<span class="string">"| invalid parameters, bye!"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">"| invalid parameters, bye!"</span>)</span><br><span class="line">        elif ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>和上面的差不多，不过这次要输入两条曲线各自的 $a,b,p$，也限制了$p-q&lt;2022,$ $a,b,c,d$ 也必须是大于 $0$，小于 $p$ 或者 $q$ 的，这样我们就不能用 $a=b=0$ 或者是 $a,b = kp$ 这样去构造奇异曲线 $y^2 \equiv x^3 \pmod p$ 了，那就还是用TinyECC那边的smartattack叭，找到一条奇异曲线，然后设 $q = nextprme(p)$，再改变合适的系数使得 $#Eq$ 是光滑的（前面是变 $q$，这里是变 $a,b$，都大差不差的），这样离散对数好求。</p>
<p>下面是一组示例</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">q = <span class="number">730750818665451459112596905638433048232067472077</span></span><br><span class="line">aq = <span class="number">3</span></span><br><span class="line">bq = <span class="number">481</span></span><br><span class="line">Eq = EllipticCurve(GF(q), [aq,bq])</span><br><span class="line"></span><br><span class="line">factor(Eq.order())                                                                                                </span><br><span class="line"><span class="number">2</span>^<span class="number">2</span> * <span class="number">3</span> * <span class="number">167</span> * <span class="number">193</span> * <span class="number">4129</span> * <span class="number">882433</span> * <span class="number">2826107</span> * <span class="number">51725111</span> * <span class="number">332577589</span> * <span class="number">10666075363</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">p</span> = <span class="number">730750818665451459112596905638433048232067471723</span> </span><br><span class="line"><span class="attr">ap</span> = <span class="number">425706413842211054102700238164133538302169176474</span> </span><br><span class="line"><span class="attr">bp</span> = <span class="number">203362936548826936673264444982866339953265530166</span></span><br><span class="line"><span class="attr">q</span> = <span class="number">730750818665451459112596905638433048232067472077</span></span><br><span class="line"><span class="attr">aq</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">bq</span> = <span class="number">481</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">from random <span class="built_in">import</span> getrandbits</span><br><span class="line"></span><br><span class="line"><span class="comment"># params from http://www.monnerat.info/publications/anomalous.pdf</span></span><br><span class="line"><span class="attr">D</span> = <span class="number">11</span></span><br><span class="line"><span class="attr">j</span> = -<span class="number">2</span>**<span class="number">15</span></span><br><span class="line"></span><br><span class="line">def anom_curve():</span><br><span class="line">    <span class="attr">m</span> = <span class="number">257743850762632419871495</span></span><br><span class="line">    <span class="attr">p</span> = (<span class="number">11</span>*m*(m + <span class="number">1</span>)) + <span class="number">3</span></span><br><span class="line">    <span class="attr">a</span> = (-<span class="number">3</span>*j * inverse_mod((j - <span class="number">1728</span>), p)) % p</span><br><span class="line">    <span class="attr">b</span> = (<span class="number">2</span>*j * inverse_mod((j - <span class="number">1728</span>), p)) % p</span><br><span class="line">    <span class="attr">E</span> = EllipticCurve(GF(p), [a,b])</span><br><span class="line">    <span class="attr">G</span> = E.gens()[<span class="number">0</span>]</span><br><span class="line">    return p, a, b, E, G</span><br><span class="line"></span><br><span class="line">def SmartAttack(P,Q,p):</span><br><span class="line">    <span class="attr">E</span> = P.curve()</span><br><span class="line">    <span class="attr">Eqp</span> = EllipticCurve(Qp(p, <span class="number">2</span>), [ ZZ(t) + randint(<span class="number">0</span>,p)*p for t <span class="keyword">in</span> E.a_invariants() ])</span><br><span class="line"></span><br><span class="line">    <span class="attr">P_Qps</span> = Eqp.lift_x(ZZ(P.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for P_Qp <span class="keyword">in</span> P_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(P_Qp.xy()[<span class="number">1</span>]) == P.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">Q_Qps</span> = Eqp.lift_x(ZZ(Q.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for Q_Qp <span class="keyword">in</span> Q_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(Q_Qp.xy()[<span class="number">1</span>]) == Q.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">p_times_P</span> = p*P_Qp</span><br><span class="line">    <span class="attr">p_times_Q</span> = p*Q_Qp</span><br><span class="line"></span><br><span class="line">    x_P,<span class="attr">y_P</span> = p_times_P.xy()</span><br><span class="line">    x_Q,<span class="attr">y_Q</span> = p_times_Q.xy()</span><br><span class="line"></span><br><span class="line">    <span class="attr">phi_P</span> = -(x_P/y_P)</span><br><span class="line">    <span class="attr">phi_Q</span> = -(x_Q/y_Q)</span><br><span class="line">    <span class="attr">k</span> = phi_Q/phi_P</span><br><span class="line">    return ZZ(k)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">p</span> = <span class="number">730750818665451459112596905638433048232067471723</span> </span><br><span class="line"><span class="attr">ap</span> = <span class="number">425706413842211054102700238164133538302169176474</span> </span><br><span class="line"><span class="attr">bp</span> = <span class="number">203362936548826936673264444982866339953265530166</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Ep</span> = EllipticCurve(GF(p), [ap,bp])</span><br><span class="line"><span class="attr">G</span> = Ep(<span class="number">126552689249226752349356206494226396414163660811</span>, <span class="number">559777835342379827315577715664975494598512818777</span>)</span><br><span class="line"><span class="attr">rG</span> = Ep(<span class="number">190128385937465835164338802317889165657442536853</span>, <span class="number">604514027124204305317929024826237325074492980218</span>)</span><br><span class="line"></span><br><span class="line">print(SmartAttack(G,rG,p))</span><br><span class="line"></span><br><span class="line"><span class="attr">q</span> = <span class="number">730750818665451459112596905638433048232067472077</span></span><br><span class="line"><span class="attr">aq</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">bq</span> = <span class="number">481</span></span><br><span class="line"><span class="attr">Eq</span> = EllipticCurve(GF(q), [aq,bq])</span><br><span class="line"></span><br><span class="line"><span class="attr">H</span> = Eq(<span class="number">284866865619833057500909264169831974815120720320</span>, <span class="number">612322665682105897045018564282609259776516527853</span>)</span><br><span class="line"><span class="attr">sH</span> = Eq(<span class="number">673590124165798818844330235458561515292416807353</span>, <span class="number">258709088293250578320930080839442511989120686226</span>)</span><br><span class="line"></span><br><span class="line">print(H.discrete_log(sH))</span><br></pre></td></tr></table></figure>

<p>flag: CCTF{Pl4yIn9_Wi7H_ECC_1Z_liK3_pLAiNg_wiTh_Fir3!!}</p>
<p>PS：感觉这两道题也可以控制参数使得两条曲线的阶都是比较光滑的，然后再解离散对数？</p>
<h2 id="DOUBLE-MIFF"><a href="#DOUBLE-MIFF" class="headerlink" title="DOUBLE MIFF"></a>DOUBLE MIFF</h2><p>POINTS：217</p>
<p>考点：椭圆曲线与丢番图方程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> a, b, p, P, Q</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onmiff</span><span class="params">(a, b, p, G)</span>:</span></span><br><span class="line">    x, y = G</span><br><span class="line">    <span class="keyword">return</span> (a*x*(y**<span class="number">2</span> - <span class="number">1</span>) - b*y*(x**<span class="number">2</span> - <span class="number">1</span>)) % p == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addmiff</span><span class="params">(X, Y)</span>:</span></span><br><span class="line">    x_1, y_1 = X</span><br><span class="line">    x_2, y_2 = Y</span><br><span class="line">    x_3 = (x_1 + x_2) * (<span class="number">1</span> + y_1*y_2) * inverse((<span class="number">1</span> + x_1*x_2) * (<span class="number">1</span> - y_1*y_2), p) % p</span><br><span class="line">    y_3 = (y_1 + y_2) * (<span class="number">1</span> + x_1*x_2) * inverse((<span class="number">1</span> + y_1*y_2) * (<span class="number">1</span> - x_1*x_2), p) % p</span><br><span class="line">    <span class="keyword">return</span> (x_3, y_3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = len(flag) // <span class="number">2</span></span><br><span class="line">m1, m2 = bytes_to_long(flag[:l]), bytes_to_long(flag[l:])</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> m1 &lt; (p // <span class="number">2</span>) <span class="keyword">and</span> m2 &lt; (p // <span class="number">2</span>)</span><br><span class="line"><span class="keyword">assert</span> onmiff(a, b, p, P) <span class="keyword">and</span> onmiff(a, b, p, Q)</span><br><span class="line"><span class="keyword">assert</span> P[<span class="number">0</span>] == m1 <span class="keyword">and</span> Q[<span class="number">0</span>] == m2</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'P + Q = <span class="subst">&#123;addmiff(P, Q)&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'Q + Q = <span class="subst">&#123;addmiff(Q, Q)&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'P + P = <span class="subst">&#123;addmiff(P, P)&#125;</span>'</span>)</span><br><span class="line">P + Q = (<span class="number">540660810777215925744546848899656347269220877882</span>, <span class="number">102385886258464739091823423239617164469644309399</span>)</span><br><span class="line">Q + Q = (<span class="number">814107817937473043563607662608397956822280643025</span>, <span class="number">961531436304505096581595159128436662629537620355</span>)</span><br><span class="line">P + P = (<span class="number">5565164868721370436896101492497307801898270333</span>, <span class="number">4969213281060625285080264123281718864612235</span></span><br></pre></td></tr></table></figure>

<p>根据题目我们有曲线 $ax(y^2 - 1)\equiv by(x^2-1) \pmod p$，其中曲线参数 $a,b,p$ 均未知，但是我们有 $P+P,Q+Q,P+Q$，$p$ 总是要恢复的叭，需要用到给出的三个点。那么通过这三个点，我们有等式 $(P+P) + (Q+Q) = 2 \cdot (P+Q)$，我们设 $2\cdot (P+Q)=(x_0,y_0),P+Q=(x_1,y_1),Q+Q=(x_2,y_2),P+P=(x_3,y_3)$，那么我们有<br>$$<br>x_0 \equiv \frac{(x_2+x_3)\cdot(1+y_2y_3)}{(1+x_2x_3)(1-y_2y_3)} \pmod p<br>$$</p>
<p>$$<br>x_0 \equiv \frac{2x_1(1+y_1^2)}{(1+x_1^2)(1-y_1^2)} \pmod p<br>$$</p>
<p>两式相减我们有<br>$$<br>(x_2+x_3)\cdot(1+y_2y_3) \cdot (1+x_1^2)(1-y_1^2)-2x_1(1+y_1^2)\cdot(1+x_2x_3)(1-y_2y_3) \equiv 0 \pmod p<br>$$<br>同理，由 $y$ 坐标的计算公式我们可以得到<br>$$<br>(y_2+y_3)\cdot(1+x_2x_3) \cdot (1+y_1^2)(1-x_1^2)-2y_1(1+x_1^2)\cdot(1+y_2y_3)(1-x_2x_3) \equiv 0 \pmod p<br>$$<br>两个模 $p$ 同余 $0$ 式子，我们求一个 $gcd$ 就能获取 $p$ 的一个倍数了，分解一下应该就能获取素数 $p$。</p>
<p>回到曲线的式子 $ax(y^2-1) \equiv by(x^2-1)$，对于两个未知数，emmm，我们给他搞成一个先 ，故而有<br>$$<br>k \equiv \frac{a}{b} \equiv \frac{y(x^2-1)}{x(y^2-1)}<br>$$<br>于是只需要一个点我们就能知道 $k \equiv \frac {a}{b}$，换一换也有<br>$$<br>k\frac{x}{x^2-1} \equiv \frac{y}{y^2-1}<br>$$<br>我们设 $P=(x_4,y_4)$，那么根据加法规则，我们有<br>$$<br>x_3 \equiv \frac{2x_4(1+y_4^2)}{(1+x_4^2)(1-y_4^2)} \pmod p<br>$$</p>
<p>$$<br>y_3 \equiv \frac{2y_4(1+x_4^2)}{(1+y_4^2)(1-x_4^2)} \pmod p<br>$$</p>
<p>两式相乘，我们有<br>$$<br>x_3y_3 \equiv \frac{4x_4y_4}{(x_4^2-1)(y_4^2-1)} \equiv 4k(\frac{x_4}{x_4^2-1})^2 \pmod p<br>$$<br>于是我们有<br>$$<br>(\frac{x_4^2-1}{x_4})^2 \equiv \frac{4k}{x_3y_3} \pmod p<br>$$<br>因为 $p \equiv 3 \pmod 4$，于是我们设 $l \equiv (\frac{4k}{x_3y_3})^{\frac{p+1}{4}}$，则有 $\frac{x_4^2-1}{x_4} \equiv \pm l$</p>
<p>于是我们有 $-x_4^2 \pm lx_4 +1 \equiv 0\pmod p$，解一手二次方程，$x \equiv \frac{\mp l \pm \sqrt{l^2+4}}{2}$ ，我们就能够拿到 $P$ 啦，同理也可以这么去拿$Q$，然后就能恢复 flag了。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">from Crypto.Util.number <span class="built_in">import</span> isPrime, long_to_bytes</span><br><span class="line">from math <span class="built_in">import</span> gcd</span><br><span class="line"></span><br><span class="line">x1, <span class="attr">y1</span> = (<span class="number">540660810777215925744546848899656347269220877882</span>, <span class="number">102385886258464739091823423239617164469644309399</span>)</span><br><span class="line">x2, <span class="attr">y2</span> = (<span class="number">814107817937473043563607662608397956822280643025</span>, <span class="number">961531436304505096581595159128436662629537620355</span>)</span><br><span class="line">x3, <span class="attr">y3</span> = (<span class="number">5565164868721370436896101492497307801898270333</span>, <span class="number">496921328106062528508026412328171886461223562143</span>)</span><br><span class="line"><span class="attr">num1</span> = (<span class="number">1</span> + x1 ** <span class="number">2</span>) * (<span class="number">1</span> - y1 ** <span class="number">2</span>) * (x2 + x3) * (<span class="number">1</span> + y2 * y3) - <span class="number">2</span> * x1 * (<span class="number">1</span> + y1 ** <span class="number">2</span>) * (<span class="number">1</span> + x2 * x3) * (<span class="number">1</span> - y2 * y3)</span><br><span class="line"><span class="attr">num2</span> = (<span class="number">1</span> + y1 ** <span class="number">2</span>) * (<span class="number">1</span> - x1 ** <span class="number">2</span>) * (y2 + y3) * (<span class="number">1</span> + x2 * x3) - <span class="number">2</span> * y1 * (<span class="number">1</span> + x1 ** <span class="number">2</span>) * (<span class="number">1</span> + y2 * y3) * (<span class="number">1</span> - x2 * x3)</span><br><span class="line"><span class="attr">pmult</span> = gcd(num1, num2)</span><br><span class="line">print(pmult)</span><br><span class="line"><span class="comment"># sage: factor(9132984636916703206790144643146359197427822823096)</span></span><br><span class="line"><span class="comment"># 2^3 * 1141623079614587900848768080393294899678477852887</span></span><br><span class="line"></span><br><span class="line"><span class="attr">p=1141623079614587900848768080393294899678477852887</span></span><br><span class="line">def recover_half(x, y):</span><br><span class="line">    <span class="attr">k</span> = y * (x ** <span class="number">2</span> - <span class="number">1</span>) * pow(x * (y ** <span class="number">2</span> - <span class="number">1</span>), -<span class="number">1</span>, p) % p</span><br><span class="line">    <span class="attr">l</span> = pow(<span class="number">4</span> * k * pow(x * y, -<span class="number">1</span>, p), (p + <span class="number">1</span>) // <span class="number">4</span>, p)</span><br><span class="line">    <span class="attr">D</span> = (l ** <span class="number">2</span> + <span class="number">4</span>) % p</span><br><span class="line">    <span class="attr">sqrtD</span> = pow(D, (p + <span class="number">1</span>) // <span class="number">4</span>, p)</span><br><span class="line">    for i <span class="keyword">in</span> (-<span class="number">1</span>, <span class="number">1</span>):</span><br><span class="line">        for j <span class="keyword">in</span> (-<span class="number">1</span>, <span class="number">1</span>):</span><br><span class="line">            <span class="attr">num</span> = (i * l + j * sqrtD) * pow(<span class="number">2</span>, -<span class="number">1</span>, p) % p</span><br><span class="line">            <span class="attr">text</span> = long_to_bytes(num)</span><br><span class="line">            <span class="keyword">if</span> b'CCTF&#123;' <span class="keyword">in</span> text <span class="literal">or</span> b'&#125;' <span class="keyword">in</span> text:</span><br><span class="line">                return text</span><br><span class="line"></span><br><span class="line"><span class="attr">first_half</span> = recover_half(x3, y3)</span><br><span class="line"><span class="attr">second_half</span> = recover_half(x2, y2)</span><br><span class="line"><span class="attr">flag</span> = (first_half + second_half).decode()</span><br><span class="line">print(flag)</span><br><span class="line"><span class="comment">#CCTF&#123;D39enEr47E_ECC_4TtaCk!_iN_Huffs?&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="ECCHIMERA"><a href="#ECCHIMERA" class="headerlink" title="ECCHIMERA"></a>ECCHIMERA</h2><p>POINTS：271</p>
<p>考点：椭圆曲线离散对数，smart attack，pohlig-hellman</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from sage.all import *</span><br><span class="line">from flag import flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = 43216667049953267964807040003094883441902922285265979216983383601881964164181</span><br><span class="line">U = 18230294945466842193029464818176109628473414458693455272527849780121431872221</span><br><span class="line">V = 13100009444194791894141652184719316024656527520759416974806280188465496030062</span><br><span class="line">W = 5543957019331266247602346710470760261172306141315670694208966786894467019982</span><br><span class="line"></span><br><span class="line">flag = flag.lstrip(b'CCTF&#123;').rstrip(b'&#125;')</span><br><span class="line">s = int(flag.hex(), 16)</span><br><span class="line">assert s &lt; n</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(n), [0, U, 0, V, W])</span><br><span class="line">G = E(6907136022576092896571634972837671088049787669883537619895520267229978111036, 35183770197918519490131925119869132666355991678945374923783026655753112300226)</span><br><span class="line"></span><br><span class="line">print(f'G = &#123;G&#125;')</span><br><span class="line">print(f's * G = &#123;s * G&#125;')</span><br></pre></td></tr></table></figure>

<p>n可以分解</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">n = 43216667049953267964807040003094883441902922285265979216983383601881964164181</span><br><span class="line">U = 18230294945466842193029464818176109628473414458693455272527849780121431872221</span><br><span class="line">V = 13100009444194791894141652184719316024656527520759416974806280188465496030062</span><br><span class="line">W = 5543957019331266247602346710470760261172306141315670694208966786894467019982</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(n), [0, U, 0, V, W])</span><br><span class="line">G = E(6907136022576092896571634972837671088049787669883537619895520267229978111036, 35183770197918519490131925119869132666355991678945374923783026655753112300226)</span><br><span class="line">sG = E(14307615146512108428634858855432876073550684773654843931813155864728883306026, 4017273397399838235912099970694615152686460424982458188724369340441833733921)</span><br><span class="line"></span><br><span class="line">p = 190116434441822299465355144611018694747</span><br><span class="line">q = 227316839687407660649258155239617355023</span><br><span class="line"></span><br><span class="line">assert p * q == n</span><br><span class="line"></span><br><span class="line"><span class="comment"># P and Q curves</span></span><br><span class="line">Ep = EllipticCurve(GF(p), [0, ZZ(U % p), 0, ZZ(V % p), ZZ(W % p)])</span><br><span class="line">Eq = EllipticCurve(GF(q), [0, ZZ(U % q), 0, ZZ(V % q), ZZ(W % q)])</span><br><span class="line"></span><br><span class="line">kp = Ep.order()</span><br><span class="line">kq = Eq.order()</span><br></pre></td></tr></table></figure>

<p>第一部分</p>
<p>kp=p，smart attack</p>
<p>第二部分</p>
<p>sage: factor(kq)<br>2^4 * 3 * 13 * 233 * 4253 * 49555349 * 7418313402470596923151 </p>
<p>但是直接discrete_log好像不行，这里选择放弃因子 3（Gq的阶没有因子3） 和 最大的 7418313402470596923151（数值太大） ，然后手撸一个pohlig hellman （也可以调参调用discrete_log，但好慢，感觉不如手撸）</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">primes</span> = [<span class="number">2</span>^<span class="number">4</span>,<span class="number">13</span>, <span class="number">233</span>, <span class="number">4253</span>, <span class="number">49555349</span>] #don't use <span class="number">3</span> <span class="keyword">and</span> <span class="built_in">last</span> one, cuz <span class="built_in">last</span> one <span class="built_in">is</span> too big, <span class="keyword">and</span> <span class="number">3</span> <span class="built_in">is</span> <span class="keyword">not</span> Gq's order's <span class="built_in">factor</span></span><br><span class="line">dlogs = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fac <span class="keyword">in</span> <span class="built_in">primes</span>:</span><br><span class="line">    <span class="built_in">print</span>(fac)</span><br><span class="line">    t = int(Gq.order()) // int(fac)</span><br><span class="line">    dlog = (t*Gq).discrete_log(t*sGq) #discrete_log(t*sGq, t*Gq, operation=<span class="string">"+"</span>)</span><br><span class="line">    dlogs += [dlog]</span><br><span class="line">    #<span class="built_in">print</span>(<span class="string">"factor: "</span>+str(fac)+<span class="string">", Discrete Log: "</span>+str(dlog)) #calculates discrete logarithm <span class="keyword">for</span> each prime order</span><br><span class="line"></span><br><span class="line">q_secret = crt(dlogs, <span class="built_in">primes</span>)</span><br></pre></td></tr></table></figure>

<p>最后再crt一下就好了</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sage</span></span><br><span class="line">from Crypto.Util.number <span class="built_in">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="attr">n</span> = <span class="number">43216667049953267964807040003094883441902922285265979216983383601881964164181</span></span><br><span class="line"><span class="attr">U</span> = <span class="number">18230294945466842193029464818176109628473414458693455272527849780121431872221</span></span><br><span class="line"><span class="attr">V</span> = <span class="number">13100009444194791894141652184719316024656527520759416974806280188465496030062</span></span><br><span class="line"><span class="attr">W</span> = <span class="number">5543957019331266247602346710470760261172306141315670694208966786894467019982</span></span><br><span class="line"></span><br><span class="line"><span class="attr">E</span> = EllipticCurve(Zmod(n), [<span class="number">0</span>, U, <span class="number">0</span>, V, W])</span><br><span class="line"><span class="attr">G</span> = E(<span class="number">6907136022576092896571634972837671088049787669883537619895520267229978111036</span>, <span class="number">35183770197918519490131925119869132666355991678945374923783026655753112300226</span>)</span><br><span class="line"><span class="attr">sG</span> = E(<span class="number">14307615146512108428634858855432876073550684773654843931813155864728883306026</span>, <span class="number">4017273397399838235912099970694615152686460424982458188724369340441833733921</span>)</span><br><span class="line"></span><br><span class="line"><span class="attr">p</span> = <span class="number">190116434441822299465355144611018694747</span></span><br><span class="line"><span class="attr">q</span> = <span class="number">227316839687407660649258155239617355023</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> p * <span class="attr">q</span> == n</span><br><span class="line"></span><br><span class="line"><span class="comment"># P curve</span></span><br><span class="line"><span class="attr">Ep</span> = EllipticCurve(GF(p), [<span class="number">0</span>, ZZ(U % p), <span class="number">0</span>, ZZ(V % p), ZZ(W % p)])</span><br><span class="line"><span class="attr">Eq</span> = EllipticCurve(GF(q), [<span class="number">0</span>, ZZ(U % q), <span class="number">0</span>, ZZ(V % q), ZZ(W % q)])</span><br><span class="line"></span><br><span class="line"><span class="attr">kp</span> = Ep.order()</span><br><span class="line"><span class="attr">kq</span> = Eq.order()</span><br><span class="line"></span><br><span class="line"><span class="attr">Gp</span> = Ep(<span class="number">6907136022576092896571634972837671088049787669883537619895520267229978111036</span>, <span class="number">35183770197918519490131925119869132666355991678945374923783026655753112300226</span>)</span><br><span class="line"><span class="attr">Gq</span> = Eq(<span class="number">6907136022576092896571634972837671088049787669883537619895520267229978111036</span>, <span class="number">35183770197918519490131925119869132666355991678945374923783026655753112300226</span>)</span><br><span class="line"></span><br><span class="line"><span class="attr">sGp</span> = Ep(<span class="number">14307615146512108428634858855432876073550684773654843931813155864728883306026</span>, <span class="number">4017273397399838235912099970694615152686460424982458188724369340441833733921</span>)</span><br><span class="line"><span class="attr">sGq</span> = Eq(<span class="number">14307615146512108428634858855432876073550684773654843931813155864728883306026</span>, <span class="number">4017273397399838235912099970694615152686460424982458188724369340441833733921</span>)</span><br><span class="line"></span><br><span class="line">print(Gp.order())</span><br><span class="line">print(Gq.order())</span><br><span class="line"></span><br><span class="line">def SmartAttack(P,Q,p):</span><br><span class="line">    <span class="attr">E</span> = P.curve()</span><br><span class="line">    <span class="attr">Eqp</span> = EllipticCurve(Qp(p, <span class="number">2</span>), [ ZZ(t) + randint(<span class="number">0</span>,p)*p for t <span class="keyword">in</span> E.a_invariants() ])</span><br><span class="line"></span><br><span class="line">    <span class="attr">P_Qps</span> = Eqp.lift_x(ZZ(P.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for P_Qp <span class="keyword">in</span> P_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(P_Qp.xy()[<span class="number">1</span>]) == P.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">Q_Qps</span> = Eqp.lift_x(ZZ(Q.xy()[<span class="number">0</span>]), <span class="attr">all=True)</span></span><br><span class="line">    for Q_Qp <span class="keyword">in</span> Q_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(Q_Qp.xy()[<span class="number">1</span>]) == Q.xy()[<span class="number">1</span>]:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    <span class="attr">p_times_P</span> = p*P_Qp</span><br><span class="line">    <span class="attr">p_times_Q</span> = p*Q_Qp</span><br><span class="line"></span><br><span class="line">    x_P,<span class="attr">y_P</span> = p_times_P.xy()</span><br><span class="line">    x_Q,<span class="attr">y_Q</span> = p_times_Q.xy()</span><br><span class="line"></span><br><span class="line">    <span class="attr">phi_P</span> = -(x_P/y_P)</span><br><span class="line">    <span class="attr">phi_Q</span> = -(x_Q/y_Q)</span><br><span class="line">    <span class="attr">k</span> = phi_Q/phi_P</span><br><span class="line">    return ZZ(k)</span><br><span class="line"></span><br><span class="line"><span class="attr">primes</span> = [<span class="number">2</span>^<span class="number">4</span>, <span class="number">13</span>, <span class="number">233</span>, <span class="number">4253</span>, <span class="number">49555349</span>] <span class="comment">#don't use 3 and last one</span></span><br><span class="line"><span class="attr">dlogs</span> = []</span><br><span class="line"></span><br><span class="line">for fac <span class="keyword">in</span> primes:</span><br><span class="line">    <span class="attr">t</span> = int(Gq.order()) // int(fac)</span><br><span class="line">    <span class="attr">dlog</span> = (t*Gq).discrete_log(t*sGq) <span class="comment">#discrete_log(t*sGq, t*Gq, operation="+")</span></span><br><span class="line">    dlogs += [dlog]</span><br><span class="line">    <span class="comment">#print("factor: "+str(fac)+", Discrete Log: "+str(dlog)) #calculates discrete logarithm for each prime order</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">p_secret</span> = SmartAttack(Gp,sGp,p)</span><br><span class="line"><span class="attr">q_secret</span> = crt(dlogs, primes)  <span class="comment">#9092500866606561 #discrete_log(sGq, Gq, ord=Gq.order(), bounds=2^4 * 13 * 233 * 4253 * 49555349, operation="+")</span></span><br><span class="line"></span><br><span class="line">print(p_secret, q_secret)</span><br><span class="line"><span class="attr">flag</span> = long_to_bytes(int(crt([p_secret, q_secret], [Gp.order(), Gq.order() // <span class="number">7418313402470596923151</span>])))</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>flag:CCTF{m1X3d_VeR5!0n_oF_3Cc!}</p>
<p>主要因为 $flag &lt; Gp.order \cdot Gq.order / 7418313402470596923151 $ ，所以我们才能解出flag。</p>
<h2 id="ROHALD"><a href="#ROHALD" class="headerlink" title="ROHALD"></a>ROHALD</h2><p>POINTS：180</p>
<p>考点：椭圆曲线、Edwards Curve、Montgomery、Weierstrass</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag, Curve</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ison</span><span class="params">(C, P)</span>:</span></span><br><span class="line">    c, d, p = C</span><br><span class="line">    u, v = P</span><br><span class="line">    <span class="keyword">return</span> (u**<span class="number">2</span> + v**<span class="number">2</span> - c**<span class="number">2</span> * (<span class="number">1</span> + d * u**<span class="number">2</span>*v**<span class="number">2</span>)) % p == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">teal</span><span class="params">(C, P, Q)</span>:</span></span><br><span class="line">    c, d, p = C</span><br><span class="line">    u1, v1 = P</span><br><span class="line">    u2, v2 = Q</span><br><span class="line">    <span class="keyword">assert</span> ison(C, P) <span class="keyword">and</span> ison(C, Q)</span><br><span class="line">    u3 = (u1 * v2 + v1 * u2) * inverse(c * (<span class="number">1</span> + d * u1 * u2 * v1 * v2), p) % p</span><br><span class="line">    v3 = (v1 * v2 - u1 * u2) * inverse(c * (<span class="number">1</span> - d * u1 * u2 * v1 * v2), p) % p</span><br><span class="line">    <span class="keyword">return</span> (int(u3), int(v3))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peam</span><span class="params">(C, P, m)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> ison(C, P)</span><br><span class="line">    c, d, p = C</span><br><span class="line">    B = bin(m)[<span class="number">2</span>:]</span><br><span class="line">    l = len(B)</span><br><span class="line">    u, v = P</span><br><span class="line">    PP = (-u, v)</span><br><span class="line">    O = teal(C, P, PP)</span><br><span class="line">    Q = O</span><br><span class="line">    <span class="keyword">if</span> m == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> O</span><br><span class="line">    <span class="keyword">elif</span> m == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> P</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(l<span class="number">-1</span>):</span><br><span class="line">            P = teal(C, P, P)</span><br><span class="line">        m = m - <span class="number">2</span>**(l<span class="number">-1</span>)</span><br><span class="line">        Q, P = P, (u, v)</span><br><span class="line">        <span class="keyword">return</span> teal(C, Q, peam(C, P, m))</span><br><span class="line"></span><br><span class="line">c, d, p = Curve</span><br><span class="line"></span><br><span class="line">flag = flag.lstrip(<span class="string">b'CCTF&#123;'</span>).rstrip(<span class="string">b'&#125;'</span>)</span><br><span class="line">l = len(flag)</span><br><span class="line">lflag, rflag = flag[:l // <span class="number">2</span>], flag[l // <span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">s, t = bytes_to_long(lflag), bytes_to_long(rflag)</span><br><span class="line"><span class="keyword">assert</span> s &lt; p <span class="keyword">and</span> t &lt; p</span><br><span class="line"></span><br><span class="line">P = (<span class="number">398011447251267732058427934569710020713094</span>, <span class="number">548950454294712661054528329798266699762662</span>)</span><br><span class="line">Q = (<span class="number">139255151342889674616838168412769112246165</span>, <span class="number">649791718379009629228240558980851356197207</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'ison(C, P) = <span class="subst">&#123;ison(Curve, P)&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'ison(C, Q) = <span class="subst">&#123;ison(Curve, Q)&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'P = <span class="subst">&#123;P&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'Q = <span class="subst">&#123;Q&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">f's * P = <span class="subst">&#123;peam(Curve, P, s)&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f't * Q = <span class="subst">&#123;peam(Curve, Q, t)&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">ison(C, P) = <span class="literal">True</span></span><br><span class="line">ison(C, Q) = <span class="literal">True</span></span><br><span class="line">P = (<span class="number">398011447251267732058427934569710020713094</span>, <span class="number">548950454294712661054528329798266699762662</span>)</span><br><span class="line">Q = (<span class="number">139255151342889674616838168412769112246165</span>, <span class="number">649791718379009629228240558980851356197207</span>)</span><br><span class="line">s * P = (<span class="number">730393937659426993430595540476247076383331</span>, <span class="number">461597565155009635099537158476419433012710</span>)</span><br><span class="line">t * Q = (<span class="number">500532897653416664117493978883484252869079</span>, <span class="number">620853965501593867437705135137758828401933</span>)</span><br></pre></td></tr></table></figure>

<p>首先还是要获取椭圆曲线的参数 $c,d,p$</p>
<p>对于 $p$ 的获取，由于我们知道四个点 $P,Q,sP,tQ$</p>
<p>根据曲线我们有 $x^2+y^2 \equiv c^2(1+dx^2y^2) \pmod p$</p>
<p>所以如果有两个点，我们就能够得出 $c^2d$</p>
<p>$X_1 = x_1^2 +y_1^2-c^2(1+dx_1^2y_1^2) = k_1p$</p>
<p>$X_2 = x_2^2 +y_2^2-c^2(1+dx_2^2y_2^2) = k_2p$</p>
<p>两式相减我们有 $X_1-X_2 = (x_1^2+y_1^2-x_2^2-y_2^2)-c^2d(x_1^2y_1^2-x_2^2y_2^2) = (k_1-k_2)p \equiv 0 \pmod p$</p>
<p>于是 $c^2d \equiv \frac{(x_1^2+y_1^2-x_2^2-y_2^2)}{x_1^2y_1^2-x_2^2y_2^2} \pmod p$ ，可求</p>
<p>有了 $c^2d$，我们就能求出 $X_1-X_2=(k_1-k_2)p$ 了，</p>
<p>同理我们用另外两个点就能够搞出 $X_3-X_4 = (k_3-k_4)p$ 了，然后 gcd一下，再factor一下，就能够求出 $p$ 了。</p>
<p>有了$c^2d$，根据 $X_1 = x_1^2 +y_1^2-c^2(1+dx_1^2y_1^2) \equiv 0 \pmod p$ 也能求出 $c^2$ 了，从而也能求出 $d$ 了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ison</span><span class="params">(C, P)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Verification points are on the curve</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    c, d, p = C</span><br><span class="line">    u, v = P</span><br><span class="line">    <span class="keyword">return</span> (u**<span class="number">2</span> + v**<span class="number">2</span> - cc * (<span class="number">1</span> + d * u**<span class="number">2</span>*v**<span class="number">2</span>)) % p == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_and_b</span><span class="params">(u1,u2,v1,v2)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Helper function used to simplify calculations</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    a12 = u1**<span class="number">2</span> - u2**<span class="number">2</span> + v1**<span class="number">2</span> - v2**<span class="number">2</span></span><br><span class="line">    b12 = u1**<span class="number">2</span> * v1**<span class="number">2</span> - u2**<span class="number">2</span> * v2**<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> a12, b12</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_modulus</span><span class="params">(u1,u2,u3,u4,v1,v2,v3,v4)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Compute the modulus from four points</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    a12, b12 = a_and_b(u1,u2,v1,v2)</span><br><span class="line">    a13, b13 = a_and_b(u1,u3,v1,v3)</span><br><span class="line">    a23, b23 = a_and_b(u2,u3,v2,v3)</span><br><span class="line">    a24, b24 = a_and_b(u2,u4,v2,v4)</span><br><span class="line"></span><br><span class="line">    p_almost = gcd(a12*b13 - a13*b12, a23*b24 - a24*b23)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">1000</span>):</span><br><span class="line">        <span class="keyword">if</span> p_almost % i == <span class="number">0</span>:</span><br><span class="line">            p_almost = p_almost // i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p_almost</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c_sq_d</span><span class="params">(u1,u2,v1,v2,p)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Helper function to computer c^2 d</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    a1,b1 = a_and_b(u1,u2,v1,v2)</span><br><span class="line">    <span class="keyword">return</span> a1 * pow(b1,<span class="number">-1</span>,p) % p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(u1,u2,v1,v2,p)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Compute c^2, d from two points and known modulus</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ccd = c_sq_d(u1,u2,v1,v2,p)</span><br><span class="line">    cc = (u1**<span class="number">2</span> + v1**<span class="number">2</span> - ccd*u1**<span class="number">2</span>*v1**<span class="number">2</span>) % p</span><br><span class="line">    d = ccd * pow(cc, <span class="number">-1</span>, p) % p</span><br><span class="line">    <span class="keyword">return</span> cc, d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">P = (<span class="number">398011447251267732058427934569710020713094</span>, <span class="number">548950454294712661054528329798266699762662</span>)</span><br><span class="line">Q = (<span class="number">139255151342889674616838168412769112246165</span>, <span class="number">649791718379009629228240558980851356197207</span>)</span><br><span class="line">sP = (<span class="number">730393937659426993430595540476247076383331</span>, <span class="number">461597565155009635099537158476419433012710</span>)</span><br><span class="line">tQ = (<span class="number">500532897653416664117493978883484252869079</span>, <span class="number">620853965501593867437705135137758828401933</span>)</span><br><span class="line"></span><br><span class="line">u1, v1 = P</span><br><span class="line">u2, v2 = Q</span><br><span class="line">u3, v3 = sP</span><br><span class="line">u4, v4 = tQ</span><br><span class="line"></span><br><span class="line">p = find_modulus(u1,u2,u3,u4,v1,v2,v3,v4)</span><br><span class="line">cc, d = c(u1,u2,v1,v2,p)</span><br><span class="line"></span><br><span class="line">C = cc, d, p</span><br><span class="line"><span class="keyword">assert</span> ison(C, P)</span><br><span class="line"><span class="keyword">assert</span> ison(C, Q)</span><br><span class="line"><span class="keyword">assert</span> ison(C, sP)</span><br><span class="line"><span class="keyword">assert</span> ison(C, tQ)</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'Found curve parameters'</span>)</span><br><span class="line">print(<span class="string">f'p = <span class="subst">&#123;p&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'c^2 = <span class="subst">&#123;cc&#125;</span>'</span>)</span><br><span class="line">print(<span class="string">f'd = <span class="subst">&#123;d&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Found curve</span></span><br><span class="line"><span class="comment"># p = 903968861315877429495243431349919213155709</span></span><br><span class="line"><span class="comment"># cc = 495368774702871559312404847312353912297284</span></span><br><span class="line"><span class="comment"># d = 540431316779988345188678880301417602675534</span></span><br></pre></td></tr></table></figure>

<p>脚本来自<a href="https://blog.cryptohack.org/cryptoctf2021-hard#rohald（注意" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-hard#rohald（注意</a> $c^2$ 开根的时候有两个解，最后解flag的时候都要尝试一下）</p>
<p>然后我们得转化这个椭圆曲线的形式，从Edwards Curve 转到 Montgomery形式最后变成Weierstrass形式，然后会发现这条曲线的阶光滑，直接调用 sagemath 的 discrete_log 就能进行求解。</p>
<p>$E_{c,d} : u^2  + v^2 -c^2 (1+du^2v^2)=0$</p>
<p>$u_{P+Q} = \frac{(u_Pv_Q)+(v_Pu_Q)}{c(1+du_Pu_Qv_Pv_Q)}$</p>
<p>$v_{P+Q}=\frac{(-u_Pv_Q)+(v_Pu_Q)}{c(1-du_Pu_Qv_Pv_Q)}$</p>
<p>Edwards Curve to $u’^2 + v’^2 =1+d’u’^2v’^2$    $(d’=dc^4,u’ = \frac{u}{c},v’=\frac{v}{c})$</p>
<p>to Montgomery $By’^2=x’^3+Ax’^2+x$   $(x’=\frac{1+v’}{1-v’},y’=\frac{2(1+v’)}{u’(1-v’)},A=\frac{2(1+d’)}{1-d’},B = \frac{1}{1-d’})$</p>
<p>to Weierstrass $y^2 =x^3 +ax+b$      $(x = \frac{x’}{B}+\frac{A}{3B},y=\frac{y’}{B},a=\frac{3-A^2}{3B^2},b=\frac{2A^3-9A}{27B^3})$</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">def to_elliptic_2(P, p, c, d):</span><br><span class="line">    <span class="attr">Zp</span> = Zmod(p)</span><br><span class="line">    x, <span class="attr">y</span> = P</span><br><span class="line">    x, <span class="attr">y</span> = Zp(x), Zp(y)</span><br><span class="line">    c, <span class="attr">d</span> = Zp(c), Zp(d)</span><br><span class="line">    x, <span class="attr">y</span> = x / c , y / c </span><br><span class="line">    <span class="attr">d</span> = d * c ** <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Montgomery</span></span><br><span class="line">    <span class="attr">u</span> = (<span class="number">1</span> + y) / (<span class="number">1</span> - y)</span><br><span class="line">    <span class="attr">v</span> = (<span class="number">2</span> * (<span class="number">1</span>+y)) / (x * (<span class="number">1</span>-y))</span><br><span class="line">    <span class="attr">B</span> = <span class="number">1</span> / (<span class="number">1</span>-d)</span><br><span class="line">    <span class="attr">A</span> = <span class="number">2</span> * (<span class="number">1</span>+d) / (<span class="number">1</span>-d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Weierstrass</span></span><br><span class="line">    <span class="attr">x</span> = u / B + A / (<span class="number">3</span>*B)</span><br><span class="line">    <span class="attr">y</span> = v / B</span><br><span class="line">    <span class="attr">a</span> = (<span class="number">3</span> - A**<span class="number">2</span>) / (<span class="number">3</span> * B**<span class="number">2</span>)</span><br><span class="line">    <span class="attr">b</span> = (<span class="number">2</span> * A**<span class="number">3</span> - <span class="number">9</span>*A) / (<span class="number">27</span> * B**<span class="number">3</span>)</span><br><span class="line">    return (x, y), a, b</span><br><span class="line"></span><br><span class="line"><span class="attr">p</span> = <span class="number">903968861315877429495243431349919213155709</span></span><br><span class="line"><span class="attr">c</span> = <span class="number">662698094423288904843781932253259903384619</span></span><br><span class="line"><span class="attr">d</span> = <span class="number">540431316779988345188678880301417602675534</span></span><br><span class="line"><span class="attr">P</span> = (<span class="number">398011447251267732058427934569710020713094</span>, <span class="number">548950454294712661054528329798266699762662</span>)</span><br><span class="line"><span class="attr">Q</span> = (<span class="number">139255151342889674616838168412769112246165</span>, <span class="number">649791718379009629228240558980851356197207</span>)</span><br><span class="line"><span class="attr">S</span> = (<span class="number">730393937659426993430595540476247076383331</span>, <span class="number">461597565155009635099537158476419433012710</span>)</span><br><span class="line"><span class="attr">T</span> = (<span class="number">500532897653416664117493978883484252869079</span>, <span class="number">620853965501593867437705135137758828401933</span>)</span><br><span class="line"></span><br><span class="line">P1, a, <span class="attr">b</span> = to_elliptic_2(P, p, c, d)</span><br><span class="line">Q1, a, <span class="attr">b</span> = to_elliptic_2(Q, p, c, d)</span><br><span class="line">S1, a, <span class="attr">b</span> = to_elliptic_2(S, p, c, d)</span><br><span class="line">T1, a, <span class="attr">b</span> = to_elliptic_2(T, p, c, d)</span><br><span class="line"></span><br><span class="line"><span class="attr">EC</span> = EllipticCurve(Zmod(p), [a, b])</span><br><span class="line"><span class="attr">P1</span> = EC(P1)</span><br><span class="line"><span class="attr">Q1</span> = EC(Q1)</span><br><span class="line"><span class="attr">S1</span> = EC(S1)</span><br><span class="line"><span class="attr">T1</span> = EC(T1)</span><br><span class="line"></span><br><span class="line"><span class="attr">s</span> = P1.discrete_log(S1)</span><br><span class="line"><span class="attr">t</span> = Q1.discrete_log(T1)</span><br><span class="line">print(s)</span><br><span class="line">print(t)</span><br></pre></td></tr></table></figure>

<p>脚本来自 <a href="https://zhuanlan.zhihu.com/p/399487467" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/399487467</a></p>
<h2 id="ROBERT"><a href="#ROBERT" class="headerlink" title="ROBERT"></a>ROBERT</h2><p>POINTS：194</p>
<p>考点： carmichael_lambda</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+   hi all, all cryptographers know <span class="keyword">that</span> fast calculation <span class="keyword">is</span> <span class="keyword">not</span> easy! +</span><br><span class="line">+   In each stage <span class="keyword">for</span> <span class="keyword">given</span> <span class="built_in">integer</span> m, find <span class="built_in">number</span> n such <span class="keyword">that</span>:        +</span><br><span class="line">+   carmichael_lambda(n) = m, e.g. carmichael_lambda(<span class="number">2021</span>) = <span class="number">966</span>       +</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">| send an <span class="built_in">integer</span> n such <span class="keyword">that</span> carmichael_lambda(n) = <span class="number">52</span>:</span><br></pre></td></tr></table></figure>

<p>给出一个值 $s$，求 $lcm(n)=s$ 的 $n$，一个想法是通过查找 $s$ 的因子 $x,y$， 如果 $x+1,y+1$ 为素数，并且满足 $lcm(x,y)=s$，那么我们有 $n = (x+1)\cdot(y+1)$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_lambda</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> divisors(n):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> divisors(n):</span><br><span class="line">            <span class="keyword">if</span> lcm(x, y) == n <span class="keyword">and</span> is_prime(x + <span class="number">1</span>) <span class="keyword">and</span> is_prime(y + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">return</span> (x + <span class="number">1</span>) * (y + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="TRUNC"><a href="#TRUNC" class="headerlink" title="TRUNC"></a>TRUNC</h2><p>POINTS：334</p>
<p>考点：Signature forgery</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> ecdsa</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line">E = ecdsa.SECP256k1</span><br><span class="line">G, n = E.generator, E.order</span><br><span class="line"></span><br><span class="line">cryptonym = <span class="string">b'Persian Gulf'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(n, G)</span>:</span></span><br><span class="line">    privkey = getRandomRange(<span class="number">1</span>, n<span class="number">-1</span>)</span><br><span class="line">    pubkey = privkey * G</span><br><span class="line">    <span class="keyword">return</span> (pubkey, privkey)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg, keypair)</span>:</span></span><br><span class="line">    nbit, dbit = <span class="number">256</span>, <span class="number">25</span></span><br><span class="line">    pubkey, privkey = keypair</span><br><span class="line">    privkey_bytes = long_to_bytes(privkey)</span><br><span class="line">    x = int(sha256(privkey_bytes).hexdigest(), <span class="number">16</span>) % <span class="number">2</span>**dbit</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        k, l = [(getRandomNBitInteger(nbit) &lt;&lt; dbit) + x <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="string">'01'</span>]</span><br><span class="line">        u, v = (k * G).x(), (l * G).y()</span><br><span class="line">        <span class="keyword">if</span> u + v &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    h = int(sha256(msg).hexdigest(), <span class="number">16</span>)</span><br><span class="line">    s = inverse(k, n) * (h * u - v * privkey) % n</span><br><span class="line">    <span class="keyword">return</span> (int(u), int(v), int(s))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(msg, pubkey, sig)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> any(x &lt; <span class="number">1</span> <span class="keyword">or</span> x &gt;= n <span class="keyword">for</span> x <span class="keyword">in</span> sig):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    u, v, s = sig</span><br><span class="line">    h = int(sha256(msg).hexdigest(), <span class="number">16</span>)</span><br><span class="line">    k, l = h * u * inverse(s, n), v * inverse(s, n)</span><br><span class="line">    X = (k * G + (n - l) * pubkey).x()</span><br><span class="line">    <span class="keyword">return</span> (X - u) % n == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">die</span><span class="params">(*args)</span>:</span></span><br><span class="line">    pr(*args)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="string">" "</span>.join(map(str, args))</span><br><span class="line">    sys.stdout.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sc</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    border = <span class="string">"+"</span></span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line">    pr(border, <span class="string">" hi all, welcome to the high secure elliptic curve signature oracle!"</span>, border)</span><br><span class="line">    pr(border, <span class="string">" Your mission is to sign the out cryptonym, try your best :)        "</span>, border)</span><br><span class="line">    pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">    keypair = keygen(n, G)</span><br><span class="line">    pubkey, privkey = keypair</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pr(<span class="string">"| Options: \n|\t[P]rint the pubkey \n|\t[S]ign \n|\t[V]erify \n|\t[Q]uit"</span>)</span><br><span class="line">        ans = sc().lower()</span><br><span class="line">        <span class="keyword">if</span> ans == <span class="string">'p'</span>:</span><br><span class="line">            pr(<span class="string">"| pubkey ="</span>, pubkey.x(), pubkey.y())</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'s'</span>:</span><br><span class="line">            pr(<span class="string">"| send your hex message to sign: "</span>)</span><br><span class="line">            msg = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                msg = bytes.fromhex(msg)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">"| your message is not valid! Bye!!"</span>)</span><br><span class="line">            <span class="keyword">if</span> msg == cryptonym:</span><br><span class="line">                die(<span class="string">'| Kidding me? Bye'</span>)</span><br><span class="line">            msg = msg[:<span class="number">14</span>]</span><br><span class="line">            sig = sign(msg, keypair)</span><br><span class="line">            pr(<span class="string">"| sign ="</span>, sig)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'v'</span>:</span><br><span class="line">            pr(<span class="string">"| send your hex message to verify: "</span>)</span><br><span class="line">            msg = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                msg = bytes.fromhex(msg)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">"| your message is not valid! Bye!!"</span>)</span><br><span class="line">            pr(<span class="string">"| send the signature separated with comma: "</span>)</span><br><span class="line">            sig = sc()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                sig = [int(s) <span class="keyword">for</span> s <span class="keyword">in</span> sig.split(<span class="string">','</span>)]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                die(<span class="string">"| your signature is not valid! Bye!!"</span>)</span><br><span class="line">            <span class="keyword">if</span> verify(msg, pubkey, sig):</span><br><span class="line">                <span class="keyword">if</span> msg == cryptonym:</span><br><span class="line">                    die(<span class="string">"| Good job! Congrats, the flag is:"</span>, FLAG)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    pr(<span class="string">"| your message is verified!!"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                die(<span class="string">"| your signature is not valid! Bye!!"</span>)</span><br><span class="line">        <span class="keyword">elif</span> ans == <span class="string">'q'</span>:</span><br><span class="line">            die(<span class="string">"Quitting ..."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            die(<span class="string">"Bye ..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>可以被非预期，</p>
<p>注意到验签函数：$k = hus^{-1},l=v\cdot s^{-1}$，其中$u,v,s$ 可控，验证 $(kG+(n-l)P)_x\equiv u \pmod n$</p>
<p>若目标消息哈希为 $h$，我们构造任意消息哈希为 $h’$，并且设 $m \equiv \frac{h}{h’} \pmod n$，</p>
<p>随后我们让服务端签名我们的消息，并得到签名 $u’,v’,s’$，此时 $k’=h’u’s’^{-1},l’=v’\cdot s’^{-1}$，该组 $(k,l)$能通过验证。</p>
<p>那么我们在伪造签名时只要设 $u=u’,s=s’m,v=v’m$，</p>
<p>就会有 $k = h’mu’(s’m)^{-1}=h’u’s’^{-1},l=v’m(s’m)^{-1}=v’s’^{-1}$，由上可知，该组 $(k,l)$ 能通过验证。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env <span class="keyword">python3</span></span><br><span class="line">from pwn import remote</span><br><span class="line">from ecdsa import SECP256k1</span><br><span class="line">from hashlib import <span class="built_in">sha256</span></span><br><span class="line"></span><br><span class="line">n = SECP256k1.order</span><br><span class="line">m1 = <span class="keyword">b</span><span class="string">'lol'</span> # any other message <span class="keyword">is</span> fine</span><br><span class="line">m2 = <span class="keyword">b</span><span class="string">'Persian Gulf'</span></span><br><span class="line">h1 = <span class="keyword">int</span>(<span class="built_in">sha256</span>(m1).hexdigest(), <span class="number">16</span>)</span><br><span class="line">h2 = <span class="keyword">int</span>(<span class="built_in">sha256</span>(m2).hexdigest(), <span class="number">16</span>)</span><br><span class="line"><span class="keyword">m</span> = h2 * <span class="built_in">pow</span>(h1, -<span class="number">1</span>, n) % n</span><br><span class="line">r = remote(<span class="string">"02.cr.yp.toc.tf"</span>, <span class="number">23010</span>)</span><br><span class="line"><span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    r.recvline()</span><br><span class="line">r.sendline(<span class="string">'s'</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">r.sendline(m1.hex())</span><br><span class="line">u1, v1, w1 = <span class="built_in">eval</span>(r.recvline()[<span class="number">8</span>:])</span><br><span class="line">u2, v2, w2 = u1, v1 * <span class="keyword">m</span> % n, w1 * <span class="keyword">m</span> % n</span><br><span class="line"><span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    r.recvline()</span><br><span class="line">r.sendline(<span class="string">'v'</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">r.sendline(m2.hex())</span><br><span class="line">r.recvline()</span><br><span class="line">r.sendline(<span class="string">','</span>.<span class="keyword">join</span>(<span class="keyword">map</span>(str, [u2, v2, w2])))</span><br><span class="line"><span class="keyword">print</span>(r.recvline().decode().strip().<span class="keyword">split</span>()[-<span class="number">1</span>])</span><br><span class="line">r.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure>

<p>CCTF{__ECC_Bi4seD_N0nCE_53ns3_LLL!!!}</p>
<p>（PS：不过看着flag，估计要构造格，又非预期了，，，）</p>
<h2 id="MY-SIEVE"><a href="#MY-SIEVE" class="headerlink" title="MY SIEVE"></a>MY SIEVE</h2><p>POINTS：477</p>
<p>考点：RSA</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enc = 17774316754182701043637765672766475504513144507864625935518462040899856505354546178499264702656639970102754546327338873353871389580967004810214134215521924626871944954513679198245322915573598165643628084858678915415521536126034275104881281802618561405075363713125886815998055449593678564456363170087233864817</span><br><span class="line"></span><br><span class="line"><span class="params">-----BEGIN</span> PUBLIC KEY<span class="params">-----</span></span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB*QKBgQCkRgRCyTcSwlBKmERQV/BHkurS</span><br><span class="line">5QnYz7Rm18OjxuuWT3A*Ueqzq7fHISey2NEEtral/*E7v2Dy59DYHoRAAouWQd03</span><br><span class="line">ZYWnvU5mWoYRcpNmHIj8q*+FOtBWcCGzMZ8uxOxaV74vqqerjxyRI14rXZ+QOcNM</span><br><span class="line"><span class="string">/TMM84h0rl/IKqqWsQIDAQAB</span></span><br><span class="line"><span class="params">-----END</span> PUBLIC KEY<span class="params">-----</span></span><br></pre></td></tr></table></figure>

<p>题目还给了一个msieve文件，里面有一个</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1dabd3bb8e99101030cd7094eb15dd525cb0f02065694604071c2a8b10228f30cc12d08fc9caa8d97c65ff</span>481</span><br></pre></td></tr></table></figure>

<p>似乎是 $n$ 的一个因子，</p>
<p>且已经有了分解</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">37517726695590864161261967849116722975727713562769161</span></span><br><span class="line"><span class="number">41223455646589331474862018682296591762663841134030283</span></span><br></pre></td></tr></table></figure>

<p>注意到公钥文件里面有四个 *，是被“污染”的 $n$，</p>
<p>这里一个想法是爆破一下，64**4 的复杂度，还好。但是好像最后也没结果。</p>
<p>然后用一用非预期（如果 $flag$ 比较小的话），尝试在“子剩余系“下解密</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *                                                                                  </span><br><span class="line">p = 37517726695590864161261967849116722975727713562769161</span><br><span class="line">q = 41223455646589331474862018682296591762663841134030283</span><br><span class="line">N = p*q</span><br><span class="line">phi = (p-1)*(q-1)</span><br><span class="line">e = 0x10001</span><br><span class="line">d = pow(e,-1,phi)</span><br><span class="line">enc = 17774316754182701043637765672766475504513144507864625935518462040899856505354546178499264702656639970102754546327338873353871389580967004810214134215521924626871944954513679198245322915573598165643628084858678915415521536126034275104881281802618561405075363713125886815998055449593678564456363170087233864817                            </span><br><span class="line">flag = long_to_bytes(pow(enc,d,N))</span><br><span class="line">print(flag) </span><br><span class="line"></span><br><span class="line"><span class="comment"># b'CCTF&#123;l34Rn_WorK_bY__Msieve__A5aP&#125;'</span></span><br></pre></td></tr></table></figure>

<p>成了！</p>
<p>那如果 flag 比较大怎么办？</p>
<p>（PS： </p>
<p>赛后没有被“污染”的公钥文件公布了，发现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">'''-----BEGIN PUBLIC KEY-----</span></span><br><span class="line"><span class="string">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCkRgRCyTcSwlBKmERQV/BHkurT</span></span><br><span class="line"><span class="string">5QnYz7Rm18OjxuuWT3AhUeqzq7fHISey2NEEtral/jE7v2Dy59DYHoRAAouWQd02</span></span><br><span class="line"><span class="string">ZYWnvU5mWoYRcpNmHIj8qk+FOtBWcCGzMZ8uxOxaV74vqqerjxyRI14rXZ+QOcNL</span></span><br><span class="line"><span class="string">/TMM84h0rl/IKqqWsQIDAQAB</span></span><br><span class="line"><span class="string">-----END PUBLIC KEY-----'''</span></span><br><span class="line">b = <span class="string">'''-----BEGIN PUBLIC KEY-----</span></span><br><span class="line"><span class="string">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB*QKBgQCkRgRCyTcSwlBKmERQV/BHkurS</span></span><br><span class="line"><span class="string">5QnYz7Rm18OjxuuWT3A*Ueqzq7fHISey2NEEtral/*E7v2Dy59DYHoRAAouWQd03</span></span><br><span class="line"><span class="string">ZYWnvU5mWoYRcpNmHIj8q*+FOtBWcCGzMZ8uxOxaV74vqqerjxyRI14rXZ+QOcNM</span></span><br><span class="line"><span class="string">/TMM84h0rl/IKqqWsQIDAQAB</span></span><br><span class="line"><span class="string">-----END PUBLIC KEY-----'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">	<span class="keyword">if</span> a[i] != b[i]:</span><br><span class="line">		print(i,a[i],b[i])</span><br><span class="line"></span><br><span class="line"><span class="number">59</span> i *</span><br><span class="line"><span class="number">90</span> T S</span><br><span class="line"><span class="number">111</span> h *</span><br><span class="line"><span class="number">133</span> j *</span><br><span class="line"><span class="number">155</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="number">178</span> k *</span><br><span class="line"><span class="number">220</span> L M</span><br></pre></td></tr></table></figure>

<p>发现除了 * 处，还有其他地方也不一样，，emmm，不是很懂出题人啥意思。</p>
<h2 id="DORSA"><a href="#DORSA" class="headerlink" title="DORSA"></a>DORSA</h2><p>POINTS：450</p>
<p>考点：RSA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keygen</span><span class="params">(nbit, dbit)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">2</span>*dbit &lt; nbit</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        u, v = getRandomNBitInteger(dbit), getRandomNBitInteger(nbit // <span class="number">2</span> - dbit)</span><br><span class="line">        p = u * v + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                x, y = getRandomNBitInteger(dbit), getRandomNBitInteger(nbit // <span class="number">2</span> - dbit)</span><br><span class="line">                q = u * y + <span class="number">1</span></span><br><span class="line">                r = x * y + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> isPrime(q) <span class="keyword">and</span> isPrime(r):</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        e = getRandomNBitInteger(dbit)</span><br><span class="line">                        <span class="keyword">if</span> gcd(e, u * v * x * y) == <span class="number">1</span>:</span><br><span class="line">                            phi = (p - <span class="number">1</span>) * (r - <span class="number">1</span>)</span><br><span class="line">                            d = inverse(e, phi)</span><br><span class="line">                            k = (e * d - <span class="number">1</span>) // phi</span><br><span class="line">                            s = k * v + <span class="number">1</span></span><br><span class="line">                            <span class="keyword">if</span> isPrime(s):</span><br><span class="line">                                n_1, n_2 = p * r, q * s</span><br><span class="line">                                <span class="keyword">return</span> (e, n_1, n_2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, pubkey)</span>:</span></span><br><span class="line">    e, n = pubkey</span><br><span class="line">    <span class="keyword">return</span> pow(msg, e, n)</span><br><span class="line"></span><br><span class="line">nbit, dbit = <span class="number">1024</span>, <span class="number">256</span></span><br><span class="line"></span><br><span class="line">e, n_1, n_2 = keygen(nbit, dbit)</span><br><span class="line"></span><br><span class="line">FLAG = int(FLAG.encode(<span class="string">"utf-8"</span>).hex(), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">c_1 = encrypt(FLAG, (e, n_1))</span><br><span class="line">c_2 = encrypt(FLAG, (e, n_2))</span><br><span class="line"></span><br><span class="line">print(<span class="string">'e ='</span>, e)</span><br><span class="line">print(<span class="string">'n_1 ='</span>, n_1)</span><br><span class="line">print(<span class="string">'n_2 ='</span>, n_2)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'enc_1 ='</span>, c_1)</span><br><span class="line">print(<span class="string">'enc_2 ='</span>, c_2)</span><br><span class="line"></span><br><span class="line">e = <span class="number">93546309251892226642049894791252717018125687269405277037147228107955818581561</span></span><br><span class="line">n_1 = <span class="number">36029694445217181240393229507657783589129565545215936055029374536597763899498239088343814109348783168014524786101104703066635008905663623795923908443470553241615761261684865762093341375627893251064284854550683090289244326428531870185742069661263695374185944997371146406463061296320874619629222702687248540071</span></span><br><span class="line">n_2 = <span class="number">29134539279166202870481433991757912690660276008269248696385264141132377632327390980628416297352239920763325399042209616477793917805265376055304289306413455729727703925501462290572634062308443398552450358737592917313872419229567573520052505381346160569747085965505651160232449527272950276802013654376796886259</span></span><br><span class="line">enc_1 = <span class="number">4813040476692112428960203236505134262932847510883271236506625270058300562795805807782456070685691385308836073520689109428865518252680199235110968732898751775587988437458034082901889466177544997152415874520654011643506344411457385571604433702808353149867689652828145581610443408094349456455069225005453663702</span></span><br><span class="line">enc_2 = <span class="number">2343495138227787186038297737188675404905958193034177306901338927852369293111504476511643406288086128052687530514221084370875813121224208277081997620232397406702129186720714924945365815390097094777447898550641598266559194167236350546060073098778187884380074317656022294673766005856076112637129916520217379601</span></span><br></pre></td></tr></table></figure>

<p>根据 题目，我们有<br>$$<br>p=uv+1,q=vy+1,r=xy+1,s=kv+1，\phi=(p-1)(r-1)=uvxy,ed\equiv 1\pmod \phi,k=(ed-1)/\phi<br>$$<br>其中 $e.nbits \approx 256$</p>
<p>注意到<br>$$<br>\frac{n_2}{n_1} = \frac{qs}{pr}=\frac{(uy+1)(kv+1)}{(uv+1)(xy+1)}\approx\frac{uykv}{uvxy}=\frac{k}{x}<br>$$<br>所以 $k,x$ 有可能会在 $n2,n1$ 的连分数上（具体的关系没有推，做题的时候可以本地测几组数据）</p>
<p>（这里假设 $gcd(k,x)=1$ 了，但是也不一定是 1 叭，但也应该不大，可以小爆破一下？）</p>
<p>有了 $k,x$ 后，我们有<br>$$<br>k\phi+1 =ed\equiv 0 \pmod e \to \phi \equiv -1 \cdot k^{-1} \pmod e<br>$$</p>
<p>$$<br>\phi =uvxy \equiv 0 \pmod x<br>$$</p>
<p>有这两条同余式，我们能恢复 $\phi$ 大约 1024bit的信息，即 $\phi \pmod {ex}$。</p>
<p>另外<br>$$<br>| \phi -n_1|=|(p-1)(r-1)-pr| \approx p+q \le 2^{513}<br>$$<br>由于 $ex$ 大约有 $512$ 比特，我们首先设 $\phi’ = \phi % ex + k\cdot ex$，$k$ 值大约使得我们的 $\phi’$ 和 $n_1$ 一个数量级，然后再在小范围爆破一下即可恢复 $\phi$，从而解密获得 $flag$</p>
<p>exp，来自<a href="https://blog.cryptohack.org/cryptoctf2021-hard#dorsa" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-hard#dorsa</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from tqdm import </span><br><span class="line">from Crypto.Util.<span class="keyword">number</span> import *</span><br><span class="line"></span><br><span class="line"><span class="keyword">e</span> = <span class="number">93546309251892226642049894791252717018125687269405277037147228107955818581561</span></span><br><span class="line">n_1 = <span class="number">36029694445217181240393229507657783589129565545215936055029374536597763899498239088343814109348783168014524786101104703066635008905663623795923908443470553241615761261684865762093341375627893251064284854550683090289244326428531870185742069661263695374185944997371146406463061296320874619629222702687248540071</span></span><br><span class="line">n_2 = <span class="number">29134539279166202870481433991757912690660276008269248696385264141132377632327390980628416297352239920763325399042209616477793917805265376055304289306413455729727703925501462290572634062308443398552450358737592917313872419229567573520052505381346160569747085965505651160232449527272950276802013654376796886259</span></span><br><span class="line">enc_1 = <span class="number">4813040476692112428960203236505134262932847510883271236506625270058300562795805807782456070685691385308836073520689109428865518252680199235110968732898751775587988437458034082901889466177544997152415874520654011643506344411457385571604433702808353149867689652828145581610443408094349456455069225005453663702</span></span><br><span class="line">enc_2 = <span class="number">2343495138227787186038297737188675404905958193034177306901338927852369293111504476511643406288086128052687530514221084370875813121224208277081997620232397406702129186720714924945365815390097094777447898550641598266559194167236350546060073098778187884380074317656022294673766005856076112637129916520217379601</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">c</span> = continued_fraction(Integer(n_2) / Integer(n_1))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in tqdm(<span class="built_in">range</span>(<span class="number">150</span>)):</span><br><span class="line">    <span class="keyword">k</span> = <span class="keyword">c</span>.numerator(i)</span><br><span class="line">    <span class="keyword">x</span> = <span class="keyword">c</span>.denominator(i)</span><br><span class="line">    <span class="keyword">if</span> GCD(<span class="keyword">e</span>, <span class="keyword">k</span>) != <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    phi_e = inverse(<span class="keyword">e</span> - <span class="keyword">k</span>, <span class="keyword">e</span>)</span><br><span class="line">    phi_ex = crt(phi_e, <span class="number">0</span>, <span class="keyword">e</span>, <span class="keyword">x</span>)</span><br><span class="line">    <span class="keyword">ex</span> = <span class="keyword">e</span> * <span class="keyword">x</span> // GCD(<span class="keyword">e</span>, <span class="keyword">x</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">st</span> = phi_ex + (n_1 // <span class="keyword">ex</span>) * <span class="keyword">ex</span> - <span class="number">100</span> * <span class="keyword">ex</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">j</span> in <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">        <span class="keyword">if</span> GCD(<span class="keyword">e</span>, <span class="keyword">st</span>) != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">st</span> += <span class="keyword">ex</span></span><br><span class="line">            <span class="keyword">continue</span> </span><br><span class="line">        d_1 = inverse(<span class="keyword">e</span>, <span class="keyword">st</span>)</span><br><span class="line">        flag = long_to_bytes(<span class="built_in">pow</span>(enc_1, d_1, n_1))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">b</span><span class="string">"CCTF"</span> in fla<span class="variable">g:</span></span><br><span class="line">            <span class="keyword">print</span>(flag)</span><br><span class="line">        <span class="keyword">st</span> += <span class="keyword">ex</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">b</span><span class="string">'CCTF&#123;__Lattice-Based_atT4cK_on_RSA_V4R1aN75!!!&#125;'</span></span><br></pre></td></tr></table></figure>

<p>(PS：看这flag，又非预期了似乎。。。。)</p>
<h2 id="POLISH"><a href="#POLISH" class="headerlink" title="POLISH"></a>POLISH</h2><p>POINTS：477</p>
<p>考点：RSA，Partial Key Exposure Attack</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">m = bytes_to_long(flag)</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">n = p * q</span><br><span class="line">  = <span class="number">40246250034008312612597372763167482121403594640959033279625274444300931999548988739160328671767018778652394885185401059130887869211330599272113849088780129624581674441314938139267245340401649784020787977993123159165051168187958742107</span></span><br><span class="line"></span><br><span class="line">d = <span class="number">0</span>b1[REDACTED]<span class="number">00001101110000010101000000101110000111101011011101111111000011110101111000100001011100001111011000010101010010111100000011000101000001110001111100001011001100010001100000011100001101101100011101000001010001100000101000001</span></span><br><span class="line"></span><br><span class="line">c = pow(x**<span class="number">2</span> + m + y, e, n)</span><br><span class="line">  = <span class="number">28505561807082805875299833176536442119874596699006698476186799206821274572541984841039970225569714867243464764627070206533293573878039612127495688810559746369298640670292301881186317254368892594525084237214035763200412059090430060075</span></span><br><span class="line"></span><br><span class="line">x**<span class="number">2</span> * (y - <span class="number">146700196613209180651680280746469710064760660116352037627587109421827052580531</span>) + y**<span class="number">2</span> * (x - <span class="number">146700196613209180651680280746469710064760660116352037627587109421827052580531</span>) = <span class="number">27617741006445293346871979669264566397938197906017433294384347969002810245774095080855953181508639433683134768646569379922750075630984038851158577517435997971553106764846655038664493024213691627948571214899362078353364358736447296943</span></span><br></pre></td></tr></table></figure>

<p>根据题目，我们已知 $n,d_{lsb}$，和一个丢番图方程。显然获得flag，除了把 RSA 解密，我们还得解这个丢番图方程获取 $x,y$</p>
<p>那么，先看看怎么解这个丢番图方程，我们有<br>$$<br>x^2(y-a)+y^2(x-a)=b<br>$$<br>我们设 $u=x+y,v=xy$，上式整理一下有<br>$$<br>xy(y+x)-a(x^2-y^2)=b<br>$$<br>替换后有<br>$$<br>    uv-a(u^2-2v)=b<br>$$</p>
<p>$$<br>(u+2a)v=au^2+b<br>$$</p>
<p>$$<br>v=\frac{au^2+b}{u+2a}<br>$$</p>
<p>$$<br>v=\frac{au^2+b+2a^2u-2a^2u}{u+2a}=au+\frac{b-2a^2u-4a^3+4a^3}{u+2a}=au-2a^2+\frac{b+4a^3}{u+2a}<br>$$</p>
<p>可以看到 $u+2a$ 应该是 $b+4a^3$ 的一个因子，所以我们可以尝试一下分解 $b+4a^3$？因为知道 $a$，然后就能获得 $u$ 了。</p>
<p>这时会发现<br>$$<br>b+4a^3=n<br>$$<br>那么问题又回到分解 $n$ 上来了。</p>
<p>那么这里泄露了私钥 $d$ 的低位，这里尝试用coppersmith对其进行分解</p>
<p>考虑到 $p,q$ 的大小，如果$p,q$ 数量级差不多，平均分了 $n$  的比特长度，那么除去已知的 $221$ 低位，我们大约还剩 $166$个低位， $2^{166} \le \frac{1}{2}n^{\beta^2-\epsilon}$ ，那么应该选择 $\beta = 0.5,\epsilon=0.034$</p>
<p>但是这里考虑道 $u+2a$ 是 $n$ 的一个因子，$4a^3+b=n$，$a$ 大约为 $n^{\frac{1}{3}}$，$v=xy=\frac{au^2+b}{u+2a}$，如果 $xy$ 的数量级差不多，那么应该 $x,y,u,a,b$ 都大约是 $n^{\frac{1}{3}}$，那么 $p,q$ 应该是 $258+515$ 这样子的分布。于是我们这里使用参数 $\beta=0.33,\epsilon=0.05$</p>
<p>（PS：由于e很大，所以个人PC挺难跑的，这里解题者是使用了20cores的计算机多线程去跑的。。。。）</p>
<p>exp来自：<a href="https://blog.cryptohack.org/cryptoctf2021-hard#polish" target="_blank" rel="noopener">https://blog.cryptohack.org/cryptoctf2021-hard#polish</a></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Part <span class="number">1</span> : Factorization of n, written by rbtree</span><br><span class="line"># Also, multiprocess the code below with multiple cores <span class="keyword">for</span> shorter computation <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">n = <span class="number">40246250034008312612597372763167482121403594640959033279625274444300931999548988739160328671767018778652394885185401059130887869211330599272113849088780129624581674441314938139267245340401649784020787977993123159165051168187958742107</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mod</span> = <span class="number">2</span>^<span class="number">221</span></span><br><span class="line">d_low = <span class="number">0b00001101110000010101000000101110000111101011011101111111000011110101111000100001011100001111011000010101010010111100000011000101000001110001111100001011001100010001100000011100001101101100011101000001010001100000101000001</span></span><br><span class="line"></span><br><span class="line">def get_p(p_low):</span><br><span class="line">    F.&lt;z&gt; = PolynomialRing(Zmod(n))</span><br><span class="line"></span><br><span class="line">    f = <span class="built_in">mod</span> * z + p_low</span><br><span class="line">    f = f.monic()</span><br><span class="line">    res = f.small_roots(<span class="built_in">beta</span>=<span class="number">0.33</span>, epsilon=<span class="number">0.05</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(res) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">        <span class="built_in">return</span> <span class="built_in">gcd</span>(int(f(res[<span class="number">0</span>])),int(n))</span><br><span class="line">    <span class="built_in">return</span> None</span><br><span class="line"></span><br><span class="line">R.&lt;x&gt; = PolynomialRing(ZZ)</span><br><span class="line">from tqdm import *</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">1</span>, e+<span class="number">1</span>)):</span><br><span class="line">    cands = [<span class="number">1</span>]</span><br><span class="line">    f = k * x^<span class="number">2</span> + (e*d_low - k*n - k - <span class="number">1</span>) * x + k * n</span><br><span class="line"></span><br><span class="line">    cands = [<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">509</span>):</span><br><span class="line">        new_cands = []</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> cands:</span><br><span class="line">            <span class="keyword">if</span> int(f(v)) <span class="symbol">%</span> <span class="number">2</span>^(i+<span class="number">1</span>) == <span class="number">0</span>:</span><br><span class="line">                new_cands.<span class="built_in">append</span>(v)</span><br><span class="line">            <span class="keyword">if</span> int(f(v + <span class="number">2</span>^i)) <span class="symbol">%</span> <span class="number">2</span>^(i+<span class="number">1</span>) == <span class="number">0</span>:</span><br><span class="line">                new_cands.<span class="built_in">append</span>(v + <span class="number">2</span>^i)</span><br><span class="line">        </span><br><span class="line">        cands = new_cands</span><br><span class="line">        <span class="keyword">if</span> len(new_cands) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"break"</span>, i)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line"></span><br><span class="line">    #<span class="built_in">print</span>(k)</span><br><span class="line">    #<span class="built_in">print</span>(cands)</span><br><span class="line"></span><br><span class="line">    ret = None</span><br><span class="line">    <span class="keyword">for</span> v1 <span class="keyword">in</span> cands:</span><br><span class="line">        <span class="keyword">for</span> v2 <span class="keyword">in</span> cands:</span><br><span class="line">            <span class="keyword">if</span> v1 * v2 <span class="symbol">%</span> <span class="built_in">mod</span> != n <span class="symbol">%</span> <span class="built_in">mod</span>:</span><br><span class="line">                continue</span><br><span class="line">            ret = get_p(v1)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">if</span> ret:</span><br><span class="line">            <span class="built_in">print</span>(ret)</span><br></pre></td></tr></table></figure>

<p>有了 $p,q$ 后，我们获取 $u,v$，因为之前 $u=x+y,v=xy$，解一个方程我们获取 $x,y$，然后就能解密密文得到 $flag$ 了。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Part 2 : Calculating the Flag</span></span><br><span class="line"></span><br><span class="line">def inthroot(a, n):</span><br><span class="line">    return a.nth_root(n, truncate_mode=True)[0]</span><br><span class="line"></span><br><span class="line">n = 40246250034008312612597372763167482121403594640959033279625274444300931999548988739160328671767018778652394885185401059130887869211330599272113849088780129624581674441314938139267245340401649784020787977993123159165051168187958742107</span><br><span class="line"></span><br><span class="line">a = 146700196613209180651680280746469710064760660116352037627587109421827052580531</span><br><span class="line">b = 27617741006445293346871979669264566397938197906017433294384347969002810245774095080855953181508639433683134768646569379922750075630984038851158577517435997971553106764846655038664493024213691627948571214899362078353364358736447296943</span><br><span class="line"></span><br><span class="line">assert n == 4 * a * a * a + b</span><br><span class="line"></span><br><span class="line"><span class="comment"># from rbtree's code with partial exposure attack on d</span></span><br><span class="line">p = 893797203302975694226187727100454198719976283557332511256329145998133198406753</span><br><span class="line">q = n // p</span><br><span class="line"></span><br><span class="line">u = p - 2 * a</span><br><span class="line">v = (a * u * u + b) // (u + 2 * a)</span><br><span class="line">dif = inthroot(Integer(u * u - 4 * v), 2)</span><br><span class="line"></span><br><span class="line">x = (u + dif) // 2</span><br><span class="line">y = (u - dif) // 2</span><br><span class="line"></span><br><span class="line">e = 65537 </span><br><span class="line"></span><br><span class="line">c = 28505561807082805875299833176536442119874596699006698476186799206821274572541984841039970225569714867243464764627070206533293573878039612127495688810559746369298640670292301881186317254368892594525084237214035763200412059090430060075</span><br><span class="line"></span><br><span class="line">d = inverse(e, (p-1) * (q-1))</span><br><span class="line"></span><br><span class="line">res = pow(c, d, n)</span><br><span class="line"></span><br><span class="line">print(long_to_bytes(res - x * x - y))</span><br><span class="line">print(long_to_bytes(res - y * y - x))</span><br></pre></td></tr></table></figure>

<p>flag:CCTF{Par7ial_K3y_Exp0sure_At7ack_0n_L0w_3xP_RSA}</p>
<p>（PS：看这flag，$e$ 也不小啊，是不是放错了，，，，，）</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可联系QQ 643713081，也可以邮件至 643713081@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>2021 CryptoCTF</p>
    <p><span class="copy-title">文章字数:</span><span class="post-count">19.6k</span></p>
    <p><span class="copy-title">本文作者:</span><a  title="Van1sh">Van1sh</a></p>
    <p><span class="copy-title">发布时间:</span>2022-08-30, 13:30:00</p>
    <p><span class="copy-title">最后更新:</span>2023-01-31, 16:25:06</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2022/08/30/2021 cryptoctf/" title="2021 CryptoCTF">http://jayxv.github.io/2022/08/30/2021 cryptoctf/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2020 Van1sh</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['@Van1sh','@FzWjScJ','#Write Up','#docker','#Sage','#CTF','#ECC','#TLS 1.2','#Crypto','#Paillier','#Web','#Files','#Serialization','#Lattice','#Dsa','#LCG','#Rc4','#SM4','#paper','#small private exponent','#SQL','#python','#Knapsack','#Rsa','#continued_fraction','#RE','#DES','#差分密码分析','#操作模式','#number theory','#Abstract algebra','#ETH','#SPN','#线性密码分析','#Book','#Shadowsocks','#Nmap','#XSS','#Linux','#Coppersmith’s Method','#book',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
